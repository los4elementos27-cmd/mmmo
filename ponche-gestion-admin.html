<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Reportes de Asistencia - PlusMoney</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Los estilos se mantienen igual que antes */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --primary: #16e086;
      --primary-dark: #15a086;
      --secondary: #3498db;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #2ecc71;
      --dark-bg: #1a2b3c;
      --darker-bg: #0d1824;
      --card-bg: rgba(255,255,255,0.05);
      --text: #ffffff;
      --text-muted: rgba(255,255,255,0.7);
      --border: rgba(255,255,255,0.1);
      --shadow: 0 4px 12px rgba(0,0,0,0.2);
      --radius: 12px;
    }

    body {
      background: linear-gradient(135deg, var(--darker-bg), var(--dark-bg));
      color: var(--text);
      min-height: 100vh;
      padding: 10px;
      font-size: 13px;
    }

    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 10px;
    }

    .login-card {
      background: #233445;
      border-radius: var(--radius);
      padding: 20px;
      width: 100%;
      max-width: 350px;
      border: 1px solid rgba(22,224,134,0.2);
      text-align: center;
    }

    .logo {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--primary);
      margin: 0 auto 10px;
    }

    .login-card h1 {
      color: var(--primary);
      margin-bottom: 5px;
      font-size: 18px;
    }

    .login-card p {
      color: var(--text-muted);
      margin-bottom: 15px;
      font-size: 12px;
    }

    .input {
      width: 100%;
      background: rgba(255,255,255,0.08);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      color: var(--text);
      margin-bottom: 10px;
      font-size: 13px;
      outline: none;
    }

    .input:focus {
      border-color: var(--primary);
    }

    .btn {
      width: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none;
      border-radius: 8px;
      padding: 12px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(22,224,134,0.3);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
    }

    .alert {
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      border-left: 4px solid;
      font-size: 12px;
      background: rgba(231,76,60,0.15);
      border-left-color: var(--danger);
    }

    .report-container {
      display: none;
    }

    .header {
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid rgba(22,224,134,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header h1 {
      color: var(--primary);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-badge {
      background: rgba(22,224,134,0.1);
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .btn-logout, .btn-back, .btn-delete-all {
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-back {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-delete-all:hover {
      background: rgba(231,76,60,0.1);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filters {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: var(--radius);
      margin-bottom: 15px;
      border: 1px solid rgba(22,224,134,0.1);
    }

    .filters h3 {
      color: var(--primary);
      font-size: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .filter-item {
      flex: 1;
      min-width: 120px;
    }

    .filter-item label {
      display: block;
      color: var(--primary);
      margin-bottom: 3px;
      font-size: 11px;
      font-weight: bold;
    }

    .filter-item input, .filter-item select {
      width: 100%;
      padding: 8px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(22,224,134,0.2);
      border-radius: 6px;
      color: white;
      font-size: 12px;
      outline: none;
    }

    .filter-actions {
      display: flex;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: #000;
      padding: 8px 12px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .stat-card {
      background: rgba(255,255,255,0.05);
      padding: 10px 5px;
      border-radius: 8px;
      border: 1px solid rgba(22,224,134,0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 16px;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .table-container {
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius);
      border: 1px solid rgba(22,224,134,0.1);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 400px;
    }

    thead {
      background: var(--primary);
      color: #000;
      position: sticky;
      top: 0;
    }

    th {
      padding: 10px 6px;
      font-size: 11px;
      font-weight: 600;
      text-align: left;
      white-space: nowrap;
    }

    td {
      padding: 8px 6px;
      font-size: 11px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      white-space: nowrap;
    }

    tr:hover {
      background: rgba(255,255,255,0.1);
    }

    .horas-extra {
      color: var(--warning);
      font-weight: 600;
    }

    .btn-ver {
      background: var(--secondary);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .modal-content {
      background: #233445;
      border-radius: var(--radius);
      width: 100%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid var(--primary);
      padding: 15px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      color: var(--primary);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .close-modal {
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      margin-bottom: 15px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .info-item {
      background: rgba(255,255,255,0.05);
      padding: 10px;
      border-radius: 8px;
    }

    .info-label {
      color: var(--primary);
      font-size: 10px;
      margin-bottom: 3px;
    }

    .info-value {
      font-size: 13px;
      font-weight: 600;
    }

    .detalle-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-weight: bold;
      color: var(--primary);
      border-top: 2px solid var(--primary);
      margin-top: 10px;
    }

    .modal-table-container {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      overflow-x: auto;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .modal-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    .modal-table th {
      background: var(--primary);
      color: #000;
      padding: 8px 6px;
      font-size: 11px;
      font-weight: 600;
      text-align: left;
      position: sticky;
      top: 0;
    }

    .modal-table td {
      padding: 8px 6px;
      font-size: 11px;
      border-bottom: 1px solid var(--border);
    }

    .modal-table tr:hover {
      background: rgba(255,255,255,0.05);
    }

    .extras-cell {
      color: var(--warning);
      font-weight: 600;
    }

    .ampm-badge {
      font-size: 9px;
      color: var(--text-muted);
      margin-left: 2px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .btn-save {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-save:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      flex-direction: column;
      gap: 10px;
    }

    .spinner {
      width: 35px;
      height: 35px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid var(--primary);
      color: white;
      font-size: 12px;
      z-index: 3000;
      display: none;
    }

    .confirm-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #233445;
      padding: 20px;
      border-radius: var(--radius);
      border: 2px solid var(--danger);
      z-index: 4000;
      display: none;
      max-width: 300px;
      text-align: center;
    }

    .confirm-dialog p {
      margin-bottom: 15px;
      color: white;
    }

    .confirm-dialog-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-confirm {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-cancel {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <div class="logo">
        <i class="fas fa-chart-bar"></i>
      </div>
      <h1>Reportes de Asistencia</h1>
      <p>Inicia sesión como administrador</p>

      <input type="text" id="username" class="input" placeholder="Usuario">
      <input type="password" id="password" class="input" placeholder="PIN">
      <button id="loginBtn" class="btn">
        <i class="fas fa-sign-in-alt"></i> Ver Reportes
      </button>

      <div id="loginAlert" class="alert" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span id="loginMessage"></span>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div id="reportContainer" class="report-container">
    <div class="header">
      <h1><i class="fas fa-chart-bar"></i> Reportes de Asistencia</h1>
      <div class="header-actions">
        <span class="user-badge" id="adminName">Administrador</span>
        <button class="btn-delete-all" id="deleteAllBtn"><i class="fas fa-trash-alt"></i> Eliminar Todos</button>
        <button class="btn-logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Salir</button>
        <a href="index.html" class="btn-back"><i class="fas fa-camera"></i> Cámara</a>
      </div>
    </div>

    <div class="filters">
      <h3><i class="fas fa-filter"></i> Filtrar Registros</h3>
      <div class="filter-group">
        <div class="filter-item">
          <label>FECHA INICIO</label>
          <input type="date" id="fechaInicio">
        </div>
        <div class="filter-item">
          <label>FECHA FIN</label>
          <input type="date" id="fechaFin">
        </div>
        <div class="filter-item">
          <label>ESTADO</label>
          <select id="filtroEstado">
            <option value="todos">Todos</option>
            <option value="completo">Completos</option>
            <option value="incompleto">Incompletos</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn-primary" onclick="aplicarFiltros()">Aplicar</button>
        <button class="btn-secondary" onclick="limpiarFiltros()">Limpiar</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalRegistros">0</div>
        <div class="stat-label">REGISTROS</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalEntradas">0</div>
        <div class="stat-label">ENTRADAS</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalSalidas">0</div>
        <div class="stat-label">SALIDAS</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalPares">0</div>
        <div class="stat-label">COMPLETOS</div>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>COLABORADOR</th>
            <th>HORAS EXTRAS</th>
            <th>ACCIÓN</th>
          </tr>
        </thead>
        <tbody id="tablaBody">
          <tr><td colspan="3" style="text-align: center; padding: 30px;">Inicia sesión para ver los reportes</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="detalleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-user"></i> <span id="modalTitulo"></span></h2>
        <button class="close-modal" onclick="cerrarModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">CÓDIGO</div>
            <div class="info-value" id="modalCodigo"></div>
          </div>
          <div class="info-item">
            <div class="info-label">TURNO</div>
            <div class="info-value" id="modalTurno"></div>
          </div>
          <div class="info-item">
            <div class="info-label">TOTAL EXTRAS</div>
            <div class="info-value" id="modalTotalExtras">0h</div>
          </div>
        </div>

        <h3 style="color: var(--primary); font-size: 13px; margin: 10px 0;">Último Registro</h3>
        <div id="modalRegistros"></div>
        <div class="total-row" id="modalTotales"></div>

        <h3 style="color: var(--primary); font-size: 13px; margin: 20px 0 10px 0;">Historial por Día</h3>
        <div class="modal-table-container">
          <table class="modal-table">
            <thead>
              <tr>
                <th>FECHA</th>
                <th>ENTRADA</th>
                <th>SALIDA</th>
                <th>HORAS</th>
                <th>EXTRAS</th>
                <th>ESTADO</th>
              </tr>
            </thead>
            <tbody id="modalTablaBody"></tbody>
          </table>
        </div>

        <div class="total-row" id="modalHistorialTotales">
          <span>Total días: 0</span>
          <span>Horas totales: 0h</span>
        </div>
        <div class="total-row" style="color: var(--warning);" id="modalExtrasTotales">
          <span>Total horas extras:</span>
          <span>0h</span>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-save" id="btnGuardarRegistro">
          <i class="fas fa-save"></i> Guardar Registro en Firebase
        </button>
      </div>
    </div>
  </div>

  <div id="confirmDialog" class="confirm-dialog">
    <p>¿Estás seguro de eliminar TODOS los registros de asistencia?</p>
    <p style="font-size: 11px; color: var(--warning);">Esta acción no se puede deshacer</p>
    <div class="confirm-dialog-actions">
      <button class="btn-confirm" id="confirmDeleteBtn">Eliminar</button>
      <button class="btn-cancel" id="cancelDeleteBtn">Cancelar</button>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">Cargando...</div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      query, 
      where, 
      orderBy,
      writeBatch,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elementos DOM
    const loginScreen = document.getElementById('loginScreen');
    const reportContainer = document.getElementById('reportContainer');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const loginAlert = document.getElementById('loginAlert');
    const loginMessage = document.getElementById('loginMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const confirmDialog = document.getElementById('confirmDialog');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const adminName = document.getElementById('adminName');
    const tablaBody = document.getElementById('tablaBody');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const toast = document.getElementById('toast');
    const detalleModal = document.getElementById('detalleModal');
    const btnGuardarRegistro = document.getElementById('btnGuardarRegistro');

    // Variables
    let currentAdmin = null;
    let todosLosRegistros = [];
    let empleadosMap = new Map();
    let todosLosPares = [];
    let colaboradorActual = null;

    // Constantes
    const UMBRAL_16_HORAS = 16;
    const UMBRAL_5_MINUTOS = 5; // 5 minutos en minutos

    // ============ FUNCIÓN PARA CONVERTIR A FORMATO AM/PM CON SEGUNDOS ============
    function convertirA12HConSegundos(hora24) {
      if (!hora24) return '---';
      
      let horaCompleta = hora24;
      if (horaCompleta.split(':').length === 2) {
        horaCompleta = horaCompleta + ':00';
      }
      
      const [horas, minutos, segundos] = horaCompleta.split(':');
      let hora = parseInt(horas);
      const ampm = hora >= 12 ? 'PM' : 'AM';
      
      hora = hora % 12;
      hora = hora ? hora : 12;
      
      return `${hora.toString().padStart(2, '0')}:${minutos}:${segundos} <span class="ampm-badge">${ampm}</span>`;
    }

    // ============ FUNCIONES UTILIDAD ============
    function showLoading(msg) {
      loadingText.textContent = msg;
      loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    function showToast(msg, type = 'success') {
      toast.textContent = msg;
      toast.style.background = type === 'success' ? 'rgba(22,224,134,0.95)' : 'rgba(231,76,60,0.95)';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    function calcularHoras(entrada, salida) {
      if (!entrada || !salida || !entrada.hora || !salida.hora) return 0;

      try {
        const entradaHora = entrada.hora.includes(':') ? 
          (entrada.hora.split(':').length === 2 ? entrada.hora + ':00' : entrada.hora) : 
          entrada.hora + ':00';
        const salidaHora = salida.hora.includes(':') ? 
          (salida.hora.split(':').length === 2 ? salida.hora + ':00' : salida.hora) : 
          salida.hora + ':00';
        
        const fechaE = entrada.fecha || '2000-01-01';
        const fechaS = salida.fecha || fechaE;
        const entradaDate = new Date(`${fechaE}T${entradaHora}`);
        const salidaDate = new Date(`${fechaS}T${salidaHora}`);
        
        let diffMs = salidaDate - entradaDate;
        if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
        
        return Math.round((diffMs / (1000 * 60 * 60)) * 100) / 100;
      } catch (e) {
        console.error("Error calculando horas:", e);
        return 0;
      }
    }

    function calcularDiferenciaHoras(fecha1, hora1, fecha2, hora2) {
      try {
        const date1 = new Date(`${fecha1}T${hora1}`);
        const date2 = new Date(`${fecha2}T${hora2}`);
        const diffMs = date2 - date1;
        return diffMs / (1000 * 60 * 60);
      } catch (e) {
        return 0;
      }
    }

    // ============ LOGIN ============
    async function authenticateUser(username, pin) {
      showLoading('Verificando...');

      const q = query(
        collection(db, "Collaborators"),
        where("username", "==", username),
        where("pin", "==", pin)
      );

      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        throw new Error('Usuario o PIN incorrectos');
      }

      const data = snapshot.docs[0].data();
      return {
        uid: snapshot.docs[0].id,
        username: data.username,
        name: `${data.firstName || ''} ${data.lastName || ''}`.trim() || username
      };
    }

    loginBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      const pin = passwordInput.value.trim();

      if (!username || !pin) {
        loginMessage.textContent = 'Complete todos los campos';
        loginAlert.style.display = 'flex';
        return;
      }

      try {
        currentAdmin = await authenticateUser(username, pin);
        adminName.textContent = currentAdmin.name;
        loginScreen.style.display = 'none';
        reportContainer.style.display = 'block';
        await cargarRegistros();
        passwordInput.value = '';
        loginAlert.style.display = 'none';
        hideLoading();
      } catch (error) {
        hideLoading();
        loginMessage.textContent = error.message;
        loginAlert.style.display = 'flex';
      }
    });

    logoutBtn.addEventListener('click', () => {
      currentAdmin = null;
      reportContainer.style.display = 'none';
      loginScreen.style.display = 'flex';
      usernameInput.value = '';
      passwordInput.value = '';
      loginAlert.style.display = 'none';
    });

    // ============ ELIMINAR TODOS LOS REGISTROS ============
    deleteAllBtn.addEventListener('click', () => {
      confirmDialog.style.display = 'block';
    });

    cancelDeleteBtn.addEventListener('click', () => {
      confirmDialog.style.display = 'none';
    });

    confirmDeleteBtn.addEventListener('click', async () => {
      confirmDialog.style.display = 'none';
      
      if (!currentAdmin) return;
      
      showLoading('Eliminando todos los registros...');
      
      try {
        const q = query(collection(db, 'facialAttendance'));
        const snapshot = await getDocs(q);
        
        const batch = writeBatch(db);
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        todosLosRegistros = [];
        todosLosPares = [];
        
        mostrarTabla([]);
        actualizarEstadisticas([]);
        
        showToast('Todos los registros han sido eliminados', 'success');
      } catch (error) {
        console.error('Error al eliminar:', error);
        showToast('Error al eliminar registros', 'error');
      } finally {
        hideLoading();
      }
    });

    window.addEventListener('click', (e) => {
      if (e.target === confirmDialog) {
        confirmDialog.style.display = 'none';
      }
    });

    // ============ CARGAR REGISTROS ============
    async function cargarRegistros() {
      if (!currentAdmin) return;

      showLoading('Cargando registros...');

      try {
        const empQuery = query(collection(db, 'employees'));
        const empSnapshot = await getDocs(empQuery);
        empSnapshot.forEach(doc => {
          const data = doc.data();
          empleadosMap.set(data.username, {
            nombre: `${data.firstName || ''} ${data.lastName || ''}`.trim() || data.username,
            turno: parseFloat(data.turnoHoras) || 8
          });
        });

        const q = query(
          collection(db, 'facialAttendance'),
          orderBy('timestamp', 'asc')
        );

        const snapshot = await getDocs(q);
        todosLosRegistros = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          timestamp: doc.data().timestamp?.toDate() || new Date()
        }));

        procesarYMostrar();

      } catch (error) {
        console.error('Error:', error);
        tablaBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--danger);">Error al cargar datos</td></tr>';
      } finally {
        hideLoading();
      }
    }

    // ============ PROCESAR REGISTROS - VERSIÓN ORIGINAL CON 5 MINUTOS ============
    function procesarYMostrar() {
      const colaboradores = new Map();

      todosLosRegistros.forEach(reg => {
        if (!reg.collaboratorCode) return;

        if (!colaboradores.has(reg.collaboratorCode)) {
          colaboradores.set(reg.collaboratorCode, []);
        }
        colaboradores.get(reg.collaboratorCode).push(reg);
      });

      const resultados = [];

      colaboradores.forEach((registros, codigo) => {
        const ordenados = registros.sort((a, b) => a.timestamp - b.timestamp);

        let ultimaEntrada = null;
        let ultimaSalida = null;

        ordenados.forEach(reg => {
          // LÓGICA DE 5 MINUTOS - Si hay entrada sin salida y pasa +5min, se registra salida automática
          if (ultimaEntrada && !ultimaSalida) {
            const diffMinutos = (reg.timestamp - ultimaEntrada.timestamp) / (1000 * 60);
            
            if (diffMinutos >= UMBRAL_5_MINUTOS) {
              resultados.push({
                codigo,
                nombre: empleadosMap.get(codigo)?.nombre || codigo,
                turno: empleadosMap.get(codigo)?.turno || 8,
                entrada: {
                  fecha: ultimaEntrada.fecha,
                  hora: ultimaEntrada.hora,
                  timestamp: ultimaEntrada.timestamp
                },
                salida: {
                  fecha: reg.fecha,
                  hora: reg.hora,
                  timestamp: reg.timestamp
                },
                completo: true
              });
              ultimaEntrada = null;
              ultimaSalida = null;
            }
          }

          // Procesar según tipo
          if (reg.type === 'entry') {
            if (!ultimaEntrada) {
              ultimaEntrada = reg;
              ultimaSalida = null;
            }
          } 
          else if (reg.type === 'exit' && ultimaEntrada) {
            // Hay una entrada pendiente y llega una salida
            resultados.push({
              codigo,
              nombre: empleadosMap.get(codigo)?.nombre || codigo,
              turno: empleadosMap.get(codigo)?.turno || 8,
              entrada: {
                fecha: ultimaEntrada.fecha,
                hora: ultimaEntrada.hora,
                timestamp: ultimaEntrada.timestamp
              },
              salida: {
                fecha: reg.fecha,
                hora: reg.hora,
                timestamp: reg.timestamp
              },
              completo: true
            });
            ultimaEntrada = null;
            ultimaSalida = reg;
          }
        });

        // Entrada sin salida al final
        if (ultimaEntrada) {
          resultados.push({
            codigo,
            nombre: empleadosMap.get(codigo)?.nombre || codigo,
            turno: empleadosMap.get(codigo)?.turno || 8,
            entrada: {
              fecha: ultimaEntrada.fecha,
              hora: ultimaEntrada.hora,
              timestamp: ultimaEntrada.timestamp
            },
            salida: null,
            completo: false
          });
        }
      });

      // APLICAR REGLAS DE MEJORA SIN MODIFICAR LOS PARES ORIGINALES
      const resultadosMejorados = aplicarReglasMejora(resultados);
      todosLosPares = resultadosMejorados;

      resultadosMejorados.sort((a, b) => {
        if (!a.entrada || !b.entrada) return 0;
        return b.entrada.fecha.localeCompare(a.entrada.fecha);
      });

      mostrarTabla(resultadosMejorados);
      actualizarEstadisticas(resultadosMejorados);
    }

    // ============ FUNCIÓN PARA APLICAR REGLAS DE MEJORA ============
    function aplicarReglasMejora(paresOriginales) {
      const paresMejorados = [];
      
      // Ordenar por fecha ascendente para procesar secuencialmente
      const paresOrdenados = [...paresOriginales].sort((a, b) => {
        if (!a.entrada || !b.entrada) return 0;
        return a.entrada.fecha.localeCompare(b.entrada.fecha);
      });

      for (let i = 0; i < paresOrdenados.length; i++) {
        const parActual = { ...paresOrdenados[i] }; // Copia para no modificar el original
        
        // REGLA 1: Si falta salida del día anterior, el primer registro del día siguiente es su salida
        if (i > 0) {
          const parAnterior = paresMejorados[paresMejorados.length - 1];
          
          if (parAnterior && !parAnterior.salida && parActual.entrada) {
            const fechaEntradaActual = new Date(parActual.entrada.fecha);
            const fechaEntradaAnterior = new Date(parAnterior.entrada.fecha);
            const diffDias = Math.floor((fechaEntradaActual - fechaEntradaAnterior) / (1000 * 60 * 60 * 24));
            
            if (diffDias >= 1) {
              // La entrada actual se convierte en la salida del día anterior
              parAnterior.salida = {
                fecha: parActual.entrada.fecha,
                hora: parActual.entrada.hora,
                timestamp: parActual.entrada.timestamp
              };
              parAnterior.completo = true;
              
              // IMPORTANTE: Este parActual mantiene su entrada original
              // No modificamos su entrada, solo se usó como salida del anterior
              console.log(`Regla 1 aplicada: Entrada del ${parActual.entrada.fecha} usada como salida del día anterior`);
            }
          }
        }
        
        // REGLA 2: Si pasaron más de 16 horas sin salida, marcar como incompleto
        if (parActual.entrada && !parActual.salida) {
          // Buscar si hay algún registro posterior que podría ser su salida
          let salidaEncontrada = false;
          for (let j = i + 1; j < paresOrdenados.length; j++) {
            const parSiguiente = paresOrdenados[j];
            if (parSiguiente.entrada) {
              const horasDiff = calcularDiferenciaHoras(
                parActual.entrada.fecha, parActual.entrada.hora,
                parSiguiente.entrada.fecha, parSiguiente.entrada.hora
              );
              
              if (horasDiff > UMBRAL_16_HORAS) {
                // Han pasado más de 16 horas sin salida, marcar como incompleto
                parActual.completo = false;
                console.log(`Regla 2 aplicada: ${horasDiff.toFixed(2)}h sin salida - marcado incompleto`);
                salidaEncontrada = true;
                break;
              }
            }
          }
        }
        
        paresMejorados.push(parActual);
      }
      
      return paresMejorados;
    }

    // ============ MOSTRAR TABLA SIMPLIFICADA ============
    function mostrarTabla(resultados) {
      if (resultados.length === 0) {
        tablaBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px;">No hay registros</td></tr>';
        return;
      }

      const colaboradoresMap = new Map();
      
      resultados.forEach(r => {
        if (!colaboradoresMap.has(r.codigo)) {
          colaboradoresMap.set(r.codigo, {
            codigo: r.codigo,
            nombre: r.nombre,
            totalExtras: 0
          });
        }
        
        const horas = calcularHoras(r.entrada, r.salida);
        const turno = r.turno || 8;
        const extras = horas > turno ? Math.round((horas - turno) * 100) / 100 : 0;
        
        const colaborador = colaboradoresMap.get(r.codigo);
        colaborador.totalExtras += extras;
      });

      let html = '';
      
      colaboradoresMap.forEach(col => {
        html += `
          <tr>
            <td><strong>${col.nombre}</strong><br><small style="color: var(--text-muted);">${col.codigo}</small></td>
            <td class="horas-extra">${col.totalExtras > 0 ? '+' + col.totalExtras.toFixed(2) + 'h' : '0h'}</td>
            <td>
              <button class="btn-ver" onclick='verDetalle("${col.codigo}")'>
                <i class="fas fa-eye"></i> Ver detalles
              </button>
            </td>
          </tr>
        `;
      });

      tablaBody.innerHTML = html;
    }

    function actualizarEstadisticas(resultados) {
      const totalRegistros = todosLosRegistros.length;
      const entradas = resultados.length;
      const salidas = resultados.filter(r => r.completo).length;

      document.getElementById('totalRegistros').textContent = totalRegistros;
      document.getElementById('totalEntradas').textContent = entradas;
      document.getElementById('totalSalidas').textContent = salidas;
      document.getElementById('totalPares').textContent = salidas;
    }

    // ============ FILTROS ============
    window.aplicarFiltros = () => {
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      const estado = document.getElementById('filtroEstado').value;

      let resultadosFiltrados = [...todosLosPares];

      if (fechaInicio) {
        resultadosFiltrados = resultadosFiltrados.filter(r => 
          r.entrada && r.entrada.fecha >= fechaInicio
        );
      }
      if (fechaFin) {
        resultadosFiltrados = resultadosFiltrados.filter(r => 
          r.entrada && r.entrada.fecha <= fechaFin
        );
      }

      if (estado === 'completo') {
        resultadosFiltrados = resultadosFiltrados.filter(r => r.completo);
      } else if (estado === 'incompleto') {
        resultadosFiltrados = resultadosFiltrados.filter(r => !r.completo);
      }

      resultadosFiltrados.sort((a, b) => {
        if (!a.entrada || !b.entrada) return 0;
        return b.entrada.fecha.localeCompare(a.entrada.fecha);
      });

      mostrarTabla(resultadosFiltrados);
    };

    window.limpiarFiltros = () => {
      document.getElementById('fechaInicio').value = '';
      document.getElementById('fechaFin').value = '';
      document.getElementById('filtroEstado').value = 'todos';
      
      const resultadosOrdenados = [...todosLosPares].sort((a, b) => {
        if (!a.entrada || !b.entrada) return 0;
        return b.entrada.fecha.localeCompare(a.entrada.fecha);
      });
      
      mostrarTabla(resultadosOrdenados);
    };

    function agruparRegistrosPorDia(registros) {
      const diasMap = new Map();
      
      registros.forEach(reg => {
        if (!reg.entrada) return;
        const fecha = reg.entrada.fecha;
        if (!diasMap.has(fecha)) {
          diasMap.set(fecha, {
            fecha: fecha,
            entrada: reg.entrada,
            salida: reg.salida,
            turno: reg.turno,
            completo: reg.completo
          });
        }
      });
      
      return Array.from(diasMap.values());
    }

    async function guardarRegistroEnFirebase(datosRegistro) {
      try {
        const docRef = await addDoc(collection(db, 'reportesGuardados'), {
          ...datosRegistro,
          guardadoPor: currentAdmin?.uid || 'unknown',
          guardadoPorNombre: currentAdmin?.name || 'unknown',
          fechaGuardado: serverTimestamp()
        });
        return { success: true, id: docRef.id };
      } catch (error) {
        console.error('Error al guardar:', error);
        return { success: false, error: error.message };
      }
    }

    // ============ MODAL DE DETALLE ============
    window.verDetalle = (codigo) => {
      colaboradorActual = codigo;
      const infoColaborador = empleadosMap.get(codigo) || { nombre: codigo, turno: 8 };
      const paresColaborador = todosLosPares.filter(p => p.codigo === codigo);
      
      paresColaborador.sort((a, b) => {
        if (!a.entrada || !b.entrada) return 0;
        return b.entrada.fecha.localeCompare(a.entrada.fecha);
      });

      document.getElementById('modalTitulo').textContent = infoColaborador.nombre || codigo;
      document.getElementById('modalCodigo').textContent = codigo;
      document.getElementById('modalTurno').textContent = (infoColaborador.turno || 8) + ' horas';

      // Calcular totales generales
      let totalExtrasGeneral = 0;
      let totalHorasGeneral = 0;
      
      paresColaborador.forEach(par => {
        const horas = calcularHoras(par.entrada, par.salida);
        const extras = horas > (par.turno || 8) ? horas - (par.turno || 8) : 0;
        totalHorasGeneral += horas;
        totalExtrasGeneral += extras;
      });

      document.getElementById('modalTotalExtras').textContent = totalExtrasGeneral.toFixed(2) + 'h';

      // Último registro
      const ultimoRegistro = paresColaborador.length > 0 ? paresColaborador[0] : null;
      
      if (ultimoRegistro && ultimoRegistro.entrada) {
        const hTrabajadas = calcularHoras(ultimoRegistro.entrada, ultimoRegistro.salida);
        const hTurno = infoColaborador.turno || 8;
        const hExtras = hTrabajadas > hTurno ? hTrabajadas - hTurno : 0;

        let registrosHtml = `
          <div class="detalle-row">
            <span>Entrada</span>
            <span>${ultimoRegistro.entrada.fecha} ${convertirA12HConSegundos(ultimoRegistro.entrada.hora)}</span>
          </div>
        `;

        if (ultimoRegistro.salida) {
          registrosHtml += `
            <div class="detalle-row">
              <span>Salida</span>
              <span>${ultimoRegistro.salida.fecha} ${convertirA12HConSegundos(ultimoRegistro.salida.hora)}</span>
            </div>
          `;
        } else {
          registrosHtml += `<div class="detalle-row" style="color: var(--warning);"><span>Sin salida registrada</span></div>`;
        }

        registrosHtml += `
          <div class="detalle-row" style="color: var(--primary); margin-top: 10px;">
            <span>Horas trabajadas</span>
            <span>${hTrabajadas.toFixed(2)}h</span>
          </div>
          <div class="detalle-row" style="color: var(--warning);">
            <span>Horas extras</span>
            <span>${hExtras > 0 ? '+' : ''}${hExtras.toFixed(2)}h</span>
          </div>
        `;

        document.getElementById('modalRegistros').innerHTML = registrosHtml;
        document.getElementById('modalTotales').innerHTML = `
          <span>Total día: ${hTrabajadas.toFixed(2)}h</span>
          <span>Extras: ${hExtras > 0 ? '+' : ''}${hExtras.toFixed(2)}h</span>
        `;
      } else {
        document.getElementById('modalRegistros').innerHTML = '<p style="text-align: center;">No hay registros</p>';
        document.getElementById('modalTotales').innerHTML = '';
      }

      // Historial completo
      const diasUnicos = agruparRegistrosPorDia(paresColaborador);
      diasUnicos.sort((a, b) => b.fecha.localeCompare(a.fecha));

      let tablaHtml = '';
      let totalDias = 0;
      let totalHorasCol = 0;
      let totalExtrasCol = 0;

      diasUnicos.forEach(dia => {
        const horas = calcularHoras(dia.entrada, dia.salida);
        const turno = dia.turno || 8;
        const extras = horas > turno ? (horas - turno) : 0;
        
        totalHorasCol += horas;
        totalExtrasCol += extras;
        totalDias++;

        const estado = dia.completo ? 'Completo' : 'Incompleto';
        const estadoClass = dia.completo ? 'badge-completo' : 'badge-exit';
        
        tablaHtml += `
          <tr>
            <td>${dia.fecha}</td>
            <td>${convertirA12HConSegundos(dia.entrada.hora)}</td>
            <td>${dia.salida ? convertirA12HConSegundos(dia.salida.hora) : '---'}</td>
            <td>${horas.toFixed(2)}h</td>
            <td class="extras-cell">${extras > 0 ? '+' + extras.toFixed(2) + 'h' : '0h'}</td>
            <td><span class="badge ${estadoClass}">${estado}</span></td>
          </tr>
        `;
      });

      document.getElementById('modalTablaBody').innerHTML = tablaHtml || '<tr><td colspan="6" style="text-align: center;">Sin historial</td></tr>';
      document.getElementById('modalHistorialTotales').innerHTML = `
        <span>Total días: ${totalDias}</span>
        <span>Horas totales: ${totalHorasCol.toFixed(2)}h</span>
      `;
      document.getElementById('modalExtrasTotales').innerHTML = `
        <span>Total horas extras:</span>
        <span>${totalExtrasCol.toFixed(2)}h</span>
      `;

      detalleModal.style.display = 'flex';
    };

    // ============ BOTÓN GUARDAR REGISTRO ============
    btnGuardarRegistro.addEventListener('click', async () => {
      if (!colaboradorActual) {
        showToast('No hay colaborador seleccionado', 'error');
        return;
      }

      showLoading('Guardando registro...');

      try {
        const paresColaborador = todosLosPares.filter(p => p.codigo === colaboradorActual);
        const infoColaborador = empleadosMap.get(colaboradorActual) || { nombre: colaboradorActual, turno: 8 };
        
        let totalHorasGeneral = 0;
        let totalExtrasGeneral = 0;
        
        paresColaborador.forEach(par => {
          const horas = calcularHoras(par.entrada, par.salida);
          const extras = horas > par.turno ? horas - par.turno : 0;
          totalHorasGeneral += horas;
          totalExtrasGeneral += extras;
        });

        const datosAGuardar = {
          colaborador: {
            codigo: colaboradorActual,
            nombre: infoColaborador.nombre,
            turno: infoColaborador.turno
          },
          totales: {
            horasTotales: totalHorasGeneral,
            extrasTotales: totalExtrasGeneral,
            diasTrabajados: paresColaborador.length
          },
          registrosPorDia: paresColaborador.map(par => ({
            fecha: par.entrada?.fecha || par.salida?.fecha,
            entrada: par.entrada ? {
              fecha: par.entrada.fecha,
              hora: par.entrada.hora,
              hora12h: convertirA12HConSegundos(par.entrada.hora).replace(/<[^>]*>/g, '')
            } : null,
            salida: par.salida ? {
              fecha: par.salida.fecha,
              hora: par.salida.hora,
              hora12h: convertirA12HConSegundos(par.salida.hora).replace(/<[^>]*>/g, '')
            } : null,
            horas: calcularHoras(par.entrada, par.salida),
            extras: calcularHoras(par.entrada, par.salida) > (par.turno || 8) ? 
              calcularHoras(par.entrada, par.salida) - (par.turno || 8) : 0,
            completo: par.completo
          })),
          fechaReporte: new Date().toISOString()
        };

        const resultado = await guardarRegistroEnFirebase(datosAGuardar);
        if (resultado.success) showToast('Registro guardado exitosamente', 'success');
        else showToast('Error al guardar: ' + resultado.error, 'error');
      } catch (error) {
        showToast('Error al guardar el registro', 'error');
      } finally {
        hideLoading();
      }
    });

    window.cerrarModal = () => {
      detalleModal.style.display = 'none';
      colaboradorActual = null;
    };

    window.addEventListener('click', (e) => {
      if (e.target === detalleModal) cerrarModal();
    });

    usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') passwordInput.focus(); }); 
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginBtn.click(); });

    const savedUser = sessionStorage.getItem('facial_currentUser');
    if (savedUser) {
      try {
        currentAdmin = JSON.parse(savedUser);
        adminName.textContent = currentAdmin.name;
        loginScreen.style.display = 'none';
        reportContainer.style.display = 'block';
        cargarRegistros();
      } catch (e) {
        sessionStorage.removeItem('facial_currentUser');
      }
    }
  </script>
</body>
</html>
