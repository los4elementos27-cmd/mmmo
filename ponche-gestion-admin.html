<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Registro Facial - Control de Personal</title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- face-api.js -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    /* ===== RESET Y VARIABLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    :root {
      --primary: #16e086;
      --primary-dark: #0da85c;
      --secondary: #2e4a55;
      --dark: #0e1c22;
      --darker: #0a1519;
      --light: #1a2c33;
      --danger: #e74c3c;
      --warning: #f39c12;
      --text: #ffffff;
      --text-muted: rgba(255,255,255,0.6);
      --border: #2a3f48;
      --border-light: #3a5a66;
    }

    body {
      background: linear-gradient(145deg, var(--darker), var(--dark));
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    /* ===== CONTENEDOR PRINCIPAL ===== */
    .app-container {
      width: 100%;
      max-width: 1400px;
      background: var(--light);
      border-radius: 28px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      border: 1px solid var(--border-light);
      max-height: 98vh;
      overflow-y: auto;
    }

    /* ===== T√çTULOS ===== */
    h1, h2, h3 {
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 {
      font-size: clamp(20px, 5vw, 28px);
      margin-bottom: 20px;
    }

    h1 i {
      color: var(--primary);
      background: rgba(22, 224, 134, 0.1);
      padding: 10px;
      border-radius: 16px;
    }

    h2 {
      font-size: clamp(18px, 4vw, 24px);
      margin: 25px 0 15px 0;
    }

    h2 i {
      color: var(--primary);
    }

    /* ===== NAVEGACI√ìN ENTRE P√ÅGINAS ===== */
    .nav-tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .nav-tab {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: clamp(14px, 4vw, 16px);
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .nav-tab.active {
      background: var(--primary);
      color: var(--darker);
    }

    .nav-tab i {
      font-size: 16px;
    }

    /* ===== LAYOUT HORIZONTAL RESPONSIVE ===== */
    .row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .col-camara {
      flex: 1.2;
      min-width: 300px;
    }

    .col-form {
      flex: 0.8;
      min-width: 300px;
    }

    /* ===== C√ÅMARA - SIN ESPEJO ===== */
    .camera-container {
      width: 100%;
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--primary);
      aspect-ratio: 4/3;
    }

    #registerVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(1); /* SIN ESPEJO - izquierda es izquierda */
    }

    .camera-overlay {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.8);
      color: var(--primary);
      padding: 8px 16px;
      border-radius: 40px;
      font-size: clamp(12px, 3vw, 14px);
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--primary);
      backdrop-filter: blur(4px);
    }

    /* ===== √ÅNGULOS - 5 POSICIONES ===== */
    .angulos-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 20px 0;
    }

    .angulo-card {
      background: var(--dark);
      border-radius: 14px;
      padding: 12px 5px;
      text-align: center;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }

    .angulo-card.active {
      border-color: var(--primary);
      background: #1a3a3a;
    }

    .angulo-card i {
      font-size: clamp(20px, 5vw, 24px);
      color: var(--primary);
      margin-bottom: 5px;
    }

    .angulo-card span {
      display: block;
      color: white;
      font-size: clamp(10px, 2.5vw, 12px);
    }

    .angulo-check {
      margin-top: 5px;
      min-height: 20px;
    }

    /* ===== FORMULARIO HORIZONTAL ===== */
    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-group {
      display: flex;
      align-items: center;
      background: var(--dark);
      border: 2px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .input-group label {
      background: var(--light);
      color: white;
      padding: 12px 16px;
      font-size: clamp(12px, 3vw, 14px);
      border-right: 2px solid var(--border);
      min-width: 100px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-group input {
      flex: 1;
      padding: 12px 16px;
      background: var(--dark);
      border: none;
      color: white;
      font-size: clamp(14px, 3.5vw, 16px);
    }

    .input-group input:focus {
      outline: none;
      background: var(--light);
    }

    /* ===== SELECTOR DE FOTO ELEGANTE ===== */
    .photo-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      background: var(--dark);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 10px 15px;
    }

    .photo-preview {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 28px;
      border: 2px dashed var(--primary);
      overflow: hidden;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-upload-btn {
      flex: 1;
      background: var(--secondary);
      color: white;
      padding: 12px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      border: none;
    }

    #fotoBase64 {
      display: none;
    }

    /* ===== BOTONES ===== */
    .btn-actions {
      display: flex;
      gap: 12px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 16px;
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      flex: 1 1 auto;
    }

    .btn-primary {
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
      color: var(--darker);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-success {
      background: var(--warning);
      color: var(--darker);
    }

    /* ===== TABLA DE COLABORADORES ===== */
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      border-radius: 16px;
    }

    .table-header {
      display: grid;
      grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 0.8fr;
      background: var(--primary);
      color: var(--darker);
      padding: 12px 15px;
      border-radius: 12px 12px 0 0;
      font-weight: bold;
      font-size: clamp(12px, 3vw, 14px);
      min-width: 600px;
    }

    .table-row {
      display: grid;
      grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 0.8fr;
      background: var(--dark);
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      color: white;
      align-items: center;
      font-size: clamp(12px, 3vw, 14px);
      min-width: 600px;
    }

    .badge {
      background: var(--primary);
      color: var(--darker);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      background: var(--secondary);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: var(--primary);
      color: var(--darker);
    }

    /* ===== MODAL DE DETALLES ===== */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      background: var(--light);
      border-radius: 24px;
      padding: 25px;
      border: 2px solid var(--primary);
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      color: white;
    }

    .close-modal {
      background: transparent;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
    }

    /* ===== TARJETAS DE REGISTROS ===== */
    .registros-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .registro-dia-card {
      background: var(--dark);
      border-radius: 16px;
      padding: 15px;
      border-left: 5px solid var(--primary);
    }

    .dia-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      color: white;
    }

    .dia-fecha {
      font-weight: bold;
      color: var(--primary);
    }

    .registro-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed var(--border);
      color: var(--text-muted);
    }

    .horas-extras {
      background: var(--warning);
      color: var(--darker);
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    /* ===== TOAST Y LOADING ===== */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 20px;
      right: 20px;
      background: rgba(22, 224, 134, 0.95);
      color: white;
      padding: 16px 20px;
      border-radius: 50px;
      text-align: center;
      font-weight: bold;
      display: none;
      z-index: 20000;
      backdrop-filter: blur(10px);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30000;
    }

    .spinner {
      border: 5px solid rgba(22, 224, 134, 0.2);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== RESPONSIVE M√ìVIL ===== */
    @media (max-width: 768px) {
      .app-container {
        padding: 15px;
        border-radius: 20px;
      }

      .col-camara, .col-form {
        min-width: 100%;
      }

      .angulos-container {
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
      }

      .angulo-card {
        padding: 8px 3px;
      }

      .angulo-card i {
        font-size: 20px;
      }

      .input-group {
        flex-direction: column;
        align-items: stretch;
      }

      .input-group label {
        border-right: none;
        border-bottom: 2px solid var(--border);
        min-width: 100%;
      }

      .btn-actions {
        flex-direction: column;
      }

      .table-header, .table-row {
        grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 0.8fr;
        font-size: 11px;
        padding: 10px;
      }

      .btn-icon {
        width: 32px;
        height: 32px;
      }
    }

    /* ===== SECCIONES ===== */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- LOADING -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="color: white; font-size: 18px;">Cargando modelos faciales...</div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toastNotification"></div>

  <!-- MODAL DE DETALLES DEL COLABORADOR -->
  <div id="detalleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitulo" style="color: white;"><i class="fas fa-user"></i> Detalles del Colaborador</h3>
        <button class="close-modal" id="closeModalBtn">&times;</button>
      </div>
      <div id="modalContenido" style="color: white;">
        <!-- Se llena din√°micamente -->
      </div>
    </div>
  </div>

  <div class="app-container">
    <!-- NAVEGACI√ìN ENTRE P√ÅGINAS -->
    <div class="nav-tabs">
      <button id="navRegistroBtn" class="nav-tab active">
        <i class="fas fa-camera-retro"></i> Registro
      </button>
      <button id="navHistorialBtn" class="nav-tab">
        <i class="fas fa-history"></i> Historial
      </button>
    </div>

    <!-- ===== SECCI√ìN 1: REGISTRO DE COLABORADORES ===== -->
    <div id="seccionRegistro" class="section active">
      <h1>
        <i class="fas fa-user-plus"></i> 
        Registro Facial - 5 √Ångulos
      </h1>

      <!-- LAYOUT HORIZONTAL -->
      <div class="row">
        <!-- COLUMNA C√ÅMARA -->
        <div class="col-camara">
          <div class="camera-container">
            <video id="registerVideo" autoplay muted playsinline></video>
            <div class="camera-overlay" id="cameraOverlay">
              <i class="fas fa-camera"></i> √Ångulo: FRONTAL
            </div>
          </div>

          <!-- 5 √ÅNGULOS DE CAPTURA -->
          <div class="angulos-container">
            <div id="anguloFrontal" class="angulo-card active">
              <i class="fas fa-user"></i>
              <span>FRONTAL</span>
              <div id="checkFrontal" class="angulo-check"></div>
            </div>
            <div id="anguloIzquierdo" class="angulo-card">
              <i class="fas fa-user fa-flip-horizontal"></i>
              <span>IZQUIERDO</span>
              <div id="checkIzquierdo" class="angulo-check"></div>
            </div>
            <div id="anguloDerecho" class="angulo-card">
              <i class="fas fa-user"></i>
              <span>DERECHO</span>
              <div id="checkDerecho" class="angulo-check"></div>
            </div>
            <div id="anguloArriba" class="angulo-card">
              <i class="fas fa-user"></i>
              <span>ARRIBA</span>
              <div id="checkArriba" class="angulo-check"></div>
            </div>
            <div id="anguloAbajo" class="angulo-card">
              <i class="fas fa-user"></i>
              <span>ABAJO</span>
              <div id="checkAbajo" class="angulo-check"></div>
            </div>
          </div>

          <!-- BOTONES DE C√ÅMARA -->
          <div class="btn-actions">
            <button id="captureFaceBtn" class="btn btn-primary">
              <i class="fas fa-camera-retro"></i> Capturar
            </button>
            <button id="refreshCameraBtn" class="btn btn-secondary">
              <i class="fas fa-sync-alt"></i> Reiniciar
            </button>
          </div>
        </div>

        <!-- COLUMNA FORMULARIO -->
        <div class="col-form">
          <div class="form-grid">
            <div class="input-group">
              <label><i class="fas fa-user"></i> Nombre</label>
              <input type="text" id="regName" placeholder="Ej: Juan P√©rez" autocomplete="off">
            </div>

            <div class="input-group">
              <label><i class="fas fa-id-card"></i> C√≥digo</label>
              <input type="text" id="regCode" placeholder="Ej: RTM-12345" autocomplete="off">
            </div>

            <div class="input-group">
              <label><i class="fas fa-lock"></i> PIN</label>
              <input type="password" id="regPin" placeholder="1234" maxlength="4" inputmode="numeric">
            </div>

            <div class="input-group">
              <label><i class="fas fa-clock"></i> Horas/d√≠a</label>
              <input type="number" id="regHoras" placeholder="8" value="8" min="1" max="24">
            </div>

            <!-- SELECTOR DE FOTO ELEGANTE (sin URL) -->
            <div class="photo-selector">
              <div class="photo-preview" id="photoPreview">
                <i class="fas fa-user"></i>
              </div>
              <button id="selectPhotoBtn" class="photo-upload-btn">
                <i class="fas fa-image"></i> Seleccionar Foto
              </button>
              <input type="file" id="fotoFile" accept="image/*" style="display: none;">
              <input type="hidden" id="fotoBase64">
            </div>

            <button id="saveCollaboratorBtn" class="btn btn-success" style="margin-top: 10px;">
              <i class="fas fa-save"></i> GUARDAR COLABORADOR (0/5 √°ngulos)
            </button>
          </div>
        </div>
      </div>

      <!-- LISTA DE COLABORADORES -->
      <h2 style="margin-top: 30px;">
        <i class="fas fa-users"></i> Colaboradores Registrados
      </h2>
      
      <div class="table-responsive">
        <div class="table-header">
          <div>NOMBRE</div>
          <div>C√ìDIGO</div>
          <div>√ÅNGULOS</div>
          <div>HORAS</div>
          <div>ACCIONES</div>
        </div>
        
        <div id="listaColaboradores">
          <!-- Se llena din√°micamente -->
        </div>
      </div>
    </div>

    <!-- ===== SECCI√ìN 2: HISTORIAL GENERAL ===== -->
    <div id="seccionHistorial" class="section">
      <h1>
        <i class="fas fa-chart-line"></i> 
        Historial de Asistencia
      </h1>

      <!-- RESUMEN GLOBAL -->
      <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <div style="background: var(--dark); padding: 20px; border-radius: 20px; flex: 1; min-width: 200px;">
          <div style="color: var(--primary); font-size: 14px;">TOTAL COLABORADORES</div>
          <div id="totalColaboradoresHistorial" style="color: white; font-size: 32px; font-weight: bold;">0</div>
        </div>
        <div style="background: var(--dark); padding: 20px; border-radius: 20px; flex: 1; min-width: 200px;">
          <div style="color: var(--primary); font-size: 14px;">REGISTROS HOY</div>
          <div id="totalRegistrosHoy" style="color: white; font-size: 32px; font-weight: bold;">0</div>
        </div>
        <div style="background: var(--dark); padding: 20px; border-radius: 20px; flex: 1; min-width: 200px;">
          <div style="color: var(--primary); font-size: 14px;">HORAS EXTRAS (HOY)</div>
          <div id="totalExtrasHoy" style="color: var(--warning); font-size: 32px; font-weight: bold;">0.0</div>
        </div>
      </div>

      <!-- TABLA DE HISTORIAL GENERAL -->
      <div class="table-responsive">
        <div class="table-header" style="grid-template-columns: 1.5fr 1fr 2fr 1fr 1fr;">
          <div>COLABORADOR</div>
          <div>FECHA</div>
          <div>REGISTROS</div>
          <div>HORAS</div>
          <div>EXTRAS</div>
        </div>
        
        <div id="historialGeneralContainer">
          <!-- Se llena din√°micamente -->
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ============================================================
    // FIREBASE - CONFIGURACI√ìN
    // ============================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      Timestamp,
      query,
      where,
      getDocs,
      doc,
      deleteDoc,
      orderBy,
      updateDoc,
      getDoc,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
      measurementId: "G-HJNZXRENE9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ============================================================
    // VARIABLES GLOBALES
    // ============================================================
    let modelsLoaded = false;
    let videoStream = null;
    
    // 5 √ÅNGULOS
    let descriptoresCapturados = {
      frontal: null,
      izquierdo: null,
      derecho: null,
      arriba: null,
      abajo: null
    };

    // Elementos DOM
    const video = document.getElementById('registerVideo');
    const regName = document.getElementById('regName');
    const regCode = document.getElementById('regCode');
    const regPin = document.getElementById('regPin');
    const regHoras = document.getElementById('regHoras');
    const fotoFile = document.getElementById('fotoFile');
    const fotoBase64 = document.getElementById('fotoBase64');
    const photoPreview = document.getElementById('photoPreview');
    const selectPhotoBtn = document.getElementById('selectPhotoBtn');
    const captureBtn = document.getElementById('captureFaceBtn');
    const saveBtn = document.getElementById('saveCollaboratorBtn');
    const refreshBtn = document.getElementById('refreshCameraBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const toast = document.getElementById('toastNotification');
    const listaColaboradores = document.getElementById('listaColaboradores');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const navRegistroBtn = document.getElementById('navRegistroBtn');
    const navHistorialBtn = document.getElementById('navHistorialBtn');
    const seccionRegistro = document.getElementById('seccionRegistro');
    const seccionHistorial = document.getElementById('seccionHistorial');
    const historialGeneralContainer = document.getElementById('historialGeneralContainer');
    const totalColaboradoresHistorial = document.getElementById('totalColaboradoresHistorial');
    const totalRegistrosHoy = document.getElementById('totalRegistrosHoy');
    const totalExtrasHoy = document.getElementById('totalExtrasHoy');
    const detalleModal = document.getElementById('detalleModal');
    const modalContenido = document.getElementById('modalContenido');
    const modalTitulo = document.getElementById('modalTitulo');
    const closeModalBtn = document.getElementById('closeModalBtn');
    
    // √Ångulos
    const anguloFrontal = document.getElementById('anguloFrontal');
    const anguloIzquierdo = document.getElementById('anguloIzquierdo');
    const anguloDerecho = document.getElementById('anguloDerecho');
    const anguloArriba = document.getElementById('anguloArriba');
    const anguloAbajo = document.getElementById('anguloAbajo');
    
    const checkFrontal = document.getElementById('checkFrontal');
    const checkIzquierdo = document.getElementById('checkIzquierdo');
    const checkDerecho = document.getElementById('checkDerecho');
    const checkArriba = document.getElementById('checkArriba');
    const checkAbajo = document.getElementById('checkAbajo');
    
    let anguloActual = 'frontal';

    // ============================================================
    // FUNCIONES UTILITARIAS
    // ============================================================
    function showLoading(message = 'Cargando...') {
      loadingText.textContent = message;
      loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    function showToast(msg, type = 'success') {
      toast.textContent = msg;
      toast.style.background = type === 'success' ? 'rgba(22, 224, 134, 0.95)' : 
                             type === 'error' ? 'rgba(231, 76, 60, 0.95)' : 
                             'rgba(243, 156, 18, 0.95)';
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 4000);
    }

    function formatearFecha(date) {
      return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function formatearHora(date) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // ============================================================
    // NAVEGACI√ìN ENTRE P√ÅGINAS
    // ============================================================
    navRegistroBtn.addEventListener('click', () => {
      navRegistroBtn.classList.add('active');
      navHistorialBtn.classList.remove('active');
      seccionRegistro.classList.add('active');
      seccionHistorial.classList.remove('active');
    });

    navHistorialBtn.addEventListener('click', () => {
      navHistorialBtn.classList.add('active');
      navRegistroBtn.classList.remove('active');
      seccionHistorial.classList.add('active');
      seccionRegistro.classList.remove('active');
      cargarHistorialGeneral();
    });

    // ============================================================
    // SELECTOR DE FOTO ELEGANTE
    // ============================================================
    selectPhotoBtn.addEventListener('click', () => {
      fotoFile.click();
    });

    fotoFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const base64 = event.target.result;
          fotoBase64.value = base64;
          
          // Mostrar preview
          photoPreview.innerHTML = `<img src="${base64}" style="width: 100%; height: 100%; object-fit: cover;">`;
        };
        reader.readAsDataURL(file);
      }
    });

    // ============================================================
    // 1. CARGAR MODELOS
    // ============================================================
    async function loadFaceApiModels() {
      showLoading('Cargando modelos faciales...');
      
      try {
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        modelsLoaded = true;
        hideLoading();
        showToast('Modelos faciales cargados ‚úÖ', 'success');
        return true;
      } catch (error) {
        try {
          const FALLBACK_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';
          await faceapi.nets.tinyFaceDetector.loadFromUri(FALLBACK_URL);
          await faceapi.nets.faceLandmark68Net.loadFromUri(FALLBACK_URL);
          await faceapi.nets.faceRecognitionNet.loadFromUri(FALLBACK_URL);
          
          modelsLoaded = true;
          hideLoading();
          showToast('Modelos cargados (alternativo)', 'success');
          return true;
        } catch (fallbackError) {
          hideLoading();
          showToast('No se pudieron cargar los modelos', 'error');
          return false;
        }
      }
    }

    // ============================================================
    // 2. INICIAR C√ÅMARA (SIN ESPEJO)
    // ============================================================
    async function startCamera() {
      try {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
        }
        
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          }
        });
        
        video.srcObject = videoStream;
        await video.play();
        
        // SIN ESPEJO - izquierda es izquierda, derecha es derecha
        video.style.transform = 'scaleX(1)';
        
        showToast('C√°mara lista', 'success');
      } catch (error) {
        showToast('No se pudo acceder a la c√°mara', 'error');
      }
    }

    // ============================================================
    // 3. CAMBIAR √ÅNGULO ACTIVO
    // ============================================================
    function setAnguloActivo(angulo) {
      anguloActual = angulo;
      
      const angulos = [anguloFrontal, anguloIzquierdo, anguloDerecho, anguloArriba, anguloAbajo];
      angulos.forEach(a => a.classList.remove('active'));
      
      if (angulo === 'frontal') anguloFrontal.classList.add('active');
      if (angulo === 'izquierdo') anguloIzquierdo.classList.add('active');
      if (angulo === 'derecho') anguloDerecho.classList.add('active');
      if (angulo === 'arriba') anguloArriba.classList.add('active');
      if (angulo === 'abajo') anguloAbajo.classList.add('active');
      
      cameraOverlay.innerHTML = `<i class="fas fa-camera"></i> √Ångulo: ${angulo.toUpperCase()}`;
    }

    // ============================================================
    // 4. CAPTURAR DESCRIPTOR DEL √ÅNGULO ACTUAL
    // ============================================================
    async function captureCurrentAngle() {
      if (!modelsLoaded) {
        showToast('Modelos no cargados', 'error');
        return;
      }

      showLoading(`Capturando √°ngulo ${anguloActual}...`);

      try {
        const detections = await faceapi.detectAllFaces(video, 
          new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
        
        if (detections.length === 0) {
          hideLoading();
          showToast('No se detect√≥ ning√∫n rostro', 'error');
          return;
        }

        const descriptor = detections[0].descriptor;
        const descriptorArray = Array.from(descriptor);
        
        descriptoresCapturados[anguloActual] = descriptorArray;
        
        const checks = {
          frontal: checkFrontal,
          izquierdo: checkIzquierdo,
          derecho: checkDerecho,
          arriba: checkArriba,
          abajo: checkAbajo
        };
        
        checks[anguloActual].innerHTML = '<i class="fas fa-check-circle" style="color: #16e086; font-size: 20px;"></i>';
        
        const orden = ['frontal', 'izquierdo', 'derecho', 'arriba', 'abajo'];
        const indexActual = orden.indexOf(anguloActual);
        if (indexActual < orden.length - 1) {
          setAnguloActivo(orden[indexActual + 1]);
        }
        
        const capturados = Object.values(descriptoresCapturados).filter(d => d !== null).length;
        
        hideLoading();
        showToast(`‚úÖ √Ångulo ${anguloActual} capturado (${capturados}/5)`, 'success');
        
        if (capturados === 5) {
          saveBtn.style.background = '#16e086';
          saveBtn.innerHTML = '<i class="fas fa-save"></i> GUARDAR COLABORADOR (COMPLETO)';
        } else {
          saveBtn.innerHTML = `<i class="fas fa-save"></i> GUARDAR COLABORADOR (${capturados}/5 √°ngulos)`;
        }
        
      } catch (error) {
        hideLoading();
        showToast('Error capturando descriptor', 'error');
      }
    }

    // ============================================================
    // 5. GUARDAR COLABORADOR EN COLECCI√ìN "Ponche"
    // ============================================================
    async function saveCollaborator() {
      if (!regName.value.trim()) {
        showToast('Ingresa el nombre', 'error');
        return;
      }
      
      if (!regCode.value.trim()) {
        showToast('Ingresa el c√≥digo', 'error');
        return;
      }
      
      const capturados = Object.values(descriptoresCapturados).filter(d => d !== null).length;
      if (capturados < 5) {
        showToast(`Debes capturar los 5 √°ngulos (solo tienes ${capturados}/5)`, 'error');
        return;
      }
      
      let pin = regPin.value.trim();
      if (!pin) pin = '1234';
      
      let horasDiarias = parseInt(regHoras.value) || 8;
      
      let fotoUrl = fotoBase64.value || '';
      
      showLoading('Guardando colaborador en Ponche...');
      
      try {
        const q = query(collection(db, "Ponche"), where("username", "==", regCode.value.trim()));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          hideLoading();
          showToast('Este c√≥digo ya existe en Ponche', 'error');
          return;
        }

        function generateProfileId(code) {
          const random = Math.floor(10000 + Math.random() * 90000);
          return `${code || 'RTM'}-${random}`.substring(0, 15);
        }

        const collaboratorData = {
          firstName: regName.value.trim().split(' ')[0],
          lastName: regName.value.trim().split(' ').slice(1).join(' ') || '',
          username: regCode.value.trim(),
          pin: pin,
          horasDiarias: horasDiarias,
          facialDescriptorFrontal: descriptoresCapturados.frontal,
          facialDescriptorIzquierdo: descriptoresCapturados.izquierdo,
          facialDescriptorDerecho: descriptoresCapturados.derecho,
          facialDescriptorArriba: descriptoresCapturados.arriba,
          facialDescriptorAbajo: descriptoresCapturados.abajo,
          uniqueProfileId: generateProfileId(regCode.value.trim()),
          fotoBase64: fotoUrl,
          registeredAt: Timestamp.now(),
          createdAt: Timestamp.now(),
          updatedAt: Timestamp.now()
        };

        const docRef = await addDoc(collection(db, "Ponche"), collaboratorData);
        
        hideLoading();
        showToast(`‚úÖ Colaborador registrado con 5 √°ngulos en Ponche`, 'success');
        
        regName.value = '';
        regCode.value = '';
        regPin.value = '';
        regHoras.value = '8';
        fotoBase64.value = '';
        photoPreview.innerHTML = '<i class="fas fa-user"></i>';
        fotoFile.value = '';
        
        descriptoresCapturados = { frontal: null, izquierdo: null, derecho: null, arriba: null, abajo: null };
        checkFrontal.innerHTML = '';
        checkIzquierdo.innerHTML = '';
        checkDerecho.innerHTML = '';
        checkArriba.innerHTML = '';
        checkAbajo.innerHTML = '';
        setAnguloActivo('frontal');
        saveBtn.style.background = '#f39c12';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> GUARDAR COLABORADOR (0/5 √°ngulos)';
        
        cargarListaColaboradores();
        cargarHistorialGeneral();
        
      } catch (error) {
        hideLoading();
        showToast('Error al registrar: ' + error.message, 'error');
      }
    }

    // ============================================================
    // 6. CARGAR LISTA DE COLABORADORES
    // ============================================================
    async function cargarListaColaboradores() {
      try {
        const q = query(collection(db, "Ponche"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          listaColaboradores.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px; grid-column: span 5;">No hay colaboradores registrados en Ponche</div>';
          return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const nombre = `${data.firstName || ''} ${data.lastName || ''}`.trim() || data.username || 'Sin nombre';
          const codigo = data.uniqueProfileId || data.username || 'Sin c√≥digo';
          
          let angulos = 0;
          if (data.facialDescriptorFrontal) angulos++;
          if (data.facialDescriptorIzquierdo) angulos++;
          if (data.facialDescriptorDerecho) angulos++;
          if (data.facialDescriptorArriba) angulos++;
          if (data.facialDescriptorAbajo) angulos++;
          
          const horas = data.horasDiarias || 8;
          
          html += `
            <div class="table-row">
              <div style="font-weight: bold;">${nombre}</div>
              <div style="color: #16e086;">${codigo}</div>
              <div><span class="badge">${angulos}/5 √°ngulos</span></div>
              <div>${horas} hrs</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn-icon" onclick="window.verDetalles('${doc.id}')" title="Ver detalles">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-icon" onclick="window.editarColaborador('${doc.id}')" title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon" onclick="window.eliminarColaborador('${doc.id}')" title="Eliminar" style="background: #c0392b;">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        });
        
        listaColaboradores.innerHTML = html;
        
      } catch (error) {
        console.error('Error cargando lista:', error);
        listaColaboradores.innerHTML = '<div style="color: #e74c3c; text-align: center; grid-column: span 5;">Error cargando colaboradores</div>';
      }
    }

    // ============================================================
    // 7. VER DETALLES DEL COLABORADOR (MODAL)
    // ============================================================
    window.verDetalles = async function(id) {
      try {
        showLoading('Cargando detalles...');
        
        const docRef = doc(db, "Ponche", id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
          hideLoading();
          showToast('Colaborador no encontrado', 'error');
          return;
        }
        
        const data = docSnap.data();
        const nombre = `${data.firstName || ''} ${data.lastName || ''}`.trim() || data.username || 'Sin nombre';
        const codigo = data.uniqueProfileId || data.username || 'Sin c√≥digo';
        const horasDiarias = data.horasDiarias || 8;
        
        // Cargar registros de asistencia
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', id),
          orderBy('timestamp', 'desc')
        );
        
        const registrosSnap = await getDocs(q);
        
        // Agrupar por fecha
        const registrosPorDia = {};
        let totalHorasQuincena = 0;
        let totalExtrasQuincena = 0;
        
        registrosSnap.forEach(doc => {
          const reg = doc.data();
          const fecha = formatearFecha(reg.timestamp.toDate());
          
          if (!registrosPorDia[fecha]) {
            registrosPorDia[fecha] = [];
          }
          
          registrosPorDia[fecha].push({
            timestamp: reg.timestamp,
            type: reg.type,
            hora: formatearHora(reg.timestamp.toDate())
          });
        });
        
        // Calcular horas por d√≠a
        let html = `
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--secondary); display: flex; align-items: center; justify-content: center; overflow: hidden;">
              ${data.fotoBase64 ? `<img src="${data.fotoBase64}" style="width: 100%; height: 100%; object-fit: cover;">` : `<i class="fas fa-user" style="font-size: 40px; color: var(--primary);"></i>`}
            </div>
            <div>
              <h3 style="color: white; margin-bottom: 5px;">${nombre}</h3>
              <p style="color: var(--primary); font-size: 16px;">${codigo}</p>
              <p style="color: rgba(255,255,255,0.6);">Horas diarias: ${horasDiarias} hrs</p>
            </div>
          </div>
        `;
        
        if (registrosSnap.empty) {
          html += '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 30px;">No hay registros de asistencia</p>';
        } else {
          html += '<h4 style="color: white; margin-bottom: 15px;">Registros por d√≠a:</h4>';
          
          // Ordenar fechas descendente
          const fechas = Object.keys(registrosPorDia).sort((a,b) => new Date(b) - new Date(a));
          
          fechas.forEach(fecha => {
            const registros = registrosPorDia[fecha].sort((a,b) => a.timestamp.toDate() - b.timestamp.toDate());
            
            // Calcular horas trabajadas en el d√≠a
            let segundosTrabajados = 0;
            for (let i = 0; i < registros.length; i += 2) {
              if (i + 1 < registros.length) {
                const entrada = registros[i].timestamp.toDate();
                const salida = registros[i + 1].timestamp.toDate();
                segundosTrabajados += (salida - entrada) / 1000;
              }
            }
            
            const horasTrabajadas = segundosTrabajados / 3600;
            const extras = Math.max(0, horasTrabajadas - horasDiarias);
            
            totalHorasQuincena += horasTrabajadas;
            totalExtrasQuincena += extras;
            
            let registrosHtml = '';
            registros.forEach((reg, index) => {
              const tipo = reg.type === 'entry' ? '‚úÖ Entrada' : 'üö™ Salida';
              registrosHtml += `<div style="display: flex; justify-content: space-between; padding: 5px 0;">
                <span>${tipo}</span>
                <span>${reg.hora}</span>
              </div>`;
            });
            
            html += `
              <div style="background: var(--dark); border-radius: 16px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span style="color: var(--primary); font-weight: bold;">${fecha}</span>
                  <span style="color: white;">${horasTrabajadas.toFixed(2)} hrs</span>
                </div>
                ${registrosHtml}
                ${extras > 0 ? `<div style="margin-top: 10px; color: var(--warning);"><i class="fas fa-clock"></i> Horas extras: ${extras.toFixed(2)}</div>` : ''}
              </div>
            `;
          });
          
          html += `
            <div style="background: var(--secondary); border-radius: 16px; padding: 20px; margin-top: 20px;">
              <div style="display: flex; justify-content: space-between; color: white; font-size: 18px;">
                <span>TOTAL QUINCENA:</span>
                <span style="font-weight: bold;">${totalHorasQuincena.toFixed(2)} hrs</span>
              </div>
              <div style="display: flex; justify-content: space-between; color: var(--warning); font-size: 16px; margin-top: 10px;">
                <span>HORAS EXTRAS:</span>
                <span style="font-weight: bold;">${totalExtrasQuincena.toFixed(2)} hrs</span>
              </div>
              <button id="reiniciarQuincenaBtn" class="btn btn-secondary" style="margin-top: 20px; width: 100%; background: var(--warning); color: var(--darker);">
                <i class="fas fa-rotate-left"></i> REINICIAR QUINCENA (GUARDAR HISTORIAL)
              </button>
            </div>
          `;
        }
        
        modalTitulo.innerHTML = `<i class="fas fa-user"></i> Detalles: ${nombre}`;
        modalContenido.innerHTML = html;
        detalleModal.style.display = 'flex';
        
        // Bot√≥n reiniciar quincena
        const reiniciarBtn = document.getElementById('reiniciarQuincenaBtn');
        if (reiniciarBtn) {
          reiniciarBtn.addEventListener('click', () => reiniciarQuincena(id, nombre));
        }
        
        hideLoading();
        
      } catch (error) {
        hideLoading();
        console.error('Error cargando detalles:', error);
        showToast('Error cargando detalles', 'error');
      }
    };

    // ============================================================
    // 8. REINICIAR QUINCENA
    // ============================================================
    async function reiniciarQuincena(colaboradorId, nombre) {
      if (!confirm(`¬øEst√°s seguro de reiniciar la quincena de ${nombre}? Se guardar√° un historial y se resetear√°n los contadores.`)) {
        return;
      }
      
      try {
        showLoading('Reiniciando quincena...');
        
        // Guardar historial de la quincena actual
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', colaboradorId),
          orderBy('timestamp', 'desc')
        );
        
        const registros = await getDocs(q);
        
        if (!registros.empty) {
          // Guardar en colecci√≥n "HistorialQuincenas"
          const historialData = {
            collaboratorId: colaboradorId,
            collaboratorName: nombre,
            registros: registros.docs.map(doc => doc.data()),
            fechaCierre: Timestamp.now(),
            totalRegistros: registros.size
          };
          
          await addDoc(collection(db, 'HistorialQuincenas'), historialData);
        }
        
        // Eliminar registros actuales
        const batch = [];
        registros.forEach(doc => {
          batch.push(deleteDoc(doc.ref));
        });
        
        await Promise.all(batch);
        
        hideLoading();
        showToast('Quincena reiniciada exitosamente', 'success');
        
        // Cerrar modal y recargar
        detalleModal.style.display = 'none';
        cargarHistorialGeneral();
        
      } catch (error) {
        hideLoading();
        console.error('Error reiniciando quincena:', error);
        showToast('Error al reiniciar quincena', 'error');
      }
    }

    // ============================================================
    // 9. EDITAR COLABORADOR
    // ============================================================
    window.editarColaborador = async function(id) {
      try {
        showLoading('Cargando datos...');
        
        const docRef = doc(db, "Ponche", id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
          hideLoading();
          showToast('Colaborador no encontrado', 'error');
          return;
        }
        
        const data = docSnap.data();
        
        // Cambiar a pesta√±a de registro
        navRegistroBtn.click();
        
        // Llenar formulario
        regName.value = `${data.firstName || ''} ${data.lastName || ''}`.trim();
        regCode.value = data.username || '';
        regPin.value = data.pin || '';
        regHoras.value = data.horasDiarias || 8;
        
        if (data.fotoBase64) {
          fotoBase64.value = data.fotoBase64;
          photoPreview.innerHTML = `<img src="${data.fotoBase64}" style="width: 100%; height: 100%; object-fit: cover;">`;
        }
        
        // Marcar √°ngulos existentes
        if (data.facialDescriptorFrontal) {
          descriptoresCapturados.frontal = data.facialDescriptorFrontal;
          checkFrontal.innerHTML = '<i class="fas fa-check-circle" style="color: #16e086; font-size: 20px;"></i>';
        }
        if (data.facialDescriptorIzquierdo) {
          descriptoresCapturados.izquierdo = data.facialDescriptorIzquierdo;
          checkIzquierdo.innerHTML = '<i class="fas fa-check-circle" style="color: #16e086; font-size: 20px;"></i>';
        }
        if (data.facialDescriptorDerecho) {
          descriptoresCapturados.derecho = data.facialDescriptorDerecho;
          checkDerecho.innerHTML = '<i class="fas fa-check-circle" style="color: #16e086; font-size: 20px;"></i>';
        }
        if (data.facialDescriptorArriba) {
          descriptoresCapturados.arriba = data.facialDescriptorArriba;
          checkArriba.innerHTML = '<i class="fas fa-check-circle" style="color: #16e086; font-size: 20px;"></i>';
        }
        if (data.facialDescriptorAbajo) {
          descriptoresCapturados.abajo = data.facialDescriptorAbajo;
          checkAbajo.innerHTML = '<i class="fas fa-check-circle" style="color: #16e086; font-size: 20px;"></i>';
        }
        
        const capturados = Object.values(descriptoresCapturados).filter(d => d !== null).length;
        saveBtn.innerHTML = `<i class="fas fa-save"></i> ACTUALIZAR COLABORADOR (${capturados}/5 √°ngulos)`;
        
        // Cambiar acci√≥n del bot√≥n guardar
        saveBtn.removeEventListener('click', saveCollaborator);
        saveBtn.addEventListener('click', () => updateCollaborator(id));
        
        hideLoading();
        showToast('Editando colaborador', 'info');
        
      } catch (error) {
        hideLoading();
        console.error('Error editando:', error);
        showToast('Error al cargar datos', 'error');
      }
    };

    // ============================================================
    // 10. ACTUALIZAR COLABORADOR
    // ============================================================
    async function updateCollaborator(id) {
      if (!regName.value.trim() || !regCode.value.trim()) {
        showToast('Nombre y c√≥digo requeridos', 'error');
        return;
      }
      
      const capturados = Object.values(descriptoresCapturados).filter(d => d !== null).length;
      if (capturados < 5) {
        showToast(`Debes tener los 5 √°ngulos (${capturados}/5)`, 'error');
        return;
      }
      
      showLoading('Actualizando colaborador...');
      
      try {
        const docRef = doc(db, "Ponche", id);
        
        const updateData = {
          firstName: regName.value.trim().split(' ')[0],
          lastName: regName.value.trim().split(' ').slice(1).join(' ') || '',
          username: regCode.value.trim(),
          pin: regPin.value.trim() || '1234',
          horasDiarias: parseInt(regHoras.value) || 8,
          facialDescriptorFrontal: descriptoresCapturados.frontal,
          facialDescriptorIzquierdo: descriptoresCapturados.izquierdo,
          facialDescriptorDerecho: descriptoresCapturados.derecho,
          facialDescriptorArriba: descriptoresCapturados.arriba,
          facialDescriptorAbajo: descriptoresCapturados.abajo,
          fotoBase64: fotoBase64.value || '',
          updatedAt: Timestamp.now()
        };
        
        await updateDoc(docRef, updateData);
        
        hideLoading();
        showToast('‚úÖ Colaborador actualizado', 'success');
        
        // Resetear formulario
        regName.value = '';
        regCode.value = '';
        regPin.value = '';
        regHoras.value = '8';
        fotoBase64.value = '';
        photoPreview.innerHTML = '<i class="fas fa-user"></i>';
        fotoFile.value = '';
        
        descriptoresCapturados = { frontal: null, izquierdo: null, derecho: null, arriba: null, abajo: null };
        checkFrontal.innerHTML = '';
        checkIzquierdo.innerHTML = '';
        checkDerecho.innerHTML = '';
        checkArriba.innerHTML = '';
        checkAbajo.innerHTML = '';
        setAnguloActivo('frontal');
        
        // Restaurar evento de guardar
        saveBtn.removeEventListener('click', updateCollaborator);
        saveBtn.addEventListener('click', saveCollaborator);
        saveBtn.innerHTML = '<i class="fas fa-save"></i> GUARDAR COLABORADOR (0/5 √°ngulos)';
        saveBtn.style.background = '#f39c12';
        
        cargarListaColaboradores();
        
      } catch (error) {
        hideLoading();
        showToast('Error al actualizar', 'error');
      }
    }

    // ============================================================
    // 11. ELIMINAR COLABORADOR
    // ============================================================
    window.eliminarColaborador = async function(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este colaborador de Ponche? Se eliminar√°n tambi√©n todos sus registros de asistencia.')) return;
      
      try {
        showLoading('Eliminando...');
        
        // Eliminar registros de asistencia
        const q = query(collection(db, 'facialAttendance'), where('collaboratorId', '==', id));
        const registros = await getDocs(q);
        
        const batch = [];
        registros.forEach(doc => {
          batch.push(deleteDoc(doc.ref));
        });
        
        await Promise.all(batch);
        
        // Eliminar colaborador
        await deleteDoc(doc(db, "Ponche", id));
        
        hideLoading();
        showToast('Colaborador eliminado de Ponche', 'success');
        
        cargarListaColaboradores();
        cargarHistorialGeneral();
        
      } catch (error) {
        hideLoading();
        showToast('Error al eliminar', 'error');
      }
    };

    // ============================================================
    // 12. CARGAR HISTORIAL GENERAL
    // ============================================================
    async function cargarHistorialGeneral() {
      try {
        // Total colaboradores
        const collSnap = await getDocs(collection(db, "Ponche"));
        totalColaboradoresHistorial.textContent = collSnap.size;
        
        // Registros de hoy
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        const q = query(
          collection(db, 'facialAttendance'),
          orderBy('timestamp', 'desc'),
          limit(200)
        );
        
        const snapshot = await getDocs(q);
        
        let registrosHoy = 0;
        let extrasHoy = 0;
        
        // Agrupar por colaborador y fecha
        const grupos = {};
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const fecha = formatearFecha(data.timestamp.toDate());
          const key = `${data.collaboratorId}_${fecha}`;
          
          if (!grupos[key]) {
            grupos[key] = {
              colaborador: data.collaboratorName || 'Colaborador',
              codigo: data.collaboratorCode || '',
              fecha: fecha,
              fechaObj: data.timestamp.toDate(),
              registros: [],
              horasDiarias: data.horasDiarias || 8
            };
          }
          
          grupos[key].registros.push({
            timestamp: data.timestamp,
            type: data.type,
            hora: formatearHora(data.timestamp.toDate())
          });
          
          // Contar registros de hoy
          const fechaReg = data.timestamp.toDate();
          if (fechaReg.toDateString() === hoy.toDateString()) {
            registrosHoy++;
          }
        });
        
        totalRegistrosHoy.textContent = registrosHoy;
        
        // Calcular horas y mostrar
        let html = '';
        let totalExtrasHoyCalc = 0;
        
        Object.values(grupos).forEach(grupo => {
          grupo.registros.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
          
          let segundosTrabajados = 0;
          for (let i = 0; i < grupo.registros.length; i += 2) {
            if (i + 1 < grupo.registros.length) {
              const entrada = grupo.registros[i].timestamp.toDate();
              const salida = grupo.registros[i + 1].timestamp.toDate();
              segundosTrabajados += (salida - entrada) / 1000;
            }
          }
          
          const horasTrabajadas = segundosTrabajados / 3600;
          const extras = Math.max(0, horasTrabajadas - grupo.horasDiarias);
          
          // Sumar extras de hoy
          if (grupo.fechaObj.toDateString() === hoy.toDateString()) {
            totalExtrasHoyCalc += extras;
          }
          
          let registrosHtml = '';
          grupo.registros.forEach((reg, index) => {
            const tipo = reg.type === 'entry' ? '‚úÖ Entrada' : 'üö™ Salida';
            registrosHtml += `<div>${tipo}: ${reg.hora}</div>`;
          });
          
          html += `
            <div class="table-row" style="grid-template-columns: 1.5fr 1fr 2fr 1fr 1fr;">
              <div><strong>${grupo.colaborador}</strong><br><small style="color: #16e086;">${grupo.codigo}</small></div>
              <div>${grupo.fecha}</div>
              <div style="font-size: 12px;">${registrosHtml}</div>
              <div>${horasTrabajadas.toFixed(2)} hrs</div>
              <div>${extras > 0 ? `<span style="background: #f39c12; color: #0a1c1f; padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: bold;">+${extras.toFixed(2)}</span>` : '0'}</div>
            </div>
          `;
        });
        
        totalExtrasHoy.textContent = totalExtrasHoyCalc.toFixed(2);
        
        if (Object.keys(grupos).length === 0) {
          historialGeneralContainer.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 30px; grid-column: span 5;">No hay registros de asistencia</div>';
        } else {
          historialGeneralContainer.innerHTML = html;
        }
        
      } catch (error) {
        console.error('Error cargando historial:', error);
        historialGeneralContainer.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 30px; grid-column: span 5;">Error cargando historial</div>';
      }
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    window.addEventListener('load', async () => {
      await loadFaceApiModels();
      await startCamera();
      await cargarListaColaboradores();
      await cargarHistorialGeneral();
    });

    anguloFrontal.addEventListener('click', () => setAnguloActivo('frontal'));
    anguloIzquierdo.addEventListener('click', () => setAnguloActivo('izquierdo'));
    anguloDerecho.addEventListener('click', () => setAnguloActivo('derecho'));
    anguloArriba.addEventListener('click', () => setAnguloActivo('arriba'));
    anguloAbajo.addEventListener('click', () => setAnguloActivo('abajo'));

    captureBtn.addEventListener('click', captureCurrentAngle);
    saveBtn.addEventListener('click', saveCollaborator);
    refreshBtn.addEventListener('click', startCamera);

    closeModalBtn.addEventListener('click', () => {
      detalleModal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === detalleModal) {
        detalleModal.style.display = 'none';
      }
    });

    window.addEventListener('beforeunload', () => {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
    });
  </script>
</body>
</html>
