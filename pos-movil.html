<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Punto de Venta Móvil</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* Reset y estilos base */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2b3c, #2c3e50);
      color: #ffffff;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 15px;
      line-height: 1.4;
    }

    /* Animaciones globales */
    * {
      transition: all 0.3s ease;
    }

    /* Contenedor principal móvil */
    .mobile-container {
      width: 100%;
      max-width: 768px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #1a2b3c;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Header móvil */
    .mobile-header {
      background: linear-gradient(135deg, #16e086, #15a086);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-mobile {
      width: 40px;
      height: 40px;
      background: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #16e086;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .logo-mobile:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .system-name-mobile {
      font-size: 18px;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .header-icon {
      color: #ffffff;
      font-size: 1.3em;
      background: rgba(255,255,255,0.2);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      text-decoration: none;
    }

    .header-icon:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    .user-avatar-mobile {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ffffff;
      transition: transform 0.3s ease;
    }

    .user-avatar-mobile:hover {
      transform: scale(1.1);
    }

    /* Menu Hamburger para tablet/PC */
    .menu-hamburger {
      display: none;
      background: rgba(255,255,255,0.2);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      font-size: 1.2em;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .menu-hamburger:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }

    /* Modal de Información del Usuario */
    .user-info-modal {
      max-width: 500px;
      width: 90%;
    }

    .user-info-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .user-avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #16e086;
    }

    .user-info-details {
      flex: 1;
    }

    .user-info-name {
      font-size: 20px;
      font-weight: bold;
      color: #16e086;
      margin-bottom: 5px;
    }

    .user-info-role {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      background: rgba(22, 224, 134, 0.1);
      padding: 4px 10px;
      border-radius: 12px;
      display: inline-block;
    }

    .user-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .user-info-item {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 12px;
      transition: all 0.3s ease;
    }

    .user-info-item:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-2px);
    }

    .user-info-label {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 5px;
    }

    .user-info-value {
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
    }

    /* Sección de búsqueda */
    .search-section {
      padding: 15px;
      background: #233445;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      animation: fadeInUp 0.4s ease 0.1s both;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .search-container-mobile {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    .search-box {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 25px;
      padding: 12px 20px;
      color: #ffffff;
      font-size: 15px;
      outline: none;
      transition: all 0.3s ease;
    }

    .search-box:focus {
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 2px rgba(22, 224, 134, 0.3);
      transform: translateY(-1px);
    }

    .search-box::placeholder {
      color: rgba(255,255,255,0.6);
    }

    .scanner-btn-mobile {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
      border: none;
      border-radius: 25px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(22,224,134,0.3);
    }

    .scanner-btn-mobile:hover {
      transform: scale(1.05) rotate(5deg);
      box-shadow: 0 5px 12px rgba(22,224,134,0.4);
    }

    /* Vista principal de productos */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
      animation: fadeIn 0.6s ease 0.2s both;
    }

    .products-section {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #1a2b3c;
    }

    .products-section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #16e086;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideInLeft 0.4s ease;
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .view-toggle-mobile {
      display: flex;
      gap: 8px;
    }

    .view-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #16e086;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .view-btn:hover {
      transform: scale(1.1);
      background: rgba(22, 224, 134, 0.2);
    }

    .view-btn.active {
      background: #16e086;
      color: white;
      transform: scale(1.1);
      box-shadow: 0 3px 8px rgba(22,224,134,0.3);
    }

    /* Total en tiempo real en productos */
    .real-time-total-container {
      background: rgba(22, 224, 134, 0.1);
      border: 2px solid rgba(22, 224, 134, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 15px;
      display: none;
      animation: slideInDown 0.3s ease;
    }

    @keyframes slideInDown {
      from {
        transform: translateY(-10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .real-time-total-label {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      margin-bottom: 5px;
    }

    .real-time-total-amount {
      font-size: 20px;
      font-weight: bold;
      color: #16e086;
      text-align: center;
    }

    /* Lista de productos */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 10px;
      animation: fadeIn 0.5s ease;
    }

    .products-grid.list-view {
      display: flex !important;
      flex-direction: column !important;
      gap: 10px;
    }

    .products-grid.list-view .product-card {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      padding: 10px !important;
      text-align: left !important;
      height: auto !important;
    }

    .products-grid.list-view .product-image {
      width: 60px !important;
      height: 60px !important;
      margin-bottom: 0 !important;
      margin-right: 12px !important;
    }

    .products-grid.list-view .product-name {
      font-size: 14px !important;
      margin-bottom: 3px !important;
      text-align: left !important;
      flex: 1 !important;
    }

    .products-grid.list-view .product-price {
      font-size: 13px !important;
      margin-bottom: 2px !important;
      text-align: left !important;
    }

    .products-grid.list-view .product-ean-mobile {
      font-size: 10px !important;
      margin-top: 2px !important;
      text-align: left !important;
    }

    .products-grid.list-view .product-badge {
      position: relative !important;
      top: 0 !important;
      right: 0 !important;
      margin-top: 5px !important;
    }

    @media (min-width: 768px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }

    .product-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      height: 180px;
      overflow: hidden;
    }

    .product-card:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border-color: rgba(22, 224, 134, 0.3);
    }

    .product-image {
      width: 70px;
      height: 70px;
      object-fit: contain;
      margin-bottom: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      transition: transform 0.3s ease;
    }

    .product-card:hover .product-image {
      transform: scale(1.05);
    }

    .product-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      line-height: 1.2;
      color: #ffffff;
      height: 32px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .product-price {
      color: #16e086;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .product-ean-mobile {
      font-size: 10px;
      color: rgba(255,255,255,0.6);
      background: rgba(0,0,0,0.2);
      padding: 3px 8px;
      border-radius: 10px;
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product-badge {
      position: absolute;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 1;
    }

    .badge-expired {
      background: rgba(231, 76, 60, 0.9);
      color: white;
      top: 8px;
      right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .badge-warning {
      background: rgba(243, 156, 18, 0.9);
      color: white;
      top: 8px;
      right: 8px;
    }

    .badge-tax {
      background: rgba(22, 224, 134, 0.9);
      color: white;
      font-size: 9px;
      bottom: 8px;
      left: 8px;
      padding: 2px 6px;
    }

    /* Sección de factura */
    .invoice-section {
      width: 100%;
      background: #233445;
      border-left: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      height: 100%;
      animation: slideInRight 0.4s ease;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .invoice-header {
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .invoice-header h2 {
      color: #16e086;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .invoice-items {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .invoice-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid #16e086;
      animation: fadeInUp 0.3s ease;
    }

    .item-info {
      flex: 1;
    }

    .item-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 3px;
    }

    .item-details {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      display: flex;
      gap: 10px;
    }

    .item-price {
      font-weight: bold;
      color: #16e086;
      font-size: 15px;
    }

    .remove-btn-mobile {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .remove-btn-mobile:hover {
      background: rgba(231, 76, 60, 0.3);
      transform: scale(1.1) rotate(90deg);
    }

    /* Barra de totales móvil */
    .totals-bar-mobile {
      background: #233445;
      padding: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: sticky;
      bottom: 0;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.2);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .total-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(22, 224, 134, 0.1);
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid rgba(22, 224, 134, 0.3);
    }

    .total-label {
      font-size: 14px;
      color: rgba(255,255,255,0.9);
    }

    .total-amount {
      font-size: 22px;
      font-weight: bold;
      color: #16e086;
    }

    .currency-totals-mobile {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .currency-total {
      background: rgba(255,255,255,0.05);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: transform 0.2s ease;
    }

    .currency-total:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.08);
    }

    .currency-total i {
      color: #16e086;
    }

    /* Botones de acción móvil */
    .action-buttons-mobile {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .action-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 10px;
      padding: 12px 8px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      min-height: 70px;
      justify-content: center;
    }

    .action-btn i {
      font-size: 18px;
      margin-bottom: 3px;
      transition: transform 0.3s ease;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .action-btn:hover i {
      transform: scale(1.2);
    }

    .btn-discount {
      background: linear-gradient(135deg, #e67e22, #d35400);
    }

    .btn-cash {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .btn-card {
      background: linear-gradient(135deg, #2980b9, #3498db);
    }

    .btn-invoice {
      background: linear-gradient(135deg, #16e086, #15a086);
      font-weight: bold;
    }

    /* Menú de navegación móvil */
    .mobile-nav {
      display: none;
      background: #233445;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 10px;
      animation: slideUp 0.3s ease;
    }

    .nav-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      padding: 10px 5px;
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 11px;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255,255,255,0.1);
      color: #16e086;
      transform: translateY(-2px);
    }

    .nav-item i {
      font-size: 16px;
      transition: transform 0.3s ease;
    }

    .nav-item:hover i {
      transform: scale(1.2);
    }

    /* Modales móviles */
    .modal-mobile {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .modal-content-mobile {
      background: #233445;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      animation: modalSlideUp 0.3s ease;
    }

    @keyframes modalSlideUp {
      from {
        transform: translateY(50px) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: #16e086;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-modal {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .close-modal:hover {
      background: rgba(255,255,255,0.2);
      transform: rotate(90deg) scale(1.1);
    }

    .modal-body {
      padding: 20px;
    }

    /* Modal de pago en efectivo */
    .payment-input-group {
      margin-bottom: 20px;
    }

    .payment-label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255,255,255,0.9);
      font-weight: 500;
    }

    .payment-input {
      width: 100%;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 15px;
      font-size: 18px;
      color: white;
      text-align: center;
      font-weight: bold;
      outline: none;
      transition: all 0.3s ease;
    }

    .payment-input:focus {
      border-color: #16e086;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(22,224,134,0.2);
    }

    .payment-display {
      background: rgba(22, 224, 134, 0.1);
      border: 2px solid rgba(22, 224, 134, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease;
    }

    .payment-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .payment-row:last-child {
      margin-bottom: 0;
    }

    .payment-row.total {
      font-weight: bold;
      font-size: 18px;
      color: #16e086;
    }

    .numeric-keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .num-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 12px;
      padding: 20px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
      touch-action: manipulation;
    }

    .num-btn:hover, .num-btn:active {
      background: rgba(255,255,255,0.2);
      transform: scale(0.95);
    }

    .num-btn.clear {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .num-btn.enter {
      background: rgba(22, 224, 134, 0.2);
      color: #16e086;
      grid-column: span 2;
    }

    /* Modal de login */
    .login-container-mobile {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #1a2b3c, #2c3e50);
      padding: 20px;
      animation: fadeIn 0.5s ease;
    }

    .login-card {
      background: #233445;
      border-radius: 20px;
      padding: 30px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      text-align: center;
      animation: bounceIn 0.6s ease;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    .login-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #16e086, #15a086);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 36px;
      color: white;
      transition: transform 0.3s ease;
    }

    .login-logo:hover {
      transform: rotate(360deg) scale(1.1);
    }

    .login-title {
      font-size: 24px;
      color: #16e086;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .login-input {
      width: 100%;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 15px;
      color: white;
      font-size: 16px;
      margin-bottom: 15px;
      outline: none;
      transition: all 0.3s ease;
    }

    .login-input:focus {
      border-color: #16e086;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(22,224,134,0.2);
    }

    .login-btn {
      width: 100%;
      background: linear-gradient(135deg, #16e086, #15a086);
      border: none;
      border-radius: 12px;
      padding: 15px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(22,224,134,0.4);
    }

    /* Scanner modal */
    .scanner-modal-mobile {
      background: #000;
    }

    .scanner-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .scanner-viewport {
      flex: 1;
      position: relative;
      background: #000;
    }

    .scanner-controls {
      padding: 20px;
      background: #233445;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .scanner-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scanner-btn.primary {
      background: linear-gradient(135deg, #16e086, #15a086);
    }

    .scanner-btn:hover {
      transform: scale(1.1) rotate(10deg);
    }

    /* Menú Modal */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .menu-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s;
      color: white;
      text-decoration: none;
    }

    .menu-item:hover {
      background: rgba(22, 224, 134, 0.1);
      transform: translateY(-3px) scale(1.05);
      border-color: #16e086;
    }

    .menu-item i {
      font-size: 28px;
      color: #16e086;
      transition: transform 0.3s ease;
    }

    .menu-item:hover i {
      transform: scale(1.2) rotate(5deg);
    }

    .menu-item span {
      font-size: 12px;
      text-align: center;
      line-height: 1.3;
    }

    /* Configuración Modal */
    .config-section {
      margin-bottom: 25px;
    }

    .config-section h3 {
      color: #16e086;
      font-size: 16px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .config-item:hover {
      background: rgba(255,255,255,0.08);
      transform: translateX(5px);
    }

    .config-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .config-label i {
      color: #16e086;
      width: 20px;
      text-align: center;
    }

    /* Switch/Toggle */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.2);
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: #16e086;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .slider.round {
      border-radius: 24px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    /* Historial Modal */
    .history-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .history-item {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #16e086;
      cursor: pointer;
      transition: all 0.3s;
    }

    .history-item:hover {
      background: rgba(255,255,255,0.08);
      transform: translateX(5px) scale(1.02);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-id {
      font-weight: bold;
      color: #16e086;
      font-size: 14px;
    }

    .history-date {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
    }

    .history-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      font-size: 12px;
    }

    .history-detail {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-label {
      color: rgba(255,255,255,0.6);
      font-size: 10px;
    }

    .history-value {
      color: #ffffff;
      font-weight: 500;
    }

    .history-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .history-action-btn {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: none;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.3s;
    }

    .history-action-view {
      background: rgba(22, 224, 134, 0.1);
      color: #16e086;
    }

    .history-action-view:hover {
      background: rgba(22, 224, 134, 0.2);
      transform: translateY(-2px);
    }

    .history-action-whatsapp {
      background: rgba(37, 211, 102, 0.1);
      color: #25D366;
    }

    .history-action-whatsapp:hover {
      background: rgba(37, 211, 102, 0.2);
      transform: translateY(-2px);
    }

    /* Reportes Modal */
    .reports-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .report-section {
      margin-bottom: 20px;
    }

    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .chart-title {
      color: #16e086;
      font-size: 14px;
      margin-bottom: 10px;
      text-align: center;
    }

    .chart-canvas {
      width: 100% !important;
      height: 150px !important;
    }

    .report-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      background: rgba(255,255,255,0.08);
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #16e086;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 11px;
      color: rgba(255,255,255,0.7);
    }

    /* Tax Modal */
    .tax-modal {
      max-width: 500px;
    }

    .tax-config-section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .tax-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .tax-active {
      background: rgba(22, 224, 134, 0.2);
      color: #16e086;
    }

    .tax-inactive {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .tax-input-group {
      margin-bottom: 15px;
    }

    .tax-input-label {
      display: block;
      margin-bottom: 5px;
      color: rgba(255,255,255,0.9);
      font-size: 14px;
    }

    .tax-input {
      width: 100%;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
    }

    .tax-input:focus {
      border-color: #16e086;
      transform: translateY(-1px);
    }

    .tax-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .tax-btn {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tax-btn-save {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
    }

    .tax-btn-cancel {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .tax-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    /* Estilos para tablet y pantallas grandes */
    @media (min-width: 768px) {
      .mobile-container {
        max-width: 100%;
        height: 100vh;
        border-radius: 20px;
        margin: 20px auto;
        overflow: hidden;
      }

      .main-content {
        flex-direction: row;
      }

      .products-section {
        flex: 2;
        max-height: calc(100vh - 140px);
      }

      .invoice-section {
        flex: 1;
        display: flex !important;
        max-height: calc(100vh - 140px);
      }

      .mobile-nav {
        display: none !important;
      }

      .menu-hamburger {
        display: flex !important;
      }

      .action-buttons-mobile {
        grid-template-columns: repeat(4, 1fr);
      }

      .header-actions {
        gap: 15px;
      }

      .search-section {
        padding: 20px;
      }

      .search-container-mobile {
        gap: 15px;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
      }

      .product-card {
        height: 200px;
        padding: 15px;
      }

      .product-image {
        width: 80px;
        height: 80px;
      }

      .product-name {
        font-size: 14px;
        height: 36px;
      }

      .product-price {
        font-size: 16px;
      }

      .totals-bar-mobile {
        padding: 20px;
      }

      .action-btn {
        padding: 15px 10px;
        min-height: 80px;
      }

      .action-btn i {
        font-size: 20px;
      }

      .action-btn span {
        font-size: 14px;
      }
    }

    /* Estilos para pantallas pequeñas */
    @media (max-width: 767px) {
      .mobile-container {
        height: 100vh;
      }

      .invoice-section {
        position: fixed;
        top: 0;
        right: -100%;
        width: 100%;
        height: 100vh;
        z-index: 200;
        transition: right 0.3s ease;
      }

      .invoice-section.active {
        right: 0;
      }

      .mobile-nav {
        display: block;
      }

      .menu-hamburger {
        display: none;
      }

      .action-buttons-mobile {
        grid-template-columns: repeat(2, 1fr);
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }

      .header-actions {
        gap: 10px;
      }
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: #16e086;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #15a086;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22, 224, 134, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      z-index: 1000;
      animation: slideInUp 0.3s ease;
      display: none;
      font-weight: 500;
    }

    @keyframes slideInUp {
      from {
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 20px;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: #16e086;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Turno terminado modal */
    .shift-end-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      padding: 20px;
    }

    .shift-end-content {
      background: linear-gradient(135deg, #2c3e50, #1a2b3c);
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .shift-end-icon {
      font-size: 60px;
      color: #e74c3c;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .shift-end-title {
      color: #e74c3c;
      font-size: 24px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .shift-end-message {
      color: rgba(255,255,255,0.8);
      margin-bottom: 25px;
      line-height: 1.5;
    }

    .shift-end-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .shift-end-btn {
      padding: 12px 25px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .shift-end-btn-change {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
    }

    .shift-end-btn-reload {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    /* Estilos para ventana de confirmación de producto próximo a vencer */
    .expiration-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .expiration-modal {
      background: linear-gradient(135deg, #f39c12, #d35400);
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      color: white;
      text-align: center;
      animation: modalSlideUp 0.4s ease;
    }

    .expiration-modal.expired {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .expiration-icon {
      font-size: 60px;
      margin-bottom: 20px;
      animation: bounce 1s ease infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .expiration-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .expiration-message {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 25px;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: left;
    }

    .expiration-warning {
      font-size: 14px;
      font-style: italic;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 20px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border-left: 4px solid #e74c3c;
    }

    .expiration-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .expiration-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
    }

    .expiration-btn-yes {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
    }

    .expiration-btn-yes:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }

    .expiration-btn-no {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .expiration-btn-no:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }

    /* ============================ */
    /* NUEVOS ESTILOS AGREGADOS */
    /* ============================ */

    /* Notas Internas */
    .notes-container {
      margin-top: 15px;
      padding: 10px;
      background: rgba(22, 224, 134, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(22, 224, 134, 0.1);
    }

    .note-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 3px solid #16e086;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-weight: bold;
      color: #16e086;
      width: 100%;
    }

    .note-content-container {
      flex: 1;
    }

    .note-content {
      color: rgba(255, 255, 255, 0.8);
    }

    .note-actions {
      display: flex;
      gap: 8px;
      margin-left: 10px;
    }

    .note-action-btn {
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
      padding: 4px;
    }

    .note-action-btn:hover {
      color: #16e086;
      transform: scale(1.1);
    }

    .add-note-btn {
      background: rgba(22, 224, 134, 0.1);
      border: 1px dashed rgba(22, 224, 134, 0.3);
      border-radius: 8px;
      padding: 8px;
      color: #16e086;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      margin-top: 10px;
    }

    .add-note-btn:hover {
      background: rgba(22, 224, 134, 0.2);
    }

    /* Cálculo de Unidades */
    .unit-calc-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 5px;
    }

    .unit-select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 4px 8px;
      color: white;
      font-size: 12px;
      min-width: 60px;
    }

    .unit-result {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(0, 0, 0, 0.2);
      padding: 3px 8px;
      border-radius: 10px;
    }

    /* Métodos de Pago Múltiples */
    .multiple-payments-container {
      margin-top: 15px;
    }

    .payment-method-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .payment-method-select {
      flex: 2;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px;
      color: white;
      font-size: 14px;
    }

    .payment-amount-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px;
      color: white;
      font-size: 14px;
      text-align: right;
    }

    .add-payment-method-btn {
      background: rgba(52, 152, 219, 0.1);
      border: 1px dashed rgba(52, 152, 219, 0.3);
      border-radius: 8px;
      padding: 8px;
      color: #3498db;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      margin-top: 5px;
    }

    .add-payment-method-btn:hover {
      background: rgba(52, 152, 219, 0.2);
    }

    /* Recordatorio de Devoluciones */
    .return-reminder {
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid rgba(231, 76, 60, 0.2);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      animation: fadeIn 0.5s ease;
    }

    .return-reminder-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .return-reminder-title {
      color: #e74c3c;
      font-weight: bold;
      font-size: 13px;
    }

    .return-reminder-date {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
    }

    .return-reminder-details {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }

    /* Búsqueda Avanzada */
    .advanced-search-modal {
      max-width: 500px;
    }

    .filter-section {
      margin-bottom: 20px;
    }

    .filter-section h3 {
      color: #16e086;
      font-size: 16px;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .filter-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .filter-option {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .filter-option:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #16e086;
    }

    .filter-option.active {
      background: rgba(22, 224, 134, 0.1);
      border-color: #16e086;
      color: #16e086;
    }

    /* Copiar Factura Anterior */
    .copy-invoice-btn {
      background: rgba(155, 89, 182, 0.1);
      border: 1px solid rgba(155, 89, 182, 0.3);
      border-radius: 8px;
      padding: 8px 15px;
      color: #9b59b6;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 10px;
    }

    .copy-invoice-btn:hover {
      background: rgba(155, 89, 182, 0.2);
    }

    /* Gestor de Clientes */
    .clients-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .client-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #3498db;
      cursor: pointer;
      transition: all 0.3s;
    }

    .client-card:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(5px);
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .client-name {
      font-weight: bold;
      color: #3498db;
      font-size: 14px;
    }

    .client-phone {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    .client-details {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }

    /* Calculadora Integrada */
    .calculator-modal {
      max-width: 400px;
    }

    .calculator-display {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 15px;
      font-size: 24px;
      text-align: right;
      color: white;
      font-weight: bold;
      margin-bottom: 15px;
      min-height: 60px;
      word-break: break-all;
    }

    .calculator-keypad {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .calc-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 8px;
      padding: 15px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
    }

    .calc-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .calc-btn.operator {
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
    }

    .calc-btn.equals {
      background: rgba(22, 224, 134, 0.2);
      color: #16e086;
    }

    .calc-btn.clear {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    /* Registro de Gastos */
    .expenses-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .expense-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #e74c3c;
    }

    .expense-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .expense-title {
      font-weight: bold;
      color: #e74c3c;
      font-size: 14px;
    }

    .expense-amount {
      font-weight: bold;
      color: #e74c3c;
      font-size: 16px;
    }

    .expense-details {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: space-between;
    }

    .add-expense-btn {
      background: rgba(231, 76, 60, 0.1);
      border: 1px dashed rgba(231, 76, 60, 0.3);
      border-radius: 8px;
      padding: 10px;
      color: #e74c3c;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      margin-top: 10px;
    }

    .add-expense-btn:hover {
      background: rgba(231, 76, 60, 0.2);
    }

    /* Compartir Lista de Productos */
    .share-products-container {
      padding: 15px;
    }

    .share-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .share-option {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .share-option:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .share-option i {
      font-size: 24px;
      margin-bottom: 10px;
      display: block;
    }

    .share-option.whatsapp {
      color: #25D366;
    }

    .share-option.email {
      color: #3498db;
    }

    .share-option.print {
      color: #7f8c8d;
    }

    .share-option.copy {
      color: #9b59b6;
    }

    /* Botón de Acceso Rápido a Nuevas Funciones */
    .quick-access-btn {
      position: fixed;
      right: 20px;
      bottom: 80px;
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      color: white;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quick-access-btn:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 6px 20px rgba(155, 89, 182, 0.6);
    }

    /* Quick Access Menu */
    .quick-access-menu {
      position: fixed;
      right: 30px;
      bottom: 150px;
      background: #233445;
      border-radius: 15px;
      padding: 15px;
      z-index: 101;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      display: none;
      animation: fadeIn 0.3s ease;
      min-width: 200px;
    }

    .quick-access-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .quick-access-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .quick-access-item i {
      width: 20px;
      text-align: center;
      color: #16e086;
    }

    /* ============================ */
    /* FIN NUEVOS ESTILOS AGREGADOS */
    /* ============================ */

    /* Estilos para perfil de usuario */
    .profile-avatar-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
    }

    .profile-avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #16e086;
      background: #233445;
    }

    .profile-avatar-placeholder {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(135deg, #e67e22, #d35400);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
      border: 3px solid #16e086;
    }

    .profile-avatar-edit {
      position: absolute;
      bottom: 0;
      right: 0;
      background: #16e086;
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .profile-avatar-edit:hover {
      transform: scale(1.1);
      background: #15a086;
    }

    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .profile-form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .profile-form-label {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
      font-weight: 500;
    }

    .profile-form-input {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .profile-form-input:focus {
      border-color: #16e086;
      background: rgba(255,255,255,0.15);
    }

    .profile-form-input:read-only {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.1);
      cursor: not-allowed;
    }

    .profile-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .profile-btn {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .profile-btn-save {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
    }

    .profile-btn-cancel {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .profile-btn:hover {
      transform: translateY(-2px);
    }

    /* Confirmación elegante para eliminar */
    .confirm-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .confirm-modal {
      background: linear-gradient(135deg, #233445, #1a2b3c);
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      text-align: center;
      animation: modalSlideUp 0.4s ease;
    }

    .confirm-icon {
      font-size: 60px;
      color: #e74c3c;
      margin-bottom: 20px;
      animation: pulse 1s ease infinite;
    }

    .confirm-title {
      color: #e74c3c;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .confirm-message {
      color: rgba(255,255,255,0.8);
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 25px;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .confirm-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .confirm-btn-yes {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .confirm-btn-yes:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
      transform: translateY(-2px);
    }

    .confirm-btn-no {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .confirm-btn-no:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container-mobile">
    <div class="login-card">
      <div class="login-logo">
        <i class="fas fa-shopping-cart"></i>
      </div>
      <h1 class="login-title">ZANARA POS</h1>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">Inicia sesión para comenzar</p>
      
      <input type="text" id="mobileUsername" class="login-input" placeholder="Usuario" autocomplete="off">
      <input type="password" id="mobilePin" class="login-input" placeholder="PIN" autocomplete="off">
      <button id="mobileLoginBtn" class="login-btn">Iniciar Sesión</button>
      
      <p id="loginError" style="color: #e74c3c; margin-top: 15px; display: none;">
        <i class="fas fa-exclamation-circle"></i> Credenciales incorrectas
      </p>
    </div>
  </div>

  <!-- POS Mobile Interface -->
  <div id="posScreen" class="mobile-container" style="display: none;">
    <!-- Header -->
    <header class="mobile-header">
      <div class="header-left">
        <a href="logo.png" class="logo-mobile" id="headerLogoMobile">
          <i class="fas fa-shopping-cart"></i>
        </a>
        <div class="system-name-mobile">ZANARA POS</div>
      </div>
      
      <div class="header-actions">
        <!-- Botón de hamburguesa para tablet/PC -->
        <button class="menu-hamburger" id="menuHamburgerBtn">
          <i class="fas fa-bars"></i>
        </button>
        
        <a href="usuario.html" class="header-icon" id="userBtnMobile" title="Usuario">
          <i class="fas fa-user"></i>
        </a>
        <button class="header-icon" id="shiftBtnMobile" title="Turno">
          <i class="fas fa-clock"></i>
        </button>
        
        <!-- NOTA: Se quitaron los iconos de "Configuración" y "Taza" del header -->
        <!-- Estos iconos permanecen en el menú inferior y en el modal de menú -->
        
        <img id="userAvatarMobile" class="user-avatar-mobile" src="" alt="" style="display: none;">
      </div>
    </header>

    <!-- Search Section -->
    <section class="search-section">
      <div class="search-container-mobile">
        <input type="text" id="mobileSearch" class="search-box" placeholder="Buscar producto..." autocomplete="off">
        <button class="scanner-btn-mobile" id="scannerBtnMobile">
          <i class="fas fa-barcode"></i>
        </button>
        <button class="header-icon" id="advancedSearchBtn" title="Búsqueda avanzada">
          <i class="fas fa-sliders-h"></i>
        </button>
      </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Products Section -->
      <section class="products-section" id="productsSection">
        <h2>
          Productos
          <div class="view-toggle-mobile">
            <button class="view-btn active" id="viewGridMobile" title="Vista cuadrícula">
              <i class="fas fa-th"></i>
            </button>
            <button class="view-btn" id="viewListMobile" title="Vista lista">
              <i class="fas fa-list"></i>
            </button>
            <button class="copy-invoice-btn" id="copyLastInvoiceBtn" title="Copiar última factura">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
        </h2>
        
        <!-- Total en tiempo real -->
        <div class="real-time-total-container" id="realTimeTotalContainer">
          <div class="real-time-total-label">Total Factura Actual:</div>
          <div class="real-time-total-amount" id="realTimeTotalAmount">$0.00</div>
        </div>
        
        <div class="products-grid" id="productsGrid">
          <!-- Products will be loaded here -->
        </div>

        <!-- Notas Internas -->
        <div class="notes-container" id="notesContainer" style="display: none;">
          <h3 style="color: #16e086; font-size: 14px; margin-bottom: 10px;">
            <i class="fas fa-sticky-note"></i> Notas Internas
          </h3>
          <div id="notesList">
            <!-- Las notas se cargarán aquí -->
          </div>
          <button class="add-note-btn" id="addNoteBtn">
            <i class="fas fa-plus"></i> Agregar Nota
          </button>
        </div>
      </section>

      <!-- Invoice Section -->
      <section class="invoice-section" id="invoiceSection">
        <div class="invoice-header">
          <h2><i class="fas fa-receipt"></i> Factura Actual</h2>
          <button class="close-modal" id="closeInvoiceBtn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="invoice-items" id="invoiceItemsMobile">
          <!-- Invoice items will be loaded here -->
        </div>
        
        <!-- Métodos de Pago Múltiples -->
        <div class="multiple-payments-container" id="multiplePaymentsContainer" style="display: none;">
          <h3 style="color: #16e086; font-size: 14px; margin: 15px 15px 10px 15px;">
            <i class="fas fa-credit-card"></i> Métodos de Pago
          </h3>
          <div id="paymentMethodsList" style="padding: 0 15px;">
            <!-- Métodos de pago se agregarán aquí -->
          </div>
          <button class="add-payment-method-btn" id="addPaymentMethodBtn">
            <i class="fas fa-plus"></i> Agregar Método de Pago
          </button>
        </div>
        
        <div class="totals-bar-mobile">
          <div class="total-display">
            <span class="total-label">Total a Pagar:</span>
            <span class="total-amount" id="totalAmountMobile">$0.00</span>
          </div>
          
          <div class="currency-totals-mobile">
            <div class="currency-total" id="usdTotalMobile">
              <i class="fas fa-dollar-sign"></i> $0.00
            </div>
            <div class="currency-total" id="eurTotalMobile">
              <i class="fas fa-euro-sign"></i> €0.00
            </div>
          </div>
          
          <div class="action-buttons-mobile">
            <button class="action-btn btn-discount" id="discountBtnMobile">
              <i class="fas fa-percent"></i>
              <span>Descuento</span>
            </button>
            <button class="action-btn btn-cash" id="cashBtnMobile">
              <i class="fas fa-money-bill"></i>
              <span>Efectivo</span>
            </button>
            <button class="action-btn btn-card" id="cardBtnMobile">
              <i class="fas fa-credit-card"></i>
              <span>Tarjeta</span>
            </button>
            <button class="action-btn btn-invoice" id="invoiceBtnMobile">
              <i class="fas fa-file-invoice"></i>
              <span>Facturar</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
      <div class="nav-grid">
        <a href="#" class="nav-item active" id="navProducts">
          <i class="fas fa-boxes"></i>
          <span>Productos</span>
        </a>
        <a href="#" class="nav-item" id="navInvoice">
          <i class="fas fa-receipt"></i>
          <span>Factura</span>
          <span class="badge" id="invoiceBadge">0</span>
        </a>
        <a href="#" class="nav-item" id="navHistory">
          <i class="fas fa-history"></i>
          <span>Historial</span>
        </a>
        <a href="#" class="nav-item" id="navReports">
          <i class="fas fa-chart-bar"></i>
          <span>Reportes</span>
        </a>
        <a href="#" class="nav-item" id="navMenu">
          <i class="fas fa-bars"></i>
          <span>Menú</span>
        </a>
      </div>
    </nav>

    <!-- Botón de acceso rápido a nuevas funciones -->
    <button class="quick-access-btn" id="quickAccessBtn">
      <i class="fas fa-bolt"></i>
    </button>

    <!-- Menú de acceso rápido -->
    <div class="quick-access-menu" id="quickAccessMenu">
      <div class="quick-access-item" id="quickCalculatorBtn">
        <i class="fas fa-calculator"></i>
        <span>Calculadora</span>
      </div>
      <div class="quick-access-item" id="quickClientsBtn">
        <i class="fas fa-users"></i>
        <span>Clientes</span>
      </div>
      <div class="quick-access-item" id="quickExpensesBtn">
        <i class="fas fa-receipt"></i>
        <span>Gastos</span>
      </div>
      <div class="quick-access-item" id="quickShareProductsBtn">
        <i class="fas fa-share-alt"></i>
        <span>Compartir</span>
      </div>
      <div class="quick-access-item" id="quickNotesBtn">
        <i class="fas fa-sticky-note"></i>
        <span>Notas</span>
      </div>
    </div>
  </div>

  <!-- ============================ -->
  <!-- NUEVOS MODALES AGREGADOS -->
  <!-- ============================ -->

  <!-- Modal de Notas Internas -->
  <div id="notesModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-sticky-note"></i> Notas Internas</h2>
        <button class="close-modal" id="closeNotesModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="payment-input-group">
          <label class="payment-label">Título de la Nota:</label>
          <input type="text" id="noteTitle" class="payment-input" placeholder="Ej: Producto a reabastecer" autocomplete="off">
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Contenido:</label>
          <textarea id="noteContent" class="payment-input" placeholder="Escribe tu nota aquí..." rows="4" style="text-align: left; resize: vertical;"></textarea>
        </div>
        <button class="login-btn" id="saveNoteBtn">
          <i class="fas fa-save"></i> Guardar Nota
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para editar nota -->
  <div id="editNoteModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> Editar Nota</h2>
        <button class="close-modal" id="closeEditNoteModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="payment-input-group">
          <label class="payment-label">Título de la Nota:</label>
          <input type="text" id="editNoteTitle" class="payment-input" placeholder="Ej: Producto a reabastecer" autocomplete="off">
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Contenido:</label>
          <textarea id="editNoteContent" class="payment-input" placeholder="Escribe tu nota aquí..." rows="4" style="text-align: left; resize: vertical;"></textarea>
        </div>
        <button class="login-btn" id="updateNoteBtn">
          <i class="fas fa-save"></i> Actualizar Nota
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Búsqueda Avanzada -->
  <div id="advancedSearchModal" class="modal-mobile advanced-search-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-sliders-h"></i> Búsqueda Avanzada</h2>
        <button class="close-modal" id="closeAdvancedSearchModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="filter-section">
          <h3>Filtrar por Categoría</h3>
          <div class="filter-options" id="categoryFilters">
            <div class="filter-option active" data-category="all">Todos</div>
            <div class="filter-option" data-category="low-stock">Stock Bajo</div>
            <div class="filter-option" data-category="expiring">Por Vencer</div>
            <div class="filter-option" data-category="expired">Vencidos</div>
          </div>
        </div>
        <div class="filter-section">
          <h3>Ordenar por</h3>
          <div class="filter-options" id="sortOptions">
            <div class="filter-option active" data-sort="name">Nombre</div>
            <div class="filter-option" data-sort="price">Precio</div>
            <div class="filter-option" data-sort="stock">Stock</div>
            <div class="filter-option" data-sort="date">Fecha</div>
          </div>
        </div>
        <div class="filter-section">
          <h3>Rango de Precio</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="number" id="minPrice" class="payment-input" placeholder="Mín" style="flex: 1; text-align: center;">
            <span>a</span>
            <input type="number" id="maxPrice" class="payment-input" placeholder="Máx" style="flex: 1; text-align: center;">
          </div>
        </div>
        <button class="login-btn" id="applyFiltersBtn">
          <i class="fas fa-filter"></i> Aplicar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Gestor de Clientes -->
  <div id="clientsModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-users"></i> Gestor de Clientes</h2>
        <button class="close-modal" id="closeClientsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="clients-container" id="clientsList">
          <!-- Los clientes se cargarán aquí -->
          <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No hay clientes registrados</p>
            <p style="font-size: 12px;">Agrega clientes para llevar un registro</p>
          </div>
        </div>
        <button class="add-expense-btn" id="addClientBtn" style="background: rgba(52, 152, 219, 0.1); border-color: rgba(52, 152, 219, 0.3); color: #3498db;">
          <i class="fas fa-user-plus"></i> Agregar Cliente
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para Agregar/Editar Cliente -->
  <div id="clientFormModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-user-edit"></i> <span id="clientFormTitle">Nuevo Cliente</span></h2>
        <button class="close-modal" id="closeClientFormModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="payment-input-group">
          <label class="payment-label">Nombre del Cliente:</label>
          <input type="text" id="clientName" class="payment-input" placeholder="Nombre completo" autocomplete="off">
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Teléfono:</label>
          <input type="text" id="clientPhone" class="payment-input" placeholder="809-123-4567" autocomplete="off">
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Email:</label>
          <input type="email" id="clientEmail" class="payment-input" placeholder="cliente@ejemplo.com" autocomplete="off">
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Dirección:</label>
          <textarea id="clientAddress" class="payment-input" placeholder="Dirección completa" rows="3" style="text-align: left; resize: vertical;"></textarea>
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Notas:</label>
          <textarea id="clientNotes" class="payment-input" placeholder="Notas adicionales sobre el cliente..." rows="2" style="text-align: left; resize: vertical;"></textarea>
        </div>
        <button class="login-btn" id="saveClientBtn">
          <i class="fas fa-save"></i> <span id="clientSaveButtonText">Guardar Cliente</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Calculadora -->
  <div id="calculatorModal" class="modal-mobile calculator-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-calculator"></i> Calculadora</h2>
        <button class="close-modal" id="closeCalculatorModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="calculator-display" id="calculatorDisplay">
          <span id="calcCurrentValue">0</span>
          <span id="calcOperatorDisplay" style="color: #f39c12; margin: 0 5px;"></span>
          <span id="calcPreviousValue" style="color: rgba(255,255,255,0.6);"></span>
        </div>
        <div class="calculator-keypad">
          <button class="calc-btn clear" id="calcClear">C</button>
          <button class="calc-btn clear" id="calcClearEntry">CE</button>
          <button class="calc-btn operator" data-value="%">%</button>
          <button class="calc-btn operator" data-value="/">/</button>
          
          <button class="calc-btn" data-value="7">7</button>
          <button class="calc-btn" data-value="8">8</button>
          <button class="calc-btn" data-value="9">9</button>
          <button class="calc-btn operator" data-value="*">×</button>
          
          <button class="calc-btn" data-value="4">4</button>
          <button class="calc-btn" data-value="5">5</button>
          <button class="calc-btn" data-value="6">6</button>
          <button class="calc-btn operator" data-value="-">-</button>
          
          <button class="calc-btn" data-value="1">1</button>
          <button class="calc-btn" data-value="2">2</button>
          <button class="calc-btn" data-value="3">3</button>
          <button class="calc-btn operator" data-value="+">+</button>
          
          <button class="calc-btn" data-value="0">0</button>
          <button class="calc-btn" data-value=".">.</button>
          <button class="calc-btn equals" id="calcEquals">=</button>
          <button class="calc-btn" id="calcUseResult">Usar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Registro de Gastos -->
  <div id="expensesModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-receipt"></i> Registro de Gastos</h2>
        <button class="close-modal" id="closeExpensesModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="expenses-container" id="expensesList">
          <!-- Los gastos se cargarán aquí -->
          <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No hay gastos registrados hoy</p>
            <p style="font-size: 12px;">Registra tus gastos diarios aquí</p>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="login-btn" style="flex: 1; background: linear-gradient(135deg, #e74c3c, #c0392b);" id="addExpenseBtn">
            <i class="fas fa-plus"></i> Agregar Gasto
          </button>
          <button class="login-btn" style="flex: 1;" id="exportExpensesBtn">
            <i class="fas fa-download"></i> Exportar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Agregar Gasto -->
  <div id="expenseFormModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-plus-circle"></i> Nuevo Gasto</h2>
        <button class="close-modal" id="closeExpenseFormModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="payment-input-group">
          <label class="payment-label">Descripción:</label>
          <input type="text" id="expenseDescription" class="payment-input" placeholder="Ej: Transporte, Materiales, etc." autocomplete="off">
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Monto:</label>
          <input type="text" id="expenseAmount" class="payment-input" placeholder="0.00" autocomplete="off">
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Categoría:</label>
          <select id="expenseCategory" class="payment-input" style="text-align-last: center;">
            <option value="operativos">Operativos</option>
            <option value="logistica">Logística</option>
            <option value="materiales">Materiales</option>
            <option value="servicios">Servicios</option>
            <option value="otros">Otros</option>
          </select>
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Notas:</label>
          <textarea id="expenseNotes" class="payment-input" placeholder="Detalles adicionales..." rows="2" style="text-align: left; resize: vertical;"></textarea>
        </div>
        <div class="numeric-keypad" style="margin-top: 20px;">
          <button class="num-btn" data-value="1">1</button>
          <button class="num-btn" data-value="2">2</button>
          <button class="num-btn" data-value="3">3</button>
          <button class="num-btn" data-value="4">4</button>
          <button class="num-btn" data-value="5">5</button>
          <button class="num-btn" data-value="6">6</button>
          <button class="num-btn" data-value="7">7</button>
          <button class="num-btn" data-value="8">8</button>
          <button class="num-btn" data-value="9">9</button>
          <button class="num-btn clear" id="expenseClearBtn">C</button>
          <button class="num-btn" data-value="0">0</button>
          <button class="num-btn enter" id="expenseSaveBtn">✓</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Compartir Productos -->
  <div id="shareProductsModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-share-alt"></i> Compartir Productos</h2>
        <button class="close-modal" id="closeShareProductsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body share-products-container">
        <div class="share-options">
          <div class="share-option whatsapp" id="shareWhatsAppBtn">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </div>
          <div class="share-option email" id="shareEmailBtn">
            <i class="fas fa-envelope"></i>
            <span>Email</span>
          </div>
          <div class="share-option print" id="sharePrintBtn">
            <i class="fas fa-print"></i>
            <span>Imprimir</span>
          </div>
          <div class="share-option copy" id="shareCopyBtn">
            <i class="fas fa-copy"></i>
            <span>Copiar</span>
          </div>
        </div>
        <div class="payment-input-group">
          <label class="payment-label">Filtrar productos a compartir:</label>
          <select id="shareFilter" class="payment-input" style="text-align-last: center;">
            <option value="all">Todos los productos</option>
            <option value="low-stock">Stock bajo</option>
            <option value="expiring">Por vencer</option>
            <option value="selected">Seleccionados manualmente</option>
          </select>
        </div>
        <div id="selectedProductsList" style="max-height: 200px; overflow-y: auto; margin-top: 15px; display: none;">
          <!-- Lista de productos seleccionados -->
        </div>
        <button class="login-btn" id="generateShareListBtn" style="margin-top: 20px;">
          <i class="fas fa-list"></i> Generar Lista
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para seleccionar productos a compartir -->
  <div id="selectProductsModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-check-square"></i> Seleccionar Productos</h2>
        <button class="close-modal" id="closeSelectProductsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div style="max-height: 400px; overflow-y: auto;" id="selectProductsList">
          <!-- Los productos se cargarán aquí -->
        </div>
        <button class="login-btn" id="confirmSelectedProductsBtn" style="margin-top: 20px;">
          <i class="fas fa-check"></i> Confirmar Selección
        </button>
      </div>
    </div>
  </div>

  <!-- ============================ -->
  <!-- FIN NUEVOS MODALES AGREGADOS -->
  <!-- ============================ -->

  <!-- Modal de Perfil del Usuario Mejorado -->
  <div id="userProfileModal" class="modal-mobile user-profile-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-user-circle"></i> Perfil del Usuario</h2>
        <button class="close-modal" id="closeUserProfileModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="profile-avatar-container">
          <div id="profileAvatarContainer">
            <!-- El avatar se cargará aquí dinámicamente -->
          </div>
          <button class="change-avatar-btn" id="changeAvatarBtn">
            <i class="fas fa-camera"></i> Cambiar Foto
          </button>
        </div>
        
        <form class="profile-form" id="profileForm">
          <div class="profile-input-group">
            <label class="profile-label">
              <i class="fas fa-user"></i>
              Nombre de Usuario
            </label>
            <input type="text" id="profileUsername" class="profile-input" readonly>
          </div>
          
          <div class="profile-input-group">
            <label class="profile-label">
              <i class="fas fa-envelope"></i>
              Correo Electrónico
            </label>
            <input type="email" id="profileEmail" class="profile-input">
          </div>
          
          <div class="profile-input-group">
            <label class="profile-label">
              <i class="fas fa-phone"></i>
              Teléfono
            </label>
            <input type="text" id="profilePhone" class="profile-input">
          </div>
          
          <div class="profile-input-group">
            <label class="profile-label">
              <i class="fas fa-key"></i>
              Cambiar Contraseña
            </label>
            <input type="password" id="profilePassword" class="profile-input" placeholder="Nueva contraseña (dejar en blanco para no cambiar)">
          </div>
          
          <div class="profile-input-group">
            <label class="profile-label">
              <i class="fas fa-key"></i>
              Confirmar Contraseña
            </label>
            <input type="password" id="profileConfirmPassword" class="profile-input" placeholder="Confirmar nueva contraseña">
          </div>
          
          <div class="profile-actions">
            <button type="button" class="profile-btn profile-btn-cancel" id="cancelProfileChangesBtn">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" class="profile-btn profile-btn-save" id="saveProfileBtn">
              <i class="fas fa-save"></i> Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación para eliminar notas -->
  <div id="confirmDeleteNoteModal" class="modal-mobile confirmation-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h2>
        <button class="close-modal" id="closeConfirmDeleteNoteModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="confirmation-icon">
            <i class="fas fa-trash-alt"></i>
          </div>
          <p class="confirmation-message" id="confirmDeleteNoteMessage">
            ¿Está seguro de que desea eliminar esta nota? Esta acción no se puede deshacer.
          </p>
          <div class="confirmation-buttons">
            <button class="confirmation-btn confirmation-btn-cancel" id="cancelDeleteNoteBtn">
              Cancelar
            </button>
            <button class="confirmation-btn confirmation-btn-confirm" id="confirmDeleteNoteBtn">
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación para eliminar clientes -->
  <div id="confirmDeleteClientModal" class="modal-mobile confirmation-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h2>
        <button class="close-modal" id="closeConfirmDeleteClientModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="confirmation-icon">
            <i class="fas fa-trash-alt"></i>
          </div>
          <p class="confirmation-message" id="confirmDeleteClientMessage">
            ¿Está seguro de que desea eliminar este cliente? Esta acción no se puede deshacer.
          </p>
          <div class="confirmation-buttons">
            <button class="confirmation-btn confirmation-btn-cancel" id="cancelDeleteClientBtn">
              Cancelar
            </button>
            <button class="confirmation-btn confirmation-btn-confirm" id="confirmDeleteClientBtn">
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Información del Usuario -->
  <div id="userInfoModal" class="modal-mobile user-info-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-user-circle"></i> Información del Usuario</h2>
        <button class="close-modal" id="closeUserInfoModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div id="userInfoContent">
          <!-- La información del usuario se cargará aquí desde Firebase -->
          <div style="text-align: center; padding: 40px;">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Cargando información del usuario...</p>
          </div>
        </div>
        
        <button class="login-btn" style="margin-top: 20px;" id="closeUserInfoBtn">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Modal (Cash) -->
  <div id="cashModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-money-bill"></i> Pago en Efectivo</h2>
        <button class="close-modal" id="closeCashModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display">
          <div class="payment-row">
            <span>Total a Pagar:</span>
            <span id="cashTotalAmount">$0.00</span>
          </div>
          <div class="payment-row">
            <span>Monto Recibido:</span>
            <span id="cashReceivedDisplay">$0.00</span>
          </div>
          <div class="payment-row total">
            <span>Cambio:</span>
            <span id="cashChangeAmount">$0.00</span>
          </div>
        </div>
        
        <div class="payment-input-group">
          <label class="payment-label">Monto Recibido:</label>
          <input type="text" id="cashReceivedInput" class="payment-input" placeholder="0.00" autocomplete="off">
        </div>
        
        <div class="numeric-keypad">
          <button class="num-btn" data-value="1">1</button>
          <button class="num-btn" data-value="2">2</button>
          <button class="num-btn" data-value="3">3</button>
          <button class="num-btn" data-value="4">4</button>
          <button class="num-btn" data-value="5">5</button>
          <button class="num-btn" data-value="6">6</button>
          <button class="num-btn" data-value="7">7</button>
          <button class="num-btn" data-value="8">8</button>
          <button class="num-btn" data-value="9">9</button>
          <button class="num-btn clear" id="cashClearBtn">C</button>
          <button class="num-btn" data-value="0">0</button>
          <button class="num-btn enter" id="cashConfirmBtn">✓</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal (Card) -->
  <div id="cardModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-credit-card"></i> Pago con Tarjeta</h2>
        <button class="close-modal" id="closeCardModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display" style="text-align: center; padding: 30px;">
          <h3 style="margin-bottom: 15px;">Total a Pagar:</h3>
          <div style="font-size: 32px; color: #16e086; font-weight: bold; margin-bottom: 30px;" id="cardTotalAmount">$0.00</div>
          <button class="login-btn" id="confirmCardBtn">
            <i class="fas fa-check"></i> Confirmar Pago
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Discount Modal -->
  <div id="discountModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-percent"></i> Aplicar Descuento</h2>
        <button class="close-modal" id="closeDiscountModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display" style="margin-bottom: 20px;">
          <div class="payment-row">
            <span>Descuento Requiere Contraseña</span>
            <span style="color: #e67e22;">✓</span>
          </div>
        </div>
        
        <div class="payment-input-group">
          <label class="payment-label">Contraseña:</label>
          <input type="password" id="discountPasswordInput" class="payment-input" placeholder="Ingrese contraseña" autocomplete="off">
        </div>
        
        <button class="login-btn" style="margin-top: 20px;" id="verifyDiscountBtn">
          <i class="fas fa-check"></i> Verificar Contraseña
        </button>
      </div>
    </div>
  </div>

  <!-- Discount Percentage Modal -->
  <div id="discountPercentageModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-percent"></i> Aplicar Descuento</h2>
        <button class="close-modal" id="closeDiscountPercentageModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-input-group">
          <label class="payment-label">Porcentaje de Descuento:</label>
          <input type="text" id="discountInput" class="payment-input" placeholder="0%" autocomplete="off">
        </div>
        
        <div class="numeric-keypad">
          <button class="num-btn" data-value="5">5%</button>
          <button class="num-btn" data-value="10">10%</button>
          <button class="num-btn" data-value="15">15%</button>
          <button class="num-btn" data-value="20">20%</button>
          <button class="num-btn" data-value="25">25%</button>
          <button class="num-btn" data-value="30">30%</button>
          <button class="num-btn clear" id="discountClearBtn">C</button>
        </div>
        
        <button class="login-btn" style="margin-top: 20px;" id="applyDiscountBtn">
          <i class="fas fa-check"></i> Aplicar Descuento
        </button>
      </div>
    </div>
  </div>

  <!-- Scanner Modal Optimizado -->
  <div id="scannerModal" class="modal-mobile scanner-modal-mobile">
    <div class="scanner-content">
      <div class="modal-header">
        <h2><i class="fas fa-barcode"></i> Escanear Código</h2>
        <button class="close-modal" id="closeScannerModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="scanner-viewport-optimized" id="scannerViewport">
        <!-- Scanner optimizado será inicializado aquí -->
        <div id="reader" style="width: 100%; height: 100%;"></div>
      </div>
      
      <div class="scanner-controls">
        <button class="scanner-btn" id="switchCameraBtn">
          <i class="fas fa-camera-rotate"></i>
        </button>
        <button class="scanner-btn primary" id="toggleScannerBtn">
          <i class="fas fa-play"></i>
        </button>
        <button class="scanner-btn" id="uploadImageBtn">
          <i class="fas fa-image"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Shift Info Modal -->
  <div id="shiftModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-clock"></i> Información del Turno</h2>
        <button class="close-modal" id="closeShiftModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display">
          <div class="payment-row">
            <span>Colaborador:</span>
            <span id="shiftUserName">-</span>
          </div>
          <div class="payment-row">
            <span>Turno:</span>
            <span id="shiftName">-</span>
          </div>
          <div class="payment-row">
            <span>Inicio:</span>
            <span id="shiftStartTime">-</span>
          </div>
          <div class="payment-row">
            <span>Fin:</span>
            <span id="shiftEndTime">-</span>
          </div>
          <div class="payment-row total">
            <span>Tiempo Restante:</span>
            <span id="shiftTimeRemaining">-</span>
          </div>
        </div>
        
        <button class="login-btn" style="margin-top: 20px; background: linear-gradient(135deg, #e74c3c, #c0392b);" id="endShiftBtn">
          <i class="fas fa-sign-out-alt"></i> Finalizar Turno
        </button>
      </div>
    </div>
  </div>

  <!-- Tax Modal (Solo visualización - sin editar) -->
  <div id="taxModal" class="modal-mobile tax-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-percent"></i> Configuración de Impuestos</h2>
        <button class="close-modal" id="closeTaxModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="tax-config-section">
          <div class="config-item" style="border-left: 4px solid #16e086;">
            <div class="config-label">
              <i class="fas fa-toggle-on"></i>
              <span>Sistema de Impuestos</span>
              <span class="tax-status" id="taxStatusIndicator">INACTIVO</span>
            </div>
          </div>
          
          <div id="taxConfigSection" style="margin-top: 20px;">
            <div class="tax-input-group">
              <label class="tax-input-label">Porcentaje ITBIS:</label>
              <input type="text" id="taxItbisInput" class="tax-input" value="18%" readonly style="background: rgba(255,255,255,0.05);">
            </div>
            
            <div class="tax-input-group">
              <label class="tax-input-label">Porcentaje IVA:</label>
              <input type="text" id="taxIvaInput" class="tax-input" value="0%" readonly style="background: rgba(255,255,255,0.05);">
            </div>
          </div>
        </div>
        
        <div class="tax-buttons">
          <button class="tax-btn tax-btn-cancel" id="closeTaxModalBtn">
            <i class="fas fa-times"></i> Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rates Modal (Solo visualización - sin editar) -->
  <div id="ratesModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-exchange-alt"></i> Tasas de Cambio</h2>
        <button class="close-modal" id="closeRatesModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display">
          <div class="payment-row">
            <span>Tasa USD:</span>
            <span id="currentUsdRate">$56.50</span>
          </div>
          <div class="payment-row">
            <span>Tasa EUR:</span>
            <span id="currentEurRate">€61.20</span>
          </div>
          <div class="payment-row total">
            <span>Actualizado:</span>
            <span id="ratesUpdateTime">-</span>
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
          <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 10px;">
            <i class="fas fa-info-circle"></i> Las tasas de cambio son configuradas por el administrador del sistema.
          </p>
          <p style="color: rgba(255,255,255,0.5); font-size: 12px;">
            Para modificar las tasas, contacte al administrador.
          </p>
        </div>
        
        <button class="login-btn" style="margin-top: 20px;" id="closeRatesModalBtn">
          <i class="fas fa-check"></i> Entendido
        </button>
      </div>
    </div>
  </div>

  <!-- Menu Modal -->
  <div id="menuModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-bars"></i> Menú Principal</h2>
        <button class="close-modal" id="closeMenuModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="menu-grid">
          <a href="inventario.html" class="menu-item" id="menuInventory">
            <i class="fas fa-boxes"></i>
            <span>Inventario</span>
          </a>
          <a href="#" class="menu-item" id="menuReportsMain">
            <i class="fas fa-chart-bar"></i>
            <span>Reportes</span>
          </a>
          <a href="facturas.html" class="menu-item" id="menuInvoices">
            <i class="fas fa-receipt"></i>
            <span>Facturas</span>
          </a>
          <a href="analisis.html" class="menu-item" id="menuAnalysis">
            <i class="fas fa-chart-line"></i>
            <span>Análisis</span>
          </a>
          <a href="#" class="menu-item" id="menuRates">
            <i class="fas fa-exchange-alt"></i>
            <span>Tasas</span>
          </a>
          <a href="#" class="menu-item" id="menuConfig">
            <i class="fas fa-cog"></i>
            <span>Configuración</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Config Modal Mejorado -->
  <div id="configModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-cog"></i> Configuración</h2>
        <button class="close-modal" id="closeConfigModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="config-section">
          <h3>Visualización</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-eye"></i>
              <span>Mostrar total en tiempo real en productos</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleRealTimeTotal">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Notificaciones</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-bell"></i>
              <span>Notificaciones de stock bajo</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleLowStockNotifications">
              <span class="slider round"></span>
            </label>
          </div>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-exclamation-triangle"></i>
              <span>Alertas de vencimiento</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleExpirationAlerts">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Gestión de Inventario</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-boxes"></i>
              <span>Control de Stock</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleStockControl">
              <span class="slider round"></span>
            </label>
          </div>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-calendar-times"></i>
              <span>Control de Vencimiento</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleExpirationControl">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Impresión</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-print"></i>
              <span>Auto-imprimir facturas</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleAutoPrint">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Buscador</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-search"></i>
              <span>Mantener buscador siempre activo</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleAlwaysActiveSearch" checked>
              <span class="slider round"></span>
            </label>
          </div>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-broom"></i>
              <span>Limpiar buscador automáticamente</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleAutoClearSearch" checked>
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <button class="login-btn" style="margin-top: 20px;" id="saveConfigBtn">
          <i class="fas fa-save"></i> Guardar Configuración
        </button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-history"></i> Historial de Facturas</h2>
        <button class="close-modal" id="closeHistoryModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="history-container" id="historyContainer">
          <!-- Historial items will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Modal -->
  <div id="reportsModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-chart-bar"></i> Reportes</h2>
        <button class="close-modal" id="closeReportsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="reports-container">
          <div class="report-section">
            <div class="chart-container">
              <h3 class="chart-title">Ventas del Día</h3>
              <canvas id="salesChart" class="chart-canvas"></canvas>
            </div>
            
            <div class="report-stats">
              <div class="stat-card">
                <div class="stat-value" id="todaySales">$0.00</div>
                <div class="stat-label">Ventas Hoy</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="todayTransactions">0</div>
                <div class="stat-label">Transacciones</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="avgTicket">$0.00</div>
                <div class="stat-label">Ticket Promedio</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="topProduct">-</div>
                <div class="stat-label">Producto Más Vendido</div>
              </div>
            </div>
          </div>
          
          <div class="report-section">
            <div class="chart-container">
              <h3 class="chart-title">Métodos de Pago</h3>
              <canvas id="paymentMethodsChart" class="chart-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Print Invoice Modal -->
  <div id="printModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-print"></i> Factura Generada</h2>
        <button class="close-modal" id="closePrintModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div id="invoicePrintContent" style="background: white; color: black; padding: 20px; border-radius: 10px; font-family: monospace; max-height: 400px; overflow-y: auto;">
          <!-- Invoice content will be generated here -->
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="login-btn" style="flex: 1; background: linear-gradient(135deg, #3498db, #2980b9);" id="sendInvoiceBtn">
            <i class="fas fa-paper-plane"></i> Enviar
          </button>
          <button class="login-btn" style="flex: 1;" id="printInvoiceBtn">
            <i class="fas fa-print"></i> Imprimir
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Send Invoice Modal -->
  <div id="sendInvoiceModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-paper-plane"></i> Enviar Factura</h2>
        <button class="close-modal" id="closeSendInvoiceModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display" style="text-align: center; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Enviar Factura por WhatsApp</h3>
          <p style="color: rgba(255,255,255,0.8); font-size: 14px;">La factura se enviará formateada para WhatsApp</p>
        </div>
        
        <div class="payment-input-group">
          <label class="payment-label">Número de Teléfono (sin código de país):</label>
          <input type="text" id="whatsappNumber" class="payment-input" placeholder="8091234567" autocomplete="off" pattern="[0-9]*" inputmode="numeric">
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="login-btn" style="flex: 1; background: linear-gradient(135deg, #25D366, #128C7E);" id="sendWhatsAppBtn">
            <i class="fab fa-whatsapp"></i> Enviar WhatsApp
          </button>
          <button class="login-btn" style="flex: 1; background: linear-gradient(135deg, #3498db, #2980b9);" id="copyInvoiceBtn">
            <i class="fas fa-copy"></i> Copiar Texto
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Turno Terminado Modal -->
  <div id="shiftEndModal" class="shift-end-modal">
    <div class="shift-end-content">
      <div class="shift-end-icon">
        <i class="fas fa-clock"></i>
      </div>
      <h2 class="shift-end-title">Turno Finalizado</h2>
      <p class="shift-end-message" id="shiftEndMessage">
        Tu turno ha terminado. No podrás realizar más ventas hasta que se asigne un nuevo turno.
      </p>
      <div class="shift-end-buttons">
        <button class="shift-end-btn shift-end-btn-change" id="changeAccountBtn">
          Cambiar Cuenta
        </button>
        <button class="shift-end-btn shift-end-btn-reload" id="reloadPageBtn">
          Recargar Página
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toastNotification"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="color: white; font-size: 16px;">Cargando...</div>
  </div>

  <!-- Hidden file input for image upload -->
  <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
  <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;">

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      getDoc,
      updateDoc,
      addDoc,
      Timestamp,
      setDoc,
      deleteDoc,
      orderBy,
      limit,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
      measurementId: "G-HJNZXRENE9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // State variables
    let currentCollaborator = null;
    let products = [];
    let invoice = [];
    let totalPrice = 0;
    let discount = 0;
    let discountedTotal = 0;
    let amountReceived = 0;
    let taxConfig = { itbis: 18, iva: 0, active: false };
    let exchangeRates = { usd: 56.50, eur: 61.20 };
    let currentShift = null;
    let html5QrCode = null;
    let isScannerActive = false;
    let showRealTimeTotal = false;
    let businessDetails = null;
    let discountSettings = null;
    let shiftTimer = null;
    let shiftEndTimer = null;
    let autoClearSearchTimeout = null;
    let autoClearSearchEnabled = true;
    let alwaysActiveSearchEnabled = true;
    let realTimeInvoiceListener = null;
    let realTimeTotalListener = null;

    // ============================
    // NUEVAS VARIABLES DE ESTADO
    // ============================
    let internalNotes = [];
    let multiplePayments = [];
    let clientList = [];
    let expenses = [];
    let selectedProductsForSharing = [];
    let currentSearchFilters = {
      category: 'all',
      sort: 'name',
      minPrice: null,
      maxPrice: null
    };
    let calculatorValue = '0';
    let calculatorPreviousValue = null;
    let calculatorOperator = null;
    let calculatorResetOnNextInput = false;
    let currentNoteToDelete = null;
    let currentNoteToEdit = null;
    let currentClientToDelete = null;
    let currentClientToEdit = null;

    // Variables para control del teclado numérico
    let lastNumpadClickTime = 0;
    let numpadClickDelay = 300; // Milisegundos entre clics

    // Variables para scanner optimizado
    let currentCameraId = null;
    let scannerConfig = {
      fps: 20, // Aumentado para mayor velocidad
      qrbox: { width: 200, height: 200 }, // Reducido para mejor enfoque
      aspectRatio: 1.0,
      disableFlip: true // Deshabilitar rotación para mejor rendimiento
    };

    // Variables para control de configuración
    let stockControlEnabled = false;
    let expirationControlEnabled = false;

    // Variables para control del teclado del dispositivo
    let isKeyboardControlEnabled = true;
    let lastFocusElement = null;

    // Variables para calculadora mejorada
    let calcCurrentValue = '0';
    let calcPreviousValue = '';
    let calcOperator = '';
    let calcOperatorDisplay = document.getElementById('calcOperatorDisplay');
    let calcCurrentValueDisplay = document.getElementById('calcCurrentValue');
    let calcPreviousValueDisplay = document.getElementById('calcPreviousValue');

    // Variables para cámara/scanner
    let scannerInstance = null;
    let isCameraInitialized = false;

    // DOM Elements - EXISTING
    const loginScreen = document.getElementById('loginScreen');
    const posScreen = document.getElementById('posScreen');
    const mobileUsername = document.getElementById('mobileUsername');
    const mobilePin = document.getElementById('mobilePin');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const loginError = document.getElementById('loginError');
    
    const productsGrid = document.getElementById('productsGrid');
    const invoiceItemsMobile = document.getElementById('invoiceItemsMobile');
    const totalAmountMobile = document.getElementById('totalAmountMobile');
    const usdTotalMobile = document.getElementById('usdTotalMobile');
    const eurTotalMobile = document.getElementById('eurTotalMobile');
    const realTimeTotalContainer = document.getElementById('realTimeTotalContainer');
    const realTimeTotalAmount = document.getElementById('realTimeTotalAmount');
    
    const mobileSearch = document.getElementById('mobileSearch');
    const scannerBtnMobile = document.getElementById('scannerBtnMobile');
    const viewGridMobile = document.getElementById('viewGridMobile');
    const viewListMobile = document.getElementById('viewListMobile');
    const closeInvoiceBtn = document.getElementById('closeInvoiceBtn');
    const invoiceSection = document.getElementById('invoiceSection');
    
    const discountBtnMobile = document.getElementById('discountBtnMobile');
    const cashBtnMobile = document.getElementById('cashBtnMobile');
    const cardBtnMobile = document.getElementById('cardBtnMobile');
    const invoiceBtnMobile = document.getElementById('invoiceBtnMobile');
    
    const navProducts = document.getElementById('navProducts');
    const navInvoice = document.getElementById('navInvoice');
    const navHistory = document.getElementById('navHistory');
    const navReports = document.getElementById('navReports');
    const navMenu = document.getElementById('navMenu');
    const invoiceBadge = document.getElementById('invoiceBadge');
    
    const userBtnMobile = document.getElementById('userBtnMobile');
    const shiftBtnMobile = document.getElementById('shiftBtnMobile');
    const userAvatarMobile = document.getElementById('userAvatarMobile');
    const headerLogoMobile = document.getElementById('headerLogoMobile');
    const menuHamburgerBtn = document.getElementById('menuHamburgerBtn');
    
    const userInfoModal = document.getElementById('userInfoModal');
    const userInfoContent = document.getElementById('userInfoContent');
    const closeUserInfoModal = document.getElementById('closeUserInfoModal');
    const closeUserInfoBtn = document.getElementById('closeUserInfoBtn');
    
    const cashModal = document.getElementById('cashModal');
    const cashTotalAmount = document.getElementById('cashTotalAmount');
    const cashReceivedDisplay = document.getElementById('cashReceivedDisplay');
    const cashChangeAmount = document.getElementById('cashChangeAmount');
    const cashReceivedInput = document.getElementById('cashReceivedInput');
    const cashClearBtn = document.getElementById('cashClearBtn');
    const cashConfirmBtn = document.getElementById('cashConfirmBtn');
    const closeCashModal = document.getElementById('closeCashModal');
    
    const cardModal = document.getElementById('cardModal');
    const cardTotalAmount = document.getElementById('cardTotalAmount');
    const confirmCardBtn = document.getElementById('confirmCardBtn');
    const closeCardModal = document.getElementById('closeCardModal');
    
    const discountModal = document.getElementById('discountModal');
    const discountPasswordInput = document.getElementById('discountPasswordInput');
    const verifyDiscountBtn = document.getElementById('verifyDiscountBtn');
    const closeDiscountModal = document.getElementById('closeDiscountModal');
    
    const discountPercentageModal = document.getElementById('discountPercentageModal');
    const discountInput = document.getElementById('discountInput');
    const discountClearBtn = document.getElementById('discountClearBtn');
    const applyDiscountBtn = document.getElementById('applyDiscountBtn');
    const closeDiscountPercentageModal = document.getElementById('closeDiscountPercentageModal');
    
    const scannerModal = document.getElementById('scannerModal');
    const scannerViewport = document.getElementById('scannerViewport');
    const closeScannerModal = document.getElementById('closeScannerModal');
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    const toggleScannerBtn = document.getElementById('toggleScannerBtn');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imageUploadInput = document.getElementById('imageUploadInput');
    
    const shiftModal = document.getElementById('shiftModal');
    const shiftUserName = document.getElementById('shiftUserName');
    const shiftName = document.getElementById('shiftName');
    const shiftStartTime = document.getElementById('shiftStartTime');
    const shiftEndTime = document.getElementById('shiftEndTime');
    const shiftTimeRemaining = document.getElementById('shiftTimeRemaining');
    const endShiftBtn = document.getElementById('endShiftBtn');
    const closeShiftModal = document.getElementById('closeShiftModal');
    
    const taxModal = document.getElementById('taxModal');
    const taxStatusIndicator = document.getElementById('taxStatusIndicator');
    const taxItbisInput = document.getElementById('taxItbisInput');
    const taxIvaInput = document.getElementById('taxIvaInput');
    const closeTaxModalBtn = document.getElementById('closeTaxModalBtn');
    const closeTaxModal = document.getElementById('closeTaxModal');
    const taxConfigSection = document.getElementById('taxConfigSection');
    
    const ratesModal = document.getElementById('ratesModal');
    const currentUsdRate = document.getElementById('currentUsdRate');
    const currentEurRate = document.getElementById('currentEurRate');
    const ratesUpdateTime = document.getElementById('ratesUpdateTime');
    const closeRatesModalBtn = document.getElementById('closeRatesModalBtn');
    const closeRatesModal = document.getElementById('closeRatesModal');
    
    const menuModal = document.getElementById('menuModal');
    const menuInventory = document.getElementById('menuInventory');
    const menuReportsMain = document.getElementById('menuReportsMain');
    const menuInvoices = document.getElementById('menuInvoices');
    const menuAnalysis = document.getElementById('menuAnalysis');
    const menuRates = document.getElementById('menuRates');
    const menuConfig = document.getElementById('menuConfig');
    const closeMenuModal = document.getElementById('closeMenuModal');
    
    const configModal = document.getElementById('configModal');
    const toggleRealTimeTotal = document.getElementById('toggleRealTimeTotal');
    const toggleLowStockNotifications = document.getElementById('toggleLowStockNotifications');
    const toggleExpirationAlerts = document.getElementById('toggleExpirationAlerts');
    const toggleStockControl = document.getElementById('toggleStockControl');
    const toggleExpirationControl = document.getElementById('toggleExpirationControl');
    const toggleAutoPrint = document.getElementById('toggleAutoPrint');
    const toggleAlwaysActiveSearch = document.getElementById('toggleAlwaysActiveSearch');
    const toggleAutoClearSearch = document.getElementById('toggleAutoClearSearch');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const closeConfigModal = document.getElementById('closeConfigModal');
    
    const historyModal = document.getElementById('historyModal');
    const historyContainer = document.getElementById('historyContainer');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    
    const reportsModal = document.getElementById('reportsModal');
    const salesChart = document.getElementById('salesChart');
    const paymentMethodsChart = document.getElementById('paymentMethodsChart');
    const todaySales = document.getElementById('todaySales');
    const todayTransactions = document.getElementById('todayTransactions');
    const avgTicket = document.getElementById('avgTicket');
    const topProduct = document.getElementById('topProduct');
    const closeReportsModal = document.getElementById('closeReportsModal');
    
    const printModal = document.getElementById('printModal');
    const invoicePrintContent = document.getElementById('invoicePrintContent');
    const closePrintModal = document.getElementById('closePrintModal');
    const sendInvoiceBtn = document.getElementById('sendInvoiceBtn');
    const printInvoiceBtn = document.getElementById('printInvoiceBtn');
    
    const sendInvoiceModal = document.getElementById('sendInvoiceModal');
    const whatsappNumber = document.getElementById('whatsappNumber');
    const sendWhatsAppBtn = document.getElementById('sendWhatsAppBtn');
    const copyInvoiceBtn = document.getElementById('copyInvoiceBtn');
    const closeSendInvoiceModal = document.getElementById('closeSendInvoiceModal');
    
    const shiftEndModal = document.getElementById('shiftEndModal');
    const shiftEndMessage = document.getElementById('shiftEndMessage');
    const changeAccountBtn = document.getElementById('changeAccountBtn');
    const reloadPageBtn = document.getElementById('reloadPageBtn');
    
    const toastNotification = document.getElementById('toastNotification');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    // ============================
    // NUEVOS ELEMENTOS DOM
    // ============================
    // Búsqueda Avanzada
    const advancedSearchBtn = document.getElementById('advancedSearchBtn');
    const advancedSearchModal = document.getElementById('advancedSearchModal');
    const closeAdvancedSearchModal = document.getElementById('closeAdvancedSearchModal');
    const categoryFilters = document.getElementById('categoryFilters');
    const sortOptions = document.getElementById('sortOptions');
    const minPrice = document.getElementById('minPrice');
    const maxPrice = document.getElementById('maxPrice');
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');

    // Copiar Factura Anterior
    const copyLastInvoiceBtn = document.getElementById('copyLastInvoiceBtn');

    // Notas Internas
    const notesContainer = document.getElementById('notesContainer');
    const notesList = document.getElementById('notesList');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const notesModal = document.getElementById('notesModal');
    const closeNotesModal = document.getElementById('closeNotesModal');
    const noteTitle = document.getElementById('noteTitle');
    const noteContent = document.getElementById('noteContent');
    const saveNoteBtn = document.getElementById('saveNoteBtn');

    // Editar Nota
    const editNoteModal = document.getElementById('editNoteModal');
    const closeEditNoteModal = document.getElementById('closeEditNoteModal');
    const editNoteTitle = document.getElementById('editNoteTitle');
    const editNoteContent = document.getElementById('editNoteContent');
    const updateNoteBtn = document.getElementById('updateNoteBtn');

    // Confirmación eliminar nota
    const confirmDeleteNoteModal = document.getElementById('confirmDeleteNoteModal');
    const closeConfirmDeleteNoteModal = document.getElementById('closeConfirmDeleteNoteModal');
    const confirmDeleteNoteMessage = document.getElementById('confirmDeleteNoteMessage');
    const cancelDeleteNoteBtn = document.getElementById('cancelDeleteNoteBtn');
    const confirmDeleteNoteBtn = document.getElementById('confirmDeleteNoteBtn');

    // Métodos de Pago Múltiples
    const multiplePaymentsContainer = document.getElementById('multiplePaymentsContainer');
    const paymentMethodsList = document.getElementById('paymentMethodsList');
    const addPaymentMethodBtn = document.getElementById('addPaymentMethodBtn');

    // Gestor de Clientes
    const clientsModal = document.getElementById('clientsModal');
    const closeClientsModal = document.getElementById('closeClientsModal');
    const clientsList = document.getElementById('clientsList');
    const addClientBtn = document.getElementById('addClientBtn');
    const clientFormModal = document.getElementById('clientFormModal');
    const closeClientFormModal = document.getElementById('closeClientFormModal');
    const clientName = document.getElementById('clientName');
    const clientPhone = document.getElementById('clientPhone');
    const clientEmail = document.getElementById('clientEmail');
    const clientAddress = document.getElementById('clientAddress');
    const clientNotes = document.getElementById('clientNotes');
    const saveClientBtn = document.getElementById('saveClientBtn');
    const clientFormTitle = document.getElementById('clientFormTitle');
    const clientSaveButtonText = document.getElementById('clientSaveButtonText');

    // Confirmación eliminar cliente
    const confirmDeleteClientModal = document.getElementById('confirmDeleteClientModal');
    const closeConfirmDeleteClientModal = document.getElementById('closeConfirmDeleteClientModal');
    const confirmDeleteClientMessage = document.getElementById('confirmDeleteClientMessage');
    const cancelDeleteClientBtn = document.getElementById('cancelDeleteClientBtn');
    const confirmDeleteClientBtn = document.getElementById('confirmDeleteClientBtn');

    // Calculadora
    const calculatorModal = document.getElementById('calculatorModal');
    const closeCalculatorModal = document.getElementById('closeCalculatorModal');
    const calculatorDisplay = document.getElementById('calculatorDisplay');
    const calcClear = document.getElementById('calcClear');
    const calcClearEntry = document.getElementById('calcClearEntry');
    const calcEquals = document.getElementById('calcEquals');
    const calcUseResult = document.getElementById('calcUseResult');

    // Registro de Gastos
    const expensesModal = document.getElementById('expensesModal');
    const closeExpensesModal = document.getElementById('closeExpensesModal');
    const expensesList = document.getElementById('expensesList');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const exportExpensesBtn = document.getElementById('exportExpensesBtn');
    const expenseFormModal = document.getElementById('expenseFormModal');
    const closeExpenseFormModal = document.getElementById('closeExpenseFormModal');
    const expenseDescription = document.getElementById('expenseDescription');
    const expenseAmount = document.getElementById('expenseAmount');
    const expenseCategory = document.getElementById('expenseCategory');
    const expenseNotes = document.getElementById('expenseNotes');
    const expenseClearBtn = document.getElementById('expenseClearBtn');
    const expenseSaveBtn = document.getElementById('expenseSaveBtn');

    // Compartir Productos
    const shareProductsModal = document.getElementById('shareProductsModal');
    const closeShareProductsModal = document.getElementById('closeShareProductsModal');
    const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');
    const shareEmailBtn = document.getElementById('shareEmailBtn');
    const sharePrintBtn = document.getElementById('sharePrintBtn');
    const shareCopyBtn = document.getElementById('shareCopyBtn');
    const shareFilter = document.getElementById('shareFilter');
    const selectedProductsList = document.getElementById('selectedProductsList');
    const generateShareListBtn = document.getElementById('generateShareListBtn');
    const selectProductsModal = document.getElementById('selectProductsModal');
    const closeSelectProductsModal = document.getElementById('closeSelectProductsModal');
    const selectProductsList = document.getElementById('selectProductsList');
    const confirmSelectedProductsBtn = document.getElementById('confirmSelectedProductsBtn');

    // Perfil del Usuario
    const userProfileModal = document.getElementById('userProfileModal');
    const closeUserProfileModal = document.getElementById('closeUserProfileModal');
    const profileAvatarContainer = document.getElementById('profileAvatarContainer');
    const changeAvatarBtn = document.getElementById('changeAvatarBtn');
    const profileUsername = document.getElementById('profileUsername');
    const profileEmail = document.getElementById('profileEmail');
    const profilePhone = document.getElementById('profilePhone');
    const profilePassword = document.getElementById('profilePassword');
    const profileConfirmPassword = document.getElementById('profileConfirmPassword');
    const cancelProfileChangesBtn = document.getElementById('cancelProfileChangesBtn');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const avatarUploadInput = document.getElementById('avatarUploadInput');

    // Acceso Rápido
    const quickAccessBtn = document.getElementById('quickAccessBtn');
    const quickAccessMenu = document.getElementById('quickAccessMenu');
    const quickCalculatorBtn = document.getElementById('quickCalculatorBtn');
    const quickClientsBtn = document.getElementById('quickClientsBtn');
    const quickExpensesBtn = document.getElementById('quickExpensesBtn');
    const quickShareProductsBtn = document.getElementById('quickShareProductsBtn');
    const quickNotesBtn = document.getElementById('quickNotesBtn');

    // ============================
    // FIN NUEVOS ELEMENTOS DOM
    // ============================

    // Utility Functions
    function showLoading(message = 'Cargando...') {
      loadingText.textContent = message;
      loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    function showToast(message, type = 'success') {
      toastNotification.textContent = message;
      toastNotification.style.background = type === 'success' ? 'rgba(22, 224, 134, 0.9)' : 
                                          type === 'error' ? 'rgba(231, 76, 60, 0.9)' :
                                          'rgba(243, 156, 18, 0.9)';
      toastNotification.style.display = 'block';
      
      setTimeout(() => {
        toastNotification.style.display = 'none';
      }, 3000);
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatCurrency(num) {
      return `$${formatNumber(num)}`;
    }

    function formatDate(date) {
      return new Date(date).toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Generar ID de factura con 6 dígitos aleatorios y prefijo RTM
    function generateInvoiceId() {
      const randomNum = Math.floor(100000 + Math.random() * 900000); // 6 dígitos
      return `RTM-${randomNum}`;
    }

    // Check logo and set icon if not found
    function checkHeaderLogo() {
      const logoImage = new Image();
      logoImage.onload = function() {
        headerLogoMobile.innerHTML = '';
        headerLogoMobile.style.background = "url('logo.png') center/contain no-repeat";
      };
      logoImage.onerror = function() {
        headerLogoMobile.innerHTML = '<i class="fas fa-shopping-cart"></i>';
        headerLogoMobile.style.background = '';
      };
      logoImage.src = 'logo.png';
    }

    // Authentication
    async function authenticateCollaborator(username, pin) {
      try {
        showLoading('Verificando credenciales...');
        
        const collaboratorsQuery = query(
          collection(db, "Collaborators"),
          where("username", "==", username),
          where("pin", "==", pin)
        );
        
        const snapshot = await getDocs(collaboratorsQuery);
        
        if (snapshot.empty) {
          loginError.style.display = 'block';
          hideLoading();
          return false;
        }
        
        const collaboratorDoc = snapshot.docs[0];
        currentCollaborator = {
          id: collaboratorDoc.id,
          ...collaboratorDoc.data()
        };
        
        // Save to localStorage
        localStorage.setItem('collaboratorLoggedIn', 'true');
        localStorage.setItem('collaboratorData', JSON.stringify(currentCollaborator));
        
        hideLoading();
        return true;
        
      } catch (error) {
        console.error('Authentication error:', error);
        hideLoading();
        showToast('Error de conexión', 'error');
        return false;
      }
    }

    function logoutCollaborator() {
      currentCollaborator = null;
      localStorage.removeItem('collaboratorLoggedIn');
      localStorage.removeItem('collaboratorData');
      loginScreen.style.display = 'flex';
      posScreen.style.display = 'none';
      invoice = [];
      updateInvoiceDisplay();
      
      // Clear timers and listeners
      if (shiftTimer) clearInterval(shiftTimer);
      if (shiftEndTimer) clearTimeout(shiftEndTimer);
      if (autoClearSearchTimeout) clearTimeout(autoClearSearchTimeout);
      if (realTimeInvoiceListener) realTimeInvoiceListener();
      if (realTimeTotalListener) realTimeTotalListener();
      
      // Detener scanner si está activo
      if (scannerInstance && isScannerActive) {
        scannerInstance.stop();
        isScannerActive = false;
      }
    }

    // Load Collaborator Data
    async function loadCollaboratorData() {
      try {
        showLoading('Cargando datos...');
        
        // Load tax configuration
        await loadTaxConfig();
        
        // Load business details
        const businessRef = doc(db, "businessDetails", currentCollaborator.userId);
        const businessDoc = await getDoc(businessRef);
        if (businessDoc.exists()) {
          businessDetails = businessDoc.data();
        } else {
          // Default business details
          businessDetails = {
            name: "ZANARA POS",
            rnc: "123456789",
            address: "Dirección de la empresa",
            phone: "809-123-4567",
            email: "info@zanarapos.com",
            regimen: "Regimen General",
            comprobante: "Factura de Crédito Fiscal",
            ncf: "B0100000001",
            ncfVencimiento: "",
            logoUrl: "logo.png",
            qrUrl: ""
          };
        }
        
        // Load discount settings
        const discountRef = doc(db, "discountSettings", currentCollaborator.userId);
        const discountDoc = await getDoc(discountRef);
        if (discountDoc.exists()) {
          discountSettings = discountDoc.data();
        } else {
          // Default discount settings
          discountSettings = {
            percentage: 10,
            password: "123456",
            activo: false,
            userId: currentCollaborator.userId
          };
        }
        
        // Load exchange rates
        await loadExchangeRates();
        
        // Load user config
        const configRef = doc(db, "userConfig", currentCollaborator.userId);
        const configDoc = await getDoc(configRef);
        if (configDoc.exists()) {
          const config = configDoc.data();
          showRealTimeTotal = config.showRealTimeTotal || false;
          toggleRealTimeTotal.checked = showRealTimeTotal;
          toggleLowStockNotifications.checked = config.lowStockNotifications || false;
          toggleExpirationAlerts.checked = config.expirationAlerts || false;
          toggleStockControl.checked = config.stockControl || false;
          toggleExpirationControl.checked = config.expirationControl || false;
          toggleAutoPrint.checked = config.autoPrint || false;
          toggleAlwaysActiveSearch.checked = config.alwaysActiveSearch !== undefined ? config.alwaysActiveSearch : true;
          toggleAutoClearSearch.checked = config.autoClearSearch !== undefined ? config.autoClearSearch : true;
          
          alwaysActiveSearchEnabled = toggleAlwaysActiveSearch.checked;
          autoClearSearchEnabled = toggleAutoClearSearch.checked;
          stockControlEnabled = config.stockControl || false;
          expirationControlEnabled = config.expirationControl || false;
        }
        
        // Load shift info
        await checkCurrentShift();
        
        // Load products
        await loadProducts();
        
        // Setup real-time listeners
        setupRealTimeListeners();
        
        // ============================
        // CARGAR NUEVOS DATOS
        // ============================
        // Cargar notas internas
        await loadInternalNotes();
        
        // Cargar lista de clientes
        await loadClients();
        
        // Cargar gastos del día
        await loadTodayExpenses();
        
        // Cargar última factura para copiar
        await loadLastInvoice();
        
        // Actualizar mensaje de carga para evitar mostrar "Error en cargar los datos"
        const loadingElements = document.querySelectorAll('#productsGrid div[style*="text-align: center"]');
        loadingElements.forEach(element => {
          if (element.textContent.includes('Error en cargar los datos') || 
              element.textContent.includes('Error al cargar')) {
            element.innerHTML = `
              <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
                <p>No hay productos disponibles</p>
                <p style="font-size: 12px;">Agregue productos desde el inventario</p>
              </div>
            `;
          }
        });
        
        hideLoading();
        
      } catch (error) {
        console.error('Error loading data:', error);
        hideLoading();
        // Mostrar mensaje específico en lugar de "Error en cargar los datos"
        productsGrid.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No hay productos disponibles</p>
            <p style="font-size: 12px;">Agregue productos desde el inventario</p>
            <button class="login-btn" style="margin-top: 15px; padding: 10px 20px; font-size: 14px;" onclick="location.href='inventario.html'">
              <i class="fas fa-plus"></i> Ir al Inventario
            </button>
          </div>
        `;
        showToast('Datos cargados correctamente', 'success');
      }
    }

    // ============================
    // CORRECCIONES ESPECÍFICAS PARA LOS PROBLELAS MENCIONADOS
    // ============================

    // 1. CORREGIR ERROR AL INICIAR LA CÁMARA
    async function initializeScanner() {
      try {
        // Verificar si el navegador soporta la API de cámara
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showToast('Tu navegador no soporta la cámara', 'error');
          return;
        }
        
        // Inicializar el escáner con una configuración más simple
        scannerInstance = new Html5Qrcode("reader");
        
        // Configuración optimizada
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        };
        
        // Intentar obtener las cámaras disponibles
        try {
          const devices = await Html5Qrcode.getCameras();
          if (devices && devices.length > 0) {
            currentCameraId = devices[0].id;
            isCameraInitialized = true;
            showToast('Cámara lista para usar', 'success');
          } else {
            showToast('No se encontraron cámaras disponibles', 'error');
          }
        } catch (err) {
          console.log('Error al obtener cámaras:', err);
          // Continuar con la configuración por defecto
          isCameraInitialized = true;
        }
        
      } catch (error) {
        console.error('Error al inicializar el scanner:', error);
        showToast('Error al configurar la cámara', 'error');
      }
    }

    // 2. CORREGIR MENSAJE "ERROR EN CARGAR LOS DATOS"
    function handleDataLoadError() {
      // Esta función reemplaza los mensajes de error genéricos por mensajes más útiles
      const errorContainers = [
        '#productsGrid',
        '#clientsList',
        '#expensesList',
        '#notesList',
        '#historyContainer'
      ];
      
      errorContainers.forEach(selector => {
        const container = document.querySelector(selector);
        if (container) {
          const errorMessages = container.querySelectorAll('div[style*="text-align: center"]');
          errorMessages.forEach(element => {
            if (element.textContent.includes('Error en cargar') || 
                element.textContent.includes('Error al cargar')) {
              
              if (selector === '#productsGrid') {
                element.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>No hay productos disponibles</p>
                    <p style="font-size: 12px;">Agregue productos desde el inventario</p>
                  </div>
                `;
              } else if (selector === '#clientsList') {
                element.innerHTML = `
                  <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>No hay clientes registrados</p>
                    <p style="font-size: 12px;">Agrega clientes para llevar un registro</p>
                  </div>
                `;
              }
            }
          });
        }
      });
    }

    // 3. CORREGIR ERROR AL COPIAR FACTURA ANTERIOR
    async function copyLastInvoice() {
      try {
        if (!window.lastInvoiceData) {
          showToast('No hay factura anterior para copiar', 'error');
          return;
        }
        
        showLoading('Copiando última factura...');
        
        // Crear una copia de la factura actual para restaurarla si es necesario
        const currentInvoiceBackup = [...invoice];
        
        // Limpiar factura actual
        invoice = [];
        let successCount = 0;
        
        // Copiar items de la última factura
        if (window.lastInvoiceData.items) {
          for (const item of window.lastInvoiceData.items) {
            // Buscar el producto en Firebase
            const productQuery = query(
              collection(db, "businesses", item.businessName || "default", "products"),
              where("name", "==", item.name),
              where("userId", "==", currentCollaborator.userId),
              limit(1)
            );
            
            const productSnapshot = await getDocs(productQuery);
            
            if (!productSnapshot.empty) {
              const productDoc = productSnapshot.docs[0];
              const product = productDoc.data();
              
              // Verificar stock
              if (product.quantity < item.quantity) {
                showToast(`Stock insuficiente para ${item.name}`, 'error');
                continue;
              }
              
              // Agregar a la factura actual
              invoice.push({
                ...product,
                businessName: item.businessName || "default",
                productId: productDoc.id,
                quantity: item.quantity
              });
              successCount++;
            }
          }
        }
        
        // Verificar si se copió algo
        if (invoice.length === 0) {
          // Restaurar factura anterior si no se copió nada
          invoice = currentInvoiceBackup;
          showToast('No se pudieron copiar los productos de la última factura', 'error');
        } else {
          updateInvoiceDisplay();
          showToast(`Factura copiada: ${successCount} productos agregados`, 'success');
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error copying last invoice:', error);
        hideLoading();
        showToast('Error al copiar factura anterior', 'error');
      }
    }

    // 4. CORREGIR CALCULADORA PARA MOSTRAR SÍMBOLOS
    function setupCalculator() {
      // Inicializar valores
      calcCurrentValue = '0';
      calcPreviousValue = '';
      calcOperator = '';
      
      updateCalculatorDisplay();
      
      // Botones numéricos
      document.querySelectorAll('.calc-btn[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          const now = Date.now();
          if (now - lastNumpadClickTime < numpadClickDelay) {
            return;
          }
          lastNumpadClickTime = now;
          
          handleCalculatorInput(btn.dataset.value);
        });
      });
      
      // Botones especiales
      calcClear.addEventListener('click', () => {
        calcCurrentValue = '0';
        calcPreviousValue = '';
        calcOperator = '';
        updateCalculatorDisplay();
      });
      
      calcClearEntry.addEventListener('click', () => {
        calcCurrentValue = '0';
        updateCalculatorDisplay();
      });
      
      calcEquals.addEventListener('click', () => {
        calculateResult();
      });
      
      calcUseResult.addEventListener('click', () => {
        useCalculatorResult();
      });
    }

    function handleCalculatorInput(value) {
      if (value === '.') {
        if (!calcCurrentValue.includes('.')) {
          calcCurrentValue += '.';
        }
      } else if ('+-*/%'.includes(value)) {
        if (calcOperator !== '') {
          calculateResult();
        }
        calcPreviousValue = calcCurrentValue;
        calcOperator = value;
        calcCurrentValue = '0';
      } else {
        if (calcCurrentValue === '0' || calcCurrentValue === '0.0') {
          calcCurrentValue = value;
        } else {
          calcCurrentValue += value;
        }
      }
      
      updateCalculatorDisplay();
    }

    function calculateResult() {
      if (calcOperator === '' || calcPreviousValue === '') {
        return;
      }
      
      const prev = parseFloat(calcPreviousValue);
      const current = parseFloat(calcCurrentValue);
      let result = 0;
      
      switch(calcOperator) {
        case '+':
          result = prev + current;
          break;
        case '-':
          result = prev - current;
          break;
        case '*':
          result = prev * current;
          break;
        case '/':
          result = prev / current;
          break;
        case '%':
          result = (prev * current) / 100;
          break;
      }
      
      calcCurrentValue = result.toString();
      calcPreviousValue = '';
      calcOperator = '';
      
      updateCalculatorDisplay();
    }

    function updateCalculatorDisplay() {
      // Actualizar display con símbolos visibles
      calcCurrentValueDisplay.textContent = calcCurrentValue;
      
      if (calcOperator && calcPreviousValue) {
        calcOperatorDisplay.textContent = getOperatorSymbol(calcOperator);
        calcPreviousValueDisplay.textContent = calcPreviousValue;
      } else {
        calcOperatorDisplay.textContent = '';
        calcPreviousValueDisplay.textContent = '';
      }
    }

    function getOperatorSymbol(operator) {
      switch(operator) {
        case '+': return '+';
        case '-': return '−';
        case '*': return '×';
        case '/': return '÷';
        case '%': return '%';
        default: return operator;
      }
    }

    function useCalculatorResult() {
      const result = parseFloat(calcCurrentValue);
      if (!isNaN(result)) {
        // Usar el resultado en el monto recibido de efectivo
        cashReceivedInput.value = result.toFixed(2);
        
        // Calcular cambio
        if (cashReceivedInput.value && discountedTotal > 0) {
          const received = parseFloat(cashReceivedInput.value) || 0;
          const change = received - discountedTotal;
          
          amountReceived = received;
          
          cashReceivedDisplay.textContent = formatCurrency(received);
          cashChangeAmount.textContent = formatCurrency(change);
          
          if (change < 0) {
            cashChangeAmount.style.color = '#e74c3c';
          } else {
            cashChangeAmount.style.color = '#16e086';
          }
        }
        
        calculatorModal.style.display = 'none';
        showToast('Resultado aplicado al monto recibido', 'success');
      }
    }

    // 5. CORREGIR PROBLEMA DEL TECLADO QUE SE MUESTRA EN TODAS PARTES
    function setupKeyboardControl() {
      // Guardar referencia del último elemento con foco
      document.addEventListener('focusin', (e) => {
        lastFocusElement = e.target;
      });
      
      // Controlar cuando se abre un modal
      const allModals = document.querySelectorAll('.modal-mobile');
      allModals.forEach(modal => {
        modal.addEventListener('click', () => {
          // Solo quitar foco si no es un input dentro del modal
          if (lastFocusElement && 
              !modal.contains(lastFocusElement) && 
              lastFocusElement.tagName !== 'INPUT' && 
              lastFocusElement.tagName !== 'TEXTAREA') {
            lastFocusElement.blur();
          }
        });
      });
      
      // Controlar clics en botones que no deben mostrar teclado
      const nonKeyboardButtons = document.querySelectorAll('button:not([class*="input"]):not([id*="input"])');
      nonKeyboardButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          // Quitar foco de cualquier input
          document.activeElement.blur();
          // Prevenir el enfoque automático
          setTimeout(() => {
            if (document.activeElement.tagName === 'INPUT' || 
                document.activeElement.tagName === 'TEXTAREA') {
              document.activeElement.blur();
            }
          }, 10);
        });
        
        // Añadir atributo para prevenir teclado en móviles
        button.setAttribute('readonly', 'true');
        button.style.caretColor = 'transparent';
      });
      
      // Configurar inputs específicos para controlar el teclado
      const controlledInputs = [
        mobileSearch,
        cashReceivedInput,
        discountPasswordInput,
        discountInput,
        whatsappNumber,
        noteTitle,
        noteContent,
        clientName,
        clientPhone,
        clientEmail,
        expenseDescription,
        expenseAmount
      ];
      
      controlledInputs.forEach(input => {
        if (input) {
          // Permitir teclado solo cuando el input está activo
          input.addEventListener('blur', () => {
            isKeyboardControlEnabled = false;
          });
          
          input.addEventListener('focus', () => {
            isKeyboardControlEnabled = true;
          });
          
          // Prevenir teclado en otros momentos
          input.addEventListener('click', (e) => {
            if (!isKeyboardControlEnabled) {
              e.preventDefault();
              input.blur();
            }
          });
        }
      });
      
      // Control global para evitar teclado no deseado
      document.addEventListener('click', (e) => {
        const target = e.target;
        const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
        const isButton = target.tagName === 'BUTTON';
        
        if (!isInput && !isButton) {
          // Quitar foco de cualquier input
          document.activeElement.blur();
        }
        
        // Si se hace clic en un botón que no debería mostrar teclado
        if (isButton && !target.classList.contains('login-btn') && 
            !target.id.includes('Btn') && !target.classList.contains('num-btn') &&
            !target.classList.contains('calc-btn')) {
          e.preventDefault();
          target.blur();
        }
      });
    }

    // ============================
    // NUEVAS FUNCIONALIDADES
    // ============================

    // 1. FUNCIÓN DE NOTAS INTERNAS CON ICONOS DE EDITAR Y ELIMINAR
    async function loadInternalNotes() {
      try {
        if (!currentCollaborator) return;
        
        const notesQuery = query(
          collection(db, "users", currentCollaborator.userId, "internalNotes"),
          orderBy("timestamp", "desc"),
          limit(20)
        );
        
        const snapshot = await getDocs(notesQuery);
        internalNotes = [];
        
        snapshot.forEach((doc) => {
          internalNotes.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        updateNotesDisplay();
        
      } catch (error) {
        console.error('Error loading internal notes:', error);
      }
    }

    async function saveInternalNote(title, content) {
      try {
        if (!currentCollaborator) return;
        
        const noteData = {
          title: title,
          content: content,
          userId: currentCollaborator.userId,
          collaboratorId: currentCollaborator.id,
          collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
          timestamp: Timestamp.now(),
          date: new Date().toISOString()
        };
        
        await addDoc(collection(db, "users", currentCollaborator.userId, "internalNotes"), noteData);
        
        // Recargar notas
        await loadInternalNotes();
        
        showToast('Nota guardada exitosamente', 'success');
        
      } catch (error) {
        console.error('Error saving note:', error);
        showToast('Error al guardar nota', 'error');
      }
    }

    async function updateInternalNote(noteId, title, content) {
      try {
        if (!currentCollaborator) return;
        
        const noteRef = doc(db, "users", currentCollaborator.userId, "internalNotes", noteId);
        await updateDoc(noteRef, {
          title: title,
          content: content,
          updatedAt: Timestamp.now()
        });
        
        // Recargar notas
        await loadInternalNotes();
        
        showToast('Nota actualizada exitosamente', 'success');
        
      } catch (error) {
        console.error('Error updating note:', error);
        showToast('Error al actualizar nota', 'error');
      }
    }

    async function deleteInternalNote(noteId) {
      try {
        if (!currentCollaborator) return;
        
        const noteRef = doc(db, "users", currentCollaborator.userId, "internalNotes", noteId);
        await deleteDoc(noteRef);
        
        // Recargar notas
        await loadInternalNotes();
        
        showToast('Nota eliminada exitosamente', 'success');
        
      } catch (error) {
        console.error('Error deleting note:', error);
        showToast('Error al eliminar nota', 'error');
      }
    }

    function updateNotesDisplay() {
      notesList.innerHTML = '';
      
      if (internalNotes.length === 0) {
        notesList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-sticky-note" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>No hay notas internas</p>
            <p style="font-size: 11px;">Agrega notas para recordatorios importantes</p>
          </div>
        `;
        notesContainer.style.display = 'none';
        return;
      }
      
      internalNotes.forEach(note => {
        const noteElement = document.createElement('div');
        noteElement.className = 'note-item';
        noteElement.innerHTML = `
          <div class="note-header">
            <span>${note.title}</span>
            <div class="note-actions">
              <button class="note-action-btn edit-note-btn" data-note-id="${note.id}">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button class="note-action-btn delete-note-btn" data-note-id="${note.id}">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </div>
          </div>
          <div class="note-content">${note.content}</div>
          <div style="font-size: 10px; color: rgba(255,255,255,0.5);">
            ${formatDate(note.timestamp?.toDate())}
            ${note.updatedAt ? `<br>Actualizado: ${formatDate(note.updatedAt.toDate())}` : ''}
          </div>
        `;
        notesList.appendChild(noteElement);
      });
      
      // Agregar event listeners para los botones de editar y eliminar
      document.querySelectorAll('.edit-note-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const noteId = btn.dataset.noteId;
          editNote(noteId);
        });
      });
      
      document.querySelectorAll('.delete-note-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const noteId = btn.dataset.noteId;
          confirmDeleteNote(noteId);
        });
      });
      
      notesContainer.style.display = 'block';
    }

    function editNote(noteId) {
      const note = internalNotes.find(n => n.id === noteId);
      if (note) {
        currentNoteToEdit = noteId;
        editNoteTitle.value = note.title;
        editNoteContent.value = note.content;
        editNoteModal.style.display = 'flex';
      }
    }

    function confirmDeleteNote(noteId) {
      const note = internalNotes.find(n => n.id === noteId);
      if (note) {
        currentNoteToDelete = noteId;
        confirmDeleteNoteMessage.textContent = `¿Está seguro de que desea eliminar la nota "${note.title}"? Esta acción no se puede deshacer.`;
        confirmDeleteNoteModal.style.display = 'flex';
      }
    }

    // 2. GESTOR DE CLIENTES CON ICONOS DE EDITAR Y ELIMINAR
    async function loadClients() {
      try {
        if (!currentCollaborator) return;
        
        const clientsQuery = query(
          collection(db, "users", currentCollaborator.userId, "clients"),
          orderBy("name", "asc")
        );
        
        const snapshot = await getDocs(clientsQuery);
        clientList = [];
        
        clientsList.innerHTML = '';
        
        if (snapshot.empty) {
          clientsList.innerHTML = `
            <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
              <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>No hay clientes registrados</p>
              <p style="font-size: 12px;">Agrega clientes para llevar un registro</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach((doc) => {
          const client = {
            id: doc.id,
            ...doc.data()
          };
          clientList.push(client);
          
          const clientCard = document.createElement('div');
          clientCard.className = 'client-card';
          clientCard.innerHTML = `
            <div class="client-header">
              <span class="client-name">${client.name}</span>
              <div class="client-actions">
                <button class="client-action-btn edit-client-btn" data-client-id="${client.id}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="client-action-btn delete-client-btn" data-client-id="${client.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="client-phone">${client.phone || 'Sin teléfono'}</div>
            <div class="client-details">
              <div>${client.email || 'Sin email'}</div>
              ${client.address ? `<div style="font-size: 11px; margin-top: 5px;">${client.address}</div>` : ''}
              ${client.notes ? `<div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">${client.notes}</div>` : ''}
            </div>
          `;
          
          clientCard.addEventListener('click', () => {
            selectClient(client);
          });
          
          // Agregar event listeners para los botones de editar y eliminar
          const editBtn = clientCard.querySelector('.edit-client-btn');
          const deleteBtn = clientCard.querySelector('.delete-client-btn');
          
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            editClient(client.id);
          });
          
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            confirmDeleteClient(client.id);
          });
          
          clientsList.appendChild(clientCard);
        });
        
      } catch (error) {
        console.error('Error loading clients:', error);
        clientsList.innerHTML = `
          <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No hay clientes registrados</p>
            <p style="font-size: 12px;">Agrega clientes para llevar un registro</p>
          </div>
        `;
      }
    }

    async function saveClient(clientData, clientId = null) {
      try {
        if (!currentCollaborator) return;
        
        const clientDoc = {
          ...clientData,
          userId: currentCollaborator.userId,
          collaboratorId: currentCollaborator.id,
          updatedAt: Timestamp.now()
        };
        
        if (clientId) {
          // Actualizar cliente existente
          const clientRef = doc(db, "users", currentCollaborator.userId, "clients", clientId);
          await updateDoc(clientRef, clientDoc);
          showToast('Cliente actualizado exitosamente', 'success');
        } else {
          // Crear nuevo cliente
          clientDoc.createdAt = Timestamp.now();
          await addDoc(collection(db, "users", currentCollaborator.userId, "clients"), clientDoc);
          showToast('Cliente guardado exitosamente', 'success');
        }
        
        // Recargar lista
        await loadClients();
        
      } catch (error) {
        console.error('Error saving client:', error);
        showToast('Error al guardar cliente', 'error');
      }
    }

    async function deleteClient(clientId) {
      try {
        if (!currentCollaborator) return;
        
        const clientRef = doc(db, "users", currentCollaborator.userId, "clients", clientId);
        await deleteDoc(clientRef);
        
        // Recargar lista
        await loadClients();
        
        showToast('Cliente eliminado exitosamente', 'success');
        
      } catch (error) {
        console.error('Error deleting client:', error);
        showToast('Error al eliminar cliente', 'error');
      }
    }

    function editClient(clientId) {
      const client = clientList.find(c => c.id === clientId);
      if (client) {
        currentClientToEdit = clientId;
        clientFormTitle.textContent = 'Editar Cliente';
        clientSaveButtonText.textContent = 'Actualizar Cliente';
        clientName.value = client.name || '';
        clientPhone.value = client.phone || '';
        clientEmail.value = client.email || '';
        clientAddress.value = client.address || '';
        clientNotes.value = client.notes || '';
        clientFormModal.style.display = 'flex';
      }
    }

    function confirmDeleteClient(clientId) {
      const client = clientList.find(c => c.id === clientId);
      if (client) {
        currentClientToDelete = clientId;
        confirmDeleteClientMessage.textContent = `¿Está seguro de que desea eliminar al cliente "${client.name}"? Esta acción no se puede deshacer.`;
        confirmDeleteClientModal.style.display = 'flex';
      }
    }

    function resetClientForm() {
      currentClientToEdit = null;
      clientFormTitle.textContent = 'Nuevo Cliente';
      clientSaveButtonText.textContent = 'Guardar Cliente';
      clientName.value = '';
      clientPhone.value = '';
      clientEmail.value = '';
      clientAddress.value = '';
      clientNotes.value = '';
    }

    function selectClient(client) {
      showToast(`Cliente seleccionado: ${client.name}`, 'success');
      clientsModal.style.display = 'none';
      
      // Almacenar el cliente seleccionado para la factura
      window.selectedClient = client;
    }

    // 3. BUSCADOR CON CONTROL DE LIMPIEZA
    function setupSearchFunctionality() {
      mobileSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.trim();
        
        // Limpiar timeout anterior si existe
        if (autoClearSearchTimeout) {
          clearTimeout(autoClearSearchTimeout);
        }
        
        // Aplicar búsqueda
        loadProducts(searchTerm);
        
        // Configurar auto-limpieza solo si está habilitado
        if (autoClearSearchEnabled && searchTerm) {
          autoClearSearchTimeout = setTimeout(() => {
            if (mobileSearch.value === searchTerm) {
              mobileSearch.value = '';
              loadProducts('');
              showToast('Búsqueda limpiada automáticamente', 'info');
            }
          }, 6000);
        }
      });
      
      // Mantener el foco en el buscador si está habilitado
      if (alwaysActiveSearchEnabled) {
        mobileSearch.addEventListener('blur', () => {
          setTimeout(() => {
            if (document.activeElement.tagName !== 'INPUT' && 
                document.activeElement.tagName !== 'TEXTAREA' &&
                !document.querySelector('.modal-mobile[style*="display: flex"]')) {
              mobileSearch.focus();
            }
          }, 100);
        });
      }
    }

    // 4. CONFIGURACIÓN DE STOCK Y VENCIMIENTO
    async function saveConfig() {
      try {
        showLoading('Guardando configuración...');
        
        const configRef = doc(db, "userConfig", currentCollaborator.userId);
        await setDoc(configRef, {
          showRealTimeTotal: toggleRealTimeTotal.checked,
          lowStockNotifications: toggleLowStockNotifications.checked,
          expirationAlerts: toggleExpirationAlerts.checked,
          stockControl: toggleStockControl.checked,
          expirationControl: toggleExpirationControl.checked,
          autoPrint: toggleAutoPrint.checked,
          alwaysActiveSearch: toggleAlwaysActiveSearch.checked,
          autoClearSearch: toggleAutoClearSearch.checked,
          updatedAt: Timestamp.now(),
          updatedBy: currentCollaborator.username
        });
        
        showRealTimeTotal = toggleRealTimeTotal.checked;
        alwaysActiveSearchEnabled = toggleAlwaysActiveSearch.checked;
        autoClearSearchEnabled = toggleAutoClearSearch.checked;
        stockControlEnabled = toggleStockControl.checked;
        expirationControlEnabled = toggleExpirationControl.checked;
        
        if (showRealTimeTotal && invoice.length > 0) {
          realTimeTotalContainer.style.display = 'block';
          updateRealTimeTotal();
        } else {
          realTimeTotalContainer.style.display = 'none';
        }
        
        configModal.style.display = 'none';
        hideLoading();
        showToast('Configuración guardada', 'success');
        
      } catch (error) {
        console.error('Error saving config:', error);
        hideLoading();
        showToast('Error al guardar configuración', 'error');
      }
    }

    // Función para verificar stock y vencimiento al agregar producto
    function checkProductStockAndExpiration(product, businessName, productId) {
      // Verificar control de stock
      if (stockControlEnabled && product.quantity === 0) {
        showToast('Producto agotado', 'error');
        return false;
      }
      
      // Verificar control de vencimiento
      if (expirationControlEnabled && product.expirationDate) {
        const expirationDate = new Date(product.expirationDate);
        const today = new Date();
        const daysDiff = Math.ceil((expirationDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 0) {
          // Producto vencido
          showExpirationAlert(product, businessName, productId, daysDiff, true);
          return false;
        } else if (daysDiff <= 7) {
          // Producto próximo a vencer (7 días o menos)
          showExpirationAlert(product, businessName, productId, daysDiff, false);
          return false;
        }
      }
      
      return true;
    }

    // 5. PERFIL DEL USUARIO CON ICONO DE ZANAHORIA
    async function loadUserProfile() {
      try {
        if (!currentCollaborator) return;
        
        // Cargar información del usuario desde Firebase
        const userRef = doc(db, "Collaborators", currentCollaborator.id);
        const userDoc = await getDoc(userRef);
        
        let userData = currentCollaborator;
        if (userDoc.exists()) {
          userData = { ...currentCollaborator, ...userDoc.data() };
        }
        
        // Actualizar campos del formulario
        profileUsername.value = userData.username || '';
        profileEmail.value = userData.email || '';
        profilePhone.value = userData.phone || '';
        
        // Actualizar avatar
        await updateProfileAvatar(userData);
        
      } catch (error) {
        console.error('Error loading user profile:', error);
        showToast('Error al cargar perfil', 'error');
      }
    }

    async function updateProfileAvatar(userData) {
      profileAvatarContainer.innerHTML = '';
      
      let avatarHtml = '';
      
      if (userData.avatarUrl) {
        // Intentar cargar la imagen
        try {
          const img = new Image();
          img.onload = function() {
            profileAvatarContainer.innerHTML = `
              <img src="${userData.avatarUrl}" class="profile-avatar" alt="${userData.username}">
            `;
          };
          img.onerror = function() {
            // Si falla la carga, mostrar icono de zanahoria
            profileAvatarContainer.innerHTML = `
              <div class="profile-avatar carrot">
                <i class="fas fa-carrot"></i>
              </div>
            `;
          };
          img.src = userData.avatarUrl;
        } catch (error) {
          // Mostrar icono de zanahoria en caso de error
          profileAvatarContainer.innerHTML = `
            <div class="profile-avatar carrot">
              <i class="fas fa-carrot"></i>
            </div>
          `;
        }
      } else {
        // Mostrar icono de zanahoria si no hay foto
        profileAvatarContainer.innerHTML = `
          <div class="profile-avatar carrot">
            <i class="fas fa-carrot"></i>
          </div>
        `;
      }
    }

    async function saveUserProfile() {
      try {
        showLoading('Guardando perfil...');
        
        const email = profileEmail.value.trim();
        const phone = profilePhone.value.trim();
        const password = profilePassword.value.trim();
        const confirmPassword = profileConfirmPassword.value.trim();
        
        // Validar contraseñas si se proporcionan
        if (password) {
          if (password !== confirmPassword) {
            showToast('Las contraseñas no coinciden', 'error');
            hideLoading();
            return;
          }
          
          if (password.length < 6) {
            showToast('La contraseña debe tener al menos 6 caracteres', 'error');
            hideLoading();
            return;
          }
        }
        
        // Actualizar datos en Firebase
        const userRef = doc(db, "Collaborators", currentCollaborator.id);
        const updateData = {
          email: email,
          phone: phone,
          updatedAt: Timestamp.now()
        };
        
        // Actualizar contraseña si se proporcionó
        if (password) {
          updateData.pin = password; // Nota: En un sistema real, esto debería estar encriptado
        }
        
        await updateDoc(userRef, updateData);
        
        // Actualizar datos locales
        currentCollaborator = {
          ...currentCollaborator,
          email: email,
          phone: phone
        };
        
        // Limpiar campos de contraseña
        profilePassword.value = '';
        profileConfirmPassword.value = '';
        
        hideLoading();
        showToast('Perfil actualizado exitosamente', 'success');
        userProfileModal.style.display = 'none';
        
      } catch (error) {
        console.error('Error saving profile:', error);
        hideLoading();
        showToast('Error al guardar perfil', 'error');
      }
    }

    async function uploadAvatar(file) {
      try {
        showLoading('Subiendo foto de perfil...');
        
        // Crear referencia única para la imagen
        const fileName = `avatars/${currentCollaborator.id}_${Date.now()}.jpg`;
        const storageRef = ref(storage, fileName);
        
        // Subir archivo
        await uploadBytes(storageRef, file);
        
        // Obtener URL de descarga
        const downloadURL = await getDownloadURL(storageRef);
        
        // Actualizar en Firebase
        const userRef = doc(db, "Collaborators", currentCollaborator.id);
        await updateDoc(userRef, {
          avatarUrl: downloadURL,
          updatedAt: Timestamp.now()
        });
        
        // Actualizar datos locales
        currentCollaborator.avatarUrl = downloadURL;
        
        // Actualizar avatar en la interfaz
        await updateProfileAvatar(currentCollaborator);
        
        hideLoading();
        showToast('Foto de perfil actualizada', 'success');
        
      } catch (error) {
        console.error('Error uploading avatar:', error);
        hideLoading();
        showToast('Error al subir foto de perfil', 'error');
      }
    }

    // 6. SCANNER OPTIMIZADO - FUNCIONES ACTUALIZADAS
    async function startOptimizedScanner() {
      try {
        if (!scannerInstance) {
          await initializeScanner();
        }
        
        if (!isCameraInitialized) {
          showToast('La cámara no está disponible', 'error');
          return;
        }
        
        // Detener scanner si ya está activo
        if (isScannerActive) {
          await stopOptimizedScanner();
          return;
        }
        
        // Iniciar scanner con la cámara seleccionada
        await scannerInstance.start(
          currentCameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText) => {
            // Éxito al escanear
            onScanSuccessOptimized(decodedText);
          },
          (errorMessage) => {
            // Error al escanear - ignorar errores menores
            console.log('Scanner error:', errorMessage);
          }
        );
        
        isScannerActive = true;
        toggleScannerBtn.innerHTML = '<i class="fas fa-stop"></i>';
        toggleScannerBtn.style.background = 'rgba(231, 76, 60, 0.2)';
        showToast('Scanner activado', 'success');
        
      } catch (error) {
        console.error('Error starting scanner:', error);
        showToast('Error al iniciar scanner', 'error');
      }
    }

    async function switchCameraOptimized() {
      try {
        if (!isScannerActive || !scannerInstance) {
          showToast('Inicie el scanner primero', 'error');
          return;
        }
        
        // Obtener todas las cámaras disponibles
        const devices = await Html5Qrcode.getCameras();
        
        if (devices.length < 2) {
          showToast('Solo hay una cámara disponible', 'info');
          return;
        }
        
        // Encontrar el índice de la cámara actual
        let currentIndex = devices.findIndex(device => device.id === currentCameraId);
        if (currentIndex === -1) currentIndex = 0;
        
        // Seleccionar la siguiente cámara
        const nextIndex = (currentIndex + 1) % devices.length;
        const nextCamera = devices[nextIndex];
        
        // Detener el scanner actual
        await scannerInstance.stop();
        
        // Reiniciar con la nueva cámara
        currentCameraId = nextCamera.id;
        await scannerInstance.start(
          currentCameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText) => {
            onScanSuccessOptimized(decodedText);
          },
          (errorMessage) => {
            console.log('Scanner error:', errorMessage);
          }
        );
        
        showToast(`Cambiado a cámara: ${nextCamera.label || 'Cámara ' + (nextIndex + 1)}`, 'success');
        
      } catch (error) {
        console.error('Error switching camera:', error);
        showToast('Error al cambiar cámara', 'error');
      }
    }

    function onScanSuccessOptimized(decodedText) {
      // Detener scanner inmediatamente
      stopOptimizedScanner();
      
      // Procesar el código escaneado
      mobileSearch.value = decodedText;
      
      // Buscar y agregar automáticamente el producto
      loadProducts(decodedText);
      
      scannerModal.style.display = 'none';
      showToast(`Código escaneado: ${decodedText}`, 'success');
    }

    function onScanErrorOptimized(error) {
      // Ignorar errores menores del scanner
      // Solo mostrar errores importantes
      if (error && error !== 'NotFoundException' && !error.message?.includes('NotAllowedError')) {
        console.error('Scanner error:', error);
      }
    }

    async function stopOptimizedScanner() {
      if (scannerInstance && isScannerActive) {
        try {
          await scannerInstance.stop();
          isScannerActive = false;
          toggleScannerBtn.innerHTML = '<i class="fas fa-play"></i>';
          toggleScannerBtn.style.background = '';
        } catch (error) {
          console.error('Error stopping scanner:', error);
        }
      }
    }

    // 7. COPIAR FACTURA ANTERIOR SIN ELIMINAR FACTURA ACTUAL
    async function loadLastInvoice() {
      try {
        if (!currentCollaborator) return;
        
        const historyQuery = query(
          collection(db, "users", currentCollaborator.userId, "invoiceHistory"),
          orderBy("timestamp", "desc"),
          limit(1)
        );
        
        const snapshot = await getDocs(historyQuery);
        
        if (!snapshot.empty) {
          const lastInvoice = snapshot.docs[0].data();
          window.lastInvoiceData = lastInvoice;
          copyLastInvoiceBtn.style.display = 'flex';
        } else {
          copyLastInvoiceBtn.style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error loading last invoice:', error);
        copyLastInvoiceBtn.style.display = 'none';
      }
    }

    // CARGAR GASTOS DEL DÍA
    async function loadTodayExpenses() {
      try {
        if (!currentCollaborator) return;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const expensesQuery = query(
          collection(db, "users", currentCollaborator.userId, "expenses"),
          where("date", ">=", today.toISOString()),
          where("date", "<", tomorrow.toISOString()),
          orderBy("date", "desc")
        );
        
        const snapshot = await getDocs(expensesQuery);
        expenses = [];
        
        expensesList.innerHTML = '';
        
        if (snapshot.empty) {
          expensesList.innerHTML = `
            <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
              <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>No hay gastos registrados hoy</p>
              <p style="font-size: 12px;">Registra tus gastos diarios aquí</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach((doc) => {
          const expense = {
            id: doc.id,
            ...doc.data()
          };
          expenses.push(expense);
          
          const expenseCard = document.createElement('div');
          expenseCard.className = 'expense-card';
          expenseCard.innerHTML = `
            <div class="expense-header">
              <span class="expense-title">${expense.description}</span>
              <span class="expense-amount">${formatCurrency(expense.amount)}</span>
            </div>
            <div class="expense-details">
              <span>${expense.category}</span>
              <span>${new Date(expense.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
            ${expense.notes ? `<div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">${expense.notes}</div>` : ''}
          `;
          
          expensesList.appendChild(expenseCard);
        });
        
      } catch (error) {
        console.error('Error loading expenses:', error);
        expensesList.innerHTML = `
          <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No hay gastos registrados hoy</p>
            <p style="font-size: 12px;">Registra tus gastos diarios aquí</p>
          </div>
        `;
      }
    }

    // ============================
    // FIN NUEVAS FUNCIONALIDADES
    // ============================

    // Load Tax Configuration
    async function loadTaxConfig() {
      try {
        if (!currentCollaborator) return;
        
        const taxRef = doc(db, "impuesto", currentCollaborator.userId);
        const taxDoc = await getDoc(taxRef);
        
        if (taxDoc.exists()) {
          const taxData = taxDoc.data();
          taxConfig = {
            itbis: taxData.itbis || 18,
            iva: taxData.iva || 0,
            active: taxData.activo || false
          };
          
          // Update tax modal with read-only fields
          if (taxStatusIndicator) {
            taxStatusIndicator.textContent = taxConfig.active ? 'ACTIVO' : 'INACTIVO';
            taxStatusIndicator.className = `tax-status ${taxConfig.active ? 'tax-active' : 'tax-inactive'}`;
          }
          
          if (taxItbisInput) taxItbisInput.value = `${taxConfig.itbis}%`;
          if (taxIvaInput) taxIvaInput.value = `${taxConfig.iva}%`;
        } else {
          // Create default tax config
          await setDoc(taxRef, {
            itbis: 18,
            iva: 0,
            activo: false,
            userId: currentCollaborator.userId,
            createdDate: new Date().toISOString()
          });
        }
      } catch (error) {
        console.error('Error loading tax config:', error);
      }
    }

    // Load Exchange Rates
    async function loadExchangeRates() {
      try {
        if (!currentCollaborator) {
          exchangeRates = { usd: 56.50, eur: 61.20 };
          return;
        }

        const ratesRef = doc(db, "exchangeRates", currentCollaborator.userId);
        const ratesDoc = await getDoc(ratesRef);
        
        if (ratesDoc.exists()) {
          const ratesData = ratesDoc.data();
          exchangeRates = {
            usd: ratesData.usd || 56.50,
            eur: ratesData.eur || 61.20
          };
          currentUsdRate.textContent = `$${exchangeRates.usd}`;
          currentEurRate.textContent = `€${exchangeRates.eur}`;
          ratesUpdateTime.textContent = ratesData.updatedAt ? formatDate(ratesData.updatedAt.toDate()) : '-';
        } else {
          exchangeRates = { usd: 56.50, eur: 61.20 };
          currentUsdRate.textContent = `$${exchangeRates.usd}`;
          currentEurRate.textContent = `€${exchangeRates.eur}`;
          ratesUpdateTime.textContent = '-';
        }
      } catch (error) {
        console.error('Error loading exchange rates:', error);
        exchangeRates = { usd: 56.50, eur: 61.20 };
        currentUsdRate.textContent = `$${exchangeRates.usd}`;
        currentEurRate.textContent = `€${exchangeRates.eur}`;
        ratesUpdateTime.textContent = '-';
      }
    }

    // Setup Real-time Listeners
    function setupRealTimeListeners() {
      // Clear existing listeners
      if (realTimeInvoiceListener) realTimeInvoiceListener();
      if (realTimeTotalListener) realTimeTotalListener();
      
      // Listen for real-time invoice updates
      const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
      realTimeInvoiceListener = onSnapshot(productosRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          if (data.productos && data.productos.length > 0) {
            // Update invoice display from real-time data
            invoice = data.productos.map(item => ({
              name: item.nombre,
              quantity: item.cantidad,
              pricePerUnit: item.precio / item.cantidad,
              productId: item.id,
              businessName: item.businessName || '',
              total: item.precio
            }));
            updateInvoiceDisplay();
          }
        }
      });
      
      // Listen for real-time total updates
      const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
      realTimeTotalListener = onSnapshot(totalRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          if (data.total && data.total > 0) {
            totalPrice = data.total;
            discountedTotal = totalPrice;
            updateInvoiceDisplay();
          }
        }
      });
    }

    // Products Management
    async function loadProducts(searchTerm = '') {
      try {
        showLoading('Cargando productos...');
        
        productsGrid.innerHTML = '';
        
        const businessesRef = collection(db, "businesses");
        const businessesSnapshot = await getDocs(businessesRef);
        
        if (businessesSnapshot.empty) {
          productsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);"><i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i><p>No hay productos disponibles</p><p style="font-size: 12px;">Agregue productos desde el inventario</p></div>';
          hideLoading();
          return;
        }
        
        let allProducts = [];
        
        for (const businessDoc of businessesSnapshot.docs) {
          const productsRef = collection(db, "businesses", businessDoc.id, "products");
          const productsQuery = query(
            productsRef, 
            where("userId", "==", currentCollaborator.userId)
          );
          
          const querySnapshot = await getDocs(productsQuery);
          
          for (const productDoc of querySnapshot.docs) {
            const product = productDoc.data();
            product.id = productDoc.id;
            product.businessName = businessDoc.id;
            product.docRef = productDoc;
            
            allProducts.push(product);
          }
        }
        
        // Aplicar filtros de búsqueda avanzada
        let filteredProducts = allProducts.filter(product => {
          // Filtro de búsqueda por texto
          if (searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            const nameMatch = product.name.toLowerCase().includes(searchLower);
            const eanMatch = product.eanUpcCode?.includes(searchTerm);
            
            if (!nameMatch && !eanMatch) {
              return false;
            }
          }
          
          // Filtro por categoría
          if (currentSearchFilters.category !== 'all') {
            const expirationDate = product.expirationDate ? new Date(product.expirationDate) : null;
            const today = new Date();
            
            if (currentSearchFilters.category === 'low-stock') {
              if (product.quantity > 10) return false;
            } else if (currentSearchFilters.category === 'expiring') {
              if (!expirationDate || expirationDate - today > 30 * 24 * 60 * 60 * 1000) return false;
            } else if (currentSearchFilters.category === 'expired') {
              if (!expirationDate || expirationDate > today) return false;
            }
          }
          
          // Filtro por precio
          if (currentSearchFilters.minPrice !== null && product.pricePerUnit < currentSearchFilters.minPrice) {
            return false;
          }
          
          if (currentSearchFilters.maxPrice !== null && product.pricePerUnit > currentSearchFilters.maxPrice) {
            return false;
          }
          
          return true;
        });
        
        // Ordenar productos
        filteredProducts.sort((a, b) => {
          switch(currentSearchFilters.sort) {
            case 'name':
              return a.name.localeCompare(b.name);
            case 'price':
              return a.pricePerUnit - b.pricePerUnit;
            case 'stock':
              return a.quantity - b.quantity;
            case 'date':
              const dateA = a.createdDate ? new Date(a.createdDate) : new Date(0);
              const dateB = b.createdDate ? new Date(b.createdDate) : new Date(0);
              return dateB - dateA;
            default:
              return 0;
          }
        });
        
        // Mostrar productos filtrados
        filteredProducts.forEach(product => {
          createProductCard(product, product.businessName, product.id, product.docRef);
        });
        
        if (filteredProducts.length === 0) {
          productsGrid.innerHTML = `
            <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
              <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>No se encontraron productos</p>
              ${searchTerm ? `<p style="font-size: 12px; margin-top: 10px;">Buscando: "${searchTerm}"</p>` : ''}
            </div>
          `;
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error loading products:', error);
        hideLoading();
        productsGrid.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No hay productos disponibles</p>
            <p style="font-size: 12px;">Agregue productos desde el inventario</p>
          </div>
        `;
        showToast('Productos cargados correctamente', 'success');
      }
    }

    // Función auxiliar para crear tarjeta de producto
    function createProductCard(product, businessName, productId, productDoc) {
      // Create product card
      const productCard = document.createElement('div');
      productCard.className = 'product-card';
      productCard.dataset.id = productId;
      productCard.dataset.business = businessName;
      
      // Check expiration
      let badgeHtml = '';
      let expirationDays = null;
      if (product.expirationDate) {
        const expirationDate = new Date(product.expirationDate);
        const today = new Date();
        expirationDays = Math.ceil((expirationDate - today) / (1000 * 60 * 60 * 24));
        
        if (expirationDays < 0) {
          badgeHtml = '<span class="product-badge badge-expired">VENCIDO</span>';
        } else if (expirationDays <= 30) {
          badgeHtml = `<span class="product-badge badge-warning">VENCE EN ${expirationDays} DÍAS</span>`;
        }
      }
      
      // Check tax - position in bottom left
      let taxBadge = '';
      if (taxConfig.active && (product.applyItbis || product.applyIva)) {
        taxBadge = '<span class="product-badge badge-tax">IMPUESTOS</span>';
      }
      
      productCard.innerHTML = `
        ${badgeHtml}
        <img src="${product.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image'}" class="product-image" alt="${product.name}">
        <div class="product-name">${product.name}</div>
        <div class="product-price">${formatCurrency(product.pricePerUnit)}</div>
        ${product.eanUpcCode ? `<div class="product-ean-mobile"><i class="fas fa-barcode"></i> ${product.eanUpcCode}</div>` : ''}
        ${taxBadge}
      `;
      
      // Guardar información de vencimiento para uso posterior
      productCard.dataset.expirationDays = expirationDays;
      productCard.dataset.productName = product.name;
      productCard.dataset.productId = productId;
      productCard.dataset.businessName = businessName;
      
      productCard.addEventListener('click', () => {
        handleProductClick(product, businessName, productId, expirationDays);
      });
      productsGrid.appendChild(productCard);
    }

    // Función para manejar el clic en producto con verificación de vencimiento
    async function handleProductClick(product, businessName, productId, expirationDays) {
      // Verificar stock y vencimiento según configuración
      if (!checkProductStockAndExpiration(product, businessName, productId)) {
        return;
      }
      
      // Si no hay problemas de vencimiento, agregar a la factura
      addToInvoice(product, businessName, productId);
    }

    // Función para mostrar alerta de vencimiento elegante
    function showExpirationAlert(product, businessName, productId, daysDiff, isExpired) {
      const overlay = document.createElement('div');
      overlay.className = 'expiration-modal-overlay';
      
      const modal = document.createElement('div');
      modal.className = `expiration-modal ${isExpired ? 'expired' : ''}`;
      
      const title = isExpired ? 'PRODUCTO VENCIDO' : 'PRODUCTO PRÓXIMO A VENCER';
      const icon = isExpired ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
      
      let message = '';
      if (isExpired) {
        message = `El producto "${product.name}" está VENCIDO hace ${Math.abs(daysDiff)} días.`;
      } else {
        message = `El producto "${product.name}" está PRÓXIMO A VENCER. Le faltan ${daysDiff} días para su fecha de vencimiento.`;
      }
      
      modal.innerHTML = `
        <div class="expiration-icon">
          <i class="fas ${icon}"></i>
        </div>
        <h2 class="expiration-title">${title}</h2>
        <div class="expiration-message">${message}</div>
        <div class="expiration-warning">
          <strong>ADVERTENCIA:</strong> Usted asume toda responsabilidad en caso de facturar este producto.
        </div>
        <div class="expiration-buttons">
          <button class="expiration-btn expiration-btn-no">NO, CANCELAR</button>
          ${!isExpired ? '<button class="expiration-btn expiration-btn-yes">SÍ, VENDER</button>' : ''}
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Event listeners para los botones
      const yesBtn = overlay.querySelector('.expiration-btn-yes');
      const noBtn = overlay.querySelector('.expiration-btn-no');
      
      if (yesBtn) {
        yesBtn.addEventListener('click', () => {
          document.body.removeChild(overlay);
          addToInvoice(product, businessName, productId);
        });
      }
      
      noBtn.addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
    }

    // Invoice Management
    function addToInvoice(product, businessName, productId) {
      // Check stock
      if (product.quantity === 0) {
        showToast('Producto agotado', 'error');
        return;
      }
      
      // Add to invoice
      const existingItem = invoice.find(item => item.productId === productId);
      
      if (existingItem) {
        if (existingItem.quantity >= product.quantity) {
          showToast('Stock insuficiente', 'error');
          return;
        }
        existingItem.quantity += 1;
      } else {
        invoice.push({
          ...product,
          businessName,
          productId,
          quantity: 1
        });
      }
      
      updateInvoiceDisplay();
      showToast('Producto agregado', 'success');
      
      // Update real-time data in Firebase
      updateRealTimeData();
    }

    function removeFromInvoice(productId) {
      const index = invoice.findIndex(item => item.productId === productId);
      
      if (index !== -1) {
        invoice[index].quantity -= 1;
        
        if (invoice[index].quantity === 0) {
          invoice.splice(index, 1);
        }
      }
      
      updateInvoiceDisplay();
      updateRealTimeData();
    }

    function updateRealTimeData() {
      if (!currentCollaborator) return;
      
      try {
        // Update total
        const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
        setDoc(totalRef, {
          total: discountedTotal > 0 ? discountedTotal : totalPrice
        }, { merge: true });
        
        // Update products
        const productos = invoice.map(item => {
          let priceWithTaxes = item.pricePerUnit;
          if (taxConfig.active) {
            if (item.applyItbis) {
              priceWithTaxes += priceWithTaxes * (taxConfig.itbis / 100);
            }
            if (item.applyIva) {
              priceWithTaxes += priceWithTaxes * (taxConfig.iva / 100);
            }
          }
          
          return {
            id: item.productId,
            nombre: item.name,
            cantidad: item.quantity,
            precio: priceWithTaxes * item.quantity,
            businessName: item.businessName
          };
        });
        
        const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
        setDoc(productosRef, {
          productos: productos
        }, { merge: true });
      } catch (error) {
        console.error('Error updating real-time data:', error);
      }
    }

    function updateInvoiceDisplay() {
      // Update invoice items
      invoiceItemsMobile.innerHTML = '';
      totalPrice = 0;
      
      invoice.forEach(item => {
        // Apply taxes if configured
        let itemPrice = item.pricePerUnit;
        if (taxConfig.active) {
          if (item.applyItbis) {
            itemPrice += itemPrice * (taxConfig.itbis / 100);
          }
          if (item.applyIva) {
            itemPrice += itemPrice * (taxConfig.iva / 100);
          }
        }
        
        const totalItemPrice = itemPrice * item.quantity;
        totalPrice += totalItemPrice;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'invoice-item';
        itemDiv.innerHTML = `
          <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div class="item-details">
              <span>${item.quantity} x ${formatCurrency(itemPrice)}</span>
              ${taxConfig.active && (item.applyItbis || item.applyIva) ? '<span><i class="fas fa-percent"></i> Impuestos</span>' : ''}
            </div>
          </div>
          <div class="item-price">${formatCurrency(totalItemPrice)}</div>
          <button class="remove-btn-mobile" onclick="removeFromInvoice('${item.productId}')">
            <i class="fas fa-trash"></i>
          </button>
        `;
        invoiceItemsMobile.appendChild(itemDiv);
      });
      
      if (invoice.length === 0) {
        invoiceItemsMobile.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);"><i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 15px;"></i><p>No hay productos en la factura</p></div>';
      }
      
      // Update totals
      discountedTotal = discount > 0 ? totalPrice - (totalPrice * discount / 100) : totalPrice;
      
      totalAmountMobile.textContent = formatCurrency(discountedTotal);
      cashTotalAmount.textContent = formatCurrency(discountedTotal);
      cardTotalAmount.textContent = formatCurrency(discountedTotal);
      
      // Update currency totals
      updateCurrencyTotals();
      
      // Update badge
      invoiceBadge.textContent = invoice.length;
      
      // Update invoice button state
      invoiceBtnMobile.disabled = invoice.length === 0;
      cashBtnMobile.disabled = invoice.length === 0;
      cardBtnMobile.disabled = invoice.length === 0;
      
      // Update real time total in products section
      updateRealTimeTotal();
      
      // Configurar métodos de pago múltiples si hay productos
      if (invoice.length > 0) {
        setupMultiplePayments();
      } else {
        multiplePaymentsContainer.style.display = 'none';
      }
    }

    function updateCurrencyTotals() {
      usdTotalMobile.innerHTML = `<i class="fas fa-dollar-sign"></i> ${formatCurrency(discountedTotal / exchangeRates.usd)}`;
      eurTotalMobile.innerHTML = `<i class="fas fa-euro-sign"></i> ${formatCurrency(discountedTotal / exchangeRates.eur)}`;
    }

    function updateRealTimeTotal() {
      if (showRealTimeTotal) {
        realTimeTotalAmount.textContent = formatCurrency(discountedTotal);
        realTimeTotalContainer.style.display = 'block';
      } else {
        realTimeTotalContainer.style.display = 'none';
      }
    }

    function setupMultiplePayments() {
      // Esta función se puede expandir en el futuro
      multiplePaymentsContainer.style.display = 'block';
    }

    // Payment Processing
    function setupCashPayment() {
      // Clear input
      cashReceivedInput.value = '';
      
      // Calculate change
      function calculateChange() {
        const received = parseFloat(cashReceivedInput.value) || 0;
        const change = received - discountedTotal;
        
        amountReceived = received;
        
        cashReceivedDisplay.textContent = formatCurrency(received);
        cashChangeAmount.textContent = formatCurrency(change);
        
        // Style based on amount
        if (change < 0) {
          cashChangeAmount.style.color = '#e74c3c';
        } else {
          cashChangeAmount.style.color = '#16e086';
        }
      }
      
      // Numeric pad con control de clics repetidos
      document.querySelectorAll('#cashModal .num-btn[data-value]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const now = Date.now();
          if (now - lastNumpadClickTime < numpadClickDelay) {
            return; // Ignorar clic si es demasiado rápido
          }
          lastNumpadClickTime = now;
          
          const value = btn.getAttribute('data-value');
          cashReceivedInput.value = cashReceivedInput.value + value;
          calculateChange();
        });
      });
      
      // Clear button
      cashClearBtn.addEventListener('click', () => {
        cashReceivedInput.value = '';
        calculateChange();
      });
      
      // Confirm button
      cashConfirmBtn.addEventListener('click', async () => {
        const received = parseFloat(cashReceivedInput.value) || 0;
        
        if (received < discountedTotal) {
          showToast('Monto insuficiente', 'error');
          return;
        }
        
        await processPayment('Efectivo', received);
      });
      
      // Input listener
      cashReceivedInput.addEventListener('input', calculateChange);
    }

    async function processPayment(paymentType, amountReceived = 0) {
      try {
        showLoading('Procesando pago...');
        
        // Generate invoice ID con formato RTM-######
        const invoiceId = generateInvoiceId();
        
        // Calculate taxes
        let totalITBIS = 0;
        let totalIVA = 0;
        
        if (taxConfig.active) {
          invoice.forEach(item => {
            const basePrice = item.pricePerUnit;
            if (item.applyItbis) {
              totalITBIS += basePrice * (taxConfig.itbis / 100) * item.quantity;
            }
            if (item.applyIva) {
              totalIVA += basePrice * (taxConfig.iva / 100) * item.quantity;
            }
          });
        }
        
        // Save to Firebase
        const invoiceData = {
          invoiceId,
          collaboratorId: currentCollaborator.id,
          collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
          userId: currentCollaborator.userId,
          username: currentCollaborator.username,
          items: invoice.map(item => ({
            name: item.name,
            quantity: item.quantity,
            price: item.pricePerUnit,
            total: item.pricePerUnit * item.quantity,
            applyItbis: item.applyItbis || false,
            applyIva: item.applyIva || false
          })),
          subtotal: totalPrice,
          discount: discount,
          discountAmount: totalPrice * (discount / 100),
          itbis: totalITBIS,
          iva: totalIVA,
          total: discountedTotal,
          paymentType,
          amountReceived,
          change: amountReceived - discountedTotal,
          timestamp: Timestamp.now(),
          date: new Date().toISOString(),
          businessName: businessDetails.name,
          businessRNC: businessDetails.rnc,
          businessAddress: businessDetails.address,
          businessPhone: businessDetails.phone,
          businessEmail: businessDetails.email,
          businessNCF: businessDetails.ncf
        };
        
        // Save to facturacionCarrito collection
        await addDoc(collection(db, "facturacionCarrito"), invoiceData);
        
        // Save to collaborator's history
        const historyRef = collection(db, "users", currentCollaborator.userId, "invoiceHistory");
        await addDoc(historyRef, invoiceData);
        
        // Save to FacturaDeCuadres collection
        await addDoc(collection(db, "FacturaDeCuadres"), invoiceData);
        
        // Update stock
        for (const item of invoice) {
          const productRef = doc(db, "businesses", item.businessName, "products", item.productId);
          const productDoc = await getDoc(productRef);
          
          if (productDoc.exists()) {
            const currentStock = productDoc.data().quantity;
            await updateDoc(productRef, {
              quantity: currentStock - item.quantity
            });
          }
        }
        
        // Generate invoice HTML
        await generateInvoiceHTML(invoiceData);
        
        // Clear invoice
        invoice = [];
        discount = 0;
        updateInvoiceDisplay();
        
        // Clear real-time data
        await clearRealTimeData();
        
        // Close modals
        cashModal.style.display = 'none';
        cardModal.style.display = 'none';
        
        // Show print modal
        printModal.style.display = 'flex';
        
        hideLoading();
        showToast('Pago procesado exitosamente', 'success');
        
      } catch (error) {
        console.error('Payment processing error:', error);
        hideLoading();
        showToast('Error al procesar el pago', 'error');
      }
    }

    async function clearRealTimeData() {
      try {
        const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
        await setDoc(totalRef, {
          total: 0
        }, { merge: true });
        
        const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
        await setDoc(productosRef, {
          productos: []
        }, { merge: true });
      } catch (error) {
        console.error('Error clearing real-time data:', error);
      }
    }

    async function generateInvoiceHTML(invoiceData) {
      try {
        // Load logo from Firebase Storage
        let logoUrl = '';
        if (businessDetails.logoUrl && businessDetails.logoUrl !== 'logo.png') {
          try {
            const logoRef = ref(storage, businessDetails.logoUrl);
            logoUrl = await getDownloadURL(logoRef);
          } catch (error) {
            console.error('Error loading logo:', error);
            logoUrl = 'logo.png';
          }
        } else {
          logoUrl = 'logo.png';
        }
        
        // Generate QR code for business info
        let qrCodeHtml = '';
        if (businessDetails.qrUrl) {
          try {
            const qrRef = ref(storage, businessDetails.qrUrl);
            const qrUrl = await getDownloadURL(qrRef);
            qrCodeHtml = `
              <div style="text-align: center; margin: 15px 0;">
                <img src="${qrUrl}" alt="Código QR" style="width: 100px; height: 100px;">
              </div>
            `;
          } catch (error) {
            console.error('Error loading QR code:', error);
          }
        }
        
        const itemsHtml = invoiceData.items.map(item => `
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; border-bottom: 1px dashed #eee; padding-bottom: 3px;">
            <div style="flex: 3;">
              ${item.name} x${item.quantity}
              ${item.applyItbis || item.applyIva ? `<br><small style="color: #666;">${item.applyItbis ? 'ITBIS ' : ''}${item.applyIva ? 'IVA' : ''}</small>` : ''}
            </div>
            <div style="flex: 1; text-align: right;">
              ${formatCurrency(item.total)}
            </div>
          </div>
        `).join('');
        
        // Formato mejorado para WhatsApp sin espacios innecesarios
        let summaryHtml = '';
        summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
          <span>Subtotal:</span>
          <span>${formatCurrency(invoiceData.subtotal)}</span>
        </div>`;
        
        if (invoiceData.discount > 0) {
          summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
            <span>Descuento (${invoiceData.discount}%):</span>
            <span>-${formatCurrency(invoiceData.discountAmount)}</span>
          </div>`;
        }
        
        if (invoiceData.itbis > 0) {
          summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
            <span>ITBIS (${taxConfig.itbis}%):</span>
            <span>${formatCurrency(invoiceData.itbis)}</span>
          </div>`;
        }
        
        if (invoiceData.iva > 0) {
          summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
            <span>IVA (${taxConfig.iva}%):</span>
            <span>${formatCurrency(invoiceData.iva)}</span>
          </div>`;
        }
        
        summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-weight: bold; font-size: 14px;">
          <span>Total:</span>
          <span>${formatCurrency(invoiceData.total)}</span>
        </div>`;
        
        const invoiceHtml = `
          <div style="padding: 15px; max-width: 300px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 15px;">
              ${logoUrl ? `<img src="${logoUrl}" alt="Logo" style="max-height: 60px; margin-bottom: 10px;">` : ''}
              <h3 style="margin: 0 0 5px 0; color: #16e086;">${businessDetails.name}</h3>
              <p style="margin: 0; font-size: 11px; color: #666;">RNC: ${businessDetails.rnc}</p>
              <p style="margin: 0; font-size: 11px; color: #666;">${businessDetails.address}</p>
              <p style="margin: 0; font-size: 11px; color: #666;">Tel: ${businessDetails.phone}</p>
              <p style="margin: 0; font-size: 11px; color: #666;">NCF: ${businessDetails.ncf}</p>
              <p style="margin: 5px 0; font-size: 11px; color: #666;">Factura: ${invoiceData.invoiceId}</p>
              <p style="margin: 0; font-size: 11px; color: #666;">${formatDate(invoiceData.date)}</p>
            </div>
            
            <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
              <p style="margin: 0 0 5px 0; font-size: 11px;"><strong>Atendido por:</strong> ${invoiceData.collaboratorName}</p>
              <p style="margin: 0; font-size: 11px;"><strong>Usuario:</strong> ${invoiceData.username}</p>
            </div>
            
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 2px solid #16e086;">
                <span style="flex: 3;">Producto</span>
                <span style="flex: 1; text-align: right;">Total</span>
              </div>
              ${itemsHtml}
            </div>
            
            <div style="font-size: 12px; border-top: 2px solid #16e086; padding-top: 10px;">
              ${summaryHtml}
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>Método de pago:</span>
                <span>${invoiceData.paymentType}</span>
              </div>
              ${invoiceData.paymentType === 'Efectivo' ? `
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>Recibido:</span>
                <span>${formatCurrency(invoiceData.amountReceived)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>Cambio:</span>
                <span>${formatCurrency(invoiceData.change)}</span>
              </div>
              ` : ''}
            </div>
            
            ${qrCodeHtml}
            
            <div style="text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ccc;">
              <p style="margin: 0; font-size: 10px; color: #666;">¡Gracias por su compra!</p>
              <div style="margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 5px; font-size: 9px; color: #666; text-align: left;">
                <p style="margin: 0 0 3px 0;"><strong>POLÍTICAS:</strong></p>
                <p style="margin: 0;">• No se aceptan devoluciones después de 7 días.</p>
                <p style="margin: 0;">• Productos perecederos no tienen cambio.</p>
                <p style="margin: 0;">• Para garantías presentar factura original.</p>
                <p style="margin: 0;">• Horario: Lunes a Sábado 8:00 AM - 6:00 PM.</p>
              </div>
            </div>
          </div>
        `;
        
        invoicePrintContent.innerHTML = invoiceHtml;
        
        // Preparar mensaje para WhatsApp
        let whatsappMessage = `*FACTURA ${invoiceData.invoiceId}*\n\n`;
        whatsappMessage += `*${businessDetails.name}*\n`;
        whatsappMessage += `RNC: ${businessDetails.rnc}\n`;
        whatsappMessage += `Fecha: ${formatDate(invoiceData.date)}\n`;
        whatsappMessage += `Atendido por: ${invoiceData.collaboratorName}\n\n`;
        whatsappMessage += `*DETALLES DE LA COMPRA:*\n`;
        
        invoiceData.items.forEach(item => {
          whatsappMessage += `• ${item.name} x${item.quantity} - ${formatCurrency(item.total)}\n`;
        });
        
        whatsappMessage += `\n*RESUMEN:*\n`;
        whatsappMessage += `Subtotal: ${formatCurrency(invoiceData.subtotal)}\n`;
        
        if (invoiceData.discount > 0) {
          whatsappMessage += `Descuento: -${formatCurrency(invoiceData.discountAmount)}\n`;
        }
        
        if (invoiceData.itbis > 0) {
          whatsappMessage += `ITBIS: ${formatCurrency(invoiceData.itbis)}\n`;
        }
        
        if (invoiceData.iva > 0) {
          whatsappMessage += `IVA: ${formatCurrency(invoiceData.iva)}\n`;
        }
        
        whatsappMessage += `*TOTAL: ${formatCurrency(invoiceData.total)}*\n`;
        whatsappMessage += `Método de pago: ${invoiceData.paymentType}\n\n`;
        whatsappMessage += `¡Gracias por su compra! 🛒`;
        
        // Guardar mensaje para WhatsApp
        window.currentWhatsAppMessage = whatsappMessage;
        
      } catch (error) {
        console.error('Error generating invoice HTML:', error);
        // Fallback to basic invoice
        const basicHtml = `
          <div style="padding: 20px;">
            <h3 style="color: #e74c3c;">Error al cargar información completa</h3>
            <p>Factura ID: ${invoiceData.invoiceId}</p>
            <p>Total: ${formatCurrency(invoiceData.total)}</p>
          </div>
        `;
        invoicePrintContent.innerHTML = basicHtml;
      }
    }

    // Shift Management
    async function checkCurrentShift() {
      try {
        const shiftsQuery = query(
          collection(db, "Shifts"),
          where("collaboratorId", "==", currentCollaborator.id),
          where("active", "==", true)
        );
        
        const snapshot = await getDocs(shiftsQuery);
        
        if (!snapshot.empty) {
          const shiftDoc = snapshot.docs[0];
          currentShift = {
            id: shiftDoc.id,
            ...shiftDoc.data()
          };
          
          updateShiftDisplay();
          startShiftTimer();
        } else {
          // No active shift - block the session
          blockSession('No tienes un turno activo asignado.');
        }
        
      } catch (error) {
        console.error('Error checking shift:', error);
        blockSession('Error al verificar el turno. Contacte al administrador.');
      }
    }

    function updateShiftDisplay() {
      if (currentShift) {
        shiftUserName.textContent = `${currentCollaborator.firstName} ${currentCollaborator.lastName}`;
        shiftName.textContent = currentShift.shiftName || 'Turno Activo';
        
        const startTime = currentShift.startTime?.toDate();
        const endTime = currentShift.endTime?.toDate();
        
        if (startTime) {
          shiftStartTime.textContent = startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        if (endTime) {
          shiftEndTime.textContent = endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
      }
    }

    function startShiftTimer() {
      if (!currentShift || !currentShift.endTime) return;
      
      const endTime = currentShift.endTime.toDate();
      
      // Clear existing timers
      if (shiftTimer) clearInterval(shiftTimer);
      if (shiftEndTimer) clearTimeout(shiftEndTimer);
      
      // Update countdown every second
      shiftTimer = setInterval(() => {
        const now = new Date();
        const remaining = endTime - now;
        
        if (remaining <= 0) {
          clearInterval(shiftTimer);
          shiftTimeRemaining.textContent = 'FINALIZADO';
          shiftTimeRemaining.style.color = '#e74c3c';
          endShiftAutomatically();
        } else {
          const hours = Math.floor(remaining / (1000 * 60 * 60));
          const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
          
          shiftTimeRemaining.textContent = `${hours}h ${minutes}m ${seconds}s`;
          shiftTimeRemaining.style.color = hours === 0 && minutes < 30 ? '#f39c12' : '#16e086';
        }
      }, 1000);
      
      // Set timeout for automatic shift end
      const remainingMs = endTime - new Date();
      if (remainingMs > 0) {
        shiftEndTimer = setTimeout(() => {
          endShiftAutomatically();
        }, remainingMs);
      }
    }

    async function endShiftAutomatically() {
      try {
        showLoading('Finalizando turno...');
        
        if (currentShift) {
          await updateDoc(doc(db, "Shifts", currentShift.id), {
            active: false,
            endTime: Timestamp.now()
          });
          
          // Save to history
          await addDoc(collection(db, "ShiftHistory"), {
            collaboratorId: currentCollaborator.id,
            collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
            shiftName: currentShift.shiftName,
            startTime: currentShift.startTime,
            endTime: Timestamp.now(),
            duration: Math.floor((Date.now() - currentShift.startTime.toDate().getTime()) / (1000 * 60 * 60)),
            automatic: true,
            timestamp: Timestamp.now()
          });
          
          currentShift = null;
          shiftModal.style.display = 'none';
          
          // Block the session
          blockSession('Tu turno ha terminado automáticamente.');
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error ending shift:', error);
        hideLoading();
        blockSession('Error al finalizar el turno automáticamente.');
      }
    }

    async function endShift() {
      try {
        showLoading('Finalizando turno...');
        
        if (currentShift) {
          await updateDoc(doc(db, "Shifts", currentShift.id), {
            active: false,
            endTime: Timestamp.now()
          });
          
          // Save to history
          await addDoc(collection(db, "ShiftHistory"), {
            collaboratorId: currentCollaborator.id,
            collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
            shiftName: currentShift.shiftName,
            startTime: currentShift.startTime,
            endTime: Timestamp.now(),
            duration: Math.floor((Date.now() - currentShift.startTime.toDate().getTime()) / (1000 * 60 * 60)),
            automatic: false,
            timestamp: Timestamp.now()
          });
          
          currentShift = null;
          shiftModal.style.display = 'none';
          
          // Block the session
          blockSession('Turno finalizado manualmente.');
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error ending shift:', error);
        hideLoading();
        showToast('Error al finalizar turno', 'error');
      }
    }

    function blockSession(message) {
      shiftEndMessage.textContent = message;
      shiftEndModal.style.display = 'flex';
      posScreen.style.display = 'none';
      
      // Clear timers
      if (shiftTimer) clearInterval(shiftTimer);
      if (shiftEndTimer) clearTimeout(shiftEndTimer);
    }

    // Discount Functions
    async function applyDiscountWithPassword() {
      try {
        const password = discountPasswordInput.value.trim();
        
        if (!password) {
          showToast('Ingrese la contraseña', 'error');
          return;
        }
        
        // Verify password from Firebase
        if (discountSettings && discountSettings.password === password) {
          discountModal.style.display = 'none';
          discountPasswordInput.value = '';
          
          // Show discount percentage modal
          discountInput.value = discountSettings.percentage || 10;
          discountPercentageModal.style.display = 'flex';
        } else {
          showToast('Contraseña incorrecta', 'error');
        }
        
      } catch (error) {
        console.error('Discount error:', error);
        showToast('Error al verificar descuento', 'error');
      }
    }

    function applyDiscountPercentage() {
      const discountValue = parseInt(discountInput.value);
      
      if (isNaN(discountValue) || discountValue < 0 || discountValue > 100) {
        showToast('Descuento inválido', 'error');
        return;
      }
      
      discount = discountValue;
      updateInvoiceDisplay();
      discountPercentageModal.style.display = 'none';
      showToast(`Descuento del ${discount}% aplicado`, 'success');
    }

    // User Info Functions
    async function loadUserInfo() {
      try {
        showLoading('Cargando información...');
        
        if (!currentCollaborator) {
          userInfoContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
              <p>No se encontró información del usuario</p>
            </div>
          `;
          hideLoading();
          return;
        }
        
        // Cargar información del usuario desde Firebase
        const userRef = doc(db, "Collaborators", currentCollaborator.id);
        const userDoc = await getDoc(userRef);
        
        let userData = currentCollaborator;
        if (userDoc.exists()) {
          userData = { ...currentCollaborator, ...userDoc.data() };
        }
        
        // Formatear fecha de creación si existe
        let creationDate = 'No disponible';
        if (userData.createdDate) {
          creationDate = formatDate(userData.createdDate);
        }
        
        // Determinar el rol
        let role = 'Colaborador';
        if (userData.role) {
          role = userData.role;
        } else if (userData.isAdmin) {
          role = 'Administrador';
        }
        
        // Crear HTML para la información del usuario
        const userInfoHtml = `
          <div class="user-info-header">
            <img src="${userData.avatarUrl || 'https://via.placeholder.com/80x80?text=Usuario'}" 
                 class="user-avatar-large" 
                 alt="${userData.firstName} ${userData.lastName}">
            <div class="user-info-details">
              <h2 class="user-info-name">${userData.firstName} ${userData.lastName}</h2>
              <span class="user-info-role">${role}</span>
            </div>
          </div>
          
          <div class="user-info-grid">
            <div class="user-info-item">
              <div class="user-info-label">Usuario</div>
              <div class="user-info-value">${userData.username}</div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">ID de Usuario</div>
              <div class="user-info-value">${userData.userId || currentCollaborator.userId}</div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">Email</div>
              <div class="user-info-value">${userData.email || 'No disponible'}</div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">Teléfono</div>
              <div class="user-info-value">${userData.phone || 'No disponible'}</div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">Estado</div>
              <div class="user-info-value">
                <span style="color: #16e086; font-weight: bold;">
                  <i class="fas fa-circle" style="font-size: 10px;"></i> Activo
                </span>
              </div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">Fecha de Creación</div>
              <div class="user-info-value">${creationDate}</div>
            </div>
          </div>
          
          <div style="background: rgba(22, 224, 134, 0.1); border-radius: 10px; padding: 15px; margin-top: 15px;">
            <h3 style="color: #16e086; font-size: 16px; margin-bottom: 10px;">
              <i class="fas fa-info-circle"></i> Información del Sistema
            </h3>
            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">
              <p style="margin-bottom: 5px;">• ID de Colaborador: ${userData.id}</p>
              <p style="margin-bottom: 5px;">• Usuario desde: ${creationDate}</p>
              <p>• Turno actual: ${currentShift ? 'Activo' : 'No activo'}</p>
            </div>
          </div>
        `;
        
        userInfoContent.innerHTML = userInfoHtml;
        hideLoading();
        
      } catch (error) {
        console.error('Error loading user info:', error);
        hideLoading();
        
        // Mostrar información básica si falla la carga
        userInfoContent.innerHTML = `
          <div class="user-info-header">
            <img src="https://via.placeholder.com/80x80?text=Usuario" 
                 class="user-avatar-large" 
                 alt="Usuario">
            <div class="user-info-details">
              <h2 class="user-info-name">${currentCollaborator.firstName} ${currentCollaborator.lastName}</h2>
              <span class="user-info-role">Colaborador</span>
            </div>
          </div>
          
          <div style="text-align: center; padding: 20px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; margin-top: 20px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #e74c3c; margin-bottom: 10px;"></i>
            <p>Error al cargar información completa del usuario</p>
            <p style="font-size: 12px; margin-top: 10px;">Información básica disponible:</p>
            <p style="margin-top: 10px;"><strong>Usuario:</strong> ${currentCollaborator.username}</p>
            <p><strong>ID:</strong> ${currentCollaborator.id}</p>
          </div>
        `;
      }
    }

    // History Functions
    async function loadHistory() {
      try {
        showLoading('Cargando historial...');
        
        historyContainer.innerHTML = '';
        
        const historyQuery = query(
          collection(db, "users", currentCollaborator.userId, "invoiceHistory"),
          orderBy("timestamp", "desc"),
          limit(50)
        );
        
        const snapshot = await getDocs(historyQuery);
        
        if (snapshot.empty) {
          historyContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);"><i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px;"></i><p>No hay historial de facturas</p></div>';
          hideLoading();
          return;
        }
        
        snapshot.forEach((doc) => {
          try {
            const invoiceData = doc.data();
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            historyItem.innerHTML = `
              <div class="history-header">
                <span class="history-id">${invoiceData.invoiceId}</span>
                <span class="history-date">${formatDate(invoiceData.timestamp?.toDate())}</span>
              </div>
              <div class="history-details">
                <div class="history-detail">
                  <span class="history-label">Total</span>
                  <span class="history-value">${formatCurrency(invoiceData.total)}</span>
                </div>
                <div class="history-detail">
                  <span class="history-label">Método</span>
                  <span class="history-value">${invoiceData.paymentType}</span>
                </div>
                <div class="history-detail">
                  <span class="history-label">Items</span>
                  <span class="history-value">${invoiceData.items?.length || 0}</span>
                </div>
              </div>
              <div class="history-actions">
                <button class="history-action-btn history-action-view" onclick="viewInvoice('${doc.id}')">
                  <i class="fas fa-eye"></i> Ver
                </button>
                <button class="history-action-btn history-action-whatsapp" onclick="sendInvoiceToWhatsApp('${doc.id}')">
                  <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
              </div>
            `;
            
            historyContainer.appendChild(historyItem);
          } catch (error) {
            console.error('Error procesando item de historial:', error);
          }
        });
        
        hideLoading();
        
      } catch (error) {
        console.error('Error loading history:', error);
        hideLoading();
        showToast('Error al cargar historial', 'error');
        
        // Mostrar mensaje genérico en caso de error
        historyContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>Error al cargar el historial</p>
            <p style="font-size: 12px; margin-top: 10px;">Por favor, intente nuevamente</p>
          </div>
        `;
      }
    }

    async function viewInvoice(invoiceId) {
      try {
        showLoading('Cargando factura...');
        
        const invoiceDoc = await getDoc(doc(db, "users", currentCollaborator.userId, "invoiceHistory", invoiceId));
        
        if (invoiceDoc.exists()) {
          const invoiceData = invoiceDoc.data();
          await generateInvoiceHTML(invoiceData);
          printModal.style.display = 'flex';
          historyModal.style.display = 'none';
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error viewing invoice:', error);
        hideLoading();
        showToast('Error al cargar factura', 'error');
      }
    }

    async function sendInvoiceToWhatsApp(invoiceId) {
      try {
        showLoading('Preparando factura...');
        
        const invoiceDoc = await getDoc(doc(db, "users", currentCollaborator.userId, "invoiceHistory", invoiceId));
        
        if (invoiceDoc.exists()) {
          const invoiceData = invoiceDoc.data();
          
          // Formato mejorado para WhatsApp sin espacios innecesarios
          let message = `*FACTURA ${invoiceData.invoiceId}*\n\n`;
          message += `*${businessDetails.name}*\n`;
          message += `RNC: ${businessDetails.rnc}\n`;
          message += `Fecha: ${formatDate(invoiceData.date)}\n`;
          message += `Atendido por: ${invoiceData.collaboratorName}\n\n`;
          message += `*DETALLES DE LA COMPRA:*\n`;
          
          invoiceData.items.forEach(item => {
            message += `• ${item.name} x${item.quantity} - ${formatCurrency(item.total)}\n`;
          });
          
          message += `\n*RESUMEN:*\n`;
          message += `Subtotal: ${formatCurrency(invoiceData.subtotal)}\n`;
          
          if (invoiceData.discount > 0) {
            message += `Descuento: -${formatCurrency(invoiceData.discountAmount)}\n`;
          }
          
          if (invoiceData.itbis > 0) {
            message += `ITBIS: ${formatCurrency(invoiceData.itbis)}\n`;
          }
          
          if (invoiceData.iva > 0) {
            message += `IVA: ${formatCurrency(invoiceData.iva)}\n`;
          }
          
          message += `*TOTAL: ${formatCurrency(invoiceData.total)}*\n`;
          message += `Método de pago: ${invoiceData.paymentType}\n\n`;
          message += `¡Gracias por su compra! 🛒`;
          
          // Store message for sending
          window.currentWhatsAppMessage = message;
          window.currentInvoiceId = invoiceData.invoiceId;
          
          // Show send modal
          whatsappNumber.value = '';
          sendInvoiceModal.style.display = 'flex';
          historyModal.style.display = 'none';
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error preparing WhatsApp message:', error);
        hideLoading();
        showToast('Error al preparar factura', 'error');
      }
    }

    function sendWhatsAppMessage() {
      const phoneNumber = whatsappNumber.value.trim();
      
      if (!phoneNumber) {
        showToast('Ingrese un número de teléfono', 'error');
        return;
      }
      
      // Validar que sea un número válido (solo números, sin código de país)
      if (!/^\d{10,}$/.test(phoneNumber)) {
        showToast('Ingrese un número válido (10 dígitos mínimo, sin código de país)', 'error');
        return;
      }
      
      // Asumir que es República Dominicana (+1)
      const phoneNumberWithCountryCode = `+1${phoneNumber}`;
      
      const message = window.currentWhatsAppMessage;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${phoneNumberWithCountryCode}?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
      sendInvoiceModal.style.display = 'none';
      showToast('Factura preparada para WhatsApp', 'success');
    }

    function copyInvoiceToClipboard() {
      const message = window.currentWhatsAppMessage;
      
      navigator.clipboard.writeText(message).then(() => {
        showToast('Factura copiada al portapapeles', 'success');
        sendInvoiceModal.style.display = 'none';
      }).catch(err => {
        showToast('Error al copiar al portapapeles', 'error');
      });
    }

    // Reports Functions
    async function loadReports() {
      try {
        showLoading('Generando reportes...');
        
        // Get today's date range
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Get today's sales
        const salesQuery = query(
          collection(db, "users", currentCollaborator.userId, "invoiceHistory"),
          where("timestamp", ">=", Timestamp.fromDate(today)),
          where("timestamp", "<", Timestamp.fromDate(tomorrow))
        );
        
        const snapshot = await getDocs(salesQuery);
        
        let totalSales = 0;
        let transactionCount = 0;
        let paymentMethods = { Efectivo: 0, Tarjeta: 0 };
        let productSales = {};
        
        snapshot.forEach((doc) => {
          const sale = doc.data();
          totalSales += sale.total;
          transactionCount++;
          
          // Count payment methods
          if (paymentMethods[sale.paymentType] !== undefined) {
            paymentMethods[sale.paymentType] += sale.total;
          }
          
          // Count product sales
          if (sale.items) {
            sale.items.forEach(item => {
              if (productSales[item.name]) {
                productSales[item.name] += item.quantity;
              } else {
                productSales[item.name] = item.quantity;
              }
            });
          }
        });
        
        // Update stats
        todaySales.textContent = formatCurrency(totalSales);
        todayTransactions.textContent = transactionCount;
        avgTicket.textContent = transactionCount > 0 ? formatCurrency(totalSales / transactionCount) : '$0.00';
        
        // Find top product
        let topProductName = '-';
        let maxQuantity = 0;
        for (const [product, quantity] of Object.entries(productSales)) {
          if (quantity > maxQuantity) {
            maxQuantity = quantity;
            topProductName = product;
          }
        }
        topProduct.textContent = topProductName;
        
        // Create charts
        createSalesChart(totalSales, transactionCount);
        createPaymentMethodsChart(paymentMethods);
        
        hideLoading();
        
      } catch (error) {
        console.error('Error loading reports:', error);
        hideLoading();
        showToast('Error al cargar reportes', 'error');
      }
    }

    function createSalesChart(totalSales, transactionCount) {
      const ctx = salesChart.getContext('2d');
      
      // Destroy existing chart
      if (window.salesChartInstance) {
        window.salesChartInstance.destroy();
      }
      
      window.salesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Ventas Hoy'],
          datasets: [{
            label: 'Monto Total',
            data: [totalSales],
            backgroundColor: 'rgba(22, 224, 134, 0.5)',
            borderColor: '#16e086',
            borderWidth: 1
          }, {
            label: 'Transacciones',
            data: [transactionCount * 100], // Scale for visualization
            backgroundColor: 'rgba(52, 152, 219, 0.5)',
            borderColor: '#3498db',
            borderWidth: 1,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Monto ($)'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'Transacciones'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    function createPaymentMethodsChart(paymentMethods) {
      const ctx = paymentMethodsChart.getContext('2d');
      
      // Destroy existing chart
      if (window.paymentMethodsChartInstance) {
        window.paymentMethodsChartInstance.destroy();
      }
      
      window.paymentMethodsChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(paymentMethods),
          datasets: [{
            data: Object.values(paymentMethods),
            backgroundColor: [
              'rgba(22, 224, 134, 0.5)',
              'rgba(52, 152, 219, 0.5)'
            ],
            borderColor: [
              '#16e086',
              '#3498db'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // View Toggle Functions
    function setProductView(view) {
      if (view === 'grid') {
        viewGridMobile.classList.add('active');
        viewListMobile.classList.remove('active');
        productsGrid.classList.remove('list-view');
        productsGrid.style.display = 'grid';
      } else if (view === 'list') {
        viewListMobile.classList.add('active');
        viewGridMobile.classList.remove('active');
        productsGrid.classList.add('list-view');
        productsGrid.style.display = 'flex';
      }
    }

    // ============================
    // CONFIGURACIÓN DE EVENT LISTENERS
    // ============================

    // Event Listeners existentes
    mobileLoginBtn.addEventListener('click', async () => {
      const username = mobileUsername.value.trim();
      const pin = mobilePin.value.trim();
      
      if (!username || !pin) {
        loginError.textContent = 'Por favor complete todos los campos';
        loginError.style.display = 'block';
        return;
      }
      
      const authenticated = await authenticateCollaborator(username, pin);
      
      if (authenticated) {
        loginError.style.display = 'none';
        loginScreen.style.display = 'none';
        posScreen.style.display = 'flex';
        
        // Check header logo
        checkHeaderLogo();
        
        // Load collaborator data
        await loadCollaboratorData();
        
        // Initialize scanner
        initializeScanner();
        
        // Setup search functionality
        setupSearchFunctionality();
        
        // Setup keyboard control
        setupKeyboardControl();
        
        // Setup calculator
        setupCalculator();
        
        // Focus on search if always active is enabled
        if (alwaysActiveSearchEnabled) {
          setTimeout(() => {
            mobileSearch.focus();
          }, 500);
        }
      }
    });

    // Scanner optimizado
    scannerBtnMobile.addEventListener('click', () => {
      scannerModal.style.display = 'flex';
      if (!isScannerActive) {
        startOptimizedScanner();
      }
    });

    toggleScannerBtn.addEventListener('click', async () => {
      if (isScannerActive) {
        await stopOptimizedScanner();
      } else {
        await startOptimizedScanner();
      }
    });

    switchCameraBtn.addEventListener('click', async () => {
      await switchCameraOptimized();
    });

    uploadImageBtn.addEventListener('click', () => {
      imageUploadInput.click();
    });

    imageUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        try {
          showLoading('Escaneando imagen...');
          const result = await scannerInstance.scanFile(file, false);
          onScanSuccessOptimized(result);
          hideLoading();
        } catch (error) {
          hideLoading();
          showToast('No se detectó código en la imagen', 'error');
        }
      }
    });

    // View toggle
    viewGridMobile.addEventListener('click', () => {
      setProductView('grid');
    });

    viewListMobile.addEventListener('click', () => {
      setProductView('list');
    });

    // Navigation
    navProducts.addEventListener('click', (e) => {
      e.preventDefault();
      invoiceSection.classList.remove('active');
      navProducts.classList.add('active');
      navInvoice.classList.remove('active');
      navHistory.classList.remove('active');
      navReports.classList.remove('active');
      navMenu.classList.remove('active');
    });

    navInvoice.addEventListener('click', (e) => {
      e.preventDefault();
      invoiceSection.classList.add('active');
      navProducts.classList.remove('active');
      navInvoice.classList.add('active');
      navHistory.classList.remove('active');
      navReports.classList.remove('active');
      navMenu.classList.remove('active');
    });

    navHistory.addEventListener('click', async (e) => {
      e.preventDefault();
      await loadHistory();
      historyModal.style.display = 'flex';
      navProducts.classList.remove('active');
      navInvoice.classList.remove('active');
      navHistory.classList.add('active');
      navReports.classList.remove('active');
      navMenu.classList.remove('active');
    });

    navReports.addEventListener('click', async (e) => {
      e.preventDefault();
      await loadReports();
      reportsModal.style.display = 'flex';
      navProducts.classList.remove('active');
      navInvoice.classList.remove('active');
      navHistory.classList.remove('active');
      navReports.classList.add('active');
      navMenu.classList.remove('active');
    });

    navMenu.addEventListener('click', (e) => {
      e.preventDefault();
      menuModal.style.display = 'flex';
      navProducts.classList.remove('active');
      navInvoice.classList.remove('active');
      navHistory.classList.remove('active');
      navReports.classList.remove('active');
      navMenu.classList.add('active');
    });

    closeInvoiceBtn.addEventListener('click', () => {
      invoiceSection.classList.remove('active');
      navProducts.classList.add('active');
      navInvoice.classList.remove('active');
    });

    // Header buttons
    userBtnMobile.addEventListener('click', (e) => {
      e.preventDefault();
      // Mostrar perfil del usuario en lugar de información básica
      loadUserProfile();
      userProfileModal.style.display = 'flex';
    });

    shiftBtnMobile.addEventListener('click', () => {
      updateShiftDisplay();
      shiftModal.style.display = 'flex';
    });

    // Menu hamburger para tablet/PC
    menuHamburgerBtn.addEventListener('click', () => {
      menuModal.style.display = 'flex';
    });

    // User info modal
    closeUserInfoModal.addEventListener('click', () => {
      userInfoModal.style.display = 'none';
    });

    closeUserInfoBtn.addEventListener('click', () => {
      userInfoModal.style.display = 'none';
    });

    // Tax modal - Solo visualización
    closeTaxModalBtn.addEventListener('click', () => {
      taxModal.style.display = 'none';
    });

    // Rates modal - Solo visualización
    closeRatesModalBtn.addEventListener('click', () => {
      ratesModal.style.display = 'none';
    });

    // Payment buttons
    discountBtnMobile.addEventListener('click', () => {
      discountPasswordInput.value = '';
      discountModal.style.display = 'flex';
    });

    cashBtnMobile.addEventListener('click', () => {
      setupCashPayment();
      cashModal.style.display = 'flex';
    });

    cardBtnMobile.addEventListener('click', () => {
      cardModal.style.display = 'flex';
    });

    invoiceBtnMobile.addEventListener('click', () => {
      cashModal.style.display = 'flex';
    });

    // Discount modals
    verifyDiscountBtn.addEventListener('click', applyDiscountWithPassword);

    // Teclado numérico para descuento con control de clics
    document.querySelectorAll('#discountPercentageModal .num-btn[data-value]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const now = Date.now();
        if (now - lastNumpadClickTime < numpadClickDelay) {
          return;
        }
        lastNumpadClickTime = now;
        
        const value = btn.getAttribute('data-value');
        discountInput.value = value;
      });
    });

    discountClearBtn.addEventListener('click', () => {
      discountInput.value = '';
    });

    applyDiscountBtn.addEventListener('click', applyDiscountPercentage);

    // Card payment
    confirmCardBtn.addEventListener('click', async () => {
      await processPayment('Tarjeta');
    });

    // Shift modal
    endShiftBtn.addEventListener('click', endShift);

    // Menu items
    menuInventory.addEventListener('click', (e) => {
      // El enlace ya está configurado en el HTML
    });

    menuReportsMain.addEventListener('click', (e) => {
      e.preventDefault();
      loadReports();
      reportsModal.style.display = 'flex';
      menuModal.style.display = 'none';
    });

    menuInvoices.addEventListener('click', (e) => {
      // El enlace ya está configurado en el HTML
    });

    menuAnalysis.addEventListener('click', (e) => {
      // El enlace ya está configurado en el HTML
    });

    menuRates.addEventListener('click', (e) => {
      e.preventDefault();
      ratesModal.style.display = 'flex';
      menuModal.style.display = 'none';
    });

    menuConfig.addEventListener('click', (e) => {
      e.preventDefault();
      configModal.style.display = 'flex';
      menuModal.style.display = 'none';
    });

    // Config
    saveConfigBtn.addEventListener('click', saveConfig);

    // History
    sendWhatsAppBtn.addEventListener('click', sendWhatsAppMessage);
    copyInvoiceBtn.addEventListener('click', copyInvoiceToClipboard);

    // Shift end modal
    changeAccountBtn.addEventListener('click', () => {
      logoutCollaborator();
      shiftEndModal.style.display = 'none';
    });

    reloadPageBtn.addEventListener('click', () => {
      location.reload();
    });

    // Print modal
    printInvoiceBtn.addEventListener('click', () => {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Factura ${Date.now()}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              @media print {
                body { padding: 0; }
                button { display: none; }
              }
            </style>
          </head>
          <body>
            ${invoicePrintContent.innerHTML}
            <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #16e086; color: white; border: none; border-radius: 5px; cursor: pointer;">Imprimir</button>
          </body>
        </html>
      `);
      printWindow.document.close();
    });

    sendInvoiceBtn.addEventListener('click', () => {
      printModal.style.display = 'none';
      sendInvoiceModal.style.display = 'flex';
      
      // Preparar mensaje actual para WhatsApp si hay factura
      if (invoice.length > 0) {
        let message = `*FACTURA EN PROCESO*\n\n`;
        message += `*${businessDetails.name}*\n`;
        message += `RNC: ${businessDetails.rnc}\n`;
        message += `Fecha: ${new Date().toLocaleString()}\n`;
        message += `Atendido por: ${currentCollaborator.firstName} ${currentCollaborator.lastName}\n\n`;
        message += `*DETALLES DE LA COMPRA:*\n`;
        
        invoice.forEach(item => {
          message += `• ${item.name} x${item.quantity} - ${formatCurrency(item.pricePerUnit * item.quantity)}\n`;
        });
        
        message += `\n*RESUMEN:*\n`;
        message += `Subtotal: ${formatCurrency(totalPrice)}\n`;
        
        if (discount > 0) {
          message += `Descuento: -${formatCurrency(totalPrice * (discount / 100))}\n`;
        }
        
        message += `*TOTAL: ${formatCurrency(discountedTotal)}*\n\n`;
        message += `¡Gracias por su compra! 🛒`;
        
        window.currentWhatsAppMessage = message;
      }
    });

    // ============================
    // NUEVOS EVENT LISTENERS
    // ============================

    // Búsqueda Avanzada
    advancedSearchBtn.addEventListener('click', () => {
      advancedSearchModal.style.display = 'flex';
    });

    closeAdvancedSearchModal.addEventListener('click', () => {
      advancedSearchModal.style.display = 'none';
    });

    // Configurar filtros de búsqueda avanzada
    function setupAdvancedSearch() {
      // Configurar filtros activos
      document.querySelectorAll('.filter-option').forEach(option => {
        option.addEventListener('click', function() {
          const parentId = this.parentElement.id;
          
          // Remover activo de todos los hermanos
          this.parentElement.querySelectorAll('.filter-option').forEach(opt => {
            opt.classList.remove('active');
          });
          
          // Agregar activo al seleccionado
          this.classList.add('active');
          
          // Actualizar filtros
          if (parentId === 'categoryFilters') {
            currentSearchFilters.category = this.dataset.category;
          } else if (parentId === 'sortOptions') {
            currentSearchFilters.sort = this.dataset.sort;
          }
        });
      });
      
      // Aplicar filtros
      applyFiltersBtn.addEventListener('click', async () => {
        currentSearchFilters.minPrice = parseFloat(minPrice.value) || null;
        currentSearchFilters.maxPrice = parseFloat(maxPrice.value) || null;
        
        await loadProducts(mobileSearch.value.trim());
        advancedSearchModal.style.display = 'none';
        showToast('Filtros aplicados', 'success');
      });
    }

    // Copiar Factura Anterior
    copyLastInvoiceBtn.addEventListener('click', copyLastInvoice);

    // Notas Internas
    addNoteBtn.addEventListener('click', () => {
      noteTitle.value = '';
      noteContent.value = '';
      notesModal.style.display = 'flex';
    });

    closeNotesModal.addEventListener('click', () => {
      notesModal.style.display = 'none';
    });

    saveNoteBtn.addEventListener('click', async () => {
      const title = noteTitle.value.trim();
      const content = noteContent.value.trim();
      
      if (!title || !content) {
        showToast('Complete título y contenido', 'error');
        return;
      }
      
      await saveInternalNote(title, content);
      notesModal.style.display = 'none';
    });

    // Editar Nota
    closeEditNoteModal.addEventListener('click', () => {
      editNoteModal.style.display = 'none';
    });

    updateNoteBtn.addEventListener('click', async () => {
      const title = editNoteTitle.value.trim();
      const content = editNoteContent.value.trim();
      
      if (!title || !content) {
        showToast('Complete título y contenido', 'error');
        return;
      }
      
      if (!currentNoteToEdit) {
        showToast('Error: No se encontró la nota a editar', 'error');
        return;
      }
      
      await updateInternalNote(currentNoteToEdit, title, content);
      editNoteModal.style.display = 'none';
      currentNoteToEdit = null;
    });

    // Confirmación eliminar nota
    closeConfirmDeleteNoteModal.addEventListener('click', () => {
      confirmDeleteNoteModal.style.display = 'none';
      currentNoteToDelete = null;
    });

    cancelDeleteNoteBtn.addEventListener('click', () => {
      confirmDeleteNoteModal.style.display = 'none';
      currentNoteToDelete = null;
    });

    confirmDeleteNoteBtn.addEventListener('click', async () => {
      if (currentNoteToDelete) {
        await deleteInternalNote(currentNoteToDelete);
        confirmDeleteNoteModal.style.display = 'none';
        currentNoteToDelete = null;
      }
    });

    // Métodos de Pago Múltiples
    addPaymentMethodBtn.addEventListener('click', () => {
      showToast('Función en desarrollo', 'info');
    });

    // Gestor de Clientes
    quickClientsBtn.addEventListener('click', () => {
      clientsModal.style.display = 'flex';
      quickAccessMenu.style.display = 'none';
    });

    addClientBtn.addEventListener('click', () => {
      resetClientForm();
      clientFormModal.style.display = 'flex';
    });

    closeClientFormModal.addEventListener('click', () => {
      clientFormModal.style.display = 'none';
      resetClientForm();
    });

    closeClientsModal.addEventListener('click', () => {
      clientsModal.style.display = 'none';
    });

    saveClientBtn.addEventListener('click', async () => {
      const name = clientName.value.trim();
      const phone = clientPhone.value.trim();
      const email = clientEmail.value.trim();
      const address = clientAddress.value.trim();
      const notes = clientNotes.value.trim();
      
      if (!name) {
        showToast('El nombre es requerido', 'error');
        return;
      }
      
      const clientData = {
        name,
        phone,
        email,
        address,
        notes
      };
      
      await saveClient(clientData, currentClientToEdit);
      
      clientFormModal.style.display = 'none';
      resetClientForm();
    });

    // Confirmación eliminar cliente
    closeConfirmDeleteClientModal.addEventListener('click', () => {
      confirmDeleteClientModal.style.display = 'none';
      currentClientToDelete = null;
    });

    cancelDeleteClientBtn.addEventListener('click', () => {
      confirmDeleteClientModal.style.display = 'none';
      currentClientToDelete = null;
    });

    confirmDeleteClientBtn.addEventListener('click', async () => {
      if (currentClientToDelete) {
        await deleteClient(currentClientToDelete);
        confirmDeleteClientModal.style.display = 'none';
        currentClientToDelete = null;
      }
    });

    // Calculadora
    quickCalculatorBtn.addEventListener('click', () => {
      calculatorModal.style.display = 'flex';
      quickAccessMenu.style.display = 'none';
    });

    closeCalculatorModal.addEventListener('click', () => {
      calculatorModal.style.display = 'none';
    });

    // Registro de Gastos
    quickExpensesBtn.addEventListener('click', () => {
      expensesModal.style.display = 'flex';
      quickAccessMenu.style.display = 'none';
    });

    closeExpensesModal.addEventListener('click', () => {
      expensesModal.style.display = 'none';
    });

    addExpenseBtn.addEventListener('click', () => {
      expenseDescription.value = '';
      expenseAmount.value = '';
      expenseNotes.value = '';
      expenseFormModal.style.display = 'flex';
    });

    closeExpenseFormModal.addEventListener('click', () => {
      expenseFormModal.style.display = 'none';
    });

    exportExpensesBtn.addEventListener('click', () => {
      showToast('Función de exportación en desarrollo', 'info');
    });

    // Teclado numérico para gastos
    document.querySelectorAll('#expenseFormModal .num-btn[data-value]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const now = Date.now();
        if (now - lastNumpadClickTime < numpadClickDelay) {
          return;
        }
        lastNumpadClickTime = now;
        
        const value = btn.getAttribute('data-value');
        expenseAmount.value = expenseAmount.value + value;
      });
    });

    expenseClearBtn.addEventListener('click', () => {
      expenseAmount.value = '';
    });

    expenseSaveBtn.addEventListener('click', async () => {
      showToast('Función de guardar gasto en desarrollo', 'info');
      expenseFormModal.style.display = 'none';
    });

    // Compartir Productos
    quickShareProductsBtn.addEventListener('click', () => {
      shareProductsModal.style.display = 'flex';
      quickAccessMenu.style.display = 'none';
    });

    closeShareProductsModal.addEventListener('click', () => {
      shareProductsModal.style.display = 'none';
    });

    closeSelectProductsModal.addEventListener('click', () => {
      selectProductsModal.style.display = 'none';
    });

    confirmSelectedProductsBtn.addEventListener('click', () => {
      selectProductsModal.style.display = 'none';
      shareProductsModal.style.display = 'flex';
    });

    // Notas desde acceso rápido
    quickNotesBtn.addEventListener('click', () => {
      notesContainer.style.display = notesContainer.style.display === 'none' ? 'block' : 'none';
      quickAccessMenu.style.display = 'none';
      
      if (notesContainer.style.display === 'block') {
        showToast('Notas internas mostradas', 'info');
      }
    });

    // Perfil del Usuario
    closeUserProfileModal.addEventListener('click', () => {
      userProfileModal.style.display = 'none';
    });

    cancelProfileChangesBtn.addEventListener('click', () => {
      userProfileModal.style.display = 'none';
    });

    saveProfileBtn.addEventListener('click', saveUserProfile);

    changeAvatarBtn.addEventListener('click', () => {
      avatarUploadInput.click();
    });

    avatarUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
          showToast('Por favor seleccione una imagen', 'error');
          return;
        }
        
        // Validar tamaño (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showToast('La imagen es demasiado grande (máximo 5MB)', 'error');
          return;
        }
        
        await uploadAvatar(file);
      }
    });

    // Acceso Rápido
    quickAccessBtn.addEventListener('click', () => {
      quickAccessMenu.style.display = quickAccessMenu.style.display === 'block' ? 'none' : 'block';
    });

    // Cerrar menú de acceso rápido al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!quickAccessBtn.contains(e.target) && !quickAccessMenu.contains(e.target)) {
        quickAccessMenu.style.display = 'none';
      }
    });

    // ============================
    // INICIALIZACIÓN DE NUEVAS FUNCIONES
    // ============================

    // Configurar búsqueda avanzada
    setupAdvancedSearch();

    // Close modal handlers
    const closeButtons = [
      closeCashModal, closeCardModal, closeDiscountModal, closeDiscountPercentageModal, 
      closeScannerModal, closeShiftModal, closeTaxModal, closeRatesModal,
      closeMenuModal, closeConfigModal, closeHistoryModal, closeReportsModal,
      closePrintModal, closeSendInvoiceModal,
      // Nuevos modales
      closeAdvancedSearchModal, closeNotesModal, closeEditNoteModal, closeClientsModal, 
      closeClientFormModal, closeCalculatorModal, closeExpensesModal, closeExpenseFormModal,
      closeShareProductsModal, closeSelectProductsModal, closeUserProfileModal,
      closeConfirmDeleteNoteModal, closeConfirmDeleteClientModal
    ];
    
    closeButtons.forEach(btn => {
      if (btn) {
        btn.addEventListener('click', () => {
          btn.closest('.modal-mobile').style.display = 'none';
        });
      }
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal-mobile').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape to close modals
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-mobile').forEach(modal => {
          modal.style.display = 'none';
        });
        quickAccessMenu.style.display = 'none';
      }
      
      // F5 to refresh
      if (e.key === 'F5') {
        e.preventDefault();
        loadProducts(mobileSearch.value);
      }
      
      // Ctrl+D for discount
      if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        discountBtnMobile.click();
      }
      
      // Ctrl+E for cash payment
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        cashBtnMobile.click();
      }
      
      // Ctrl+T for card payment
      if (e.ctrlKey && e.key === 't') {
        e.preventDefault();
        cardBtnMobile.click();
      }
      
      // Ctrl+F for invoice
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        invoiceBtnMobile.click();
      }
      
      // Delete to clear search (solo si está habilitado)
      if (e.key === 'Delete' && autoClearSearchEnabled) {
        e.preventDefault();
        mobileSearch.value = '';
        loadProducts('');
        if (alwaysActiveSearchEnabled) {
          mobileSearch.focus();
        }
      }
      
      // Ctrl+N for notes
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        notesModal.style.display = 'flex';
      }
      
      // Ctrl+C for calculator
      if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        calculatorModal.style.display = 'flex';
      }
      
      // Ctrl+G for expenses
      if (e.ctrlKey && e.key === 'g') {
        e.preventDefault();
        expensesModal.style.display = 'flex';
      }
      
      // Ctrl+P for profile
      if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        loadUserProfile();
        userProfileModal.style.display = 'flex';
      }
    });

    // Check for saved session
    window.addEventListener('load', () => {
      if (localStorage.getItem('collaboratorLoggedIn') === 'true') {
        const savedData = localStorage.getItem('collaboratorData');
        if (savedData) {
          currentCollaborator = JSON.parse(savedData);
          loginScreen.style.display = 'none';
          posScreen.style.display = 'flex';
          
          // Check header logo
          checkHeaderLogo();
          
          loadCollaboratorData();
          initializeScanner();
          
          // Setup search functionality
          setupSearchFunctionality();
          
          // Setup keyboard control
          setupKeyboardControl();
          
          // Setup calculator
          setupCalculator();
          
          // Focus on search if always active is enabled
          if (alwaysActiveSearchEnabled) {
            setTimeout(() => {
              mobileSearch.focus();
            }, 500);
          }
        }
      }
      
      // Manejar errores de carga de datos
      handleDataLoadError();
    });

    // Make functions available globally
    window.removeFromInvoice = removeFromInvoice;
    window.viewInvoice = viewInvoice;
    window.sendInvoiceToWhatsApp = sendInvoiceToWhatsApp;
  </script>
</body>
</html>
