<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Asistencia Facial - C√°mara Fullscreen</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Roboto, sans-serif;
    }

    :root {
      --primary: #16e086;
      --primary-dark: #0da85c;
      --secondary: #2e4a55;
      --dark: #0e1c22;
      --darker: #0a1519;
      --danger: #e74c3c;
      --warning: #f39c12;
      --text: #ffffff;
      --border: #2a3f48;
    }

    body {
      background: #000;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      margin: 0;
      overflow: hidden;
    }

    .fullscreen-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    .camera-full {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    #videoFacial {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(1);
    }

    .overlay-content {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      pointer-events: none;
    }

    .overlay-content button,
    .overlay-content input,
    .codigo-input-container,
    .btn-reiniciar,
    .link-registro {
      pointer-events: auto;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      padding: 15px 25px;
      border-radius: 50px;
      border: 1px solid var(--primary);
      color: white;
      flex-wrap: wrap;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title i {
      color: var(--primary);
      font-size: 24px;
    }

    .title h1 {
      font-size: clamp(18px, 4vw, 24px);
      font-weight: bold;
      color: white;
    }

    .camara-badge {
      background: rgba(0,0,0,0.8);
      color: var(--primary);
      padding: 8px 18px;
      border-radius: 40px;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--primary);
    }

    .resultado-flotante {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 550px;
      background: rgba(10, 25, 30, 0.85);
      backdrop-filter: blur(15px);
      border-radius: 30px;
      padding: 30px;
      border: 2px solid var(--primary);
      box-shadow: 0 0 50px rgba(22, 224, 134, 0.3);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .resultado-header {
      display: flex;
      align-items: center;
      gap: 25px;
    }

    .foto-colaborador {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--primary);
      background: var(--secondary);
    }

    .foto-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 48px;
      border: 4px dashed var(--primary);
    }

    .info-colaborador {
      flex: 1;
    }

    .nombre-colaborador {
      color: white;
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .codigo-colaborador {
      color: var(--primary);
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .tipo-registro {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 40px;
      font-weight: bold;
      font-size: 16px;
    }

    .entrada {
      background: var(--primary);
      color: var(--darker);
    }

    .salida {
      background: var(--danger);
      color: white;
    }

    .hora-registro {
      color: rgba(255,255,255,0.9);
      font-size: 18px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .codigo-input-container {
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      border-radius: 50px;
      padding: 15px 25px;
      border: 1px solid var(--primary);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .codigo-input {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--primary);
      border-radius: 40px;
      padding: 14px 20px;
      color: white;
      font-size: 18px;
      text-align: center;
      letter-spacing: 3px;
    }

    .codigo-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .btn-codigo {
      background: var(--primary);
      color: var(--darker);
      border: none;
      border-radius: 40px;
      padding: 14px 25px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    .btn-reiniciar {
      background: rgba(46, 74, 85, 0.8);
      backdrop-filter: blur(5px);
      color: white;
      border: 1px solid var(--primary);
      border-radius: 40px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .bloqueo-mensaje {
      background: rgba(231, 76, 60, 0.9);
      backdrop-filter: blur(5px);
      border-radius: 20px;
      padding: 15px 20px;
      color: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-left: 5px solid white;
    }

    .link-registro {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      padding: 12px 20px;
      border-radius: 40px;
      border: 1px solid var(--primary);
    }

    .link-registro a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 20px;
      right: 20px;
      background: rgba(22, 224, 134, 0.95);
      color: white;
      padding: 16px 20px;
      border-radius: 50px;
      text-align: center;
      font-weight: bold;
      display: none;
      z-index: 20000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30000;
    }

    .spinner {
      border: 5px solid rgba(22, 224, 134, 0.2);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .top-bar { flex-direction: column; align-items: flex-start; }
      .resultado-flotante { width: 95%; padding: 20px; }
      .resultado-header { flex-direction: column; text-align: center; }
      .codigo-input-container { flex-direction: column; }
      .btn-codigo { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="color: white; font-size: 18px;">Cargando modelos faciales...</div>
  </div>

  <div class="toast" id="toastNotification"></div>

  <div class="fullscreen-container">
    <div class="camera-full">
      <video id="videoFacial" autoplay muted playsinline></video>
    </div>

    <div class="overlay-content">
      <div class="top-bar">
        <div class="title">
          <i class="fas fa-clock"></i>
          <h1>Control de Asistencia</h1>
        </div>
        <div class="camara-badge">
          <i class="fas fa-face-smile"></i> ESCANEANDO...
        </div>
      </div>

      <div id="resultadoFlotante" class="resultado-flotante" style="display: none;">
        <div class="resultado-header">
          <div id="fotoContainer">
            <div class="foto-placeholder" id="fotoPlaceholder">
              <i class="fas fa-user"></i>
            </div>
            <img id="fotoColaborador" class="foto-colaborador" style="display: none;">
          </div>
          <div class="info-colaborador">
            <div id="nombreDisplay" class="nombre-colaborador">---</div>
            <div id="codigoDisplay" class="codigo-colaborador">---</div>
            <div id="tipoDisplay" class="tipo-registro" style="display: none;"></div>
            <div id="horaDisplay" class="hora-registro">
              <i class="fas fa-clock"></i> <span id="horaTexto">--:--:--</span>
            </div>
          </div>
        </div>
        <div id="bloqueoMensaje" class="bloqueo-mensaje" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i> <span id="bloqueoTexto"></span>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 15px;">
        <div class="codigo-input-container">
          <input type="text" id="codigoInput" class="codigo-input" placeholder="Ingrese c√≥digo (solo n√∫meros)" inputmode="numeric" autocomplete="off">
          <button id="btnRegistrarPorCodigo" class="btn-codigo">
            <i class="fas fa-qrcode"></i> Registrar por C√≥digo
          </button>
        </div>
        
        <div style="display: flex; justify-content: flex-end;">
          <button id="btnReiniciar" class="btn-reiniciar">
            <i class="fas fa-sync-alt"></i> Reiniciar c√°mara
          </button>
        </div>
      </div>

      <div class="link-registro">
        <a href="registro-facial.html">
          <i class="fas fa-user-plus"></i> Registrar colaborador
        </a>
      </div>
    </div>
  </div>

  <script type="module">
    // ============================================================
    // FIREBASE - CONFIGURACI√ìN
    // ============================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      Timestamp,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
      measurementId: "G-HJNZXRENE9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ============================================================
    // VARIABLES GLOBALES
    // ============================================================
    let modelosCargados = false;
    let streamVideo = null;
    let colaboradoresRegistrados = [];
    let descriptorActual = null;
    
    let ultimoRegistroExitoso = {
      colaboradorId: null,
      timestamp: 0,
      tipo: null
    };
    
    let timeoutResultado = null;
    let intervaloDeteccion = null;
    
    // Elementos DOM
    const video = document.getElementById('videoFacial');
    const btnReiniciar = document.getElementById('btnReiniciar');
    const btnRegistrarPorCodigo = document.getElementById('btnRegistrarPorCodigo');
    const codigoInput = document.getElementById('codigoInput');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const toast = document.getElementById('toastNotification');
    
    const resultadoFlotante = document.getElementById('resultadoFlotante');
    const nombreDisplay = document.getElementById('nombreDisplay');
    const codigoDisplay = document.getElementById('codigoDisplay');
    const tipoDisplay = document.getElementById('tipoDisplay');
    const horaTexto = document.getElementById('horaTexto');
    const fotoColaborador = document.getElementById('fotoColaborador');
    const fotoPlaceholder = document.getElementById('fotoPlaceholder');
    const bloqueoMensaje = document.getElementById('bloqueoMensaje');
    const bloqueoTexto = document.getElementById('bloqueoTexto');

    // ============================================================
    // FUNCIONES UTILITARIAS
    // ============================================================
    function mostrarLoading(m) { loadingText.textContent = m; loadingOverlay.style.display = 'flex'; }
    function ocultarLoading() { loadingOverlay.style.display = 'none'; }
    
    function mostrarToast(msg, t = 'success') {
      toast.textContent = msg;
      toast.style.background = t === 'success' ? 'rgba(22,224,134,0.95)' : 
                             t === 'error' ? 'rgba(231,76,60,0.95)' : 
                             'rgba(243,156,18,0.95)';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 4000);
    }

    function formatearHora(d) { 
      return d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); 
    }
    
    function actualizarHora() { 
      horaTexto.textContent = formatearHora(new Date()); 
    }
    setInterval(actualizarHora, 1000);

    function limpiarResultado() {
      if (timeoutResultado) clearTimeout(timeoutResultado);
      timeoutResultado = setTimeout(() => {
        resultadoFlotante.style.display = 'none';
        descriptorActual = null;
      }, 60000);
    }

    // ============================================================
    // 1. CARGAR MODELOS
    // ============================================================
    async function cargarModelosFaceAPI() {
      mostrarLoading('Cargando modelos...');
      try {
        const url = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        await faceapi.nets.tinyFaceDetector.loadFromUri(url);
        await faceapi.nets.faceLandmark68Net.loadFromUri(url);
        await faceapi.nets.faceRecognitionNet.loadFromUri(url);
        modelosCargados = true;
        ocultarLoading();
        mostrarToast('Modelos cargados ‚úÖ', 'success');
        return true;
      } catch {
        try {
          const fallback = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';
          await faceapi.nets.tinyFaceDetector.loadFromUri(fallback);
          await faceapi.nets.faceLandmark68Net.loadFromUri(fallback);
          await faceapi.nets.faceRecognitionNet.loadFromUri(fallback);
          modelosCargados = true;
          ocultarLoading();
          mostrarToast('Modelos cargados (alt)', 'success');
          return true;
        } catch {
          ocultarLoading();
          mostrarToast('Error cargando modelos', 'error');
          return false;
        }
      }
    }

    // ============================================================
    // 2. CARGAR COLABORADORES
    // ============================================================
    async function cargarColaboradores() {
      try {
        const snapshot = await getDocs(query(collection(db, 'Ponche')));
        colaboradoresRegistrados = [];
        
        snapshot.forEach(doc => {
          const d = doc.data();
          const descriptores = [];
          if (d.facialDescriptorFrontal) descriptores.push(new Float32Array(d.facialDescriptorFrontal));
          if (d.facialDescriptorIzquierdo) descriptores.push(new Float32Array(d.facialDescriptorIzquierdo));
          if (d.facialDescriptorDerecho) descriptores.push(new Float32Array(d.facialDescriptorDerecho));
          if (d.facialDescriptorArriba) descriptores.push(new Float32Array(d.facialDescriptorArriba));
          if (d.facialDescriptorAbajo) descriptores.push(new Float32Array(d.facialDescriptorAbajo));
          
          if (descriptores.length) {
            colaboradoresRegistrados.push({
              id: doc.id,
              descriptores,
              nombre: `${d.firstName || ''} ${d.lastName || ''}`.trim() || d.username || 'Colaborador',
              codigo: d.username || '00000',
              fotoBase64: d.fotoBase64 || '',
              horasDiarias: d.horasDiarias || 8
            });
          }
        });
        return colaboradoresRegistrados.length;
      } catch (e) {
        console.error(e);
        return 0;
      }
    }

    // ============================================================
    // 3. INICIAR C√ÅMARA - CORREGIDA (COMPATIBLE CON TODOS)
    // ============================================================
    async function iniciarCamara() {
      try {
        if (streamVideo) {
          streamVideo.getTracks().forEach(t => t.stop());
        }
        
        // CONSTRAINTS COMPATIBLES CON TODOS LOS DISPOSITIVOS
        const constraints = {
          video: {
            facingMode: 'user',
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 }
          }
        };
        
        streamVideo = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = streamVideo;
        await video.play();
        video.style.transform = 'scaleX(1)';
        
        mostrarToast('C√°mara iniciada', 'success');
        return true;
      } catch (error) {
        console.error('Error c√°mara:', error);
        mostrarToast('No se pudo acceder a la c√°mara. Verifica permisos.', 'error');
        return false;
      }
    }

    // ============================================================
    // 4. CAPTURAR DESCRIPTOR
    // ============================================================
    async function capturarDescriptorActual() {
      if (!modelosCargados || !video) return null;
      try {
        const detecciones = await faceapi.detectAllFaces(video, 
          new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
          .withFaceLandmarks().withFaceDescriptors();
        return detecciones.length ? detecciones[0].descriptor : null;
      } catch {
        return null;
      }
    }

    // ============================================================
    // 5. COMPARAR DESCRIPTOR (UMBRAL 0.40)
    // ============================================================
    function encontrarColaboradorPorDescriptor(descriptor) {
      let mejor = null, menorDist = 1.0;
      for (const colab of colaboradoresRegistrados) {
        for (const desc of colab.descriptores) {
          const dist = faceapi.euclideanDistance(descriptor, desc);
          if (dist < menorDist) {
            menorDist = dist;
            mejor = colab;
          }
        }
      }
      return (mejor && menorDist < 0.40) ? { colaborador: mejor, distancia: menorDist } : null;
    }

    // ============================================================
    // 6. ENCONTRAR POR C√ìDIGO
    // ============================================================
    function encontrarColaboradorPorCodigo(codigo) {
      return colaboradoresRegistrados.find(c => c.codigo === codigo) || null;
    }

    // ============================================================
    // 7. VERIFICAR 4 HORAS
    // ============================================================
    async function puedeRegistrar(colaboradorId) {
      try {
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', colaboradorId),
          orderBy('timestamp', 'desc'),
          limit(1)
        );
        const snap = await getDocs(q);
        if (snap.empty) return { puede: true };
        const ultimo = snap.docs[0].data().timestamp.toDate();
        const horas = (new Date() - ultimo) / (1000 * 60 * 60);
        return horas < 4 
          ? { puede: false, mensaje: `‚è≥ Espere ${(4 - horas).toFixed(1)}h. Solo 1 registro cada 4h.` }
          : { puede: true };
      } catch {
        return { puede: true };
      }
    }

    // ============================================================
    // 8. DETERMINAR ENTRADA/SALIDA
    // ============================================================
    async function determinarTipoRegistro(colaboradorId) {
      try {
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', colaboradorId),
          orderBy('timestamp', 'desc'),
          limit(1)
        );
        const snap = await getDocs(q);
        if (snap.empty) return 'entry';
        return snap.docs[0].data().type === 'entry' ? 'exit' : 'entry';
      } catch {
        return 'entry';
      }
    }

    // ============================================================
    // 9. REGISTRAR ASISTENCIA
    // ============================================================
    async function registrarAsistencia(colaborador, tipo, metodo = 'facial') {
      try {
        await addDoc(collection(db, 'facialAttendance'), {
          collaboratorId: colaborador.id,
          collaboratorName: colaborador.nombre,
          collaboratorCode: colaborador.codigo,
          timestamp: Timestamp.now(),
          date: new Date().toISOString(),
          type: tipo,
          method: metodo,
          horasDiarias: colaborador.horasDiarias || 8
        });
        return true;
      } catch {
        return false;
      }
    }

    // ============================================================
    // 10. MOSTRAR RESULTADO
    // ============================================================
    async function mostrarResultado(colaborador, tipo, metodo = 'facial') {
      resultadoFlotante.style.display = 'block';
      nombreDisplay.textContent = colaborador.nombre;
      codigoDisplay.textContent = colaborador.codigo;
      tipoDisplay.style.display = 'inline-block';
      tipoDisplay.className = `tipo-registro ${tipo === 'entry' ? 'entrada' : 'salida'}`;
      tipoDisplay.innerHTML = tipo === 'entry' ? '‚úÖ ENTRADA REGISTRADA' : 'üö™ SALIDA REGISTRADA';
      horaTexto.textContent = formatearHora(new Date());
      
      if (colaborador.fotoBase64) {
        fotoColaborador.src = colaborador.fotoBase64;
        fotoColaborador.style.display = 'block';
        fotoPlaceholder.style.display = 'none';
      } else {
        fotoColaborador.style.display = 'none';
        fotoPlaceholder.style.display = 'flex';
        fotoPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
      }
      
      bloqueoMensaje.style.display = 'none';
      mostrarToast(`${tipo === 'entry' ? '‚úÖ Entrada' : 'üö™ Salida'}: ${colaborador.nombre}`, 'success');
      limpiarResultado();
    }

    // ============================================================
    // 11. PROCESAR REGISTRO FACIAL
    // ============================================================
    async function procesarRegistroFacial() {
      if (!modelosCargados || !colaboradoresRegistrados.length) return;
      
      const descriptor = await capturarDescriptorActual();
      if (!descriptor) {
        if (resultadoFlotante.style.display === 'none') return;
        return;
      }
      
      descriptorActual = descriptor;
      const resultado = encontrarColaboradorPorDescriptor(descriptor);
      
      if (!resultado) {
        if (resultadoFlotante.style.display === 'none') {
          resultadoFlotante.style.display = 'block';
          nombreDisplay.textContent = '‚ùå No registrado';
          codigoDisplay.textContent = 'Rostro no existe';
          tipoDisplay.style.display = 'none';
          fotoColaborador.style.display = 'none';
          fotoPlaceholder.style.display = 'flex';
          fotoPlaceholder.style.borderColor = '#e74c3c';
          fotoPlaceholder.innerHTML = '<i class="fas fa-ban" style="color:#e74c3c;"></i>';
          bloqueoMensaje.style.display = 'none';
          limpiarResultado();
        }
        return;
      }
      
      const colaborador = resultado.colaborador;
      const ahora = Date.now();
      
      if (ultimoRegistroExitoso.colaboradorId === colaborador.id && ahora - ultimoRegistroExitoso.timestamp < 60000) {
        const seg = Math.ceil(60 - ((ahora - ultimoRegistroExitoso.timestamp) / 1000));
        resultadoFlotante.style.display = 'block';
        nombreDisplay.textContent = colaborador.nombre;
        codigoDisplay.textContent = colaborador.codigo;
        tipoDisplay.style.display = 'none';
        bloqueoMensaje.style.display = 'flex';
        bloqueoTexto.innerHTML = `‚ö†Ô∏è YA REGISTR√ì ${ultimoRegistroExitoso.tipo === 'entry' ? 'ENTRADA' : 'SALIDA'} HACE ${seg}s.`;
        mostrarToast(`‚è≥ Espere ${seg} segundos`, 'warning');
        return;
      }
      
      const verif = await puedeRegistrar(colaborador.id);
      if (!verif.puede) {
        resultadoFlotante.style.display = 'block';
        nombreDisplay.textContent = colaborador.nombre;
        codigoDisplay.textContent = colaborador.codigo;
        tipoDisplay.style.display = 'none';
        bloqueoMensaje.style.display = 'flex';
        bloqueoTexto.innerHTML = verif.mensaje;
        mostrarToast(verif.mensaje, 'warning');
        return;
      }
      
      const tipo = await determinarTipoRegistro(colaborador.id);
      const registrado = await registrarAsistencia(colaborador, tipo, 'facial');
      
      if (registrado) {
        ultimoRegistroExitoso = { colaboradorId: colaborador.id, timestamp: ahora, tipo };
        await mostrarResultado(colaborador, tipo, 'facial');
      }
    }

    // ============================================================
    // 12. REGISTRAR POR C√ìDIGO
    // ============================================================
    async function registrarPorCodigo() {
      const codigo = codigoInput.value.trim().replace(/\D/g, '');
      if (!codigo) return mostrarToast('Ingrese un c√≥digo v√°lido', 'error');
      
      const colaborador = encontrarColaboradorPorCodigo(codigo);
      if (!colaborador) return mostrarToast('C√≥digo no encontrado', 'error');
      
      mostrarLoading('Verificando rostro...');
      const descriptor = await capturarDescriptorActual();
      
      if (!descriptor) {
        ocultarLoading();
        return mostrarToast('No se detect√≥ rostro', 'error');
      }
      
      let coincide = false;
      for (const desc of colaborador.descriptores) {
        if (faceapi.euclideanDistance(descriptor, desc) < 0.45) {
          coincide = true;
          break;
        }
      }
      
      ocultarLoading();
      
      if (!coincide) return mostrarToast('‚ùå El rostro no coincide con el c√≥digo', 'error');
      
      const ahora = Date.now();
      if (ultimoRegistroExitoso.colaboradorId === colaborador.id && ahora - ultimoRegistroExitoso.timestamp < 60000) {
        const seg = Math.ceil(60 - ((ahora - ultimoRegistroExitoso.timestamp) / 1000));
        return mostrarToast(`‚è≥ Espere ${seg} segundos`, 'warning');
      }
      
      const verif = await puedeRegistrar(colaborador.id);
      if (!verif.puede) return mostrarToast(verif.mensaje, 'warning');
      
      const tipo = await determinarTipoRegistro(colaborador.id);
      const registrado = await registrarAsistencia(colaborador, tipo, 'codigo');
      
      if (registrado) {
        ultimoRegistroExitoso = { colaboradorId: colaborador.id, timestamp: ahora, tipo };
        await mostrarResultado(colaborador, tipo, 'codigo');
        codigoInput.value = '';
      }
    }

    // ============================================================
    // 13. DETECCI√ìN CONTINUA
    // ============================================================
    function iniciarDeteccionContinua() {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      if (!modelosCargados || !colaboradoresRegistrados.length) return;
      intervaloDeteccion = setInterval(procesarRegistroFacial, 800);
    }

    // ============================================================
    // 14. INICIALIZACI√ìN
    // ============================================================
    async function inicializarSistema() {
      const modelosOK = await cargarModelosFaceAPI();
      if (!modelosOK) return;
      
      const cantidad = await cargarColaboradores();
      const camaraOK = await iniciarCamara();
      if (!camaraOK) return;
      
      if (cantidad) {
        iniciarDeteccionContinua();
        mostrarToast(`‚úÖ ${cantidad} colaboradores - Umbral 0.40`, 'success');
      }
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    window.addEventListener('load', inicializarSistema);
    
    btnReiniciar.addEventListener('click', async () => { 
      await iniciarCamara(); 
      mostrarToast('C√°mara reiniciada', 'success');
    });
    
    btnRegistrarPorCodigo.addEventListener('click', registrarPorCodigo);
    
    codigoInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') registrarPorCodigo();
    });

    window.addEventListener('beforeunload', () => {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      if (streamVideo) streamVideo.getTracks().forEach(t => t.stop());
      if (timeoutResultado) clearTimeout(timeoutResultado);
    });
  </script>
</body>
</html>
