<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Asistencia Facial - Control Horario</title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- face-api.js -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    /* ===== RESET Y VARIABLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    :root {
      --primary: #16e086;
      --primary-dark: #0da85c;
      --secondary: #2e4a55;
      --dark: #0e1c22;
      --darker: #0a1519;
      --light: #1a2c33;
      --danger: #e74c3c;
      --warning: #f39c12;
      --text: #ffffff;
      --text-muted: rgba(255,255,255,0.6);
      --border: #2a3f48;
      --border-light: #3a5a66;
    }

    body {
      background: linear-gradient(145deg, var(--darker), var(--dark));
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      background: var(--light);
      border-radius: 28px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      border: 1px solid var(--border-light);
      max-height: 98vh;
      overflow-y: auto;
    }

    h1 {
      color: white;
      font-size: clamp(20px, 5vw, 26px);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 i {
      color: var(--primary);
      background: rgba(22, 224, 134, 0.1);
      padding: 10px;
      border-radius: 16px;
    }

    .nav-tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .nav-tab {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: clamp(14px, 4vw, 16px);
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .nav-tab.active {
      background: var(--primary);
      color: var(--darker);
    }

    .row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .col-camara {
      flex: 1;
      min-width: 280px;
    }

    .col-resultado {
      flex: 1;
      min-width: 280px;
    }

    .camara-wrapper {
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--primary);
      aspect-ratio: 4/3;
      width: 100%;
    }

    #videoFacial {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(1);
    }

    .camara-badge {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: var(--primary);
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--primary);
      backdrop-filter: blur(4px);
    }

    .resultado-card {
      background: var(--dark);
      border-radius: 16px;
      padding: 20px;
      height: 100%;
      border-left: 5px solid;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .resultado-existe {
      border-left-color: var(--primary);
      background: linear-gradient(145deg, var(--dark), #14262e);
    }

    .resultado-no-existe {
      border-left-color: var(--danger);
    }

    .info-horizontal {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .foto-colaborador {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      background: var(--secondary);
    }

    .foto-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 40px;
      border: 3px dashed var(--primary);
    }

    .detalles-colaborador {
      flex: 1;
    }

    .nombre-colaborador {
      color: white;
      font-size: clamp(18px, 4vw, 24px);
      font-weight: bold;
      margin-bottom: 5px;
    }

    .codigo-colaborador {
      color: var(--primary);
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: 600;
      margin-bottom: 10px;
    }

    .tipo-registro {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .entrada {
      background: var(--primary);
      color: var(--darker);
    }

    .salida {
      background: var(--danger);
      color: white;
    }

    .hora-registro {
      color: var(--text-muted);
      font-size: 15px;
      margin-top: 5px;
    }

    .bloqueo-mensaje {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid var(--danger);
      border-radius: 12px;
      padding: 12px;
      margin-top: 15px;
      color: var(--danger);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bloqueo-horas-mensaje {
      background: rgba(243, 156, 18, 0.2);
      border: 1px solid var(--warning);
      border-radius: 12px;
      padding: 12px;
      margin-top: 15px;
      color: var(--warning);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn-gris {
      background: var(--secondary);
      color: white;
      width: 100%;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
    }

    .link-registro {
      text-align: center;
      margin-top: 20px;
    }

    .link-registro a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 20px;
      right: 20px;
      background: rgba(22, 224, 134, 0.95);
      color: white;
      padding: 16px 20px;
      border-radius: 50px;
      text-align: center;
      font-weight: bold;
      display: none;
      z-index: 10000;
      backdrop-filter: blur(10px);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30000;
    }

    .spinner {
      border: 5px solid rgba(22, 224, 134, 0.2);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .registro-counter {
      margin-top: 10px;
      padding: 8px 12px;
      background: rgba(22, 224, 134, 0.1);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 13px;
      border-left: 3px solid var(--primary);
    }

    .registro-counter i {
      color: var(--primary);
      margin-right: 6px;
    }

    .confianza-badge {
      background: rgba(255,255,255,0.1);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-muted);
      display: inline-block;
      margin-top: 5px;
    }

    .confianza-alta {
      color: #16e086;
    }

    .confianza-baja {
      color: #f39c12;
    }

    .confianza-muy-baja {
      color: #e74c3c;
    }
  </style>
</head>
<body>

  <!-- LOADING -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="color: white; font-size: 18px;">Cargando modelos faciales...</div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toastNotification"></div>

  <div class="app-container">
    <!-- NAVEGACI√ìN -->
    <div class="nav-tabs">
      <button id="navAsistenciaBtn" class="nav-tab active">
        <i class="fas fa-camera"></i> Asistencia
      </button>
      <button id="navRegistroLinkBtn" class="nav-tab">
        <i class="fas fa-user-plus"></i> Registro
      </button>
    </div>

    <h1>
      <i class="fas fa-clock"></i> 
      Control de Asistencia
    </h1>

    <!-- LAYOUT HORIZONTAL COMPACTO -->
    <div class="row">
      <!-- COLUMNA C√ÅMARA -->
      <div class="col-camara">
        <div class="camara-wrapper">
          <video id="videoFacial" autoplay muted playsinline></video>
          <div class="camara-badge">
            <i class="fas fa-face-smile"></i> ESCANEANDO...
          </div>
        </div>
        <button id="btnReiniciar" class="btn btn-gris btn-small" style="margin-top: 10px;">
          <i class="fas fa-sync-alt"></i> Reiniciar c√°mara
        </button>
      </div>

      <!-- COLUMNA RESULTADO -->
      <div class="col-resultado">
        <div id="resultadoCard" class="resultado-card" style="border-left-color: #f39c12;">
          <div id="infoContenido" class="info-horizontal">
            
            <!-- FOTO -->
            <div id="fotoContainer">
              <div class="foto-placeholder" id="fotoPlaceholder">
                <i class="fas fa-user"></i>
              </div>
              <img id="fotoColaborador" class="foto-colaborador" style="display: none;">
            </div>

            <!-- DETALLES -->
            <div class="detalles-colaborador">
              <div id="nombreDisplay" class="nombre-colaborador" style="color: #f39c12;">
                Esperando rostro...
              </div>
              <div id="codigoDisplay" class="codigo-colaborador" style="color: #f39c12;">
                <i class="fas fa-hourglass-half"></i>
              </div>
              <div id="confianzaDisplay" class="confianza-badge" style="display: none;"></div>
              <div id="tipoDisplay" class="tipo-registro" style="display: none;"></div>
              <div id="horaDisplay" class="hora-registro">
                <i class="fas fa-clock"></i> 
                <span id="horaTexto">--:--:--</span>
              </div>
              
              <!-- Mensaje de bloqueo por escaneo repetido -->
              <div id="bloqueoMensaje" class="bloqueo-mensaje" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="bloqueoTexto"></span>
              </div>
              
              <!-- Mensaje de bloqueo por 4 horas -->
              <div id="bloqueoHorasMensaje" class="bloqueo-horas-mensaje" style="display: none;">
                <i class="fas fa-clock"></i>
                <span id="bloqueoHorasTexto"></span>
              </div>
              
              <!-- Contador de registros del d√≠a -->
              <div id="registroCounter" class="registro-counter" style="display: none;">
                <i class="fas fa-list-ol"></i>
                <span id="registroCounterTexto"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOT√ìN IR A REGISTRO -->
    <div class="link-registro">
      <a href="#" id="irARegistroLink">
        <i class="fas fa-user-plus"></i> Registrar nuevo colaborador
      </a>
    </div>
  </div>

  <script type="module">
    // ============================================================
    // FIREBASE - CONFIGURACI√ìN
    // ============================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      addDoc,
      Timestamp,
      orderBy,
      limit,
      getDoc,
      updateDoc,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
      measurementId: "G-HJNZXRENE9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ============================================================
    // VARIABLES GLOBALES - SEGURIDAD M√ÅXIMA
    // ============================================================
    let modelosCargados = false;
    let streamVideo = null;
    
    // Colaboradores desde colecci√≥n "Ponche"
    let colaboradoresRegistrados = [];
    
    // MAPA para control estricto de escaneos por colaborador
    const escaneosPorColaborador = new Map();
    
    // TIEMPO DE BLOQUEO: 4 HORAS
    const TIEMPO_BLOQUEO_HORAS = 4 * 60 * 60 * 1000;
    
    // Cache de registros diarios
    const cacheRegistrosDiarios = new Map();
    
    // Control de frames
    let colaboradorActualEnProceso = null;
    let ultimoDescriptorProcesado = null;
    let tiempoUltimoRegistroExitoso = 0;
    
    // ===== UMBRALES DE SEGURIDAD - EXTREMADAMENTE ESTRICTOS =====
    // Para evitar cualquier confusi√≥n entre diferentes personas
    const UMBRAL_RECONOCIMIENTO = 0.35;  // REDUCIDO DE 0.48 a 0.35 - MUY ESTRICTO
    const UMBRAL_MISMA_PERSONA = 0.30;   // Para verificar que es exactamente la misma persona
    
    // Historial de descriptores por colaborador (para verificaci√≥n m√∫ltiple)
    const historialDescriptores = new Map();
    
    let timeoutResultado = null;
    let intervaloDeteccion = null;
    
    // Elementos DOM
    const video = document.getElementById('videoFacial');
    const btnReiniciar = document.getElementById('btnReiniciar');
    const navAsistenciaBtn = document.getElementById('navAsistenciaBtn');
    const navRegistroLinkBtn = document.getElementById('navRegistroLinkBtn');
    const irARegistroLink = document.getElementById('irARegistroLink');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const toast = document.getElementById('toastNotification');
    
    // Elementos de resultado
    const nombreDisplay = document.getElementById('nombreDisplay');
    const codigoDisplay = document.getElementById('codigoDisplay');
    const tipoDisplay = document.getElementById('tipoDisplay');
    const horaTexto = document.getElementById('horaTexto');
    const fotoColaborador = document.getElementById('fotoColaborador');
    const fotoPlaceholder = document.getElementById('fotoPlaceholder');
    const resultadoCard = document.getElementById('resultadoCard');
    const bloqueoMensaje = document.getElementById('bloqueoMensaje');
    const bloqueoTexto = document.getElementById('bloqueoTexto');
    const bloqueoHorasMensaje = document.getElementById('bloqueoHorasMensaje');
    const bloqueoHorasTexto = document.getElementById('bloqueoHorasTexto');
    const registroCounter = document.getElementById('registroCounter');
    const registroCounterTexto = document.getElementById('registroCounterTexto');
    const confianzaDisplay = document.getElementById('confianzaDisplay');

    // ============================================================
    // FUNCIONES UTILITARIAS
    // ============================================================
    function mostrarLoading(mensaje = 'Cargando...') {
      loadingText.textContent = mensaje;
      loadingOverlay.style.display = 'flex';
    }

    function ocultarLoading() {
      loadingOverlay.style.display = 'none';
    }

    function mostrarToast(msg, tipo = 'success') {
      toast.textContent = msg;
      toast.style.background = tipo === 'success' ? 'rgba(22, 224, 134, 0.95)' : 
                             tipo === 'error' ? 'rgba(231, 76, 60, 0.95)' : 
                             'rgba(243, 156, 18, 0.95)';
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 4000);
    }

    function formatearHora(date) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function formatearFecha(date) {
      return date.toISOString().split('T')[0];
    }

    function actualizarHora() {
      const ahora = new Date();
      horaTexto.textContent = formatearHora(ahora);
    }
    setInterval(actualizarHora, 1000);

    // Limpiar resultado
    function limpiarResultado() {
      if (timeoutResultado) clearTimeout(timeoutResultado);
      timeoutResultado = setTimeout(() => {
        nombreDisplay.textContent = 'Esperando rostro...';
        nombreDisplay.style.color = '#f39c12';
        codigoDisplay.innerHTML = '<i class="fas fa-hourglass-half"></i> Col√≥cate frente a la c√°mara';
        codigoDisplay.style.color = '#f39c12';
        tipoDisplay.style.display = 'none';
        confianzaDisplay.style.display = 'none';
        bloqueoMensaje.style.display = 'none';
        bloqueoHorasMensaje.style.display = 'none';
        registroCounter.style.display = 'none';
        
        fotoColaborador.style.display = 'none';
        fotoPlaceholder.style.display = 'flex';
        fotoPlaceholder.style.borderColor = '#f39c12';
        fotoPlaceholder.innerHTML = '<i class="fas fa-user" style="color: #f39c12;"></i>';
        
        resultadoCard.className = 'resultado-card';
        resultadoCard.style.borderLeftColor = '#f39c12';
        
        colaboradorActualEnProceso = null;
        ultimoDescriptorProcesado = null;
      }, 60000);
    }

    // ============================================================
    // NAVEGACI√ìN
    // ============================================================
    function irARegistro() {
      window.location.href = 'registro-facial.html';
    }

    navRegistroLinkBtn.addEventListener('click', irARegistro);
    irARegistroLink.addEventListener('click', (e) => {
      e.preventDefault();
      irARegistro();
    });

    // ============================================================
    // 1. CARGAR MODELOS
    // ============================================================
    async function cargarModelosFaceAPI() {
      mostrarLoading('Cargando modelos faciales...');
      
      try {
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        modelosCargados = true;
        ocultarLoading();
        return true;
      } catch (error) {
        try {
          const FALLBACK_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';
          await faceapi.nets.tinyFaceDetector.loadFromUri(FALLBACK_URL);
          await faceapi.nets.faceLandmark68Net.loadFromUri(FALLBACK_URL);
          await faceapi.nets.faceRecognitionNet.loadFromUri(FALLBACK_URL);
          
          modelosCargados = true;
          ocultarLoading();
          return true;
        } catch (fallbackError) {
          ocultarLoading();
          mostrarToast('No se pudieron cargar los modelos', 'error');
          return false;
        }
      }
    }

    // ============================================================
    // 2. CARGAR COLABORADORES DESDE "Ponche"
    // ============================================================
    async function cargarColaboradores() {
      try {
        const collRef = collection(db, 'Ponche');
        const q = query(collRef);
        const snapshot = await getDocs(q);
        
        colaboradoresRegistrados = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          
          const descriptores = [];
          
          // Cargar descriptores de todos los √°ngulos
          if (data.facialDescriptorFrontal) descriptores.push(new Float32Array(data.facialDescriptorFrontal));
          if (data.facialDescriptorIzquierdo) descriptores.push(new Float32Array(data.facialDescriptorIzquierdo));
          if (data.facialDescriptorDerecho) descriptores.push(new Float32Array(data.facialDescriptorDerecho));
          if (data.facialDescriptorArriba) descriptores.push(new Float32Array(data.facialDescriptorArriba));
          if (data.facialDescriptorAbajo) descriptores.push(new Float32Array(data.facialDescriptorAbajo));
          
          if (descriptores.length > 0) {
            const nombreCompleto = `${data.firstName || ''} ${data.lastName || ''}`.trim() || data.username || 'Colaborador';
            
            colaboradoresRegistrados.push({
              id: doc.id,
              descriptores: descriptores,
              descriptorPrincipal: new Float32Array(data.facialDescriptorFrontal || descriptores[0]),
              nombre: nombreCompleto,
              username: data.username || '',
              codigo: data.uniqueProfileId || `RTM-${doc.id.slice(-5)}`,
              fotoBase64: data.fotoBase64 || '',
              horasDiarias: data.horasDiarias || 8,
              pin: data.pin || '1234'
            });
            
            // Inicializar control de escaneo
            if (!escaneosPorColaborador.has(doc.id)) {
              escaneosPorColaborador.set(doc.id, {
                ultimoRegistroTimestamp: 0,
                ultimoTipoRegistro: null,
                contadorDia: 0,
                fechaActual: formatearFecha(new Date()),
                verificacionesExitosas: 0
              });
            }
            
            // Inicializar historial de descriptores
            if (!historialDescriptores.has(doc.id)) {
              historialDescriptores.set(doc.id, []);
            }
          }
        });
        
        return colaboradoresRegistrados.length;
      } catch (error) {
        console.error('Error cargando colaboradores:', error);
        return 0;
      }
    }

    // ============================================================
    // 3. INICIAR C√ÅMARA
    // ============================================================
    async function iniciarCamara() {
      try {
        if (streamVideo) {
          streamVideo.getTracks().forEach(track => track.stop());
        }
        
        streamVideo = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          }
        });
        
        video.srcObject = streamVideo;
        await video.play();
        video.style.transform = 'scaleX(1)';
        
        return true;
      } catch (error) {
        mostrarToast('No se pudo acceder a la c√°mara', 'error');
        return false;
      }
    }

    // ============================================================
    // 4. VERIFICACI√ìN MULTIFACTOR DE IDENTIDAD FACIAL
    // ============================================================
    async function verificarIdentidadFacial(descriptorDetectado, colaborador) {
      
      // ===== VERIFICACI√ìN 1: DISTANCIA CON DESCRIPTOR PRINCIPAL =====
      let distanciaPrincipal = 1.0;
      if (colaborador.descriptorPrincipal) {
        distanciaPrincipal = faceapi.euclideanDistance(descriptorDetectado, colaborador.descriptorPrincipal);
      }
      
      // ===== VERIFICACI√ìN 2: MEJOR DISTANCIA ENTRE TODOS LOS √ÅNGULOS =====
      let mejorDistancia = 1.0;
      for (const descriptorGuardado of colaborador.descriptores) {
        const distancia = faceapi.euclideanDistance(descriptorDetectado, descriptorGuardado);
        if (distancia < mejorDistancia) {
          mejorDistancia = distancia;
        }
      }
      
      // ===== VERIFICACI√ìN 3: CONSISTENCIA CON HISTORIAL =====
      const historial = historialDescriptores.get(colaborador.id) || [];
      let consistencia = 1.0;
      
      if (historial.length > 0) {
        let sumaDistancias = 0;
        const muestras = Math.min(historial.length, 3);
        for (let i = 0; i < muestras; i++) {
          const distanciaHistorial = faceapi.euclideanDistance(descriptorDetectado, historial[i]);
          sumaDistancias += distanciaHistorial;
        }
        consistencia = sumaDistancias / muestras;
      }
      
      // ===== ACTUALIZAR HISTORIAL =====
      historial.unshift(descriptorDetectado);
      if (historial.length > 5) historial.pop();
      historialDescriptores.set(colaborador.id, historial);
      
      // ===== DISTANCIA FINAL =====
      const distanciaFinal = (mejorDistancia * 0.6) + (consistencia * 0.4);
      
      return {
        esMismaPersona: distanciaFinal < UMBRAL_RECONOCIMIENTO,
        distancia: distanciaFinal,
        distanciaPrincipal: distanciaPrincipal,
        mejorDistancia: mejorDistancia,
        consistencia: consistencia,
        nivelConfianza: Math.max(0, Math.min(100, 100 - (distanciaFinal * 100)))
      };
    }

    // ============================================================
    // 5. COMPARAR CONTRA TODOS LOS COLABORADORES
    // ============================================================
    async function encontrarColaborador(descriptorDetectado) {
      let mejorCoincidencia = null;
      let mejorVerificacion = null;
      
      for (const colaborador of colaboradoresRegistrados) {
        const verificacion = await verificarIdentidadFacial(descriptorDetectado, colaborador);
        
        if (verificacion.esMismaPersona) {
          if (!mejorCoincidencia || verificacion.distancia < mejorVerificacion.distancia) {
            mejorCoincidencia = colaborador;
            mejorVerificacion = verificacion;
          }
        }
      }
      
      return { mejorColaborador: mejorCoincidencia, verificacion: mejorVerificacion };
    }

    // ============================================================
    // 6. OBTENER REGISTROS DEL D√çA
    // ============================================================
    async function obtenerRegistrosDelDia(colaboradorId) {
      try {
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const manana = new Date(hoy);
        manana.setDate(manana.getDate() + 1);
        
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', colaboradorId),
          where('timestamp', '>=', Timestamp.fromDate(hoy)),
          where('timestamp', '<', Timestamp.fromDate(manana)),
          orderBy('timestamp', 'asc')
        );
        
        const snapshot = await getDocs(q);
        const registros = [];
        
        snapshot.forEach(doc => {
          registros.push({
            id: doc.id,
            ...doc.data(),
            timestamp: doc.data().timestamp.toDate()
          });
        });
        
        const fechaHoy = formatearFecha(new Date());
        cacheRegistrosDiarios.set(`${colaboradorId}_${fechaHoy}`, registros);
        
        return registros;
      } catch (error) {
        console.error('Error obteniendo registros:', error);
        return [];
      }
    }

    // ============================================================
    // 7. DETERMINAR TIPO DE REGISTRO
    // ============================================================
    async function determinarTipoRegistro(colaboradorId) {
      try {
        const registrosHoy = await obtenerRegistrosDelDia(colaboradorId);
        const cantidadRegistros = registrosHoy.length;
        
        if (cantidadRegistros === 0) {
          return { 
            tipo: 'entry', 
            orden: 1, 
            descripcion: 'Primera Entrada',
            registrosHoy: []
          };
        }
        
        const esPar = cantidadRegistros % 2 === 0;
        
        if (esPar) {
          return { 
            tipo: 'entry', 
            orden: cantidadRegistros + 1, 
            descripcion: `${cantidadRegistros + 1}¬™ Entrada`,
            registrosHoy: registrosHoy
          };
        } else {
          return { 
            tipo: 'exit', 
            orden: cantidadRegistros + 1, 
            descripcion: `${Math.ceil((cantidadRegistros + 1) / 2)}¬™ Salida`,
            registrosHoy: registrosHoy
          };
        }
        
      } catch (error) {
        console.error('Error determinando tipo:', error);
        return { tipo: 'entry', orden: 1, descripcion: 'Entrada', registrosHoy: [] };
      }
    }

    // ============================================================
    // 8. VERIFICAR BLOQUEO DE 4 HORAS
    // ============================================================
    async function verificarBloqueo4Horas(colaboradorId) {
      try {
        const registrosHoy = await obtenerRegistrosDelDia(colaboradorId);
        
        if (registrosHoy.length === 0) {
          return { bloqueado: false, tiempoRestante: 0, mensaje: '' };
        }
        
        const ultimoRegistro = registrosHoy[registrosHoy.length - 1];
        const ahora = new Date();
        const tiempoUltimoRegistro = ultimoRegistro.timestamp instanceof Date 
          ? ultimoRegistro.timestamp 
          : new Date(ultimoRegistro.timestamp);
        
        const diferenciaMs = ahora - tiempoUltimoRegistro;
        const registrosPendientes = registrosHoy.length % 2 !== 0;
        
        if (registrosPendientes) {
          if (diferenciaMs < TIEMPO_BLOQUEO_HORAS) {
            const horasRestantes = Math.floor((TIEMPO_BLOQUEO_HORAS - diferenciaMs) / (60 * 60 * 1000));
            const minutosRestantes = Math.floor(((TIEMPO_BLOQUEO_HORAS - diferenciaMs) % (60 * 60 * 1000)) / (60 * 1000));
            
            return {
              bloqueado: true,
              tiempoRestante: TIEMPO_BLOQUEO_HORAS - diferenciaMs,
              mensaje: `Debe esperar ${horasRestantes}h ${minutosRestantes}m para registrar su salida`,
              tipoBloqueo: 'horas'
            };
          }
        }
        
        return { bloqueado: false, tiempoRestante: 0, mensaje: '' };
        
      } catch (error) {
        console.error('Error verificando bloqueo:', error);
        return { bloqueado: false, tiempoRestante: 0, mensaje: '' };
      }
    }

    // ============================================================
    // 9. VERIFICAR ESCANEO REPETIDO
    // ============================================================
    function verificarEscaneoRepetido(colaboradorId) {
      const ahora = Date.now();
      const escaneoColaborador = escaneosPorColaborador.get(colaboradorId) || {
        ultimoRegistroTimestamp: 0
      };
      
      if (escaneoColaborador.ultimoRegistroTimestamp > 0 && 
          ahora - escaneoColaborador.ultimoRegistroTimestamp < 60000) {
        
        const segundosRestantes = Math.ceil(60 - ((ahora - escaneoColaborador.ultimoRegistroTimestamp) / 1000));
        
        return {
          repetido: true,
          segundosRestantes: segundosRestantes,
          mensaje: `Espere ${segundosRestantes} segundos para registrar nuevamente`
        };
      }
      
      return { repetido: false };
    }

    // ============================================================
    // 10. REGISTRAR ASISTENCIA
    // ============================================================
    async function registrarAsistencia(colaborador, infoTipo, verificacion) {
      try {
        const ahora = new Date();
        const fechaHoy = formatearFecha(ahora);
        
        const registroData = {
          collaboratorId: colaborador.id,
          collaboratorName: colaborador.nombre,
          collaboratorCode: colaborador.codigo,
          timestamp: Timestamp.fromDate(ahora),
          date: ahora.toISOString(),
          type: infoTipo.tipo,
          tipoDescripcion: infoTipo.descripcion,
          numeroRegistro: infoTipo.orden,
          turno: Math.ceil(infoTipo.orden / 2),
          method: 'auto',
          horasDiarias: colaborador.horasDiarias || 8,
          
          // METADATOS DE SEGURIDAD FACIAL
          nivelConfianza: verificacion.nivelConfianza,
          distanciaFacial: verificacion.mejorDistancia,
          consistenciaHistorial: verificacion.consistencia,
          verificadoMultifactorial: true
        };

        await addDoc(collection(db, 'facialAttendance'), registroData);
        
        escaneosPorColaborador.set(colaborador.id, {
          ultimoRegistroTimestamp: Date.now(),
          ultimoTipoRegistro: infoTipo.tipo,
          ultimoNumeroRegistro: infoTipo.orden,
          fechaActual: fechaHoy,
          ultimaConfianza: verificacion.nivelConfianza
        });
        
        cacheRegistrosDiarios.delete(`${colaborador.id}_${fechaHoy}`);
        
        return true;
      } catch (error) {
        console.error('Error registrando:', error);
        return false;
      }
    }

    // ============================================================
    // 11. MOSTRAR COLABORADOR DETECTADO - SEGURIDAD M√ÅXIMA
    // ============================================================
    async function mostrarColaboradorDetectado(colaborador, verificacion) {
      
      if (timeoutResultado) clearTimeout(timeoutResultado);
      
      // PREVENIR M√öLTIPLES REGISTROS
      if (colaboradorActualEnProceso === colaborador.id) {
        return;
      }
      
      colaboradorActualEnProceso = colaborador.id;
      
      // ===== 1. VERIFICAR CONFIANZA M√çNIMA =====
      if (verificacion.nivelConfianza < 65) { // M√≠nimo 65% de confianza
        mostrarToast(`‚ùå Confianza baja (${Math.round(verificacion.nivelConfianza)}%). Ac√©rquese m√°s a la c√°mara.`, 'warning');
        colaboradorActualEnProceso = null;
        
        // Mostrar en UI
        nombreDisplay.textContent = colaborador.nombre;
        nombreDisplay.style.color = '#f39c12';
        codigoDisplay.innerHTML = `<i class="fas fa-id-card"></i> ${colaborador.codigo} - CONFIANZA BAJA`;
        codigoDisplay.style.color = '#f39c12';
        
        confianzaDisplay.style.display = 'block';
        confianzaDisplay.className = 'confianza-badge confianza-baja';
        confianzaDisplay.innerHTML = `<i class="fas fa-shield-alt"></i> Confianza: ${Math.round(verificacion.nivelConfianza)}% (m√≠nimo 65%)`;
        
        setTimeout(() => {
          colaboradorActualEnProceso = null;
        }, 2000);
        return;
      }
      
      // ===== 2. VERIFICAR ESCANEO REPETIDO =====
      const escaneoRepetido = verificarEscaneoRepetido(colaborador.id);
      if (escaneoRepetido.repetido) {
        bloqueoMensaje.style.display = 'flex';
        bloqueoTexto.innerHTML = escaneoRepetido.mensaje;
        bloqueoHorasMensaje.style.display = 'none';
        
        resultadoCard.style.borderLeftColor = '#e74c3c';
        mostrarInformacionColaborador(colaborador, null, 'bloqueado-60s', verificacion);
        mostrarToast(`‚è≥ ${escaneoRepetido.mensaje}`, 'warning');
        
        setTimeout(() => {
          colaboradorActualEnProceso = null;
        }, 3000);
        return;
      }
      
      // ===== 3. OBTENER TIPO DE REGISTRO =====
      const infoTipo = await determinarTipoRegistro(colaborador.id);
      
      // ===== 4. VERIFICAR BLOQUEO DE 4 HORAS =====
      const bloqueoHoras = await verificarBloqueo4Horas(colaborador.id);
      if (bloqueoHoras.bloqueado) {
        bloqueoHorasMensaje.style.display = 'flex';
        bloqueoHorasTexto.innerHTML = bloqueoHoras.mensaje;
        bloqueoMensaje.style.display = 'none';
        
        resultadoCard.style.borderLeftColor = '#f39c12';
        mostrarInformacionColaborador(colaborador, infoTipo, 'bloqueado-horas', verificacion);
        mostrarToast(`‚è≥ ${bloqueoHoras.mensaje}`, 'warning');
        
        setTimeout(() => {
          colaboradorActualEnProceso = null;
        }, 5000);
        return;
      }
      
      // ===== 5. REGISTRAR ASISTENCIA =====
      const registrado = await registrarAsistencia(colaborador, infoTipo, verificacion);
      
      if (!registrado) {
        mostrarToast('Error al registrar', 'error');
        colaboradorActualEnProceso = null;
        return;
      }
      
      // ===== 6. MOSTRAR √âXITO =====
      await mostrarInformacionColaborador(colaborador, infoTipo, 'exitoso', verificacion);
      mostrarToast(`‚úÖ ${infoTipo.descripcion}: ${colaborador.nombre} (${Math.round(verificacion.nivelConfianza)}% confianza)`, 'success');
      
      limpiarResultado();
      
      setTimeout(() => {
        colaboradorActualEnProceso = null;
      }, 5000);
    }

    // ============================================================
    // 12. MOSTRAR INFORMACI√ìN DEL COLABORADOR
    // ============================================================
    async function mostrarInformacionColaborador(colaborador, infoTipo, estado, verificacion) {
      
      nombreDisplay.textContent = colaborador.nombre;
      codigoDisplay.innerHTML = `<i class="fas fa-id-card"></i> ${colaborador.codigo}`;
      
      // Mostrar nivel de confianza
      if (verificacion) {
        confianzaDisplay.style.display = 'block';
        const confianza = Math.round(verificacion.nivelConfianza);
        
        if (confianza >= 80) {
          confianzaDisplay.className = 'confianza-badge confianza-alta';
        } else if (confianza >= 65) {
          confianzaDisplay.className = 'confianza-badge confianza-baja';
        } else {
          confianzaDisplay.className = 'confianza-badge confianza-muy-baja';
        }
        
        confianzaDisplay.innerHTML = `<i class="fas fa-shield-alt"></i> Confianza: ${confianza}% | Distancia: ${verificacion.mejorDistancia.toFixed(3)}`;
      }
      
      // Colores seg√∫n estado
      switch(estado) {
        case 'exitoso':
          nombreDisplay.style.color = '#16e086';
          codigoDisplay.style.color = '#16e086';
          resultadoCard.className = 'resultado-card resultado-existe';
          resultadoCard.style.borderLeftColor = '#16e086';
          
          if (infoTipo) {
            tipoDisplay.style.display = 'inline-block';
            tipoDisplay.className = `tipo-registro ${infoTipo.tipo === 'entry' ? 'entrada' : 'salida'}`;
            tipoDisplay.innerHTML = infoTipo.tipo === 'entry' ? 
              `‚úÖ ${infoTipo.descripcion} REGISTRADA` : 
              `üö™ ${infoTipo.descripcion} REGISTRADA`;
          }
          break;
          
        case 'bloqueado-horas':
          nombreDisplay.style.color = '#f39c12';
          codigoDisplay.style.color = '#f39c12';
          resultadoCard.style.borderLeftColor = '#f39c12';
          
          tipoDisplay.style.display = 'inline-block';
          tipoDisplay.className = `tipo-registro`;
          tipoDisplay.style.background = '#f39c12';
          tipoDisplay.style.color = '#0a1519';
          tipoDisplay.innerHTML = '‚è≥ ESPERANDO 4 HORAS';
          break;
          
        case 'bloqueado-60s':
          nombreDisplay.style.color = '#e74c3c';
          codigoDisplay.style.color = '#e74c3c';
          resultadoCard.style.borderLeftColor = '#e74c3c';
          
          tipoDisplay.style.display = 'inline-block';
          tipoDisplay.className = `tipo-registro`;
          tipoDisplay.style.background = '#e74c3c';
          tipoDisplay.style.color = 'white';
          tipoDisplay.innerHTML = '‚è≥ ESCANEO REPETIDO';
          break;
      }
      
      // Foto
      if (colaborador.fotoBase64) {
        fotoColaborador.src = colaborador.fotoBase64;
        fotoColaborador.style.display = 'block';
        fotoPlaceholder.style.display = 'none';
      } else {
        fotoColaborador.style.display = 'none';
        fotoPlaceholder.style.display = 'flex';
        fotoPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
      }
      
      // Contador de registros
      if (infoTipo && infoTipo.registrosHoy) {
        const registrosHoy = infoTipo.registrosHoy;
        registroCounter.style.display = 'block';
        
        let entradas = 0;
        let salidas = 0;
        
        registrosHoy.forEach(reg => {
          if (reg.type === 'entry') entradas++;
          else salidas++;
        });
        
        if (estado === 'exitoso' && infoTipo) {
          if (infoTipo.tipo === 'entry') entradas++;
          else salidas++;
        }
        
        registroCounterTexto.innerHTML = `Registros hoy: ${entradas} entrada(s) | ${salidas} salida(s)`;
      }
    }

    // ============================================================
    // 13. MOSTRAR ROSTRO NO REGISTRADO
    // ============================================================
    function mostrarRostroNoRegistrado() {
      if (timeoutResultado) clearTimeout(timeoutResultado);
      
      resultadoCard.className = 'resultado-card resultado-no-existe';
      nombreDisplay.style.color = '#e74c3c';
      nombreDisplay.textContent = '‚ùå No registrado';
      
      codigoDisplay.style.color = '#e74c3c';
      codigoDisplay.innerHTML = '<i class="fas fa-user-slash"></i> Rostro no existe en el sistema';
      
      tipoDisplay.style.display = 'none';
      confianzaDisplay.style.display = 'none';
      bloqueoMensaje.style.display = 'none';
      bloqueoHorasMensaje.style.display = 'none';
      registroCounter.style.display = 'none';
      
      fotoColaborador.style.display = 'none';
      fotoPlaceholder.style.display = 'flex';
      fotoPlaceholder.style.borderColor = '#e74c3c';
      fotoPlaceholder.innerHTML = '<i class="fas fa-ban" style="color: #e74c3c; font-size: 40px;"></i>';
      
      colaboradorActualEnProceso = null;
      ultimoDescriptorProcesado = null;
      limpiarResultado();
    }

    // ============================================================
    // 14. MOSTRAR M√öLTIPLES ROSTROS
    // ============================================================
    function mostrarMultiplesRostros() {
      nombreDisplay.textContent = 'üë• M√∫ltiples rostros';
      nombreDisplay.style.color = '#f39c12';
      codigoDisplay.innerHTML = '<i class="fas fa-users"></i> Solo un rostro a la vez';
      codigoDisplay.style.color = '#f39c12';
      tipoDisplay.style.display = 'none';
      confianzaDisplay.style.display = 'none';
      bloqueoMensaje.style.display = 'none';
      bloqueoHorasMensaje.style.display = 'none';
      
      fotoColaborador.style.display = 'none';
      fotoPlaceholder.style.display = 'flex';
      fotoPlaceholder.style.borderColor = '#f39c12';
      fotoPlaceholder.innerHTML = '<i class="fas fa-users" style="color: #f39c12;"></i>';
    }

    // ============================================================
    // 15. MOSTRAR ESPERANDO ROSTRO
    // ============================================================
    function mostrarEsperandoRostro() {
      if (nombreDisplay.textContent !== 'Esperando rostro...' && 
          nombreDisplay.textContent !== '‚ùå No registrado' &&
          nombreDisplay.textContent !== 'üë• M√∫ltiples rostros') {
        return;
      }
      
      resultadoCard.className = 'resultado-card';
      resultadoCard.style.borderLeftColor = '#f39c12';
      nombreDisplay.style.color = '#f39c12';
      nombreDisplay.textContent = 'üë§ Esperando rostro...';
      
      codigoDisplay.style.color = '#f39c12';
      codigoDisplay.innerHTML = '<i class="fas fa-hourglass-half"></i> Col√≥cate frente a la c√°mara';
      
      tipoDisplay.style.display = 'none';
      confianzaDisplay.style.display = 'none';
      bloqueoMensaje.style.display = 'none';
      bloqueoHorasMensaje.style.display = 'none';
      registroCounter.style.display = 'none';
      
      fotoColaborador.style.display = 'none';
      fotoPlaceholder.style.display = 'flex';
      fotoPlaceholder.style.borderColor = '#f39c12';
      fotoPlaceholder.innerHTML = '<i class="fas fa-user" style="color: #f39c12;"></i>';
      
      colaboradorActualEnProceso = null;
    }

    // ============================================================
    // 16. DETECCI√ìN CONTINUA - CORREGIDA
    // ============================================================
    function iniciarDeteccionContinua() {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      
      if (!modelosCargados || colaboradoresRegistrados.length === 0) return;
      
      let contadorFrames = 0;
      const FRAMES_SALTAR = 4; // Procesar cada 4 frames
      
      intervaloDeteccion = setInterval(async () => {
        if (!video || video.paused || video.ended) return;
        
        try {
          contadorFrames++;
          if (contadorFrames % FRAMES_SALTAR !== 0) return;
          
          const detecciones = await faceapi.detectAllFaces(video, 
            new faceapi.TinyFaceDetectorOptions({
              inputSize: 320, // Mayor precisi√≥n
              scoreThreshold: 0.6 // Umbral m√°s alto
            }))
            .withFaceLandmarks()
            .withFaceDescriptors();
          
          actualizarHora();
          
          if (detecciones.length === 1) {
            const descriptorDetectado = detecciones[0].descriptor;
            
            // ===== EVITAR PROCESAR EL MISMO DESCRIPTOR =====
            if (ultimoDescriptorProcesado) {
              const distanciaUltimo = faceapi.euclideanDistance(descriptorDetectado, ultimoDescriptorProcesado);
              if (distanciaUltimo < 0.1) {
                return; // Mismo rostro, mismo frame
              }
            }
            
            ultimoDescriptorProcesado = descriptorDetectado;
            
            // ===== ENCONTRAR COLABORADOR CON VERIFICACI√ìN MULTIFACTOR =====
            const { mejorColaborador, verificacion } = await encontrarColaborador(descriptorDetectado);
            
            if (mejorColaborador && verificacion) {
              await mostrarColaboradorDetectado(mejorColaborador, verificacion);
            } else {
              mostrarRostroNoRegistrado();
            }
          } else if (detecciones.length > 1) {
            mostrarMultiplesRostros();
            colaboradorActualEnProceso = null;
            ultimoDescriptorProcesado = null;
          } else {
            mostrarEsperandoRostro();
            colaboradorActualEnProceso = null;
            ultimoDescriptorProcesado = null;
          }
        } catch (e) {
          console.warn('Error en detecci√≥n:', e);
        }
      }, 600);
    }

    // ============================================================
    // 17. INICIALIZACI√ìN
    // ============================================================
    async function inicializarSistema() {
      const modelosOK = await cargarModelosFaceAPI();
      if (!modelosOK) return;
      
      const cantidad = await cargarColaboradores();
      
      const camaraOK = await iniciarCamara();
      if (!camaraOK) return;
      
      if (cantidad > 0) {
        iniciarDeteccionContinua();
        mostrarToast(`‚úÖ ${cantidad} colaboradores en sistema`, 'success');
      } else {
        mostrarToast('No hay colaboradores registrados', 'warning');
      }
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    window.addEventListener('load', inicializarSistema);
    
    btnReiniciar.addEventListener('click', async () => {
      await iniciarCamara();
      mostrarToast('C√°mara reiniciada', 'success');
    });

    window.addEventListener('beforeunload', () => {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      if (streamVideo) streamVideo.getTracks().forEach(track => track.stop());
      if (timeoutResultado) clearTimeout(timeoutResultado);
    });
  </script>
</body>
</html> 
