<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Asistencia Facial - Control Horario</title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- face-api.js -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    /* ===== RESET Y VARIABLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    :root {
      --primary: #16e086;
      --primary-dark: #0da85c;
      --secondary: #2e4a55;
      --dark: #0e1c22;
      --darker: #0a1519;
      --light: #1a2c33;
      --danger: #e74c3c;
      --warning: #f39c12;
      --text: #ffffff;
      --text-muted: rgba(255,255,255,0.6);
      --border: #2a3f48;
      --border-light: #3a5a66;
    }

    body {
      background: linear-gradient(145deg, var(--darker), var(--dark));
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    /* ===== CONTENEDOR PRINCIPAL ===== */
    .app-container {
      width: 100%;
      max-width: 1200px;
      background: var(--light);
      border-radius: 28px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      border: 1px solid var(--border-light);
      max-height: 98vh;
      overflow-y: auto;
    }

    h1 {
      color: white;
      font-size: clamp(20px, 5vw, 26px);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 i {
      color: var(--primary);
      background: rgba(22, 224, 134, 0.1);
      padding: 10px;
      border-radius: 16px;
    }

    /* ===== NAVEGACI√ìN ===== */
    .nav-tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .nav-tab {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: clamp(14px, 4vw, 16px);
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .nav-tab.active {
      background: var(--primary);
      color: var(--darker);
    }

    /* ===== LAYOUT HORIZONTAL COMPACTO ===== */
    .row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .col-camara {
      flex: 1;
      min-width: 280px;
    }

    .col-resultado {
      flex: 1;
      min-width: 280px;
    }

    /* ===== C√ÅMARA - SIN ESPEJO - TAMA√ëO COMPACTO ===== */
    .camara-wrapper {
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--primary);
      aspect-ratio: 4/3;
      width: 100%;
    }

    #videoFacial {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(1); /* SIN ESPEJO - izquierda es izquierda */
    }

    .camara-badge {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: var(--primary);
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--primary);
      backdrop-filter: blur(4px);
    }

    /* ===== CONTENEDOR DE RESULTADO HORIZONTAL ELEGANTE ===== */
    .resultado-card {
      background: var(--dark);
      border-radius: 16px;
      padding: 20px;
      height: 100%;
      border-left: 5px solid;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .resultado-existe {
      border-left-color: var(--primary);
      background: linear-gradient(145deg, var(--dark), #14262e);
    }

    .resultado-no-existe {
      border-left-color: var(--danger);
    }

    .info-horizontal {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    /* FOTO */
    .foto-colaborador {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      background: var(--secondary);
    }

    .foto-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 40px;
      border: 3px dashed var(--primary);
    }

    /* DATOS */
    .detalles-colaborador {
      flex: 1;
    }

    .nombre-colaborador {
      color: white;
      font-size: clamp(18px, 4vw, 24px);
      font-weight: bold;
      margin-bottom: 5px;
    }

    .codigo-colaborador {
      color: var(--primary);
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: 600;
      margin-bottom: 10px;
    }

    .tipo-registro {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .entrada {
      background: var(--primary);
      color: var(--darker);
    }

    .salida {
      background: var(--danger);
      color: white;
    }

    .hora-registro {
      color: var(--text-muted);
      font-size: 15px;
      margin-top: 5px;
    }

    /* MENSAJE DE BLOQUEO */
    .bloqueo-mensaje {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid var(--danger);
      border-radius: 12px;
      padding: 12px;
      margin-top: 15px;
      color: var(--danger);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* BOTONES */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn-gris {
      background: var(--secondary);
      color: white;
      width: 100%;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
    }

    .link-registro {
      text-align: center;
      margin-top: 20px;
    }

    .link-registro a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
    }

    /* ===== TOAST Y LOADING ===== */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 20px;
      right: 20px;
      background: rgba(22, 224, 134, 0.95);
      color: white;
      padding: 16px 20px;
      border-radius: 50px;
      text-align: center;
      font-weight: bold;
      display: none;
      z-index: 10000;
      backdrop-filter: blur(10px);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30000;
    }

    .spinner {
      border: 5px solid rgba(22, 224, 134, 0.2);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== RESPONSIVE M√ìVIL ===== */
    @media (max-width: 768px) {
      .app-container {
        padding: 15px;
        border-radius: 20px;
      }

      .col-camara, .col-resultado {
        min-width: 100%;
      }

      .info-horizontal {
        flex-direction: column;
        text-align: center;
      }

      .foto-colaborador, .foto-placeholder {
        width: 80px;
        height: 80px;
      }

      .camara-badge {
        padding: 4px 10px;
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .foto-colaborador, .foto-placeholder {
        width: 70px;
        height: 70px;
      }

      .nombre-colaborador {
        font-size: 18px;
      }

      .codigo-colaborador {
        font-size: 14px;
      }
    }

    /* ===== TIMER ===== */
    .timer-badge {
      background: rgba(255,255,255,0.1);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>

  <!-- LOADING -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="color: white; font-size: 18px;">Cargando modelos faciales...</div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toastNotification"></div>

  <div class="app-container">
    <!-- NAVEGACI√ìN -->
    <div class="nav-tabs">
      <button id="navAsistenciaBtn" class="nav-tab active">
        <i class="fas fa-camera"></i> Asistencia
      </button>
      <button id="navRegistroLinkBtn" class="nav-tab">
        <i class="fas fa-user-plus"></i> Registro
      </button>
    </div>

    <h1>
      <i class="fas fa-clock"></i> 
      Control de Asistencia
    </h1>

    <!-- LAYOUT HORIZONTAL COMPACTO -->
    <div class="row">
      <!-- COLUMNA C√ÅMARA (M√ÅS PEQUE√ëA) -->
      <div class="col-camara">
        <div class="camara-wrapper">
          <video id="videoFacial" autoplay muted playsinline></video>
          <div class="camara-badge">
            <i class="fas fa-face-smile"></i> ESCANEANDO...
          </div>
        </div>
        <button id="btnReiniciar" class="btn btn-gris btn-small" style="margin-top: 10px;">
          <i class="fas fa-sync-alt"></i> Reiniciar c√°mara
        </button>
      </div>

      <!-- COLUMNA RESULTADO (HORIZONTAL ELEGANTE) -->
      <div class="col-resultado">
        <div id="resultadoCard" class="resultado-card" style="border-left-color: #f39c12;">
          <div id="infoContenido" class="info-horizontal">
            
            <!-- FOTO -->
            <div id="fotoContainer">
              <div class="foto-placeholder" id="fotoPlaceholder">
                <i class="fas fa-user"></i>
              </div>
              <img id="fotoColaborador" class="foto-colaborador" style="display: none;">
            </div>

            <!-- DETALLES -->
            <div class="detalles-colaborador">
              <div id="nombreDisplay" class="nombre-colaborador" style="color: #f39c12;">
                Esperando rostro...
              </div>
              <div id="codigoDisplay" class="codigo-colaborador" style="color: #f39c12;">
                <i class="fas fa-hourglass-half"></i>
              </div>
              <div id="tipoDisplay" class="tipo-registro" style="display: none;"></div>
              <div id="horaDisplay" class="hora-registro">
                <i class="fas fa-clock"></i> 
                <span id="horaTexto">--:--:--</span>
              </div>
              
              <!-- Mensaje de bloqueo (se muestra cuando hay escaneo repetido) -->
              <div id="bloqueoMensaje" class="bloqueo-mensaje" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="bloqueoTexto"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOT√ìN IR A REGISTRO -->
    <div class="link-registro">
      <a href="#" id="irARegistroLink">
        <i class="fas fa-user-plus"></i> Registrar nuevo colaborador
      </a>
    </div>
  </div>

  <script type="module">
    // ============================================================
    // FIREBASE - CONFIGURACI√ìN
    // ============================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      addDoc,
      Timestamp,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
      measurementId: "G-HJNZXRENE9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ============================================================
    // VARIABLES GLOBALES
    // ============================================================
    let modelosCargados = false;
    let streamVideo = null;
    
    // Colaboradores desde colecci√≥n "Ponche"
    let colaboradoresRegistrados = [];
    
    // Control de escaneos repetidos - 60 SEGUNDOS
    let ultimoEscaneo = {
      colaboradorId: null,
      timestamp: 0,
      tipo: null
    };
    
    let timeoutResultado = null;
    let intervaloDeteccion = null;
    
    // Elementos DOM
    const video = document.getElementById('videoFacial');
    const btnReiniciar = document.getElementById('btnReiniciar');
    const navAsistenciaBtn = document.getElementById('navAsistenciaBtn');
    const navRegistroLinkBtn = document.getElementById('navRegistroLinkBtn');
    const irARegistroLink = document.getElementById('irARegistroLink');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const toast = document.getElementById('toastNotification');
    
    // Elementos de resultado
    const nombreDisplay = document.getElementById('nombreDisplay');
    const codigoDisplay = document.getElementById('codigoDisplay');
    const tipoDisplay = document.getElementById('tipoDisplay');
    const horaTexto = document.getElementById('horaTexto');
    const fotoColaborador = document.getElementById('fotoColaborador');
    const fotoPlaceholder = document.getElementById('fotoPlaceholder');
    const resultadoCard = document.getElementById('resultadoCard');
    const bloqueoMensaje = document.getElementById('bloqueoMensaje');
    const bloqueoTexto = document.getElementById('bloqueoTexto');

    // ============================================================
    // FUNCIONES UTILITARIAS
    // ============================================================
    function mostrarLoading(mensaje = 'Cargando...') {
      loadingText.textContent = mensaje;
      loadingOverlay.style.display = 'flex';
    }

    function ocultarLoading() {
      loadingOverlay.style.display = 'none';
    }

    function mostrarToast(msg, tipo = 'success') {
      toast.textContent = msg;
      toast.style.background = tipo === 'success' ? 'rgba(22, 224, 134, 0.95)' : 
                             tipo === 'error' ? 'rgba(231, 76, 60, 0.95)' : 
                             'rgba(243, 156, 18, 0.95)';
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 4000);
    }

    function formatearHora(date) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function actualizarHora() {
      const ahora = new Date();
      horaTexto.textContent = formatearHora(ahora);
    }
    setInterval(actualizarHora, 1000);

    // Limpiar resultado despu√©s de 60 segundos
    function limpiarResultado() {
      if (timeoutResultado) clearTimeout(timeoutResultado);
      timeoutResultado = setTimeout(() => {
        nombreDisplay.textContent = 'Esperando rostro...';
        nombreDisplay.style.color = '#f39c12';
        codigoDisplay.innerHTML = '<i class="fas fa-hourglass-half"></i> Col√≥cate frente a la c√°mara';
        codigoDisplay.style.color = '#f39c12';
        tipoDisplay.style.display = 'none';
        bloqueoMensaje.style.display = 'none';
        
        fotoColaborador.style.display = 'none';
        fotoPlaceholder.style.display = 'flex';
        fotoPlaceholder.style.borderColor = '#f39c12';
        fotoPlaceholder.innerHTML = '<i class="fas fa-user" style="color: #f39c12;"></i>';
        
        resultadoCard.className = 'resultado-card';
        resultadoCard.style.borderLeftColor = '#f39c12';
      }, 60000); // 60 segundos
    }

    // ============================================================
    // NAVEGACI√ìN
    // ============================================================
    function irARegistro() {
      window.location.href = 'registro-facial.html';
    }

    navRegistroLinkBtn.addEventListener('click', irARegistro);
    irARegistroLink.addEventListener('click', (e) => {
      e.preventDefault();
      irARegistro();
    });

    // ============================================================
    // 1. CARGAR MODELOS
    // ============================================================
    async function cargarModelosFaceAPI() {
      mostrarLoading('Cargando modelos faciales...');
      
      try {
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        modelosCargados = true;
        ocultarLoading();
        return true;
      } catch (error) {
        try {
          const FALLBACK_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';
          await faceapi.nets.tinyFaceDetector.loadFromUri(FALLBACK_URL);
          await faceapi.nets.faceLandmark68Net.loadFromUri(FALLBACK_URL);
          await faceapi.nets.faceRecognitionNet.loadFromUri(FALLBACK_URL);
          
          modelosCargados = true;
          ocultarLoading();
          return true;
        } catch (fallbackError) {
          ocultarLoading();
          mostrarToast('No se pudieron cargar los modelos', 'error');
          return false;
        }
      }
    }

    // ============================================================
    // 2. CARGAR COLABORADORES DESDE "Ponche"
    // ============================================================
    async function cargarColaboradores() {
      try {
        const collRef = collection(db, 'Ponche');
        const q = query(collRef);
        const snapshot = await getDocs(q);
        
        colaboradoresRegistrados = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          
          const descriptores = [];
          
          if (data.facialDescriptorFrontal) descriptores.push(new Float32Array(data.facialDescriptorFrontal));
          if (data.facialDescriptorIzquierdo) descriptores.push(new Float32Array(data.facialDescriptorIzquierdo));
          if (data.facialDescriptorDerecho) descriptores.push(new Float32Array(data.facialDescriptorDerecho));
          if (data.facialDescriptorArriba) descriptores.push(new Float32Array(data.facialDescriptorArriba));
          if (data.facialDescriptorAbajo) descriptores.push(new Float32Array(data.facialDescriptorAbajo));
          
          if (descriptores.length > 0) {
            const nombreCompleto = `${data.firstName || ''} ${data.lastName || ''}`.trim() || data.username || 'Colaborador';
            
            colaboradoresRegistrados.push({
              id: doc.id,
              descriptores: descriptores,
              nombre: nombreCompleto,
              username: data.username || '',
              codigo: data.uniqueProfileId || `RTM-${doc.id.slice(-5)}`,
              fotoBase64: data.fotoBase64 || '',
              horasDiarias: data.horasDiarias || 8,
              pin: data.pin || '1234'
            });
          }
        });
        
        return colaboradoresRegistrados.length;
      } catch (error) {
        console.error('Error cargando colaboradores:', error);
        return 0;
      }
    }

    // ============================================================
    // 3. INICIAR C√ÅMARA (SIN ESPEJO)
    // ============================================================
    async function iniciarCamara() {
      try {
        if (streamVideo) {
          streamVideo.getTracks().forEach(track => track.stop());
        }
        
        streamVideo = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          }
        });
        
        video.srcObject = streamVideo;
        await video.play();
        
        // SIN ESPEJO - izquierda es izquierda, derecha es derecha
        video.style.transform = 'scaleX(1)';
        
        return true;
      } catch (error) {
        mostrarToast('No se pudo acceder a la c√°mara', 'error');
        return false;
      }
    }

    // ============================================================
    // 4. COMPARAR CONTRA TODOS LOS √ÅNGULOS
    // ============================================================
    async function compararConTodosAngulos(descriptorDetectado) {
      let mejorCoincidencia = null;
      let menorDistancia = 1.0;
      let mejorColaborador = null;
      
      for (const colaborador of colaboradoresRegistrados) {
        for (const descriptorGuardado of colaborador.descriptores) {
          const distancia = faceapi.euclideanDistance(descriptorDetectado, descriptorGuardado);
          
          if (distancia < menorDistancia) {
            menorDistancia = distancia;
            mejorColaborador = colaborador;
          }
        }
      }
      
      return { mejorColaborador, menorDistancia };
    }

    // ============================================================
    // 5. DETERMINAR SI ES ENTRADA O SALIDA
    // ============================================================
    async function determinarTipoRegistro(colaboradorId) {
      try {
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', colaboradorId),
          orderBy('timestamp', 'desc'),
          limit(1)
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          return 'entry';
        }
        
        const ultimoRegistro = snapshot.docs[0].data();
        return ultimoRegistro.type === 'entry' ? 'exit' : 'entry';
        
      } catch (error) {
        console.error('Error determinando tipo:', error);
        return 'entry';
      }
    }

    // ============================================================
    // 6. REGISTRAR ASISTENCIA
    // ============================================================
    async function registrarAsistencia(colaborador, tipo) {
      try {
        const registroData = {
          collaboratorId: colaborador.id,
          collaboratorName: colaborador.nombre,
          collaboratorCode: colaborador.codigo,
          timestamp: Timestamp.now(),
          date: new Date().toISOString(),
          type: tipo,
          method: 'auto',
          horasDiarias: colaborador.horasDiarias || 8
        };

        await addDoc(collection(db, 'facialAttendance'), registroData);
        return true;
      } catch (error) {
        console.error('Error registrando:', error);
        return false;
      }
    }

    // ============================================================
    // 7. MOSTRAR COLABORADOR DETECTADO
    // ============================================================
    async function mostrarColaboradorDetectado(colaborador, distancia) {
      // Limpiar timeout anterior
      if (timeoutResultado) clearTimeout(timeoutResultado);
      
      const ahora = Date.now();
      
      // VERIFICAR ESCANEO REPETIDO - 60 SEGUNDOS
      if (ultimoEscaneo.colaboradorId === colaborador.id && ahora - ultimoEscaneo.timestamp < 60000) {
        const segundosRestantes = Math.ceil(60 - ((ahora - ultimoEscaneo.timestamp) / 1000));
        
        // Mostrar mensaje de advertencia
        bloqueoMensaje.style.display = 'flex';
        bloqueoTexto.innerHTML = `Ya realiz√≥ ${ultimoEscaneo.tipo === 'entry' ? 'entrada' : 'salida'} hace menos de 60 segundos. Espere ${segundosRestantes} segundos. Esto puede causar anomal√≠as en su ponche.`;
        
        resultadoCard.className = 'resultado-card';
        resultadoCard.style.borderLeftColor = '#e74c3c';
        
        mostrarToast(`‚è≥ Espere ${segundosRestantes} segundos`, 'warning');
        return;
      }
      
      // Ocultar mensaje de bloqueo
      bloqueoMensaje.style.display = 'none';
      
      // Determinar tipo
      const tipo = await determinarTipoRegistro(colaborador.id);
      
      // Registrar
      const registrado = await registrarAsistencia(colaborador, tipo);
      
      if (!registrado) {
        mostrarToast('Error al registrar', 'error');
        return;
      }
      
      // Actualizar √∫ltimo escaneo
      ultimoEscaneo = {
        colaboradorId: colaborador.id,
        timestamp: ahora,
        tipo: tipo
      };
      
      // MOSTRAR RESULTADO
      resultadoCard.className = 'resultado-card resultado-existe';
      nombreDisplay.style.color = '#16e086';
      nombreDisplay.textContent = colaborador.nombre;
      
      codigoDisplay.style.color = '#16e086';
      codigoDisplay.innerHTML = `<i class="fas fa-id-card"></i> ${colaborador.codigo}`;
      
      tipoDisplay.style.display = 'inline-block';
      tipoDisplay.className = `tipo-registro ${tipo === 'entry' ? 'entrada' : 'salida'}`;
      tipoDisplay.innerHTML = tipo === 'entry' ? '‚úÖ ENTRADA REGISTRADA' : 'üö™ SALIDA REGISTRADA';
      
      const ahoraDate = new Date();
      horaTexto.textContent = formatearHora(ahoraDate);
      
      // Foto
      if (colaborador.fotoBase64) {
        fotoColaborador.src = colaborador.fotoBase64;
        fotoColaborador.style.display = 'block';
        fotoPlaceholder.style.display = 'none';
      } else {
        fotoColaborador.style.display = 'none';
        fotoPlaceholder.style.display = 'flex';
        fotoPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
      }
      
      mostrarToast(`${tipo === 'entry' ? '‚úÖ Entrada' : 'üö™ Salida'}: ${colaborador.nombre}`, 'success');
      
      // Programar limpieza a los 60 segundos
      limpiarResultado();
    }

    // ============================================================
    // 8. MOSTRAR ROSTRO NO REGISTRADO
    // ============================================================
    function mostrarRostroNoRegistrado() {
      if (timeoutResultado) clearTimeout(timeoutResultado);
      
      resultadoCard.className = 'resultado-card resultado-no-existe';
      nombreDisplay.style.color = '#e74c3c';
      nombreDisplay.textContent = '‚ùå No registrado';
      
      codigoDisplay.style.color = '#e74c3c';
      codigoDisplay.innerHTML = '<i class="fas fa-user-slash"></i> Rostro no existe en Ponche';
      
      tipoDisplay.style.display = 'none';
      bloqueoMensaje.style.display = 'none';
      
      fotoColaborador.style.display = 'none';
      fotoPlaceholder.style.display = 'flex';
      fotoPlaceholder.style.borderColor = '#e74c3c';
      fotoPlaceholder.innerHTML = '<i class="fas fa-ban" style="color: #e74c3c; font-size: 40px;"></i>';
      
      limpiarResultado();
    }

    // ============================================================
    // 9. MOSTRAR ESPERANDO ROSTRO
    // ============================================================
    function mostrarEsperandoRostro() {
      if (nombreDisplay.textContent !== 'Esperando rostro...' && 
          nombreDisplay.textContent !== '‚ùå No registrado') {
        return;
      }
      
      resultadoCard.className = 'resultado-card';
      resultadoCard.style.borderLeftColor = '#f39c12';
      nombreDisplay.style.color = '#f39c12';
      nombreDisplay.textContent = 'üë§ Esperando rostro...';
      
      codigoDisplay.style.color = '#f39c12';
      codigoDisplay.innerHTML = '<i class="fas fa-hourglass-half"></i> Col√≥cate frente a la c√°mara';
      
      tipoDisplay.style.display = 'none';
      bloqueoMensaje.style.display = 'none';
      
      fotoColaborador.style.display = 'none';
      fotoPlaceholder.style.display = 'flex';
      fotoPlaceholder.style.borderColor = '#f39c12';
      fotoPlaceholder.innerHTML = '<i class="fas fa-user" style="color: #f39c12;"></i>';
    }

    // ============================================================
    // 10. DETECCI√ìN CONTINUA
    // ============================================================
    function iniciarDeteccionContinua() {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      
      if (!modelosCargados || colaboradoresRegistrados.length === 0) return;
      
      intervaloDeteccion = setInterval(async () => {
        if (!video || video.paused || video.ended) return;
        
        try {
          const detecciones = await faceapi.detectAllFaces(video, 
            new faceapi.TinyFaceDetectorOptions({
              inputSize: 224,
              scoreThreshold: 0.5
            }))
            .withFaceLandmarks()
            .withFaceDescriptors();
          
          actualizarHora();
          
          if (detecciones.length > 0) {
            const descriptorDetectado = detecciones[0].descriptor;
            
            const { mejorColaborador, menorDistancia } = await compararConTodosAngulos(descriptorDetectado);
            
            const UMBRAL = 0.58;
            
            if (mejorColaborador && menorDistancia < UMBRAL) {
              await mostrarColaboradorDetectado(mejorColaborador, menorDistancia);
            } else {
              mostrarRostroNoRegistrado();
            }
          } else {
            mostrarEsperandoRostro();
          }
        } catch (e) {
          console.warn('Error en detecci√≥n:', e);
        }
      }, 700);
    }

    // ============================================================
    // 11. INICIALIZACI√ìN
    // ============================================================
    async function inicializarSistema() {
      const modelosOK = await cargarModelosFaceAPI();
      if (!modelosOK) return;
      
      const cantidad = await cargarColaboradores();
      
      const camaraOK = await iniciarCamara();
      if (!camaraOK) return;
      
      if (cantidad > 0) {
        iniciarDeteccionContinua();
        mostrarToast(`‚úÖ ${cantidad} colaboradores en sistema`, 'success');
      } else {
        mostrarToast('No hay colaboradores registrados', 'warning');
      }
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    window.addEventListener('load', inicializarSistema);
    
    btnReiniciar.addEventListener('click', async () => {
      await iniciarCamara();
      mostrarToast('C√°mara reiniciada', 'success');
    });

    window.addEventListener('beforeunload', () => {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      if (streamVideo) streamVideo.getTracks().forEach(track => track.stop());
      if (timeoutResultado) clearTimeout(timeoutResultado);
    });
  </script>
</body>
</html>
