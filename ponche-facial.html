<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administración Colaboradores - TensorFlow.js</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    :root { 
      --primary: #16e086; 
      --primary-dark: #0da85c; 
      --secondary: #2e4a55; 
      --dark: #0e1c22; 
      --darker: #0a1519; 
      --danger: #e74c3c; 
      --warning: #f39c12; 
      --text: #ffffff; 
    }
    
    body { 
      background: linear-gradient(135deg, #0e1c22 0%, #1a2f38 100%); 
      min-height: 100vh; 
      padding: 30px; 
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
    }
    
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 30px; 
      color: white; 
    }
    
    .header h1 { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
    }
    
    .header h1 i { 
      color: var(--primary); 
    }
    
    .btn { 
      padding: 12px 25px; 
      border: none; 
      border-radius: 50px; 
      font-weight: bold; 
      cursor: pointer; 
      display: inline-flex; 
      align-items: center; 
      gap: 10px; 
      transition: all 0.3s; 
      text-decoration: none; 
    }
    
    .btn-primary { 
      background: var(--primary); 
      color: var(--darker); 
    }
    
    .btn-primary:hover { 
      background: var(--primary-dark); 
      transform: scale(1.05); 
    }
    
    .btn-secondary { 
      background: var(--secondary); 
      color: white; 
    }
    
    .panel-grid { 
      display: grid; 
      grid-template-columns: 1fr 1.5fr; 
      gap: 30px; 
    }
    
    @media (max-width: 1000px) { 
      .panel-grid { 
        grid-template-columns: 1fr; 
      } 
    }
    
    .card { 
      background: rgba(255,255,255,0.1); 
      backdrop-filter: blur(10px); 
      border-radius: 30px; 
      padding: 30px; 
      border: 1px solid rgba(22, 224, 134, 0.3); 
      color: white; 
      margin-bottom: 30px; 
    }
    
    .card h2 { 
      margin-bottom: 20px; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      color: var(--primary); 
    }
    
    .form-group { 
      margin-bottom: 20px; 
    }
    
    .form-group label { 
      display: block; 
      margin-bottom: 8px; 
      color: rgba(255,255,255,0.9); 
    }
    
    .form-group label i { 
      color: var(--primary); 
      margin-right: 8px; 
    }
    
    .form-control, .form-select { 
      width: 100%; 
      padding: 14px 20px; 
      background: rgba(0,0,0,0.3); 
      border: 1px solid rgba(255,255,255,0.2); 
      border-radius: 15px; 
      color: white; 
      font-size: 16px; 
    }
    
    .form-control:focus, .form-select:focus { 
      outline: none; 
      border-color: var(--primary); 
      background: rgba(0,0,0,0.5); 
    }
    
    .form-select option { 
      background: var(--dark); 
    }
    
    .camera-mini { 
      position: relative; 
      width: 100%; 
      max-width: 300px; 
      margin: 0 auto; 
      border-radius: 15px; 
      overflow: hidden; 
      border: 3px solid var(--primary); 
    }
    
    #videoAdmin { 
      width: 100%; 
      display: block; 
    }
    
    .btn-captura { 
      background: var(--primary); 
      color: var(--darker); 
      border: none; 
      padding: 12px; 
      border-radius: 30px; 
      font-weight: bold; 
      margin-top: 15px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 10px; 
      width: 100%; 
    }
    
    .foto-preview { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      margin-top: 20px; 
    }
    
    #previewFotoAdmin { 
      width: 120px; 
      height: 120px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 4px solid var(--primary); 
      margin-bottom: 10px; 
    }
    
    .table-container { 
      overflow-x: auto; 
      max-height: 600px; 
      overflow-y: auto; 
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    
    th { 
      position: sticky; 
      top: 0; 
      background: rgba(14, 28, 34, 0.95); 
      color: var(--primary); 
      padding: 15px; 
      text-align: left; 
      border-bottom: 2px solid var(--primary); 
    }
    
    td { 
      padding: 15px; 
      border-bottom: 1px solid rgba(255,255,255,0.1); 
    }
    
    .empleado-avatar { 
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      object-fit: cover; 
    }
    
    .badge { 
      padding: 5px 12px; 
      border-radius: 30px; 
      font-size: 12px; 
      font-weight: bold; 
    }
    
    .badge-success { 
      background: var(--primary); 
      color: var(--darker); 
    }
    
    .badge-danger { 
      background: var(--danger); 
      color: white; 
    }
    
    .badge-warning { 
      background: var(--warning); 
      color: var(--darker); 
    }
    
    .acciones { 
      display: flex; 
      gap: 10px; 
    }
    
    .acciones button { 
      background: none; 
      border: none; 
      color: white; 
      cursor: pointer; 
      font-size: 16px; 
      padding: 5px; 
    }
    
    .acciones button:hover { 
      color: var(--primary); 
    }
    
    .toast { 
      position: fixed; 
      bottom: 30px; 
      left: 50%; 
      transform: translateX(-50%); 
      padding: 15px 30px; 
      border-radius: 50px; 
      background: rgba(0,0,0,0.9); 
      border: 1px solid var(--primary); 
      color: white; 
      z-index: 200; 
      display: none; 
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-cog"></i> Panel de Administración</h1>
      <div>
        <a href="index.html" class="btn btn-secondary">
          <i class="fas fa-camera"></i> Asistencia
        </a>
        <a href="reportes.html" class="btn btn-secondary">
          <i class="fas fa-chart-bar"></i> Reportes
        </a>
      </div>
    </div>

    <div class="toast" id="toastAdmin"></div>

    <div class="panel-grid">
      <!-- FORMULARIO -->
      <div class="card">
        <h2 id="formTitle"><i class="fas fa-user-plus"></i> Registrar Colaborador</h2>
        
        <form id="colaboradorForm">
          <input type="hidden" id="colaboradorId" value="">
          
          <div class="form-group">
            <label><i class="fas fa-id-card"></i> Código Empleado *</label>
            <input type="text" id="username" class="form-control" placeholder="Ej: EMP001" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-user"></i> Nombre *</label>
            <input type="text" id="firstName" class="form-control" placeholder="Nombre" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-user"></i> Apellido *</label>
            <input type="text" id="lastName" class="form-control" placeholder="Apellido" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-envelope"></i> Email *</label>
            <input type="email" id="email" class="form-control" placeholder="correo@empresa.com" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-phone"></i> Teléfono</label>
            <input type="text" id="phone" class="form-control" placeholder="+56 9 1234 5678">
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-building"></i> Departamento</label>
            <select id="departamento" class="form-select">
              <option value="">Seleccionar</option>
              <option value="Ventas">Ventas</option>
              <option value="Marketing">Marketing</option>
              <option value="TI">Tecnología</option>
              <option value="RRHH">Recursos Humanos</option>
              <option value="Operaciones">Operaciones</option>
            </select>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-clock"></i> Turno (horas diarias) *</label>
            <select id="turnoHoras" class="form-select" required>
              <option value="8">8 horas (Jornada normal)</option>
              <option value="12">12 horas (Jornada extendida)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-camera"></i> Foto para Reconocimiento *</label>
            <div class="camera-mini">
              <video id="videoAdmin" autoplay playsinline></video>
            </div>
            <button type="button" id="btnCapturarFotoAdmin" class="btn-captura">
              <i class="fas fa-camera"></i> CAPTURAR FOTO
            </button>
            
            <div id="fotoPreviewContainerAdmin" style="display: none;" class="foto-preview">
              <img id="previewFotoAdmin" src="" alt="Vista previa">
              <button type="button" id="btnRetomarFotoAdmin" style="background: none; border: none; color: var(--primary); cursor: pointer;">
                <i class="fas fa-redo-alt"></i> Tomar otra foto
              </button>
            </div>
            <input type="hidden" id="fotoBase64">
          </div>
          
          <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="submit" id="btnGuardar" class="btn btn-primary" style="flex: 1;">
              <i class="fas fa-save"></i> GUARDAR
            </button>
            <button type="button" id="btnCancelar" class="btn btn-secondary" style="flex: 0.3;">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </form>
      </div>
      
      <!-- LISTA COLABORADORES -->
      <div class="card">
        <h2><i class="fas fa-users"></i> Colaboradores</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Foto</th>
                <th>Código</th>
                <th>Nombre</th>
                <th>Turno</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaColaboradores">
              <tr><td colspan="6" style="text-align: center;">Cargando colaboradores...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      addDoc, 
      updateDoc,
      doc,
      getDoc,
      query,
      where,
      orderBy,
      Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ============= CONFIGURACIÓN FIREBASE =============
    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ============= VARIABLES =============
    let video = document.getElementById('videoAdmin');
    let stream = null;
    let editandoId = null;

    // ============= TOAST =============
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toastAdmin');
      toast.textContent = message;
      toast.style.background = type === 'success' ? 'rgba(22, 224, 134, 0.2)' : 'rgba(231, 76, 60, 0.2)';
      toast.style.border = `1px solid ${type === 'success' ? 'var(--primary)' : 'var(--danger)'}`;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    // ============= CÁMARA =============
    async function iniciarCamara() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 640, height: 480, facingMode: 'user' } 
        });
        video.srcObject = stream;
      } catch (error) {
        console.error('Error cámara:', error);
        showToast('No se pudo acceder a la cámara', 'error');
      }
    }

    function detenerCamara() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
    }

    // ============= CAPTURAR FOTO =============
    function capturarFoto() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const base64 = canvas.toDataURL('image/jpeg', 0.9);
      
      document.getElementById('previewFotoAdmin').src = base64;
      document.getElementById('fotoPreviewContainerAdmin').style.display = 'flex';
      document.getElementById('fotoBase64').value = base64;
      document.querySelector('.camera-mini').style.display = 'none';
      document.getElementById('btnCapturarFotoAdmin').style.display = 'none';
    }

    // ============= VALIDAR CÓDIGO ÚNICO =============
    async function validarCodigoUnico(codigo, idExcluir = null) {
      const q = query(collection(db, 'Ponche'), where('username', '==', codigo));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return true;
      if (idExcluir && snapshot.docs[0].id === idExcluir) return true;
      return false;
    }

    // ============= CARGAR COLABORADORES =============
    async function cargarColaboradores() {
      const tbody = document.getElementById('tablaColaboradores');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Cargando colaboradores...</td></tr>';
      
      try {
        const q = query(collection(db, 'Ponche'), orderBy('firstName'));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay colaboradores</td></tr>';
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const nombre = `${data.firstName || ''} ${data.lastName || ''}`.trim();
          const foto = data.fotoBase64 || 'https://via.placeholder.com/50';
          const turno = data.turnoHoras || 8;
          const activo = data.activo !== false;
          
          html += `
            <tr>
              <td><img src="${foto}" class="empleado-avatar" onerror="this.src='https://via.placeholder.com/50'"></td>
              <td><strong>${data.username || 'N/A'}</strong></td>
              <td>${nombre || 'N/A'}</td>
              <td><span class="badge ${turno === 12 ? 'badge-warning' : 'badge-success'}">${turno}h</span></td>
              <td><span class="badge ${activo ? 'badge-success' : 'badge-danger'}">${activo ? 'Activo' : 'Inactivo'}</span></td>
              <td class="acciones">
                <button onclick="editarColaborador('${doc.id}')" title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="toggleEstado('${doc.id}', ${activo})" title="${activo ? 'Desactivar' : 'Activar'}">
                  <i class="fas ${activo ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                </button>
              </td>
            </tr>
          `;
        });
        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error cargando:', error);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--danger);">Error al cargar</td></tr>';
      }
    }

    // ============= EDITAR =============
    window.editarColaborador = async (id) => {
      try {
        const docSnap = await getDoc(doc(db, 'Ponche', id));
        if (docSnap.exists()) {
          const data = docSnap.data();
          
          document.getElementById('colaboradorId').value = id;
          document.getElementById('username').value = data.username || '';
          document.getElementById('firstName').value = data.firstName || '';
          document.getElementById('lastName').value = data.lastName || '';
          document.getElementById('email').value = data.email || '';
          document.getElementById('phone').value = data.phone || '';
          document.getElementById('departamento').value = data.departamento || '';
          document.getElementById('turnoHoras').value = data.turnoHoras || 8;
          
          if (data.fotoBase64) {
            document.getElementById('previewFotoAdmin').src = data.fotoBase64;
            document.getElementById('fotoPreviewContainerAdmin').style.display = 'flex';
            document.getElementById('fotoBase64').value = data.fotoBase64;
            document.querySelector('.camera-mini').style.display = 'none';
            document.getElementById('btnCapturarFotoAdmin').style.display = 'none';
          }
          
          document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-edit"></i> Editar Colaborador';
          editandoId = id;
        }
      } catch (error) {
        console.error('Error editando:', error);
        showToast('Error al cargar datos', 'error');
      }
    };

    // ============= TOGGLE ESTADO =============
    window.toggleEstado = async (id, estadoActual) => {
      try {
        await updateDoc(doc(db, 'Ponche', id), { 
          activo: !estadoActual,
          updatedAt: Timestamp.now()
        });
        showToast(`Colaborador ${!estadoActual ? 'activado' : 'desactivado'}`, 'success');
        cargarColaboradores();
      } catch (error) {
        console.error('Error cambiando estado:', error);
        showToast('Error al cambiar estado', 'error');
      }
    };

    // ============= RESET FORM =============
    function resetFormulario() {
      document.getElementById('colaboradorForm').reset();
      document.getElementById('colaboradorId').value = '';
      document.getElementById('fotoBase64').value = '';
      document.getElementById('fotoPreviewContainerAdmin').style.display = 'none';
      document.querySelector('.camera-mini').style.display = 'block';
      document.getElementById('btnCapturarFotoAdmin').style.display = 'flex';
      document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-plus"></i> Registrar Colaborador';
      editandoId = null;
    }

    // ============= EVENTOS =============
    document.getElementById('btnCapturarFotoAdmin').addEventListener('click', capturarFoto);
    
    document.getElementById('btnRetomarFotoAdmin').addEventListener('click', () => {
      document.querySelector('.camera-mini').style.display = 'block';
      document.getElementById('btnCapturarFotoAdmin').style.display = 'flex';
      document.getElementById('fotoPreviewContainerAdmin').style.display = 'none';
      document.getElementById('fotoBase64').value = '';
    });
    
    document.getElementById('btnCancelar').addEventListener('click', resetFormulario);

    // ============= GUARDAR =============
    document.getElementById('colaboradorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btnGuardar = document.getElementById('btnGuardar');
      btnGuardar.disabled = true;
      btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GUARDANDO...';

      try {
        const username = document.getElementById('username').value.trim().toUpperCase();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const departamento = document.getElementById('departamento').value;
        const turnoHoras = parseInt(document.getElementById('turnoHoras').value);
        const fotoBase64 = document.getElementById('fotoBase64').value;

        if (!username || !firstName || !lastName || !email) {
          throw new Error('Complete todos los campos obligatorios');
        }

        if (!fotoBase64 && !editandoId) {
          throw new Error('Debe capturar una foto');
        }

        const codigoUnico = await validarCodigoUnico(username, editandoId);
        if (!codigoUnico) {
          throw new Error('El código ya existe');
        }

        const colaboradorData = {
          username,
          firstName,
          lastName,
          email,
          phone: phone || '',
          departamento: departamento || 'No asignado',
          turnoHoras,
          fotoBase64: fotoBase64 || null,
          activo: true,
          updatedAt: Timestamp.now()
        };

        if (editandoId) {
          await updateDoc(doc(db, 'Ponche', editandoId), colaboradorData);
          showToast('✅ Colaborador actualizado', 'success');
        } else {
          colaboradorData.createdAt = Timestamp.now();
          await addDoc(collection(db, 'Ponche'), colaboradorData);
          showToast('✅ Colaborador registrado', 'success');
        }

        resetFormulario();
        cargarColaboradores();

      } catch (error) {
        console.error('Error:', error);
        showToast('❌ ' + error.message, 'error');
      } finally {
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = '<i class="fas fa-save"></i> GUARDAR';
      }
    });

    // ============= INICIAR =============
    iniciarCamara();
    cargarColaboradores();

    window.addEventListener('beforeunload', detenerCamara);

    // Hacer funciones globales
    window.editarColaborador = window.editarColaborador;
    window.toggleEstado = window.toggleEstado;
  </script>
</body>
</html> 
