<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Asistencia Facial - Control Horario</title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- face-api.js -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    /* ===== RESET Y VARIABLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    :root {
      --primary: #16e086;
      --primary-dark: #0da85c;
      --secondary: #2e4a55;
      --dark: #0e1c22;
      --darker: #0a1519;
      --light: #1a2c33;
      --danger: #e74c3c;
      --warning: #f39c12;
      --text: #ffffff;
      --text-muted: rgba(255,255,255,0.6);
      --border: #2a3f48;
      --border-light: #3a5a66;
    }

    body {
      background: linear-gradient(145deg, var(--darker), var(--dark));
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      background: var(--light);
      border-radius: 28px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      border: 1px solid var(--border-light);
      max-height: 98vh;
      overflow-y: auto;
    }

    h1 {
      color: white;
      font-size: clamp(20px, 5vw, 26px);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 i {
      color: var(--primary);
      background: rgba(22, 224, 134, 0.1);
      padding: 10px;
      border-radius: 16px;
    }

    .nav-tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .nav-tab {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: clamp(14px, 4vw, 16px);
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .nav-tab.active {
      background: var(--primary);
      color: var(--darker);
    }

    /* ===== LAYOUT PRINCIPAL - RESULTADO SOBRE C√ÅMARA ===== */
    .main-layout {
      position: relative;
      width: 100%;
      margin-bottom: 20px;
    }

    .camara-section {
      position: relative;
      width: 100%;
    }

    .camara-wrapper {
      background: #000;
      border-radius: 24px;
      overflow: hidden;
      position: relative;
      border: 3px solid var(--primary);
      aspect-ratio: 16/9;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    #videoFacial {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(-1); /* CORREGIDO: Espejo para movimiento natural */
    }

    .camara-badge {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.85);
      color: var(--primary);
      padding: 8px 18px;
      border-radius: 40px;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--primary);
      backdrop-filter: blur(4px);
      z-index: 20;
    }

    /* ===== OVERLAY DE RESULTADO SOBRE LA C√ÅMARA ===== */
    .resultado-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(10, 21, 25, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 25px;
      border: 2px solid var(--primary);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      z-index: 30;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .resultado-overlay.hidden {
      display: none;
    }

    /* FOTO M√ÅS GRANDE EN EL OVERLAY */
    .overlay-foto {
      width: 100px;
      height: 100px;
      border-radius: 20px;
      object-fit: cover;
      border: 4px solid var(--primary);
      background: var(--secondary);
      flex-shrink: 0;
    }

    .overlay-foto-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 20px;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 48px;
      border: 4px dashed var(--primary);
      flex-shrink: 0;
    }

    .overlay-info {
      flex: 1;
    }

    .overlay-nombre {
      color: white;
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .overlay-codigo {
      color: var(--primary);
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .overlay-tipo {
      display: inline-block;
      padding: 8px 24px;
      border-radius: 40px;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .overlay-tipo.entrada {
      background: var(--primary);
      color: var(--darker);
    }

    .overlay-tipo.salida {
      background: var(--danger);
      color: white;
    }

    .overlay-hora {
      color: var(--text-muted);
      font-size: 16px;
      margin-top: 8px;
    }

    .overlay-confianza {
      background: rgba(255,255,255,0.1);
      padding: 6px 16px;
      border-radius: 30px;
      font-size: 14px;
      color: var(--text-muted);
      display: inline-block;
      margin-top: 8px;
    }

    .overlay-confianza.alta { color: #16e086; }
    .overlay-confianza.media { color: #f39c12; }
    .overlay-confianza.baja { color: #e74c3c; }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 40px;
      font-size: 15px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-gris {
      background: var(--secondary);
      color: white;
    }

    .btn-gris:hover {
      background: #3a5a66;
    }

    .btn-small {
      padding: 10px 20px;
      font-size: 14px;
    }

    .link-registro {
      text-align: center;
      margin-top: 30px;
    }

    .link-registro a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 20px;
      right: 20px;
      background: rgba(22, 224, 134, 0.95);
      color: white;
      padding: 16px 24px;
      border-radius: 50px;
      text-align: center;
      font-weight: bold;
      display: none;
      z-index: 10000;
      backdrop-filter: blur(10px);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30000;
    }

    .spinner {
      border: 5px solid rgba(22, 224, 134, 0.2);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .bloqueo-mensaje,
    .bloqueo-horas-mensaje {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid var(--danger);
      border-radius: 12px;
      padding: 12px;
      margin-top: 15px;
      color: var(--danger);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bloqueo-horas-mensaje {
      background: rgba(243, 156, 18, 0.2);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .resultado-overlay {
        flex-direction: column;
        text-align: center;
        padding: 15px;
      }
      
      .overlay-foto,
      .overlay-foto-placeholder {
        width: 80px;
        height: 80px;
      }
      
      .overlay-nombre { font-size: 22px; }
      .overlay-codigo { font-size: 18px; }
      .overlay-tipo { font-size: 16px; }
    }
  </style>
</head>
<body>

  <!-- LOADING -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="color: white; font-size: 18px;">Cargando modelos faciales...</div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toastNotification"></div>

  <!-- AUDIO PLAYER OCULTO -->
  <audio id="sonidoRegistro" preload="auto" style="display: none;"></audio>

  <div class="app-container">
    <!-- NAVEGACI√ìN -->
    <div class="nav-tabs">
      <button id="navAsistenciaBtn" class="nav-tab active">
        <i class="fas fa-camera"></i> Asistencia
      </button>
      <button id="navRegistroLinkBtn" class="nav-tab">
        <i class="fas fa-user-plus"></i> Registro
      </button>
    </div>

    <h1>
      <i class="fas fa-clock"></i> 
      Control de Asistencia
    </h1>

    <!-- LAYOUT PRINCIPAL: C√ÅMARA CON OVERLAY -->
    <div class="main-layout">
      <div class="camara-section">
        <div class="camara-wrapper">
          <video id="videoFacial" autoplay muted playsinline></video>
          <div class="camara-badge">
            <i class="fas fa-face-smile"></i> ESCANEANDO...
          </div>
        </div>
        
        <!-- OVERLAY DE RESULTADO (APARECE SOBRE LA C√ÅMARA) -->
        <div id="resultadoOverlay" class="resultado-overlay hidden">
          <!-- FOTO -->
          <div id="overlayFotoContainer">
            <div id="overlayFotoPlaceholder" class="overlay-foto-placeholder">
              <i class="fas fa-user"></i>
            </div>
            <img id="overlayFoto" class="overlay-foto" style="display: none;">
          </div>
          
          <!-- INFORMACI√ìN -->
          <div class="overlay-info">
            <div id="overlayNombre" class="overlay-nombre">Esperando rostro...</div>
            <div id="overlayCodigo" class="overlay-codigo">
              <i class="fas fa-hourglass-half"></i>
            </div>
            <div id="overlayTipo" class="overlay-tipo" style="display: none;"></div>
            <div id="overlayHora" class="overlay-hora">
              <i class="fas fa-clock"></i> 
              <span id="overlayHoraTexto">--:--:--</span>
            </div>
            <div id="overlayConfianza" class="overlay-confianza" style="display: none;"></div>
            
            <!-- MENSAJES DE BLOQUEO (DENTRO DEL OVERLAY) -->
            <div id="overlayBloqueoMensaje" class="bloqueo-mensaje hidden">
              <i class="fas fa-exclamation-triangle"></i>
              <span id="overlayBloqueoTexto"></span>
            </div>
            <div id="overlayBloqueoHoras" class="bloqueo-horas-mensaje hidden">
              <i class="fas fa-clock"></i>
              <span id="overlayBloqueoHorasTexto"></span>
            </div>
          </div>
        </div>
      </div>
      
      <button id="btnReiniciar" class="btn btn-gris btn-small" style="margin-top: 15px;">
        <i class="fas fa-sync-alt"></i> Reiniciar c√°mara
      </button>
    </div>

    <!-- BOT√ìN IR A REGISTRO -->
    <div class="link-registro">
      <a href="#" id="irARegistroLink">
        <i class="fas fa-user-plus"></i> Registrar nuevo colaborador
      </a>
    </div>
  </div>

  <script type="module">
    // ============================================================
    // FIREBASE - CONFIGURACI√ìN
    // ============================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      Timestamp,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
      measurementId: "G-HJNZXRENE9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ============================================================
    // VARIABLES GLOBALES - OPTIMIZADAS PARA VELOCIDAD Y PRECISI√ìN
    // ============================================================
    let modelosCargados = false;
    let streamVideo = null;
    
    // Colaboradores
    let colaboradoresRegistrados = [];
    
    // MAPAS DE CONTROL
    const escaneosPorColaborador = new Map();
    const cacheRegistrosDiarios = new Map();
    const cacheDescriptores = new Map(); // Cach√© de descriptores para velocidad
    
    // TIEMPOS
    const TIEMPO_BLOQUEO_HORAS = 4 * 60 * 60 * 1000;
    const UMBRAL_RECONOCIMIENTO = 0.42; // Balance entre velocidad y precisi√≥n
    const TIEMPO_MINIMO_ENTRE_REGISTROS = 60000; // 60 segundos
    
    // Control de rendimiento
    let ultimoDescriptorProcesado = null;
    let colaboradorActualEnProceso = null;
    let tiempoUltimoRegistro = 0;
    let ultimaDeteccionExitosa = null;
    
    // Opciones de detecci√≥n OPTIMIZADAS para velocidad
    const detectorOptions = new faceapi.TinyFaceDetectorOptions({
      inputSize: 160,      // REDUCIDO: M√°s r√°pido (320 -> 160)
      scoreThreshold: 0.6
    });
    
    // ===== AUDIO =====
    const AUDIO_URL = "https://firebasestorage.googleapis.com/v0/b/inventario-35d6b.appspot.com/o/songs%2Fvep0iP5hgENLRXkyF8rXF76RyJ43%2F1770857392106_Tu%20entrada....mp3?alt=media&token=a119422d-bebf-4986-a9c8-9c9e0b3361b9";
    let audioElement;
    
    // Elementos DOM
    const video = document.getElementById('videoFacial');
    const btnReiniciar = document.getElementById('btnReiniciar');
    const navAsistenciaBtn = document.getElementById('navAsistenciaBtn');
    const navRegistroLinkBtn = document.getElementById('navRegistroLinkBtn');
    const irARegistroLink = document.getElementById('irARegistroLink');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const toast = document.getElementById('toastNotification');
    
    // Elementos del OVERLAY
    const overlay = document.getElementById('resultadoOverlay');
    const overlayNombre = document.getElementById('overlayNombre');
    const overlayCodigo = document.getElementById('overlayCodigo');
    const overlayTipo = document.getElementById('overlayTipo');
    const overlayHoraTexto = document.getElementById('overlayHoraTexto');
    const overlayFoto = document.getElementById('overlayFoto');
    const overlayFotoPlaceholder = document.getElementById('overlayFotoPlaceholder');
    const overlayConfianza = document.getElementById('overlayConfianza');
    const overlayBloqueoMensaje = document.getElementById('overlayBloqueoMensaje');
    const overlayBloqueoTexto = document.getElementById('overlayBloqueoTexto');
    const overlayBloqueoHoras = document.getElementById('overlayBloqueoHoras');
    const overlayBloqueoHorasTexto = document.getElementById('overlayBloqueoHorasTexto');

    // ============================================================
    // FUNCIONES UTILITARIAS
    // ============================================================
    function mostrarLoading(mensaje = 'Cargando...') {
      loadingText.textContent = mensaje;
      loadingOverlay.style.display = 'flex';
    }

    function ocultarLoading() {
      loadingOverlay.style.display = 'none';
    }

    function mostrarToast(msg, tipo = 'success') {
      toast.textContent = msg;
      toast.style.background = tipo === 'success' ? 'rgba(22, 224, 134, 0.95)' : 
                             tipo === 'error' ? 'rgba(231, 76, 60, 0.95)' : 
                             'rgba(243, 156, 18, 0.95)';
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    function formatearHora(date) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function formatearFecha(date) {
      return date.toISOString().split('T')[0];
    }

    // ===== REPRODUCIR SONIDO =====
    async function reproducirSonido(tipo) {
      try {
        if (!audioElement) {
          audioElement = document.getElementById('sonidoRegistro');
          audioElement.src = AUDIO_URL;
          await audioElement.load();
        }
        
        audioElement.currentTime = 0;
        await audioElement.play();
      } catch (error) {
        console.warn('Error reproduciendo audio:', error);
      }
    }

    // ===== OCULTAR OVERLAY =====
    function ocultarOverlay() {
      overlay.classList.add('hidden');
    }

    // ===== MOSTRAR OVERLAY CON INFORMACI√ìN =====
    function mostrarOverlay(colaborador, infoTipo, estado, verificacion) {
      overlay.classList.remove('hidden');
      
      // Nombre y c√≥digo
      overlayNombre.textContent = colaborador.nombre;
      overlayCodigo.innerHTML = `<i class="fas fa-id-card"></i> ${colaborador.codigo}`;
      
      // Hora
      overlayHoraTexto.textContent = formatearHora(new Date());
      
      // Foto
      if (colaborador.fotoBase64) {
        overlayFoto.src = colaborador.fotoBase64;
        overlayFoto.style.display = 'block';
        overlayFotoPlaceholder.style.display = 'none';
      } else {
        overlayFoto.style.display = 'none';
        overlayFotoPlaceholder.style.display = 'flex';
        overlayFotoPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
      }
      
      // Tipo de registro y estado
      overlayTipo.style.display = 'inline-block';
      overlayBloqueoMensaje.classList.add('hidden');
      overlayBloqueoHoras.classList.add('hidden');
      
      if (estado === 'exitoso' && infoTipo) {
        overlayTipo.className = `overlay-tipo ${infoTipo.tipo === 'entry' ? 'entrada' : 'salida'}`;
        overlayTipo.innerHTML = infoTipo.tipo === 'entry' ? 
          '‚úÖ ' + infoTipo.descripcion.toUpperCase() : 
          'üö™ ' + infoTipo.descripcion.toUpperCase();
        
        // Confianza
        if (verificacion) {
          overlayConfianza.style.display = 'inline-block';
          const confianza = Math.round(verificacion.nivelConfianza);
          let claseConfianza = 'alta';
          if (confianza < 70) claseConfianza = 'media';
          if (confianza < 60) claseConfianza = 'baja';
          overlayConfianza.className = `overlay-confianza ${claseConfianza}`;
          overlayConfianza.innerHTML = `<i class="fas fa-shield-alt"></i> Confianza: ${confianza}%`;
        }
        
        // REPRODUCIR SONIDO
        reproducirSonido(infoTipo.tipo);
        
      } else if (estado === 'bloqueado-horas') {
        overlayTipo.className = `overlay-tipo`;
        overlayTipo.style.background = '#f39c12';
        overlayTipo.style.color = '#0a1519';
        overlayTipo.innerHTML = '‚è≥ ESPERANDO 4 HORAS';
        overlayConfianza.style.display = 'none';
      } else if (estado === 'bloqueado-60s') {
        overlayTipo.className = `overlay-tipo`;
        overlayTipo.style.background = '#e74c3c';
        overlayTipo.style.color = 'white';
        overlayTipo.innerHTML = '‚è≥ ESCANEO REPETIDO';
        overlayConfianza.style.display = 'none';
      }
    }

    // ============================================================
    // 1. CARGAR MODELOS (OPTIMIZADO)
    // ============================================================
    async function cargarModelosFaceAPI() {
      mostrarLoading('Cargando modelos faciales...');
      
      try {
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        
        // Cargar solo lo necesario para reconocimiento
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
        ]);
        
        modelosCargados = true;
        ocultarLoading();
        return true;
      } catch (error) {
        try {
          const FALLBACK_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';
          await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(FALLBACK_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(FALLBACK_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(FALLBACK_URL)
          ]);
          
          modelosCargados = true;
          ocultarLoading();
          return true;
        } catch (fallbackError) {
          ocultarLoading();
          mostrarToast('No se pudieron cargar los modelos', 'error');
          return false;
        }
      }
    }

    // ============================================================
    // 2. CARGAR COLABORADORES (CON CACH√â DE DESCRIPTORES)
    // ============================================================
    async function cargarColaboradores() {
      try {
        const collRef = collection(db, 'Ponche');
        const snapshot = await getDocs(collRef);
        
        colaboradoresRegistrados = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const descriptores = [];
          
          // Cargar descriptores
          if (data.facialDescriptorFrontal) descriptores.push(new Float32Array(data.facialDescriptorFrontal));
          if (data.facialDescriptorIzquierdo) descriptores.push(new Float32Array(data.facialDescriptorIzquierdo));
          if (data.facialDescriptorDerecho) descriptores.push(new Float32Array(data.facialDescriptorDerecho));
          
          if (descriptores.length > 0) {
            const nombreCompleto = `${data.firstName || ''} ${data.lastName || ''}`.trim() || data.username || 'Colaborador';
            
            const colaborador = {
              id: doc.id,
              descriptores: descriptores,
              descriptorPrincipal: new Float32Array(data.facialDescriptorFrontal || descriptores[0]),
              nombre: nombreCompleto,
              username: data.username || '',
              codigo: data.uniqueProfileId || `RTM-${doc.id.slice(-5)}`,
              fotoBase64: data.fotoBase64 || '',
              horasDiarias: data.horasDiarias || 8
            };
            
            colaboradoresRegistrados.push(colaborador);
            
            // Cache para b√∫squeda r√°pida
            cacheDescriptores.set(doc.id, colaborador.descriptorPrincipal);
            
            // Inicializar control de escaneo
            if (!escaneosPorColaborador.has(doc.id)) {
              escaneosPorColaborador.set(doc.id, {
                ultimoRegistroTimestamp: 0,
                ultimoTipoRegistro: null,
                fechaActual: formatearFecha(new Date())
              });
            }
          }
        });
        
        return colaboradoresRegistrados.length;
      } catch (error) {
        console.error('Error cargando colaboradores:', error);
        return 0;
      }
    }

    // ============================================================
    // 3. INICIAR C√ÅMARA (CORREGIDA - MOVIMIENTO NATURAL)
    // ============================================================
    async function iniciarCamara() {
      try {
        if (streamVideo) {
          streamVideo.getTracks().forEach(track => track.stop());
        }
        
        streamVideo = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user',
            frameRate: { ideal: 30 }
          }
        });
        
        video.srcObject = streamVideo;
        await video.play();
        
        // CORREGIDO: Espejo horizontal para movimiento natural
        // Izquierda real = izquierda en pantalla, derecha real = derecha en pantalla
        video.style.transform = 'scaleX(-1)';
        
        return true;
      } catch (error) {
        mostrarToast('No se pudo acceder a la c√°mara', 'error');
        return false;
      }
    }

    // ============================================================
    // 4. COMPARACI√ìN R√ÅPIDA (OPTIMIZADA)
    // ============================================================
    function encontrarColaboradorRapido(descriptorDetectado) {
      let mejorCoincidencia = null;
      let menorDistancia = 0.6;
      let mejorColaborador = null;
      
      // B√∫squeda r√°pida - solo descriptor principal
      for (const colaborador of colaboradoresRegistrados) {
        const distancia = faceapi.euclideanDistance(descriptorDetectado, colaborador.descriptorPrincipal);
        
        if (distancia < menorDistancia) {
          menorDistancia = distancia;
          mejorColaborador = colaborador;
        }
      }
      
      if (mejorColaborador) {
        // Verificaci√≥n secundaria con otros √°ngulos
        let mejorAngulo = menorDistancia;
        for (const descriptor of mejorColaborador.descriptores) {
          const distancia = faceapi.euclideanDistance(descriptorDetectado, descriptor);
          if (distancia < mejorAngulo) {
            mejorAngulo = distancia;
          }
        }
        
        return {
          colaborador: mejorColaborador,
          distancia: mejorAngulo,
          nivelConfianza: Math.max(0, Math.min(100, 100 - (mejorAngulo * 100)))
        };
      }
      
      return null;
    }

    // ============================================================
    // 5. VERIFICAR BLOQUEO DE 4 HORAS (CORREGIDO)
    // ============================================================
    async function verificarBloqueo4Horas(colaboradorId) {
      try {
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const manana = new Date(hoy);
        manana.setDate(manana.getDate() + 1);
        
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', colaboradorId),
          where('timestamp', '>=', Timestamp.fromDate(hoy)),
          where('timestamp', '<', Timestamp.fromDate(manana)),
          orderBy('timestamp', 'desc'),
          limit(1)
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          return { bloqueado: false, mensaje: '' };
        }
        
        const ultimoRegistro = snapshot.docs[0].data();
        const ahora = new Date();
        const tiempoUltimoRegistro = ultimoRegistro.timestamp.toDate();
        
        // Verificar si el √∫ltimo registro fue una entrada y no ha pasado salida
        if (ultimoRegistro.type === 'entry') {
          const diferenciaMs = ahora - tiempoUltimoRegistro;
          
          if (diferenciaMs < TIEMPO_BLOQUEO_HORAS) {
            const horasRestantes = Math.floor((TIEMPO_BLOQUEO_HORAS - diferenciaMs) / (60 * 60 * 1000));
            const minutosRestantes = Math.floor(((TIEMPO_BLOQUEO_HORAS - diferenciaMs) % (60 * 60 * 1000)) / (60 * 1000));
            
            return {
              bloqueado: true,
              mensaje: `Debe esperar ${horasRestantes}h ${minutosRestantes}m para registrar su salida`
            };
          }
        }
        
        return { bloqueado: false, mensaje: '' };
        
      } catch (error) {
        console.error('Error verificando bloqueo:', error);
        return { bloqueado: false, mensaje: '' };
      }
    }

    // ============================================================
    // 6. DETERMINAR TIPO DE REGISTRO
    // ============================================================
    async function determinarTipoRegistro(colaboradorId) {
      try {
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const manana = new Date(hoy);
        manana.setDate(manana.getDate() + 1);
        
        const q = query(
          collection(db, 'facialAttendance'),
          where('collaboratorId', '==', colaboradorId),
          where('timestamp', '>=', Timestamp.fromDate(hoy)),
          where('timestamp', '<', Timestamp.fromDate(manana)),
          orderBy('timestamp', 'asc')
        );
        
        const snapshot = await getDocs(q);
        const registros = snapshot.docs.length;
        
        const esPar = registros % 2 === 0;
        const orden = registros + 1;
        
        if (registros === 0) {
          return { tipo: 'entry', orden: 1, descripcion: 'Primera Entrada' };
        } else if (esPar) {
          return { tipo: 'entry', orden: orden, descripcion: `${orden}¬™ Entrada` };
        } else {
          return { tipo: 'exit', orden: orden, descripcion: `${Math.ceil(orden / 2)}¬™ Salida` };
        }
        
      } catch (error) {
        console.error('Error determinando tipo:', error);
        return { tipo: 'entry', orden: 1, descripcion: 'Entrada' };
      }
    }

    // ============================================================
    // 7. REGISTRAR ASISTENCIA (CON VALIDACI√ìN ESTRICTA DE 4 HORAS)
    // ============================================================
    async function registrarAsistencia(colaborador, infoTipo, verificacion) {
      try {
        // VERIFICAR BLOQUEO DE 4 HORAS ANTES DE REGISTRAR
        const bloqueo = await verificarBloqueo4Horas(colaborador.id);
        if (bloqueo.bloqueado) {
          return { registrado: false, bloqueado: true, mensaje: bloqueo.mensaje };
        }
        
        const ahora = new Date();
        
        const registroData = {
          collaboratorId: colaborador.id,
          collaboratorName: colaborador.nombre,
          collaboratorCode: colaborador.codigo,
          timestamp: Timestamp.fromDate(ahora),
          date: ahora.toISOString(),
          type: infoTipo.tipo,
          tipoDescripcion: infoTipo.descripcion,
          numeroRegistro: infoTipo.orden,
          turno: Math.ceil(infoTipo.orden / 2),
          method: 'auto',
          horasDiarias: colaborador.horasDiarias || 8,
          nivelConfianza: verificacion.nivelConfianza,
          distanciaFacial: verificacion.distancia
        };

        await addDoc(collection(db, 'facialAttendance'), registroData);
        
        // Actualizar control de escaneo
        escaneosPorColaborador.set(colaborador.id, {
          ultimoRegistroTimestamp: Date.now(),
          ultimoTipoRegistro: infoTipo.tipo,
          fechaActual: formatearFecha(ahora)
        });
        
        return { registrado: true, bloqueado: false };
        
      } catch (error) {
        console.error('Error registrando:', error);
        return { registrado: false, bloqueado: false, error: true };
      }
    }

    // ============================================================
    // 8. PROCESAR DETECCI√ìN (OPTIMIZADA Y CORREGIDA)
    // ============================================================
    async function procesarDeteccion(descriptorDetectado) {
      
      // 1. ENCONTRAR COLABORADOR (B√öSQUEDA R√ÅPIDA)
      const resultado = encontrarColaboradorRapido(descriptorDetectado);
      
      if (!resultado) {
        mostrarOverlayNoRegistrado();
        return;
      }
      
      const { colaborador, distancia, nivelConfianza } = resultado;
      
      // 2. VERIFICAR CONFIANZA M√çNIMA
      if (nivelConfianza < 58) {
        mostrarOverlayConfianzaBaja(colaborador, nivelConfianza);
        return;
      }
      
      // 3. VERIFICAR ESCANEO REPETIDO (60 SEGUNDOS)
      const escaneoColaborador = escaneosPorColaborador.get(colaborador.id);
      const ahora = Date.now();
      
      if (escaneoColaborador && escaneoColaborador.ultimoRegistroTimestamp > 0) {
        const tiempoTranscurrido = ahora - escaneoColaborador.ultimoRegistroTimestamp;
        
        if (tiempoTranscurrido < TIEMPO_MINIMO_ENTRE_REGISTROS) {
          const segundosRestantes = Math.ceil((TIEMPO_MINIMO_ENTRE_REGISTROS - tiempoTranscurrido) / 1000);
          mostrarOverlayBloqueado60s(colaborador, segundosRestantes);
          return;
        }
      }
      
      // 4. VERIFICAR BLOQUEO DE 4 HORAS
      const bloqueoHoras = await verificarBloqueo4Horas(colaborador.id);
      if (bloqueoHoras.bloqueado) {
        mostrarOverlayBloqueadoHoras(colaborador, bloqueoHoras.mensaje);
        return;
      }
      
      // 5. DETERMINAR TIPO DE REGISTRO
      const infoTipo = await determinarTipoRegistro(colaborador.id);
      
      // 6. REGISTRAR ASISTENCIA
      const registro = await registrarAsistencia(colaborador, infoTipo, resultado);
      
      if (registro.registrado) {
        // √âXITO - Mostrar overlay y reproducir sonido
        mostrarOverlay(colaborador, infoTipo, 'exitoso', resultado);
        mostrarToast(`‚úÖ ${infoTipo.descripcion}: ${colaborador.nombre}`, 'success');
      } else if (registro.bloqueado) {
        mostrarOverlayBloqueadoHoras(colaborador, registro.mensaje);
      }
    }

    // ============================================================
    // 9. FUNCIONES DE OVERLAY
    // ============================================================
    function mostrarOverlayNoRegistrado() {
      overlay.classList.remove('hidden');
      overlayNombre.textContent = '‚ùå No registrado';
      overlayNombre.style.color = '#e74c3c';
      overlayCodigo.innerHTML = '<i class="fas fa-user-slash"></i> Rostro no existe';
      overlayCodigo.style.color = '#e74c3c';
      overlayTipo.style.display = 'none';
      overlayConfianza.style.display = 'none';
      overlayBloqueoMensaje.classList.add('hidden');
      overlayBloqueoHoras.classList.add('hidden');
      
      overlayFoto.style.display = 'none';
      overlayFotoPlaceholder.style.display = 'flex';
      overlayFotoPlaceholder.innerHTML = '<i class="fas fa-ban" style="color: #e74c3c;"></i>';
    }

    function mostrarOverlayConfianzaBaja(colaborador, confianza) {
      overlay.classList.remove('hidden');
      overlayNombre.textContent = colaborador.nombre;
      overlayNombre.style.color = '#f39c12';
      overlayCodigo.innerHTML = `<i class="fas fa-id-card"></i> ${colaborador.codigo}`;
      overlayCodigo.style.color = '#f39c12';
      
      overlayTipo.style.display = 'inline-block';
      overlayTipo.className = 'overlay-tipo';
      overlayTipo.style.background = '#f39c12';
      overlayTipo.style.color = '#0a1519';
      overlayTipo.innerHTML = `‚ö†Ô∏è CONFIANZA BAJA (${Math.round(confianza)}%)`;
      
      overlayConfianza.style.display = 'none';
      overlayBloqueoMensaje.classList.add('hidden');
      overlayBloqueoHoras.classList.add('hidden');
      
      if (colaborador.fotoBase64) {
        overlayFoto.src = colaborador.fotoBase64;
        overlayFoto.style.display = 'block';
        overlayFotoPlaceholder.style.display = 'none';
      }
    }

    function mostrarOverlayBloqueado60s(colaborador, segundos) {
      overlay.classList.remove('hidden');
      overlayNombre.textContent = colaborador.nombre;
      overlayNombre.style.color = '#e74c3c';
      overlayCodigo.innerHTML = `<i class="fas fa-id-card"></i> ${colaborador.codigo}`;
      overlayCodigo.style.color = '#e74c3c';
      
      overlayTipo.style.display = 'inline-block';
      overlayTipo.className = 'overlay-tipo';
      overlayTipo.style.background = '#e74c3c';
      overlayTipo.style.color = 'white';
      overlayTipo.innerHTML = `‚è≥ ESPERE ${segundos}s`;
      
      overlayConfianza.style.display = 'none';
      overlayBloqueoMensaje.classList.remove('hidden');
      overlayBloqueoMensaje.querySelector('span').textContent = `Espere ${segundos} segundos para registrar nuevamente`;
      
      if (colaborador.fotoBase64) {
        overlayFoto.src = colaborador.fotoBase64;
        overlayFoto.style.display = 'block';
        overlayFotoPlaceholder.style.display = 'none';
      }
    }

    function mostrarOverlayBloqueadoHoras(colaborador, mensaje) {
      overlay.classList.remove('hidden');
      overlayNombre.textContent = colaborador.nombre;
      overlayNombre.style.color = '#f39c12';
      overlayCodigo.innerHTML = `<i class="fas fa-id-card"></i> ${colaborador.codigo}`;
      overlayCodigo.style.color = '#f39c12';
      
      overlayTipo.style.display = 'inline-block';
      overlayTipo.className = 'overlay-tipo';
      overlayTipo.style.background = '#f39c12';
      overlayTipo.style.color = '#0a1519';
      overlayTipo.innerHTML = '‚è≥ 4 HORAS';
      
      overlayConfianza.style.display = 'none';
      overlayBloqueoHoras.classList.remove('hidden');
      overlayBloqueoHoras.querySelector('span').textContent = mensaje;
      
      if (colaborador.fotoBase64) {
        overlayFoto.src = colaborador.fotoBase64;
        overlayFoto.style.display = 'block';
        overlayFotoPlaceholder.style.display = 'none';
      }
    }

    // ============================================================
    // 10. DETECCI√ìN CONTINUA (ULTRA R√ÅPIDA)
    // ============================================================
    function iniciarDeteccionContinua() {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      
      if (!modelosCargados || colaboradoresRegistrados.length === 0) return;
      
      intervaloDeteccion = setInterval(async () => {
        if (!video || video.paused || video.ended) return;
        
        try {
          const detecciones = await faceapi.detectAllFaces(video, detectorOptions)
            .withFaceDescriptors();
          
          // Actualizar hora en overlay
          overlayHoraTexto.textContent = formatearHora(new Date());
          
          if (detecciones.length === 1) {
            const descriptor = detecciones[0].descriptor;
            
            // Evitar procesar el mismo descriptor
            if (ultimoDescriptorProcesado) {
              const distancia = faceapi.euclideanDistance(descriptor, ultimoDescriptorProcesado);
              if (distancia < 0.08) return;
            }
            
            ultimoDescriptorProcesado = descriptor;
            await procesarDeteccion(descriptor);
            
          } else if (detecciones.length > 1) {
            overlay.classList.remove('hidden');
            overlayNombre.textContent = 'üë• M√∫ltiples rostros';
            overlayNombre.style.color = '#f39c12';
            overlayCodigo.innerHTML = '<i class="fas fa-users"></i> Solo un rostro a la vez';
            overlayCodigo.style.color = '#f39c12';
            overlayTipo.style.display = 'none';
            overlayConfianza.style.display = 'none';
          }
        } catch (e) {
          console.warn('Error en detecci√≥n:', e);
        }
      }, 300); // 300ms = MUY R√ÅPIDO
    }

    // ============================================================
    // 11. INICIALIZACI√ìN
    // ============================================================
    async function inicializarSistema() {
      const modelosOK = await cargarModelosFaceAPI();
      if (!modelosOK) return;
      
      const cantidad = await cargarColaboradores();
      mostrarToast(`‚úÖ ${cantidad} colaboradores cargados`, 'success');
      
      const camaraOK = await iniciarCamara();
      if (!camaraOK) return;
      
      if (cantidad > 0) {
        iniciarDeteccionContinua();
      }
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    window.addEventListener('load', inicializarSistema);
    
    btnReiniciar.addEventListener('click', async () => {
      await iniciarCamara();
      mostrarToast('C√°mara reiniciada', 'success');
    });

    navRegistroLinkBtn.addEventListener('click', () => {
      window.location.href = 'registro-facial.html';
    });
    
    irARegistroLink.addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = 'registro-facial.html';
    });

    window.addEventListener('beforeunload', () => {
      if (intervaloDeteccion) clearInterval(intervaloDeteccion);
      if (streamVideo) streamVideo.getTracks().forEach(track => track.stop());
    });
  </script>
</body>
</html>
