<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solicitar Préstamo - Sistema de Préstamos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1abc9c;
            --primary-dark: #16a085;
            --background-color: #2c3e50; /* COLOR DE FONDO PARA SELECTS */
            --text-color: #ffffff;
            --text-light: #a8a8a8;
            --border-color: #444;
            --card-bg: #34495e;
            --danger-color: #e74c3c;
            --success-color: #15b086;
            --warning-color: #f39c12;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            --card-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            --smooth-transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            font-size: 12px;
        }

        body {
            font-family: 'Poppins', 'Roboto', sans-serif;
            background-color: #2c3e50; /* Fondo general de la página */
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        /* HEADER */
        .app-header {
            background: var(--card-bg);
            padding: 0.5rem 0.8rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 50px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 0.4rem;
        }

        .logo {
            width: 28px;
            height: 28px;
            border-radius: 5px;
        }

        .header-title {
            color: var(--primary-color);
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0;
        }

        .back-button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.3rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        /* CONTENEDOR PRINCIPAL */
        .container {
            flex: 1;
            width: 100%;
            max-width: 100%;
            padding: 0;
            margin-top: 50px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
            background-color: #2c3e50; /* Fondo del contenedor */
        }

        .content {
            padding: 0.8rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            background-color: #2c3e50; /* Fondo del contenido */
        }

        /* CARD */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            box-sizing: border-box;
        }

        .card-title {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.4rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.3rem;
        }

        /* FORM STEPS */
        .form-step {
            animation: fadeIn 0.4s ease;
            display: none;
            width: 100%;
        }

        .form-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px dashed var(--border-color);
            width: 100%;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section-title {
            color: var(--primary-color);
            margin-bottom: 0.6rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.3rem;
        }

        .form-group {
            margin-bottom: 0.8rem;
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: var(--text-light);
            font-weight: 500;
            font-size: 0.75rem;
            text-align: left;
        }

        .form-control {
            width: 100%;
            padding: 0.6rem 0.7rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: #2c3e50; /* COLOR DE FONDO PARA TODOS LOS CAMPOS */
            color: var(--text-color);
            font-size: 0.8rem;
            transition: var(--smooth-transition);
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            min-height: 38px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px rgba(26, 188, 156, 0.3);
        }

        /* ESTILOS ESPECÍFICOS PARA SELECTS CON FONDO #2c3e50 */
        select.form-control {
            cursor: pointer;
            appearance: none;
            background-color: #2c3e50 !important; /* FONDO #2c3e50 PARA SELECTS */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231abc9c' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            background-size: 0.8em;
            padding-right: 1.8rem;
        }

        /* ESTILO PARA LAS OPCIONES DEL SELECT - IMPORTANTE */
        select.form-control option {
            background-color: #2c3e50 !important; /* FONDO #2c3e50 PARA LAS OPCIONES */
            color: white !important;
            padding: 10px !important;
            border: none !important;
        }

        /* PARA CHROME, SAFARI */
        select.form-control option:checked,
        select.form-control option:hover,
        select.form-control option:focus {
            background-color: #1abc9c !important; /* Color primario cuando está seleccionado */
            color: white !important;
        }

        /* PARA FIREFOX */
        select.form-control::-moz-focus-inner {
            border: 0;
        }

        select.form-control:-moz-focusring {
            color: transparent;
            text-shadow: 0 0 0 white;
        }

        select.form-control option:checked {
            background-color: #1abc9c !important;
            color: white !important;
        }

        /* FILAS HORIZONTALES */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
            margin-bottom: 0.6rem;
            width: 100%;
        }

        /* SLIDER */
        .slider-container {
            margin: 0.8rem 0;
            padding: 0 0.3rem;
            width: 100%;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
            font-size: 0.7rem;
        }

        .amount-display {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 0.6rem 0;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .amount-display .currency {
            font-size: 1rem;
            color: var(--text-light);
            margin-right: 3px;
        }

        .amount-slider {
            width: 100%;
            height: 12px;
            -webkit-appearance: none;
            appearance: none;
            background: #2c3e50; /* FONDO #2c3e50 PARA EL SLIDER */
            border-radius: 6px;
            outline: none;
            margin: 0.6rem 0;
            border: 1px solid var(--border-color);
        }

        .amount-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--gradient-primary);
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(26, 188, 156, 0.3);
            border: 2px solid white;
            transition: var(--smooth-transition);
        }

        /* CALCULADORA */
        .payment-calculator {
            background: rgba(0, 0, 0, 0.2); /* Fondo oscuro semi-transparente */
            border-radius: 6px;
            padding: 0.8rem;
            margin: 0.6rem 0;
            border: 1px solid var(--border-color);
            width: 100%;
            box-sizing: border-box;
        }

        .calculation-results {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.6rem;
        }

        .calculation-item {
            text-align: center;
            padding: 0.5rem;
            background: #2c3e50; /* FONDO #2c3e50 PARA LOS ITEMS DE CÁLCULO */
            border-radius: 6px;
            border: 1px solid var(--border-color);
            min-height: 55px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calculation-label {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 0.2rem;
            display: block;
        }

        .calculation-value {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* NAVEGACIÓN */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-color);
            gap: 0.5rem;
            width: 100%;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0.8rem 0;
            width: 100%;
        }

        .step-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #2c3e50; /* FONDO #2c3e50 PARA LOS DOTS */
            margin: 0 2px;
            transition: var(--smooth-transition);
        }

        .step-dot.active {
            background: var(--gradient-primary);
            transform: scale(1.1);
        }

        .step-dot.completed {
            background-color: var(--success-color);
        }

        /* BOTONES */
        .btn {
            background: var(--gradient-primary);
            color: var(--text-color);
            border: none;
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--smooth-transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            min-width: 90px;
            min-height: 36px;
            touch-action: manipulation;
        }

        .btn i {
            margin-right: 4px;
            font-size: 0.8rem;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #11946e);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        /* ALERTAS */
        .alert {
            padding: 0.6rem 0.7rem;
            border-radius: 6px;
            display: none;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 0.6rem;
            animation: fadeIn 0.4s ease;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.75rem;
            background-color: #2c3e50; /* FONDO #2c3e50 PARA ALERTAS */
            border: 1px solid;
        }

        .alert i {
            margin-right: 0.4rem;
            font-size: 0.9rem;
        }

        .alert-danger {
            background-color: rgba(231, 76, 60, 0.15);
            border-color: var(--danger-color);
            color: #ff6b6b;
        }

        .alert-success {
            background-color: rgba(46, 204, 113, 0.15);
            border-color: var(--success-color);
            color: #55efc4;
        }

        /* SPINNER */
        .spinner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner.active {
            display: flex;
        }

        .spinner-icon {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* USER SELECTOR */
        .user-selector {
            margin-top: 0.4rem;
            width: 100%;
        }

        .user-selector .form-control {
            margin-bottom: 0.4rem;
        }

        .user-info-display {
            background: #2c3e50; /* FONDO #2c3e50 PARA INFO USUARIO */
            border-radius: 6px;
            padding: 0.6rem;
            margin-top: 0.4rem;
            display: none;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .user-info-display.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .user-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.2rem;
            font-size: 0.7rem;
        }

        .user-info-label {
            color: var(--text-light);
            text-align: left;
        }

        .user-info-value {
            color: var(--text-color);
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        /* RTM DISPLAY */
        .rtm-display {
            text-align: center;
            padding: 0.6rem;
            margin: 0.6rem 0;
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.1), rgba(22, 160, 133, 0.1));
            border-radius: 6px;
            border: 1px dashed var(--primary-color);
            background-color: #2c3e50; /* FONDO #2c3e50 PARA RTM */
        }

        .rtm-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.3rem;
        }

        .rtm-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 1px;
            font-family: monospace;
        }

        /* MEDIA QUERIES */
        @media (min-width: 768px) {
            .container {
                max-width: 90%;
                margin-left: auto;
                margin-right: auto;
            }
            
            .content {
                padding: 1rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .calculation-results {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .amount-display {
                font-size: 1.5rem;
            }
            
            .btn {
                min-width: 110px;
            }
            
            .rtm-number {
                font-size: 1.3rem;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 800px;
            }
            
            .amount-display {
                font-size: 1.8rem;
            }
            
            .rtm-number {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 767px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .calculation-results {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .step-navigation {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .calculation-results {
                grid-template-columns: 1fr;
            }
            
            .step-navigation {
                flex-direction: column;
            }
            
            .step-navigation .btn {
                width: 100%;
            }
        }

        @media (max-width: 360px) {
            html {
                font-size: 11px;
            }
            
            .container {
                padding: 0.6rem;
            }
            
            .card {
                padding: 0.6rem;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .app-header {
                height: 45px;
                padding: 0.4rem 0.6rem;
            }
            
            .container {
                margin-top: 45px;
                padding: 0.6rem;
            }
            
            .card {
                padding: 0.6rem;
                margin-bottom: 0.6rem;
            }
            
            .form-section {
                margin-bottom: 0.6rem;
                padding-bottom: 0.5rem;
            }
        }

        /* ESTILOS ESPECÍFICOS PARA LOS CAMPOS DE SELECCIÓN EN DIFERENTES NAVEGADORES */
        
        /* Para Chrome, Safari, Edge */
        select.form-control::-webkit-scrollbar {
            width: 8px;
        }

        select.form-control::-webkit-scrollbar-track {
            background: #2c3e50;
        }

        select.form-control::-webkit-scrollbar-thumb {
            background: #1abc9c;
            border-radius: 4px;
        }

        /* Para Firefox */
        select.form-control {
            scrollbar-width: thin;
            scrollbar-color: #1abc9c #2c3e50;
        }

        /* Para Internet Explorer */
        @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
            select.form-control {
                background-color: #2c3e50;
                color: white;
            }
            
            select.form-control option {
                background-color: #2c3e50;
                color: white;
            }
        }

        /* Para Safari en iOS */
        @supports (-webkit-touch-callout: none) {
            select.form-control {
                font-size: 14px !important;
                -webkit-appearance: none;
            }
            
            select.form-control option {
                background-color: #2c3e50;
                color: white;
                font-size: 14px;
            }
        }

        /* SCROLL GENERAL */
        .container::-webkit-scrollbar {
            width: 4px;
        }

        .container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="app-header">
        <button class="back-button" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-content">
            <img src="logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
            <h1 class="header-title">Solicitar Préstamo</h1>
        </div>
        <div style="width: 36px;"></div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container">
        <div class="content">
            <div class="card">
                <!-- Paso 1: Monto y Cálculo -->
                <div id="step1" class="form-step active">
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-sliders-h"></i> Selecciona el Monto</h4>
                        <div class="slider-container">
                            <div class="slider-header">
                                <span>Mínimo: <strong>$1,000</strong></span>
                                <span>Máximo: <strong>$100,000</strong></span>
                            </div>
                            
                            <div class="amount-display">
                                <span class="currency">$</span>
                                <span id="selectedAmount">5,000</span>
                            </div>
                            
                            <input type="range" min="0" max="20" value="5" step="1" class="amount-slider" id="loanAmountSlider">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-calculator"></i> Configura los Términos</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="interestRate">Tasa de Interés %</label>
                                <input type="number" id="interestRate" class="form-control" min="0" max="100" step="0.1" value="5.0" placeholder="Ej: 5.0">
                            </div>
                            
                            <div class="form-group">
                                <label for="paymentTerm">Plazo de Pago</label>
                                <select id="paymentTerm" class="form-control">
                                    <option value="daily">Diario</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="biweekly" selected>Quincenal</option>
                                    <option value="monthly">Mensual</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="payment-calculator">
                            <h5 style="color: var(--primary-color); margin-bottom: 0.6rem; font-size: 0.8rem; text-align: center;">
                                <i class="fas fa-chart-pie"></i> Resumen del Pago
                            </h5>
                            
                            <div class="calculation-results">
                                <div class="calculation-item">
                                    <span class="calculation-label">Monto del Préstamo</span>
                                    <span class="calculation-value" id="calcLoanAmount">$5,000</span>
                                </div>
                                <div class="calculation-item">
                                    <span class="calculation-label">Interés Total</span>
                                    <span class="calculation-value" id="calcTotalInterest">$250</span>
                                </div>
                                <div class="calculation-item">
                                    <span class="calculation-label">Total a Pagar</span>
                                    <span class="calculation-value" id="calcTotalPayment">$5,250</span>
                                </div>
                                <div class="calculation-item">
                                    <span class="calculation-label">Pago por <span id="calcTermLabel">Quincena</span></span>
                                    <span class="calculation-value" id="calcPaymentPerTerm">$262.50</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="btn btn-danger" onclick="window.location.href='index.html'">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-success" id="nextStep1">
                            <i class="fas fa-arrow-right"></i> Siguiente
                        </button>
                    </div>
                </div>
                
                <!-- Paso 2: Datos del Solicitante -->
                <div id="step2" class="form-step">
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-user-edit"></i> Datos Personales</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fullName">Nombre Completo *</label>
                                <input type="text" id="fullName" class="form-control" required placeholder="Ej: Juan Pérez García">
                            </div>
                            <div class="form-group">
                                <label for="cedula">Cédula de Identidad *</label>
                                <input type="text" id="cedula" class="form-control" required placeholder="Ej: 001-1234567-8">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phoneNumber">Teléfono *</label>
                                <input type="tel" id="phoneNumber" class="form-control" required placeholder="Ej: 809-555-1234">
                            </div>
                            <div class="form-group">
                                <label for="emailAddress">Correo Electrónico</label>
                                <input type="email" id="emailAddress" class="form-control" placeholder="ejemplo@correo.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-briefcase"></i> Situación Laboral</h4>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.8rem;">
                                <input type="checkbox" id="isEmployed" style="margin-right: 6px;">
                                Actualmente me encuentro laborando
                            </label>
                        </div>
                        
                        <div id="employmentFields" class="form-row" style="display: none;">
                            <div class="form-group">
                                <label for="companyName">Nombre de la Empresa</label>
                                <input type="text" id="companyName" class="form-control" placeholder="Nombre de la empresa donde labora">
                            </div>
                            <div class="form-group">
                                <label for="employmentTime">Tiempo Laborando</label>
                                <select id="employmentTime" class="form-control">
                                    <option value="">Seleccione tiempo</option>
                                    <option value="less_than_6">Menos de 6 meses</option>
                                    <option value="6_to_12">6 a 12 meses</option>
                                    <option value="1_to_3">1 a 3 años</option>
                                    <option value="3_to_5">3 a 5 años</option>
                                    <option value="more_than_5">Más de 5 años</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-share-alt"></i> ¿Cómo se enteró de nosotros?</h4>
                        
                        <div class="form-group">
                            <select id="referralSource" class="form-control">
                                <option value="">Seleccione una opción</option>
                                <option value="facebook">Facebook</option>
                                <option value="instagram">Instagram</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="friend">Amigo/Conocido</option>
                                <option value="web">Página Web</option>
                                <option value="email">Correo Electrónico</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="otherSourceField" style="display: none; margin-top: 0.6rem;">
                            <label for="otherSource">Especifique</label>
                            <input type="text" id="otherSource" class="form-control" placeholder="¿Cómo se enteró?">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-users"></i> Usuario Destino</h4>
                        <p style="color: var(--text-light); font-size: 0.75rem; margin-bottom: 0.6rem; text-align: center;">
                            Seleccione el usuario al que va dirigido este préstamo:
                        </p>
                        
                        <div class="user-selector">
                            <div class="form-group">
                                <label for="userSelect">Seleccionar Usuario *</label>
                                <select id="userSelect" class="form-control" required>
                                    <option value="">-- Seleccione un usuario --</option>
                                    <!-- Los usuarios se cargarán aquí dinámicamente -->
                                </select>
                            </div>
                            
                            <div id="userInfoDisplay" class="user-info-display">
                                <div class="user-info-item">
                                    <span class="user-info-label">Nombre:</span>
                                    <span id="selectedUserName" class="user-info-value"></span>
                                </div>
                                <div class="user-info-item">
                                    <span class="user-info-label">Email:</span>
                                    <span id="selectedUserEmail" class="user-info-value"></span>
                                </div>
                                <div class="user-info-item">
                                    <span class="user-info-label">Teléfono:</span>
                                    <span id="selectedUserPhone" class="user-info-value"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Display del número RTM -->
                    <div class="form-section">
                        <div class="rtm-display">
                            <div class="rtm-label">Número de Solicitud RTM:</div>
                            <div class="rtm-number" id="rtmNumber">RTM-00000000</div>
                            <p style="font-size: 0.7rem; color: var(--text-light); margin-top: 0.3rem; text-align: center;">
                                Este número es único e irrepetible
                            </p>
                        </div>
                    </div>
                    
                    <div class="step-indicator">
                        <div class="step-dot completed"></div>
                        <div class="step-dot active"></div>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="btn" id="prevStep2">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button class="btn btn-success" id="submitApplication">
                            <i class="fas fa-paper-plane"></i> Enviar Solicitud
                        </button>
                    </div>
                </div>
            </div>

            <div id="alert" class="alert" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="alertMessage"></span>
            </div>
        </div>
    </div>

    <!-- Spinner de carga -->
    <div class="spinner" id="spinner">
        <div class="spinner-icon"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs,
            addDoc,
            query,
            Timestamp,
            getCountFromServer
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
            authDomain: "inventario-35d6b.firebaseapp.com",
            databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
            projectId: "inventario-35d6b",
            storageBucket: "inventario-35d6b.appspot.com",
            messagingSenderId: "266100399659",
            appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allUsers = [];
        const loanAmounts = [1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000, 
                             15000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 100000];
        let generatedRTMNumber = '';

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Iniciando aplicación de solicitud de préstamos...");
            await loadAllUsers();
            await generateRTMNumber();
            initializeLoanRequest();
        });

        async function generateRTMNumber() {
            try {
                showLoading();
                const loanApplicationsRef = collection(db, "LoanApplications");
                const snapshot = await getCountFromServer(loanApplicationsRef);
                const totalCount = snapshot.data().count;
                const baseNumber = (totalCount + 1).toString().padStart(8, '0');
                generatedRTMNumber = `RTM-${baseNumber}`;
                document.getElementById('rtmNumber').textContent = generatedRTMNumber;
                return generatedRTMNumber;
            } catch (error) {
                console.error("Error generando número RTM:", error);
                const fallbackNumber = `RTM-${Date.now().toString().slice(-8)}`;
                document.getElementById('rtmNumber').textContent = fallbackNumber;
                generatedRTMNumber = fallbackNumber;
                return fallbackNumber;
            } finally {
                hideLoading();
            }
        }

        async function loadAllUsers() {
            try {
                showLoading();
                allUsers = [];
                const usersRef = collection(db, "users");
                const usersQuery = query(usersRef);
                const usersSnapshot = await getDocs(usersQuery);
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.email) {
                        allUsers.push({
                            id: doc.id,
                            name: userData.name || userData.username || 'Usuario sin nombre',
                            username: userData.username || '',
                            email: userData.email,
                            phone: userData.phone || '',
                            pin: userData.pin || ''
                        });
                    }
                });
                
                updateUserSelector();
                
                if (allUsers.length === 0) {
                    showAlert("No se encontraron usuarios en el sistema.", "warning");
                }
                
            } catch (error) {
                console.error("Error al cargar usuarios:", error);
                showAlert("Error al cargar usuarios: " + error.message, "danger");
            } finally {
                hideLoading();
            }
        }

        function updateUserSelector() {
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">-- Seleccione un usuario --</option>';
            
            if (allUsers.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay usuarios disponibles';
                option.disabled = true;
                userSelect.appendChild(option);
                return;
            }
            
            const sortedUsers = [...allUsers].sort((a, b) => {
                const nameA = a.name || a.email || '';
                const nameB = b.name || b.email || '';
                return nameA.localeCompare(nameB);
            });
            
            sortedUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                let displayText = user.name || user.email.split('@')[0];
                if (user.email) {
                    displayText += ` - ${user.email}`;
                }
                option.textContent = displayText;
                userSelect.appendChild(option);
            });
        }

        function initializeLoanRequest() {
            const slider = document.getElementById('loanAmountSlider');
            slider.addEventListener('input', updateLoanAmount);
            slider.addEventListener('touchmove', updateLoanAmount);
            
            document.getElementById('interestRate').addEventListener('input', calculatePayment);
            document.getElementById('paymentTerm').addEventListener('change', calculatePayment);
            
            document.getElementById('nextStep1').addEventListener('click', goToStep2);
            document.getElementById('prevStep2').addEventListener('click', goToStep1);
            
            document.getElementById('isEmployed').addEventListener('change', toggleEmploymentFields);
            document.getElementById('referralSource').addEventListener('change', toggleOtherSourceField);
            
            document.getElementById('userSelect').addEventListener('change', showUserInfo);
            document.getElementById('submitApplication').addEventListener('click', submitLoanApplication);
            
            updateLoanAmount();
            calculatePayment();
        }

        function updateLoanAmount() {
            const slider = document.getElementById('loanAmountSlider');
            const amountDisplay = document.getElementById('selectedAmount');
            const calcAmount = document.getElementById('calcLoanAmount');
            
            const index = parseInt(slider.value);
            const amount = loanAmounts[index];
            
            amountDisplay.textContent = amount.toLocaleString('en-US');
            calcAmount.textContent = `$${amount.toLocaleString('en-US')}`;
            calculatePayment();
        }

        function calculatePayment() {
            const slider = document.getElementById('loanAmountSlider');
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const paymentTerm = document.getElementById('paymentTerm').value;
            
            const index = parseInt(slider.value);
            const loanAmount = loanAmounts[index];
            
            const totalInterest = loanAmount * (interestRate / 100);
            const totalPayment = loanAmount + totalInterest;
            
            let paymentPerTerm = 0;
            let termLabel = "";
            
            switch(paymentTerm) {
                case 'daily':
                    paymentPerTerm = totalPayment / 30;
                    termLabel = "Día";
                    break;
                case 'weekly':
                    paymentPerTerm = totalPayment / 4;
                    termLabel = "Semana";
                    break;
                case 'biweekly':
                    paymentPerTerm = totalPayment / 2;
                    termLabel = "Quincena";
                    break;
                case 'monthly':
                    paymentPerTerm = totalPayment;
                    termLabel = "Mes";
                    break;
            }
            
            document.getElementById('calcTotalInterest').textContent = `$${totalInterest.toFixed(2)}`;
            document.getElementById('calcTotalPayment').textContent = `$${totalPayment.toFixed(2)}`;
            document.getElementById('calcPaymentPerTerm').textContent = `$${paymentPerTerm.toFixed(2)}`;
            document.getElementById('calcTermLabel').textContent = termLabel;
        }

        function showUserInfo() {
            const userSelect = document.getElementById('userSelect');
            const selectedUserId = userSelect.value;
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            
            if (!selectedUserId) {
                userInfoDisplay.classList.remove('active');
                return;
            }
            
            const selectedUser = allUsers.find(user => user.id === selectedUserId);
            
            if (selectedUser) {
                document.getElementById('selectedUserName').textContent = selectedUser.name || selectedUser.email.split('@')[0] || 'No disponible';
                document.getElementById('selectedUserEmail').textContent = selectedUser.email || 'No disponible';
                document.getElementById('selectedUserPhone').textContent = selectedUser.phone || 'No disponible';
                userInfoDisplay.classList.add('active');
            } else {
                userInfoDisplay.classList.remove('active');
            }
        }

        function goToStep2() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleEmploymentFields() {
            const isEmployed = document.getElementById('isEmployed').checked;
            document.getElementById('employmentFields').style.display = isEmployed ? 'grid' : 'none';
        }

        function toggleOtherSourceField() {
            const source = document.getElementById('referralSource').value;
            document.getElementById('otherSourceField').style.display = source === 'other' ? 'block' : 'none';
        }

        async function submitLoanApplication() {
            const fullName = document.getElementById('fullName').value.trim();
            const cedula = document.getElementById('cedula').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            const selectedUserId = document.getElementById('userSelect').value;
            
            if (!fullName || !cedula || !phone) {
                showAlert('Por favor complete todos los campos obligatorios (*)', 'danger');
                return;
            }
            
            if (!selectedUserId) {
                showAlert('Por favor seleccione un usuario destino para el préstamo', 'danger');
                return;
            }
            
            const slider = document.getElementById('loanAmountSlider');
            const index = parseInt(slider.value);
            const loanAmount = loanAmounts[index];
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const paymentTerm = document.getElementById('paymentTerm').value;
            
            const selectedUser = allUsers.find(user => user.id === selectedUserId);
            if (!selectedUser) {
                showAlert('El usuario seleccionado no es válido', 'danger');
                return;
            }
            
            if (loanAmount < 1000) {
                showAlert('El monto mínimo del préstamo es de $1,000', 'danger');
                return;
            }
            
            if (interestRate < 0 || interestRate > 100) {
                showAlert('La tasa de interés debe estar entre 0% y 100%', 'danger');
                return;
            }
            
            const rtmNumber = await generateRTMNumber();
            showLoading();
            
            try {
                const applicationData = {
                    applicantName: fullName,
                    applicantCedula: cedula,
                    applicantPhone: phone,
                    applicantEmail: document.getElementById('emailAddress').value.trim() || '',
                    
                    isEmployed: document.getElementById('isEmployed').checked,
                    companyName: document.getElementById('companyName').value.trim() || '',
                    employmentTime: document.getElementById('employmentTime').value || '',
                    
                    referralSource: document.getElementById('referralSource').value || '',
                    otherSource: document.getElementById('otherSource').value.trim() || '',
                    
                    targetUserId: selectedUserId,
                    targetUserName: selectedUser.name || selectedUser.email.split('@')[0],
                    targetUserEmail: selectedUser.email || '',
                    targetUserPhone: selectedUser.phone || '',
                    
                    loanAmount: loanAmount,
                    interestRate: interestRate,
                    paymentTerm: paymentTerm,
                    totalPayment: loanAmount + (loanAmount * (interestRate / 100)),
                    paymentPerTerm: calculatePaymentPerTerm(loanAmount, interestRate, paymentTerm),
                    
                    rtmNumber: rtmNumber,
                    
                    applicationDate: Timestamp.now(),
                    applicationDateString: new Date().toLocaleString(),
                    status: 'pending',
                    applicationNumber: rtmNumber,
                    
                    userId: selectedUserId,
                    userDisplayName: selectedUser.name || selectedUser.email.split('@')[0],
                    userEmail: selectedUser.email
                };
                
                const loanApplicationsRef = collection(db, "LoanApplications");
                const docRef = await addDoc(loanApplicationsRef, applicationData);
                
                console.log("Solicitud guardada con ID:", docRef.id);
                
                const successMessage = `
                    ¡Solicitud enviada correctamente!
                    
                    Número de solicitud: <strong>${rtmNumber}</strong>
                    Monto solicitado: $${loanAmount.toLocaleString('en-US')}
                    Usuario destino: ${selectedUser.name || selectedUser.email.split('@')[0]}
                    Fecha: ${new Date().toLocaleDateString()}
                `;
                
                showAlert(successMessage, 'success');
                
                setTimeout(() => {
                    resetForm();
                    goToStep1();
                    setTimeout(() => {
                        document.getElementById('alert').style.display = 'none';
                    }, 3000);
                }, 5000);
                
            } catch (error) {
                console.error("Error al enviar solicitud: ", error);
                showAlert('No se pudo enviar la solicitud. Error: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function calculatePaymentPerTerm(amount, interestRate, term) {
            const totalInterest = amount * (interestRate / 100);
            const totalPayment = amount + totalInterest;
            
            switch(term) {
                case 'daily': return totalPayment / 30;
                case 'weekly': return totalPayment / 4;
                case 'biweekly': return totalPayment / 2;
                case 'monthly': return totalPayment;
                default: return totalPayment;
            }
        }

        function resetForm() {
            document.getElementById('fullName').value = '';
            document.getElementById('cedula').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('emailAddress').value = '';
            document.getElementById('isEmployed').checked = false;
            document.getElementById('companyName').value = '';
            document.getElementById('employmentTime').value = '';
            document.getElementById('referralSource').value = '';
            document.getElementById('otherSource').value = '';
            document.getElementById('userSelect').value = '';
            document.getElementById('userInfoDisplay').classList.remove('active');
            document.getElementById('employmentFields').style.display = 'none';
            document.getElementById('otherSourceField').style.display = 'none';
            
            document.getElementById('loanAmountSlider').value = 5;
            document.getElementById('interestRate').value = 5.0;
            document.getElementById('paymentTerm').value = 'biweekly';
            updateLoanAmount();
            calculatePayment();
            
            generateRTMNumber();
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.style.display = 'flex';
            alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
            document.getElementById('alertMessage').innerHTML = message;
            
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            const timeout = type === 'success' ? 6000 : 4000;
            setTimeout(() => {
                alert.style.display = 'none';
            }, timeout);
        }

        function showLoading() {
            document.getElementById('spinner').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('spinner').classList.remove('active');
        }
    </script>
</body>
</html>
