<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Punto de Ventas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- AGREGADO: Librería para escáner de códigos -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* Estilo general */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -moz-user-drag: none;
      user-drag: none;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: #ecf0f1;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 14px;
    }

    /* Login Styles */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      position: relative;
    }

    .login-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .login-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 10px;
      background: url('logo.png') center/contain no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-logo.fallback {
      background: none;
      font-size: 48px;
      color: #16e086;
    }

    .login-title {
      font-size: 20px;
      color: #16e086;
      font-weight: bold;
    }

    .login-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      display: none;
    }

    .custom-loader {
      width: 60px;
      height: 60px;
      background: url('logo.png') center/contain no-repeat;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    .custom-loader.fallback {
      background: none;
      border: 4px solid #16e086;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }

    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .login-form {
      background: rgba(44, 62, 80, 0.9);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 350px;
      text-align: center;
      position: relative;
      z-index: 10;
    }

    .login-form h2 {
      margin-bottom: 15px;
      color: #16e086;
      font-size: 18px;
    }

    .login-form input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: #ecf0f1;
      font-size: 14px;
    }

    .login-form button {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      border: none;
      border-radius: 5px;
      background: #16e086;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-form button:hover {
      background: #15a086;
    }

    .login-error {
      color: #ff7675;
      margin-top: 8px;
      display: none;
      font-size: 13px;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #47627d;
      padding: 8px 15px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .system-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-img {
      width: 40px;
      height: 40px;
      background: url('logo.png') center/contain no-repeat;
    }

    .logo-img.fallback {
      background: none;
      font-size: 24px;
      color: #16e086;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .system-name {
      font-size: 18px;
      font-weight: bold;
      color: #16e086;
    }

    .header-icons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #16e086;
      margin-right: 5px;
    }

    .icon {
      color: #15a086;
      font-size: 1.5em;
      transition: transform 0.3s ease, color 0.3s ease;
      cursor: pointer;
    }

    .icon:hover {
      transform: scale(1.2);
      color: #16e086;
    }

    .icon.clock-animated {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .icon.locked {
      opacity: 0.5;
      pointer-events: none;
      position: relative;
    }

    .icon.locked::after {
      content: "\f023";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.8rem;
      color: #e74c3c;
      z-index: 1;
    }

    #invoiceUser {
      font-size: 1em;
      font-weight: bold;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      margin-top: 50px;
      flex-grow: 1;
      min-height: calc(100vh - 100px);
    }

    /* Left: Product List */
    .product-list-container {
      flex: 3;
      padding: 15px;
      overflow-y: auto;
      background: #34495e;
      border-radius: 10px;
      margin: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      height: calc(100vh - 150px);
      position: relative;
    }

    .product-list-container h1 {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: #16e086;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: #34495e;
      padding: 8px 0;
      z-index: 10;
    }

    .view-toggle {
      display: flex;
      gap: 8px;
    }

    .view-toggle-btn {
      background: none;
      border: none;
      color: #15a086;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .view-toggle-btn:hover, .view-toggle-btn.active {
      color: #16e086;
      transform: scale(1.2);
    }

    .search-container {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      width: 100%;
      position: sticky;
      top: 60px;
      background: #34495e;
      padding: 8px 0;
      z-index: 10;
    }

    .search-container input {
      flex-grow: 1;
      padding: 10px;
      font-size: 14px;
      border: none;
      border-radius: 20px;
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      color: #dfe6e9;
      transition: background 0.3s ease;
      width: 100%;
    }

    .search-container input:focus {
      background: rgba(255, 255, 255, 0.2);
    }

    /* NUEVO: Estilos para el botón de escáner en el buscador */
    .search-with-scanner {
      display: flex;
      gap: 5px;
      align-items: center;
      width: 100%;
    }

    .search-with-scanner input {
      flex: 1;
    }

    .scanner-btn {
      background: #16e086;
      color: white;
      border: none;
      border-radius: 20px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .scanner-btn:hover {
      background: #15a086;
      transform: scale(1.1);
    }

    .scanner-btn i {
      font-size: 18px;
    }

    .products-list {
      height: calc(100% - 100px);
      overflow-y: auto;
      overflow-x: hidden;
      margin-top: 8px;
    }

    .products-list.grid-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }

    .products-list.grid-view .product-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      transition: all 0.3s;
      cursor: pointer;
      height: 220px;
      position: relative;
    }

    .products-list.grid-view .product-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-5px);
    }

    .products-list.grid-view .product-item img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 8px;
      border-radius: 5px;
    }

    .products-list.grid-view .product-item .product-name {
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 0.8em;
    }

    .products-list.grid-view .product-item .product-price {
      color: #16e086;
      font-weight: bold;
      font-size: 0.9em;
    }

    .product-ean {
      font-size: 0.6em;
      color: #95a5a6;
      margin-top: 3px;
      background: rgba(0, 0, 0, 0.2);
      padding: 2px 6px;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product-ean:hover {
      background: rgba(22, 224, 134, 0.2);
      color: #16e086;
    }

    .product-ean .copy-icon {
      font-size: 0.8em;
      opacity: 0.7;
    }

    .product-ean:hover .copy-icon {
      opacity: 1;
    }

    .copy-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(22, 224, 134, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 9999;
      animation: fadeInOut 2s ease-in-out;
      display: none;
      font-size: 12px;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(10px); }
    }

    .products-list.list-view {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .products-list.list-view .product-item {
      display: flex;
      align-items: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      transition: all 0.3s;
      cursor: pointer;
      height: auto;
      position: relative;
    }

    .products-list.list-view .product-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .products-list.list-view .product-item img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 12px;
      border-radius: 5px;
    }

    .products-list.list-view .product-item .product-details {
      flex-grow: 1;
    }

    .products-list.list-view .product-item .product-name {
      font-weight: bold;
      font-size: 0.8em;
    }

    .products-list.list-view .product-item .product-price {
      color: #16e086;
      font-weight: bold;
      font-size: 0.9em;
    }

    /* Right: Current Invoice */
    .products-container {
      flex: 3;
      padding: 15px;
      overflow-y: auto;
      background: #2c3e50;
      border-radius: 10px;
      margin: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      height: calc(100vh - 150px);
    }

    .products-container h1 {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: #16e086;
    }

    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      transition: transform 0.3s ease, background 0.3s ease;
      cursor: pointer;
    }

    .product-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-5px);
    }

    .invoice-item {
      padding: 8px;
      border-bottom: 1px solid #95a5a6;
      margin-bottom: 8px;
      background: #2c3e50;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.3s ease;
      font-size: 13px;
    }

    .invoice-item:hover {
      transform: translateX(5px);
    }

    .remove-btn {
      background-color: #d63031;
      color: #fff;
      padding: 4px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-left: auto;
      font-size: 12px;
    }

    .remove-btn:hover {
      background-color: #ff7675;
    }

    /* Bottom Totals Bar */
    .totals-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #2c3e50;
      padding: 8px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .totals-bar .total-container {
      background: #47627d;
      padding: 8px 15px;
      border-radius: 5px;
      font-size: 0.9em;
      color: #ecf0f1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .totals-bar .total-container i {
      font-size: 1em;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .button {
      padding: 10px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 0.9em;
      color: #ecf0f1;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s, transform 0.3s;
      text-decoration: none;
    }

    .button:hover {
      transform: scale(1.05);
    }

    .button i {
      font-size: 1em;
    }

    .button-efectivo {
      background-color: #27ae60;
    }

    .button-efectivo:hover {
      background-color: #2ecc71;
    }

    .button-tarjeta {
      background-color: #2980b9;
    }

    .button-tarjeta:hover {
      background-color: #3498db;
    }

    .button-descuento {
      background-color: #e67e22;
    }

    .button-descuento:hover {
      background-color: #d35400;
    }

    .button-home {
      background-color: #8e44ad;
    }

    .button-home:hover {
      background-color: #9b59b6;
    }

    .button-pay {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: #fff;
      font-size: 16px;
      padding: 10px 20px;
      border-radius: 40px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    .button-pay:hover {
      background: linear-gradient(135deg, #15a086, #16e086);
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #2c3e50;
      padding: 15px;
      border: 1px solid #888;
      width: 70mm;
      max-width: 85%;
      border-radius: 10px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 13px;
    }

    @keyframes slideIn {
      from { transform: translate(-50%, -100px); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: #fff;
    }

    /* Payment Modals */
    .payment-modal-content {
      background-color: #2c3e50;
      padding: 15px;
      border: 1px solid #888;
      width: 280px;
      max-width: 85%;
      border-radius: 10px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .payment-modal-content input {
      width: 90%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #888;
      background-color: #34495e;
      color: #ecf0f1;
      font-size: 0.9em;
    }

    .payment-modal-content button {
      padding: 8px 15px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 0.9em;
      background-color: #27ae60;
      color: #ecf0f1;
      transition: background 0.3s, transform 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px auto;
    }

    .payment-modal-content button:hover {
      background-color: #2ecc71;
      transform: scale(1.05);
    }

    .rates-modal-content {
      background-color: #2c3e50;
      padding: 25px;
      border: 1px solid #888;
      width: 320px;
      max-width: 85%;
      border-radius: 15px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .rates-modal-content h2 {
      margin-bottom: 15px;
      color: #16e086;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 18px;
    }

    .rates-modal-content .current-rates {
      margin: 15px 0;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .rates-modal-content .current-rates h3 {
      margin-bottom: 8px;
      color: #16e086;
      font-size: 16px;
    }

    .rates-modal-content .current-rates p {
      margin: 4px 0;
      font-size: 1em;
    }

    .rates-modal-content .current-rates .rate-value {
      font-weight: bold;
      color: #16e086;
    }

    .password-modal-content {
      background-color: #2c3e50;
      padding: 15px;
      border: 1px solid #888;
      width: 280px;
      max-width: 85%;
      border-radius: 10px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .password-modal-content input {
      width: 90%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #888;
      background-color: #34495e;
      color: #ecf0f1;
      font-size: 14px;
    }

    .password-modal-content button {
      padding: 8px 15px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 0.9em;
      background-color: #27ae60;
      color: #ecf0f1;
      transition: background 0.3s, transform 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .password-modal-content button:hover {
      background-color: #2ecc71;
      transform: scale(1.05);
    }

    .discount-applied-modal {
      background-color: #2c3e50;
      padding: 15px;
      border: 1px solid #888;
      width: 280px;
      max-width: 85%;
      border-radius: 10px;
    }

    .virtual-keyboard {
      display: none;
      position: fixed;
      z-index: 2000;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      padding: 12px;
      cursor: move;
    }

    .virtual-keyboard .keyboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #16e086;
    }

    .virtual-keyboard .keyboard-title {
      color: #16e086;
      font-weight: bold;
      font-size: 14px;
    }

    .virtual-keyboard .keyboard-actions {
      display: flex;
      gap: 8px;
    }

    .virtual-keyboard .keyboard-action-btn {
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 12px;
    }

    .virtual-keyboard .keyboard-action-btn:hover {
      background: #16e086;
    }

    .numeric-keyboard {
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-top: 12px;
      text-align: center;
      width: 220px;
    }

    .numeric-keyboard-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .numeric-btn {
      padding: 10px;
      font-size: 14px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(145deg, #2c3e50, #222);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      box-shadow: 0 0 6px rgba(22, 224, 136);
      transition: all 0.3s ease-in-out;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .numeric-btn:hover {
      background: #16e086;
      color: #000;
      box-shadow: 0 0 12px rgba(22, 224, 134);
      transform: scale(1.05);
    }

    #backspaceBtn {
      background: #ff004c;
      color: white;
      box-shadow: 0 0 8px rgba(255, 0, 76, 0.6);
    }

    #backspaceBtn:hover {
      background: #ff3366;
      box-shadow: 0 0 15px rgba(255, 0, 76, 1);
      transform: scale(1.05);
    }

    #acceptBtn {
      background: #15a086;
      color: #fff;
      font-size: 14px;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(21, 160, 135);
      grid-column: span 1;
      min-height: 40px;
    }

    #acceptBtn:hover {
      background: #16e086;
      box-shadow: 0 0 15px rgba(22, 224, 134);
      transform: scale(1.05);
    }

    .text-keyboard {
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
      margin-top: 12px;
      width: 680px;
      max-width: 95vw;
    }

    .text-keyboard-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
    }

    .text-keyboard button {
      padding: 10px;
      font-size: 14px;
      background: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .text-keyboard button:hover {
      background: #16e086;
      transform: scale(1.05);
    }

    .text-keyboard .space {
      grid-column: span 4;
    }

    .text-keyboard .enter {
      grid-column: span 3;
      background: #27ae60;
    }

    .text-keyboard .shift {
      grid-column: span 2;
      background: #e67e22;
    }

    .text-keyboard .shift.active {
      background: #f39c12;
      box-shadow: 0 0 8px rgba(243, 156, 18, 0.8);
    }

    .text-keyboard .backspace {
      grid-column: span 2;
      background: #d63031;
    }

    .text-keyboard .number-toggle {
      grid-column: span 2;
      background: #8e44ad;
    }

    .invoice-container {
      width: 100%;
      max-width: 70mm;
      margin: 0 auto;
      padding: 8px;
      font-family: Arial, sans-serif;
      font-size: 12px;
    }

    .invoice-header {
      text-align: center;
      margin-bottom: 8px;
      border-bottom: 1px dashed #000;
      padding-bottom: 8px;
    }

    .invoice-header h2 {
      margin: 4px 0;
      font-size: 16px;
    }

    .invoice-header p {
      margin: 2px 0;
      font-size: 12px;
    }

    .invoice-user {
      margin: 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px dashed #000;
    }

    .invoice-products {
      margin: 8px 0;
    }

    .product-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .product-name {
      flex: 3;
    }

    .product-quantity, .product-price, .product-total {
      flex: 1;
      text-align: right;
      margin-left: 4px;
    }

    .invoice-totals {
      margin-top: 12px;
      border-top: 1px dashed #000;
      padding-top: 8px;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .barcode {
      text-align: center;
      margin-top: 12px;
      padding: 4px 0;
      background: #2c3e50;
    }

    .barcode-print {
      background: white !important;
    }

    .barcode img {
      max-width: 100%;
      height: auto;
    }

    .thank-you {
      text-align: center;
      margin-top: 8px;
      font-style: italic;
      padding: 4px 0;
    }

    #btnPrint {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 40px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    #btnPrint:hover {
      background: linear-gradient(135deg, #15a086, #16e086);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }

    #btnPrint i {
      font-size: 16px;
    }

    .user-info-modal {
      background-color: #2c3e50;
      padding: 15px;
      border: 1px solid #888;
      width: 280px;
      max-width: 85%;
      border-radius: 10px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .user-info-modal h2 {
      margin-bottom: 12px;
      color: #16e086;
      font-size: 18px;
    }

    .user-info-modal p {
      margin: 8px 0;
      font-size: 14px;
    }

    .logout-btn {
      background: #d63031;
      color: #fff;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.3s;
      font-size: 14px;
    }

    .logout-btn:hover {
      background: #ff7675;
    }

    .alert-modal {
      background-color: #2c3e50;
      padding: 15px;
      border: 1px solid #888;
      width: 280px;
      max-width: 85%;
      border-radius: 10px;
      color: #ecf0f1;
      text-align: center;
      animation: slideIn 0.3s ease;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .alert-modal h2 {
      margin-bottom: 12px;
      font-size: 18px;
    }

    .alert-success h2 {
      color: #16e086;
    }

    .alert-error h2 {
      color: #ff7675;
    }

    .alert-warning h2 {
      color: #fdcb6e;
    }

    .alert-modal button {
      background: #16e086;
      color: #fff;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.3s;
      font-size: 14px;
    }

    .alert-modal button:hover {
      background: #15a086;
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        margin-top: 45px;
      }

      .products-container, .product-list-container {
        margin: 4px;
        padding: 8px;
        height: auto;
        min-height: 45vh;
      }

      .totals-bar {
        flex-direction: column;
        gap: 8px;
        padding: 8px;
        position: relative;
      }

      .action-buttons {
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
      }

      .button {
        flex: 1 1 45%;
        min-width: 110px;
        font-size: 0.8em;
        padding: 8px;
      }

      .text-keyboard {
        grid-template-columns: repeat(8, 1fr);
        width: 95%;
      }

      .text-keyboard .space {
        grid-column: span 3;
      }

      .text-keyboard .enter {
        grid-column: span 2;
      }

      .numeric-keyboard {
        width: 95%;
      }

      .header-icons {
        gap: 6px;
      }

      .icon {
        font-size: 1.2em;
      }

      #invoiceUser {
        font-size: 0.9em;
      }

      .product-list-container h1 {
        font-size: 1.3em;
        flex-direction: column;
        gap: 8px;
      }

      .search-container {
        flex-direction: column;
      }

      .products-list.grid-view {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }

      .modal-content, .payment-modal-content, .password-modal-content {
        width: 95%;
        padding: 12px;
      }
    }

    @media (max-width: 480px) {
      .products-list.grid-view {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      }

      .button {
        flex: 1 1 100%;
      }

      .header-icons {
        gap: 4px;
      }

      .icon {
        font-size: 1em;
      }

      .text-keyboard {
        width: 95%;
      }

      .numeric-keyboard {
        width: 95%;
      }
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .modal-content, .modal-content * {
        visibility: visible;
      }
      .modal-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        border: none;
        color: #000;
        background: white;
      }
      .modal-content button {
        display: none;
      }
      .no-print {
        display: none !important;
      }
      .barcode {
        background: white !important;
      }
      .barcode-print {
        background: white !important;
      }
    }

    .currency-totals {
      display: flex;
      gap: 8px;
      margin-left: 8px;
    }

    .currency-total {
      background: #47627d;
      padding: 8px;
      border-radius: 5px;
      font-size: 0.8em;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .currency-total i {
      font-size: 0.9em;
    }

    .print-btn {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
    }

    .print-btn:hover {
      background: linear-gradient(135deg, #15a086, #16e086);
      transform: translateY(-2px);
    }

    .print-btn i {
      font-size: 14px;
    }

    .report-print-container {
      display: none;
    }

    .products-list.grid-view .product-item img,
    .products-list.grid-overlay .product-item img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 8px;
      border-radius: 5px;
    }

    .quick-access-modal {
      background-color: #2c3e50;
      padding: 15px;
      border: 1px solid #888;
      width: 280px;
      max-width: 85%;
      border-radius: 10px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .quick-access-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .quick-access-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 5px;
      color: #ecf0f1;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      font-size: 14px;
    }

    .quick-access-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .quick-access-btn i {
      font-size: 1.1em;
    }

    ::-webkit-scrollbar-track {
      background-color: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: transparent;
      border-radius: 8px;
      height: 8px;
      transition: background-color 0.3s ease;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #15a086;
    }

    ::-webkit-scrollbar-thumb:active {
      background-color: #0d705c;
    }

    .taxes-modal-content {
      background-color: #2c3e50;
      padding: 25px;
      border: 1px solid #888;
      width: 380px;
      max-width: 85%;
      border-radius: 15px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .taxes-status {
      margin: 15px 0;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .tax-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .tax-name {
      font-weight: bold;
      color: #16e086;
      font-size: 14px;
    }

    .tax-value {
      font-weight: bold;
      font-size: 14px;
    }

    .tax-status {
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .tax-active {
      background: rgba(22, 224, 134, 0.2);
      color: #16e086;
    }

    .tax-inactive {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(15px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .scale-in {
      animation: scaleIn 0.2s ease-out;
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .enhanced-hover {
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .enhanced-hover:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    }

    .global-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .global-loading .custom-loader {
      width: 60px;
      height: 60px;
      background: url('logo.png') center/contain no-repeat;
      animation: spin 1s linear infinite;
    }

    .global-loading .custom-loader.fallback {
      background: none;
      border: 4px solid #16e086;
      border-bottom-color: transparent;
      border-radius: 50%;
    }

    .qr-code {
      text-align: center;
      margin: 12px 0;
    }

    .qr-code img {
      width: 1.8cm;
      height: 1.8cm;
      border: 1px solid #ddd;
      padding: 4px;
      background: white;
    }

    .advanced-menu {
      position: fixed;
      top: 55px;
      right: 15px;
      background: #2c3e50;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      padding: 12px;
      z-index: 1500;
      display: none;
      min-width: 180px;
    }

    .advanced-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      color: #ecf0f1;
      text-decoration: none;
      border-radius: 5px;
      transition: background 0.3s;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .advanced-menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .advanced-menu-item i {
      width: 18px;
      text-align: center;
    }

    .product-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(44, 62, 80, 0.9);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      z-index: 100;
      display: none;
    }

    .product-loading .custom-loader {
      width: 40px;
      height: 40px;
      margin: 0 auto 8px;
    }

    .shift-end-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      text-align: center;
      padding: 2rem;
    }

    .shift-end-content {
      max-width: 500px;
      background: rgba(44, 62, 80, 0.95);
      padding: 3rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 2px solid #e74c3c;
    }

    .shift-end-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 2rem;
    }

    .shift-end-btn {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(22, 224, 134, 0.3);
      cursor: pointer;
    }

    .shift-end-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(22, 224, 134, 0.4);
    }

    .shift-end-btn.secondary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .shift-end-btn.secondary:hover {
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
    }

    .shift-info {
      position: fixed;
      top: 60px;
      right: 15px;
      background: rgba(44, 62, 80, 0.95);
      border: 2px solid #16e086;
      border-radius: 10px;
      padding: 10px 15px;
      color: white;
      font-size: 14px;
      z-index: 999;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      min-width: 250px;
      display: none;
    }

    .shift-countdown {
      font-weight: bold;
      color: #16e086;
    }

    .shift-countdown.warning {
      color: #f39c12;
    }

    .shift-countdown.danger {
      color: #e74c3c;
    }

    .efectivo-modal-content {
      background-color: #2c3e50;
      padding: 20px;
      border: 1px solid #888;
      width: 500px;
      max-width: 90%;
      border-radius: 15px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      z-index: 1001;
    }

    .efectivo-modal-content h2 {
      margin-bottom: 20px;
      color: #16e086;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 22px;
    }

    .efectivo-main-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .efectivo-info-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .efectivo-total-display {
      background: rgba(22, 224, 134, 0.1);
      border: 2px solid #16e086;
      border-radius: 10px;
      padding: 15px;
    }

    .efectivo-total-display p {
      margin: 5px 0;
      font-size: 16px;
    }

    .efectivo-total-display .total-amount {
      font-size: 24px;
      font-weight: bold;
      color: #16e086;
    }

    .efectivo-input-container {
      text-align: left;
    }

    .efectivo-input-container label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #16e086;
    }

    .efectivo-received-input {
      width: 100%;
      padding: 12px 15px;
      font-size: 18px;
      border: 2px solid #16e086;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #ecf0f1;
      text-align: center;
      font-weight: bold;
    }

    .efectivo-received-input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(22, 224, 134, 0.5);
    }

    .efectivo-calculations {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
    }

    .efectivo-calculation-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .efectivo-calculation-row:last-child {
      border-bottom: none;
    }

    .efectivo-calculation-label {
      font-weight: bold;
    }

    .efectivo-calculation-value {
      font-weight: bold;
      font-size: 16px;
    }

    .efectivo-calculation-value.received {
      color: #fdcb6e;
    }

    .efectivo-calculation-value.change {
      color: #00b894;
    }

    .efectivo-keyboard-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #34495e;
      border-radius: 10px;
      padding: 15px;
      border: 1px solid #16e086;
    }

    .efectivo-keyboard-title {
      font-size: 14px;
      color: #95a5a6;
      margin-bottom: 10px;
      text-align: center;
    }

    .efectivo-keyboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .efectivo-keyboard-btn {
      padding: 12px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(145deg, #2c3e50, #34495e);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .efectivo-keyboard-btn:hover {
      background: #16e086;
      color: #000;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(22, 224, 134, 0.4);
    }

    .efectivo-keyboard-btn.clear {
      background: #e74c3c;
    }

    .efectivo-keyboard-btn.clear:hover {
      background: #c0392b;
    }

    .efectivo-keyboard-btn.enter {
      background: #27ae60;
      grid-column: span 2;
    }

    .efectivo-keyboard-btn.enter:hover {
      background: #2ecc71;
    }

    .efectivo-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .efectivo-action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .efectivo-action-btn.confirm {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
    }

    .efectivo-action-btn.confirm:hover {
      background: linear-gradient(135deg, #15a086, #16e086);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(22, 224, 134, 0.4);
    }

    .efectivo-action-btn.cancel {
      background: #e74c3c;
      color: white;
    }

    .efectivo-action-btn.cancel:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
    }

    .shift-details-modal {
      background-color: #2c3e50;
      padding: 25px;
      border: 1px solid #888;
      width: 400px;
      max-width: 85%;
      border-radius: 15px;
      color: #ecf0f1;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      z-index: 1001;
    }

    .shift-details-modal h2 {
      margin-bottom: 20px;
      color: #16e086;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 22px;
    }

    .shift-details-content {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      text-align: left;
    }

    .shift-detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .shift-detail-row:last-child {
      border-bottom: none;
    }

    .shift-detail-label {
      font-weight: bold;
      color: #16e086;
    }

    .shift-detail-value {
      font-weight: bold;
    }

    .shift-timer {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      padding: 15px;
      background: rgba(22, 224, 134, 0.1);
      border-radius: 10px;
      border: 2px solid #16e086;
    }

    .shift-timer.warning {
      color: #f39c12;
      border-color: #f39c12;
      background: rgba(243, 156, 18, 0.1);
    }

    .shift-timer.danger {
      color: #e74c3c;
      border-color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }

    .password-input-container {
      position: relative;
      width: 100%;
      margin-bottom: 15px;
    }

    .password-input-container input {
      width: 100%;
      padding-right: 40px;
    }

    .keyboard-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #16e086;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
      padding: 5px;
    }

    .keyboard-icon:hover {
      color: #15a086;
      transform: translateY(-50%) scale(1.1);
    }

    .tax-password-keyboard {
      display: none;
      position: fixed;
      z-index: 2001;
      background: rgba(0, 0, 0, 0.95);
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(22, 224, 134, 0.7);
      backdrop-filter: blur(10px);
      padding: 15px;
      cursor: move;
      width: 500px;
      max-width: 95vw;
    }

    .tax-password-keyboard .keyboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #16e086;
    }

    .tax-password-keyboard .keyboard-title {
      color: #16e086;
      font-weight: bold;
      font-size: 16px;
    }

    .tax-password-keyboard .keyboard-actions {
      display: flex;
      gap: 8px;
    }

    .tax-password-keyboard .keyboard-action-btn {
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 12px;
    }

    .tax-password-keyboard .keyboard-action-btn:hover {
      background: #16e086;
    }

    .tax-password-keyboard-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 5px;
      margin-top: 10px;
    }

    .tax-password-keyboard button {
      padding: 10px;
      font-size: 14px;
      background: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tax-password-keyboard button:hover {
      background: #16e086;
      transform: scale(1.05);
    }

    .tax-password-keyboard .space {
      grid-column: span 4;
    }

    .tax-password-keyboard .enter {
      grid-column: span 3;
      background: #27ae60;
    }

    .tax-password-keyboard .shift {
      grid-column: span 2;
      background: #e67e22;
    }

    .tax-password-keyboard .shift.active {
      background: #f39c12;
      box-shadow: 0 0 8px rgba(243, 156, 18, 0.8);
    }

    .tax-password-keyboard .backspace {
      grid-column: span 2;
      background: #d63031;
    }

    .tax-password-keyboard .symbol-toggle {
      grid-column: span 2;
      background: #8e44ad;
    }

    .tax-password-keyboard .symbol-toggle.active {
      background: #9b59b6;
      box-shadow: 0 0 8px rgba(155, 89, 182, 0.8);
    }

    .symbols-keyboard {
      display: none;
    }

    .virtual-keyboard.dragging {
      opacity: 0.9;
      box-shadow: 0 0 20px rgba(22, 224, 134, 0.8) !important;
    }

    .virtual-keyboard .keyboard-header {
      cursor: move;
      user-select: none;
    }

    .virtual-keyboard {
      position: fixed !important;
      z-index: 2000;
      transition: opacity 0.2s ease;
    }
    
    /* CORRECCIÓN: Eliminado el estilo del stock */
    .product-stock {
      display: none !important;
    }

    /* NUEVO: Estilos para el modal del escáner */
    .scanner-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
    }

    .scanner-modal-content {
      background-color: #000;
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .scanner-header {
      background: #2c3e50;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .scanner-header h2 {
      margin: 0;
      color: #16e086;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .scanner-close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
    }

    .scanner-close:hover {
      color: #16e086;
    }

    #scanner-container {
      width: 100%;
      height: 300px;
      position: relative;
      background: #000;
    }

    .scanner-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 15px;
      background: #2c3e50;
    }

    .scanner-control-btn {
      background: #16e086;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 20px;
    }

    .scanner-control-btn:hover {
      background: #15a086;
      transform: scale(1.1);
    }

    .scanner-control-btn.switch {
      background: #3498db;
    }

    .scanner-control-btn.switch:hover {
      background: #2980b9;
    }

    .scanner-control-btn.gallery {
      background: #9b59b6;
    }

    .scanner-control-btn.gallery:hover {
      background: #8e44ad;
    }

    .scanner-instructions {
      background: #2c3e50;
      padding: 10px;
      text-align: center;
      color: #95a5a6;
      font-size: 12px;
      border-top: 1px solid #34495e;
    }

    /* NUEVO: Estilo para el campo de búsqueda con escáner */
    .search-with-scanner {
      position: relative;
      width: 100%;
    }

    .search-with-scanner input {
      padding-right: 45px !important;
    }

    .scanner-btn-inside {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: #16e086;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .scanner-btn-inside:hover {
      background: #15a086;
      transform: translateY(-50%) scale(1.1);
    }

    .scanner-btn-inside i {
      font-size: 16px;
    }

    /* NUEVO: Estilo para el resultado del escáner */
    .scanner-result {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 2001;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }

    .scanner-result h3 {
      color: #16e086;
      margin-bottom: 10px;
    }

    .scanner-result p {
      color: #333;
      margin: 10px 0;
      font-weight: bold;
      font-size: 18px;
    }

    .scanner-result button {
      background: #16e086;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }

    .scanner-result button:hover {
      background: #15a086;
    }
  </style>
</head>
<body>
  <!-- Toast de copiado -->
  <div id="copyToast" class="copy-toast">
    <i class="fas fa-check-circle"></i> Código copiado al portapapeles
  </div>

  <!-- Loading Global -->
  <div id="globalLoading" class="global-loading">
    <div class="custom-loader" id="globalCustomLoader"></div>
    <p style="margin-top: 15px; font-size: 1em; color: white;">Cargando...</p>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="login-container">
    <div class="login-loading" id="loginLoading">
      <div class="custom-loader" id="loginCustomLoader"></div>
      <p style="margin-top: 15px; font-size: 1em;">Iniciando sesión...</p>
    </div>
    <div class="login-form">
      <div class="login-header">
        <div class="login-logo" id="loginLogo">
          <i class="fas fa-carrot"></i>
        </div>
        <div class="login-title">ZANARA</div>
      </div>
      <h2>Iniciar Sesión</h2>
      <input type="text" id="loginUsername" placeholder="Nombre de usuario">
      <input type="password" id="loginPin" placeholder="PIN">
      <button id="loginButton">Iniciar Sesión</button>
      <p id="loginError" class="login-error">Credenciales incorrectas</p>
    </div>
  </div>

  <!-- POS Section (hidden by default) -->
  <div id="posSection" style="display: none;">
    <header>
      <!-- CORRECCIÓN: Agregado logo y nombre del sistema -->
      <div class="header-left">
        <div class="system-logo">
          <div class="logo-img" id="headerLogo">
            <i class="fas fa-carrot"></i>
          </div>
          <div class="system-name">ZANARA POS</div>
        </div>
      </div>
      
      <div class="header-icons"> 
        <!-- CORRECCIÓN: Agregada foto de perfil del colaborador -->
        <img id="userAvatar" class="user-avatar" src="" alt="Foto de perfil" onerror="this.style.display='none'">
        
        <a href="#" id="homeBtn" title="Inicio"><i class="fa-solid fa-house icon"></i></a>
        <a href="inventario-home-index.html" id="inventoryBtn" title="Inventario"><i class="fa-solid fa-box icon"></i></a>
        <a href="venta-del-dia.html" id="reportsBtn" title="Reportes"><i class="fa-solid fa-chart-line icon"></i></a>
        <a href="facturas-del-dia.html" id="invoicesBtn" title="Facturas"><i class="fa-solid fa-receipt icon"></i></a>
        <a href="analisis-de-venta-con-comparacion.html" id="salesAnalysisBtn" title="Análisis de Ventas"><i class="fa-solid fa-chart-pie icon"></i></a>
        <a href="audotoria-por-colaborador.html" id="auditBtn" title="Auditorías"><i class="fa-solid fa-ear-listen icon"></i></a>
        <a href="Perla-chatbot-Pos.html" id="auditBtn" title="Perla - Asistente Virtual"><i class="fa-solid fas fa-robot icon"></i></a>
        <a href="#" id="userBtn" title="Usuario"><i class="fa-solid fa-user icon"></i></a>
        <a href="#" id="clockBtn" title="Tiempo de Turno"><i class="fa-solid fa-clock icon clock-animated"></i></a>
        <a href="#" id="ratesBtn" title="Tasas de Cambio"><i class="fa-solid fa-money-bill-transfer icon"></i></a>
        <a href="#" id="taxesBtn" title="Impuestos" class="taxes-icon">
          <i class="fa-solid fa-percent icon"></i>
          <span id="taxBadge" class="tax-badge">!</span>
        </a>
        <a href="devolucion-de-faturacion.html" id="returnsBtn" title="Devoluciones"><i class="fa-solid fa-arrow-rotate-left icon"></i></a>
        <a href="#" id="refreshBtn" title="Recargar"><i class="fa-solid fa-rotate icon"></i></a>
        <a href="#" id="advancedMenuBtn" title="Menú Avanzado"><i class="fa-solid fa-bars icon"></i></a>
        <a href="novedad.html" id="newsBtn" title="Novedad"><i class="fa-solid fa-bell icon"></i></a>
      </div>
      <span id="invoiceUser"></span>
    </header>

    <!-- Menú Avanzado -->
    <div id="advancedMenu" class="advanced-menu">
      <a href="estadistica-rapida-colaboradores.html" class="advanced-menu-item" id="quickStatsBtn">
        <i class="fa-solid fa-chart-line"></i>
        <span>Estadísticas Rápidas</span>
      </a>
      <a href="#" class="advanced-menu-item" id="backupBtn">
        <i class="fa-solid fa-bell"></i>
        <span>Novedad</span>
      </a>
      <a href="venta-a-credito.html" class="advanced-menu-item" id="exportBtn">
        <i class="fa-solid fa-tag"></i>
        <span>Vender a crédito</span>
      </a>
      <a href="#" class="advanced-menu-item" id="importBtn">
        <i class="fa-solid fa-file-import"></i>
        <span>Importar Productos</span>
      </a>
      <a href="#" class="advanced-menu-item" id="bulkDiscountBtn">
        <i class="fa-solid fa-tags"></i>
        <span>Descuentos Masivos</span>
      </a>
      <a href="#" class="advanced-menu-item" id="priceUpdateBtn">
        <i class="fa-solid fa-dollar-sign"></i>
        <span>Actualizar Precios</span>
      </a>
      <a href="#" class="advanced-menu-item" id="stockAlertBtn">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <span>Alertas de Stock</span>
      </a>
      <a href="venta-a-credito.html" class="advanced-menu-item" id="customerManagementBtn">
        <i class="fa-solid fa-users"></i>
        <span>Gestión de Clientes</span>
      </a>
      <a href="#" class="advanced-menu-item" id="supplierManagementBtn">
        <i class="fa-solid fa-truck"></i>
        <span>Gestión de Proveedores</span>
      </a>
    </div>

    <div class="main-container">
      <!-- Left: Product List -->
      <div class="product-list-container" id="productListSection">
        <div id="productLoading" class="product-loading">
          <div class="custom-loader"></div>
          <p style="color: white; margin-top: 8px;">Cargando productos...</p>
        </div>
        
        <h1>Todos los Productos
          <div class="view-toggle">
            <button class="view-toggle-btn" id="viewGrid" title="Vista de cuadrícula"><i class="fa-solid fa-grip"></i></button>
            <button class="view-toggle-btn" id="viewList" title="Vista de lista"><i class="fa-solid fa-list"></i></button>
          </div>
        </h1>
        <div class="search-container">
          <!-- MODIFICADO: Campo de búsqueda EAN/UPC con botón de escáner -->
          <div class="search-with-scanner">
            <input type="number" id="searchInput" placeholder="Buscar por EAN o UPC" autofocus>
            <button class="scanner-btn-inside" id="scannerBtnInside" title="Escanear código">
              <i class="fas fa-barcode"></i>
            </button>
          </div>
          <input type="text" id="searchByNameInput" placeholder="Buscar por nombre">
        </div>
        
        <div id="numericKeyboard" class="virtual-keyboard numeric-keyboard">
          <div class="keyboard-header">
            <div class="keyboard-title">Teclado Numérico</div>
            <div class="keyboard-actions">
              <button class="keyboard-action-btn" id="switchToTextKeyboard"><i class="fa-solid fa-keyboard"></i></button>
              <button class="keyboard-action-btn" id="closeNumericKeyboard"><i class="fa-solid fa-times"></i></button>
            </div>
          </div>
          <div class="numeric-keyboard-grid">
            <button class="numeric-btn" data-value="1">1</button>
            <button class="numeric-btn" data-value="2">2</button>
            <button class="numeric-btn" data-value="3">3</button>
            <button class="numeric-btn" data-value="4">4</button>
            <button class="numeric-btn" data-value="5">5</button>
            <button class="numeric-btn" data-value="6">6</button>
            <button class="numeric-btn" data-value="7">7</button>
            <button class="numeric-btn" data-value="8">8</button>
            <button class="numeric-btn" data-value="9">9</button>
            <button class="numeric-btn" data-value="0">0</button>
            <button class="numeric-btn" id="backspaceBtn">⌫</button>
            <button class="numeric-btn" id="acceptBtn">✔</button>
          </div>
        </div>
        
        <div id="textKeyboard" class="virtual-keyboard text-keyboard">
          <div class="keyboard-header">
            <div class="keyboard-title">Teclado de Texto</div>
            <div class="keyboard-actions">
              <button class="keyboard-action-btn" id="switchToNumericKeyboard"><i class="fa-solid fa-calculator"></i></button>
            </div>
          </div>
          <div class="text-keyboard-grid">
            <button data-value="1">1</button>
            <button data-value="2">2</button>
            <button data-value="3">3</button>
            <button data-value="4">4</button>
            <button data-value="5">5</button>
            <button data-value="6">6</button>
            <button data-value="7">7</button>
            <button data-value="8">8</button>
            <button data-value="9">9</button>
            <button data-value="0">0</button>
            
            <button data-value="q">q</button>
            <button data-value="w">w</button>
            <button data-value="e">e</button>
            <button data-value="r">r</button>
            <button data-value="t">t</button>
            <button data-value="y">y</button>
            <button data-value="u">u</button>
            <button data-value="i">i</button>
            <button data-value="o">o</button>
            <button data-value="p">p</button>
            
            <button data-value="a">a</button>
            <button data-value="s">s</button>
            <button data-value="d">d</button>
            <button data-value="f">f</button>
            <button data-value="g">g</button>
            <button data-value="h">h</button>
            <button data-value="j">j</button>
            <button data-value="k">k</button>
            <button data-value="l">l</button>
            <button data-value="ñ">ñ</button>
            
            <button class="shift" id="shiftBtn">Shift</button>
            <button data-value="z">z</button>
            <button data-value="x">x</button>
            <button data-value="c">c</button>
            <button data-value="v">v</button>
            <button data-value="b">b</button>
            <button data-value="n">n</button>
            <button data-value="m">m</button>
            <button data-value=",">,</button>
            <button data-value=".">.</button>
            
            <button class="space">Espacio</button>
            <button class="enter">Enter</button>
            <button class="backspace">⌫</button>
          </div>
        </div>
        <div id="productList" class="products-list grid-view"></div>
      </div>

      <!-- Right: Current Invoice -->
      <div class="products-container" id="invoiceSection">
        <h1>Factura Actual</h1>
        <div id="invoiceItems"></div>
      </div>
    </div>

    <!-- Bottom Totals Bar -->
    <div class="totals-bar">
      <div style="display: flex; align-items: center;">
        <div class="total-container" id="invoiceTotal"><i class="fa-solid fa-calculator"></i> Total: DOP $0.00</div>
        <div class="currency-totals">
          <div class="currency-total" id="usdTotal"><i class="fa-solid fa-dollar-sign"></i> USD $0.00</div>
          <div class="currency-total" id="eurTotal"><i class="fa-solid fa-euro-sign"></i> EUR €0.00</div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="button button-descuento" id="btnApplyDiscount"><i class="fa-solid fa-percent"></i> Descuento</button>
        <button class="button button-efectivo" id="btnEfectivo"><i class="fa-solid fa-money-bill"></i> Efectivo</button>
        <button class="button button-tarjeta" id="btnTarjeta"><i class="fa-solid fa-credit-card"></i> Tarjeta</button>
        <button class="button button-pay" id="payButton"><i class="fa-solid fa-credit-card"></i> Facturar</button>
      </div>
    </div>
  </div>

  <!-- Pantalla de fin de turno -->
  <div id="shiftEndScreen" class="shift-end-screen" style="display: none;">
    <div class="shift-end-content">
      <i class="fas fa-hourglass-end" style="font-size: 4rem; color: #e74c3c; margin-bottom: 1.5rem;"></i>
      <h1 style="color: #e74c3c; margin-bottom: 1rem; font-size: 2rem;">Turno Finalizado</h1>
      <p id="shiftEndMessage" style="font-size: 1.2rem; margin-bottom: 0.5rem; line-height: 1.5;">
        Tu turno ha terminado.
      </p>
      <p id="shiftEndDetails" style="font-size: 1.1rem; margin-bottom: 2rem; color: #ecf0f1;">
        Hola <strong id="shiftEndUserName">Colaborador</strong>, ya es hora de revisar tus ventas realizadas el día de hoy.
      </p>
      <div class="shift-end-buttons">
        <a href="venta-del-dia.html" class="shift-end-btn">
          <i class="fas fa-chart-bar"></i>
          Revisar Ventas del Día
        </a>
        <button id="changeAccountBtn" class="shift-end-btn secondary">
          <i class="fas fa-user"></i>
          Cambiar de Cuenta
        </button>
        <button id="reloadBtn" class="shift-end-btn secondary">
          <i class="fas fa-redo"></i>
          Recargar
        </button>
      </div>
    </div>
  </div>

  <!-- Contenedor de información del turno -->
  <div id="shiftInfo" class="shift-info" style="display: none;">
    <div style="display: flex; align-items: center; margin-bottom: 8px;">
      <i class="fas fa-clock" style="color: #16e086; margin-right: 8px;"></i>
      <strong style="color: #16e086;" id="shiftNameDisplay">Turno Activo</strong>
    </div>
    <div style="font-size: 12px; margin-bottom: 5px;">
      <div>Inicio: <span id="shiftStartTime">--:--</span></div>
      <div>Fin: <span id="shiftEndTime">--:--</span></div>
    </div>
    <div style="font-size: 13px; font-weight: bold;">
      Tiempo restante: <span id="shiftCountdown" class="shift-countdown">--:--:--</span>
    </div>
  </div>

  <!-- Print Modal -->
  <div id="printModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">×</span>
      <div id="invoicePrintContent"></div>
      <button id="btnPrint"><i class="fa-solid fa-print"></i> Imprimir</button>
    </div>
  </div>

  <!-- Payment Modal (Efectivo) -->
  <div id="efectivoModal" class="modal">
    <div class="efectivo-modal-content">
      <span class="close" id="closeEfectivoModal">×</span>
      <h2><i class="fa-solid fa-money-bill"></i> Pago en Efectivo</h2>
      
      <div class="efectivo-main-container">
        <div class="efectivo-info-section">
          <div class="efectivo-total-display">
            <p>Total a Pagar:</p>
            <p class="total-amount" id="efectivoTotal">DOP $0.00</p>
          </div>
          
          <div class="efectivo-input-container">
            <label for="efectivoReceived">Monto Recibido (DOP):</label>
            <input type="text" id="efectivoReceived" class="efectivo-received-input" placeholder="0.00" autocomplete="off">
          </div>
          
          <div class="efectivo-calculations">
            <div class="efectivo-calculation-row">
              <span class="efectivo-calculation-label">Monto Recibido:</span>
              <span class="efectivo-calculation-value received" id="efectivoReceivedDisplay">DOP $0.00</span>
            </div>
            <div class="efectivo-calculation-row">
              <span class="efectivo-calculation-label">Cambio:</span>
              <span class="efectivo-calculation-value change" id="efectivoChange">DOP $0.00</span>
            </div>
          </div>
        </div>
        
        <div class="efectivo-keyboard-section">
          <div class="efectivo-keyboard-title">Teclado Numérico</div>
          <div class="efectivo-keyboard">
            <button class="efectivo-keyboard-btn" data-value="1">1</button>
            <button class="efectivo-keyboard-btn" data-value="2">2</button>
            <button class="efectivo-keyboard-btn" data-value="3">3</button>
            <button class="efectivo-keyboard-btn" data-value="4">4</button>
            <button class="efectivo-keyboard-btn" data-value="5">5</button>
            <button class="efectivo-keyboard-btn" data-value="6">6</button>
            <button class="efectivo-keyboard-btn" data-value="7">7</button>
            <button class="efectivo-keyboard-btn" data-value="8">8</button>
            <button class="efectivo-keyboard-btn" data-value="9">9</button>
            <button class="efectivo-keyboard-btn clear" id="efectivoClearBtn">C</button>
            <button class="efectivo-keyboard-btn" data-value="0">0</button>
            <button class="efectivo-keyboard-btn" id="efectivoBackspaceBtn">⌫</button>
          </div>
        </div>
      </div>
      
      <div class="efectivo-actions">
        <button class="efectivo-action-btn cancel" id="cancelEfectivo">
          <i class="fa-solid fa-times"></i> Cancelar
        </button>
        <button class="efectivo-action-btn confirm" id="confirmEfectivo">
          <i class="fa-solid fa-check"></i> Confirmar Pago
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Modal (Tarjeta) -->
  <div id="tarjetaModal" class="modal">
    <div class="payment-modal-content">
      <span class="close" id="closeTarjetaModal">×</span>
      <h2>Pago con Tarjeta</h2>
      <p>Total a Pagar: <span id="tarjetaTotal"></span></p>
      <button id="confirmTarjeta"><i class="fa-solid fa-check"></i> Confirmar Pago</button>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal">
    <div class="password-modal-content">
      <span class="close" id="closePasswordModal">×</span>
      <h2>Introduce la Contraseña</h2>
      <div class="password-input-container">
        <input type="password" id="passwordInput" placeholder="Contraseña de 6 dígitos">
        <button class="keyboard-icon" id="passwordKeyboardIcon">
          <i class="fa-solid fa-keyboard"></i>
        </button>
      </div>
      <button id="submitPassword"><i class="fa-solid fa-lock"></i> Aceptar</button>
      <p id="passwordError" style="color: #e74c3c; display: none;">Contraseña incorrecta</p>
    </div>
  </div>

  <!-- Discount Applied Modal -->
  <div id="discountAppliedModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeDiscountModal">×</span>
      <h2>Descuento Aplicado</h2>
      <p id="discountMessage"></p>
    </div>
  </div>

  <!-- User Info Modal -->
  <div id="userInfoModal" class="modal">
    <div class="user-info-modal">
      <span class="close" id="closeUserModal">×</span>
      <h2>Información del Usuario</h2>
      <p id="userName"></p>
      <p id="userEmail"></p>
      <button id="logoutBtn" class="logout-btn">Cerrar Sesión</button>
    </div>
  </div>

  <!-- Rates Modal -->
  <div id="ratesModal" class="modal">
    <div class="rates-modal-content">
      <span class="close" id="closeRatesModal">×</span>
      <h2><i class="fa-solid fa-money-bill-transfer"></i> Tasas de Cambio</h2>
      
      <div class="current-rates">
        <h3>Tasas Actuales</h3>
        <p>Dólar (USD): <span class="rate-value" id="currentUsdRate">$56.50</span></p>
        <p>Euro (EUR): <span class="rate-value" id="currentEurRate">€61.20</span></p>
      </div>
    </div>
  </div>

  <!-- Modal de Impuestos -->
  <div id="taxesModal" class="modal">
    <div class="taxes-modal-content">
      <span class="close" id="closeTaxesModal">×</span>
      <h2><i class="fa-solid fa-percent"></i> Configuración de Impuestos</h2>
      
      <div class="taxes-status">
        <h3>Estado Actual de Impuestos</h3>
        <div class="tax-item">
          <span class="tax-name">ITBIS:</span>
          <span class="tax-value" id="itbisValue">Sin ITBIS asignado</span>
          <span class="tax-status tax-inactive" id="itbisStatus">No aplicado</span>
        </div>
        <div class="tax-item">
          <span class="tax-name">IVA:</span>
          <span class="tax-value" id="ivaValue">Sin IVA asignado</span>
          <span class="tax-status tax-inactive" id="ivaStatus">No aplicado</span>
        </div>
      </div>
      
      <p style="margin-top: 12px; font-size: 0.8em; color: #95a5a6;">
        <i class="fa-solid fa-info-circle"></i> Los impuestos se aplicarán automáticamente a los productos cuando estén activados
      </p>
    </div>
  </div>

  <!-- Modal de detalles del turno -->
  <div id="shiftDetailsModal" class="modal">
    <div class="shift-details-modal">
      <span class="close" id="closeShiftDetails">×</span>
      <h2><i class="fa-solid fa-clock"></i> Detalles del Turno</h2>
      
      <div class="shift-details-content">
        <div class="shift-detail-row">
          <span class="shift-detail-label">Nombre del Turno:</span>
          <span class="shift-detail-value" id="shiftDetailName">--</span>
        </div>
        <div class="shift-detail-row">
          <span class="shift-detail-label">Colaborador:</span>
          <span class="shift-detail-value" id="shiftDetailCollaborator">--</span>
        </div>
        <div class="shift-detail-row">
          <span class="shift-detail-label">Hora de Inicio:</span>
          <span class="shift-detail-value" id="shiftDetailStart">--:--</span>
        </div>
        <div class="shift-detail-row">
          <span class="shift-detail-label">Hora de Fin:</span>
          <span class="shift-detail-value" id="shiftDetailEnd">--:--</span>
        </div>
        <div class="shift-detail-row">
          <span class="shift-detail-label">Duración:</span>
          <span class="shift-detail-value" id="shiftDetailDuration">-- horas</span>
        </div>
      </div>
      
      <div class="shift-timer" id="shiftDetailTimer">
        --:--:--
      </div>
      
      <button id="closeShiftDetailsBtn" style="padding: 10px 20px; background: #16e086; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
        <i class="fa-solid fa-check"></i> Aceptar
      </button>
    </div>
  </div>

  <!-- Alert Modals -->
  <div id="successAlert" class="modal">
    <div class="alert-modal alert-success">
      <span class="close" id="closeSuccessAlert">×</span>
      <h2>Éxito</h2>
      <p id="successMessage"></p>
      <button id="successOkBtn">Aceptar</button>
    </div>
  </div>

  <div id="errorAlert" class="modal">
    <div class="alert-modal alert-error">
      <span class="close" id="closeErrorAlert">×</span>  
      <h2>Error</h2> 
      <p id="errorMessage"></p>
      <button id="errorOkBtn">Aceptar</button>
    </div>
  </div>

  <div id="warningAlert" class="modal">
    <div class="alert-modal alert-warning">
      <span class="close" id="closeWarningAlert">×</span>
      <h2>Advertencia</h2>
      <p id="warningMessage"></p>
      <button id="warningOkBtn">Aceptar</button>
    </div>
  </div>

  <!-- Modal de confirmación para productos próximos a vencer -->
  <div id="expiryWarningModal" class="modal">
    <div class="alert-modal alert-warning">
      <span class="close" id="closeExpiryWarning">×</span>
      <h2>Producto Próximo a Vencer</h2>
      <p id="expiryWarningMessage"></p>
      <div style="display: flex; gap: 8px; justify-content: center; margin-top: 15px;">
        <button id="confirmExpirySale" style="background: #16e086;">Sí, Vender</button>
        <button id="cancelExpirySale" style="background: #e74c3c;">No, Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de acceso rápido con Ctrl+Alt+P -->
  <div id="quickAccessModal" class="modal">
    <div class="quick-access-modal">
      <span class="close" id="closeQuickAccess">×</span>
      <h2><i class="fa-solid fa-keyboard"></i> Panel De Control</h2>
      <div class="quick-access-buttons">
        <a href="index.html" class="quick-access-btn" id="quickAccessPermissions">
          <i class="fa-solid fa-lock"></i>
          <span>Administrador</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Contenedor para imprimir reportes (oculto) -->
  <div id="reportPrintContainer" class="report-print-container"></div>

  <!-- Teclado virtual para contraseña de impuestos -->
  <div id="taxPasswordKeyboard" class="tax-password-keyboard">
    <div class="keyboard-header">
      <div class="keyboard-title">Teclado para Contraseña de Impuestos</div>
      <div class="keyboard-actions">
        <button class="keyboard-action-btn" id="closeTaxPasswordKeyboard"><i class="fa-solid fa-times"></i></button>
      </div>
    </div>
    
    <!-- Teclado de letras -->
    <div id="lettersKeyboard" class="tax-password-keyboard-grid">
      <!-- Primera fila - Números -->
      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button data-value="7">7</button>
      <button data-value="8">8</button>
      <button data-value="9">9</button>
      <button data-value="0">0</button>
      <!-- Segunda fila - Primera fila de letras QWERTY -->
      <button data-value="q">q</button>
      <button data-value="w">w</button>
      <button data-value="e">e</button>
      <button data-value="r">r</button>
      <button data-value="t">t</button>
      <button data-value="y">y</button>
      <button data-value="u">u</button>
      <button data-value="i">i</button>
      <button data-value="o">o</button>
      <button data-value="p">p</button>
      <!-- Tercera fila - Segunda fila de letras QWERTY -->
      <button data-value="a">a</button>
      <button data-value="s">s</button>
      <button data-value="d">d</button>
      <button data-value="f">f</button>
      <button data-value="g">g</button>
      <button data-value="h">h</button>
      <button data-value="j">j</button>
      <button data-value="k">k</button>
      <button data-value="l">l</button>
      <button data-value="ñ">ñ</button>
      <!-- Cuarta fila - Tercera fila de letras QWERTY -->
      <button class="shift" id="taxPasswordShiftBtn">Shift</button>
      <button data-value="z">z</button>
      <button data-value="x">x</button>
      <button data-value="c">c</button>
      <button data-value="v">v</button>
      <button data-value="b">b</button>
      <button data-value="n">n</button>
      <button data-value="m">m</button>
      <button data-value="-">-</button>
      <button data-value="_">_</button>
      <!-- Quinta fila - Teclas especiales -->
      <button class="symbol-toggle" id="taxPasswordSymbolToggle">Símbolos</button>
      <button class="space">Espacio</button>
      <button class="enter">Enter</button>
      <button class="backspace">⌫</button>
    </div>
    
    <!-- Teclado de símbolos -->
    <div id="symbolsKeyboard" class="tax-password-keyboard-grid symbols-keyboard">
      <!-- Primera fila - Símbolos -->
      <button data-value="!">!</button>
      <button data-value="@">@</button>
      <button data-value="#">#</button>
      <button data-value="$">$</button>
      <button data-value="%">%</button>
      <button data-value="&">&</button>
      <button data-value="*">*</button>
      <button data-value="(">(</button>
      <button data-value=")">)</button>
      <button data-value="=">=</button>
      <!-- Segunda fila - Más símbolos -->
      <button data-value="+">+</button>
      <button data-value="-">-</button>
      <button data-value="_">_</button>
      <button data-value=".">.</button>
      <button data-value=",">,</button>
      <button data-value="?">?</button>
      <button data-value="¡">¡</button>
      <button data-value="¿">¿</button>
      <button data-value="/">/</button>
      <button data-value="\">\</button>
      <!-- Tercera fila - Símbolos adicionales -->
      <button data-value="[">[</button>
      <button data-value="]">]</button>
      <button data-value="{">{</button>
      <button data-value="}">}</button>
      <button data-value="<"><</button>
      <button data-value=">">></button>
      <button data-value="|">|</button>
      <button data-value="~">~</button>
      <button data-value="`">`</button>
      <button data-value="^">^</button>
      <!-- Cuarta fila - Símbolos especiales -->
      <button data-value='"'>"</button>
      <button data-value="'">'</button>
      <button data-value=":">:</button>
      <button data-value=";">;</button>
      <button data-value="ñ">ñ</button>
      <button data-value="Ñ">Ñ</button>
      <button data-value="€">€</button>
      <button data-value="£">£</button>
      <button data-value="¥">¥</button>
      <button data-value="¢">¢</button>
      <!-- Quinta fila - Teclas especiales -->
      <button class="symbol-toggle active" id="taxPasswordSymbolToggle2">Letras</button>
      <button class="space">Espacio</button>
      <button class="enter">Enter</button>
      <button class="backspace">⌫</button>
    </div>
  </div>

  <!-- NUEVO: Modal del escáner de códigos de barras -->
  <div id="scannerModal" class="modal scanner-modal">
    <div class="scanner-modal-content">
      <div class="scanner-header">
        <h2><i class="fas fa-barcode"></i> Escáner de Códigos</h2>
        <button class="scanner-close" id="closeScanner">&times;</button>
      </div>
      <div id="scanner-container"></div>
      <div class="scanner-controls">
        <button class="scanner-control-btn switch" id="switchCameraBtn" title="Cambiar cámara">
          <i class="fas fa-camera-rotate"></i>
        </button>
       <!-- <button class="scanner-control-btn gallery" id="uploadImageBtn" title="Seleccionar imagen">
          <i class="fas fa-image"></i>
        </button>-->
      </div>
      <div class="scanner-instructions">
        <p>Coloca el código de barras frente a la cámara o selecciona una imagen</p>
      </div>
    </div>
  </div>

  <!-- NUEVO: Input oculto para seleccionar imagen desde galería -->
  <input type="file" id="imageUploadInput" accept="image/*" style="display:none">

  <!-- NUEVO: Resultado del escáner (ya no se usa, mantenido por compatibilidad) -->
  <div id="scannerResult" class="scanner-result" style="display:none;">
    <h3>Código detectado</h3>
    <p id="scannedCode"></p>
    <button id="scannerResultOk">Aceptar</button>
  </div>

<link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  limit,
  getDocs,
  doc,
  getDoc,
  updateDoc,
  addDoc,
  deleteDoc,
  Timestamp,
  where,
  setDoc,
  arrayUnion,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithEmailAndPassword,
  signOut 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
  authDomain: "formulario-2-8929a.firebaseapp.com",
  databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
  projectId: "formulario-2-8929a",
  storageBucket: "formulario-2-8929a.appspot.com",
  messagingSenderId: "136908102526",
  appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
  measurementId: "G-HJNZXRENE9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app); 
const storage = getStorage(app);

// =============================================
// CORRECCIONES PARA EL ESCÁNER - VERSIÓN MODIFICADA
// =============================================

// Variables para el escáner
let html5QrCode = null;
let fileScanner = null;
let currentCameraFacingMode = "environment";
let isScannerActive = false;
let productNotFoundTimeout = null; // Para el mensaje de "producto no existe"

// Función para inicializar el escáner
function initializeScanner() {
  try {
    // Inicializar el escáner para la cámara
    html5QrCode = new Html5Qrcode("scanner-container");
    
    // Inicializar el escáner para archivos
    fileScanner = new Html5Qrcode("scanner-container");
    
    console.log("✅ Escáner inicializado correctamente");
  } catch (error) {
    console.error("❌ Error al inicializar el escáner:", error);
    showAlert('error', 'Error al inicializar el escáner: ' + error.message);
  }
}

// Función para iniciar el escáner de cámara
async function startCameraScanner(cameraFacingMode = "environment") {
  try {
    if (!html5QrCode) {
      console.error("Escáner no inicializado");
      return false;
    }

    // Detener el escáner si ya está activo
    if (isScannerActive) {
      await stopScanner();
    }

    const config = {
      fps: 30,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0,
      experimentalFeatures: {
        useBarCodeDetectorIfSupported: true
      },
      videoConstraints: {
        facingMode: cameraFacingMode,
        focusMode: "continuous",
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 }
      }
    };

    await html5QrCode.start(
      { facingMode: cameraFacingMode },
      config,
      onScanSuccess,
      onScanError
    );
    
    isScannerActive = true;
    currentCameraFacingMode = cameraFacingMode;
    console.log("✅ Escáner de cámara iniciado con modo:", cameraFacingMode);
    return true;
    
  } catch (error) {
    console.error("❌ Error al iniciar el escáner de cámara:", error);
    
    // Si falla con la cámara trasera, intentar con la frontal
    if (cameraFacingMode === "environment") {
      console.log("⚠️ Intentando con cámara frontal...");
      return await startCameraScanner("user");
    }
    
    showAlert('error', 'Error al acceder a la cámara: ' + error.message);
    return false;
  }
}

// Función para detener el escáner
async function stopScanner() {
  try {
    if (html5QrCode && isScannerActive) {
      await html5QrCode.stop();
      isScannerActive = false;
      console.log("✅ Escáner detenido");
    }
  } catch (error) {
    console.error("❌ Error al detener el escáner:", error);
  }
}

// Función para cambiar entre cámaras
async function switchCamera() {
  try {
    if (!isScannerActive) return;
    
    const newFacingMode = currentCameraFacingMode === "environment" ? "user" : "environment";
    
    // Detener el escáner actual
    await stopScanner();
    
    // Iniciar con la nueva cámara
    await startCameraScanner(newFacingMode);
    
    console.log("🔄 Cámara cambiada a:", newFacingMode);
    
  } catch (error) {
    console.error("❌ Error al cambiar la cámara:", error);
  }
}

// Función para escanear desde una imagen
async function scanFromImage(file) {
  try {
    if (!fileScanner) {
      console.error("Escáner de archivos no inicializado");
      return;
    }

    const result = await fileScanner.scanFile(file, true);
    onScanSuccess(result);
    
  } catch (error) {
    console.error("❌ Error al escanear imagen:", error);
    showAlert('warning', 'No se detectó un código válido en la imagen');
  }
}

// =============================================
// FUNCIÓN MODIFICADA: Cuando se detecta un código exitosamente
// =============================================
async function onScanSuccess(decodedText) {
  console.log("✅ Código detectado:", decodedText);
  
  // Detener el escáner
  await stopScanner();
  
  // Cerrar el modal del escáner
  closeScannerModal();
  
  // Procesar el código escaneado automáticamente
  await processScannedCode(decodedText);
}

// =============================================
// FUNCIÓN MODIFICADA: Procesar el código escaneado
// =============================================
async function processScannedCode(code) {
  console.log("🔍 Procesando código escaneado:", code);
  
  if (!searchInput) {
    console.error("❌ Campo de búsqueda no encontrado");
    return;
  }
  
  // Limpiar timeout anterior si existe
  if (productNotFoundTimeout) {
    clearTimeout(productNotFoundTimeout);
  }
  
  // Poner el código escaneado en el campo de búsqueda
  searchInput.value = code;
  
  // Enfocar el campo de búsqueda
  searchInput.focus();
  
  // Mostrar mensaje de procesamiento
  showAlert('info', `Buscando producto con código: ${code}`);
  
  try {
    // Buscar el producto automáticamente
    await renderProducts(code, "");
    
    // Verificar si se encontró algún producto
    await checkIfProductExists(code);
    
  } catch (error) {
    console.error("❌ Error al procesar código escaneado:", error);
    showAlert('error', 'Error al buscar el producto');
  }
}

// =============================================
// NUEVA FUNCIÓN: Verificar si el producto existe
// =============================================
async function checkIfProductExists(scannedCode) {
  try {
    // Esperar un momento para que se complete la renderización
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Obtener todos los productos renderizados
    const productItems = document.querySelectorAll('.product-item');
    const productEans = Array.from(productItems).map(item => {
      const eanElement = item.querySelector('.product-ean');
      return eanElement ? eanElement.textContent.trim().replace('', '').trim() : '';
    });
    
    // Verificar si el código escaneado coincide con algún producto
    const productExists = productEans.some(ean => ean === scannedCode);
    
    if (!productExists) {
      // Programar el mensaje de "producto no existe" después de 3 segundos
      productNotFoundTimeout = setTimeout(() => {
        // Verificar nuevamente que el código siga en el buscador
        if (searchInput.value === scannedCode) {
          showAlert('warning', `No existe ningún producto con el código: ${scannedCode}`);
          
          // Limpiar el campo después de mostrar el mensaje
          setTimeout(() => {
            if (searchInput.value === scannedCode) {
              searchInput.value = '';
              console.log("🧹 Campo de búsqueda limpiado - Producto no existe");
            }
          }, 3000);
        }
      }, 3000);
    } else {
      console.log("✅ Producto encontrado:", scannedCode);
    }
    
  } catch (error) {
    console.error("❌ Error al verificar existencia del producto:", error);
  }
}

// Función cuando hay error en el escáner
function onScanError(error) {
  // Solo mostrar errores si no es "NotFoundException" (que es normal cuando no hay código)
  if (!error.includes("NotFoundException")) {
    console.warn("⚠️ Error en el escáner:", error);
  }
}

// Función para abrir el modal del escáner
function openScannerModal() {
  const scannerModal = document.getElementById('scannerModal');
  if (scannerModal) {
    scannerModal.style.display = 'flex';
    
    // Inicializar el escáner si no está inicializado
    if (!html5QrCode) {
      initializeScanner();
    }
    
    // Iniciar el escáner después de un breve delay para asegurar que el modal esté visible
    setTimeout(async () => {
      const started = await startCameraScanner();
      if (!started) {
        // Si no se pudo iniciar la cámara, cerrar el modal
        scannerModal.style.display = 'none';
        showAlert('warning', 'No se pudo acceder a la cámara. Verifica los permisos.');
      }
    }, 500);
  }
}

// Función para cerrar el modal del escáner
function closeScannerModal() {
  const scannerModal = document.getElementById('scannerModal');
  if (scannerModal) {
    scannerModal.style.display = 'none';
    
    // Detener el escáner
    stopScanner();
    
    // Limpiar timeout de "producto no existe"
    if (productNotFoundTimeout) {
      clearTimeout(productNotFoundTimeout);
      productNotFoundTimeout = null;
    }
  }
}

// =============================================
// CONFIGURACIÓN DE IMPUESTOS POR PRODUCTO
// =============================================

// Variables globales para impuestos
let taxConfig = {
  itbis: 18,
  iva: 0,
  activo: false
};

// Función para cargar la configuración de impuestos del usuario
async function loadTaxConfig() {
  try {
    if (!currentCollaborator) return;
    
    // Buscar la configuración de impuestos del usuario del colaborador
    const taxRef = doc(db, "impuesto", currentCollaborator.userId);
    const taxDoc = await getDoc(taxRef);
    
    if (taxDoc.exists()) {
      const taxData = taxDoc.data();
      taxConfig = {
        itbis: taxData.itbis || 18,
        iva: taxData.iva || 0,
        activo: taxData.activo || false
      };
      
      console.log("Configuración de impuestos cargada:", taxConfig);
      updateTaxesUI();
    } else {
      // Crear configuración por defecto si no existe
      await setDoc(taxRef, {
        itbis: 18,
        iva: 0,
        activo: false,
        userId: currentCollaborator.userId,
        createdDate: new Date().toISOString()
      });
      
      console.log("Configuración de impuestos creada por defecto");
      taxConfig = {
        itbis: 18,
        iva: 0,
        activo: false
      };
      updateTaxesUI();
    }
  } catch (error) {
    console.error("Error al cargar configuración de impuestos:", error);
    showAlert('error', 'Error al cargar configuración de impuestos');
  }
}

// Función para aplicar impuestos al precio de un producto específico
function applyTaxesToProduct(price, productData) {
  let finalPrice = price;
  
  // Solo aplicar impuestos si están activados en la configuración general
  if (taxConfig.activo) {
    // Verificar si el producto específico tiene ITBIS asignado
    if (productData.applyItbis) {
      finalPrice = finalPrice + (finalPrice * (taxConfig.itbis / 100));
    }
    
    // Verificar si el producto específico tiene IVA asignado
    if (productData.applyIva) {
      finalPrice = finalPrice + (finalPrice * (taxConfig.iva / 100));
    }
  }
  
  return finalPrice;
}

// Función para mostrar información de impuestos en la factura
function getTaxInfoForProduct(productData) {
  let taxInfo = '';
  
  if (taxConfig.activo) {
    const basePrice = productData.pricePerUnit;
    const itbisAmount = productData.applyItbis ? basePrice * (taxConfig.itbis / 100) : 0;
    const ivaAmount = productData.applyIva ? basePrice * (taxConfig.iva / 100) : 0;
    
    if (productData.applyItbis || productData.applyIva) {
      taxInfo = ` (`;
      if (productData.applyItbis) {
        taxInfo += `ITBIS: $${formatNumberWithCommas(itbisAmount)}`;
      }
      if (productData.applyItbis && productData.applyIva) {
        taxInfo += ', ';
      }
      if (productData.applyIva) {
        taxInfo += `IVA: $${formatNumberWithCommas(ivaAmount)}`;
      }
      taxInfo += `)`;
    }
  }
  
  return taxInfo;
}

// =============================================
// SISTEMA DE TURNOS MEJORADO - TIEMPO REAL
// =============================================

// Variables globales para turnos
let currentShift = null;
let shiftTimer = null;
let shiftAlertTimer = null;
let shiftEndTimer = null;
let shiftListener = null; // Listener para cambios en tiempo real

// CORRECCIÓN: Función para mostrar información del turno en el modal
function showShiftModalInfo() {
  if (!currentShift) return;
  
  const startTime = currentShift.startTime.toDate();
  const endTime = currentShift.endTime.toDate();
  const durationHours = Math.round((endTime - startTime) / (1000 * 60 * 60));
  
  let shiftDurationText = `${durationHours} horas`;
  
  // CORRECCIÓN: Si no es 8 o 12 horas, mostrar "turno ilimitado o turno permanente"
  if (durationHours !== 8 && durationHours !== 12) {
    shiftDurationText = "Sesión Permanente";
  }
  
  // Actualizar información en el modal
  const shiftDetailName = document.getElementById('shiftDetailName');
  const shiftDetailCollaborator = document.getElementById('shiftDetailCollaborator');
  const shiftDetailStart = document.getElementById('shiftDetailStart');
  const shiftDetailEnd = document.getElementById('shiftDetailEnd');
  const shiftDetailDuration = document.getElementById('shiftDetailDuration');
  
  if (shiftDetailName) shiftDetailName.textContent = currentShift.shiftName || '--';
  if (shiftDetailCollaborator) shiftDetailCollaborator.textContent = currentCollaborator ? 
    `${currentCollaborator.firstName} ${currentCollaborator.lastName}` : '--';
  if (shiftDetailStart) shiftDetailStart.textContent = formatTime(startTime);
  if (shiftDetailEnd) shiftDetailEnd.textContent = formatTime(endTime);
  if (shiftDetailDuration) shiftDetailDuration.textContent = shiftDurationText;
}

// Función para verificar el turno del colaborador al iniciar sesión
async function checkCollaboratorShift() {
  try {
    if (!currentCollaborator) {
      console.log("No hay colaborador autenticado");
      return;
    }
    
    console.log("Verificando turno para colaborador:", currentCollaborator.id);
    
    // CONSULTA EXACTA PARA BUSCAR TURNOS ACTIVOS DE ESTE COLABORADOR
    const shiftsQuery = query(
      collection(db, "Shifts"),
      where("collaboratorId", "==", currentCollaborator.id),
      where("active", "==", true)
    );
    
    const shiftsSnapshot = await getDocs(shiftsQuery);
    
    if (shiftsSnapshot.empty) {
      console.log("No hay turno activo para este colaborador");
      showShiftEndScreen("No tienes un turno activo asignado.");
      return;
    }
    
    const shiftDoc = shiftsSnapshot.docs[0];
    currentShift = {
      id: shiftDoc.id,
      ...shiftDoc.data()
    };
    
    console.log("Turno activo encontrado:", currentShift);
    
    // Verificar si el turno ya expiró
    const now = new Date();
    const endTime = currentShift.endTime.toDate();
    
    if (now >= endTime) {
      console.log("El turno ya expiró, finalizando automáticamente");
      await endShiftAutomatically();
      return;
    }
    
    // Configurar temporizadores del turno
    setupShiftTimer();
    
    // Mostrar información del turno
    checkAndShowShiftInfo();
    
    // Configurar listener en tiempo real para cambios en el turno
    setupShiftRealTimeListener();
    
  } catch (error) {
    console.error("Error verificando turno del colaborador:", error);
    showShiftEndScreen("Error al verificar el turno. Contacte al administrador.");
  }
}

// Configurar listener en tiempo real para cambios en el turno
function setupShiftRealTimeListener() {
  if (!currentCollaborator) return;
  
  // Limpiar listener anterior si existe
  if (shiftListener) {
    shiftListener();
  }
  
  // CONSULTA EXACTA PARA BUSCAR TURNOS ACTIVOS DE ESTE COLABORADOR
  const shiftsQuery = query(
    collection(db, "Shifts"),
    where("collaboratorId", "==", currentCollaborator.id),
    where("active", "==", true)
  );
  
  // Configurar listener en tiempo real
  shiftListener = onSnapshot(shiftsQuery, async (shiftsSnapshot) => {
    console.log("Cambio detectado en turnos - Documentos:", shiftsSnapshot.size);
    
    if (shiftsSnapshot.empty) {
      console.log("No hay turno activo para este colaborador (en tiempo real)");
      // Si había un turno activo previamente, finalizarlo
      if (currentShift) {
        await endShiftAutomatically();
      }
      return;
    }
    
    const shiftDoc = shiftsSnapshot.docs[0];
    const newShiftData = {
      id: shiftDoc.id,
      ...shiftDoc.data()
    };
    
    console.log("Turno activo encontrado/en tiempo real:", newShiftData);
    
    // Verificar si es un turno nuevo o reactivado
    if (!currentShift || currentShift.id !== newShiftData.id) {
      console.log("Nuevo turno detectado o reactivado - Inicializando...");
      currentShift = newShiftData;
      await handleShiftActivation();
    } else {
      console.log("Turno existente actualizado");
      // Actualizar datos del turno existente
      currentShift = newShiftData;
      updateShiftUI();
    }
  }, (error) => {
    console.error("Error en listener de turnos:", error);
  });
}

// Manejar activación de turno (nuevo o reactivado)
async function handleShiftActivation() {
  try {
    console.log("Manejando activación de turno");
    
    // Verificar si el turno ya expiró
    const now = new Date();
    const endTime = currentShift.endTime.toDate();
    
    if (now >= endTime) {
      console.log("El turno ya expiró, finalizando automáticamente");
      await endShiftAutomatically();
      return;
    }
    
    // Si estamos en la pantalla de fin de turno, ocultarla
    const shiftEndScreen = document.getElementById('shiftEndScreen');
    if (shiftEndScreen && shiftEndScreen.style.display === 'flex') {
      shiftEndScreen.style.display = 'none';
      console.log("Pantalla de fin de turno ocultada");
    }
    
    // Mostrar la sección POS si estaba oculta
    const posSection = document.getElementById('posSection');
    if (posSection && posSection.style.display === 'none') {
      posSection.style.display = 'block';
      console.log("Sección POS mostrada");
    }
    
    // Configurar temporizadores del turno
    setupShiftTimer();
    
    // Mostrar información del turno si corresponde
    checkAndShowShiftInfo();
    
    // Mostrar alerta de turno activado
    showAlert('success', `¡Turno activado! "${currentShift.shiftName}" - Bienvenido ${currentCollaborator.firstName}`);
    
    console.log("Turno activado exitosamente");
    
  } catch (error) {
    console.error("Error activando turno:", error);
    showAlert('error', 'Error al activar el turno');
  }
}

// Verificar y mostrar información del turno según los minutos restantes
function checkAndShowShiftInfo() {
  if (!currentShift) return;
  
  const now = new Date();
  const endTime = currentShift.endTime.toDate();
  const diff = endTime - now;
  const minutesRemaining = Math.floor(diff / (1000 * 60));
  
  console.log("Minutos restantes para mostrar info:", minutesRemaining, "Alert time:", currentShift.alertTime);
  
  // Mostrar el contenedor solo si estamos en los minutos de alerta o menos
  if (minutesRemaining <= currentShift.alertTime) {
    showShiftInfo();
  } else {
    // Ocultar el contenedor si no estamos en los minutos de alerta
    hideShiftInfo();
  }
}

// Mostrar información del turno
function showShiftInfo() {
  const shiftInfoElement = document.getElementById('shiftInfo');
  const shiftNameDisplay = document.getElementById('shiftNameDisplay');
  const shiftStartTime = document.getElementById('shiftStartTime');
  const shiftEndTime = document.getElementById('shiftEndTime');
  
  if (shiftInfoElement && shiftNameDisplay && shiftStartTime && shiftEndTime) {
    const startTime = currentShift.startTime.toDate();
    const endTime = currentShift.endTime.toDate();
    
    shiftNameDisplay.textContent = currentShift.shiftName;
    shiftStartTime.textContent = formatTime(startTime);
    shiftEndTime.textContent = formatTime(endTime);
    
    shiftInfoElement.style.display = 'block';
    console.log("Mostrando información del turno");
  }
}

// Ocultar información del turno
function hideShiftInfo() {
  const shiftInfoElement = document.getElementById('shiftInfo');
  if (shiftInfoElement) {
    shiftInfoElement.style.display = 'none';
    console.log("Ocultando información del turno");
  }
}

// Actualizar UI del turno
function updateShiftUI() {
  if (!currentShift) return;
  
  // Verificar si debemos mostrar u ocultar la información
  checkAndShowShiftInfo();
  
  // Actualizar cuenta regresiva
  updateShiftCountdown();
}

// Función para configurar temporizador del turno
function setupShiftTimer() {
  if (!currentShift) return;
  
  // Limpiar temporizadores existentes
  if (shiftTimer) clearInterval(shiftTimer);
  if (shiftAlertTimer) clearTimeout(shiftAlertTimer);
  if (shiftEndTimer) clearTimeout(shiftEndTimer);
  
  const now = new Date();
  const endTime = currentShift.endTime.toDate();
  
  console.log("Configurando temporizador del turno. Tiempo restante:", Math.floor((endTime - now) / (1000 * 60)), "minutos");
  
  // Configurar temporizador principal (actualización cada segundo)
  shiftTimer = setInterval(() => {
    const now = new Date();
    const endTime = currentShift.endTime.toDate();
    
    if (now >= endTime) {
      endShiftAutomatically();
    } else {
      updateShiftCountdown();
      // Verificar dinámicamente si debemos mostrar/ocultar la información
      checkAndShowShiftInfo();
    }
  }, 1000);
  
  // Configurar alerta anticipada
  const alertTime = new Date(endTime);
  alertTime.setMinutes(alertTime.getMinutes() - currentShift.alertTime);
  
  const alertDiff = alertTime - now;
  
  if (alertDiff > 0) {
    console.log("Alerta programada en", Math.floor(alertDiff / (1000 * 60)), "minutos");
    shiftAlertTimer = setTimeout(() => {
      showShiftAlert();
      // Mostrar información cuando llegue el tiempo de alerta
      showShiftInfo();
    }, alertDiff);
  } else if (alertDiff <= 0) {
    // Si ya estamos en el tiempo de alerta, mostrar la información inmediatamente
    console.log("Ya estamos en tiempo de alerta, mostrando información inmediatamente");
    showShiftInfo();
  }
  
  // Configurar finalización automática
  const endDiff = endTime - now;
  
  if (endDiff > 0) {
    console.log("Finalización automática programada en", Math.floor(endDiff / (1000 * 60)), "minutos");
    shiftEndTimer = setTimeout(() => {
      endShiftAutomatically();
    }, endDiff);
  }
  
  // Actualizar cuenta regresiva inicial
  updateShiftCountdown();
  // Verificar inicialmente si debemos mostrar la información
  checkAndShowShiftInfo();
}

// Función para actualizar cuenta regresiva
function updateShiftCountdown() {
  if (!currentShift) return;
  
  const countdownElement = document.getElementById('shiftCountdown');
  if (!countdownElement) return;
  
  const now = new Date();
  const endTime = currentShift.endTime.toDate();
  const diff = endTime - now;
  
  if (diff <= 0) {
    countdownElement.textContent = '00:00:00';
    countdownElement.className = 'shift-countdown danger';
    return;
  }
  
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  countdownElement.textContent = timeString;
  
  // Cambiar color según el tiempo restante
  if (hours === 0 && minutes < currentShift.alertTime) {
    countdownElement.className = 'shift-countdown warning';
  } else {
    countdownElement.className = 'shift-countdown';
  }
}

// Función para mostrar alerta de turno
function showShiftAlert() {
  if (!currentShift) return;
  
  const timeRemaining = calculateTimeRemaining(new Date(currentShift.endTime.toDate()));
  
  if (timeRemaining.minutes > 0) {
    showAlert('warning', 
      `¡Atención ${currentCollaborator.firstName}! Tu turno "${currentShift.shiftName}" finalizará en ${timeRemaining.minutes} minutos.`
    );
  }
}

// Función para finalizar turno automáticamente
async function endShiftAutomatically() {
  try {
    if (!currentShift || !currentCollaborator) return;
    
    console.log("Finalizando turno automáticamente");
    
    // Limpiar temporizadores
    if (shiftTimer) clearInterval(shiftTimer);
    if (shiftAlertTimer) clearTimeout(shiftAlertTimer);
    if (shiftEndTimer) clearTimeout(shiftEndTimer);
    
    const endTime = new Date();
    
    // Guardar en historial - CON LOS MISMOS DATOS DEL COLABORADOR
    await addDoc(collection(db, "ShiftHistory"), {
      userId: currentCollaborator.userId,
      collaboratorId: currentCollaborator.id,
      collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
      collaboratorCode: currentCollaborator.code,
      collaboratorUsername: currentCollaborator.username,
      shiftName: currentShift.shiftName,
      startTime: currentShift.startTime,
      endTime: Timestamp.fromDate(endTime),
      duration: Math.round((endTime - currentShift.startTime.toDate()) / (1000 * 60 * 60)),
      totalHours: Math.round((endTime - currentShift.startTime.toDate()) / (1000 * 60 * 60)),
      automatic: true,
      date: Timestamp.fromDate(endTime),
      createdAt: Timestamp.now()
    });
    
    // Actualizar estado del turno
    await updateDoc(doc(db, "Shifts", currentShift.id), {
      active: false,
      endTime: Timestamp.fromDate(endTime)
    });
    
    // Limpiar referencia al turno actual
    currentShift = null;
    
    // Mostrar pantalla de fin de turno
    showShiftEndScreen(`Tu turno ha terminado.`);
    
  } catch (error) {
    console.error("Error finalizando turno automáticamente:", error);
    showShiftEndScreen("Error al finalizar el turno automáticamente.");
  }
}

// Función para mostrar pantalla de fin de turno
function showShiftEndScreen(message = "Tu turno ha terminado.") {
  // Ocultar sección del POS
  const posSection = document.getElementById('posSection');
  if (posSection) {
    posSection.style.display = 'none';
  }
  
  // Ocultar información del turno
  hideShiftInfo();
  
  // Mostrar pantalla de fin de turno
  const shiftEndScreen = document.getElementById('shiftEndScreen');
  const shiftEndMessage = document.getElementById('shiftEndMessage');
  const shiftEndDetails = document.getElementById('shiftEndDetails');
  const shiftEndUserName = document.getElementById('shiftEndUserName');
  
  if (shiftEndScreen && shiftEndMessage && shiftEndDetails && shiftEndUserName) {
    shiftEndMessage.textContent = message;
    shiftEndUserName.textContent = currentCollaborator ? 
      `${currentCollaborator.firstName} ${currentCollaborator.lastName}` : 'Colaborador';
    
    // Añadir detalles específicos del turno si está disponible
    if (currentShift) {
      shiftEndDetails.innerHTML = `
        Hola <strong>${currentCollaborator.firstName} ${currentCollaborator.lastName}</strong>, 
        tu turno <strong>"${currentShift.shiftName}"</strong> ha finalizado. 
        Ya es hora de revisar tus ventas realizadas el día de hoy.
      `;
    }
    
    shiftEndScreen.style.display = 'flex';
  }
} 

// Función auxiliar para formatear hora
function formatTime(date) {
  return date.toLocaleTimeString('es-ES', {
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Función auxiliar para calcular tiempo restante
function calculateTimeRemaining(endTime) {
  const now = new Date();
  const diff = endTime - now;
  
  if (diff <= 0) {
    return { expired: true, hours: 0, minutes: 0, seconds: 0 };
  }
  
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  return { expired: false, hours, minutes, seconds };
}

// Mostrar detalles elegantes del turno - CORREGIDA
function showShiftDetails() {
  if (!currentShift) {
    showAlert('info', 'No hay turno activo actualmente');
    return;
  }
  
  // CORRECCIÓN: Mostrar información del turno en el modal
  showShiftModalInfo();
  
  const shiftDetailsModal = document.getElementById('shiftDetailsModal');
  const shiftDetailTimer = document.getElementById('shiftDetailTimer');
  
  if (shiftDetailsModal && shiftDetailTimer) {
    
    // Actualizar el temporizador en tiempo real
    const updateShiftDetailTimer = () => {
      if (!currentShift) return;
      
      const now = new Date();
      const endTime = currentShift.endTime.toDate();
      const diff = endTime - now;
      
      if (diff <= 0) {
        shiftDetailTimer.textContent = '00:00:00';
        shiftDetailTimer.className = 'shift-timer danger';
        clearInterval(shiftDetailTimerInterval);
        return;
      }
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      shiftDetailTimer.textContent = timeString;
      
      // Cambiar color según el tiempo restante
      if (hours === 0 && minutes < currentShift.alertTime) {
        shiftDetailTimer.className = 'shift-timer warning';
      } else {
        shiftDetailTimer.className = 'shift-timer';
      }
    };
    
    // Actualizar inmediatamente
    updateShiftDetailTimer();
    
    // Configurar intervalo para actualizar en tiempo real
    const shiftDetailTimerInterval = setInterval(updateShiftDetailTimer, 1000);
    
    // Limpiar intervalo cuando se cierre el modal
    const closeShiftDetailsBtn = document.getElementById('closeShiftDetailsBtn');
    const closeShiftDetails = document.getElementById('closeShiftDetails');
    
    const closeModalHandler = () => {
      clearInterval(shiftDetailTimerInterval);
      shiftDetailsModal.style.display = 'none';
    };
    
    closeShiftDetailsBtn.onclick = closeModalHandler;
    closeShiftDetails.onclick = closeModalHandler;
    
    shiftDetailsModal.style.display = 'flex';
  }
}

// Elementos del DOM
const loginSection = document.getElementById("loginSection");
const loginLoading = document.getElementById("loginLoading");
const loginCustomLoader = document.getElementById("loginCustomLoader");
const posSection = document.getElementById("posSection");
const loginUsername = document.getElementById("loginUsername");
const loginPin = document.getElementById("loginPin");
const loginButton = document.getElementById("loginButton");
const loginError = document.getElementById("loginError");
const globalLoading = document.getElementById("globalLoading");
const globalCustomLoader = document.getElementById("globalCustomLoader");
const loginLogo = document.getElementById("loginLogo");
const copyToast = document.getElementById("copyToast");

const searchInput = document.getElementById("searchInput");
const searchByNameInput = document.getElementById("searchByNameInput");
const productList = document.getElementById("productList");
const invoiceItems = document.getElementById("invoiceItems");
const invoiceTotal = document.getElementById("invoiceTotal");
const usdTotal = document.getElementById("usdTotal");
const eurTotal = document.getElementById("eurTotal");
const payButton = document.getElementById("payButton");
const numericKeyboard = document.getElementById("numericKeyboard");
const textKeyboard = document.getElementById("textKeyboard");
const invoiceUser = document.getElementById("invoiceUser");

// CORRECCIÓN: Elementos del logo en el header
const headerLogo = document.getElementById("headerLogo");
const userAvatar = document.getElementById("userAvatar");

// Botones de vista de productos
const viewGrid = document.getElementById("viewGrid");
const viewList = document.getElementById("viewList");

// Elementos de facturación
const btnEfectivo = document.getElementById("btnEfectivo");
const btnTarjeta = document.getElementById("btnTarjeta");
const btnApplyDiscount = document.getElementById("btnApplyDiscount");
const printModal = document.getElementById("printModal");
const invoicePrintContent = document.getElementById("invoicePrintContent");
const closeModal = document.getElementById("closeModal");
const btnPrint = document.getElementById("btnPrint");

const efectivoModal = document.getElementById("efectivoModal");
const closeEfectivoModal = document.getElementById("closeEfectivoModal");
const efectivoReceived = document.getElementById("efectivoReceived");
const efectivoReceivedDisplay = document.getElementById("efectivoReceivedDisplay");
const efectivoTotal = document.getElementById("efectivoTotal");
const efectivoChange = document.getElementById("efectivoChange");
const confirmEfectivo = document.getElementById("confirmEfectivo");
const cancelEfectivo = document.getElementById("cancelEfectivo");

const tarjetaModal = document.getElementById("tarjetaModal");
const closeTarjetaModal = document.getElementById("closeTarjetaModal");
const tarjetaTotal = document.getElementById("tarjetaTotal");
const confirmTarjeta = document.getElementById("confirmTarjeta");

const passwordModal = document.getElementById("passwordModal");
const closePasswordModal = document.getElementById("closePasswordModal");
const passwordInput = document.getElementById("passwordInput");
const passwordKeyboardIcon = document.getElementById("passwordKeyboardIcon");
const submitPassword = document.getElementById("submitPassword");
const passwordError = document.getElementById("passwordError");

const discountAppliedModal = document.getElementById("discountAppliedModal");
const closeDiscountModal = document.getElementById("closeDiscountModal");
const discountMessage = document.getElementById("discountMessage");

// Elementos de navegación (header)
const homeBtn = document.getElementById("homeBtn");
const inventoryBtn = document.getElementById("inventoryBtn");
const reportsBtn = document.getElementById("reportsBtn");
const invoicesBtn = document.getElementById("invoicesBtn");
const salesAnalysisBtn = document.getElementById("salesAnalysisBtn");
const userBtn = document.getElementById("userBtn");
const clockBtn = document.getElementById("clockBtn");
const ratesBtn = document.getElementById("ratesBtn");
const taxesBtn = document.getElementById("taxesBtn");
const returnsBtn = document.getElementById("returnsBtn");
const refreshBtn = document.getElementById("refreshBtn");
const advancedMenuBtn = document.getElementById("advancedMenuBtn");
const advancedMenu = document.getElementById("advancedMenu");
const taxBadge = document.getElementById("taxBadge");

// Elementos del modal de impuestos
const taxesModal = document.getElementById("taxesModal");
const closeTaxesModal = document.getElementById("closeTaxesModal");
const itbisValue = document.getElementById("itbisValue");
const ivaValue = document.getElementById("ivaValue");
const itbisStatus = document.getElementById("itbisStatus");
const ivaStatus = document.getElementById("ivaStatus");

// Secciones
const productListSection = document.getElementById("productListSection");
const invoiceSection = document.getElementById("invoiceSection");

// Modales de usuario
const userInfoModal = document.getElementById("userInfoModal");
const closeUserModal = document.getElementById("closeUserModal");
const userName = document.getElementById("userName");
const userEmail = document.getElementById("userEmail");
const logoutBtn = document.getElementById("logoutBtn");

// Modales de tasas de cambio
const ratesModal = document.getElementById("ratesModal");
const closeRatesModal = document.getElementById("closeRatesModal");
const currentUsdRate = document.getElementById("currentUsdRate");
const currentEurRate = document.getElementById("currentEurRate");

// Alertas elegantes
const successAlert = document.getElementById("successAlert");
const successMessage = document.getElementById("successMessage");
const closeSuccessAlert = document.getElementById("closeSuccessAlert");
const successOkBtn = document.getElementById("successOkBtn");

const errorAlert = document.getElementById("errorAlert");
const errorMessage = document.getElementById("errorMessage");
const closeErrorAlert = document.getElementById("closeErrorAlert");
const errorOkBtn = document.getElementById("errorOkBtn");

const warningAlert = document.getElementById("warningAlert");
const warningMessage = document.getElementById("warningMessage");
const closeWarningAlert = document.getElementById("closeWarningAlert");
const warningOkBtn = document.getElementById("warningOkBtn");

// Elementos de teclados virtuales
const switchToTextKeyboard = document.getElementById("switchToTextKeyboard");
const switchToNumericKeyboard = document.getElementById("switchToNumericKeyboard");
const closeNumericKeyboard = document.getElementById("closeNumericKeyboard");
const shiftBtn = document.getElementById("shiftBtn");
const numberToggle = document.getElementById("numberToggle");

// Elementos del menú avanzado
const quickStatsBtn = document.getElementById("quickStatsBtn");
const backupBtn = document.getElementById("backupBtn");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const bulkDiscountBtn = document.getElementById("bulkDiscountBtn");
const priceUpdateBtn = document.getElementById("priceUpdateBtn");
const stockAlertBtn = document.getElementById("stockAlertBtn");
const customerManagementBtn = document.getElementById("customerManagementBtn");
const supplierManagementBtn = document.getElementById("supplierManagementBtn");

// Loading local para productos
const productLoading = document.getElementById("productLoading");

// Elementos de fin de turno
const shiftEndScreen = document.getElementById("shiftEndScreen");
const changeAccountBtn = document.getElementById("changeAccountBtn");
const reloadBtn = document.getElementById("reloadBtn");

// Elementos del teclado de contraseña de impuestos
const taxPasswordKeyboard = document.getElementById("taxPasswordKeyboard");
const closeTaxPasswordKeyboard = document.getElementById("closeTaxPasswordKeyboard");
const taxPasswordShiftBtn = document.getElementById("taxPasswordShiftBtn");
const taxPasswordSymbolToggle = document.getElementById("taxPasswordSymbolToggle");
const taxPasswordSymbolToggle2 = document.getElementById("taxPasswordSymbolToggle2");
const lettersKeyboard = document.getElementById("lettersKeyboard");
const symbolsKeyboard = document.getElementById("symbolsKeyboard");

// NUEVO: Elementos del escáner (modificados)
const scannerBtnInside = document.getElementById("scannerBtnInside");
const scannerModal = document.getElementById("scannerModal");
const closeScanner = document.getElementById("closeScanner");
const switchCameraBtn = document.getElementById("switchCameraBtn");
const uploadImageBtn = document.getElementById("uploadImageBtn");
const imageUploadInput = document.getElementById("imageUploadInput");
const scannerResult = document.getElementById("scannerResult"); // Ya no se usa, pero se mantiene por compatibilidad
const scannedCode = document.getElementById("scannedCode"); // Ya no se usa, pero se mantiene por compatibilidad
const scannerResultOk = document.getElementById("scannerResultOk"); // Ya no se usa, pero se mantiene por compatibilidad

// Variables globales
let invoice = [];
let totalPrice = 0;
let currentUser = null;
let userPermissions = []; // Permisos del usuario
let exchangeRates = { usd: 56.50, eur: 61.20 }; // Tasas de cambio
let discount = 0;
let discountedTotal = 0;
let invoiceId = null;
let isShiftPressed = false;
let amountReceived = 0; // Variable para almacenar el monto recibido
let currentView = 'grid'; // Vista actual de productos
let isOnline = navigator.onLine; // Estado de conexión
let currentTaxes = { itbis: 18, iva: 0 }; // Valores actuales de impuestos (ahora usando taxConfig)
let productsLoaded = false; // Control para evitar duplicación de productos
let productUnsubscribe = null; // Para manejar el listener de productos en tiempo real
let currentActiveSearchInput = null; // Para controlar qué campo de búsqueda está activo
let returnQuantities = []; // Para almacenar las cantidades a devolver
let productsMap = new Map(); // Para evitar duplicados de productos
let lastSearchTerm = ""; // Para controlar la búsqueda anterior
let isRendering = false; // Para evitar renderizados duplicados
let realTimeListeners = []; // Array para almacenar todos los listeners en tiempo real
let businessDetails = null; // Para almacenar los detalles de la empresa
let currentCollaborator = null; // Para almacenar la información del colaborador actual
let discountSettings = null; // Para almacenar la configuración de descuentos del usuario
let isTaxPasswordShiftPressed = false; // Para el teclado de contraseña de impuestos
let isTaxPasswordSymbolsVisible = false; // Para alternar entre letras y símbolos

// =============================================
// Configuración de teclas de acceso rápido
// =============================================
document.addEventListener('keydown', (e) => {
  // Ctrl+D para aplicar descuento
  if (e.ctrlKey && e.key === 'd' && !e.altKey) {
    e.preventDefault();
    console.log("Ctrl+D presionado - Aplicando descuento");
    if (typeof btnApplyDiscount !== 'undefined' && btnApplyDiscount) {
      btnApplyDiscount.click();
    }
  }
  
  // Ctrl+E para pago en efectivo
  if (e.ctrlKey && e.key === 'e' && !e.altKey) {
    e.preventDefault();
    console.log("Ctrl+E presionado - Abriendo pago en efectivo");
    if (typeof btnEfectivo !== 'undefined' && btnEfectivo) {
      btnEfectivo.click();
    }
  }
  
  // Ctrl+T para pago con tarjeta
  if (e.ctrlKey && e.key === 't' && !e.altKey) {
    e.preventDefault();
    console.log("Ctrl+T presionado - Abriendo pago con tarjeta");
    if (typeof btnTarjeta !== 'undefined' && btnTarjeta) {
      btnTarjeta.click();
    }
  }
  
  // Ctrl+Alt+P para acceso rápido (Panel de Control)
  if (e.ctrlKey && e.altKey && e.key === 'p') {
    e.preventDefault();
    console.log("Ctrl+Alt+P presionado - Mostrando panel de control");
    const quickAccessModal = document.getElementById('quickAccessModal');
    if (quickAccessModal) {
      quickAccessModal.style.display = 'flex';
    }
  }
  
  // Ctrl+Y (si lo necesitas)
  if (e.ctrlKey && e.key === 'y' && !e.altKey) {
    e.preventDefault();
    console.log("Ctrl+Y presionado");
    // Aquí puedes agregar la funcionalidad específica para Ctrl+Y
    // showAlert('info', 'Ctrl+Y presionado');
  }
  
  // Supr para limpiar el buscador EAN/UPC
  if (e.key === 'Delete' || e.key === 'Del') {
    e.preventDefault();
    if (posSection && posSection.style.display === 'block') {
      const focusedElement = document.activeElement;
      
      if (focusedElement === searchInput || focusedElement === searchByNameInput) {
        focusedElement.value = '';
        if (typeof loadCollaboratorProducts !== 'undefined') {
          loadCollaboratorProducts();
        }
      } else {
        if (searchInput) {
          searchInput.value = '';
          if (typeof loadCollaboratorProducts !== 'undefined') {
            loadCollaboratorProducts();
          }
          searchInput.focus();
        }
      }
    }
  }
  
  // Enter para aceptar/confirmar
  if (e.key === 'Enter') {
    if (efectivoModal && efectivoModal.style.display === 'flex') {
      if (typeof confirmEfectivo !== 'undefined' && confirmEfectivo) {
        confirmEfectivo.click();
      }
    } else if (tarjetaModal && tarjetaModal.style.display === 'flex') { 
      if (typeof confirmTarjeta !== 'undefined' && confirmTarjeta) {
        confirmTarjeta.click();
      }
    } else if (passwordModal && passwordModal.style.display === 'block') {
      if (typeof submitPassword !== 'undefined' && submitPassword) {
        submitPassword.click();
      }
    } else if (numericKeyboard && numericKeyboard.style.display === 'block') {
      const acceptBtn = document.querySelector('#acceptBtn');
      if (acceptBtn) acceptBtn.click();
    } else if (textKeyboard && textKeyboard.style.display === 'block') {
      const enterBtn = document.querySelector('.text-keyboard .enter');
      if (enterBtn) enterBtn.click();
    }
  }
  
  // Tab para cambiar vista de productos
  if (e.key === 'Tab' && !e.ctrlKey) { 
    e.preventDefault();
    if (typeof setProductView !== 'undefined') {
      if (currentView === 'grid') { 
        setProductView('list'); 
      } else { 
        setProductView('grid'); 
      }
    }
  }
  
  // F5 o Ctrl+R para recargar
  if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
    e.preventDefault();
    if (typeof refreshBtn !== 'undefined' && refreshBtn) {
      refreshBtn.click();
    }
  }
  
  // Esc para cerrar modales
  if (e.key === 'Escape') {
    e.preventDefault();
    const openModals = document.querySelectorAll('.modal[style*="display: flex"], .modal[style*="display: block"]');
    openModals.forEach(modal => {
      const closeBtn = modal.querySelector('.close');
      if (closeBtn) closeBtn.click();
    });
    if (advancedMenu && advancedMenu.style.display === 'block') {
      advancedMenu.style.display = 'none';
    }
  }
});


// Verificar vencimiento del producto CON ALERT DAYS PERSONALIZADO
async function checkProductExpiration(product, businessName, productId) {
  try {
    // Obtener información de vencimiento del producto
    const productRef = doc(db, "businesses", businessName, "products", productId);
    const productDoc = await getDoc(productRef);
    
    if (productDoc.exists()) {
      const productData = productDoc.data();
      
      // Verificar si el producto tiene fecha de vencimiento
      if (productData.expirationDate) {
        const expirationDate = new Date(productData.expirationDate);
        const today = new Date();
        const timeDiff = expirationDate.getTime() - today.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        
        // Obtener los días de alerta personalizados del producto (si existen)
        const alertDays = productData.alertDays || 30; // Valor por defecto si no está configurado
        
        // Si el producto ya está vencido
        if (daysDiff < 0) {
          return {
            expired: true,
            days: daysDiff,
            message: `Este producto está VENCIDO hace ${Math.abs(daysDiff)} días.`,
            alertDays: alertDays
          };
        }
        // Si al producto le faltan X días o menos para vencer (X = alertDays personalizado)
        else if (daysDiff <= alertDays) {
          return {
            expired: false,
            days: daysDiff,
            message: `Este producto está PRÓXIMO A VENCER. Le faltan ${daysDiff} días (Alerta configurada: ${alertDays} días). Usted asume toda responsabilidad en caso de facturar este producto. ¿Desea continuar con la venta?`,
            alertDays: alertDays
          };
        }
      }
    }
    
    // Si no hay fecha de vencimiento o no está próximo a vencer
    return {
      expired: false,
      days: null,
      message: null,
      alertDays: 30 // Valor por defecto
    };
  } catch (error) {
    console.error("Error al verificar vencimiento del producto:", error);
    return {
      expired: false,
      days: null,
      message: null,
      alertDays: 30 // Valor por defecto
    };
  }
}

// Mostrar alerta de vencimiento CON INFORMACIÓN DE ALERT DAYS
function showExpirationAlert(product, businessName, productId, expirationInfo) {
  return new Promise((resolve) => {
    // Crear modal personalizado para vencimiento
    const expirationModal = document.createElement('div');
    expirationModal.style.position = 'fixed';
    expirationModal.style.top = '0';
    expirationModal.style.left = '0';
    expirationModal.style.width = '100%';
    expirationModal.style.height = '100%';
    expirationModal.style.backgroundColor = 'rgba(0,0,0,0.7)';
    expirationModal.style.display = 'flex';
    expirationModal.style.justifyContent = 'center';
    expirationModal.style.alignItems = 'center';
    expirationModal.style.zIndex = '2000';
    
    // Contenido del modal
    const modalContent = document.createElement('div');
    modalContent.style.backgroundColor = expirationInfo.expired ? '#e74c3c' : '#f39c12';
    modalContent.style.padding = '25px';
    modalContent.style.borderRadius = '12px';
    modalContent.style.boxShadow = '0 8px 25px rgba(0,0,0,0.5)';
    modalContent.style.maxWidth = '450px';
    modalContent.style.width = '90%';
    modalContent.style.textAlign = 'center';
    modalContent.style.color = 'white';
    
    // Icono según el estado
    const icon = document.createElement('i');
    icon.className = expirationInfo.expired ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle';
    icon.style.fontSize = '42px';
    icon.style.marginBottom = '15px';
    icon.style.display = 'block';
    
    // Título
    const title = document.createElement('h2');
    title.textContent = expirationInfo.expired ? 'PRODUCTO VENCIDO' : 'PRODUCTO PRÓXIMO A VENCER';
    title.style.marginBottom = '15px';
    title.style.fontSize = '20px'; 
     
    // Mensaje
    const message = document.createElement('p');
    message.textContent = expirationInfo.message;
    message.style.marginBottom = '25px';
    message.style.fontSize = '16px';
    message.style.lineHeight = '1.5';
    
    // Información adicional sobre alert days personalizados
    if (!expirationInfo.expired && expirationInfo.alertDays !== 30) {
      const alertInfo = document.createElement('div');
      alertInfo.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
      alertInfo.style.padding = '10px';
      alertInfo.style.borderRadius = '8px';
      alertInfo.style.marginBottom = '15px';
      alertInfo.style.fontSize = '14px';
      alertInfo.innerHTML = `<strong>Configuración personalizada:</strong> Este producto tiene alertas configuradas para ${expirationInfo.alertDays} días antes del vencimiento.`;
      modalContent.appendChild(alertInfo);
    }
    
    // Botones
    const buttonContainer = document.createElement('div');
    buttonContainer.style.display = 'flex';
    buttonContainer.style.justifyContent = 'center';
    buttonContainer.style.gap = '12px';
    
    if (expirationInfo.expired) {
      // Solo botón de aceptar para productos vencidos
      const acceptButton = document.createElement('button');
      acceptButton.textContent = 'ACEPTAR';
      acceptButton.style.padding = '10px 25px';
      acceptButton.style.border = 'none';
      acceptButton.style.borderRadius = '5px';
      acceptButton.style.backgroundColor = '#fff';
      acceptButton.style.color = expirationInfo.expired ? '#e74c3c' : '#f39c12';
      acceptButton.style.fontWeight = 'bold';
      acceptButton.style.cursor = 'pointer';
      acceptButton.style.transition = 'transform 0.2s, box-shadow 0.2s';
      
      acceptButton.addEventListener('mouseover', () => {
        acceptButton.style.transform = 'scale(1.05)';
        acceptButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
      });
      
      acceptButton.addEventListener('mouseout', () => {
        acceptButton.style.transform = 'scale(1)';
        acceptButton.style.boxShadow = 'none';
      });
      
      acceptButton.addEventListener('click', () => {
        document.body.removeChild(expirationModal);
        // Reactivar el buscador después de cerrar el modal
        setTimeout(() => {
          searchInput.focus();
        }, 100);
        resolve(false); // No permitir la venta
      });
      
      buttonContainer.appendChild(acceptButton);
    } else {
      // Botones de Sí y No para productos próximos a vencer
      const yesButton = document.createElement('button');
      yesButton.textContent = 'SÍ, VENDER';
      yesButton.style.padding = '10px 25px';
      yesButton.style.border = 'none';
      yesButton.style.borderRadius = '5px';
      yesButton.style.backgroundColor = '#2ecc71';
      yesButton.style.color = 'white';
      yesButton.style.fontWeight = 'bold';
      yesButton.style.cursor = 'pointer';
      yesButton.style.transition = 'transform 0.2s, box-shadow 0.2s';
      
      yesButton.addEventListener('mouseover', () => {
        yesButton.style.transform = 'scale(1.05)';
        yesButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
      });
      
      yesButton.addEventListener('mouseout', () => {
        yesButton.style.transform = 'scale(1)';
        yesButton.style.boxShadow = 'none';
      });
      
      yesButton.addEventListener('click', () => {
        document.body.removeChild(expirationModal);
        // Reactivar el buscador después de cerrar el modal
        setTimeout(() => {
          searchInput.focus();
        }, 100);
        resolve(true); // Permitir la venta
      });
      
      const noButton = document.createElement('button');
      noButton.textContent = 'NO, CANCELAR';
      noButton.style.padding = '10px 25px';
      noButton.style.border = 'none';
      noButton.style.borderRadius = '5px';
      noButton.style.backgroundColor = '#e74c3c';
      noButton.style.color = 'white';
      noButton.style.fontWeight = 'bold';
      noButton.style.cursor = 'pointer';
      noButton.style.transition = 'transform 0.2s, box-shadow 0.2s';
      
      noButton.addEventListener('mouseover', () => {
        noButton.style.transform = 'scale(1.05)';
        noButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
      });
      
      noButton.addEventListener('mouseout', () => {
        noButton.style.transform = 'scale(1)';
        noButton.style.boxShadow = 'none';
      });
      
      noButton.addEventListener('click', () => {
        document.body.removeChild(expirationModal);
        // Reactivar el buscador después de cerrar el modal
        setTimeout(() => {
          searchInput.focus();
        }, 100);
        resolve(false); // No permitir la venta
      });
      
      buttonContainer.appendChild(yesButton);
      buttonContainer.appendChild(noButton);
    }
    
    // Agregar elementos al modal
    modalContent.appendChild(icon);
    modalContent.appendChild(title);
    modalContent.appendChild(message);
    modalContent.appendChild(buttonContainer);
    
    expirationModal.appendChild(modalContent);
    document.body.appendChild(expirationModal);
  });
}

// Función para cargar tasas de cambio del usuario específico
const loadExchangeRates = async () => {
  try {
    // Si no hay colaborador autenticado, usar tasas por defecto
    if (!currentCollaborator) {
      exchangeRates = { usd: 56.50, eur: 61.20 };
      currentUsdRate.textContent = `$${exchangeRates.usd}`;
      currentEurRate.textContent = `€${exchangeRates.eur}`;
      return;
    }

    // Buscar tasas de cambio del usuario específico (userId del colaborador)
    const ratesRef = doc(db, "exchangeRates", currentCollaborator.userId);
    const ratesDoc = await getDoc(ratesRef);
    
    if (ratesDoc.exists()) {
      const ratesData = ratesDoc.data();
      exchangeRates = {
        usd: ratesData.usd || 56.50,
        eur: ratesData.eur || 61.20
      };
      currentUsdRate.textContent = `$${exchangeRates.usd}`;
      currentEurRate.textContent = `€${exchangeRates.eur}`;
    } else {
      // Si no existe configuración, usar tasas por defecto
      exchangeRates = { usd: 56.50, eur: 61.20 };
      currentUsdRate.textContent = `$${exchangeRates.usd}`;
      currentEurRate.textContent = `€${exchangeRates.eur}`;
    }
  } catch (error) {
    console.error("Error al cargar tasas de cambio:", error);
    // En caso de error, usar tasas por defecto
    exchangeRates = { usd: 56.50, eur: 61.20 };
    currentUsdRate.textContent = `$${exchangeRates.usd}`;
    currentEurRate.textContent = `€${exchangeRates.eur}`;
  }
};

// Formatear números con comas y puntos - VERSIÓN MEJORADA SIN DECIMALES FORZADOS
function formatNumberWithCommas(number) {
  // Si es string, remover comas existentes y convertir a número
  if (typeof number === 'string') {
    number = number.replace(/,/g, '');
  }
  
  // Convertir a número
  const num = parseFloat(number);
  
  // Verificar si es un número válido
  if (isNaN(num)) return '0';
  
  // Formatear con comas pero SIN decimales forzados
  // Solo mostrar decimales si el número los tiene naturalmente
  if (num % 1 === 0) {
    // Es un número entero
    return num.toLocaleString('en-US');
  } else {
    // Tiene decimales, mostrar hasta 2 decimales
    return num.toLocaleString('en-US', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 2
    });
  }
}

// Convertir número formateado a número normal - VERSIÓN MEJORADA
function parseFormattedNumber(formattedNumber) {
  // Remover comas y convertir a número
  const cleanNumber = formattedNumber.replace(/,/g, '');
  return parseFloat(cleanNumber) || 0;
}

// Función para actualizar los totales en diferentes monedas
const updateCurrencyTotals = () => {
  if (!exchangeRates) return;
  
  const usdAmount = (discountedTotal / exchangeRates.usd).toFixed(2);
  const eurAmount = (discountedTotal / exchangeRates.eur).toFixed(2);
  
  usdTotal.innerHTML = `<i class="fa-solid fa-dollar-sign"></i> USD $${formatNumberWithCommas(usdAmount)}`;
  eurTotal.innerHTML = `<i class="fa-solid fa-euro-sign"></i> EUR €${formatNumberWithCommas(eurAmount)}`;
};

// Función renderInvoice para incluir actualización de tasas Y IMPUESTOS POR PRODUCTO
const renderInvoice = () => {
  invoiceItems.innerHTML = "";
  totalPrice = 0;

  invoice.forEach((item) => {
    // Aplicar impuestos específicos del producto si están activados
    let priceWithTaxes = applyTaxesToProduct(item.pricePerUnit, item);
    
    const totalItemPrice = priceWithTaxes * item.quantity;

    const productDiv = document.createElement("div");
    productDiv.classList.add("invoice-item");
    productDiv.innerHTML = `
      <i class="fa-solid fa-box"></i> ${item.name} x ${item.quantity} - $${formatNumberWithCommas(totalItemPrice)}${getTaxInfoForProduct(item)}
      <button class="remove-btn" onclick="removeProduct('${item.productId}')">Eliminar</button>
    `;
    invoiceItems.appendChild(productDiv);
    totalPrice += totalItemPrice;
  });

  discountedTotal = discount > 0 ? totalPrice - (totalPrice * discount / 100) : totalPrice;
  
  invoiceTotal.innerHTML = `<i class="fa-solid fa-calculator"></i> Total: DOP $${formatNumberWithCommas(discountedTotal)}`;
  efectivoTotal.textContent = `DOP $${formatNumberWithCommas(discountedTotal)}`;
  tarjetaTotal.textContent = `DOP $${formatNumberWithCommas(discountedTotal)}`;
  
  // Usar la función actualizada para calcular totales en otras monedas
  updateCurrencyTotals();
  
  // Actualizar en Firestore para sincronización en tiempo real
  updateRealTimeInvoice();
};

const updateRealTimeInvoice = async () => {
  if (!currentCollaborator) return;
  
  try {
    const productos = invoice.map(item => {
      // Aplicar impuestos específicos del producto
      let priceWithTaxes = applyTaxesToProduct(item.pricePerUnit, item);
      
      return {
        id: item.productId,
        nombre: item.name,
        cantidad: item.quantity,
        precio: priceWithTaxes * item.quantity
      };
    });
    
    // Actualizar total
    const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
    await setDoc(totalRef, {
      total: discountedTotal > 0 ? discountedTotal : totalPrice
    }, { merge: true });
    
    // Actualizar productos
    const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
    await setDoc(productosRef, {
      productos: productos
    }, { merge: true });
  } catch (error) {
    console.error("Error al actualizar factura en tiempo real:", error);
  }
};

// Función para actualizar la UI de impuestos
function updateTaxesUI() {
  // Actualizar modal de impuestos
  itbisValue.textContent = taxConfig.itbis > 0 ? `${taxConfig.itbis}%` : 'Sin ITBIS asignado';
  ivaValue.textContent = taxConfig.iva > 0 ? `${taxConfig.iva}%` : 'Sin IVA asignado';
  
  if (taxConfig.activo) {
    itbisStatus.textContent = 'Sistema activo';
    itbisStatus.className = 'tax-status tax-active';
    ivaStatus.textContent = 'Sistema activo';
    ivaStatus.className = 'tax-status tax-active';
    taxBadge.textContent = '✓';
    taxBadge.className = 'tax-badge active';
  } else {
    itbisStatus.textContent = 'Sistema inactivo';
    itbisStatus.className = 'tax-status tax-inactive';
    ivaStatus.textContent = 'Sistema inactivo';
    ivaStatus.className = 'tax-status tax-inactive';
    taxBadge.textContent = '!';
    taxBadge.className = 'tax-badge';
  }
}

// CORRECCIÓN: Verificar si el logo existe y cargar fallback si no - VERSIÓN MEJORADA
function checkLogo() {
  const logoImage = new Image();
  logoImage.onload = function() {
    loginLogo.style.background = "url('logo.png') center/contain no-repeat";
    loginLogo.innerHTML = '';
    
    // También cargar en el header
    headerLogo.style.background = "url('logo.png') center/contain no-repeat";
    headerLogo.innerHTML = '';
  };
  logoImage.onerror = function() {
    loginLogo.classList.add('fallback');
    loginLogo.innerHTML = '<i class="fas fa-carrot"></i>';
    
    headerLogo.classList.add('fallback');
    headerLogo.innerHTML = '<i class="fas fa-carrot"></i>';
  };
  logoImage.src = 'logo.png';
}

// Llamar a la función al cargar la página
checkLogo();

// Función para mostrar loading global
function showGlobalLoading(message = "Cargando...") {
  globalLoading.style.display = 'flex';
  globalLoading.querySelector('p').textContent = message;
  
  // Verificar si el logo está cargado
  const logoImage = new Image();
  logoImage.onload = function() {
    globalCustomLoader.classList.remove('fallback');
  };
  logoImage.onerror = function() {
    globalCustomLoader.classList.add('fallback');
  };
  logoImage.src = 'logo.png';
}

// Función para ocultar loading global
function hideGlobalLoading() {
  globalLoading.style.display = 'none';
}

// Función para mostrar loading de login
function showLoginLoading() {
  loginLoading.style.display = 'flex';
  
  // Verificar si el logo está cargado
  const logoImage = new Image();
  logoImage.onload = function() {
    loginCustomLoader.classList.remove('fallback');
  };
  logoImage.onerror = function() {
    loginCustomLoader.classList.add('fallback');
  };
  logoImage.src = 'logo.png';
}

// Función para ocultar loading de login
function hideLoginLoading() {
  loginLoading.style.display = 'none';
}

// Función para mostrar loading local de productos
function showProductLoading() {
  productLoading.style.display = 'block';
}

// Función para ocultar loading local de productos
function hideProductLoading() {
  productLoading.style.display = 'none';
}

// Mostrar toast de copiado
function showCopyToast() {
  copyToast.style.display = 'block';
  setTimeout(() => {
    copyToast.style.display = 'none';
  }, 2000);
}

// Copiar código EAN al portapapeles
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showCopyToast();
  }).catch(err => {
    console.error('Error al copiar: ', err);
  });
}

// Verificar estado de conexión
window.addEventListener('online', () => {
  isOnline = true;
  actualizarPermisosUI();
  loadTaxConfig(); // Recargar impuestos cuando hay conexión
});

window.addEventListener('offline', () => {
  isOnline = false;
  actualizarPermisosUI();
});

// Función para mostrar alertas elegantes
function showAlert(type, message) {
  if (type === 'success') {
    successMessage.textContent = message;
    successAlert.style.display = 'flex';
  } else if (type === 'error') {
    errorMessage.textContent = message;
    errorAlert.style.display = 'flex';
  } else if (type === 'warning') {
    warningMessage.textContent = message;
    warningAlert.style.display = 'flex';
  }
}

// Función para cerrar todas las alertas
function closeAllAlerts() {
  successAlert.style.display = 'none';
  errorAlert.style.display = 'none';
  warningAlert.style.display = 'none';
}

// Event listeners para alertas
closeSuccessAlert.addEventListener('click', closeAllAlerts);
successOkBtn.addEventListener('click', closeAllAlerts);
closeErrorAlert.addEventListener('click', closeAllAlerts);
errorOkBtn.addEventListener('click', closeAllAlerts);
closeWarningAlert.addEventListener('click', closeAllAlerts);
warningOkBtn.addEventListener('click', closeAllAlerts);

// Autenticación de colaborador por nombre de usuario y PIN
async function authenticateCollaborator(username, pin) {
  try {
    showLoginLoading();
    
    // Buscar el colaborador en la colección Collaborators
    const collaboratorsQuery = query(
      collection(db, "Collaborators"),
      where("username", "==", username),
      where("pin", "==", pin)
    );
    
    const collaboratorsSnapshot = await getDocs(collaboratorsQuery);
    
    if (collaboratorsSnapshot.empty) {
      loginError.style.display = 'block';
      loginError.textContent = 'Nombre de usuario o PIN incorrectos';
      hideLoginLoading();
      return false;
    }
    
    // Colaborador encontrado
    const collaboratorDoc = collaboratorsSnapshot.docs[0];
    currentCollaborator = {
      id: collaboratorDoc.id,
      ...collaboratorDoc.data()
    };
    
    // CORRECCIÓN: Cargar foto de perfil del colaborador
    if (currentCollaborator.profileImage) {
      userAvatar.src = currentCollaborator.profileImage;
      userAvatar.style.display = 'block';
    }
    
    // Guardar información del colaborador en localStorage
    localStorage.setItem('collaboratorLoggedIn', 'true');
    localStorage.setItem('collaboratorData', JSON.stringify(currentCollaborator));
    
    hideLoginLoading();
    return true;
  } catch (error) {
    console.error("Error al autenticar colaborador:", error);
    loginError.style.display = 'block';
    loginError.textContent = 'Error al iniciar sesión';
    hideLoginLoading();
    return false;
  }
}

// CORRECCIÓN: Cargar productos del colaborador autenticado SIN MOSTRAR EL STOCK
async function loadCollaboratorProducts() {
  if (!currentCollaborator) return;
  
  try {
    showProductLoading();
    
    // Buscar productos que tengan el userId del colaborador
    const businessesRef = collection(db, "businesses");
    const businessesSnapshot = await getDocs(businessesRef);
    
    productsMap.clear();
    productList.innerHTML = "";
    
    if (businessesSnapshot.empty) {
      productList.innerHTML = "<p>No hay productos disponibles.</p>";
      hideProductLoading();
      return;
    }
    
    let productsCount = 0;
    
    for (const businessDoc of businessesSnapshot.docs) {
      const productsRef = collection(db, "businesses", businessDoc.id, "products");
      
      // Buscar productos que tengan el userId del colaborador
      const productsQuery = query(
        productsRef, 
        where("userId", "==", currentCollaborator.userId)
      );
      
      const querySnapshot = await getDocs(productsQuery);
      
      for (const doc of querySnapshot.docs) {
        const product = doc.data();
        const productKey = `${businessDoc.id}-${doc.id}`;
        
        if (!productsMap.has(productKey)) {
          productsMap.set(productKey, { product, businessDoc, doc });
          productsCount++;
        }
      }
    }
    
    // Renderizar productos únicos del mapa
    for (const [key, { product, businessDoc, doc }] of productsMap) {
      const productDiv = document.createElement("div");
      productDiv.classList.add("product-item");
      productDiv.setAttribute('data-product-id', doc.id);
      productDiv.setAttribute('data-business-name', businessDoc.id);
      
      // Imagen por defecto si no hay imagen
      const productImage = product.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image';
      
      // Verificar vencimiento del producto para mostrar etiqueta (CON ALERT DAYS PERSONALIZADOS)
      const expirationInfo = await checkProductExpiration(product, businessDoc.id, doc.id);
      let expirationBadge = '';
      let expirationMessage = '';
      
      if (expirationInfo.expired) {
        expirationBadge = '<div style="color: #e74c3c; font-weight: bold; background: rgba(231, 76, 60, 0.2); padding: 2px 8px; border-radius: 4px; margin-top: 5px;">VENCIDO</div>';
        expirationMessage = `Vencido hace ${Math.abs(expirationInfo.days)} días`;
      } else if (expirationInfo.message) {
        expirationBadge = '<div style="color: #f39c12; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 2px 8px; border-radius: 4px; margin-top: 5px;">PRÓXIMO A VENCER</div>';
        expirationMessage = `Vence en ${expirationInfo.days} días (Alerta: ${expirationInfo.alertDays} días)`;
      }
      
      // Mostrar información de impuestos del producto
      let taxInfo = '';
      if (taxConfig.activo) {
        if (product.applyItbis || product.applyIva) {
          taxInfo = '<div style="font-size: 0.6em; color: #16e086; margin-top: 2px;">';
          if (product.applyItbis) taxInfo += 'ITBIS ';
          if (product.applyItbis && product.applyIva) taxInfo += '+ ';
          if (product.applyIva) taxInfo += 'IVA';
          taxInfo += '</div>';
        }
      }
    
      // CORRECCIÓN: Eliminado el stock de la visualización
      if (currentView === 'grid') {
        productDiv.innerHTML = `
          <img src="${productImage}" alt="${product.name}" style="width: 80px; height: 80px; object-fit: contain;">
          <div class="product-name">${product.name}</div>
          <div class="product-price">$${formatNumberWithCommas(product.pricePerUnit)}</div>
          ${taxInfo}
          ${product.eanUpcCode ? `
            <div class="product-ean" title="Haz clic para copiar el código">
              <span class="copy-icon"><i class="fas fa-copy"></i></span>
              ${product.eanUpcCode}
            </div>
          ` : ''}
          ${expirationBadge}
          ${expirationMessage ? `<div style="font-size: 0.7em; color: #95a5a6; margin-top: 2px;">${expirationMessage}</div>` : ''}
        `;
      } else if (currentView === 'list') {
        productDiv.innerHTML = `
          <img src="${productImage}" alt="${product.name}" style="width: 40px; height: 40px; object-fit: contain;">
          <div class="product-details">
            <div class="product-name">${product.name}</div>
            <div class="product-price">$${formatNumberWithCommas(product.pricePerUnit)}</div>
            ${taxInfo}
            ${product.eanUpcCode ? `
              <div class="product-ean" title="Haz clic para copiar el código">
                <span class="copy-icon"><i class="fas fa-copy"></i></span>
                ${product.eanUpcCode}
              </div>
            ` : ''}
            ${expirationBadge}
            ${expirationMessage ? `<div style="font-size: 0.7em; color: #95a5a6; margin-top: 2px;">${expirationMessage}</div>` : ''}
          </div>
        `;
      }
      
      if (product.quantity === 0) {
        productDiv.style.backgroundColor = 'rgba(255, 99, 71, 0.2)';
        productDiv.innerHTML += '<div style="color: #ff7675; font-weight: bold;">AGOTADO</div>';
      }
      
      // Agregar evento para copiar código EAN
      const eanElement = productDiv.querySelector('.product-ean');
      if (eanElement) {
        eanElement.addEventListener('click', (e) => {
          e.stopPropagation(); // Evitar que se active el clic del producto
          copyToClipboard(product.eanUpcCode);
        });
      }
      
      productDiv.addEventListener("click", async () => {
        if (product.quantity === 0) {
          showAlert('warning', 'Este producto está agotado');
          return;
        }
        
        // Verificar vencimiento del producto CON ALERT DAYS PERSONALIZADOS
        const expirationInfo = await checkProductExpiration(product, businessDoc.id, doc.id);
        
        if (expirationInfo.expired) {
          // Producto vencido - mostrar alerta
          await showExpirationAlert(product, businessDoc.id, doc.id, expirationInfo);
          return;
        } else if (expirationInfo.message) {
          // Producto próximo a vencer - preguntar si desea vender
          const allowSale = await showExpirationAlert(product, businessDoc.id, doc.id, expirationInfo);
          if (!allowSale) return;
        }
        
        // Si no hay problemas de vencimiento o el usuario aceptó vender
        updateInvoice(product, businessDoc.id, doc.id);
      });
      productList.appendChild(productDiv);
    }

    hideProductLoading();

    if (productsCount === 0) {
      productList.innerHTML = "<p>No hay productos registrados por este colaborador.</p>";
    }
  } catch (error) {
    console.error("Error al cargar productos del colaborador:", error);
    hideProductLoading();
    showAlert('error', 'Error al cargar los productos');
  }
}

// En lugar de loadTaxes, ahora usamos loadTaxConfig
async function loadBusinessDetails() {
  try {
    if (!currentCollaborator) return;
    
    // Buscar detalles de la empresa del usuario del colaborador
    const businessRef = doc(db, "businessDetails", currentCollaborator.userId);
    const businessDoc = await getDoc(businessRef);
    
    if (businessDoc.exists()) {
      businessDetails = businessDoc.data();
    } else {
      // Si no existe, crear configuración por defecto
      businessDetails = {
        name: "Mi Empresa SRL",
        rnc: "123456789",
        address: "Dirección de la empresa",
        phone: "809-123-4567",
        email: "info@empresa.com",
        regimen: "Regimen General",
        comprobante: "Factura de Crédito Fiscal",
        ncf: "B0100000001",
        ncfVencimiento: "",
        logoUrl: "",
        qrUrl: ""
      };
      await setDoc(businessRef, businessDetails);
    }
  } catch (error) {
    console.error("Error al cargar detalles de la empresa:", error);
    businessDetails = {
      name: "Mi Empresa SRL",
      rnc: "123456789",
      address: "Dirección de la empresa",
      phone: "809-123-4567",
      email: "info@empresa.com",
        regimen: "Regimen General",
        comprobante: "Factura de Crédito Fiscal",
        ncf: "B0100000001",
        ncfVencimiento: "",
        logoUrl: "",
        qrUrl: ""
      };
  }
}

// Cargar configuración de descuentos del usuario
async function loadDiscountSettings() {
  try {
    if (!currentCollaborator) return;
    
    // Buscar configuración de descuentos del usuario del colaborador
    const discountRef = doc(db, "discountSettings", currentCollaborator.userId);
    const discountDoc = await getDoc(discountRef);
    
    if (discountDoc.exists()) {
      discountSettings = discountDoc.data();
    } else {
      // Si no existe, crear configuración por defecto
      discountSettings = {
        percentage: 10,
        password: "123456",
        activo: false,
        userId: currentCollaborator.userId
      };
      await setDoc(discountRef, discountSettings);
    }
  } catch (error) {
    console.error("Error al cargar configuración de descuentos:", error);
    discountSettings = {
      percentage: 10,
      password: "123456",
      activo: false,
      userId: currentCollaborator.userId
    };
  }
}

// Cerrar sesión del colaborador
function logoutCollaborator() {
  currentCollaborator = null;
  localStorage.removeItem('collaboratorLoggedIn');
  localStorage.removeItem('collaboratorData');
  loginSection.style.display = 'flex';
  posSection.style.display = 'none';
  invoiceUser.textContent = '';
  userName.textContent = '';
  userEmail.textContent = '';
  
  // Limpiar todos los listeners
  cleanupAllListeners();
  
  // Detener el escáner si está activo
  stopScanner();
  
  // Limpiar timeout de "producto no existe"
  if (productNotFoundTimeout) {
    clearTimeout(productNotFoundTimeout);
    productNotFoundTimeout = null;
  }
}

// Observador de autenticación MODIFICADO para colaboradores
document.addEventListener('DOMContentLoaded', () => {
  // Verificar si hay sesión de colaborador guardada
  if (localStorage.getItem('collaboratorLoggedIn') === 'true') {
    const collaboratorData = localStorage.getItem('collaboratorData');
    if (collaboratorData) {
      currentCollaborator = JSON.parse(collaboratorData);
      loginSection.style.display = 'none';
      posSection.style.display = 'block';
      
      // Mostrar información del colaborador
      invoiceUser.textContent = `${currentCollaborator.firstName} ${currentCollaborator.lastName}`;
      userName.textContent = `Nombre: ${currentCollaborator.firstName} ${currentCollaborator.lastName}`;
      userEmail.textContent = `Usuario: ${currentCollaborator.username}`;
      
      // CORRECCIÓN: Cargar foto de perfil del colaborador
      if (currentCollaborator.profileImage) {
        userAvatar.src = currentCollaborator.profileImage;
        userAvatar.style.display = 'block';
      }
      
      // Cargar productos del colaborador
      showProductLoading();
      loadCollaboratorProducts();
      hideProductLoading();

      // Cargar tasas de cambio
      loadExchangeRates();
      // Cargar preferencia de vista de productos
      loadProductViewPreference();
      // Cargar configuración de impuestos del usuario
      loadTaxConfig();
      // Cargar detalles de la empresa del usuario
      loadBusinessDetails();
      // Cargar configuración de descuentos del usuario
      loadDiscountSettings();
      
      // VERIFICAR TURNO DEL COLABORADOR AL INICIAR SESIÓN
      checkCollaboratorShift();
      
      // Iniciar listeners para actualización en tiempo real
      setupRealTimeListeners();
      
      // Inicializar el escáner
      initializeScanner();
      
      // Enfocar automáticamente el buscador EAN/UPC
      setTimeout(() => {
        searchInput.focus();
      }, 500);
    }
  } else {
    loginSection.style.display = 'flex';
    posSection.style.display = 'none';
  }
});

// Limpiar todos los listeners
function cleanupAllListeners() {
  // Limpiar listener de productos
  if (productUnsubscribe) {
    productUnsubscribe();
    productUnsubscribe = null;
  }
  
  // Limpiar temporizadores de turnos
  if (shiftTimer) clearInterval(shiftTimer);
  if (shiftAlertTimer) clearTimeout(shiftAlertTimer);
  if (shiftEndTimer) clearTimeout(shiftEndTimer);
  
  // Limpiar listener de turnos en tiempo real
  if (shiftListener) {
    shiftListener();
    shiftListener = null;
  }
  
  // Limpiar todos los listeners en tiempo real
  realTimeListeners.forEach(unsubscribe => {
    if (unsubscribe) unsubscribe();
  });
  realTimeListeners = [];
  
  // Limpiar timeout de "producto no existe"
  if (productNotFoundTimeout) {
    clearTimeout(productNotFoundTimeout);
    productNotFoundTimeout = null;
  }
}

// Función para actualizar la UI según los permisos del usuario
function actualizarPermisosUI() {
  // Verificar permisos para los iconos del header
  const headerIcons = [
    { id: inventoryBtn, permission: 'inventario' },
    { id: reportsBtn, permission: 'reportes' },
    { id: invoicesBtn, permission: 'facturas' },
    { id: salesAnalysisBtn, permission: 'analisis' }
  ];

  headerIcons.forEach(icon => {
    // Limpiar cualquier candado existente primero
    const existingLock = icon.id.querySelector('.fa-lock');
    if (existingLock) {
      existingLock.remove();
    }

    // Verificar si hay conexión a internet
    if (!isOnline) {
      // Sin conexión: mostrar todos los botones bloqueados
      icon.id.style.opacity = '0.5';
      icon.id.style.pointerEvents = 'none';
      icon.id.title = 'Sin conexión - No se pueden verificar permisos';
      
      // Agregar icono de candado
      const lockIcon = document.createElement('i');
      lockIcon.className = 'fas fa-lock';
      lockIcon.style.marginLeft = '5px';
      lockIcon.style.color = '#e74c3c';
      icon.id.appendChild(lockIcon);
      return;
    }

    if (!userPermissions.includes(icon.permission)) {
      // Si no tiene permiso, deshabilitar el botón
      icon.id.style.opacity = '0.5';
      icon.id.style.pointerEvents = 'none';
      icon.id.title = 'No tiene permiso para acceder a esta función';
      
      // Agregar icono de candado
      const lockIcon = document.createElement('i');
      lockIcon.className = 'fas fa-lock';
      lockIcon.style.marginLeft = '5px';
      lockIcon.style.color = '#e74c3c';
      icon.id.appendChild(lockIcon);
    } else {
      // Si tiene permiso, asegurarse de que esté habilitado
      icon.id.style.opacity = '1';
      icon.id.style.pointerEvents = 'auto';
      icon.id.title = icon.id.getAttribute('data-original-title') || '';
    }
  });
}

// Configurar listeners para productos en tiempo real - MEJORADO
function setupRealTimeProductListeners() {
  if (!currentCollaborator) return;
  
  // Limpiar listener anterior si existe
  if (productUnsubscribe) {
    productUnsubscribe();
  }
  
  // MEJORADO: Listener para productos en tiempo real que actualiza automáticamente
  const businessesRef = collection(db, "businesses");
  productUnsubscribe = onSnapshot(businessesRef, (snapshot) => {
    // Si no hay búsqueda activa, renderizar todos los productos del colaborador
    if (!searchInput.value && !searchByNameInput.value) {
      loadCollaboratorProducts();
    } else {
      // Si hay búsqueda, mantener los productos actuales pero actualizar sus datos en tiempo real
      updateExistingProductsInRealTime();
    }
  }, (error) => {
    console.error("Error en listener de productos:", error);
  });
  
  // Agregar a la lista de listeners
  realTimeListeners.push(productUnsubscribe);
}

// Actualizar productos existentes en tiempo real
function updateExistingProductsInRealTime() {
  const productItems = document.querySelectorAll('.product-item');
  productItems.forEach(item => {
    const productId = item.getAttribute('data-product-id');
    const businessName = item.getAttribute('data-business-name');
    
    if (productId && businessName) {
      const productRef = doc(db, "businesses", businessName, "products", productId);
      const unsubscribe = onSnapshot(productRef, (productDoc) => {
        if (productDoc.exists()) {
          const productData = productDoc.data();
          // Actualizar la información del producto en la UI en tiempo real
          updateProductUI(item, productData);
        }
      });
      
      // Agregar a la lista de listeners
      realTimeListeners.push(unsubscribe);
    }
  });
}

// Función para actualizar la UI de un producto - CORREGIDA: SIN STOCK
function updateProductUI(productElement, productData) {
  const priceElement = productElement.querySelector('.product-price');
  const nameElement = productElement.querySelector('.product-name');
  const eanElement = productElement.querySelector('.product-ean');
  
  if (priceElement) {
    priceElement.textContent = `$${formatNumberWithCommas(productData.pricePerUnit)}`;
  }
  
  if (nameElement) {
    nameElement.textContent = productData.name;
  }
  
  // Actualizar código EAN
  if (eanElement) {
    if (productData.eanUpcCode) {
      eanElement.innerHTML = `<span class="copy-icon"><i class="fas fa-copy"></i></span> ${productData.eanUpcCode}`;
      eanElement.style.display = 'flex';
    } else {
      eanElement.style.display = 'none';
    }
  }
  
  // Actualizar estado de agotado
  if (productData.quantity === 0) {
    productElement.style.backgroundColor = 'rgba(255, 99, 71, 0.2)';
    if (!productElement.querySelector('.agotado-badge')) {
      const agotadoBadge = document.createElement('div');
      agotadoBadge.className = 'agotado-badge';
      agotadoBadge.style.cssText = 'color: #ff7675; font-weight: bold; margin-top: 5px;';
      agotadoBadge.textContent = 'AGOTADO';
      productElement.appendChild(agotadoBadge);
    }
  } else {
    productElement.style.backgroundColor = '';
    const agotadoBadge = productElement.querySelector('.agotado-badge');
    if (agotadoBadge) {
      agotadoBadge.remove();
    }
  }
  
  // Actualizar información de vencimiento CON ALERT DAYS PERSONALIZADOS
  updateProductExpirationUI(productElement, productData);
  
  // Actualizar información de impuestos del producto
  updateProductTaxInfoUI(productElement, productData);
}

// Actualizar UI de información de impuestos del producto
function updateProductTaxInfoUI(productElement, productData) {
  // Eliminar información de impuestos existente
  const existingTaxInfo = productElement.querySelector('[data-tax-info]');
  if (existingTaxInfo) {
    existingTaxInfo.remove();
  }
  
  // Agregar nueva información de impuestos si está activado
  if (taxConfig.activo && (productData.applyItbis || productData.applyIva)) {
    const taxInfo = document.createElement('div');
    taxInfo.setAttribute('data-tax-info', 'true');
    taxInfo.style.cssText = 'font-size: 0.6em; color: #16e086; margin-top: 2px;';
    
    let taxText = '';
    if (productData.applyItbis) taxText += 'ITBIS ';
    if (productData.applyItbis && productData.applyIva) taxText += '+ ';
    if (productData.applyIva) taxText += 'IVA';
    
    taxInfo.textContent = taxText;
    
    // Insertar después del precio
    const priceElement = productElement.querySelector('.product-price');
    if (priceElement) {
      priceElement.parentNode.insertBefore(taxInfo, priceElement.nextSibling);
    }
  }
}

// Actualizar UI de vencimiento del producto CON ALERT DAYS PERSONALIZADOS
function updateProductExpirationUI(productElement, productData) {
  // Eliminar badges de vencimiento existentes
  const existingBadges = productElement.querySelectorAll('[data-expiration-badge]');
  existingBadges.forEach(badge => badge.remove());
  
  // Eliminar mensajes de vencimiento existentes
  const existingMessages = productElement.querySelectorAll('[data-expiration-message]');
  existingMessages.forEach(message => message.remove());
  
  // Verificar si hay fecha de vencimiento
  if (productData.expirationDate) {
    const expirationDate = new Date(productData.expirationDate);
    const today = new Date();
    const timeDiff = expirationDate.getTime() - today.getTime();
    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
    
    // Obtener alertDays personalizados del producto
    const alertDays = productData.alertDays || 30; // Valor por defecto
    
    let expirationBadge = null;
    let expirationMessage = null;
    
    if (daysDiff < 0) {
      // Producto vencido
      expirationBadge = document.createElement('div');
      expirationBadge.setAttribute('data-expiration-badge', 'true');
      expirationBadge.style.cssText = 'color: #e74c3c; font-weight: bold; background: rgba(231, 76, 60, 0.2); padding: 2px 8px; border-radius: 4px; margin-top: 5px;';
      expirationBadge.textContent = 'VENCIDO';
      
      expirationMessage = document.createElement('div');
      expirationMessage.setAttribute('data-expiration-message', 'true');
      expirationMessage.style.cssText = 'font-size: 0.7em; color: #95a5a6; margin-top: 2px;';
      expirationMessage.textContent = `Vencido hace ${Math.abs(daysDiff)} días`;
    } else if (daysDiff <= alertDays) {
      // Producto próximo a vencer (según alertDays personalizados)
      expirationBadge = document.createElement('div');
      expirationBadge.setAttribute('data-expiration-badge', 'true');
      expirationBadge.style.cssText = 'color: #f39c12; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 2px 8px; border-radius: 4px; margin-top: 5px;';
      expirationBadge.textContent = 'PRÓXIMO A VENCER';
      
      expirationMessage = document.createElement('div');
      expirationMessage.setAttribute('data-expiration-message', 'true');
      expirationMessage.style.cssText = 'font-size: 0.7em; color: #95a5a6; margin-top: 2px;';
      expirationMessage.textContent = `Vence en ${daysDiff} días (Alerta: ${alertDays} días)`;
    }
    
    if (expirationBadge) {
      productElement.appendChild(expirationBadge);
    }
    
    if (expirationMessage) {
      productElement.appendChild(expirationMessage);
    }
  }
}

// Configurar listeners para actualización en tiempo real - MEJORADO
function setupRealTimeListeners() {
  if (!currentCollaborator) return;
  
  // Listener para el total actual
  const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
  const totalUnsubscribe = onSnapshot(totalRef, (doc) => {
    if (doc.exists()) {
      const data = doc.data();
      invoiceTotal.innerHTML = `<i class="fa-solid fa-calculator"></i> Total: DOP $${formatNumberWithCommas(data.total)}`;
      efectivoTotal.textContent = `DOP $${formatNumberWithCommas(data.total)}`;
      tarjetaTotal.textContent = `DOP $${formatNumberWithCommas(data.total)}`;
      
      // Usar la función actualizada para calcular totales en otras monedas
      updateCurrencyTotals();
    }
  });
  realTimeListeners.push(totalUnsubscribe);
  
  // Listener para los productos en la factura actual
  const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
  const productosUnsubscribe = onSnapshot(productosRef, (doc) => {
    if (doc.exists()) {
      const data = doc.data();
      invoiceItems.innerHTML = "";
      
      if (data.productos && data.productos.length > 0) {
        data.productos.forEach((producto) => {
          const productDiv = document.createElement("div");
          productDiv.classList.add("invoice-item");
          productDiv.innerHTML = `
            <i class="fa-solid fa-box"></i> ${producto.nombre} x ${producto.cantidad} - $${formatNumberWithCommas(producto.precio)}
            <button class="remove-btn" onclick="removeProduct('${producto.id}')">Eliminar</button>
          `;
          invoiceItems.appendChild(productDiv);
        });
      }
    }
  });
  realTimeListeners.push(productosUnsubscribe);
  
  // Listener para impuestos en tiempo real - AHORA USANDO TAXCONFIG
  const taxesRef = doc(db, "impuesto", currentCollaborator.userId);
  const taxesUnsubscribe = onSnapshot(taxesRef, (doc) => {
    if (doc.exists()) {
      const taxesData = doc.data();
      taxConfig = {
        itbis: taxesData.itbis || 18,
        iva: taxesData.iva || 0,
        activo: taxesData.activo || false
      };
      
      updateTaxesUI();
      renderInvoice(); // Recalcular la factura con los nuevos impuestos
      // Actualizar UI de productos para mostrar/ocultar información de impuestos
      updateProductsTaxInfo();
    }
  });
  realTimeListeners.push(taxesUnsubscribe);

  // Listener para descuentos en tiempo real
  const discountRef = doc(db, "discountSettings", currentCollaborator.userId);
  const discountUnsubscribe = onSnapshot(discountRef, (doc) => {
    if (doc.exists()) {
      discountSettings = doc.data();
    }
  });
  realTimeListeners.push(discountUnsubscribe);

  // Listener para tasas de cambio en tiempo real del usuario específico
  const ratesRef = doc(db, "exchangeRates", currentCollaborator.userId);
  const ratesUnsubscribe = onSnapshot(ratesRef, (doc) => {
    if (doc.exists()) {
      const ratesData = doc.data();
      exchangeRates = {
        usd: ratesData.usd || 56.50,
        eur: ratesData.eur || 61.20
      };
      currentUsdRate.textContent = `$${exchangeRates.usd}`;
      currentEurRate.textContent = `€${exchangeRates.eur}`;
      
      // Actualizar los totales en otras monedas cuando cambien las tasas
      updateCurrencyTotals();
    }
  });
  realTimeListeners.push(ratesUnsubscribe);
}

// Actualizar información de impuestos en todos los productos
function updateProductsTaxInfo() {
  const productItems = document.querySelectorAll('.product-item');
  productItems.forEach(item => {
    const productId = item.getAttribute('data-product-id');
    const businessName = item.getAttribute('data-business-name');
    
    if (productId && businessName) {
      const productRef = doc(db, "businesses", businessName, "products", productId);
      getDoc(productRef).then(productDoc => {
        if (productDoc.exists()) {
          const productData = productDoc.data();
          updateProductTaxInfoUI(item, productData);
        }
      });
    }
  });
}

// Login para colaboradores
loginButton.addEventListener('click', async () => {
  try {
    const username = loginUsername.value.trim();
    const pin = loginPin.value.trim();
    
    if (!username || !pin) {
      loginError.style.display = 'block';
      loginError.textContent = 'Por favor complete todos los campos';
      return;
    }
    
    const isAuthenticated = await authenticateCollaborator(username, pin);
    
    if (isAuthenticated) {
      loginError.style.display = 'none';
      loginSection.style.display = 'none';
      posSection.style.display = 'block';
      
      // Mostrar información del colaborador
      invoiceUser.textContent = `${currentCollaborator.firstName} ${currentCollaborator.lastName}`;
      userName.textContent = `Nombre: ${currentCollaborator.firstName} ${currentCollaborator.lastName}`;
      userEmail.textContent = `Usuario: ${currentCollaborator.username}`;
      
      // CORRECCIÓN: Cargar foto de perfil del colaborador
      if (currentCollaborator.profileImage) {
        userAvatar.src = currentCollaborator.profileImage;
        userAvatar.style.display = 'block';
      }
      
      // Cargar productos del colaborador
      showProductLoading();
      loadCollaboratorProducts();
      hideProductLoading();

      // Cargar tasas de cambio
      loadExchangeRates();
      // Cargar preferencia de vista de productos
      loadProductViewPreference();
      // Cargar configuración de impuestos del usuario
      loadTaxConfig();
      // Cargar detalles de la empresa del usuario
      loadBusinessDetails();
      // Cargar configuración de descuentos del usuario
      loadDiscountSettings();
      
      // VERIFICAR TURNO DEL COLABORADOR AL INICIAR SESIÓN
      await checkCollaboratorShift();
      
      // Iniciar listeners para actualización en tiempo real
      setupRealTimeListeners();
      
      // Inicializar el escáner
      initializeScanner();
      
      // Enfocar automáticamente el buscador EAN/UPC
      setTimeout(() => {
        searchInput.focus();
      }, 500);
    }
  } catch (error) {
    console.error('Error al iniciar sesión:', error);
    loginError.style.display = 'block';
    loginError.textContent = 'Error al iniciar sesión';
  }
});

// Logout para colaboradores
logoutBtn.addEventListener('click', () => {
  // Crear modal de confirmación
  const confirmModal = document.createElement('div');
  confirmModal.style.position = 'fixed';
  confirmModal.style.top = '0';
  confirmModal.style.left = '0';
  confirmModal.style.width = '100%';
  confirmModal.style.height = '100%';
  confirmModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
  confirmModal.style.display = 'flex';
  confirmModal.style.justifyContent = 'center';
  confirmModal.style.alignItems = 'center';
  confirmModal.style.zIndex = '2000';
  
  // Contenido del modal
  const modalContent = document.createElement('div');
  modalContent.style.backgroundColor = '#2c3e50';
  modalContent.style.padding = '20px';
  modalContent.style.borderRadius = '10px';
  modalContent.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
  modalContent.style.maxWidth = '400px';
  modalContent.style.width = '90%';
  modalContent.style.textAlign = 'center';
  
  // Título
  const title = document.createElement('h2');
  title.textContent = 'Confirmar Cierre de Sesión';
  title.style.color = '#e74c3c';
  title.style.marginBottom = '20px';
  
  // Mensaje
  const message = document.createElement('p');
  message.textContent = '¿Estás seguro que deseas cerrar sesión?';
  message.style.marginBottom = '20px';
  message.style.fontSize = '16px';
  
  // Botones
  const buttonContainer = document.createElement('div');
  buttonContainer.style.display = flex;
  buttonContainer.style.justifyContent = 'center';
  buttonContainer.style.gap = '10px';
  
  const cancelButton = document.createElement('button');
  cancelButton.textContent = 'Cancelar';
  cancelButton.style.padding = '10px 20px';
  cancelButton.style.border = 'none';
  cancelButton.style.borderRadius = '5px';
  cancelButton.style.backgroundColor = '#15a086';
  cancelButton.style.color = 'white';
  cancelButton.style.cursor = 'pointer';
  cancelButton.style.transition = 'background-color 0.3s';
  
  cancelButton.addEventListener('mouseover', () => {
    cancelButton.style.backgroundColor = '#15a086';
  });
  
  cancelButton.addEventListener('mouseout', () => {
    cancelButton.style.backgroundColor = '#16e086';
  });
  
  const confirmButton = document.createElement('button');
  confirmButton.textContent = 'Cerrar Sesión';
  confirmButton.style.padding = '10px 20px';
  confirmButton.style.border = 'none';
  confirmButton.style.borderRadius = '5px';
  confirmButton.style.backgroundColor = '#e74c3c';
  confirmButton.style.color = 'white';
  confirmButton.style.cursor = 'pointer';
  confirmButton.style.transition = 'background-color 0.3s';
  
  confirmButton.addEventListener('mouseover', () => {
    confirmButton.style.backgroundColor = '#c0392b';
  });
  
  confirmButton.addEventListener('mouseout', () => {
    confirmButton.style.backgroundColor = '#e74c3c';
  });
  
  // Eventos de los botones
  cancelButton.addEventListener('click', () => {
    document.body.removeChild(confirmModal);
  });
  
  confirmButton.addEventListener('click', () => {
    try {
      showGlobalLoading("Cerrando sesión...");
      logoutCollaborator();
      userInfoModal.style.display = 'none';
      document.body.removeChild(confirmModal);
      hideGlobalLoading();
      showAlert('success', 'Sesión cerrada correctamente');
    } catch (error) {
      console.error('Error al cerrar sesión:', error);
      hideGlobalLoading();
      showAlert('error', 'Error al cerrar sesión');
    }
  });
  
  // Agregar elementos al modal
  buttonContainer.appendChild(cancelButton);
  buttonContainer.appendChild(confirmButton);
  
  modalContent.appendChild(title);
  modalContent.appendChild(message);
  modalContent.appendChild(buttonContainer);
  
  confirmModal.appendChild(modalContent);
  document.body.appendChild(confirmModal);
});

// Funciones de negocio - MODIFICADAS para usar userId del colaborador
const getBusinessDetails = async () => {
  try {
    // Si ya tenemos los detalles cargados, devolverlos
    if (businessDetails) {
      return businessDetails;
    }
    
    showGlobalLoading("Obteniendo detalles del negocio...");
    
    // MODIFICADO: Buscar detalles del negocio del usuario del colaborador
    const businessRef = doc(db, "businessDetails", currentCollaborator.userId);
    const businessDoc = await getDoc(businessRef);
    
    if (businessDoc.exists()) {
      const data = businessDoc.data();
      businessDetails = data;
      hideGlobalLoading();
      return businessDetails;
    } else {
      const defaultData = {
        name: "Mi Empresa SRL",
        rnc: "123456789",
        address: "Dirección de la empresa",
        phone: "809-123-4567",
        email: "info@empresa.com",
        regimen: "Regimen General",
        comprobante: "Factura de Crédito Fiscal",
        ncf: "B0100000001",
        ncfVencimiento: "",
        logoUrl: "",
        qrUrl: ""
      };
      await setDoc(businessRef, defaultData);
      businessDetails = defaultData;
      hideGlobalLoading();
      return businessDetails;
    }
  } catch (error) {
    console.error("Error al obtener detalles del negocio:", error);
    hideGlobalLoading();
    return {
        name: "Mi Empresa SRL",
        rnc: "123456789",
        address: "Dirección de la empresa",
        phone: "809-123-4567",
        email: "info@empresa.com",
        regimen: "Regimen General",
        comprobante: "Factura de Crédito Fiscal",
        ncf: "B0100000001",
        ncfVencimiento: "",
        logoUrl: "",
        qrUrl: ""
      };
  }
};

// Cargar preferencia de vista de productos
const loadProductViewPreference = async () => {
  if (!currentCollaborator) return;
  
  try {
    const prefRef = doc(db, "userPreferences", currentCollaborator.userId);
    const prefDoc = await getDoc(prefRef);
    
    if (prefDoc.exists() && prefDoc.data().productView) {
      currentView = prefDoc.data().productView;
      setProductView(currentView);
    }
  } catch (error) {
    console.error("Error al cargar preferencia de vista:", error);
  }
};

// Guardar preferencia de vista de productos
const saveProductViewPreference = async (view) => {
  if (!currentCollaborator) return;
  
  try {
    const prefRef = doc(db, "userPreferences", currentCollaborator.userId);
    await setDoc(prefRef, {
      productView: view
    }, { merge: true });
  } catch (error) {
    console.error("Error al guardar preferencia de vista:", error);
  }
};

// Establecer vista de productos
const setProductView = (view) => {
  currentView = view;
  productList.className = `products-list ${view}-view`;
  
  // Actualizar botones activos
  viewGrid.classList.remove('active');
  viewList.classList.remove('active');
  
  if (view === 'grid') viewGrid.classList.add('active');
  if (view === 'list') viewList.classList.add('active');
  
  // Guardar preferencia
  saveProductViewPreference(view);
};

// Event listeners para botones de vista
viewGrid.addEventListener('click', () => setProductView('grid'));
viewList.addEventListener('click', () => setProductView('list'));

// Funciones de productos - CORREGIDO PARA EVITAR DUPLICADOS Y SIN STOCK
const renderProducts = async (eanTerm = "", nameTerm = "") => {
  if (!currentCollaborator || isRendering) return;
  
  isRendering = true;

  try {
    showProductLoading(); // Usar loading local
    const businessesRef = collection(db, "businesses");
    const businessesSnapshot = await getDocs(businessesRef);

    // Limpiar el mapa de productos para evitar duplicados
    productsMap.clear();
    productList.innerHTML = "";

    if (businessesSnapshot.empty) {
      productList.innerHTML = "<p>No hay productos disponibles.</p>";
      hideProductLoading();
      isRendering = false;
      return;
    }

    let productsCount = 0;
    
    for (const businessDoc of businessesSnapshot.docs) {
      const productsRef = collection(db, "businesses", businessDoc.id, "products");
      let productsQuery = query(productsRef, where("userId", "==", currentCollaborator.userId));

      if (eanTerm) {
        // MODIFICADO: Búsqueda por EAN/UPC solo números
        productsQuery = query(
          productsRef, 
          where("userId", "==", currentCollaborator.userId),
          where("eanUpcCode", "==", eanTerm)
        );
      } else if (nameTerm) {
        // Búsqueda por coincidencia sin importar mayúsculas/minúsculas
        const productsSnapshot = await getDocs(productsRef);
        for (const doc of productsSnapshot.docs) {
          const product = doc.data();
          // Buscar por coincidencia sin importar mayúsculas/minúsculas
          if (product.name && product.name.toLowerCase().includes(nameTerm.toLowerCase()) && 
              product.userId === currentCollaborator.userId) {
            const productKey = `${businessDoc.id}-${doc.id}`; // Clave única por negocio y producto
            
            // Evitar duplicados usando el mapa
            if (!productsMap.has(productKey)) {
              productsMap.set(productKey, { product, businessDoc, doc });
              productsCount++;
            }
          }
        }
        continue; // Continuar con el siguiente negocio
      }

      const querySnapshot = await getDocs(productsQuery);
      
      for (const doc of querySnapshot.docs) {
        const product = doc.data();
        const productKey = `${businessDoc.id}-${doc.id}`; // Clave única por negocio y producto
        
        // Evitar duplicados usando el mapa
        if (!productsMap.has(productKey)) {
          productsMap.set(productKey, { product, businessDoc, doc });
          productsCount++;
        }
      }
    }

    // Renderizar productos únicos del mapa - CORREGIDO: SIN STOCK
    for (const [key, { product, businessDoc, doc }] of productsMap) {
      const productDiv = document.createElement("div");
      productDiv.classList.add("product-item");
      productDiv.setAttribute('data-product-id', doc.id);
      productDiv.setAttribute('data-business-name', businessDoc.id);
      
      // Imagen por defecto si no hay imagen
      const productImage = product.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image';
      
      // Verificar vencimiento del producto para mostrar etiqueta (CON ALERT DAYS PERSONALIZADOS)
      const expirationInfo = await checkProductExpiration(product, businessDoc.id, doc.id);
      let expirationBadge = '';
      let expirationMessage = '';
      
      if (expirationInfo.expired) {
        expirationBadge = '<div style="color: #e74c3c; font-weight: bold; background: rgba(231, 76, 60, 0.2); padding: 2px 8px; border-radius: 4px; margin-top: 5px;">VENCIDO</div>';
        expirationMessage = `Vencido hace ${Math.abs(expirationInfo.days)} días`;
      } else if (expirationInfo.message) {
        expirationBadge = '<div style="color: #f39c12; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 2px 8px; border-radius: 4px; margin-top: 5px;">PRÓXIMO A VENCER</div>';
        expirationMessage = `Vence en ${expirationInfo.days} días (Alerta: ${expirationInfo.alertDays} días)`;
      }
      
      // Mostrar información de impuestos del producto
      let taxInfo = '';
      if (taxConfig.activo) {
        if (product.applyItbis || product.applyIva) {
          taxInfo = '<div style="font-size: 0.6em; color: #16e086; margin-top: 2px;">';
          if (product.applyItbis) taxInfo += 'ITBIS ';
          if (product.applyItbis && product.applyIva) taxInfo += '+ ';
          if (product.applyIva) taxInfo += 'IVA';
          taxInfo += '</div>';
        }
      }
    
      // CORRECCIÓN: Eliminado el stock de la visualización
      if (currentView === 'grid') {
        productDiv.innerHTML = `
          <img src="${productImage}" alt="${product.name}" style="width: 80px; height: 80px; object-fit: contain;">
          <div class="product-name">${product.name}</div>
          <div class="product-price">$${formatNumberWithCommas(product.pricePerUnit)}</div>
          ${taxInfo}
          ${product.eanUpcCode ? `
            <div class="product-ean" title="Haz clic para copiar el código">
              <span class="copy-icon"><i class="fas fa-copy"></i></span>
              ${product.eanUpcCode}
            </div>
          ` : ''}
          ${expirationBadge}
          ${expirationMessage ? `<div style="font-size: 0.7em; color: #95a5a6; margin-top: 2px;">${expirationMessage}</div>` : ''}
        `;
      } else if (currentView === 'list') {
        productDiv.innerHTML = `
          <img src="${productImage}" alt="${product.name}" style="width: 40px; height: 40px; object-fit: contain;">
          <div class="product-details">
            <div class="product-name">${product.name}</div>
            <div class="product-price">$${formatNumberWithCommas(product.pricePerUnit)}</div>
            ${taxInfo}
            ${product.eanUpcCode ? `
              <div class="product-ean" title="Haz clic para copiar el código">
                <span class="copy-icon"><i class="fas fa-copy"></i></span>
                ${product.eanUpcCode}
              </div>
            ` : ''}
            ${expirationBadge}
            ${expirationMessage ? `<div style="font-size: 0.7em; color: #95a5a6; margin-top: 2px;">${expirationMessage}</div>` : ''}
          </div>
        `;
      }
      
      if (product.quantity === 0) {
        productDiv.style.backgroundColor = 'rgba(255, 99, 71, 0.2)';
        productDiv.innerHTML += '<div style="color: #ff7675; font-weight: bold;">AGOTADO</div>';
      }
      
      // Agregar evento para copiar código EAN
      const eanElement = productDiv.querySelector('.product-ean');
      if (eanElement) {
        eanElement.addEventListener('click', (e) => {
          e.stopPropagation(); // Evitar que se active el clic del producto
          copyToClipboard(product.eanUpcCode);
        });
      }
      
      productDiv.addEventListener("click", async () => {
        if (product.quantity === 0) {
          showAlert('warning', 'Este producto está agotado');
          return;
        }
        
        // Verificar vencimiento del producto CON ALERT DAYS PERSONALIZADOS
        const expirationInfo = await checkProductExpiration(product, businessDoc.id, doc.id);
        
        if (expirationInfo.expired) {
          // Producto vencido - mostrar alerta
          await showExpirationAlert(product, businessDoc.id, doc.id, expirationInfo);
          return;
        } else if (expirationInfo.message) {
          // Producto próximo a vencer - preguntar si desea vender
          const allowSale = await showExpirationAlert(product, businessDoc.id, doc.id, expirationInfo);
          if (!allowSale) return;
        }
        
        // Si no hay problemas de vencimiento o el usuario aceptó vender
        updateInvoice(product, businessDoc.id, doc.id);
      });
      productList.appendChild(productDiv);
    }

    hideProductLoading();
    isRendering = false;

    if (eanTerm) addToInvoiceBySearch(eanTerm);
  } catch (error) {
    console.error("Error al obtener los productos:", error);
    hideProductLoading();
    isRendering = false;
    showAlert('error', 'Error al cargar los productos');
  }
};

const addToInvoiceBySearch = async (eanTerm) => {
  const businessesRef = collection(db, "businesses");

  getDocs(businessesRef).then((businessesSnapshot) => {
    businessesSnapshot.forEach(async (businessDoc) => {
      const productsRef = collection(db, "businesses", businessDoc.id, "products");
      const productsQuery = query(
        productsRef, 
        where("userId", "==", currentCollaborator.userId),
        where("eanUpcCode", "==", eanTerm)
      );

      getDocs(productsQuery).then(async (querySnapshot) => {
        querySnapshot.forEach(async (doc) => {
          const product = doc.data();
          if (product.quantity === 0) {
            showAlert('warning', 'Este producto está agotado');
            return;
          }
          
          // Verificar vencimiento del producto CON ALERT DAYS PERSONALIZADOS
          const expirationInfo = await checkProductExpiration(product, businessDoc.id, doc.id);
          
          if (expirationInfo.expired) {
            // Producto vencido - mostrar alerta
            await showExpirationAlert(product, businessDoc.id, doc.id, expirationInfo);
            return;
          } else if (expirationInfo.message) {
            // Producto próximo a vencer - preguntar si desea vender
            const allowSale = await showExpirationAlert(product, businessDoc.id, doc.id, expirationInfo);
            if (!allowSale) return;
          }
          
          // Si no hay problemas de vencimiento o el usuario aceptó vender
          updateInvoice(product, businessDoc.id, doc.id);
        });
      });
    });
  });
};

// Funciones de facturación con impuestos por producto
const updateInvoice = (product, businessName, productId) => {
  const existingProduct = invoice.find((item) => item.productId === productId);
  if (existingProduct) {
    if (existingProduct.quantity >= product.quantity) {
      showAlert('warning', 'No hay suficiente stock de este producto');
      return;
    }
    existingProduct.quantity += 1;
  } else {
    invoice.push({ ...product, businessName, productId, quantity: 1 });
  }

  // Aplicar impuestos específicos del producto
  let priceWithTaxes = applyTaxesToProduct(product.pricePerUnit, product);
  
  totalPrice += priceWithTaxes;
  renderInvoice();
  
  // Actualizar en Firestore para sincronización en tiempo real
  updateRealTimeInvoice();
};

window.removeProduct = (productId) => {
  const productIndex = invoice.findIndex((item) => item.productId === productId);
  if (productIndex > -1) {
    // Aplicar impuestos específicos del producto
    let priceWithTaxes = applyTaxesToProduct(invoice[productIndex].pricePerUnit, invoice[productIndex]);
    
    totalPrice -= priceWithTaxes;
    invoice[productIndex].quantity -= 1;
    if (invoice[productIndex].quantity === 0) {
      invoice.splice(productIndex, 1);
    }
    renderInvoice();
  }
};

// Funciones de pago y facturación con impuestos por producto
const generateInvoice = async (paymentTypeValue, change = 0) => {
  const businessDetails = await getBusinessDetails();
  
  // Calcular impuestos totales por producto
  let totalITBIS = 0;
  let totalIVA = 0;
  
  if (taxConfig.activo) {
    invoice.forEach(item => {
      const basePrice = item.pricePerUnit;
      if (item.applyItbis) {
        totalITBIS += basePrice * (taxConfig.itbis / 100) * item.quantity;
      }
      if (item.applyIva) {
        totalIVA += basePrice * (taxConfig.iva / 100) * item.quantity;
      }
    });
  }
  
  // Asegurarnos de que amountReceived tenga un valor válido
  const receivedAmount = paymentTypeValue === 'Efectivo' ? parseFloat(amountReceived) || 0 : 0;
  
  // Generar ID de factura con formato Rtm-0001
  const invoiceId = generateInvoiceId();
  
  // Factura con logo, datos de empresa y código QR
  const invoiceHTML = `
    <div class="invoice-container" style="max-height: 80vh; overflow-y: auto;">
      <div class="invoice-header">
        ${businessDetails.logoUrl ? `<img src="${businessDetails.logoUrl}" alt="Logo de ${businessDetails.name}" style="max-width: 80px; max-height: 60px; margin-bottom: 10px;">` : ''}
        <h2>${businessDetails.name}</h2>
        <p>RNC: ${businessDetails.rnc}</p>
        <p>Teléfono: ${businessDetails.phone}</p>
        <p>Email: ${businessDetails.email}</p>
        <p>NCF: ${businessDetails.ncf}</p>
        <p>Factura ID: ${invoiceId}</p>
      </div>
      <div class="invoice-user">
        <p>Atendido por: ${currentCollaborator.firstName} ${currentCollaborator.lastName}</p>
      </div>
      <div class="invoice-products">
        <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px;">
          <span class="product-name">Producto</span>
          <span class="product-quantity">Cant</span>
          <span class="product-price">Precio</span>
          <span class="product-total">Total</span>
        </div>
        ${invoice.map(item => {
          // Aplicar impuestos específicos del producto
          let priceWithTaxes = applyTaxesToProduct(item.pricePerUnit, item);
          const itemTotal = priceWithTaxes * item.quantity;
          
          // Mostrar información de impuestos del producto
          let taxInfo = '';
          if (taxConfig.activo && (item.applyItbis || item.applyIva)) {
            taxInfo = ' ';
            if (item.applyItbis) taxInfo += '(ITBIS)';
            if (item.applyItbis && item.applyIva) taxInfo += ' ';
            if (item.applyIva) taxInfo += '(IVA)';
          }
          
          return `
            <div class="product-row">
              <span class="product-name">${item.name}${taxInfo}</span>
              <span class="product-quantity">${item.quantity}</span>
              <span class="product-price">$${formatNumberWithCommas(priceWithTaxes)}</span>
              <span class="product-total">$${formatNumberWithCommas(itemTotal)}</span>
            </div>
          `;
        }).join('')}
      </div>
      <div class="invoice-totals">
        <div class="total-row">
          <span>Descuento:</span>
          <span>${discount > 0 ? `$${formatNumberWithCommas(totalPrice * discount / 100)} (${discount}%)` : '$0.00'}</span>
        </div>
        ${taxConfig.activo && (totalITBIS > 0 || totalIVA > 0) ? `
          ${totalITBIS > 0 ? `
            <div class="total-row">
              <span>Total ITBIS:</span>
              <span>$${formatNumberWithCommas(totalITBIS)}</span>
            </div>
          ` : ''}
          ${totalIVA > 0 ? `
            <div class="total-row">
              <span>Total IVA:</span>
              <span>$${formatNumberWithCommas(totalIVA)}</span>
            </div>
          ` : ''}
        ` : ''}
        ${paymentTypeValue === 'Efectivo' ? `
          <div class="total-row">
            <span>Monto Recibido:</span>
            <span>$${formatNumberWithCommas(receivedAmount)}</span>
          </div>
          <div class="total-row">
            <span>Cambio:</span>
            <span>$${formatNumberWithCommas(change)}</span>
          </div>
        ` : ''}
        <div class="total-row" style="font-weight: bold;">
          <span>Total general:</span>
          <span>$${formatNumberWithCommas(discountedTotal)}</span>
        </div>
        <div class="total-row">
          <span>Método de pago:</span>
          <span>${paymentTypeValue}</span>
        </div>
      </div>
      <!-- Código QR agregado en la parte inferior -->
      ${businessDetails.qrUrl ? `
        <div class="qr-code" style="text-align: center; margin: 15px 0;">
          <img src="${businessDetails.qrUrl}" alt="Código QR" style="width: 2cm; height: 2cm; border: 1px solid #ddd; padding: 5px; background: white;">
        </div>
      ` : ''}
      <div class="thank-you">
        <p>Gracias por su compra</p>
        <!-- Políticas y Términos -->
<div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 9px; color: #666; text-align: center; line-height: 1.3;">
  <p><strong>POLÍTICAS DE LA EMPRESA:</strong></p>
  <p>• No se aceptan devoluciones después de 7 días.</p>
  <p>• Productos perecederos no tienen cambio.</p>
  <p>• Para garantías presentar factura original.</p>
  <p>• Precios incluyen ITBIS según ley.</p>
  <p>• Pagos con tarjeta sujetos a verificación.</p>
  <p>• Horario de atención: Lunes a Sábado 8:00 AM - 6:00 PM.</p>
  <p style="margin-top: 8px;"><strong>¡Gracias por preferirnos!</strong></p>
</div>
      </div>
    </div>
  `;
  
  invoicePrintContent.innerHTML = invoiceHTML;
  await saveInvoiceToFirebase(paymentTypeValue, change, receivedAmount, invoiceId);
  
  // Limpiar datos en tiempo real después de facturar
  await clearRealTimeData();
};

// Función para generar ID de factura con formato Rtm-0001
function generateInvoiceId() {
  // Generar un número aleatorio de 4 dígitos
  const randomNumber = Math.floor(1000 + Math.random() * 9000);
  return `Rtm-${randomNumber}`;
}

const clearRealTimeData = async () => {
  if (!currentCollaborator) return;
  
  try {
    const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
    await setDoc(totalRef, {
      total: 0
    }, { merge: true });
    
    const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
    await setDoc(productosRef, {
      productos: []
    }, { merge: true });
  } catch (error) {
    console.error("Error al limpiar datos en tiempo real:", error);
  }
};

// Función para guardar factura con impuestos por producto
const saveInvoiceToFirebase = async (paymentTypeValue, change = 0, receivedAmount = 0, invoiceId = '') => {
  try {
    showGlobalLoading("Guardando factura...");
    const businessDetails = await getBusinessDetails();
    
    // Calcular impuestos por producto
    let totalITBIS = 0;
    let totalIVA = 0;
    
    if (taxConfig.activo) {
      invoice.forEach(item => {
        const basePrice = item.pricePerUnit;
        if (item.applyItbis) {
          totalITBIS += basePrice * (taxConfig.itbis / 100) * item.quantity;
        }
        if (item.applyIva) {
          totalIVA += basePrice * (taxConfig.iva / 100) * item.quantity;
        }
      });
    }
    
    const subtotalSinImpuestos = invoice.reduce((sum, item) => {
      return sum + (item.pricePerUnit * item.quantity);
    }, 0);
    
    const invoiceData = {
      businessName: businessDetails.name,
      businessRNC: businessDetails.rnc,
      businessAddress: businessDetails.address,
      businessPhone: businessDetails.phone,
      businessEmail: businessDetails.email,
      businessNCF: businessDetails.ncf,
      businessLogoUrl: businessDetails.logoUrl,
      businessQrUrl: businessDetails.qrUrl,
      user: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
      userId: currentCollaborator.userId,
      collaboratorId: currentCollaborator.id, // AÑADIDO: ID del colaborador
      username: currentCollaborator.username, // AÑADIDO: Username del colaborador
      items: invoice.map(item => {
        // Aplicar impuestos específicos del producto
        let priceWithTaxes = applyTaxesToProduct(item.pricePerUnit, item);
        const itemTotal = priceWithTaxes * item.quantity;
        
        // Calcular impuestos individuales
        let itemITBIS = 0;
        let itemIVA = 0;
        
        if (taxConfig.activo) {
          const basePrice = item.pricePerUnit;
          if (item.applyItbis) {
            itemITBIS = basePrice * (taxConfig.itbis / 100) * item.quantity;
          }
          if (item.applyIva) {
            itemIVA = basePrice * (taxConfig.iva / 100) * item.quantity;
          }
        }
        
        return {
          name: item.name,
          quantity: item.quantity,
          pricePerUnit: item.pricePerUnit,
          priceWithProfit: priceWithTaxes, // CAMBIADO: de priceWithTaxes a priceWithProfit
          total: itemTotal,
          itbis: itemITBIS,
          iva: itemIVA,
          applyItbis: item.applyItbis || false,
          applyIva: item.applyIva || false,
          productId: item.productId,
          businessName: item.businessName
        };
      }),
      subtotal: subtotalSinImpuestos,
      discount: discount > 0 ? (totalPrice * discount / 100) : 0,
      discountPercentage: discount,
      itbis: totalITBIS,
      iva: totalIVA,
      total: discountedTotal,
      paymentType: paymentTypeValue,
      amountReceived: paymentTypeValue === 'Efectivo' ? parseFloat(receivedAmount) : 0,
      change: paymentTypeValue === 'Efectivo' ? change : 0,
      date: Timestamp.now(),
      invoiceId: invoiceId,
      timestamp: new Date().getTime(),
      taxesEnabled: taxConfig.activo,
      taxRates: taxConfig.activo ? { itbis: taxConfig.itbis, iva: taxConfig.iva } : {}
    };

    // Guardar en facturacionCarrito CON FILTRO DE COLABORADOR
    const carritoRef = await addDoc(collection(db, "facturacionCarrito"), invoiceData);
    
    // Guardar en el historial del colaborador
    const collaboratorInvoiceRef = collection(db, "users", currentCollaborator.userId, "invoiceHistory");
    await addDoc(collaboratorInvoiceRef, {
      ...invoiceData,
      carritoId: carritoRef.id
    });
    
    // Guardar en FacturaDeCuadres CON FILTRO DE COLABORADOR
    await addDoc(collection(db, "FacturaDeCuadres"), invoiceData);
    
    // Actualizar stock
    for (const item of invoice) {
      const productRef = doc(db, "businesses", item.businessName, "products", item.productId);
      const productDoc = await getDoc(productRef);
      
      if (productDoc.exists()) {
        const currentStock = productDoc.data().quantity;
        await updateDoc(productRef, {
          quantity: currentStock - item.quantity
        });
      }
    }
    
    hideGlobalLoading();
    showAlert('success', 'El pago fue realizado');
  } catch (error) {
    console.error("Error al guardar la factura:", error);
    hideGlobalLoading();
    showAlert('error', 'Error al guardar la factura: ' + error.message);
  }
};

const processPayment = async (paymentTypeValue) => {
  try {
    console.log("🚀 Iniciando processPayment para:", paymentTypeValue);
    
    if (invoice.length === 0) {
      showAlert('warning', 'No hay productos en la factura');
      return;
    }

    showGlobalLoading("Procesando pago...");
    
    // Verificar stock
    for (const item of invoice) {
      const productRef = doc(db, "businesses", item.businessName, "products", item.productId);
      const productDoc = await getDoc(productRef);

      if (productDoc.exists()) {
        const productData = productDoc.data();
        const currentQuantity = productData.quantity || 0;
        
        if (currentQuantity < item.quantity) {
          hideGlobalLoading();
          showAlert('warning', `No hay suficiente stock de ${item.name}`);
          return;
        }
      } else {
        hideGlobalLoading();
        showAlert('warning', `Producto ${item.name} no encontrado`);
        return;
      }
    }

    console.log("✅ Stock verificado, generando factura...");
    
    const change = paymentTypeValue === 'Efectivo' ? amountReceived - discountedTotal : 0;
    
    await generateInvoice(paymentTypeValue, change);
    
    console.log("✅ Factura generada, mostrando modal de impresión...");
    printModal.style.display = "block";

    console.log("🔄 Limpiando datos de factura...");
    
    // Limpiar factura
    invoice = [];
    totalPrice = 0;
    discount = 0;
    discountedTotal = 0;
    amountReceived = 0;
    renderInvoice();
    
    console.log("✅ Pago completado exitosamente");
    
  } catch (error) {
    console.error("❌ Error al procesar el pago:", error);
    showAlert('error', 'Error al procesar el pago: ' + error.message);
  } finally {
    hideGlobalLoading();
    console.log("🔚 processPayment finalizado");
  }
};

// FUNCIONES DE DESCUENTO MODIFICADAS - AHORA USAN LA CONFIGURACIÓN DEL USUARIO
const applyDiscount = async () => {
  try {
    if (!currentCollaborator) {
      showAlert('error', 'No hay usuario autenticado');
      return;
    }

    // Verificar si el sistema de descuentos está activado para este usuario
    if (!discountSettings || !discountSettings.activo) {
      showAlert('warning', 'El sistema de descuentos no está activado para este usuario');
      return;
    }

    // Mostrar modal de contraseña
    passwordModal.style.display = "block";
    passwordInput.value = "";
    passwordError.style.display = "none";
  } catch (error) {
    console.error("Error al aplicar descuento:", error);
    showAlert('error', 'Error al aplicar descuento');
  }
};

// Función para verificar la contraseña de descuento
submitPassword.addEventListener("click", async () => {
  try {
    const password = passwordInput.value.trim();
    
    if (!password) {
      passwordError.style.display = "block";
      passwordError.textContent = "Por favor ingrese la contraseña";
      return;
    }

    // Verificar si hay configuración de descuentos cargada
    if (!discountSettings) {
      passwordError.style.display = "block";
      passwordError.textContent = "No hay configuración de descuentos disponible";
      return;
    }

    // Verificar si el sistema de descuentos está activado
    if (!discountSettings.activo) {
      passwordError.style.display = "block";
      passwordError.textContent = "El sistema de descuentos no está activado";
      return;
    }

    // Verificar la contraseña
    if (password === discountSettings.password) {
      // Contraseña correcta, aplicar descuento
      discount = discountSettings.percentage;
      renderInvoice();
      passwordModal.style.display = "none";
      discountMessage.textContent = `Descuento del ${discount}% aplicado correctamente.`;
      discountAppliedModal.style.display = "block";
      passwordError.style.display = "none";
    } else {
      passwordError.style.display = "block";
      passwordError.textContent = "Contraseña incorrecta";
    }
  } catch (error) {
    console.error("Error al verificar contraseña:", error);
    passwordError.style.display = "block";
    passwordError.textContent = "Error al verificar contraseña";
  }
});

// Calcular cambio para el modal de efectivo mejorado - VERSIÓN CORREGIDA
const calculateChangeImproved = () => {
  const received = parseFormattedNumber(efectivoReceived.value) || 0;
  amountReceived = received; // Actualizar la variable global
  const change = received - discountedTotal;
  
  // Mostrar el cambio formateado (sin decimales forzados)
  efectivoChange.textContent = `DOP $${formatNumberWithCommas(change)}`;
  efectivoReceivedDisplay.textContent = `DOP $${formatNumberWithCommas(received)}`;
  
  // Validar si el monto es suficiente y mostrar feedback visual
  if (received < discountedTotal) {
    efectivoChange.style.color = '#e74c3c';
  } else {
    efectivoChange.style.color = '#00b894';
  }
};

// Configurar teclado numérico para el modal de efectivo - COMPORTAMIENTO CORREGIDO SIN DECIMALES FORZADOS
function setupEfectivoKeyboard() {
  const efectivoKeyboardBtns = document.querySelectorAll('.efectivo-keyboard-btn');
  
  efectivoKeyboardBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // Mantener el foco en el campo de monto recibido
      efectivoReceived.focus();
      
      const value = btn.getAttribute('data-value');
      let currentValue = efectivoReceived.value.replace(/,/g, ''); // Remover comas para procesar
      
      if (value) {
        // Si el campo tiene "0" o está vacío, limpiarlo antes de agregar números
        if (currentValue === '0' || currentValue === '') {
          currentValue = '';
        }
        
        // Agregar el nuevo número
        currentValue += value;
        
        // Formatear el número con comas pero SIN decimales forzados
        efectivoReceived.value = formatNumberWithCommas(currentValue);
      } else if (btn.id === 'efectivoClearBtn') {
        // Limpiar completamente el campo
        efectivoReceived.value = '0';
      } else if (btn.id === 'efectivoBackspaceBtn') {
        // Eliminar el último carácter completamente
        if (currentValue.length > 1) {
          currentValue = currentValue.slice(0, -1);
          // Si después de borrar queda vacío, poner "0"
          efectivoReceived.value = currentValue ? formatNumberWithCommas(currentValue) : '0';
        } else {
          // Si solo queda un carácter, poner "0"
          efectivoReceived.value = '0';
        }
      }
      
      // Recalcular el cambio
      calculateChangeImproved();
    });
  });
}

// Procesar pago en efectivo - CORREGIDA
const processEfectivoPayment = async () => {
  try {
    const received = parseFormattedNumber(efectivoReceived.value) || 0;
    
    // VALIDACIÓN MEJORADA DEL MONTO
    if (received <= 0) {
      showAlert('warning', 'Por favor ingrese un monto válido');
      return;
    }
    
    if (received < discountedTotal) {
      showAlert('warning', 'El monto recibido es insuficiente');
      return;
    }
    
    amountReceived = received;
    
    // Mostrar loading
    showGlobalLoading("Procesando pago...");
    
    // Cerrar modal primero
    efectivoModal.style.display = "none";
    
    // Procesar el pago
    await processPayment("Efectivo");
    
    // Limpiar campos del modal
    efectivoReceived.value = "0";
    efectivoChange.textContent = "DOP $0";
    efectivoReceivedDisplay.textContent = "DOP $0";
    
  } catch (error) {
    console.error("Error al procesar pago en efectivo:", error);
    hideGlobalLoading();
    showAlert('error', 'Error al procesar el pago: ' + error.message);
  }
};

// Abrir modal de efectivo
const openEfectivoModal = () => {
  if (invoice.length === 0) {
    showAlert('warning', 'No hay productos en la factura');
    return;
  }
  
  efectivoModal.style.display = "flex";
  efectivoReceived.value = '0';
  calculateChangeImproved();
  
  // Enfocar el campo después de un breve delay
  setTimeout(() => {
    efectivoReceived.focus();
    efectivoReceived.select();
  }, 100);
};

// Configurar teclado de contraseña de impuestos
function setupTaxPasswordKeyboard() {
  // Hacer el teclado arrastrable
  makeKeyboardDraggable(taxPasswordKeyboard);
  
  // Configurar botón de cierre
  closeTaxPasswordKeyboard.addEventListener('click', () => {
    taxPasswordKeyboard.style.display = 'none';
  });
  
  // Configurar botón shift
  taxPasswordShiftBtn.addEventListener('click', () => {
    isTaxPasswordShiftPressed = !isTaxPasswordShiftPressed;
    if (isTaxPasswordShiftPressed) {
      taxPasswordShiftBtn.classList.add('active');
    } else {
      taxPasswordShiftBtn.classList.remove('active');
    }
  });
  
  // Configurar botón de alternar símbolos
  taxPasswordSymbolToggle.addEventListener('click', () => {
    isTaxPasswordSymbolsVisible = !isTaxPasswordSymbolsVisible;
    if (isTaxPasswordSymbolsVisible) {
      lettersKeyboard.style.display = 'none';
      symbolsKeyboard.style.display = 'grid';
      taxPasswordSymbolToggle.classList.add('active');
      taxPasswordSymbolToggle2.classList.add('active');
    } else {
      lettersKeyboard.style.display = 'grid';
      symbolsKeyboard.style.display = 'none';
      taxPasswordSymbolToggle.classList.remove('active');
      taxPasswordSymbolToggle2.classList.remove('active');
    }
  });
  
  taxPasswordSymbolToggle2.addEventListener('click', () => {
    isTaxPasswordSymbolsVisible = !isTaxPasswordSymbolsVisible;
    if (isTaxPasswordSymbolsVisible) {
      lettersKeyboard.style.display = 'none';
      symbolsKeyboard.style.display = 'grid';
      taxPasswordSymbolToggle.classList.add('active');
      taxPasswordSymbolToggle2.classList.add('active');
    } else {
      lettersKeyboard.style.display = 'grid';
      symbolsKeyboard.style.display = 'none';
      taxPasswordSymbolToggle.classList.remove('active');
      taxPasswordSymbolToggle2.classList.remove('active');
    }
  });
  
  // Configurar botones del teclado de letras
  const letterButtons = lettersKeyboard.querySelectorAll('button');
  letterButtons.forEach(button => {
    button.addEventListener('click', () => {
      if (button.classList.contains('backspace')) {
        passwordInput.value = passwordInput.value.slice(0, -1);
      } else if (button.classList.contains('space')) {
        passwordInput.value += ' ';
      } else if (button.classList.contains('enter')) {
        submitPassword.click();
        taxPasswordKeyboard.style.display = 'none';
      } else if (button.classList.contains('shift')) {
        // El shift ya está manejado arriba
      } else if (button.classList.contains('symbol-toggle')) {
        // El symbol-toggle ya está manejado arriba
      } else {
        const value = isTaxPasswordShiftPressed ? 
          button.getAttribute("data-value").toUpperCase() : 
          button.getAttribute("data-value");
        
        passwordInput.value += value;
        
        // Auto-desactivar shift después de una tecla 
        if (isTaxPasswordShiftPressed) {
          isTaxPasswordShiftPressed = false;
          taxPasswordShiftBtn.classList.remove('active');
        }
      }
    });
  });
  
  // Configurar botones del teclado de símbolos
  const symbolButtons = symbolsKeyboard.querySelectorAll('button');
  symbolButtons.forEach(button => {
    button.addEventListener('click', () => {
      if (button.classList.contains('backspace')) {
        passwordInput.value = passwordInput.value.slice(0, -1);
      } else if (button.classList.contains('space')) {
        passwordInput.value += ' ';
      } else if (button.classList.contains('enter')) {
        submitPassword.click();
        taxPasswordKeyboard.style.display = 'none';
      } else if (button.classList.contains('symbol-toggle')) {
        // El symbol-toggle ya está manejado arriba
      } else {
        const value = button.getAttribute("data-value");
        passwordInput.value += value;
      }
    });
  });
}

// Mostrar teclado de contraseña de impuestos
function showTaxPasswordKeyboard() {
  taxPasswordKeyboard.style.display = 'block';
  // Posicionar el teclado cerca del campo de contraseña
  const rect = passwordInput.getBoundingClientRect();
  taxPasswordKeyboard.style.top = (rect.bottom + 10) + "px";
  taxPasswordKeyboard.style.left = (rect.left) + "px";
}

function makeKeyboardDraggable(keyboard) {
  let offsetX = 0, offsetY = 0;
  let isDragging = false;
  const header = keyboard.querySelector('.keyboard-header');
  
  if (header) {
    header.style.cursor = 'move';
    header.onmousedown = startDrag;
  }

  function startDrag(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Calcular el offset entre el mouse y la posición del teclado
    const rect = keyboard.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    
    isDragging = true;
    keyboard.classList.add('dragging');
    keyboard.style.zIndex = '2001';
    
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
  }

  function onDrag(e) {
    if (!isDragging) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    // Calcular nueva posición basada en la posición del mouse
    let newX = e.clientX - offsetX;
    let newY = e.clientY - offsetY;
    
    // Limitar dentro de la ventana
    const maxX = window.innerWidth - keyboard.offsetWidth;
    const maxY = window.innerHeight - keyboard.offsetHeight;
    
    newX = Math.max(0, Math.min(newX, maxX));
    newY = Math.max(0, Math.min(newY, maxY));
    
    // Aplicar nueva posición
    keyboard.style.left = newX + 'px';
    keyboard.style.top = newY + 'px';
  }

  function stopDrag() {
    isDragging = false;
    keyboard.classList.remove('dragging');
    
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
  }
}

function setupVirtualKeyboards() {
  // Hacer los teclados arrastrables con la misma función mejorada
  makeKeyboardDraggable(numericKeyboard);
  makeKeyboardDraggable(textKeyboard);
  
  // Configurar botones de cambio entre teclados
  switchToTextKeyboard.addEventListener('click', () => {
    numericKeyboard.style.display = 'none';
    textKeyboard.style.display = 'block';
    // Posicionar el teclado de texto donde estaba el numérico
    textKeyboard.style.top = numericKeyboard.style.top;
    textKeyboard.style.left = numericKeyboard.style.left;
    // Activar el campo de búsqueda por nombre
    currentActiveSearchInput = searchByNameInput;
    searchByNameInput.focus();
  });
  
  switchToNumericKeyboard.addEventListener('click', () => {
    textKeyboard.style.display = 'none';
    numericKeyboard.style.display = 'block';
    // Posicionar el teclado numérico donde estaba el de texto
    numericKeyboard.style.top = textKeyboard.style.top;
    numericKeyboard.style.left = textKeyboard.style.left;
    // Activar el campo de búsqueda numérico
    currentActiveSearchInput = searchInput;
    searchInput.focus();
  });
  
  // Configurar botones de cierre - CORREGIDO PARA EVITAR "null"
  closeNumericKeyboard.addEventListener('click', () => {
    numericKeyboard.style.display = 'none';
    // Limpiar la referencia al campo activo sin afectar el contenido
    currentActiveSearchInput = null;
  });
  
  // MODIFICADO: El teclado de texto se cierra al hacer clic fuera
  // No hay botón de cerrar en el teclado de texto
  
  // Configurar botón shift
  shiftBtn.addEventListener('click', () => {
    isShiftPressed = !isShiftPressed;
    if (isShiftPressed) {
      shiftBtn.classList.add('active');
    } else {
      shiftBtn.classList.remove('active');
    }
  });
  
  // Configurar botones numéricos
  const numericButtons = document.querySelectorAll('.numeric-keyboard .numeric-btn');
  numericButtons.forEach(button => {
    button.addEventListener('click', () => {
      if (button.id !== "backspaceBtn" && button.id !== "acceptBtn") {
        const value = button.getAttribute("data-value");
        if (currentActiveSearchInput) {
          currentActiveSearchInput.value += value;
        } else {
          searchInput.value += value;
        }
      }
    });
  });

  // Configurar botón de retroceso numérico
  const backspaceBtn = document.querySelector('#backspaceBtn');
  backspaceBtn.addEventListener('click', () => {
    if (currentActiveSearchInput) {
      currentActiveSearchInput.value = currentActiveSearchInput.value.slice(0, -1);
    } else {
      searchInput.value = searchInput.value.slice(0, -1);
    }
  });

  // Configurar botón de aceptar numérico
  const acceptBtn = document.querySelector('#acceptBtn');
  acceptBtn.addEventListener('click', () => {
    if (currentActiveSearchInput === searchInput || !currentActiveSearchInput) {
      renderProducts(searchInput.value, "");
    } else {
      renderProducts("", searchByNameInput.value);
    }
    numericKeyboard.style.display = 'none';
    currentActiveSearchInput = null;
  });

  // Configurar botones de texto - CORREGIDOS
  const textButtons = document.querySelectorAll('.text-keyboard button');
  textButtons.forEach(button => {
    button.addEventListener('click', () => {
      if (button.classList.contains('backspace')) {
        if (currentActiveSearchInput) {
          currentActiveSearchInput.value = currentActiveSearchInput.value.slice(0, -1);
        } else {
          searchByNameInput.value = searchByNameInput.value.slice(0, -1);
        }
      } else if (button.classList.contains('space')) {
        if (currentActiveSearchInput) {
          currentActiveSearchInput.value += ' ';
        } else {
          searchByNameInput.value += ' ';
        }
      } else if (button.classList.contains('enter')) {
        if (currentActiveSearchInput === searchByNameInput || !currentActiveSearchInput) {
          renderProducts("", searchByNameInput.value);
        } else {
          renderProducts(searchInput.value, "");
        }
        textKeyboard.style.display = 'none';
        currentActiveSearchInput = null;
      } else if (button.classList.contains('shift')) {
        // El shift ya está manejado arriba
      } else if (button.classList.contains('number-toggle')) {
        // Cambiar a teclado numérico
        textKeyboard.style.display = 'none';
        numericKeyboard.style.display = 'block';
        numericKeyboard.style.top = textKeyboard.style.top;
        numericKeyboard.style.left = textKeyboard.style.left;
        // Activar el campo de búsqueda numérico
        currentActiveSearchInput = searchInput;
        searchInput.focus();
      } else {
        const value = isShiftPressed ? 
          button.getAttribute("data-value").toUpperCase() : 
          button.getAttribute("data-value");
        
        if (currentActiveSearchInput) {
          currentActiveSearchInput.value += value;
        } else {
          searchByNameInput.value += value;
        } 
        
        // Auto-desactivar shift después de una tecla 
        if (isShiftPressed) {
          isShiftPressed = false;
          shiftBtn.classList.remove('active');
        }
      }
    });
  });
} 

// =============================================
// EVENT LISTENERS PARA EL ESCÁNER MODIFICADOS
// =============================================

// Botón de escáner dentro del buscador
scannerBtnInside.addEventListener('click', () => {
  openScannerModal();
});

// Cerrar modal del escáner
closeScanner.addEventListener('click', () => {
  closeScannerModal();
});

// Cambiar cámara
switchCameraBtn.addEventListener('click', () => {
  switchCamera();
});

// Subir imagen desde galería
uploadImageBtn.addEventListener('click', () => {
  imageUploadInput.click();
});

// Procesar imagen seleccionada
imageUploadInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    scanFromImage(file);
  }
});

// =============================================
// MODIFICACIÓN: Función para limpiar automáticamente el campo de búsqueda
// =============================================

// Función para limpiar el campo de búsqueda después de 6 segundos
function setupAutoClearSearch() {
  let searchTimeout = null;
  
  // Función para manejar la búsqueda con limpieza automática
  function handleSearchWithAutoClear(searchFunction, searchTerm) {
    // Limpiar timeout anterior
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Ejecutar la búsqueda
    searchFunction(searchTerm, "");
    
    // Configurar limpieza automática después de 6 segundos
    searchTimeout = setTimeout(() => {
      if (searchInput && searchInput.value === searchTerm) {
        searchInput.value = '';
        console.log("🧹 Campo de búsqueda limpiado automáticamente después de 6 segundos");
      }
    }, 6000);
  }
  
  // Modificar el event listener del campo de búsqueda EAN/UPC
  searchInput.addEventListener("input", (e) => {
    const currentTerm = e.target.value.trim();
    
    // Solo buscar si el término cambió significativamente
    if (currentTerm === "" && lastSearchTerm !== "") {
      loadCollaboratorProducts();
      lastSearchTerm = "";
    } else if (currentTerm !== "" && currentTerm !== lastSearchTerm) {
      handleSearchWithAutoClear(renderProducts, currentTerm);
      lastSearchTerm = currentTerm;
    }
  });
}

// Inicializar la limpieza automática
setupAutoClearSearch();

// CORRECCIÓN: Event listener para Ctrl+Alt+P - VERSIÓN MEJORADA
document.addEventListener('keydown', (e) => {
  // Ctrl+Alt+P para modo especial
  if (e.ctrlKey && e.altKey && e.key === 'p') {
    e.preventDefault();
    console.log("Ctrl+Alt+P presionado - Mostrando modal de acceso rápido");
    
    // Mostrar el modal de acceso rápido existente
    const quickAccessModal = document.getElementById('quickAccessModal');
    if (quickAccessModal) {
      quickAccessModal.style.display = 'flex';
    }
  }
  
  // Resto de atajos de teclado...
  // Ctrl+D para descuento
  if (e.ctrlKey && e.key === 'd') {
    e.preventDefault();
    btnApplyDiscount.click();
  }
  
  // Ctrl+E para pago en efectivo
  if (e.ctrlKey && e.key === 'e') {
    e.preventDefault();
    btnEfectivo.click();
  }
  
  // Ctrl+T para pago con tarjeta
  if (e.ctrlKey && e.key === 't') {
    e.preventDefault();
    btnTarjeta.click();
  }
  
  // Ctrl+F para facturar
  if (e.ctrlKey && e.key === 'f') {
    e.preventDefault();
    payButton.click();
  }
  
  // F5 o Ctrl+R para recargar
  if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
    e.preventDefault();
    refreshBtn.click();
  }
  
  // BOTÓN "SUPR" (DELETE) PARA EL BUSCADOR EAN/UPC
  if (e.key === 'Delete' || e.key === 'Del') {
    e.preventDefault();
    
    // Verificar si estamos en la sección POS (no en login)
    if (posSection.style.display === 'block') {
      // Obtener el elemento activo
      const focusedElement = document.activeElement;
      
      // Solo activar la función si no estamos en un campo de texto específico
      // o si estamos en el campo de búsqueda EAN/UPC
      if (focusedElement === searchInput || focusedElement === searchByNameInput) {
        // Si ya está en el campo de búsqueda, vaciarlo
        focusedElement.value = '';
        loadCollaboratorProducts();
      } else {
        // Si no está en ningún campo de búsqueda, activar el buscador EAN/UPC
        handleDeleteKey();
      }
    }
  }
  
  // Enter para aceptar y confirmar pagos
  if (e.key === 'Enter') {
    if (efectivoModal.style.display === 'flex') {
      confirmEfectivo.click();
    } else if (tarjetaModal.style.display === 'flex') { 
      confirmTarjeta.click();
    } else if (passwordModal.style.display === 'block') {
      submitPassword.click();
    } else if (numericKeyboard.style.display === 'block') {
      acceptBtn.click();
    } else if (textKeyboard.style.display === 'block') {
      const enterBtn = document.querySelector('.text-keyboard .enter');
      if (enterBtn) enterBtn.click();
    } 
  } 
  
  // Tab para cambiar de vista 
  if (e.key === 'Tab') { 
    e.preventDefault();
    if (currentView === 'grid') { 
      setProductView('list'); 
    } else { 
      setProductView('grid'); 
    }
  }
});

// Función para manejar el botón "Supr" (Delete) - VERSIÓN MEJORADA
function handleDeleteKey() {
  // 1. Vaciar el campo de búsqueda EAN/UPC
  searchInput.value = '';
  
  // 2. Activar el buscador (cargar todos los productos)
  loadCollaboratorProducts();
  
  // 3. Enfocar el campo de búsqueda
  searchInput.focus();
  
  // 4. Mostrar feedback visual (opcional)
  searchInput.style.backgroundColor = 'rgba(22, 224, 134, 0.2)';
  setTimeout(() => {
    searchInput.style.backgroundColor = '';
  }, 300);
  
  console.log("✅ Botón 'Supr' activado: Buscador EAN/UPC vaciado y enfocado");
}

// Event Listeners CORREGIDOS - VERSIÓN MEJORADA
btnEfectivo.addEventListener("click", () => {
  if (invoice.length === 0) {
    showAlert('warning', 'No hay productos en la factura');
    return;
  }
  efectivoModal.style.display = "flex";
  efectivoReceived.value = '0';
  calculateChangeImproved();
  setTimeout(() => {
    efectivoReceived.focus();
    efectivoReceived.select();
  }, 100);
});

payButton.addEventListener("click", () => {
  if (invoice.length === 0) {
    showAlert('warning', 'No hay productos en la factura');
    return;
  }
  efectivoModal.style.display = "flex";
  efectivoReceived.value = '0';
  calculateChangeImproved();
  setTimeout(() => {
    efectivoReceived.focus();
    efectivoReceived.select();
  }, 100);
});

confirmEfectivo.addEventListener("click", async () => {
  const received = parseFormattedNumber(efectivoReceived.value) || 0;
  
  // VALIDACIÓN MEJORADA DEL MONTO
  if (received <= 0) {
    showAlert('warning', 'Por favor ingrese un monto válido');
    return;
  }
  
  if (received < discountedTotal) {
    showAlert('warning', 'El monto recibido es insuficiente');
    return;
  }
  
  try {
    console.log("💵 Confirmando pago en efectivo...");
    amountReceived = received;
    
    // Cerrar modal inmediatamente
    efectivoModal.style.display = "none";
    
    // Limpiar campos del modal
    efectivoReceived.value = "0";
    efectivoChange.textContent = "DOP $0";
    efectivoReceivedDisplay.textContent = "DOP $0";
    
    // Procesar el pago
    await processPayment("Efectivo");
    
  } catch (error) {
    console.error("❌ Error en pago efectivo:", error);
    showAlert('error', 'Error al procesar el pago');
  }
});

cancelEfectivo.addEventListener("click", () => {
  efectivoModal.style.display = "none";
  efectivoReceived.value = "0";
  efectivoChange.textContent = "DOP $0";
  efectivoReceivedDisplay.textContent = "DOP $0";
});

closeEfectivoModal.addEventListener("click", () => {
  efectivoModal.style.display = "none";
  efectivoReceived.value = "0";
  efectivoChange.textContent = "DOP $0";
  efectivoReceivedDisplay.textContent = "DOP $0";
});

btnTarjeta.addEventListener("click", () => {
  if (invoice.length === 0) {
    showAlert('warning', 'No hay factura para pagar');
    return;
  }
  tarjetaModal.style.display = "flex";
});

confirmTarjeta.addEventListener("click", () => {
  processPayment("Tarjeta");
  tarjetaModal.style.display = "none";
});

btnApplyDiscount.addEventListener("click", applyDiscount);

// Event listener para el icono del teclado de contraseña
passwordKeyboardIcon.addEventListener("click", () => {
  showTaxPasswordKeyboard();
});

// Event listener para el campo de monto recibido - MANTIENE EL FOCO
efectivoReceived.addEventListener("input", calculateChangeImproved);

// Permitir entrada manual con teclado físico - MANTIENE EL FOCO
efectivoReceived.addEventListener("keydown", (e) => {
  // Permitir solo números, punto, coma y teclas de control
  if (!/[\d,.]|Backspace|Delete|ArrowLeft|ArrowRight|Tab/.test(e.key)) {
    e.preventDefault();
  }
});

efectivoReceived.addEventListener("blur", () => {
  // Formatear el valor cuando el campo pierde el foco
  const value = parseFormattedNumber(efectivoReceived.value) || 0;
  efectivoReceived.value = formatNumberWithCommas(value);
  calculateChangeImproved();
});

// Navegación en el login con Shift+Tab y Enter
loginUsername.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    loginPin.focus();
  }
});

loginPin.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    loginButton.click();
  }
  if (e.key === "Tab" && e.shiftKey) {
    e.preventDefault();
    loginUsername.focus();
  }
});

// Eventos del teclado virtual - CORREGIDOS
searchInput.addEventListener("click", () => {
  numericKeyboard.style.display = "block";
  textKeyboard.style.display = "none";
  
  // POSICIONAMIENTO MEJORADO del teclado cerca del campo de búsqueda
  const rect = searchInput.getBoundingClientRect();
  const keyboardTop = rect.bottom + 10;
  const keyboardLeft = Math.max(10, rect.left);
  
  // Verificar que no se salga de la pantalla
  const maxTop = window.innerHeight - numericKeyboard.offsetHeight - 10;
  const maxLeft = window.innerWidth - numericKeyboard.offsetWidth - 10;
  
  numericKeyboard.style.top = Math.min(keyboardTop, maxTop) + "px";
  numericKeyboard.style.left = Math.min(keyboardLeft, maxLeft) + "px";
  
  currentActiveSearchInput = searchInput;
});

searchByNameInput.addEventListener("click", () => {
  textKeyboard.style.display = "block";
  numericKeyboard.style.display = "none";
  
  // POSICIONAMIENTO MEJORADO del teclado cerca del campo de búsqueda
  const rect = searchByNameInput.getBoundingClientRect();
  const keyboardTop = rect.bottom + 10;
  const keyboardLeft = Math.max(10, rect.left);
  
  // Verificar que no se salga de la pantalla
  const maxTop = window.innerHeight - textKeyboard.offsetHeight - 10;
  const maxLeft = window.innerWidth - textKeyboard.offsetWidth - 10;
  
  textKeyboard.style.top = Math.min(keyboardTop, maxTop) + "px";
  textKeyboard.style.left = Math.min(keyboardLeft, maxLeft) + "px";
  
  currentActiveSearchInput = searchByNameInput;
});

document.addEventListener("click", (e) => {
  // Cerrar teclados al hacer clic fuera de ellos
  if (!searchInput.contains(e.target) && !numericKeyboard.contains(e.target) &&
      !searchByNameInput.contains(e.target) && !textKeyboard.contains(e.target) &&
      !passwordInput.contains(e.target) && !taxPasswordKeyboard.contains(e.target) &&
      !passwordKeyboardIcon.contains(e.target) && !scannerModal.contains(e.target) &&
      !scannerBtnInside.contains(e.target)) {
    numericKeyboard.style.display = "none";
    textKeyboard.style.display = "none";
    taxPasswordKeyboard.style.display = "none";
    currentActiveSearchInput = null;
  }
});

// Búsqueda corregida para evitar duplicación - MEJORADO
// (Ya manejado por setupAutoClearSearch)

searchByNameInput.addEventListener("input", (e) => {
  const currentTerm = e.target.value.trim();
  
  // Solo buscar si el término cambió significativamente
  if (currentTerm === "" && lastSearchTerm !== "") {
    loadCollaboratorProducts();
    lastSearchTerm = "";
  } else if (currentTerm !== "" && currentTerm !== lastSearchTerm) {
    renderProducts(searchInput.value, currentTerm);
    lastSearchTerm = currentTerm;
  }
});

// Eventos de cierre de modales
closeModal.addEventListener("click", () => printModal.style.display = "none");
closeTarjetaModal.addEventListener("click", () => tarjetaModal.style.display = "none");
closePasswordModal.addEventListener("click", () => {
  passwordModal.style.display = "none";
  passwordError.style.display = "none";
  taxPasswordKeyboard.style.display = "none";
});
closeDiscountModal.addEventListener("click", () => discountAppliedModal.style.display = "none");
closeUserModal.addEventListener("click", () => userInfoModal.style.display = "none");
closeRatesModal.addEventListener("click", () => ratesModal.style.display = "none");
closeTaxesModal.addEventListener("click", () => taxesModal.style.display = "none");
// CORRECCIÓN: Cerrar modal de acceso rápido
document.getElementById('closeQuickAccess')?.addEventListener("click", () => {
  document.getElementById('quickAccessModal').style.display = "none";
});

btnPrint.addEventListener("click", () => {
  const printContent = invoicePrintContent.innerHTML;
  const printWindow = window.open('', '', 'height=400,width=600');
  printWindow.document.write('<html><head><title>Imprimir Factura</title>');
  printWindow.document.write('<style>body { font-family: Arial; width: 80mm; margin: 0; padding: 10px; } p, h2, h3 { color: #000; margin: 5px 0; } button { display: none; } .invoice-container { width: 100%; max-width: 80mm; margin: 0 auto; padding: 10px; font-family: Arial, sans-serif; } .invoice-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px; } .invoice-header h2 { margin: 5px 0; font-size: 18px; } .invoice-header p { margin: 3px 0; font-size: 14px; } .invoice-user { margin: 10px 0; padding-bottom: 5px; border-bottom: 1px dashed #000; } .invoice-products { margin: 10px 0; } .product-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; } .product-name { flex: 3; } .product-quantity, .product-price, .product-total { flex: 1; text-align: right; } .invoice-totals { margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px; } .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; } .qr-code { text-align: center; margin-top: 15px; } .thank-you { text-align: center; margin-top: 10px; font-style: italic; }</style></head><body>');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.print();
  printWindow.close();
});

// Navegación
homeBtn.addEventListener('click', () => {
  productListSection.style.display = 'block';
  invoiceSection.style.display = 'block';
  advancedMenu.style.display = 'none';
});

inventoryBtn.addEventListener('click', () => {
  showAlert('info', 'Redirigiendo al inventario');
});

reportsBtn.addEventListener('click', () => {
  showAlert('info', 'Redirigiendo a reportes');
});

invoicesBtn.addEventListener('click', () => {
  showAlert('info', 'Redirigiendo a facturas');
});

salesAnalysisBtn.addEventListener('click', () => {
  showAlert('info', 'Redirigiendo a análisis de ventas');
});

userBtn.addEventListener('click', () => {
  userInfoModal.style.display = 'flex';
});

// Evento para el botón de tiempo - AHORA MUESTRA DETALLES ELEGANTES
clockBtn.addEventListener('click', () => {
  showShiftDetails();
});

ratesBtn.addEventListener('click', () => {
  ratesModal.style.display = 'flex';
});

// Nuevo evento para el botón de impuestos
taxesBtn.addEventListener('click', () => {
  taxesModal.style.display = 'flex';
});

// Evento para el botón de recarga - COMPLETAMENTE CORREGIDO
refreshBtn.addEventListener('click', async () => {
  try {
    showProductLoading();
    
    console.log("🔄 Recargando productos...");
    
    // Limpiar estado actual
    productsMap.clear();
    productList.innerHTML = "";
    
    // Limpiar listeners anteriores
    cleanupAllListeners();
    
    // Forzar recarga completa de productos
    if (currentCollaborator) {
      console.log("🔍 Buscando productos para colaborador:", currentCollaborator.id);
      
      // Usar renderProducts con búsqueda vacía para cargar TODOS los productos
      await renderProducts("", "");
      
      // Configurar listeners en tiempo real
      setupRealTimeProductListeners();
      setupRealTimeListeners();
      
      console.log("✅ Productos recargados exitosamente");
      showAlert('success', 'Lista de productos actualizada correctamente');
    } else {
      console.log("❌ No hay colaborador autenticado");
      showAlert('error', 'No hay usuario autenticado');
    }
    
  } catch (error) {
    console.error("❌ Error al recargar productos:", error);
    showAlert('error', 'Error al recargar productos: ' + error.message);
  } finally {
    // El loading se oculta dentro de renderProducts
    setTimeout(() => {
      searchInput.focus();
    }, 500);
  }
});

// Evento para el botón de menú avanzado
advancedMenuBtn.addEventListener('click', (e) => {
  e.preventDefault();
  advancedMenu.style.display = advancedMenu.style.display === 'block' ? 'none' : 'block';
});

// Eventos para el menú avanzado
quickStatsBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

backupBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

exportBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

importBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

bulkDiscountBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

priceUpdateBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none'; 
});

stockAlertBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

customerManagementBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

supplierManagementBtn.addEventListener('click', (e) => {
  advancedMenu.style.display = 'none';
});

// Cerrar menú avanzado al hacer clic fuera de él
document.addEventListener('click', (e) => {
  if (!advancedMenuBtn.contains(e.target) && !advancedMenu.contains(e.target)) {
    advancedMenu.style.display = 'none';
  }
});

// Eventos para la pantalla de fin de turno
changeAccountBtn.addEventListener('click', () => {
  logoutCollaborator();
  shiftEndScreen.style.display = 'none';
  loginSection.style.display = 'flex';
});

reloadBtn.addEventListener('click', () => {
  location.reload();
});

// Inicializar teclados virtuales
setupVirtualKeyboards();

// Inicializar teclado del modal de efectivo
setupEfectivoKeyboard();

// Inicializar teclado de contraseña de impuestos
setupTaxPasswordKeyboard();

// Enfocar automáticamente el campo de búsqueda EAN/UPC al cargar la página
window.onload = function() {
  if (localStorage.getItem('collaboratorLoggedIn') === 'true') {
    setTimeout(() => {
      searchInput.focus();
    }, 1000);
  } else {
    loginUsername.focus();
  }
};

// Observar cambios en la visibilidad de la sección POS
const observer = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.attributeName === 'style') {
      if (posSection.style.display === 'block') {
        setTimeout(() => {  
          // Código adicional si es necesario
        }, 500);
      }
    }
  });
});

// Observar cambios en el atributo style de la sección POS  
observer.observe(posSection, { attributes: true });
</script> 
</body>
</html>
