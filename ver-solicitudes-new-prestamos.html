<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mis Solicitudes - Sistema de Préstamos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1abc9c;
            --primary-dark: #16a085;
            --background-color: #2c3e50;
            --text-color: #ffffff;
            --text-light: #a8a8a8;
            --border-color: #444;
            --card-bg: #34495e;
            --danger-color: #e74c3c;
            --success-color: #15b086;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            --smooth-transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Poppins', 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        /* Header fijo para móviles */
        .app-header {
            background: var(--card-bg);
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 0.5rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .header-title {
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--primary-color);
            padding: 0.5rem;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .notification-count.active {
            display: flex;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Contenedor principal ajustado para móvil */
        .container {
            flex: 1;
            width: 100%;
            max-width: 100%;
            padding: 0;
            margin-top: 70px; /* Para el header fijo */
            margin-bottom: 80px; /* Para el footer fijo */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .content {
            padding: 1rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Card styles optimizadas para móvil */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--smooth-transition);
            width: 100%;
            box-sizing: border-box;
        }

        .card-title {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* User info panel */
        .user-panel {
            text-align: center;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.1), rgba(22, 160, 133, 0.1));
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .user-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
        }

        .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .user-email {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .login-info {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Filter controls */
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--smooth-transition);
            flex: 1;
            min-width: 80px;
            text-align: center;
        }

        .filter-btn.active {
            background: var(--gradient-primary);
            border-color: var(--primary-color);
        }

        /* Application list */
        .application-list {
            margin-top: 1rem;
        }

        .application-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
            transition: var(--smooth-transition);
            animation: fadeIn 0.5s ease;
            border: 1px solid var(--border-color);
        }

        .application-item.new {
            border-left-color: var(--warning-color);
            background: rgba(243, 156, 18, 0.05);
            animation: highlight 1s ease;
        }

        @keyframes highlight {
            0% { background-color: rgba(243, 156, 18, 0.2); }
            100% { background-color: rgba(243, 156, 18, 0.05); }
        }

        .application-item.pending {
            border-left-color: var(--warning-color);
        }

        .application-item.approved {
            border-left-color: var(--success-color);
        }

        .application-item.rejected {
            border-left-color: var(--danger-color);
        }

        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .application-rtm {
            font-family: monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 1px;
        }

        .application-status {
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-pending {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
        }

        .status-approved {
            background-color: rgba(46, 204, 113, 0.2);
            color: var(--success-color);
        }

        .status-rejected {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger-color);
        }

        .application-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .detail-label {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .detail-value {
            font-weight: 500;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .application-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .application-date {
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .application-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Action buttons */
        .btn {
            background: var(--gradient-primary);
            color: var(--text-color);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--smooth-transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            min-height: 36px;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 188, 156, 0.3);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            min-height: 32px;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #11946e);
        }

        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }

        .btn-warning:hover {
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #2980b9);
        }

        .btn-info:hover {
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(127, 140, 141, 0.3);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 3rem;
            color: var(--border-color);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        /* Loading spinner */
        .spinner {
            text-align: center;
            padding: 2rem;
        }

        .spinner-icon {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification sound control */
        .sound-control {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 999;
            display: none;
        }

        .sound-control.active {
            display: block;
        }

        .sound-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--smooth-transition);
        }

        .sound-btn:hover {
            transform: scale(1.1);
        }

        .sound-btn.muted {
            background: var(--border-color);
        }

        /* Footer fijo para móviles */
        .app-footer {
            background: var(--card-bg);
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .footer-info {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Media queries */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin-left: auto;
                margin-right: auto;
            }
            
            .content {
                padding: 1.5rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .application-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .filter-controls {
                gap: 1rem;
            }
            
            .filter-btn {
                min-width: 100px;
            }
            
            .application-actions {
                flex-wrap: nowrap;
            }
        }

        @media (max-width: 480px) {
            .application-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .application-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .application-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                flex: 1;
                min-width: 0;
            }
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Estilo para nuevos mensajes */
        .new-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
            display: none;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { top: 0; opacity: 0; }
            to { top: 80px; opacity: 1; }
        }

        /* Mensaje de redirección */
        .redirect-message {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .redirect-icon {
            font-size: 3rem;
            color: var(--warning-color);
            margin-bottom: 1rem;
        }

        .redirect-btn {
            margin-top: 1.5rem;
            padding: 0.8rem 2rem;
            font-size: 1rem;
        }

        /* Modal de detalles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--primary-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: var(--smooth-transition);
        }

        .modal-close:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        /* Estilo para el indicador "Nuevo" */
        .new-badge {
            background: var(--warning-color);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }

        /* Contador de nuevas solicitudes */
        .new-requests-alert {
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 8px;
            border: 1px solid var(--warning-color);
            display: none;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .new-requests-alert.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        /* Efecto de resaltado para nuevas solicitudes */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(243, 156, 18, 0); }
            100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
        }

        .application-item.new {
            animation: pulse-glow 2s infinite, fadeIn 0.5s ease;
        }

        /* Mejoras para los botones en móviles */
        @media (max-width: 360px) {
            .application-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* Botones de acción flotantes */
        .action-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .action-button {
            flex: 1;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- Header fijo para móviles -->
    <header class="app-header">
        <button class="btn btn-sm" onclick="window.location.href='index.html'" style="background: rgba(255,255,255,0.1); padding: 0.5rem;">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-content">
            <img src="logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
            <h1 class="header-title">Mis Solicitudes</h1>
        </div>
        <div class="notification-bell" id="notificationBell" style="display: none;">
            <i class="fas fa-bell"></i>
            <span class="notification-count" id="notificationCount">0</span>
        </div>
    </header>

    <!-- Notificación de nueva solicitud -->
    <div class="new-notification" id="newNotification">
        <i class="fas fa-exclamation-circle"></i>
        <span id="notificationMessage">¡Nueva solicitud recibida!</span>
    </div>

    <!-- Contenedor principal -->
    <div class="container">
        <div class="content" id="mainContent">
            <!-- Contenido cuando NO hay usuario -->
            <div id="noUserSection" style="display: none;">
                <div class="card" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(231, 76, 60, 0.1)); border: 2px solid var(--warning-color);">
                    <div style="text-align: center; padding: 2rem 1rem;">
                        <div class="redirect-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h2 style="color: var(--warning-color); margin-bottom: 1rem;">Usuario no identificado</h2>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                            No hay un usuario identificado en el sistema. Para ver tus solicitudes, 
                            necesitas iniciar sesión en la página principal.
                        </p>
                        <p style="color: var(--text-color); font-size: 0.9rem; margin-bottom: 2rem;">
                            <i class="fas fa-info-circle"></i> 
                            Solo puedes ver las solicitudes cuando has iniciado sesión en el sistema.
                        </p>
                        <button class="btn btn-warning redirect-btn" onclick="redirectToIndex()">
                            <i class="fas fa-sign-in-alt"></i> Ir a Iniciar Sesión
                        </button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1.5rem; background: rgba(26, 188, 156, 0.1); border: 1px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i> ¿Cómo funciona?
                    </h4>
                    <ol style="padding-left: 1.5rem; color: var(--text-light); font-size: 0.9rem;">
                        <li style="margin-bottom: 0.5rem;">Inicia sesión en la página principal del sistema</li>
                        <li style="margin-bottom: 0.5rem;">Tu sesión se guarda automáticamente</li>
                        <li style="margin-bottom: 0.5rem;">Regresa a esta página para ver tus solicitudes</li>
                        <li>Las solicitudes se actualizan en tiempo real</li>
                    </ol>
                </div>
            </div>
            
            <!-- Contenido cuando SÍ hay usuario -->
            <div id="requestsSection" style="display: none;">
                <!-- Panel de información del usuario -->
                <div class="user-panel" id="userPanel">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <h2 class="user-name" id="userName">Usuario</h2>
                    <p class="user-email" id="userEmail">usuario@ejemplo.com</p>
                    <div class="login-info">
                        <i class="fas fa-user-check"></i>
                        <span>Sesión activa - Verificando solicitudes...</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
                        <i class="fas fa-history"></i> Última actualización: <span id="lastUpdate">--:--:--</span>
                    </div>
                    <button class="btn btn-sm" onclick="logout()" style="margin-top: 1rem; background: rgba(255,255,255,0.1);">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>

                <!-- Card principal -->
                <div class="card">
                    <div class="card-title">
                        <span><i class="fas fa-file-invoice-dollar"></i> Mis Solicitudes Recibidas</span>
                        <span id="applicationCount">0 solicitudes</span>
                    </div>

                    <!-- Controles de filtro -->
                    <div class="filter-controls">
                        <button class="filter-btn active" data-filter="all">Todas</button>
                        <button class="filter-btn" data-filter="pending">Pendientes</button>
                        <button class="filter-btn" data-filter="approved">Aprobadas</button>
                        <button class="filter-btn" data-filter="rejected">Rechazadas</button>
                    </div>

                    <!-- Contador de nuevas solicitudes -->
                    <div class="new-requests-alert" id="newRequestsAlert">
                        <div class="alert-content">
                            <i class="fas fa-bell" style="color: var(--warning-color);"></i>
                            <span style="color: var(--warning-color); font-weight: 500;">
                                Tienes <span id="newRequestsCount">0</span> nuevas solicitudes
                            </span>
                        </div>
                        <button class="btn btn-warning btn-sm" onclick="markAllAsRead()">
                            <i class="fas fa-check"></i> Marcar como leídas
                        </button>
                    </div>

                    <!-- Lista de solicitudes -->
                    <div class="application-list" id="applicationList">
                        <div class="spinner" id="loadingSpinner">
                            <div class="spinner-icon"></div>
                            <p style="margin-top: 1rem; color: var(--text-light);">Cargando solicitudes...</p>
                        </div>
                    </div>
                </div>

                <!-- Instrucciones -->
                <div class="card" style="background: rgba(26, 188, 156, 0.1); border: 1px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Información importante
                    </h4>
                    <ul style="padding-left: 1.5rem; color: var(--text-light); font-size: 0.9rem;">
                        <li style="margin-bottom: 0.5rem;">Solo ves las solicitudes dirigidas a <strong id="currentUserName">TU usuario</strong></li>
                        <li style="margin-bottom: 0.5rem;">Las solicitudes se actualizan automáticamente en tiempo real</li>
                        <li style="margin-bottom: 0.5rem;">Recibirás una notificación sonora cuando llegue una nueva solicitud</li>
                        <li>Los números RTM son únicos e irrepetibles</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Control de sonido flotante -->
    <div class="sound-control" id="soundControl">
        <button class="sound-btn" id="soundToggle">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>

    <!-- Footer fijo para móviles -->
    <footer class="app-footer">
        <div class="footer-info">
            <p>© 2024 Sistema de Préstamos - Notificaciones en tiempo real</p>
        </div>
    </footer>

    <!-- Audio para notificaciones -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            onSnapshot,
            updateDoc,
            doc,
            getDocs,
            getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
            authDomain: "inventario-35d6b.firebaseapp.com",
            databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
            projectId: "inventario-35d6b",
            storageBucket: "inventario-35d6b.appspot.com",
            messagingSenderId: "266100399659",
            appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let currentUser = null;
        let applications = [];
        let filteredApplications = [];
        let unreadCount = 0;
        let soundEnabled = true;
        let unsubscribe = null;
        let sessionTimeout = null;
        let currentModal = null;

        // Inicializar - Verificar usuario logueado
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Verificando usuario logueado...");
            
            // Intentar obtener usuario de localStorage
            try {
                const savedUser = localStorage.getItem('loanSystemUser');
                
                if (!savedUser) {
                    console.log("No hay usuario en localStorage");
                    showNoUserSection();
                    return;
                }
                
                currentUser = JSON.parse(savedUser);
                console.log("Usuario encontrado en localStorage:", currentUser);
                
                // Verificar que el usuario exista en Firebase
                if (currentUser && currentUser.id) {
                    try {
                        const userDocRef = doc(db, "users", currentUser.id);
                        const userDocSnap = await getDoc(userDocRef);
                        
                        if (userDocSnap.exists()) {
                            // Actualizar datos del usuario desde Firebase
                            const userData = userDocSnap.data();
                            currentUser.name = userData.name || userData.username || currentUser.name || 'Usuario';
                            currentUser.email = userData.email || currentUser.email || '';
                            currentUser.phone = userData.phone || currentUser.phone || '';
                            currentUser.username = userData.username || currentUser.username || '';
                            
                            // Actualizar localStorage
                            localStorage.setItem('loanSystemUser', JSON.stringify(currentUser));
                            
                            console.log("Usuario verificado en Firebase:", currentUser);
                            startSession();
                        } else {
                            console.log("Usuario no existe en Firebase");
                            localStorage.removeItem('loanSystemUser');
                            currentUser = null;
                            showNoUserSection();
                        }
                    } catch (firebaseError) {
                        console.error("Error verificando usuario en Firebase:", firebaseError);
                        // Si hay error en Firebase, usar los datos de localStorage
                        startSession();
                    }
                } else {
                    console.log("Usuario en localStorage no tiene ID válido");
                    localStorage.removeItem('loanSystemUser');
                    showNoUserSection();
                }
                
            } catch (error) {
                console.error("Error al cargar usuario de localStorage:", error);
                localStorage.removeItem('loanSystemUser');
                showNoUserSection();
            }
        });

        // Mostrar sección cuando NO hay usuario
        function showNoUserSection() {
            console.log("Mostrando sección 'no hay usuario'");
            document.getElementById('noUserSection').style.display = 'block';
            document.getElementById('requestsSection').style.display = 'none';
            document.getElementById('notificationBell').style.display = 'none';
            document.getElementById('soundControl').classList.remove('active');
        }

        // Mostrar sección cuando SÍ hay usuario
        function showRequestsSection() {
            console.log("Mostrando sección de solicitudes");
            document.getElementById('noUserSection').style.display = 'none';
            document.getElementById('requestsSection').style.display = 'block';
            document.getElementById('notificationBell').style.display = 'block';
            document.getElementById('soundControl').classList.add('active');
        }

        // Redirigir a index.html
        function redirectToIndex() {
            window.location.href = 'index.html';
        }

        // Iniciar sesión (cuando hay usuario)
        function startSession() {
            if (!currentUser) {
                console.error("No hay usuario para iniciar sesión");
                showNoUserSection();
                return;
            }
            
            console.log("Iniciando sesión para:", currentUser.email);
            
            // Mostrar sección de solicitudes
            showRequestsSection();
            
            // Actualizar información del usuario
            updateUserPanel();
            
            // Actualizar nombre en instrucciones
            document.getElementById('currentUserName').textContent = currentUser.name || currentUser.email.split('@')[0] || 'TU usuario';
            
            // Cargar solicitudes en tiempo real
            loadApplicationsRealtime();
            
            // Configurar controles
            setupUI();
            setupFilters();
            
            // Configurar actualización de tiempo
            updateLastUpdateTime();
            setInterval(updateLastUpdateTime, 1000);
            
            // Configurar timeout de sesión (8 horas)
            if (sessionTimeout) clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                showNotification("Tu sesión ha expirado, por favor inicia sesión nuevamente", "warning");
                logout();
            }, 8 * 60 * 60 * 1000);
        }

        // Cerrar sesión
        function logout() {
            console.log("Cerrando sesión...");
            
            // Detener listener actual
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            
            // Limpiar datos
            currentUser = null;
            applications = [];
            filteredApplications = [];
            unreadCount = 0;
            
            // Cerrar modal si está abierto
            closeModal();
            
            // Limpiar localStorage
            localStorage.removeItem('loanSystemUser');
            
            // Limpiar timeout de sesión
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
                sessionTimeout = null;
            }
            
            // Mostrar sección de "no hay usuario"
            showNoUserSection();
            
            // Mostrar mensaje
            showNotification("Sesión cerrada correctamente", "success");
        }

        // Actualizar panel de usuario
        function updateUserPanel() {
            if (!currentUser) return;
            
            // Nombre y email
            const userName = currentUser.name || currentUser.email.split('@')[0] || 'Usuario';
            const userEmail = currentUser.email || 'Sin email';
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = userEmail;
            
            // Avatar con iniciales
            const avatar = document.getElementById('userAvatar');
            const initials = getInitials(userName);
            avatar.textContent = initials;
            
            // Color del avatar basado en el email
            const colors = ['#1abc9c', '#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#2ecc71'];
            const colorIndex = Math.abs(hashCode(userEmail || currentUser.id)) % colors.length;
            avatar.style.background = `linear-gradient(135deg, ${colors[colorIndex]}, ${darkenColor(colors[colorIndex], 20)})`;
        }

        // Configurar controles de interfaz
        function setupUI() {
            // Control de sonido
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                soundToggle.addEventListener('click', toggleSound);
            }
            
            // Icono de notificación
            const notificationBell = document.getElementById('notificationBell');
            if (notificationBell) {
                notificationBell.addEventListener('click', () => {
                    markAllAsRead();
                });
            }
            
            // Actualizar estado inicial del sonido
            updateSoundButton();
        }

        // Configurar filtros
        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remover clase active de todos
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Agregar clase active al botón clickeado
                    button.classList.add('active');
                    
                    // Filtrar aplicaciones
                    const filter = button.getAttribute('data-filter');
                    filterApplications(filter);
                });
            });
        }

        // Cargar aplicaciones en tiempo real usando onSnapshot
        async function loadApplicationsRealtime() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error("No hay usuario identificado");
                    showNoUserSection();
                    return;
                }
                
                console.log("Escuchando solicitudes para el usuario:", currentUser.id, currentUser.email);
                
                // Intentar diferentes formas de buscar las solicitudes
                const applicationsRef = collection(db, "LoanApplications");
                
                // Primero intentar consultas específicas
                const queryAttempts = [
                    query(applicationsRef, where("userId", "==", currentUser.id)),
                    query(applicationsRef, where("targetUserId", "==", currentUser.id)),
                    query(applicationsRef, where("assignedTo", "==", currentUser.id)),
                    query(applicationsRef, where("assignedToEmail", "==", currentUser.email)),
                    query(applicationsRef, where("userEmail", "==", currentUser.email))
                ];
                
                let querySuccess = false;
                
                for (let i = 0; i < queryAttempts.length; i++) {
                    try {
                        console.log(`Intentando consulta ${i + 1}...`);
                        
                        unsubscribe = onSnapshot(queryAttempts[i], (snapshot) => {
                            handleApplicationsSnapshot(snapshot);
                        }, (error) => {
                            console.log(`Consulta ${i + 1} falló:`, error.message);
                            
                            // Si esta no funciona y es la última, intentar cargar todas
                            if (i === queryAttempts.length - 1) {
                                console.log("Intentando cargar todas las solicitudes...");
                                const allQuery = query(applicationsRef);
                                
                                unsubscribe = onSnapshot(allQuery, (allSnapshot) => {
                                    // Filtrar manualmente las que son para este usuario
                                    const userApplications = [];
                                    allSnapshot.forEach((doc) => {
                                        const data = doc.data();
                                        
                                        // Verificar si es para este usuario
                                        if (data.userId === currentUser.id || 
                                            data.targetUserId === currentUser.id ||
                                            data.assignedTo === currentUser.id ||
                                            data.assignedToEmail === currentUser.email ||
                                            data.userEmail === currentUser.email) {
                                            userApplications.push({
                                                id: doc.id,
                                                ...data
                                            });
                                        }
                                    });
                                    
                                    // Crear snapshot simulado
                                    const simulatedSnapshot = {
                                        docs: userApplications.map(app => ({
                                            id: app.id,
                                            data: () => {
                                                const { id, ...data } = app;
                                                return data;
                                            }
                                        })),
                                        empty: userApplications.length === 0,
                                        forEach: (callback) => {
                                            userApplications.forEach((app, index) => {
                                                callback({
                                                    id: app.id,
                                                    data: () => {
                                                        const { id, ...data } = app;
                                                        return data;
                                                    }
                                                }, index);
                                            });
                                        }
                                    };
                                    
                                    handleApplicationsSnapshot(simulatedSnapshot);
                                }, (allError) => {
                                    console.error("Error cargando todas las solicitudes:", allError);
                                    handleSnapshotError(allError);
                                });
                            }
                        });
                        
                        querySuccess = true;
                        console.log(`Consulta ${i + 1} configurada exitosamente`);
                        break;
                        
                    } catch (queryError) {
                        console.log(`Consulta ${i + 1} generó error:`, queryError.message);
                        continue;
                    }
                }
                
                if (!querySuccess) {
                    console.log("Todas las consultas fallaron");
                    showEmptyState();
                }
                
            } catch (error) {
                console.error("Error al configurar listener en tiempo real:", error);
                handleSnapshotError(error);
            }
        }

        // Manejar snapshot de aplicaciones
        function handleApplicationsSnapshot(snapshot) {
            try {
                console.log(`Datos recibidos: ${snapshot.docs ? snapshot.docs.length : 0} documentos`);
                
                // Ocultar spinner de carga
                const loadingSpinner = document.getElementById('loadingSpinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
                
                const newApplications = [];
                const oldAppIds = applications.map(app => app.id);
                
                // Procesar documentos
                if (snapshot.forEach) {
                    snapshot.forEach((doc) => {
                        try {
                            let data, id;
                            
                            if (typeof doc.data === 'function') {
                                data = doc.data();
                                id = doc.id;
                            } else {
                                // Si ya es un objeto plano
                                data = doc;
                                id = doc.id;
                            }
                            
                            if (data) {
                                // Generar RTM único si no existe
                                if (!data.rtmNumber || data.rtmNumber === 'RTM-00000000') {
                                    data.rtmNumber = generateUniqueRTM();
                                }
                                
                                newApplications.push({
                                    id: id || generateUniqueId(),
                                    ...data
                                });
                            }
                        } catch (docError) {
                            console.error("Error procesando documento:", docError);
                        }
                    });
                }
                
                // Detectar nuevas solicitudes
                const newApps = newApplications.filter(app => !oldAppIds.includes(app.id));
                
                // Marcar nuevas solicitudes como no leídas
                newApps.forEach(app => {
                    app.isNew = true;
                    app.isRead = false;
                    handleNewApplication(app);
                });
                
                // Actualizar lista completa
                applications = newApplications;
                
                // Ordenar por fecha (más recientes primero)
                applications.sort((a, b) => {
                    try {
                        let dateA = getDateFromApplication(a);
                        let dateB = getDateFromApplication(b);
                        return dateB - dateA;
                    } catch (error) {
                        return 0;
                    }
                });
                
                // Actualizar UI
                updateCounters();
                const activeFilter = document.querySelector('.filter-btn.active');
                if (activeFilter) {
                    filterApplications(activeFilter.getAttribute('data-filter'));
                } else {
                    filterApplications('all');
                }
                
                // Mostrar estado vacío si no hay aplicaciones
                if (applications.length === 0) {
                    showEmptyState();
                }
                
                // Mostrar alerta si hay nuevas solicitudes
                if (unreadCount > 0) {
                    document.getElementById('newRequestsAlert').classList.add('show');
                } else {
                    document.getElementById('newRequestsAlert').classList.remove('show');
                }
                
            } catch (error) {
                console.error("Error en handleApplicationsSnapshot:", error);
            }
        }

        // Obtener fecha de una aplicación
        function getDateFromApplication(app) {
            if (app.applicationDate && app.applicationDate.toDate) {
                return app.applicationDate.toDate();
            } else if (app.applicationDate) {
                return new Date(app.applicationDate);
            } else if (app.createdAt) {
                return new Date(app.createdAt);
            } else if (app.timestamp) {
                return new Date(app.timestamp);
            } else {
                return new Date(0);
            }
        }

        // Manejar error en snapshot
        function handleSnapshotError(error) {
            console.error("Error en listener:", error);
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.innerHTML = `
                    <div style="color: var(--danger-color); text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Error al cargar solicitudes</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--text-light);">
                            ${error.message || 'Error desconocido'}
                        </p>
                        <button class="btn" onclick="location.reload()" style="margin-top: 1rem;">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Mostrar estado vacío
        function showEmptyState() {
            const applicationList = document.getElementById('applicationList');
            if (applicationList) {
                applicationList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h3>No hay solicitudes aún</h3>
                        <p>No has recibido solicitudes de préstamo todavía.</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem; color: var(--primary-color);">
                            <i class="fas fa-info-circle"></i> Las solicitudes aparecerán aquí cuando alguien te envíe una.
                        </p>
                    </div>
                `;
            }
        }

        // Manejar nueva solicitud
        function handleNewApplication(application) {
            // Incrementar contador de no leídas
            unreadCount++;
            
            // Mostrar notificación visual
            const applicantName = application.applicantName || 'Un solicitante';
            const rtmNumber = application.rtmNumber || generateUniqueRTM();
            showNotification(`Nueva solicitud de ${applicantName} - ${rtmNumber}`);
            
            // Reproducir sonido si está habilitado
            if (soundEnabled) {
                playNotificationSound();
            }
            
            // Vibración si está disponible (para móviles)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        // Generar ID único
        function generateUniqueId() {
            return 'app_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Generar RTM único
        function generateUniqueRTM() {
            const timestamp = Date.now().toString();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            // Usar últimos 4 dígitos del timestamp + random
            const uniquePart = (timestamp.slice(-4) + random).padStart(8, '0');
            return `RTM-${uniquePart}`;
        }

        // Filtrar aplicaciones por estado
        function filterApplications(filterType) {
            let filtered = [];
            
            switch(filterType) {
                case 'all':
                    filtered = [...applications];
                    break;
                case 'pending':
                    filtered = applications.filter(app => 
                        (app.status || '').toLowerCase().includes('pendiente'));
                    break;
                case 'approved':
                    filtered = applications.filter(app => 
                        (app.status || '').toLowerCase().includes('aprob'));
                    break;
                case 'rejected':
                    filtered = applications.filter(app => 
                        (app.status || '').toLowerCase().includes('rechaz'));
                    break;
                default:
                    filtered = [...applications];
            }
            
            filteredApplications = filtered;
            renderApplications();
        }

        // Renderizar aplicaciones en la lista
        function renderApplications() {
            const applicationList = document.getElementById('applicationList');
            if (!applicationList) return;
            
            if (filteredApplications.length === 0) {
                const activeFilter = document.querySelector('.filter-btn.active');
                const filterType = activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
                
                let message = '';
                let icon = 'fas fa-inbox';
                
                switch(filterType) {
                    case 'all':
                        message = 'No tienes solicitudes de préstamo.';
                        icon = 'fas fa-inbox';
                        break;
                    case 'pending':
                        message = 'No tienes solicitudes pendientes.';
                        icon = 'fas fa-clock';
                        break;
                    case 'approved':
                        message = 'No tienes solicitudes aprobadas.';
                        icon = 'fas fa-check-circle';
                        break;
                    case 'rejected':
                        message = 'No tienes solicitudes rechazadas.';
                        icon = 'fas fa-times-circle';
                        break;
                }
                
                applicationList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="${icon}"></i>
                        </div>
                        <h3>No hay solicitudes ${getFilterText()}</h3>
                        <p>${message}</p>
                        ${filterType !== 'all' ? 
                            `<button class="btn" onclick="document.querySelector('[data-filter=\"all\"]').click()" style="margin-top: 1rem;">
                                <i class="fas fa-eye"></i> Ver todas las solicitudes
                            </button>` : ''
                        }
                    </div>
                `;
                return;
            }
            
            applicationList.innerHTML = '';
            
            filteredApplications.forEach((app, index) => {
                const applicationItem = createApplicationElement(app);
                applicationList.appendChild(applicationItem);
                
                // Animación de entrada escalonada
                setTimeout(() => {
                    if (applicationItem.classList) {
                        applicationItem.classList.add('fade-in');
                    }
                }, index * 50);
            });
        }

        // Crear elemento de aplicación CON TODOS LOS BOTONES NECESARIOS
        function createApplicationElement(app) {
            const div = document.createElement('div');
            div.className = `application-item ${getStatusClass(app.status)} ${app.isNew && !app.isRead ? 'new' : ''}`;
            div.id = `app-${app.id || generateUniqueId()}`;
            
            // Formatear fecha
            let dateString = 'Fecha no disponible';
            try {
                const date = getDateFromApplication(app);
                if (date.getTime() > 0) {
                    dateString = date.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (error) {
                console.error("Error formateando fecha:", error);
            }
            
            // Formatear monto
            let amountFormatted = '$0';
            try {
                if (app.loanAmount) {
                    const amount = parseFloat(app.loanAmount);
                    if (!isNaN(amount)) {
                        amountFormatted = `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                }
            } catch (error) {
                console.error("Error formateando monto:", error);
            }
            
            // Determinar texto y clase del estado
            let statusText = 'Pendiente';
            let statusClass = 'status-pending';
            
            const status = (app.status || '').toLowerCase();
            if (status.includes('aprob')) {
                statusText = 'Aprobado';
                statusClass = 'status-approved';
            } else if (status.includes('rechaz')) {
                statusText = 'Rechazado';
                statusClass = 'status-rejected';
            }
            
            // Generar RTM único
            let rtmNumber = app.rtmNumber || generateUniqueRTM();
            
            // Escapar ID para uso en HTML
            const appId = (app.id || '').replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
            
            // Determinar estado actual para mostrar botones apropiados
            const isPending = status.includes('pendiente');
            const isApproved = status.includes('aprob');
            const isRejected = status.includes('rechaz');
            const isNew = app.isNew && !app.isRead;
            
            div.innerHTML = `
                <div class="application-header">
                    <div class="application-rtm">${rtmNumber}</div>
                    <div class="application-status ${statusClass}">${statusText}</div>
                </div>
                
                <div class="application-details">
                    <div class="detail-item">
                        <span class="detail-label">Solicitante:</span>
                        <span class="detail-value">${app.applicantName || 'No especificado'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Monto:</span>
                        <span class="detail-value">${amountFormatted}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Cédula:</span>
                        <span class="detail-value">${app.applicantCedula || 'No especificada'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Teléfono:</span>
                        <span class="detail-value">${app.applicantPhone || 'No especificado'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Tasa de interés:</span>
                        <span class="detail-value">${app.interestRate || 0}%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Plazo:</span>
                        <span class="detail-value">${getPaymentTermText(app.paymentTerm)}</span>
                    </div>
                </div>
                
                ${app.applicantEmail ? `
                <div style="margin-bottom: 0.8rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <div style="font-size: 0.85rem; color: var(--text-light);">Email del solicitante:</div>
                    <div style="font-weight: 500; word-break: break-all;">${app.applicantEmail || 'No especificado'}</div>
                </div>` : ''}
                
                <div class="application-footer">
                    <div class="application-date">
                        <i class="far fa-clock"></i> ${dateString}
                        ${isNew ? '<span class="new-badge"><i class="fas fa-star"></i> Nuevo</span>' : ''}
                    </div>
                    
                    <div class="application-actions">
                        <!-- BOTÓN PENDIENTE (solo si NO está pendiente) -->
                        ${!isPending ? `
                            <button class="btn btn-secondary btn-sm" onclick="updateApplicationStatus('${appId}', 'pending')" title="Marcar como pendiente">
                                <i class="fas fa-clock"></i> Pendiente
                            </button>
                        ` : ''}
                        
                        <!-- BOTÓN APROBAR (solo si NO está aprobado) -->
                        ${!isApproved ? `
                            <button class="btn btn-success btn-sm" onclick="updateApplicationStatus('${appId}', 'approved')" title="Aprobar solicitud">
                                <i class="fas fa-check"></i> Aprobar
                            </button>
                        ` : ''}
                        
                        <!-- BOTÓN RECHAZAR (solo si NO está rechazado) -->
                        ${!isRejected ? `
                            <button class="btn btn-danger btn-sm" onclick="updateApplicationStatus('${appId}', 'rejected')" title="Rechazar solicitud">
                                <i class="fas fa-times"></i> Rechazar
                            </button>
                        ` : ''}
                        
                        <!-- BOTÓN VER DETALLES (siempre visible) -->
                        <button class="btn btn-info btn-sm" onclick="viewApplicationDetails('${appId}')" title="Ver detalles completos">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        
                        <!-- BOTÓN MARCAR COMO LEÍDO (solo si es nueva) -->
                        ${isNew ? `
                            <button class="btn btn-warning btn-sm" onclick="markAsRead('${appId}')" title="Marcar como leída">
                                <i class="fas fa-check-double"></i> Leído
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return div;
        }

        // Obtener clase CSS para el estado
        function getStatusClass(status) {
            const statusLower = (status || '').toLowerCase();
            if (statusLower.includes('aprob')) return 'approved';
            if (statusLower.includes('rechaz')) return 'rejected';
            if (statusLower.includes('pendiente')) return 'pending';
            return 'pending';
        }

        // Actualizar estado de una aplicación - TODOS LOS ESTADOS DISPONIBLES
        async function updateApplicationStatus(applicationId, newStatus) {
            try {
                if (!currentUser) {
                    showNotification("Debes iniciar sesión para realizar esta acción", "warning");
                    return;
                }
                
                const applicationRef = doc(db, "LoanApplications", applicationId);
                let statusText = '';
                let notificationMessage = '';
                let notificationType = 'success';
                
                // Determinar texto del estado y mensaje de notificación
                switch(newStatus) {
                    case 'pending':
                        statusText = 'Pendiente';
                        notificationMessage = 'Solicitud marcada como pendiente';
                        break;
                    case 'approved':
                        statusText = 'Aprobado';
                        notificationMessage = 'Solicitud aprobada correctamente';
                        break;
                    case 'rejected':
                        statusText = 'Rechazado';
                        notificationMessage = 'Solicitud rechazada correctamente';
                        break;
                    default:
                        statusText = 'Pendiente';
                        notificationMessage = 'Estado actualizado';
                }
                
                const updateData = {
                    status: statusText,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.id,
                    updatedByName: currentUser.name || currentUser.email
                };
                
                await updateDoc(applicationRef, updateData);
                
                console.log(`Estado actualizado a ${statusText} para aplicación ${applicationId}`);
                
                // Mostrar mensaje de confirmación
                showNotification(notificationMessage, notificationType);
                
                // Cerrar modal si está abierto
                closeModal();
                
                // Si era nueva y se cambió el estado, marcarla como leída
                const appIndex = applications.findIndex(app => app.id === applicationId);
                if (appIndex >= 0) {
                    applications[appIndex].isRead = true;
                    applications[appIndex].isNew = false;
                    
                    // Actualizar contador de no leídas
                    unreadCount = Math.max(0, unreadCount - 1);
                    updateCounters();
                    
                    // Si no hay más solicitudes nuevas, ocultar alerta
                    if (unreadCount === 0) {
                        document.getElementById('newRequestsAlert').classList.remove('show');
                    }
                }
                
            } catch (error) {
                console.error("Error actualizando estado:", error);
                showNotification("Error al actualizar el estado: " + error.message, "danger");
            }
        }

        // Marcar solicitud como leída
        function markAsRead(applicationId) {
            try {
                const appElement = document.getElementById(`app-${applicationId}`);
                if (appElement) {
                    appElement.classList.remove('new');
                    
                    // Actualizar en memoria
                    const appIndex = applications.findIndex(app => app.id === applicationId);
                    if (appIndex >= 0) {
                        applications[appIndex].isRead = true;
                        applications[appIndex].isNew = false;
                    }
                    
                    // Actualizar contadores
                    unreadCount = Math.max(0, unreadCount - 1);
                    updateCounters();
                    
                    // Si no hay más solicitudes nuevas, ocultar alerta
                    if (unreadCount === 0) {
                        document.getElementById('newRequestsAlert').classList.remove('show');
                    }
                    
                    // Mostrar notificación
                    showNotification("Solicitud marcada como leída", "success");
                }
            } catch (error) {
                console.error("Error marcando como leída:", error);
            }
        }

        // Marcar todas como leídas
        function markAllAsRead() {
            try {
                applications.forEach(app => {
                    if (app.isNew && !app.isRead) {
                        app.isRead = true;
                        app.isNew = false;
                        
                        const appElement = document.getElementById(`app-${app.id}`);
                        if (appElement) {
                            appElement.classList.remove('new');
                        }
                    }
                });
                
                unreadCount = 0;
                updateCounters();
                document.getElementById('newRequestsAlert').classList.remove('show');
                
                // Parar sonido de notificación si está sonando
                stopNotificationSound();
                
                // Mostrar confirmación
                showNotification("Todas las solicitudes marcadas como leídas", "success");
                
            } catch (error) {
                console.error("Error marcando todas como leídas:", error);
            }
        }

        // Ver detalles de aplicación
        function viewApplicationDetails(applicationId) {
            try {
                const application = applications.find(app => app.id === applicationId);
                if (!application) {
                    showNotification("No se encontró la solicitud", "warning");
                    return;
                }
                
                // Marcar como leída al abrir detalles
                markAsRead(applicationId);
                
                // Generar RTM único
                let rtmNumber = application.rtmNumber || generateUniqueRTM();
                
                // Formatear monto
                let amountFormatted = '$0';
                if (application.loanAmount) {
                    const amount = parseFloat(application.loanAmount);
                    if (!isNaN(amount)) {
                        amountFormatted = `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                }
                
                // Determinar texto del estado
                let statusText = 'Pendiente';
                const status = (application.status || '').toLowerCase();
                if (status.includes('aprob')) {
                    statusText = 'Aprobado';
                } else if (status.includes('rechaz')) {
                    statusText = 'Rechazado';
                }
                
                // Determinar estado actual para mostrar botones apropiados en modal
                const isPending = status.includes('pendiente');
                const isApproved = status.includes('aprob');
                const isRejected = status.includes('rechaz');
                
                // Escapar ID para HTML
                const appId = applicationId.replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
                
                // Crear modal de detalles con TODOS LOS BOTONES
                const modalHTML = `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">
                                    <i class="fas fa-file-alt"></i> Detalles de Solicitud
                                </h3>
                                <button class="modal-close" onclick="closeModal()">&times;</button>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary-color); font-family: monospace; margin-bottom: 0.5rem;">
                                    ${rtmNumber}
                                </div>
                                <div class="application-status ${statusText === 'Aprobado' ? 'status-approved' : statusText === 'Rechazado' ? 'status-rejected' : 'status-pending'}" style="display: inline-block;">
                                    ${statusText}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 0.8rem; font-size: 1rem;">
                                        <i class="fas fa-user"></i> Información del Solicitante
                                    </h4>
                                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem;">
                                        <div style="margin-bottom: 0.5rem;"><strong>Nombre:</strong> ${application.applicantName || 'No especificado'}</div>
                                        <div style="margin-bottom: 0.5rem;"><strong>Cédula:</strong> ${application.applicantCedula || 'No especificada'}</div>
                                        <div style="margin-bottom: 0.5rem;"><strong>Teléfono:</strong> ${application.applicantPhone || 'No especificado'}</div>
                                        <div><strong>Email:</strong> ${application.applicantEmail || 'No especificado'}</div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 0.8rem; font-size: 1rem;">
                                        <i class="fas fa-money-bill-wave"></i> Detalles del Préstamo
                                    </h4>
                                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                            <div><strong>Monto:</strong> ${amountFormatted}</div>
                                            <div><strong>Tasa de interés:</strong> ${application.interestRate || 0}%</div>
                                            <div><strong>Plazo:</strong> ${getPaymentTermText(application.paymentTerm)}</div>
                                            <div><strong>Total a pagar:</strong> $${application.totalPayment ? parseFloat(application.totalPayment).toFixed(2) : '0.00'}</div>
                                            <div><strong>Pago por período:</strong> $${application.paymentPerTerm ? parseFloat(application.paymentPerTerm).toFixed(2) : '0.00'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${application.companyName || application.employmentTime ? `
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 0.8rem; font-size: 1rem;">
                                        <i class="fas fa-briefcase"></i> Situación Laboral
                                    </h4>
                                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem;">
                                        ${application.companyName ? `<div style="margin-bottom: 0.5rem;"><strong>Empresa:</strong> ${application.companyName}</div>` : ''}
                                        ${application.employmentTime ? `<div><strong>Tiempo laborando:</strong> ${getEmploymentTimeText(application.employmentTime)}</div>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 0.8rem; font-size: 1rem;">
                                        <i class="fas fa-calendar-alt"></i> Información de la Solicitud
                                    </h4>
                                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem;">
                                        <div style="margin-bottom: 0.5rem;"><strong>Fecha de solicitud:</strong> ${application.applicationDateString || 'No especificada'}</div>
                                        <div style="margin-bottom: 0.5rem;"><strong>Fuente de referencia:</strong> ${getReferralSourceText(application.referralSource)}</div>
                                        ${application.otherSource ? `<div><strong>Otra fuente:</strong> ${application.otherSource}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                                <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1rem;">
                                    <i class="fas fa-cogs"></i> Cambiar Estado
                                </h4>
                                <div class="action-buttons-container">
                                    <!-- Botón Pendiente (si no está pendiente) -->
                                    ${!isPending ? `
                                        <button class="btn btn-secondary action-button" onclick="updateApplicationStatus('${appId}', 'pending'); closeModal();">
                                            <i class="fas fa-clock"></i> Marcar como Pendiente
                                        </button>
                                    ` : ''}
                                    
                                    <!-- Botón Aprobar (si no está aprobado) -->
                                    ${!isApproved ? `
                                        <button class="btn btn-success action-button" onclick="updateApplicationStatus('${appId}', 'approved'); closeModal();">
                                            <i class="fas fa-check"></i> Aprobar Solicitud
                                        </button>
                                    ` : ''}
                                    
                                    <!-- Botón Rechazar (si no está rechazado) -->
                                    ${!isRejected ? `
                                        <button class="btn btn-danger action-button" onclick="updateApplicationStatus('${appId}', 'rejected'); closeModal();">
                                            <i class="fas fa-times"></i> Rechazar Solicitud
                                        </button>
                                    ` : ''}
                                </div>
                                
                                <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                                    <button onclick="closeModal()" class="btn" style="background: rgba(255,255,255,0.1);">
                                        <i class="fas fa-times"></i> Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal anterior si existe
                closeModal();
                
                // Agregar nuevo modal
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer.firstElementChild);
                currentModal = modalContainer.firstElementChild;
                
            } catch (error) {
                console.error("Error mostrando detalles:", error);
                showNotification("Error al mostrar detalles: " + error.message, "danger");
            }
        }

        // Cerrar modal
        function closeModal() {
            try {
                if (currentModal && currentModal.parentNode) {
                    currentModal.parentNode.removeChild(currentModal);
                    currentModal = null;
                }
                
                // También buscar y eliminar cualquier modal existente
                const existingModals = document.querySelectorAll('.modal-overlay');
                existingModals.forEach(modal => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                });
            } catch (error) {
                console.error("Error cerrando modal:", error);
            }
        }

        // Actualizar contadores
        function updateCounters() {
            try {
                // Contador total
                const appCountElement = document.getElementById('applicationCount');
                if (appCountElement) {
                    appCountElement.textContent = 
                        `${applications.length} solicitud${applications.length !== 1 ? 'es' : ''}`;
                }
                
                // Contador de notificaciones
                const notificationCount = document.getElementById('notificationCount');
                if (notificationCount) {
                    if (unreadCount > 0) {
                        notificationCount.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        notificationCount.classList.add('active');
                    } else {
                        notificationCount.classList.remove('active');
                    }
                }
                
                // Contador de nuevas solicitudes en la alerta
                const newRequestsCount = document.getElementById('newRequestsCount');
                if (newRequestsCount) {
                    newRequestsCount.textContent = unreadCount;
                }
                
            } catch (error) {
                console.error("Error actualizando contadores:", error);
            }
        }

        // Mostrar notificación temporal
        function showNotification(message, type = 'info') {
            try {
                const notification = document.getElementById('newNotification');
                const messageElement = document.getElementById('notificationMessage');
                
                if (!notification || !messageElement) return;
                
                messageElement.textContent = message;
                
                // Cambiar color según tipo
                if (type === 'success') {
                    notification.style.background = 'var(--success-color)';
                } else if (type === 'warning') {
                    notification.style.background = 'var(--warning-color)';
                } else if (type === 'danger') {
                    notification.style.background = 'var(--danger-color)';
                } else {
                    notification.style.background = 'var(--info-color)';
                }
                
                notification.style.display = 'flex';
                notification.style.alignItems = 'center';
                notification.style.gap = '0.5rem';
                
                // Ocultar después de 5 segundos
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error("Error mostrando notificación:", error);
            }
        }

        // Reproducir sonido de notificación
        function playNotificationSound() {
            try {
                const sound = document.getElementById('notificationSound');
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log("Error reproduciendo sonido:", e));
                }
            } catch (error) {
                console.error("Error reproduciendo sonido:", error);
            }
        }

        // Detener sonido de notificación
        function stopNotificationSound() {
            try {
                const sound = document.getElementById('notificationSound');
                if (sound) {
                    sound.pause();
                    sound.currentTime = 0;
                }
            } catch (error) {
                console.error("Error deteniendo sonido:", error);
            }
        }

        // Alternar sonido
        function toggleSound() {
            try {
                soundEnabled = !soundEnabled;
                updateSoundButton();
                
                // Mostrar notificación
                showNotification(
                    soundEnabled ? 'Notificaciones de sonido activadas' : 'Notificaciones de sonido desactivadas',
                    soundEnabled ? 'success' : 'warning'
                );
            } catch (error) {
                console.error("Error alternando sonido:", error);
            }
        }

        // Actualizar botón de sonido
        function updateSoundButton() {
            try {
                const button = document.getElementById('soundToggle');
                if (!button) return;
                
                const icon = button.querySelector('i');
                if (!icon) return;
                
                if (soundEnabled) {
                    button.classList.remove('muted');
                    icon.className = 'fas fa-volume-up';
                } else {
                    button.classList.add('muted');
                    icon.className = 'fas fa-volume-mute';
                }
            } catch (error) {
                console.error("Error actualizando botón de sonido:", error);
            }
        }

        // Actualizar tiempo de última actualización
        function updateLastUpdateTime() {
            try {
                const element = document.getElementById('lastUpdate');
                if (element) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    element.textContent = timeString;
                }
            } catch (error) {
                console.error("Error actualizando tiempo:", error);
            }
        }

        // Funciones auxiliares
        function getInitials(name) {
            if (!name) return 'U';
            return name
                .split(' ')
                .map(part => part.charAt(0))
                .join('')
                .toUpperCase()
                .substring(0, 2);
        }

        function hashCode(str) {
            if (!str) return 0;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash;
        }

        function darkenColor(color, percent) {
            if (!color) return '#1abc9c';
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function getPaymentTermText(term) {
            const terms = {
                'daily': 'Diario',
                'weekly': 'Semanal',
                'biweekly': 'Quincenal',
                'monthly': 'Mensual',
                'Diario': 'Diario',
                'Semanal': 'Semanal',
                'Quincenal': 'Quincenal',
                'Mensual': 'Mensual',
                'diario': 'Diario',
                'semanal': 'Semanal',
                'quincenal': 'Quincenal',
                'mensual': 'Mensual'
            };
            return terms[term] || term || 'No especificado';
        }

        function getEmploymentTimeText(time) {
            const times = {
                'less_than_6': 'Menos de 6 meses',
                '6_to_12': '6 a 12 meses',
                '1_to_3': '1 a 3 años',
                '3_to_5': '3 a 5 años',
                'more_than_5': 'Más de 5 años',
                'Menos de 6 meses': 'Menos de 6 meses',
                '6 a 12 meses': '6 a 12 meses',
                '1 a 3 años': '1 a 3 años',
                '3 a 5 años': '3 a 5 años',
                'Más de 5 años': 'Más de 5 años',
                'menos de 6 meses': 'Menos de 6 meses',
                '6 a 12 meses': '6 a 12 meses',
                '1 a 3 años': '1 a 3 años',
                '3 a 5 años': '3 a 5 años',
                'más de 5 años': 'Más de 5 años'
            };
            return times[time] || time || 'No especificado';
        }

        function getReferralSourceText(source) {
            const sources = {
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'whatsapp': 'WhatsApp',
                'friend': 'Amigo/Conocido',
                'web': 'Página Web',
                'email': 'Correo Electrónico',
                'other': 'Otro',
                'Facebook': 'Facebook',
                'Instagram': 'Instagram',
                'WhatsApp': 'WhatsApp',
                'Amigo/Conocido': 'Amigo/Conocido',
                'Página Web': 'Página Web',
                'Correo Electrónico': 'Correo Electrónico',
                'Otro': 'Otro',
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'whatsapp': 'WhatsApp',
                'friend': 'Amigo/Conocido',
                'web': 'Página Web',
                'email': 'Correo Electrónico',
                'other': 'Otro'
            };
            return sources[source] || source || 'No especificada';
        }

        function getFilterText() {
            const activeFilter = document.querySelector('.filter-btn.active');
            if (!activeFilter) return '';
            
            const filter = activeFilter.getAttribute('data-filter');
            const filters = {
                'all': '',
                'pending': 'pendientes',
                'approved': 'aprobadas',
                'rejected': 'rechazadas'
            };
            return filters[filter];
        }

        // Hacer funciones globales para los event listeners
        window.updateApplicationStatus = updateApplicationStatus;
        window.viewApplicationDetails = viewApplicationDetails;
        window.markAsRead = markAsRead;
        window.markAllAsRead = markAllAsRead;
        window.closeModal = closeModal;
        window.toggleSound = toggleSound;
        window.logout = logout;
        window.redirectToIndex = redirectToIndex;
    </script>
</body>
</html>
