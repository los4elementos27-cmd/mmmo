<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Punto de Venta Móvil</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
/* ============================================
   DISEÑO FUTURISTA Y ELEGANTE - SIN AFECTAR FUNCIONES
   MANTIENDO TODAS LAS CLASES Y IDs ORIGINALES
   ============================================ */

/* RESET Y CONFIGURACIÓN INICIAL */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --primary: #00f2fe;
  --primary-dark: #00c6fe;
  --secondary: #667eea;
  --secondary-dark: #764ba2;
  --success: #43e97b;
  --danger: #f5576c;
  --warning: #fa709a;
  --dark-bg: #0a0a14;
  --darker-bg: #050510;
  --card-bg: rgba(20, 25, 45, 0.9);
  --glass-bg: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.15);
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.8);
  --text-muted: rgba(255, 255, 255, 0.6);
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, var(--dark-bg), var(--darker-bg));
  color: var(--text-primary);
  margin: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
  font-size: 14px;
  line-height: 1.4;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%);
}

/* ============================================
   CONTENEDOR PRINCIPAL - DISEÑO FUTURISTA
   ============================================ */
.mobile-container {
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--darker-bg);
  backdrop-filter: blur(20px);
  position: relative;
  overflow: hidden;
  animation: fadeIn 0.5s ease;
  border: 1px solid var(--glass-border);
}

@media (min-width: 769px) {
  .mobile-container {
    max-width: 98%;
    height: 97vh;
    margin: 1.5vh auto;
    border-radius: 24px;
    box-shadow: 
      0 25px 50px -12px rgba(0, 0, 0, 0.5),
      0 0 30px rgba(0, 242, 254, 0.1);
  }
}

@media (min-width: 1024px) {
  .mobile-container {
    max-width: 99%;
    height: 98vh;
  }
}

@media (min-width: 1440px) {
  .mobile-container {
    max-width: 1400px;
  }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   HEADER - DISEÑO FUTURISTA CON EFECTO NEÓN
   ============================================ */
.mobile-header {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.15), rgba(102, 126, 234, 0.15));
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--glass-border);
  animation: slideDown 0.3s ease;
  min-height: 70px;
}

@keyframes slideDown {
  from { transform: translateY(-100%); }
  to { transform: translateY(0); }
}

.header-left {
  display: flex;
  align-items: center;
  gap: 15px;
}

.logo-mobile {
  width: 45px;
  height: 45px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: white;
  box-shadow: 0 5px 15px rgba(0, 242, 254, 0.3);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.logo-mobile:hover {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 0 8px 25px rgba(0, 242, 254, 0.4);
}

.logo-mobile::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s;
}

.logo-mobile:hover::before {
  left: 100%;
}

.system-name-mobile {
  font-size: 20px;
  font-weight: 800;
  background: linear-gradient(45deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: 0.5px;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.header-icon {
  color: var(--text-primary);
  font-size: 18px;
  background: var(--glass-bg);
  width: 45px;
  height: 45px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  text-decoration: none;
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(10px);
}

.header-icon:hover {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  transform: translateY(-3px) scale(1.1);
  box-shadow: 0 10px 25px rgba(0, 242, 254, 0.3);
  border-color: transparent;
}

.user-avatar-mobile {
  width: 45px;
  height: 45px;
  border-radius: 12px;
  object-fit: cover;
  border: 2px solid var(--primary);
  transition: transform 0.3s ease;
  box-shadow: 0 5px 15px rgba(0, 242, 254, 0.2);
}

.user-avatar-mobile:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 25px rgba(0, 242, 254, 0.3);
}

.menu-hamburger {
  display: none;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  width: 45px;
  height: 45px;
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 20px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.menu-hamburger:hover {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  transform: rotate(90deg);
  border-color: transparent;
}

/* ============================================
   MODALES - DISEÑO FUTURISTA
   ============================================ */
.modal-mobile {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(10px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
  overflow-y: auto;
}

.modal-content-mobile {
  background: var(--card-bg);
  border-radius: 20px;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.5),
    0 0 40px rgba(0, 242, 254, 0.1);
  animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(20px);
}

@keyframes modalSlideUp {
  from {
    transform: translateY(50px) scale(0.95);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(180deg, rgba(0, 242, 254, 0.1), transparent);
  border-radius: 20px 20px 0 0;
}

.modal-header h2 {
  color: var(--primary);
  font-size: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
}

.close-modal {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  color: var(--text-primary);
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  backdrop-filter: blur(10px);
}

.close-modal:hover {
  background: linear-gradient(135deg, var(--danger), #ff6b6b);
  transform: rotate(90deg) scale(1.1);
  border-color: transparent;
}

.modal-body {
  padding: 25px;
}

/* ============================================
   LOGIN SCREEN - DISEÑO FUTURISTA
   ============================================ */
.login-container-mobile {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, var(--dark-bg), var(--darker-bg));
  padding: 20px;
  animation: fadeIn 0.6s ease;
  background-image: 
    radial-gradient(circle at 10% 20%, rgba(120, 119, 198, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 90% 80%, rgba(255, 119, 198, 0.2) 0%, transparent 50%);
}

.login-card {
  background: var(--card-bg);
  border-radius: 24px;
  padding: 40px;
  width: 100%;
  max-width: 400px;
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  text-align: center;
  animation: bounceIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(20px);
}

@keyframes bounceIn {
  0% { transform: scale(0.3); opacity: 0; }
  50% { transform: scale(1.05); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

.login-logo {
  width: 90px;
  height: 90px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 25px;
  font-size: 40px;
  color: white;
  box-shadow: 0 15px 35px rgba(0, 242, 254, 0.3);
  transition: transform 0.3s ease;
  position: relative;
  overflow: hidden;
}

.login-logo:hover {
  transform: rotate(360deg) scale(1.1);
}

.login-logo::before {
  content: '';
  position: absolute;
  inset: -5px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 25px;
  z-index: -1;
  filter: blur(20px);
  opacity: 0.5;
}

.login-title {
  font-size: 32px;
  color: var(--primary);
  margin-bottom: 10px;
  font-weight: 800;
  background: linear-gradient(45deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.login-input {
  width: 100%;
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px 20px;
  color: var(--text-primary);
  font-size: 16px;
  margin-bottom: 20px;
  outline: none;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.login-input:focus {
  border-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0, 242, 254, 0.2);
}

.login-btn {
  width: 100%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border: none;
  border-radius: 12px;
  padding: 16px;
  color: white;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.5px;
}

.login-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 35px rgba(0, 242, 254, 0.4);
}

.login-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s;
}

.login-btn:hover::before {
  left: 100%;
}

/* ============================================
   SECCIÓN DE BÚSQUEDA - DISEÑO FUTURISTA
   ============================================ */
.search-section {
  padding: 20px;
  background: var(--card-bg);
  border-bottom: 1px solid var(--glass-border);
  backdrop-filter: blur(10px);
  animation: fadeInUp 0.4s ease 0.1s both;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.search-container-mobile {
  display: flex;
  gap: 12px;
  width: 100%;
}

.search-box {
  flex: 1;
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  border-radius: 16px;
  padding: 15px 20px;
  color: var(--text-primary);
  font-size: 16px;
  outline: none;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.search-box:focus {
  border-color: var(--primary);
  box-shadow: 0 10px 25px rgba(0, 242, 254, 0.2);
  transform: translateY(-2px);
}

.search-box::placeholder {
  color: var(--text-muted);
}

.scanner-btn-mobile {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  border-radius: 16px;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 25px rgba(0, 242, 254, 0.3);
  font-size: 24px;
}

.scanner-btn-mobile:hover {
  transform: scale(1.1) rotate(10deg);
  box-shadow: 0 15px 35px rgba(0, 242, 254, 0.4);
}

/* ============================================
   SECCIÓN PRINCIPAL - DISEÑO FUTURISTA
   ============================================ */
.main-content {
  flex: 1;
  display: flex;
  overflow: hidden;
  animation: fadeIn 0.5s ease 0.1s both;
}

.products-section {
  flex: 1;
  overflow-y: auto;
  padding: 25px;
  background: var(--darker-bg);
  position: relative;
}

.products-section h2 {
  font-size: 22px;
  margin-bottom: 20px;
  color: var(--primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 700;
  background: linear-gradient(45deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: slideInLeft 0.4s ease;
}

@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}

.view-toggle-mobile {
  display: flex;
  gap: 10px;
  background: var(--glass-bg);
  padding: 8px;
  border-radius: 12px;
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
}

.view-btn {
  background: transparent;
  border: none;
  color: var(--text-muted);
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 18px;
}

.view-btn:hover {
  transform: scale(1.1);
  background: var(--glass-bg);
}

.view-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  transform: scale(1.1);
  box-shadow: 0 8px 20px rgba(0, 242, 254, 0.3);
}

/* ============================================
   PRODUCTOS - TARJETAS FUTURISTAS
   ============================================ */
.products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 20px;
  margin-top: 15px;
  animation: fadeIn 0.6s ease;
}

@media (min-width: 768px) {
  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 25px;
  }
}

@media (min-width: 1024px) {
  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 30px;
  }
}

.product-card {
  background: var(--card-bg);
  border-radius: 18px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid var(--glass-border);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.product-card:hover {
  background: rgba(30, 35, 55, 0.95);
  transform: translateY(-10px) scale(1.02);
  box-shadow: 
    0 25px 50px rgba(0, 242, 254, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  border-color: var(--primary);
}

.product-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  transform: scaleX(0);
  transition: transform 0.4s;
  transform-origin: left;
}

.product-card:hover::before {
  transform: scaleX(1);
}

.product-image {
  width: 100px;
  height: 100px;
  object-fit: contain;
  margin-bottom: 15px;
  border-radius: 12px;
  background: var(--glass-bg);
  padding: 10px;
  transition: transform 0.3s ease;
}

.product-card:hover .product-image {
  transform: scale(1.1) rotate(5deg);
}

.product-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 10px;
  color: var(--text-primary);
  line-height: 1.3;
  height: 40px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.product-price {
  color: var(--primary);
  font-weight: 800;
  font-size: 20px;
  margin-bottom: 8px;
  text-shadow: 0 2px 10px rgba(0, 242, 254, 0.3);
}

.product-ean-mobile {
  font-size: 11px;
  color: var(--text-muted);
  background: var(--glass-bg);
  padding: 6px 12px;
  border-radius: 20px;
  margin-top: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ============================================
   SECCIÓN DE FACTURA - DISEÑO FUTURISTA
   ============================================ */
.invoice-section {
  width: 100%;
  background: var(--card-bg);
  border-left: 1px solid var(--glass-border);
  display: flex;
  flex-direction: column;
  height: 100%;
  animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}

@keyframes slideInRight {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.invoice-header {
  padding: 20px;
  background: linear-gradient(180deg, rgba(0, 242, 254, 0.1), transparent);
  border-bottom: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.invoice-header h2 {
  color: var(--primary);
  font-size: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
}

.invoice-close-btn {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  width: 45px;
  height: 45px;
  border-radius: 12px;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  backdrop-filter: blur(10px);
}

.invoice-close-btn:hover {
  background: linear-gradient(135deg, var(--danger), #ff6b6b);
  transform: rotate(90deg) scale(1.1);
  border-color: transparent;
}

@media (min-width: 768px) {
  .invoice-close-btn {
    display: none;
  }
}

.invoice-items {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.invoice-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px;
  background: var(--glass-bg);
  border-radius: 14px;
  margin-bottom: 12px;
  border-left: 5px solid var(--primary);
  border: 1px solid var(--glass-border);
  animation: fadeInUp 0.3s ease;
  backdrop-filter: blur(10px);
  transition: all 0.3s;
}

.invoice-item:hover {
  transform: translateX(5px);
  border-color: var(--primary);
}

.item-info {
  flex: 1;
}

.item-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 6px;
  color: var(--text-primary);
}

.item-details {
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  gap: 12px;
}

.item-price {
  font-weight: 700;
  color: var(--primary);
  font-size: 18px;
  text-shadow: 0 2px 8px rgba(0, 242, 254, 0.2);
}

.remove-btn-mobile {
  background: linear-gradient(135deg, var(--danger), #ff6b6b);
  color: white;
  border: none;
  width: 35px;
  height: 35px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 16px;
}

.remove-btn-mobile:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 8px 20px rgba(245, 87, 108, 0.3);
}

/* ============================================
   BARRA DE TOTALES - DISEÑO FUTURISTA
   ============================================ */
.totals-bar-mobile {
  background: var(--card-bg);
  padding: 25px;
  border-top: 1px solid var(--glass-border);
  display: flex;
  flex-direction: column;
  gap: 15px;
  position: sticky;
  bottom: 0;
  box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.4s ease;
  backdrop-filter: blur(20px);
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.total-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  padding: 20px;
  border-radius: 16px;
  border: 1px solid var(--glass-border);
}

.total-label {
  font-size: 16px;
  color: var(--text-secondary);
  font-weight: 600;
}

.total-amount {
  font-size: 32px;
  font-weight: 800;
  color: var(--primary);
  text-shadow: 0 2px 15px rgba(0, 242, 254, 0.3);
  background: linear-gradient(45deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.currency-totals-mobile {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding-bottom: 10px;
}

.currency-total {
  background: var(--glass-bg);
  padding: 12px 18px;
  border-radius: 12px;
  font-size: 14px;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: transform 0.3s ease;
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(10px);
}

.currency-total:hover {
  transform: translateY(-3px);
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.15), rgba(102, 126, 234, 0.15));
  border-color: var(--primary);
}

.currency-total i {
  color: var(--primary);
}

/* ============================================
   BOTONES DE ACCIÓN - DISEÑO FUTURISTA
   ============================================ */
.action-buttons-mobile {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 15px;
}

@media (max-width: 767px) {
  .action-buttons-mobile {
    grid-template-columns: repeat(2, 1fr);
  }
}

.action-btn {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 14px;
  padding: 20px 10px;
  color: var(--text-primary);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  min-height: 100px;
  justify-content: center;
  backdrop-filter: blur(10px);
  position: relative;
  overflow: hidden;
}

.action-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.6s;
}

.action-btn:hover::before {
  left: 100%;
}

.action-btn i {
  font-size: 28px;
  margin-bottom: 5px;
  transition: transform 0.3s ease;
}

.action-btn:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
}

.action-btn:hover i {
  transform: scale(1.2) rotate(10deg);
}

.btn-discount {
  background: linear-gradient(135deg, var(--warning), #fee140);
  border: none;
}

.btn-cash {
  background: linear-gradient(135deg, var(--success), #38f9d7);
  border: none;
}

.btn-card {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border: none;
}

.btn-invoice {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  font-weight: 800;
}

/* ============================================
   NAVEGACIÓN MÓVIL - DISEÑO FUTURISTA
   ============================================ */
.mobile-nav {
  display: none;
  background: var(--card-bg);
  border-top: 1px solid var(--glass-border);
  padding: 15px;
  animation: slideUp 0.4s ease;
  backdrop-filter: blur(20px);
}

@media (max-width: 767px) {
  .mobile-nav {
    display: block;
  }
}

.nav-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 15px 8px;
  color: var(--text-muted);
  text-decoration: none;
  font-size: 12px;
  border-radius: 14px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  border: 1px solid transparent;
}

.nav-item:hover, .nav-item.active {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  color: var(--primary);
  transform: translateY(-5px);
  border-color: var(--glass-border);
}

.nav-item i {
  font-size: 24px;
  transition: transform 0.3s ease;
}

.nav-item:hover i {
  transform: scale(1.2);
}

/* ============================================
   MODAL DE PAGO - DISEÑO FUTURISTA
   ============================================ */
.payment-input-group {
  margin-bottom: 25px;
}

.payment-label {
  display: block;
  margin-bottom: 10px;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 16px;
}

.payment-input {
  width: 100%;
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  border-radius: 14px;
  padding: 18px;
  font-size: 24px;
  color: var(--text-primary);
  text-align: center;
  font-weight: 700;
  outline: none;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.payment-input:focus {
  border-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: 0 15px 35px rgba(0, 242, 254, 0.2);
}

.payment-display {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 25px;
  margin-bottom: 25px;
  animation: fadeIn 0.3s ease;
  backdrop-filter: blur(10px);
}

.payment-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--glass-border);
}

.payment-row:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.payment-row.total {
  font-weight: 800;
  font-size: 20px;
  color: var(--primary);
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid var(--glass-border);
}

/* ============================================
   TECLADO NUMÉRICO - DISEÑO FUTURISTA
   ============================================ */
.numeric-keypad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-top: 25px;
}

.num-btn {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 25px;
  font-size: 28px;
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 700;
  touch-action: manipulation;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.num-btn:hover, .num-btn:active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  transform: scale(0.95);
  box-shadow: 0 10px 25px rgba(0, 242, 254, 0.3);
  border-color: transparent;
}

.num-btn.clear {
  background: linear-gradient(135deg, var(--danger), #ff6b6b);
  color: white;
}

.num-btn.enter {
  background: linear-gradient(135deg, var(--success), #38f9d7);
  color: white;
  grid-column: span 2;
}

.num-btn.backspace {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

/* Modal de efectivo con 4 columnas */
#cashModal .numeric-keypad {
  grid-template-columns: repeat(4, 1fr);
}

#cashModal .num-btn.enter {
  grid-column: span 1;
}

/* ============================================
   MENÚ MODAL - DISEÑO FUTURISTA
   ============================================ */
.menu-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.menu-item {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 18px;
  padding: 25px 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  color: var(--text-primary);
  text-decoration: none;
  backdrop-filter: blur(10px);
}

.menu-item:hover {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  transform: translateY(-10px) scale(1.05);
  border-color: var(--primary);
  box-shadow: 0 20px 40px rgba(0, 242, 254, 0.15);
}

.menu-item i {
  font-size: 36px;
  color: var(--primary);
  transition: transform 0.3s ease;
}

.menu-item:hover i {
  transform: scale(1.2) rotate(10deg);
}

.menu-item span {
  font-size: 13px;
  text-align: center;
  line-height: 1.3;
  font-weight: 600;
}

/* ============================================
   CONFIGURACIÓN - DISEÑO FUTURISTA
   ============================================ */
.config-section {
  margin-bottom: 30px;
}

.config-section h3 {
  color: var(--primary);
  font-size: 18px;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--glass-border);
  font-weight: 700;
}

.config-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: var(--glass-bg);
  border-radius: 16px;
  margin-bottom: 12px;
  transition: all 0.3s;
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(10px);
}

.config-item:hover {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  transform: translateX(10px);
  border-color: var(--primary);
}

.config-label {
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 15px;
}

.config-label i {
  color: var(--primary);
  width: 24px;
  text-align: center;
  font-size: 20px;
}

/* Switch/Toggle futurista */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--glass-bg);
  transition: .4s;
  border: 1px solid var(--glass-border);
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  transition: .4s;
}

input:checked + .slider {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.2), rgba(102, 126, 234, 0.2));
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}

/* ============================================
   HISTORIAL - DISEÑO FUTURISTA
   ============================================ */
.history-container {
  max-height: 400px;
  overflow-y: auto;
}

.history-item {
  background: var(--glass-bg);
  border-radius: 18px;
  padding: 25px;
  margin-bottom: 15px;
  border-left: 5px solid var(--primary);
  border: 1px solid var(--glass-border);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}

.history-item:hover {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  transform: translateX(10px) scale(1.02);
  border-color: var(--primary);
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.history-id {
  font-weight: 800;
  color: var(--primary);
  font-size: 16px;
}

.history-date {
  font-size: 13px;
  color: var(--text-muted);
}

.history-details {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  font-size: 14px;
}

.history-detail {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.history-label {
  color: var(--text-muted);
  font-size: 12px;
}

.history-value {
  color: var(--text-primary);
  font-weight: 600;
}

.history-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.history-action-btn {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: none;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s;
  font-weight: 600;
}

.history-action-view {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
}

.history-action-view:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(0, 242, 254, 0.3);
}

.history-action-whatsapp {
  background: linear-gradient(135deg, #25D366, #128C7E);
  color: white;
}

.history-action-whatsapp:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(37, 211, 102, 0.3);
}

/* ============================================
   REPORTES - DISEÑO FUTURISTA
   ============================================ */
.reports-container {
  max-height: 400px;
  overflow-y: auto;
}

.chart-container {
  background: var(--glass-bg);
  border-radius: 18px;
  padding: 25px;
  margin-bottom: 20px;
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(10px);
}

.chart-title {
  color: var(--primary);
  font-size: 16px;
  margin-bottom: 15px;
  text-align: center;
  font-weight: 700;
}

.chart-canvas {
  width: 100% !important;
  height: 200px !important;
}

.report-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-top: 20px;
}

.stat-card {
  background: var(--glass-bg);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  transition: transform 0.3s ease;
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(10px);
}

.stat-card:hover {
  transform: translateY(-5px);
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  border-color: var(--primary);
}

.stat-value {
  font-size: 24px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 8px;
  text-shadow: 0 2px 10px rgba(0, 242, 254, 0.2);
}

.stat-label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ============================================
   TURNOS - DISEÑO FUTURISTA
   ============================================ */
.shift-end-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  text-align: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.shift-end-content {
  background: linear-gradient(135deg, var(--card-bg), rgba(20, 25, 45, 0.8));
  border-radius: 24px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.5),
    0 0 50px rgba(0, 242, 254, 0.1);
  animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(30px);
}

@keyframes scaleIn {
  from {
    transform: scale(0.8);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.shift-end-icon {
  font-size: 60px;
  color: var(--danger);
  margin-bottom: 20px;
  animation: pulse 2s infinite;
}

.shift-end-title {
  color: var(--danger);
  font-size: 28px;
  margin-bottom: 15px;
  font-weight: 800;
}

.shift-end-message {
  color: var(--text-secondary);
  margin-bottom: 30px;
  line-height: 1.5;
  font-size: 16px;
}

.shift-end-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.shift-end-btn {
  padding: 18px 30px;
  border-radius: 16px;
  border: none;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 150px;
  position: relative;
  overflow: hidden;
}

.shift-end-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.6s;
}

.shift-end-btn:hover::before {
  left: 100%;
}

.shift-end-btn-change {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
}

.shift-end-btn-change:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 35px rgba(0, 242, 254, 0.3);
}

.shift-end-btn-reload {
  background: var(--glass-bg);
  color: var(--text-primary);
  border: 1px solid var(--glass-border);
}

.shift-end-btn-reload:hover {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
  transform: translateY(-3px);
}

/* ============================================
   TOAST Y LOADING - DISEÑO FUTURISTA
   ============================================ */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 20px 30px;
  border-radius: 16px;
  z-index: 1000;
  animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  display: none;
  font-weight: 600;
  font-size: 16px;
  box-shadow: 0 20px 40px rgba(0, 242, 254, 0.3);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

@keyframes slideInUp {
  from {
    transform: translateX(-50%) translateY(30px);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(30px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 25px;
  animation: fadeIn 0.3s ease;
}

.spinner {
  width: 80px;
  height: 80px;
  border: 3px solid transparent;
  border-top-color: var(--primary);
  border-right-color: var(--secondary);
  border-bottom-color: var(--danger);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* ============================================
   RESPONSIVE ADAPTACIONES
   ============================================ */
@media (min-width: 768px) {
  .mobile-container {
    max-width: 97%;
    height: 97vh;
    margin: 1.5vh auto;
    border-radius: 24px;
  }
  
  .main-content {
    flex-direction: row;
  }
  
  .products-section {
    flex: 2;
    max-height: calc(97vh - 140px);
  }
  
  .invoice-section {
    flex: 1;
    display: flex !important;
    max-height: calc(97vh - 140px);
  }
  
  .mobile-nav {
    display: none !important;
  }
  
  .menu-hamburger {
    display: flex !important;
  }
  
  .action-buttons-mobile {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .header-actions {
    gap: 15px;
  }
  
  .search-section {
    padding: 25px;
  }
  
  .search-container-mobile {
    gap: 15px;
  }
  
  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 25px;
  }
  
  .product-card {
    height: auto;
    padding: 25px;
  }
  
  .product-image {
    width: 120px;
    height: 120px;
  }
  
  .product-name {
    font-size: 16px;
    height: 45px;
  }
  
  .product-price {
    font-size: 22px;
  }
  
  .totals-bar-mobile {
    padding: 30px;
  }
  
  .action-btn {
    padding: 25px 15px;
    min-height: 120px;
  }
  
  .action-btn i {
    font-size: 32px;
  }
  
  .action-btn span {
    font-size: 14px;
  }
  
  .modal-content-mobile {
    max-width: 600px;
  }
}

@media (max-width: 767px) {
  .mobile-container {
    height: 100vh;
  }
  
  .invoice-section {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    height: 100vh;
    z-index: 200;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .invoice-section.active {
    right: 0;
  }
  
  .mobile-nav {
    display: block;
  }
  
  .menu-hamburger {
    display: none;
  }
  
  .action-buttons-mobile {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  }
  
  .header-actions {
    gap: 10px;
  }
}

/* ============================================
   SCROLLBAR PERSONALIZADA
   ============================================ */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: var(--glass-bg);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, var(--secondary), var(--primary));
}

/* ============================================
   EFECTOS ESPECIALES
   ============================================ */
.glow-effect {
  position: relative;
}

.glow-effect::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, var(--primary), var(--secondary), var(--danger), var(--warning));
  border-radius: inherit;
  z-index: -1;
  filter: blur(15px);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.glow-effect:hover::after {
  opacity: 0.5;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes shimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}

.shimmer-text {
  background: linear-gradient(90deg, 
    var(--primary) 0%, 
    var(--secondary) 25%, 
    #9b59b6 50%,
    var(--secondary) 75%,
    var(--primary) 100%);
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 3s linear infinite;
}

/* ============================================
   PANTALLAS MUY GRANDES
   ============================================ */
@media (min-width: 1920px) {
  .mobile-container {
    max-width: 1800px;
  }
  
  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 35px;
  }
  
  .product-card {
    padding: 35px;
  }
  
  .product-image {
    width: 150px;
    height: 150px;
  }
  
  .modal-content-mobile {
    max-width: 800px;
  }
}

/* ============================================
   ESTILOS ADICIONALES (MANTENIENDO LOS ORIGINALES)
   ============================================ */
.carrot-icon {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--warning), #fee140);
  border-radius: 50%;
  color: white;
  font-size: 28px;
}

.real-time-total-container {
  background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(102, 126, 234, 0.1));
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 25px;
  display: none;
  animation: slideInDown 0.4s ease;
  backdrop-filter: blur(10px);
}

@keyframes slideInDown {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.real-time-total-label {
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.real-time-total-amount {
  font-size: 28px;
  font-weight: 800;
  color: var(--primary);
  text-align: center;
  text-shadow: 0 2px 15px rgba(0, 242, 254, 0.3);
}

.products-grid.list-view {
  display: flex !important;
  flex-direction: column !important;
  gap: 15px;
}

.products-grid.list-view .product-card {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  padding: 20px !important;
  text-align: left !important;
  height: auto !important;
}

.products-grid.list-view .product-image {
  width: 60px !important;
  height: 60px !important;
  margin-bottom: 0 !important;
  margin-right: 20px !important;
}

.products-grid.list-view .product-name {
  font-size: 16px !important;
  margin-bottom: 5px !important;
  text-align: left !important;
  flex: 1 !important;
  height: auto !important;
}

.products-grid.list-view .product-price {
  font-size: 18px !important;
  margin-bottom: 5px !important;
  text-align: left !important;
}

.products-grid.list-view .product-ean-mobile {
  font-size: 12px !important;
  margin-top: 5px !important;
  text-align: left !important;
}

/* Badges */
.product-badge {
  position: absolute;
  font-size: 11px;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 700;
  z-index: 1;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-expired {
  background: linear-gradient(135deg, var(--danger), #ff6b6b);
  color: white;
  top: 10px;
  right: 10px;
  animation: pulse 2s infinite;
}

.badge-warning {
  background: linear-gradient(135deg, var(--warning), #fee140);
  color: white;
  top: 10px;
  right: 10px;
}

.badge-tax {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  font-size: 10px;
  bottom: 10px;
  left: 10px;
  padding: 5px 10px;
}

/* ============================================
   MODAL DE VENCIMIENTO
   ============================================ */
.expiration-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

.expiration-modal {
  background: linear-gradient(135deg, var(--warning), #fee140);
  border-radius: 20px;
  padding: 30px;
  max-width: 350px;
  width: 85%;
  box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
  color: white;
  text-align: center;
  animation: modalSlideUp 0.4s ease;
  border: 1px solid rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(20px);
}

.expiration-modal.expired {
  background: linear-gradient(135deg, var(--danger), #ff6b6b);
}

.expiration-icon {
  font-size: 48px;
  margin-bottom: 20px;
  animation: bounce 1s ease infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.expiration-title {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 15px;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.expiration-message {
  font-size: 15px;
  line-height: 1.4;
  margin-bottom: 20px;
  background: rgba(255, 255, 255, 0.15);
  padding: 15px;
  border-radius: 12px;
  text-align: left;
}

.expiration-warning {
  font-size: 13px;
  font-style: italic;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 20px;
  padding: 10px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  border-left: 4px solid var(--danger);
}

.expiration-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.expiration-btn {
  padding: 15px 25px;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 15px;
  min-width: 120px;
}

.expiration-btn-yes {
  background: linear-gradient(135deg, var(--success), #38f9d7);
  color: white;
}

.expiration-btn-yes:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(67, 233, 123, 0.4);
}

.expiration-btn-no {
  background: linear-gradient(135deg, var(--danger), #ff6b6b);
  color: white;
}

.expiration-btn-no:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
}

/* ============================================
   QUANTITY MODAL (MANTENIENDO ESTRUCTURA)
   ============================================ */
.quantity-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

.quantity-modal {
  background: var(--card-bg);
  border-radius: 24px;
  padding: 40px;
  max-width: 350px;
  width: 85%;
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.5),
    0 0 40px rgba(0, 242, 254, 0.1);
  animation: modalSlideUp 0.4s ease;
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(30px);
}

.quantity-modal-header {
  text-align: center;
  margin-bottom: 30px;
}

.quantity-modal-header h3 {
  color: var(--primary);
  font-size: 22px;
  margin-bottom: 10px;
  font-weight: 700;
}

.quantity-modal-header p {
  font-size: 28px;
  font-weight: 800;
  background: linear-gradient(45deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.quantity-input-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 25px;
  margin: 40px 0;
}

.quantity-btn {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border: none;
  width: 60px;
  height: 60px;
  border-radius: 16px;
  color: white;
  font-size: 28px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 10px 25px rgba(0, 242, 254, 0.3);
}

.quantity-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 15px 35px rgba(0, 242, 254, 0.4);
}

.quantity-display {
  font-size: 48px;
  font-weight: 800;
  color: var(--primary);
  min-width: 80px;
  text-align: center;
  text-shadow: 0 2px 15px rgba(0, 242, 254, 0.3);
}

.quantity-actions {
  display: flex;
  gap: 15px;
  margin-top: 30px;
}

.quantity-action-btn {
  flex: 1;
  padding: 20px;
  border-radius: 16px;
  border: none;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.quantity-action-add {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
}

.quantity-action-cancel {
  background: var(--glass-bg);
  color: var(--text-primary);
  border: 1px solid var(--glass-border);
}

.quantity-action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
}

/* ============================================
   MODAL DE UNIDADES VARIABLES (MANTENIENDO ESTRUCTURA)
   ============================================ */
#unitModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s ease-out;
}

#unitModal .modal-content-mobile {
  background: var(--card-bg);
  border-radius: 24px;
  width: 90%;
  max-width: 400px;
  max-height: 85vh;
  overflow-y: auto;
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid var(--glass-border);
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.5),
    0 0 40px rgba(0, 242, 254, 0.1);
  backdrop-filter: blur(30px);
}

#unitModal .modal-header {
  padding: 25px;
  background: linear-gradient(180deg, rgba(0, 242, 254, 0.1), transparent);
  border-bottom: 1px solid var(--glass-border);
  border-radius: 24px 24px 0 0;
}

#unitModal .modal-header h3 {
  color: var(--primary);
  font-size: 20px;
  font-weight: 700;
}

#unitModal .modal-body {
  padding: 25px;
}

/* ============================================
   ESTILOS PARA PANTALLAS MUY PEQUEÑAS
   ============================================ */
@media (max-width: 480px) {
  .mobile-header {
    padding: 12px 15px;
    min-height: 60px;
  }
  
  .logo-mobile {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }
  
  .system-name-mobile {
    font-size: 18px;
  }
  
  .header-icon {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  
  .user-avatar-mobile {
    width: 40px;
    height: 40px;
  }
  
  .search-section {
    padding: 15px;
  }
  
  .search-box {
    padding: 12px 15px;
    font-size: 14px;
  }
  
  .scanner-btn-mobile {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
  
  .products-section {
    padding: 15px;
  }
  
  .products-section h2 {
    font-size: 18px;
  }
  
  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
  }
  
  .product-card {
    padding: 15px;
  }
  
  .product-image {
    width: 80px;
    height: 80px;
  }
  
  .product-name {
    font-size: 13px;
  }
  
  .product-price {
    font-size: 16px;
  }
  
  .modal-content-mobile {
    margin: 10px;
  }
}

/* ============================================
   ESTILOS PARA ORIENTACIÓN LANDSCAPE
   ============================================ */
@media (orientation: landscape) and (max-height: 600px) {
  .mobile-header {
    min-height: 50px;
    padding: 10px 15px;
  }
  
  .mobile-nav {
    padding: 8px;
  }
  
  .nav-item {
    padding: 8px 4px;
    font-size: 10px;
  }
  
  .nav-item i {
    font-size: 18px;
  }
  
  .modal-content-mobile {
    max-height: 85vh;
    width: 90%;
  }
  
  .modal-body {
    padding: 15px;
  }
}
  </style>
</head>
<body>
  <!-- Mantengo EXACTAMENTE el mismo HTML original -->
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container-mobile">
    <div class="login-card">
      <div class="login-logo" id="loginLogo">
        <i class="fas fa-carrot"></i>
      </div>
      <h1 class="login-title">ZANARA POS</h1>
      <p style="color: var(--text-secondary); margin-bottom: 25px;">Inicia sesión para comenzar</p>
      
      <input type="text" id="mobileUsername" class="login-input" placeholder="Usuario" autocomplete="off">
      <input type="password" id="mobilePin" class="login-input" placeholder="PIN" autocomplete="off">
      <button id="mobileLoginBtn" class="login-btn">Iniciar Sesión</button>
      
      <p id="loginError" style="color: var(--danger); margin-top: 12px; display: none;">
        <i class="fas fa-exclamation-circle"></i> Credenciales incorrectas
      </p>
    </div>
  </div>

  <!-- POS Mobile Interface -->
  <div id="posScreen" class="mobile-container" style="display: none;">
    <!-- Header -->
    <header class="mobile-header">
      <div class="header-left">
        <a href="logo.png" class="logo-mobile" id="headerLogoMobile">
          <i class="fas fa-carrot"></i>
        </a>
        <div class="system-name-mobile">ZANARA POS</div>
      </div>
      
      <div class="header-actions">
        <button class="menu-hamburger" id="menuHamburgerBtn">
          <i class="fas fa-bars"></i>
        </button>
        
        <a href="#" class="header-icon" id="userBtnMobile" title="Usuario">
          <i class="fas fa-user"></i>
        </a>
        <button class="header-icon" id="shiftBtnMobile" title="Turno">
          <i class="fas fa-clock"></i>
        </button>
        
        <a href="estadistica-rapida-colaboradores.html" class="header-icon" id="reportBtnMobile" title="Reportes">
          <i class="fas fa-chart-bar"></i>
        </a>
        
        <img id="userAvatarMobile" class="user-avatar-mobile" src="" alt="" style="display: none;">
      </div>
    </header>

    <!-- Search Section -->
    <section class="search-section">
      <div class="search-container-mobile">
        <input type="text" id="mobileSearch" class="search-box" placeholder="Buscar producto..." autocomplete="off">
        <button class="scanner-btn-mobile" id="scannerBtnMobile">
          <i class="fas fa-barcode"></i>
        </button>
      </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Products Section -->
      <section class="products-section" id="productsSection">
        <h2>
          Productos
          <div class="view-toggle-mobile">
            <button class="view-btn active" id="viewGridMobile" title="Vista cuadrícula">
              <i class="fas fa-th"></i>
            </button>
            <button class="view-btn" id="viewListMobile" title="Vista lista">
              <i class="fas fa-list"></i>
            </button>
          </div>
        </h2>
        
        <!-- Total en tiempo real -->
        <div class="real-time-total-container" id="realTimeTotalContainer">
          <div class="real-time-total-label">Total Factura Actual:</div>
          <div class="real-time-total-amount" id="realTimeTotalAmount">$0.00</div>
        </div>
        
        <div class="products-grid" id="productsGrid">
          <!-- Products will be loaded here -->
        </div>
      </section>

      <!-- Invoice Section -->
      <section class="invoice-section" id="invoiceSection">
        <div class="invoice-header">
          <h2><i class="fas fa-receipt"></i> Factura Actual</h2>
          <button class="invoice-close-btn" id="closeInvoiceBtn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="invoice-items" id="invoiceItemsMobile">
          <!-- Invoice items will be loaded here -->
        </div>
        
        <div class="totals-bar-mobile">
          <div class="total-display">
            <span class="total-label">Total a Pagar:</span>
            <span class="total-amount" id="totalAmountMobile">$0.00</span>
          </div>
          
          <div class="currency-totals-mobile">
            <div class="currency-total" id="usdTotalMobile">
              <i class="fas fa-dollar-sign"></i> $0.00
            </div>
            <div class="currency-total" id="eurTotalMobile">
              <i class="fas fa-euro-sign"></i> €0.00
            </div>
          </div>
          
          <div class="action-buttons-mobile">
            <button class="action-btn btn-discount" id="discountBtnMobile">
              <i class="fas fa-percent"></i>
              <span>Descuento</span>
            </button>
            <button class="action-btn btn-cash" id="cashBtnMobile">
              <i class="fas fa-money-bill"></i>
              <span>Efectivo</span>
            </button>
            <button class="action-btn btn-card" id="cardBtnMobile">
              <i class="fas fa-credit-card"></i>
              <span>Tarjeta</span>
            </button>
            <button class="action-btn btn-invoice" id="invoiceBtnMobile">
              <i class="fas fa-file-invoice"></i>
              <span>Facturar</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
      <div class="nav-grid">
        <a href="#" class="nav-item active" id="navProducts">
          <i class="fas fa-boxes"></i>
          <span>Productos</span>
        </a>
        <a href="#" class="nav-item" id="navInvoice">
          <i class="fas fa-receipt"></i>
          <span>Factura</span>
          <span class="badge badge-expired" id="invoiceBadge">0</span>
        </a>
        <a href="#" class="nav-item" id="navHistory">
          <i class="fas fa-history"></i>
          <span>Historial</span>
        </a>
        <a href="#" class="nav-item" id="navReports">
          <i class="fas fa-chart-bar"></i>
          <span>Reportes</span>
        </a>
        <a href="#" class="nav-item" id="navMenu">
          <i class="fas fa-bars"></i>
          <span>Menú</span>
        </a>
      </div>
    </nav>
  </div>

  <!-- Ventana de cantidad de producto -->
  <div id="quantityModal" class="quantity-modal-overlay" style="display: none;">
    <div class="quantity-modal">
      <div class="quantity-modal-header">
        <h3 id="quantityProductName">Producto</h3>
        <p id="quantityProductPrice">$0.00</p>
      </div>
      <div class="quantity-input-container">
        <button class="quantity-btn" id="quantityDecrease">
          <i class="fas fa-minus"></i>
        </button>
        <div class="quantity-display" id="quantityDisplay">1</div>
        <button class="quantity-btn" id="quantityIncrease">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="quantity-actions">
        <button class="quantity-action-btn quantity-action-cancel" id="quantityCancel">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="quantity-action-btn quantity-action-add" id="quantityAdd">
          <i class="fas fa-cart-plus"></i> Agregar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Información del Usuario -->
  <div id="userInfoModal" class="modal-mobile user-info-modal">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-user-circle"></i> Perfil de Usuario</h2>
        <button class="close-modal" id="closeUserInfoModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div id="userInfoContent">
          <div class="user-info-header">
            <div style="position: relative;">
              <div id="profileCarrotIcon" class="carrot-icon" style="width: 90px; height: 90px; display: none;">
                <i class="fas fa-carrot"></i>
              </div>
              <img id="profileAvatar" src="" 
                   class="user-avatar-large" 
                   alt="Usuario" style="display: none;">
            </div>
            <div class="user-info-details">
              <h2 class="user-info-name" id="profileName">Usuario</h2>
              <span class="user-info-role" id="profileRole">Colaborador</span>
            </div>
          </div>
          
          <div class="user-info-grid">
            <div class="user-info-item">
              <div class="user-info-label">Usuario</div>
              <div class="user-info-value" id="profileUsername">-</div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">ID Único</div>
              <div class="user-info-value" id="profileUserId">RTM-00000</div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">Nombre Completo</div>
              <div class="user-info-value" id="profileFullName">-</div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">Estado</div>
              <div class="user-info-value">
                <span style="color: var(--primary); font-weight: bold;">
                  <i class="fas fa-circle" style="font-size: 12px;"></i> Activo
                </span>
              </div>
            </div>
            
            <div class="user-info-item">
              <div class="user-info-label">Turno</div>
              <div class="user-info-value" id="profileShift">-</div>
            </div>
          </div>
          
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal (Cash) -->
  <div id="cashModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-money-bill"></i> Pago en Efectivo</h2>
        <button class="close-modal" id="closeCashModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display">
          <div class="payment-row">
            <span>Total a Pagar:</span>
            <span id="cashTotalAmount">$0.00</span>
          </div>
          <div class="payment-row">
            <span>Monto Recibido:</span>
            <span id="cashReceivedDisplay">$0.00</span>
          </div>
          <div class="payment-row total">
            <span>Cambio:</span>
            <span id="cashChangeAmount">$0.00</span>
          </div>
        </div>
        
        <div class="payment-input-group">
          <label class="payment-label">Monto Recibido:</label>
          <input type="text" id="cashReceivedInput" class="payment-input" placeholder="0.00" autocomplete="off" readonly>
        </div>
        
        <div class="numeric-keypad">
          <button class="num-btn" data-value="7">7</button>
          <button class="num-btn" data-value="8">8</button>
          <button class="num-btn" data-value="9">9</button>
          <button class="num-btn backspace" id="cashBackspaceBtn">
            <i class="fas fa-backspace"></i>
          </button>
          <button class="num-btn" data-value="4">4</button>
          <button class="num-btn" data-value="5">5</button>
          <button class="num-btn" data-value="6">6</button>
          <button class="num-btn clear" id="cashClearBtn">C</button>
          <button class="num-btn" data-value="1">1</button>
          <button class="num-btn" data-value="2">2</button>
          <button class="num-btn" data-value="3">3</button>
          <button class="num-btn" data-value=".">.</button>
          <button class="num-btn" data-value="0">0</button>
          <button class="num-btn" data-value="00">00</button>
          <button class="num-btn enter" id="cashConfirmBtn">✓</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal (Card) -->
  <div id="cardModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-credit-card"></i> Pago con Tarjeta</h2>
        <button class="close-modal" id="closeCardModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display" style="text-align: center; padding: 25px;">
          <h3 style="margin-bottom: 12px;">Total a Pagar:</h3>
          <div style="font-size: 28px; color: var(--primary); font-weight: bold; margin-bottom: 25px;" id="cardTotalAmount">$0.00</div>
          <button class="login-btn" id="confirmCardBtn">
            <i class="fas fa-check"></i> Confirmar Pago
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Discount Modal -->
  <div id="discountModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-percent"></i> Aplicar Descuento</h2>
        <button class="close-modal" id="closeDiscountModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display" style="margin-bottom: 15px;">
          <div class="payment-row">
            <span>Descuento Requiere Contraseña</span>
            <span style="color: var(--warning);">✓</span>
          </div>
        </div>
        
        <div class="payment-input-group">
          <label class="payment-label">Contraseña:</label>
          <input type="password" id="discountPasswordInput" class="payment-input" placeholder="Ingrese contraseña" autocomplete="off">
        </div>
        
        <!-- Teclado numérico para contraseña -->
        <div class="numeric-keypad">
          <button class="num-btn" data-value="1">1</button>
          <button class="num-btn" data-value="2">2</button>
          <button class="num-btn" data-value="3">3</button>
          <button class="num-btn" data-value="4">4</button>
          <button class="num-btn" data-value="5">5</button>
          <button class="num-btn" data-value="6">6</button>
          <button class="num-btn" data-value="7">7</button>
          <button class="num-btn" data-value="8">8</button>
          <button class="num-btn" data-value="9">9</button>
          <button class="num-btn clear" id="discountClearPasswordBtn">C</button>
          <button class="num-btn" data-value="0">0</button>
          <button class="num-btn backspace" id="discountBackspaceBtn">
            <i class="fas fa-backspace"></i>
          </button>
        </div>
        
        <button class="login-btn" style="margin-top: 15px;" id="verifyDiscountBtn">
          <i class="fas fa-check"></i> Verificar Contraseña
        </button>
      </div>
    </div>
  </div>

  <!-- Discount Percentage Modal -->
  <div id="discountPercentageModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-percent"></i> Aplicar Descuento</h2>
        <button class="close-modal" id="closeDiscountPercentageModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-input-group">
          <label class="payment-label">Porcentaje de Descuento:</label>
          <input type="text" id="discountInput" class="payment-input" placeholder="0%" autocomplete="off" readonly>
        </div>
        
        <!-- Teclado para porcentaje de descuento -->
        <div class="numeric-keypad">
          <button class="num-btn" data-value="5">5%</button>
          <button class="num-btn" data-value="10">10%</button>
          <button class="num-btn" data-value="15">15%</button>
          <button class="num-btn" data-value="20">20%</button>
          <button class="num-btn" data-value="25">25%</button>
          <button class="num-btn" data-value="30">30%</button>
          <button class="num-btn backspace" id="discountBackspaceBtn2">
            <i class="fas fa-backspace"></i>
          </button>
          <button class="num-btn clear" id="discountClearBtn">C</button>
        </div>
        
        <button class="login-btn" style="margin-top: 15px;" id="applyDiscountBtn">
          <i class="fas fa-check"></i> Aplicar Descuento
        </button>
      </div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="scannerModal" class="modal-mobile scanner-modal-mobile">
    <div class="scanner-content">
      <div class="modal-header">
        <h2><i class="fas fa-barcode"></i> Escanear Código</h2>
        <button class="close-modal" id="closeScannerModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="scanner-viewport" id="scannerViewport">
        <!-- Scanner will be initialized here -->
      </div>
      
      <div class="scanner-controls">
        <button class="scanner-btn" id="switchCameraBtn">
          <i class="fas fa-camera-rotate"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Shift Info Modal -->
  <div id="shiftModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-clock"></i> Información del Turno</h2>
        <button class="close-modal" id="closeShiftModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display">
          <div class="payment-row">
            <span>Colaborador:</span>
            <span id="shiftUserName">-</span>
          </div>
          <div class="payment-row">
            <span>Turno:</span>
            <span id="shiftName">-</span>
          </div>
          <div class="payment-row">
            <span>Inicio:</span>
            <span id="shiftStartTime">-</span>
          </div>
          <div class="payment-row">
            <span>Fin:</span>
            <span id="shiftEndTime">-</span>
          </div>
          <div class="payment-row total">
            <span>Tiempo Restante:</span>
            <span id="shiftTimeRemaining">-</span>
          </div>
        </div>
        
        <button class="login-btn" style="margin-top: 15px; background: linear-gradient(135deg, var(--danger), #ff6b6b);" id="endShiftBtn">
          <i class="fas fa-sign-out-alt"></i> Finalizar Turno
        </button>
      </div>
    </div>
  </div>

  <!-- Config Modal -->
  <div id="configModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-cog"></i> Configuración</h2>
        <button class="close-modal" id="closeConfigModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="config-section">
          <h3>Visualización</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-eye"></i>
              <span>Mostrar total en tiempo real en productos</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleRealTimeTotal">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Ventana de Cantidad</h3>
          <div class="config-quantity-toggle">
            <div class="config-quantity-label">
              <i class="fas fa-window-restore"></i>
              <span>Activar ventana de cantidad para productos</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleQuantityWindow">
              <span class="slider round"></span>
            </label>
          </div>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-info-circle"></i>
              <span>Si está activado, al hacer clic en un producto se mostrará una ventana para seleccionar la cantidad</span>
            </div>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Notificaciones</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-bell"></i>
              <span>Notificaciones de stock bajo</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleLowStockNotifications">
              <span class="slider round"></span>
            </label>
          </div>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-exclamation-triangle"></i>
              <span>Alertas de vencimiento</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleExpirationAlerts">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Impresión</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-print"></i>
              <span>Auto-imprimir facturas</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleAutoPrint">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Buscador</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-search"></i>
              <span>Mantener buscador siempre activo</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleAlwaysActiveSearch" checked>
              <span class="slider round"></span>
            </label>
          </div>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-broom"></i>
              <span>Limpiar buscador automáticamente</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleAutoClearSearch" checked>
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="config-section">
          <h3>Sistema de Turnos</h3>
          <div class="config-item">
            <div class="config-label">
              <i class="fas fa-clock"></i>
              <span>Modo con turnos</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleShiftMode" checked>
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <button class="login-btn" style="margin-top: 15px;" id="saveConfigBtn">
          <i class="fas fa-save"></i> Guardar Configuración
        </button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-history"></i> Historial de Facturas</h2>
        <button class="close-modal" id="closeHistoryModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="history-container" id="historyContainer">
          <!-- Historial items will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Modal -->
  <div id="reportsModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-chart-bar"></i> Reportes</h2>
        <button class="close-modal" id="closeReportsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="reports-container">
          <div class="report-section">
            <div class="chart-container">
              <h3 class="chart-title">Ventas del Día</h3>
              <canvas id="salesChart" class="chart-canvas"></canvas>
            </div>
            
            <div class="report-stats">
              <div class="stat-card">
                <div class="stat-value" id="todaySales">$0.00</div>
                <div class="stat-label">Ventas Hoy</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="todayTransactions">0</div>
                <div class="stat-label">Transacciones</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="avgTicket">$0.00</div>
                <div class="stat-label">Ticket Promedio</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="topProduct">-</div>
                <div class="stat-label">Producto Más Vendido</div>
              </div>
            </div>
          </div>
          
          <div class="report-section">
            <div class="chart-container">
              <h3 class="chart-title">Métodos de Pago</h3>
              <canvas id="paymentMethodsChart" class="chart-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu Modal -->
  <div id="menuModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-bars"></i> Menú Principal</h2>
        <button class="close-modal" id="closeMenuModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="menu-grid">
          <a href="novedad-cliente.html" class="menu-item" id="menuInventory">
            <i class="fa-solid fa-bell"></i>
            <span>Novedades</span>
          </a>
          <a href="estadistica-rapida-colaboradores.html" class="menu-item" id="menuReportsMain">
            <i class="fas fa-chart-bar"></i>
            <span>Reportes</span>
          </a>
          <a href="facturas-del-dia.html" class="menu-item" id="menuInvoices">
            <i class="fas fa-receipt"></i>
            <span>Facturas</span>
          </a>
          <a href="Ventas-general.html" class="menu-item" id="menuAnalysis">
            <i class="fa-solid fa-money-bill"></i>
            <span>Ventas</span>
          </a>
          <a href="analisis.html" class="menu-item" id="menuAnalysis">
            <i class="fas fa-chart-line"></i>
            <span>Análisis</span>
          </a>
          <a href="devolucion-de-faturacion.html" class="menu-item" id="menuAnalysis">
            <i class="fa-solid fa-arrow-rotate-left"></i>
            <span>Devoluciones</span>
          </a>
          <a href="conciliacion-de-Caja.html" class="menu-item" id="menuAnalysis">
            <i class="fas fa-cash-register"></i>
            <span>Cierre de Caja</span>
          </a>
          <a href="venta-a-credito.html" class="menu-item" id="menuAnalysis">
            <i class="fas fa-cart-plus"></i>
            <span>Ventas a Crédito</span>
          </a>
          <a href="Perla-chatbot-Pos.html" class="menu-item" id="menuAnalysis">
            <i class="fas fa-robot"></i>
            <span>Perla - Asistente</span>
          </a>
          <a href="bajo-stock.html" class="menu-item" id="menuAnalysis">
            <i class="fas fa-check-circle"></i>
            <span>Ver Stock</span>
          </a>
          <a href="#" class="menu-item" id="menuConfigMain">
            <i class="fas fa-cog"></i>
            <span>Configuración</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Print Invoice Modal -->
  <div id="printModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-print"></i> Factura Generada</h2>
        <button class="close-modal" id="closePrintModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div id="invoicePrintContent" style="background: white; color: black; padding: 15px; border-radius: 8px; font-family: monospace; max-height: 350px; overflow-y: auto;">
          <!-- Invoice content will be generated here -->
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 15px;">
          <button class="login-btn" style="flex: 1; background: linear-gradient(135deg, var(--primary), var(--secondary));" id="sendInvoiceBtn">
            <i class="fas fa-paper-plane"></i> Enviar
          </button>
          <button class="login-btn" style="flex: 1;" id="printInvoiceBtn">
            <i class="fas fa-print"></i> Imprimir
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Send Invoice Modal -->
  <div id="sendInvoiceModal" class="modal-mobile">
    <div class="modal-content-mobile">
      <div class="modal-header">
        <h2><i class="fas fa-paper-plane"></i> Enviar Factura</h2>
        <button class="close-modal" id="closeSendInvoiceModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="payment-display" style="text-align: center; padding: 15px; margin-bottom: 15px;">
          <h3 style="margin-bottom: 8px;">Enviar Factura por WhatsApp</h3>
          <p style="color: var(--text-secondary); font-size: 13px;">La factura se enviará formateada para WhatsApp</p>
        </div>
        
        <div class="payment-input-group">
          <label class="payment-label">Número de Teléfono (sin código de país):</label>
          <input type="text" id="whatsappNumber" class="payment-input" placeholder="8091234567" autocomplete="off" pattern="[0-9]*" inputmode="numeric">
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 15px;">
          <button class="login-btn" style="flex: 1; background: linear-gradient(135deg, #25D366, #128C7E);" id="sendWhatsAppBtn">
            <i class="fab fa-whatsapp"></i> Enviar WhatsApp
          </button>
          <button class="login-btn" style="flex: 1; background: linear-gradient(135deg, var(--primary), var(--secondary));" id="copyInvoiceBtn">
            <i class="fas fa-copy"></i> Copiar Texto
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Turno Terminado Modal -->
  <div id="shiftEndModal" class="shift-end-modal">
    <div class="shift-end-content">
      <div class="shift-end-icon">
        <i class="fas fa-clock"></i>
      </div>
      <h2 class="shift-end-title">Turno Finalizado</h2>
      <p class="shift-end-message" id="shiftEndMessage">
        Tu turno ha terminado. No podrás realizar más ventas hasta que se asigne un nuevo turno.
      </p>
      <div class="shift-end-buttons">
        <button class="shift-end-btn shift-end-btn-change" id="changeAccountBtn">
          Cambiar Cuenta
        </button>
        <button class="shift-end-btn shift-end-btn-reload" id="reloadPageBtn">
          Recargar Página
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toastNotification"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="color: var(--text-primary); font-size: 16px;">Cargando...</div>
  </div>

  <!-- Hidden file input for image upload -->
  <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">

  <!-- Mantengo el JavaScript existente sin cambios -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      getDoc,
      updateDoc,
      addDoc,
      Timestamp,
      setDoc,
      orderBy,
      limit,
      onSnapshot,
      deleteDoc,
      arrayUnion,
      arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
      authDomain: "formulario-2-8929a.firebaseapp.com",
      databaseURL: "https://formulario-2-8929a-default-rtdb.firebaseio.com",
      projectId: "formulario-2-8929a",
      storageBucket: "formulario-2-8929a.appspot.com",
      messagingSenderId: "136908102526",
      appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f",
      measurementId: "G-HJNZXRENE9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // State variables
    let currentCollaborator = null;
    let products = [];
    let invoice = [];
    let totalPrice = 0;
    let discount = 0;
    let discountedTotal = 0;
    let amountReceived = 0;
    let taxConfig = { itbis: 18, iva: 0, active: false };
    let exchangeRates = { usd: 56.50, eur: 61.20 };
    let currentShift = null;
    let html5QrCode = null;
    let isScannerActive = false;
    let showRealTimeTotal = false;
    let businessDetails = null;
    let discountSettings = null;
    let shiftTimer = null;
    let shiftEndTimer = null;
    let autoClearSearchTimeout = null;
    let autoClearSearchEnabled = true;
    let alwaysActiveSearchEnabled = true;
    let realTimeInvoiceListener = null;
    let realTimeTotalListener = null;
    let shiftModeEnabled = true;
    let quantityWindowEnabled = false;
    let currentProductForQuantity = null;

    // Variables para control del teclado numérico
    let lastNumpadClickTime = 0;
    let numpadClickDelay = 300;

    // Variables para evitar duplicación de resultados
    let currentSearchResults = new Set();
    let isSearchInProgress = false;
    let lastSearchQuery = '';

    // CORRECCIÓN: Variables para control de registro de facturas
    let isProcessingPayment = false;
    let invoiceCounter = 10000; // Base para IDs

    // NUEVO: Variables para control de venta por unidades variables
    let currentProductForVariableUnit = null;
    let unitModalOpen = false;
    let unitConversionData = {
      unit: '',
      quantity: 1,
      customQuantity: 1,
      conversionOptions: [],
      selectedOption: 0
    };

    // ====================================================================
    // SISTEMA DE NOTIFICACIONES EN TIEMPO REAL - CORREGIDO Y MEJORADO
    // ====================================================================
    let notificationsListener = null;
    let unreadNotifications = 0;
    let currentNotifications = [];
    let lastCheckedTimestamp = null;
    
    // Elementos para notificaciones - TAMAÑO REDUCIDO Y MEJOR POSICIONADO
    const notificationIcon = document.createElement('div');
    notificationIcon.id = 'notificationIcon';
    notificationIcon.style.cssText = `
      position: fixed;
      top: 80px;
      right: 15px;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 1px solid #16e086;
      transition: all 0.3s ease;
    `;
    
    const notificationBadge = document.createElement('div');
    notificationBadge.id = 'notificationBadge';
    notificationBadge.style.cssText = `
      position: absolute;
      top: -3px;
      right: -3px;
      width: 18px;
      height: 18px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 1px solid #2c3e50;
      display: none;
    `;
    
    notificationIcon.innerHTML = '<i class="fas fa-bell" style="font-size: 18px; color: #16e086;"></i>';
    notificationIcon.appendChild(notificationBadge);
    document.body.appendChild(notificationIcon);
    
    // Función para verificar si hay notificaciones para el colaborador
    async function checkForNotifications() {
      if (!currentCollaborator) return;
      
      try {
        console.log("Verificando notificaciones para:", currentCollaborator.id);
        
        // Obtener la última vez que el colaborador marcó notificaciones como leídas
        const lastReadRef = doc(db, "notificationReadStatus", currentCollaborator.id);
        let lastReadDoc = null;
        try {
          lastReadDoc = await getDoc(lastReadRef);
        } catch (error) {
          console.log("No hay registro previo de lectura");
        }
        
        // Consultar textos desde la colección "Textos" ordenados por fecha
        const textsQuery = query(
          collection(db, "Textos"),
          orderBy("createdAt", "desc")
        );
        
        const snapshot = await getDocs(textsQuery);
        let notifications = [];
        let newUnreadCount = 0;
        
        snapshot.forEach(doc => {
          const text = doc.data();
          const textId = doc.id;
          
          // Verificar si el texto es para este colaborador
          if (isTextForCollaborator(text)) {
            // Verificar si el texto es más reciente que la última lectura
            let isRead = false;
            
            if (lastReadDoc && lastReadDoc.exists()) {
              const lastReadData = lastReadDoc.data();
              const textTimestamp = text.createdAt?.toDate?.() || new Date();
              const lastReadTimestamp = lastReadData.lastReadAt?.toDate?.() || new Date(0);
              
              // Si el texto es anterior o igual a la última lectura, marcarlo como leído
              if (textTimestamp <= lastReadTimestamp) {
                isRead = true;
              }
            }
            
            // Crear objeto de notificación
            const notification = {
              id: textId,
              ...text,
              isRead: isRead,
              timestamp: text.createdAt?.toDate?.() || new Date()
            };
            
            notifications.push(notification);
            
            // Si no ha sido leída, incrementar contador
            if (!isRead) {
              newUnreadCount++;
            }
          }
        });
        
        console.log("Notificaciones encontradas:", notifications.length);
        console.log("No leídas:", newUnreadCount);
        
        // Actualizar contador global
        unreadNotifications = newUnreadCount;
        
        // Guardar notificaciones actuales
        currentNotifications = notifications;
        
        // Actualizar badge
        updateNotificationBadge();
        
        // Mostrar notificación si hay nuevas
        if (newUnreadCount > 0) {
          const newNotifications = notifications.filter(n => !n.isRead);
          if (newNotifications.length > 0) {
            // Mostrar la más reciente
            showNotification(newNotifications[0]);
          }
        }
        
      } catch (error) {
        console.error('Error verificando notificaciones:', error);
      }
    }
    
    // Función para verificar si un texto es para el colaborador actual
    function isTextForCollaborator(text) {
      if (!currentCollaborator) return false;
      
      // Si es para todos
      if (text.isForAll === true) {
        return true;
      }
      
      // Si tiene destinatarios específicos
      if (text.destinatarios && Array.isArray(text.destinatarios)) {
        return text.destinatarios.includes(currentCollaborator.id);
      }
      
      return false;
    }
    
    // Función para mostrar notificación en pantalla
    function showNotification(notification) {
      // Verificar si ya hay una notificación mostrándose
      if (document.querySelector('.notification-toast')) {
        return;
      }
      
      // Crear notificación visual
      const notificationToast = document.createElement('div');
      notificationToast.className = 'notification-toast';
      notificationToast.style.cssText = `
        position: fixed;
        top: 70px;
        right: 15px;
        background: linear-gradient(135deg, #16e086, #12c574);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(22, 224, 134, 0.3);
        z-index: 9998;
        max-width: 280px;
        animation: slideInRight 0.3s ease;
        border: 1px solid rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        cursor: pointer;
      `;
      
      const title = notification.title || 'Nueva Notificación';
      const message = notification.content ? 
        (notification.content.length > 50 ? notification.content.substring(0, 50) + '...' : notification.content) : 
        'Tienes una nueva notificación';
      
      notificationToast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
          <i class="fas fa-bullhorn" style="font-size: 16px;"></i>
          <h4 style="margin: 0; font-size: 14px; font-weight: bold;">${title}</h4>
        </div>
        <p style="margin: 0 0 8px 0; font-size: 12px; line-height: 1.3;">${message}</p>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <small style="opacity: 0.8; font-size: 10px;">Hace unos momentos</small>
          <button id="viewNotificationBtn" style="background: rgba(255,255,255,0.2); color: white; border: none; 
                  padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
            Ver
          </button>
        </div>
      `;
      
      document.body.appendChild(notificationToast);
      
      // Configurar evento para ver notificación
      const viewBtn = notificationToast.querySelector('#viewNotificationBtn');
      if (viewBtn) {
        viewBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.body.removeChild(notificationToast);
          
          // Marcar como leída
          markNotificationAsRead(notification.id);
          
          // Redirigir a novedades en la MISMA pestaña
          window.location.href = 'novedad-cliente.html';
        });
      }
      
      notificationToast.addEventListener('click', () => {
        document.body.removeChild(notificationToast);
        
        // Marcar como leída
        markNotificationAsRead(notification.id);
        
        // Redirigir a novedades en la MISMA pestaña
        window.location.href = 'novedad-cliente.html';
      });
      
      // Auto-remover notificación después de 6 segundos
      setTimeout(() => {
        if (notificationToast.parentNode) {
          document.body.removeChild(notificationToast);
        }
      }, 6000);
    }
    
    // Función para marcar notificación como leída (individuo o todas)
    async function markNotificationAsRead(notificationId = null) {
      if (!currentCollaborator) return;
      
      try {
        console.log("Marcando notificaciones como leídas para:", currentCollaborator.id);
        
        const lastReadRef = doc(db, "notificationReadStatus", currentCollaborator.id);
        
        // Actualizar timestamp de última lectura
        await setDoc(lastReadRef, {
          collaboratorId: currentCollaborator.id,
          collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
          lastReadAt: Timestamp.now(),
          updatedAt: Timestamp.now()
        }, { merge: true });
        
        // Si es una notificación específica, también marcarla individualmente
        if (notificationId) {
          const notificationRef = doc(db, "Textos", notificationId);
          try {
            await updateDoc(notificationRef, {
              readBy: arrayUnion(currentCollaborator.id)
            });
          } catch (error) {
            console.log("No se pudo actualizar readBy, continuando...");
          }
        }
        
        // Actualizar contador local
        unreadNotifications = 0;
        updateNotificationBadge();
        
        // Actualizar en array de notificaciones
        currentNotifications.forEach(n => {
          n.isRead = true;
        });
        
        console.log("Notificaciones marcadas como leídas");
        
      } catch (error) {
        console.error('Error al marcar notificación como leída:', error);
      }
    }
    
    // Función para actualizar el badge de notificaciones
    function updateNotificationBadge() {
      console.log("Actualizando badge. No leídas:", unreadNotifications);
      
      if (unreadNotifications > 0) {
        notificationBadge.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
        notificationBadge.style.display = 'flex';
        notificationIcon.style.display = 'flex';
        
        // Animar el icono si hay notificaciones
        notificationIcon.style.animation = 'pulse 2s infinite';
        
        // Asegurar que esté encima de otros elementos pero no sobre la barra inferior
        notificationIcon.style.zIndex = '1000';
        
        // Asegurar que no interfiera en móvil
        if (window.innerWidth <= 768) {
          notificationIcon.style.top = '70px';
          notificationIcon.style.right = '15px';
        } else {
          notificationIcon.style.top = '80px';
          notificationIcon.style.right = '20px';
        }
      } else {
        notificationBadge.style.display = 'none';
        notificationIcon.style.animation = '';
        notificationIcon.style.display = 'none';
      }
    }
    
    // Función para escuchar notificaciones en tiempo real - VERSIÓN MEJORADA
    function setupNotificationsListener() {
      if (notificationsListener) {
        notificationsListener();
        notificationsListener = null;
      }
      
      if (!currentCollaborator) return;
      
      console.log("Configurando listener de notificaciones para:", currentCollaborator.id);
      
      // Obtener la última vez que el colaborador marcó notificaciones como leídas
      getDoc(doc(db, "notificationReadStatus", currentCollaborator.id))
        .then(lastReadDoc => {
          let lastReadTimestamp = new Date(0);
          
          if (lastReadDoc.exists()) {
            lastReadTimestamp = lastReadDoc.data().lastReadAt?.toDate?.() || new Date(0);
          }
          
          // Escuchar cambios en la colección Textos
          const textsRef = collection(db, "Textos");
          const textsQuery = query(textsRef, orderBy("createdAt", "desc"));
          
          notificationsListener = onSnapshot(textsQuery, (snapshot) => {
            console.log("Cambio detectado en Textos. Total cambios:", snapshot.docChanges().length);
            
            let hasNewNotification = false;
            let latestTimestamp = lastReadTimestamp;
            
            snapshot.docChanges().forEach((change) => {
              if (change.type === "added") {
                console.log("Texto añadido:", change.doc.id);
                
                const newText = {
                  id: change.doc.id,
                  ...change.doc.data()
                };
                
                // Verificar si es para este colaborador
                if (isTextForCollaborator(newText)) {
                  console.log("Texto es para este colaborador");
                  
                  // Verificar si es más reciente que la última lectura
                  const textTimestamp = newText.createdAt?.toDate?.() || new Date();
                  
                  if (textTimestamp > lastReadTimestamp) {
                    console.log("Nueva notificación no leída");
                    
                    // Mostrar notificación
                    showNotification(newText);
                    
                    // Incrementar contador
                    unreadNotifications++;
                    hasNewNotification = true;
                    
                    // Actualizar timestamp más reciente
                    if (textTimestamp > latestTimestamp) {
                      latestTimestamp = textTimestamp;
                    }
                    
                    // Agregar a array
                    currentNotifications.push({
                      ...newText,
                      isRead: false,
                      timestamp: textTimestamp
                    });
                  }
                }
              }
            });
            
            if (hasNewNotification) {
              updateNotificationBadge();
            }
          }, (error) => {
            console.error('Error en listener de notificaciones:', error);
          });
        })
        .catch(error => {
          console.error('Error obteniendo última lectura:', error);
        });
    }
    
    // Configurar evento para el icono de notificaciones
    notificationIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      
      console.log("Icono de notificación clickeado");
      
      // Marcar todas las notificaciones como leídas
      markNotificationAsRead();
      
      // Redirigir a la página de novedades en la MISMA pestaña
      window.location.href = 'novedad-cliente.html';
    });
    
    // Estilos CSS para animaciones
    const notificationStyles = document.createElement('style');
    notificationStyles.textContent = `
      @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        50% { transform: scale(1.1); box-shadow: 0 3px 12px rgba(0,0,0,0.4); }
        100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      .notification-toast {
        animation: slideInRight 0.3s ease;
      }
      
      /* Asegurar que no interfiera con la barra inferior en móvil */
      @media (max-width: 768px) {
        #notificationIcon {
          top: 70px !important;
          right: 15px !important;
        }
        
        .notification-toast {
          top: 60px !important;
          right: 15px !important;
          max-width: 250px !important;
        }
      }
      
      /* En pantallas muy pequeñas, asegurar posición */
      @media (max-width: 480px) {
        #notificationIcon {
          top: 60px !important;
          right: 10px !important;
          width: 35px !important;
          height: 35px !important;
        }
        
        #notificationIcon i {
          font-size: 16px !important;
        }
        
        #notificationBadge {
          width: 16px !important;
          height: 16px !important;
          font-size: 9px !important;
          top: -2px !important;
          right: -2px !important;
        }
      }
    `;
    document.head.appendChild(notificationStyles);
    
    // ====================================================================
    // FIN SISTEMA DE NOTIFICACIONES CORREGIDO
    // ====================================================================

    // DOM Elements
    const loginScreen = document.getElementById('loginScreen');
    const posScreen = document.getElementById('posScreen');
    const mobileUsername = document.getElementById('mobileUsername');
    const mobilePin = document.getElementById('mobilePin');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const loginError = document.getElementById('loginError');
    const loginLogo = document.getElementById('loginLogo');
    
    const productsGrid = document.getElementById('productsGrid');
    const invoiceItemsMobile = document.getElementById('invoiceItemsMobile');
    const totalAmountMobile = document.getElementById('totalAmountMobile');
    const usdTotalMobile = document.getElementById('usdTotalMobile');
    const eurTotalMobile = document.getElementById('eurTotalMobile');
    const realTimeTotalContainer = document.getElementById('realTimeTotalContainer');
    const realTimeTotalAmount = document.getElementById('realTimeTotalAmount');
    
    const mobileSearch = document.getElementById('mobileSearch');
    const scannerBtnMobile = document.getElementById('scannerBtnMobile');
    const viewGridMobile = document.getElementById('viewGridMobile');
    const viewListMobile = document.getElementById('viewListMobile');
    const closeInvoiceBtn = document.getElementById('closeInvoiceBtn');
    const invoiceSection = document.getElementById('invoiceSection');
    
    const discountBtnMobile = document.getElementById('discountBtnMobile');
    const cashBtnMobile = document.getElementById('cashBtnMobile');
    const cardBtnMobile = document.getElementById('cardBtnMobile');
    const invoiceBtnMobile = document.getElementById('invoiceBtnMobile');
    
    const navProducts = document.getElementById('navProducts');
    const navInvoice = document.getElementById('navInvoice');
    const navHistory = document.getElementById('navHistory');
    const navReports = document.getElementById('navReports');
    const navMenu = document.getElementById('navMenu');
    const invoiceBadge = document.getElementById('invoiceBadge');
    
    const userBtnMobile = document.getElementById('userBtnMobile');
    const shiftBtnMobile = document.getElementById('shiftBtnMobile');
    const reportBtnMobile = document.getElementById('reportBtnMobile');
    const userAvatarMobile = document.getElementById('userAvatarMobile');
    const headerLogoMobile = document.getElementById('headerLogoMobile');
    const menuHamburgerBtn = document.getElementById('menuHamburgerBtn');
    
    // Ventana de cantidad
    const quantityModal = document.getElementById('quantityModal');
    const quantityProductName = document.getElementById('quantityProductName');
    const quantityProductPrice = document.getElementById('quantityProductPrice');
    const quantityDisplay = document.getElementById('quantityDisplay');
    const quantityDecrease = document.getElementById('quantityDecrease');
    const quantityIncrease = document.getElementById('quantityIncrease');
    const quantityCancel = document.getElementById('quantityCancel');
    const quantityAdd = document.getElementById('quantityAdd');
    
    // Config - Ventana de cantidad
    const toggleQuantityWindow = document.getElementById('toggleQuantityWindow');
    
    // NUEVO: Modal para unidades variables
    const unitModal = document.createElement('div');
    unitModal.id = 'unitModal';
    unitModal.className = 'modal-mobile';
    unitModal.innerHTML = `
      <div class="modal-content-mobile" style="max-width: 400px;">
        <div class="modal-header">
          <h3 id="unitModalTitle">Seleccionar Cantidad</h3>
          <button class="close-modal" id="closeUnitModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="unit-product-info" style="text-align: center; margin-bottom: 15px;">
            <h4 id="unitProductName">Producto</h4>
            <p id="unitProductPrice" style="color: #16e086; font-weight: bold; font-size: 16px;">$0.00</p>
          </div>
          
          <div class="unit-options" style="margin-bottom: 15px;">
            <h5 style="margin-bottom: 10px;">Seleccionar Unidad:</h5>
            <div id="unitOptionsContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
              <!-- Las opciones de unidad se generarán dinámicamente -->
            </div>
          </div>
          
          <div class="custom-quantity" style="margin-bottom: 15px;">
            <h5 style="margin-bottom: 10px;">Cantidad Personalizada:</h5>
            <div style="display: flex; align-items: center; gap: 10px;">
              <button id="unitDecrease" style="width: 40px; height: 40px; border-radius: 50%; background: #e74c3c; color: white; border: none; font-size: 18px;">-</button>
              <input type="number" id="unitCustomQuantity" value="1" min="0.01" step="0.01" style="flex: 1; padding: 10px; text-align: center; border: 2px solid #16e086; border-radius: 8px; font-size: 16px;">
              <button id="unitIncrease" style="width: 40px; height: 40px; border-radius: 50%; background: #16e086; color: white; border: none; font-size: 18px;">+</button>
            </div>
            <p style="text-align: center; margin-top: 5px; color: #666; font-size: 12px;">Ingrese la cantidad exacta que necesita</p>
          </div>
          
          <div class="unit-total" style="background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
            <h5>Total a Pagar:</h5>
            <h3 id="unitTotalPrice" style="color: #2c3e50; margin: 0;">$0.00</h3>
          </div>
          
          <div class="unit-actions" style="display: flex; gap: 10px;">
            <button id="unitCancel" style="flex: 1; padding: 12px; background: #7f8c8d; color: white; border: none; border-radius: 8px; font-weight: bold;">Cancelar</button>
            <button id="unitAddToCart" style="flex: 1; padding: 12px; background: #16e086; color: white; border: none; border-radius: 8px; font-weight: bold;">Agregar al Carrito</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(unitModal);
    
    // Elementos del modal de unidades
    const closeUnitModal = document.getElementById('closeUnitModal');
    const unitModalTitle = document.getElementById('unitModalTitle');
    const unitProductName = document.getElementById('unitProductName');
    const unitProductPrice = document.getElementById('unitProductPrice');
    const unitOptionsContainer = document.getElementById('unitOptionsContainer');
    const unitCustomQuantity = document.getElementById('unitCustomQuantity');
    const unitDecrease = document.getElementById('unitDecrease');
    const unitIncrease = document.getElementById('unitIncrease');
    const unitTotalPrice = document.getElementById('unitTotalPrice');
    const unitCancel = document.getElementById('unitCancel');
    const unitAddToCart = document.getElementById('unitAddToCart');

    // Modales
    const userInfoModal = document.getElementById('userInfoModal');
    const userInfoContent = document.getElementById('userInfoContent');
    const closeUserInfoModal = document.getElementById('closeUserInfoModal');
    
    const profileCarrotIcon = document.getElementById('profileCarrotIcon');
    const profileAvatar = document.getElementById('profileAvatar');
    const profileName = document.getElementById('profileName');
    const profileRole = document.getElementById('profileRole');
    const profileUsername = document.getElementById('profileUsername');
    const profileUserId = document.getElementById('profileUserId');
    const profileFullName = document.getElementById('profileFullName');
    const profileShift = document.getElementById('profileShift');
    const logoutBtn = document.getElementById('logoutBtn');
    
    const cashModal = document.getElementById('cashModal');
    const cashTotalAmount = document.getElementById('cashTotalAmount');
    const cashReceivedDisplay = document.getElementById('cashReceivedDisplay');
    const cashChangeAmount = document.getElementById('cashChangeAmount');
    const cashReceivedInput = document.getElementById('cashReceivedInput');
    const cashClearBtn = document.getElementById('cashClearBtn');
    const cashBackspaceBtn = document.getElementById('cashBackspaceBtn');
    const cashConfirmBtn = document.getElementById('cashConfirmBtn');
    const closeCashModal = document.getElementById('closeCashModal');
    
    const cardModal = document.getElementById('cardModal');
    const cardTotalAmount = document.getElementById('cardTotalAmount');
    const confirmCardBtn = document.getElementById('confirmCardBtn');
    const closeCardModal = document.getElementById('closeCardModal');
    
    const discountModal = document.getElementById('discountModal');
    const discountPasswordInput = document.getElementById('discountPasswordInput');
    const discountClearPasswordBtn = document.getElementById('discountClearPasswordBtn');
    const discountBackspaceBtn = document.getElementById('discountBackspaceBtn');
    const verifyDiscountBtn = document.getElementById('verifyDiscountBtn');
    const closeDiscountModal = document.getElementById('closeDiscountModal');
    
    const discountPercentageModal = document.getElementById('discountPercentageModal');
    const discountInput = document.getElementById('discountInput');
    const discountBackspaceBtn2 = document.getElementById('discountBackspaceBtn2');
    const discountClearBtn = document.getElementById('discountClearBtn');
    const applyDiscountBtn = document.getElementById('applyDiscountBtn');
    const closeDiscountPercentageModal = document.getElementById('closeDiscountPercentageModal');
    
    const scannerModal = document.getElementById('scannerModal');
    const scannerViewport = document.getElementById('scannerViewport');
    const closeScannerModal = document.getElementById('closeScannerModal');
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    const imageUploadInput = document.getElementById('imageUploadInput');
    
    const shiftModal = document.getElementById('shiftModal');
    const shiftUserName = document.getElementById('shiftUserName');
    const shiftName = document.getElementById('shiftName');
    const shiftStartTime = document.getElementById('shiftStartTime');
    const shiftEndTime = document.getElementById('shiftEndTime');
    const shiftTimeRemaining = document.getElementById('shiftTimeRemaining');
    const endShiftBtn = document.getElementById('endShiftBtn');
    const closeShiftModal = document.getElementById('closeShiftModal');
    
    const configModal = document.getElementById('configModal');
    const toggleRealTimeTotal = document.getElementById('toggleRealTimeTotal');
    const toggleLowStockNotifications = document.getElementById('toggleLowStockNotifications');
    const toggleExpirationAlerts = document.getElementById('toggleExpirationAlerts');
    const toggleAutoPrint = document.getElementById('toggleAutoPrint');
    const toggleAlwaysActiveSearch = document.getElementById('toggleAlwaysActiveSearch');
    const toggleAutoClearSearch = document.getElementById('toggleAutoClearSearch');
    const toggleShiftMode = document.getElementById('toggleShiftMode');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const closeConfigModal = document.getElementById('closeConfigModal');
    
    const historyModal = document.getElementById('historyModal');
    const historyContainer = document.getElementById('historyContainer');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    
    const reportsModal = document.getElementById('reportsModal');
    const salesChart = document.getElementById('salesChart');
    const paymentMethodsChart = document.getElementById('paymentMethodsChart');
    const todaySales = document.getElementById('todaySales');
    const todayTransactions = document.getElementById('todayTransactions');
    const avgTicket = document.getElementById('avgTicket');
    const topProduct = document.getElementById('topProduct');
    const closeReportsModal = document.getElementById('closeReportsModal');
    
    const menuModal = document.getElementById('menuModal');
    const menuInventory = document.getElementById('menuInventory');
    const menuReportsMain = document.getElementById('menuReportsMain');
    const menuInvoices = document.getElementById('menuInvoices');
    const menuAnalysis = document.getElementById('menuAnalysis');
    const menuConfigMain = document.getElementById('menuConfigMain');
    const closeMenuModal = document.getElementById('closeMenuModal');
    
    const printModal = document.getElementById('printModal');
    const invoicePrintContent = document.getElementById('invoicePrintContent');
    const closePrintModal = document.getElementById('closePrintModal');
    const sendInvoiceBtn = document.getElementById('sendInvoiceBtn');
    const printInvoiceBtn = document.getElementById('printInvoiceBtn');
    
    const sendInvoiceModal = document.getElementById('sendInvoiceModal');
    const whatsappNumber = document.getElementById('whatsappNumber');
    const sendWhatsAppBtn = document.getElementById('sendWhatsAppBtn');
    const copyInvoiceBtn = document.getElementById('copyInvoiceBtn');
    const closeSendInvoiceModal = document.getElementById('closeSendInvoiceModal');
    
    const shiftEndModal = document.getElementById('shiftEndModal');
    const shiftEndMessage = document.getElementById('shiftEndMessage');
    const changeAccountBtn = document.getElementById('changeAccountBtn');
    const reloadPageBtn = document.getElementById('reloadPageBtn');
    
    const toastNotification = document.getElementById('toastNotification');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    // CORRECCIÓN: Variables para los botones de teclado numérico
    const allNumButtons = document.querySelectorAll('.num-btn[data-value]');

    // ====================================================================
    // TABLA DE CONVERSIONES CORREGIDA - CON FACTORES DE CONVERSIÓN CORRECTOS
    // ====================================================================

    // Tabla de conversiones para unidades comunes - CORREGIDA COMPLETAMENTE
    const unitConversions = {
        'Libras': {
            baseUnit: 'Libras',
            conversions: {
                'Onzas': 16,           // 1 Libra = 16 Onzas
                'Kilogramos': 0.453592, // 1 Libra = 0.453592 Kg
                'Gramos': 453.592,     // 1 Libra = 453.592 g
                'Quintal': 0.01,       // 1 Libra = 0.01 Quintal (100 lb)
                'Media Libra': 0.5,     // Media Libra = 0.5 Libras
                'Cuarto de Libra': 0.25, // Cuarto de Libra = 0.25 Libras
                '3/4 Libra': 0.75      // 3/4 Libra = 0.75 Libras
            }
        },
        'Onzas': {
            baseUnit: 'Onzas',
            conversions: {
                'Libras': 0.0625,      // 1 Onza = 0.0625 Libras
                'Kilogramos': 0.0283495, // 1 Onza = 0.0283495 Kg
                'Gramos': 28.3495,     // 1 Onza = 28.3495 g
                'Media Onza': 0.5,     // Media Onza = 0.5 Onzas
                'Cuarto de Onza': 0.25, // Cuarto de Onza = 0.25 Onzas
                '3/4 Onza': 0.75       // 3/4 Onza = 0.75 Onzas
            }
        },
        'Kilogramos': {
            baseUnit: 'Kilogramos',
            conversions: {
                'Libras': 2.20462,     // 1 Kg = 2.20462 Libras
                'Onzas': 35.274,       // 1 Kg = 35.274 Onzas
                'Gramos': 1000,        // 1 Kg = 1000 g
                'Quintal': 0.01,       // 1 Kg = 0.01 Quintal (100 kg)
                'Medio Kilo': 0.5,     // Medio Kilo = 0.5 Kg
                'Cuarto de Kilo': 0.25, // Cuarto de Kilo = 0.25 Kg
                '3/4 Kilo': 0.75       // 3/4 Kilo = 0.75 Kg
            }
        },
        'Gramos': {
            baseUnit: 'Gramos',
            conversions: {
                'Libras': 0.00220462,  // 1 g = 0.00220462 Libras
                'Onzas': 0.035274,     // 1 g = 0.035274 Onzas
                'Kilogramos': 0.001,   // 1 g = 0.001 Kg
                'Quintal': 0.00001,    // 1 g = 0.00001 Quintal
                'Medio Gramo': 0.5,    // Medio Gramo = 0.5 g
                'Cuarto de Gramo': 0.25, // Cuarto de Gramo = 0.25 g
                '3/4 Gramo': 0.75      // 3/4 Gramo = 0.75 g
            }
        },
        'Galón': {
            baseUnit: 'Galón',
            conversions: {
                'Litro': 3.78541,      // 1 Galón = 3.78541 Litros
                'Mililitro': 3785.41,  // 1 Galón = 3785.41 ml
                'Cuarto de Galón': 0.25, // Cuarto de Galón = 0.25 Galones
                'Medio Galón': 0.5,    // Medio Galón = 0.5 Galones
                '3/4 Galón': 0.75      // 3/4 Galón = 0.75 Galones
            }
        },
        'Litro': {
            baseUnit: 'Litro',
            conversions: {
                'Galón': 0.264172,     // 1 L = 0.264172 Galones
                'Mililitro': 1000,     // 1 L = 1000 ml
                'Medio Litro': 0.5,    // Medio Litro = 0.5 Litros
                'Cuarto de Litro': 0.25, // Cuarto de Litro = 0.25 Litros
                '3/4 Litro': 0.75      // 3/4 Litro = 0.75 Litros
            }
        },
        'Quintal': {
            baseUnit: 'Quintal',
            conversions: {
                'Libras': 100,         // 1 Quintal = 100 Libras
                'Kilogramos': 100,     // 1 Quintal = 100 Kg
                'Gramos': 100000,      // 1 Quintal = 100,000 g
                'Medio Quintal': 0.5,  // Medio Quintal = 0.5 Quintales
                'Cuarto de Quintal': 0.25, // Cuarto de Quintal = 0.25 Quintales
                '3/4 Quintal': 0.75    // 3/4 Quintal = 0.75 Quintales
            }
        },
        'Metro': {
            baseUnit: 'Metro',
            conversions: {
                'Centímetro': 100,     // 1 m = 100 cm
                'Pulgada': 39.3701,    // 1 m = 39.3701 in
                'Pie': 3.28084,        // 1 m = 3.28084 ft
                'Medio Metro': 0.5,    // Medio Metro = 0.5 m
                'Cuarto de Metro': 0.25, // Cuarto de Metro = 0.25 m
                '3/4 Metro': 0.75      // 3/4 Metro = 0.75 m
            }
        },
        'Fardo': {
            baseUnit: 'Fardo',
            conversions: {
                'Unidad': 1,           // 1 Fardo = 1 Unidad
                'Medio Fardo': 0.5,    // Medio Fardo = 0.5 Fardos
                'Cuarto de Fardo': 0.25, // Cuarto de Fardo = 0.25 Fardos
                '3/4 Fardo': 0.75      // 3/4 Fardo = 0.75 Fardos
            }
        }
    };

    // ====================================================================
    // NUEVAS FUNCIONES PARA VENTA POR UNIDADES VARIABLES - CORREGIDAS COMPLETAMENTE
    // ====================================================================

    // NUEVA FUNCIÓN: Detectar si un producto necesita venta por unidades variables
    function requiresVariableUnit(product) {
        const variableUnits = ['Libras', 'Onzas', 'Kilogramos', 'Gramos', 'Galón', 'Litro', 'Quintal', 'Metro', 'Fardo'];
        return variableUnits.includes(product.unit);
    }

    // NUEVA FUNCIÓN: Mostrar modal para unidades variables
    function showVariableUnitModal(product, businessName, productId) {
        if (!product || !businessName || !productId) return;
        
        currentProductForVariableUnit = { product, businessName, productId };
        unitModalOpen = true;
        
        // Configurar información del producto
        unitModalTitle.textContent = `Vender por ${product.unit || 'Unidad'}`;
        unitProductName.textContent = product.name;
        unitProductPrice.textContent = `${formatCurrency(product.pricePerUnit)}/${product.unit || 'unidad'}`;
        
        // Generar opciones de conversión
        generateUnitOptions(product.unit);
        
        // Configurar cantidad personalizada
        unitCustomQuantity.value = "1.00";
        unitConversionData.customQuantity = 1;
        
        // Calcular precio inicial
        calculateUnitTotal();
        
        // Mostrar modal
        unitModal.style.display = 'flex';
    }

    // NUEVA FUNCIÓN: Generar opciones de conversión de unidades
    function generateUnitOptions(baseUnit) {
        unitOptionsContainer.innerHTML = '';
        unitConversionData.conversionOptions = [];
        
        // Opción 1: Unidad base completa (ej: 1 Libra)
        addUnitOption('1 ' + baseUnit, 1, baseUnit);
        
        // Opción 2: Media unidad (ej: 1/2 Libra)
        addUnitOption('1/2 ' + baseUnit, 0.5, 'Media ' + baseUnit);
        
        // Opción 3: Cuarto de unidad (ej: 1/4 Libra)
        addUnitOption('1/4 ' + baseUnit, 0.25, 'Cuarto de ' + baseUnit);
        
        // Opción 4: Tres cuartos (ej: 3/4 Libra)
        addUnitOption('3/4 ' + baseUnit, 0.75, '3/4 ' + baseUnit);
        
        // Opciones de conversión según la tabla - CORREGIDAS
        if (unitConversions[baseUnit]) {
            const conversions = unitConversions[baseUnit].conversions;
            for (const [targetUnit, factor] of Object.entries(conversions)) {
                // Solo agregar conversiones a otras unidades (no fracciones)
                if (!targetUnit.includes('Media') && 
                    !targetUnit.includes('Cuarto') && 
                    !targetUnit.includes('3/4') &&
                    !targetUnit.includes('Medio')) {
                    
                    // Si es una unidad diferente, mostrar como "1 [unidad base] = X [targetUnit]"
                    if (factor !== 1) {
                        const displayLabel = `1 ${baseUnit} = ${factor} ${targetUnit}`;
                        addUnitOption(displayLabel, factor, targetUnit);
                    }
                }
            }
        }
        
        // Seleccionar primera opción por defecto
        if (unitConversionData.conversionOptions.length > 0) {
            selectUnitOption(0);
        }
    }

    // NUEVA FUNCIÓN: Agregar opción de unidad al contenedor
    function addUnitOption(label, multiplier, unitName) {
        const optionIndex = unitConversionData.conversionOptions.length;
        unitConversionData.conversionOptions.push({
            label,
            multiplier,
            unitName
        });
        
        const optionElement = document.createElement('div');
        optionElement.className = 'unit-option';
        optionElement.style.cssText = `
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        `;
        optionElement.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">${label}</div>
            <div style="font-size: 12px; color: #666;">${formatCurrency(currentProductForVariableUnit.product.pricePerUnit * multiplier)}</div>
        `;
        
        optionElement.addEventListener('click', () => selectUnitOption(optionIndex));
        unitOptionsContainer.appendChild(optionElement);
    }

    // NUEVA FUNCIÓN: Seleccionar opción de unidad
    function selectUnitOption(index) {
        // Remover selección anterior
        document.querySelectorAll('.unit-option').forEach((option, i) => {
            if (i === index) {
                option.style.borderColor = '#16e086';
                option.style.background = 'rgba(22, 224, 134, 0.1)';
                option.style.transform = 'scale(1.02)';
            } else {
                option.style.borderColor = '#ddd';
                option.style.background = 'white';
                option.style.transform = 'scale(1)';
            }
        });
        
        unitConversionData.selectedOption = index;
        calculateUnitTotal();
    }

    // NUEVA FUNCIÓN: Calcular total para unidades variables - CORREGIDA
    function calculateUnitTotal() {
        if (!currentProductForVariableUnit) return;
        
        const product = currentProductForVariableUnit.product;
        const selectedOption = unitConversionData.conversionOptions[unitConversionData.selectedOption];
        const customQuantity = parseFloat(unitCustomQuantity.value) || 1;
        
        if (selectedOption) {
            // Para unidades diferentes, necesitamos calcular la cantidad en la unidad base
            let quantityInBaseUnit = customQuantity;
            let displayUnit = selectedOption.unitName;
            
            // Si la unidad seleccionada es diferente a la unidad base, calcular conversión
            if (selectedOption.unitName !== product.unit) {
                // El multiplicador es cuántas unidades base equivalen a 1 unidad seleccionada
                // Ejemplo: 1 Libra = 16 Onzas, entonces multiplier = 16
                // Si selecciono 2 Onzas, necesito convertir a Libras: 2 Onzas = 2 / 16 = 0.125 Libras
                quantityInBaseUnit = customQuantity / selectedOption.multiplier;
            }
            
            const totalPrice = product.pricePerUnit * quantityInBaseUnit;
            
            unitTotalPrice.textContent = formatCurrency(totalPrice);
            unitConversionData.quantity = quantityInBaseUnit; // Guardar en unidad base
            unitConversionData.unit = selectedOption.unitName;
            unitConversionData.quantityInSelectedUnit = customQuantity; // Guardar cantidad en unidad seleccionada
            unitConversionData.multiplier = selectedOption.multiplier;
        }
    }

    // ====================================================================
    // FUNCIÓN CORREGIDA PARA AGREGAR PRODUCTOS CON UNIDADES VARIABLES AL CARRITO
    // ====================================================================
    function addVariableUnitToCart() {
        if (!currentProductForVariableUnit) return;
        
        const { product, businessName, productId } = currentProductForVariableUnit;
        const quantityInBaseUnit = unitConversionData.quantity;
        const selectedUnit = unitConversionData.unit;
        const quantityInSelectedUnit = unitConversionData.quantityInSelectedUnit || quantityInBaseUnit;
        
        // Verificar stock disponible - CORRECCIÓN IMPORTANTE
        // El stock está en la unidad base del producto
        const stockInBaseUnit = product.quantity;
        
        if (stockInBaseUnit < quantityInBaseUnit) {
            const stockInSelectedUnit = convertToSelectedUnit(stockInBaseUnit, product.unit, selectedUnit);
            showToast(`Stock insuficiente. Disponible: ${formatNumber(stockInSelectedUnit)} ${selectedUnit}`, 'error');
            return;
        }
        
        // Buscar si ya existe el mismo producto en el carrito con la misma unidad seleccionada
        const existingItemIndex = invoice.findIndex(item => 
            item.productId === productId && 
            item.businessName === businessName &&
            item.selectedUnit === selectedUnit // Verificar por unidad seleccionada específica
        );
        
        if (existingItemIndex >= 0) {
            // Actualizar cantidad existente - sumar en unidad base
            const newQuantityInBaseUnit = invoice[existingItemIndex].quantityInBaseUnit + quantityInBaseUnit;
            
            if (newQuantityInBaseUnit > stockInBaseUnit) {
                const availableInSelectedUnit = convertToSelectedUnit(stockInBaseUnit - invoice[existingItemIndex].quantityInBaseUnit, product.unit, selectedUnit);
                showToast(`Stock insuficiente. Puede agregar: ${formatNumber(availableInSelectedUnit)} ${selectedUnit} más`, 'error');
                return;
            }
            
            // Actualizar cantidades
            invoice[existingItemIndex].quantityInBaseUnit = newQuantityInBaseUnit;
            invoice[existingItemIndex].quantityInSelectedUnit = invoice[existingItemIndex].quantityInSelectedUnit + quantityInSelectedUnit;
            
            // Recalcular cantidad total para display
            invoice[existingItemIndex].quantity = newQuantityInBaseUnit;
            
            showToast(`Agregado: ${formatNumber(quantityInSelectedUnit)} ${selectedUnit} de ${product.name}`, 'success');
        } else {
            // Agregar nuevo item con toda la información necesaria
            const cartItem = {
                ...product,
                businessName,
                productId,
                quantity: quantityInBaseUnit, // Cantidad en unidad base para cálculos
                quantityInBaseUnit: quantityInBaseUnit, // Cantidad exacta en unidad base
                quantityInSelectedUnit: quantityInSelectedUnit, // Cantidad en unidad seleccionada
                selectedUnit: selectedUnit, // Unidad seleccionada por el usuario
                originalUnit: product.unit, // Unidad base del producto
                variableUnitSale: true, // Marcar como venta por unidad variable
                pricePerUnit: product.pricePerUnit, // Precio por unidad base
                conversionMultiplier: unitConversionData.multiplier || 1 // Factor de conversión
            };
            invoice.push(cartItem);
            
            showToast(`${formatNumber(quantityInSelectedUnit)} ${selectedUnit} de ${product.name} agregado(s)`, 'success');
        }
        
        updateInvoiceDisplay();
        closeVariableUnitModal();
        updateRealTimeData();
    }

    // Función auxiliar para convertir de unidad base a unidad seleccionada
    function convertToSelectedUnit(quantityInBaseUnit, baseUnit, targetUnit) {
        if (baseUnit === targetUnit) return quantityInBaseUnit;
        
        if (unitConversions[baseUnit] && unitConversions[baseUnit].conversions[targetUnit]) {
            const multiplier = unitConversions[baseUnit].conversions[targetUnit];
            // multiplier es cuántas unidades target equivalen a 1 unidad base
            return quantityInBaseUnit * multiplier;
        }
        
        return quantityInBaseUnit;
    }

    // NUEVA FUNCIÓN: Cerrar modal de unidades variables
    function closeVariableUnitModal() {
        unitModal.style.display = 'none';
        currentProductForVariableUnit = null;
        unitModalOpen = false;
        unitConversionData = {
            unit: '',
            quantity: 1,
            customQuantity: 1,
            conversionOptions: [],
            selectedOption: 0
        };
    }

    // ====================================================================
    // FUNCIÓN CORREGIDA PARA ELIMINAR PRODUCTOS DE LA FACTURA - CON UNIDADES VARIABLES
    // ====================================================================
    function removeFromInvoice(productId, businessName, unit = null) {
        const index = invoice.findIndex(item => 
            item.productId === productId && 
            item.businessName === businessName &&
            (unit ? item.selectedUnit === unit : true) // Si se especifica unidad, verificar unidad seleccionada
        );
        
        if (index !== -1) {
            const item = invoice[index];
            
            // CORRECCIÓN: Reducir en 1 unidad de la unidad seleccionada
            if (item.quantityInSelectedUnit > 1) {
                // Para productos con unidades variables, reducir en la unidad seleccionada
                if (item.variableUnitSale) {
                    // Reducir 1 unidad de la unidad seleccionada
                    const reductionInBaseUnit = 1 / (item.conversionMultiplier || 1);
                    
                    // Verificar que no reduzca por debajo de 0
                    if (item.quantityInBaseUnit - reductionInBaseUnit > 0) {
                        invoice[index].quantityInSelectedUnit -= 1;
                        invoice[index].quantityInBaseUnit -= reductionInBaseUnit;
                        invoice[index].quantity = invoice[index].quantityInBaseUnit;
                        
                        showToast(`Eliminado: 1 ${item.selectedUnit} de ${item.name}`, 'info');
                    } else {
                        // Si al reducir quedaría en 0, eliminar completamente
                        invoice.splice(index, 1);
                        showToast(`${item.name} eliminado de la factura`, 'info');
                    }
                } else {
                    // Para productos normales
                    invoice[index].quantity -= 1;
                    showToast(`Eliminado: 1 ${item.unit || 'unidad'} de ${item.name}`, 'info');
                }
            } else {
                // Si solo queda 1, eliminar completamente
                invoice.splice(index, 1);
                showToast(`${item.name} eliminado de la factura`, 'info');
            }
        } else {
            // Si no encuentra con unidad específica, buscar sin unidad (para compatibilidad)
            const fallbackIndex = invoice.findIndex(item => 
                item.productId === productId && 
                item.businessName === businessName
            );
            
            if (fallbackIndex !== -1) {
                const item = invoice[fallbackIndex];
                
                if (item.quantity > 1) {
                    invoice[fallbackIndex].quantity -= 1;
                    showToast(`Eliminado: 1 ${item.unit || 'unidad'} de ${item.name}`, 'info');
                } else {
                    invoice.splice(fallbackIndex, 1);
                    showToast(`${item.name} eliminado de la factura`, 'info');
                }
            } else {
                showToast('Producto no encontrado en la factura', 'error');
                return;
            }
        }
        
        updateInvoiceDisplay();
        updateRealTimeData();
    }

    // ====================================================================
    // FUNCIÓN CORREGIDA PARA ACTUALIZAR LA FACTURA - CON UNIDADES ESPECÍFICAS
    // ====================================================================
    function updateInvoiceDisplay() {
        invoiceItemsMobile.innerHTML = '';
        totalPrice = 0;
        
        // Usar un Set para evitar duplicados en la visualización
        const displayedItems = new Set();
        
        invoice.forEach(item => {
            const itemKey = `${item.businessName}_${item.productId}_${item.name}_${item.selectedUnit || ''}`;
            if (displayedItems.has(itemKey)) {
                return; // Saltar duplicados
            }
            displayedItems.add(itemKey);
            
            let itemPrice = item.pricePerUnit;
            if (taxConfig.active) {
                if (item.applyItbis) {
                    itemPrice += itemPrice * (taxConfig.itbis / 100);
                }
                if (item.applyIva) {
                    itemPrice += itemPrice * (taxConfig.iva / 100);
                }
            }
            
            // Para productos con unidades variables, usar la cantidad en unidad base para calcular el precio
            const quantityForCalculation = item.quantity;
            const totalItemPrice = itemPrice * quantityForCalculation;
            totalPrice += totalItemPrice;
            
            // Determinar qué unidad mostrar
            let displayUnit = item.unit || 'unidad';
            let displayQuantity = item.quantity;
            
            if (item.variableUnitSale && item.selectedUnit) {
                displayUnit = item.selectedUnit;
                displayQuantity = item.quantityInSelectedUnit || item.quantity;
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            
            itemDiv.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-details">
                        <span>${formatNumber(displayQuantity)} ${displayUnit} x ${formatCurrency(itemPrice)}</span>
                        ${taxConfig.active && (item.applyItbis || item.applyIva) ? '<span><i class="fas fa-percent"></i> Impuestos</span>' : ''}
                        ${item.variableUnitSale ? '<span><i class="fas fa-balance-scale"></i> Venta por Peso</span>' : ''}
                    </div>
                </div>
                <div class="item-price">${formatCurrency(totalItemPrice)}</div>
                <button class="remove-btn-mobile" 
                        onclick="removeFromInvoice('${item.productId}', '${item.businessName}', '${item.selectedUnit || ''}')">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            invoiceItemsMobile.appendChild(itemDiv);
        });
        
        if (invoice.length === 0) {
            invoiceItemsMobile.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);"><i class="fas fa-receipt" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay productos en la factura</p></div>';
        }
        
        discountedTotal = discount > 0 ? totalPrice - (totalPrice * discount / 100) : totalPrice;
        
        totalAmountMobile.textContent = formatCurrency(discountedTotal);
        cashTotalAmount.textContent = formatCurrency(discountedTotal);
        cardTotalAmount.textContent = formatCurrency(discountedTotal);
        
        updateCurrencyTotals();
        invoiceBadge.textContent = invoice.length;
        
        invoiceBtnMobile.disabled = invoice.length === 0;
        cashBtnMobile.disabled = invoice.length === 0;
        cardBtnMobile.disabled = invoice.length === 0;
        
        updateRealTimeTotal();
    }

    // Utility Functions
    function showLoading(message = 'Cargando...') {
      loadingText.textContent = message;
      loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    function showToast(message, type = 'success') {
      toastNotification.textContent = message;
      toastNotification.style.background = type === 'success' ? 'rgba(22, 224, 134, 0.9)' : 
                                          type === 'error' ? 'rgba(231, 76, 60, 0.9)' :
                                          'rgba(243, 156, 18, 0.9)';
      toastNotification.style.display = 'block';
      
      setTimeout(() => {
        toastNotification.style.display = 'none';
      }, 3000);
    }

    function formatNumber(num) {
      if (num % 1 !== 0) {
        // Número decimal, mostrar con 2 decimales
        return new Intl.NumberFormat('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 3
        }).format(num);
      } else {
        // Número entero, mostrar sin decimales
        return new Intl.NumberFormat('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(num);
      }
    }

    function formatCurrency(num) {
      return `$${formatNumber(num)}`;
    }

    function formatDate(date) {
      return new Date(date).toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // CORRECCIÓN: Función mejorada para generar ID único de factura con 5 dígitos y sin repeticiones
    function generateUniqueInvoiceId(collaboratorId) {
      // Generar un ID único basado en timestamp y colaborador
      const timestamp = Date.now().toString().slice(-6); // Últimos 6 dígitos del timestamp
      const randomNum = Math.floor(10000 + Math.random() * 90000); // Número aleatorio de 5 dígitos
      const collaboratorCode = collaboratorId ? collaboratorId.slice(-4) : '0000';
      
      // Tomar solo los últimos 5 dígitos del número aleatorio
      const uniqueNumber = randomNum.toString().slice(-5);
      
      // Formato: RTM-34256 (ejemplo)
      const invoiceId = `RTM-${uniqueNumber}`;
      
      // Incrementar el contador para el próximo ID
      invoiceCounter = (invoiceCounter + 1) % 100000; // Asegurar que sea de 5 dígitos
      
      return invoiceId;
    }

    // Check logo and set icon if not found
    function checkHeaderLogo() {
      const logoImage = new Image();
      logoImage.onload = function() {
        headerLogoMobile.innerHTML = '';
        headerLogoMobile.style.background = "url('logo.png') center/contain no-repeat";
        loginLogo.innerHTML = '';
        loginLogo.style.background = "url('logo.png') center/contain no-repeat";
      };
      logoImage.onerror = function() {
        headerLogoMobile.innerHTML = '<i class="fas fa-carrot"></i>';
        headerLogoMobile.style.background = '';
        loginLogo.innerHTML = '<i class="fas fa-carrot"></i>';
        loginLogo.style.background = '';
      };
      logoImage.src = 'logo.png';
    }

    // CORRECCIÓN: Función para generar ID de perfil único por colaborador
    function generateUniqueProfileId(collaborator) {
      if (!collaborator) return 'RTM-00000';
      
      // Usar el userId del colaborador para crear un ID único
      const userId = collaborator.userId || collaborator.id;
      const timestamp = Date.now();
      
      // Crear un hash simple del userId
      let hash = 0;
      for (let i = 0; i < userId.length; i++) {
        hash = ((hash << 5) - hash) + userId.charCodeAt(i);
        hash = hash & hash;
      }
      
      // Tomar los últimos 5 dígitos del hash
      const uniqueNumber = Math.abs(hash % 100000).toString().padStart(5, '0');
      
      return `RTM-${uniqueNumber}`;
    }

    // Authentication
    async function authenticateCollaborator(username, pin) {
      try {
        showLoading('Verificando credenciales...');
        
        const collaboratorsQuery = query(
          collection(db, "Collaborators"),
          where("username", "==", username),
          where("pin", "==", pin)
        );
        
        const snapshot = await getDocs(collaboratorsQuery);
        
        if (snapshot.empty) {
          loginError.style.display = 'block';
          hideLoading();
          return false;
        }
        
        const collaboratorDoc = snapshot.docs[0];
        currentCollaborator = {
          id: collaboratorDoc.id,
          ...collaboratorDoc.data()
        };
        
        // CORRECCIÓN: Generar ID único para el perfil
        currentCollaborator.uniqueProfileId = generateUniqueProfileId(currentCollaborator);
        
        // Save to localStorage
        localStorage.setItem('collaboratorLoggedIn', 'true');
        localStorage.setItem('collaboratorData', JSON.stringify(currentCollaborator));
        
        hideLoading();
        return true;
        
      } catch (error) {
        console.error('Authentication error:', error);
        hideLoading();
        showToast('Error de conexión', 'error');
        return false;
      }
    }

    // CORRECCIÓN: Función logout mejorada para cerrar el modal
    function logoutCollaborator() {
      // Cerrar el modal de perfil si está abierto
      userInfoModal.style.display = 'none';
      
      // Limpiar datos
      currentCollaborator = null;
      localStorage.removeItem('collaboratorLoggedIn');
      localStorage.removeItem('collaboratorData');
      
      // Mostrar pantalla de login
      loginScreen.style.display = 'flex';
      posScreen.style.display = 'none';
      
      // Limpiar factura
      invoice = [];
      updateInvoiceDisplay();
      
      // Limpiar timers y listeners
      if (shiftTimer) clearInterval(shiftTimer);
      if (shiftEndTimer) clearTimeout(shiftEndTimer);
      if (autoClearSearchTimeout) clearTimeout(autoClearSearchTimeout);
      if (realTimeInvoiceListener) realTimeInvoiceListener();
      if (realTimeTotalListener) realTimeTotalListener();
      
      // CORRECCIÓN: Eliminar listener de notificaciones
      if (notificationsListener) {
        notificationsListener();
        notificationsListener = null;
      }
      
      // Ocultar icono de notificación
      notificationIcon.style.display = 'none';
      notificationBadge.style.display = 'none';
      
      // CORRECCIÓN: Resetear contador de facturas
      invoiceCounter = 10000;
      
      showToast('Sesión cerrada exitosamente', 'success');
    }

    // Load Collaborator Data
    async function loadCollaboratorData() {
      try {
        showLoading('Cargando datos...');
        
        // Load tax configuration
        await loadTaxConfig();
        
        // Load business details
        const businessRef = doc(db, "businessDetails", currentCollaborator.userId);
        const businessDoc = await getDoc(businessRef);
        if (businessDoc.exists()) {
          businessDetails = businessDoc.data();
        } else {
          businessDetails = {
            name: "ZANARA POS",
            rnc: "123456789",
            address: "Dirección de la empresa",
            phone: "809-123-4567",
            email: "info@zanarapos.com",
            regimen: "Regimen General",
            comprobante: "Factura de Crédito Fiscal",
            ncf: "B0100000001",
            ncfVencimiento: "",
            logoUrl: "logo.png",
            qrUrl: ""
          };
        }
        
        // Load discount settings
        const discountRef = doc(db, "discountSettings", currentCollaborator.userId);
        const discountDoc = await getDoc(discountRef);
        if (discountDoc.exists()) {
          discountSettings = discountDoc.data();
        } else {
          discountSettings = {
            percentage: 10,
            password: "123456",
            activo: false,
            userId: currentCollaborator.userId
          };
        }
        
        // Load exchange rates
        await loadExchangeRates();
        
        // Load user config
        const configRef = doc(db, "userConfig", currentCollaborator.userId);
        const configDoc = await getDoc(configRef);
        if (configDoc.exists()) {
          const config = configDoc.data();
          showRealTimeTotal = config.showRealTimeTotal || false;
          toggleRealTimeTotal.checked = showRealTimeTotal;
          toggleLowStockNotifications.checked = config.lowStockNotifications || false;
          toggleExpirationAlerts.checked = config.expirationAlerts || false;
          toggleAutoPrint.checked = config.autoPrint || false;
          toggleAlwaysActiveSearch.checked = config.alwaysActiveSearch !== undefined ? config.alwaysActiveSearch : true;
          toggleAutoClearSearch.checked = config.autoClearSearch !== undefined ? config.autoClearSearch : true;
          toggleShiftMode.checked = config.shiftMode !== undefined ? config.shiftMode : true;
          quantityWindowEnabled = config.quantityWindow || false;
          toggleQuantityWindow.checked = quantityWindowEnabled;
          
          alwaysActiveSearchEnabled = toggleAlwaysActiveSearch.checked;
          autoClearSearchEnabled = toggleAutoClearSearch.checked;
          shiftModeEnabled = toggleShiftMode.checked;
          quantityWindowEnabled = toggleQuantityWindow.checked;
        }
        
        // Load shift info if shift mode is enabled
        if (shiftModeEnabled) {
          await checkCurrentShift();
        } else {
          // Si el modo de turnos está desactivado, permitir acceso directo
          currentShift = { active: true, shiftName: "Modo Libre" };
        }
        
        // Load products
        await loadProducts('');
        
        // Setup real-time listeners
        setupRealTimeListeners();
        
        // CORRECCIÓN: Setup notifications - PRIMERO VERIFICAR, LUEGO ESCUCHAR
        await checkForNotifications();
        setupNotificationsListener();
        
        // Load user profile data
        await loadUserProfile();
        
        hideLoading();
        
      } catch (error) {
        console.error('Error loading data:', error);
        hideLoading();
        showToast('Error al cargar datos', 'error');
      }
    }

    // Load Tax Configuration
    async function loadTaxConfig() {
      try {
        if (!currentCollaborator) return;
        
        const taxRef = doc(db, "impuesto", currentCollaborator.userId);
        const taxDoc = await getDoc(taxRef);
        
        if (taxDoc.exists()) {
          const taxData = taxDoc.data();
          taxConfig = {
            itbis: taxData.itbis || 18,
            iva: taxData.iva || 0,
            active: taxData.activo || false
          };
        }
      } catch (error) {
        console.error('Error loading tax config:', error);
      }
    }

    // Load Exchange Rates
    async function loadExchangeRates() {
      try {
        if (!currentCollaborator) {
          exchangeRates = { usd: 56.50, eur: 61.20 };
          return;
        }

        const ratesRef = doc(db, "exchangeRates", currentCollaborator.userId);
        const ratesDoc = await getDoc(ratesRef);
        
        if (ratesDoc.exists()) {
          const ratesData = ratesDoc.data();
          exchangeRates = {
            usd: ratesData.usd || 56.50,
            eur: ratesData.eur || 61.20
          };
        } else {
          exchangeRates = { usd: 56.50, eur: 61.20 };
        }
      } catch (error) {
        console.error('Error loading exchange rates:', error);
        exchangeRates = { usd: 56.50, eur: 61.20 };
      }
    }

    // Setup Real-time Listeners
    function setupRealTimeListeners() {
      if (realTimeInvoiceListener) realTimeInvoiceListener();
      if (realTimeTotalListener) realTimeTotalListener();
      
      if (!currentCollaborator) return;
      
      const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
      realTimeInvoiceListener = onSnapshot(productosRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          if (data.productos && data.productos.length > 0) {
            invoice = data.productos.map(item => ({
              name: item.nombre,
              quantity: item.cantidad,
              pricePerUnit: item.precio / item.cantidad,
              productId: item.id,
              businessName: item.businessName || '',
              total: item.precio
            }));
            updateInvoiceDisplay();
          }
        }
      });
      
      const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
      realTimeTotalListener = onSnapshot(totalRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          if (data.total && data.total > 0) {
            totalPrice = data.total;
            discountedTotal = totalPrice;
            updateInvoiceDisplay();
          }
        }
      });
    }

    // Products Management
    async function loadProducts(searchTerm = '') {
      try {
        if (isSearchInProgress) return;
        isSearchInProgress = true;
        
        showLoading('Cargando productos...');
        
        // Limpiar productos anteriores y el set de resultados
        productsGrid.innerHTML = '';
        currentSearchResults.clear();
        
        // Si el término de búsqueda es el mismo que el anterior, no hacer nada
        if (lastSearchQuery === searchTerm && searchTerm !== '') {
          hideLoading();
          isSearchInProgress = false;
          return;
        }
        lastSearchQuery = searchTerm;
        
        // Usar un Map para evitar duplicados (clave única: businessId + productId + nombre)
        const productsMap = new Map();
        
        const businessesRef = collection(db, "businesses");
        const businessesSnapshot = await getDocs(businessesRef);
        
        if (businessesSnapshot.empty) {
          productsGrid.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);"><i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay productos disponibles</p></div>';
          hideLoading();
          isSearchInProgress = false;
          return;
        }
        
        for (const businessDoc of businessesSnapshot.docs) {
          const businessId = businessDoc.id;
          const productsRef = collection(db, "businesses", businessId, "products");
          const productsQuery = query(
            productsRef, 
            where("userId", "==", currentCollaborator.userId)
          );
          
          const querySnapshot = await getDocs(productsQuery);
          
          for (const productDoc of querySnapshot.docs) {
            const product = productDoc.data();
            
            // Filtrar por término de búsqueda
            if (searchTerm && searchTerm.trim() !== '') {
              const searchLower = searchTerm.toLowerCase();
              const nameMatch = product.name.toLowerCase().includes(searchLower);
              const eanMatch = product.eanUpcCode?.toLowerCase().includes(searchLower);
              
              if (!nameMatch && !eanMatch) {
                continue;
              }
            }
            
            // Crear una clave única para el producto
            const uniqueKey = `${businessId}_${productDoc.id}_${product.name}`;
            
            // Evitar duplicados usando el Map
            if (!productsMap.has(uniqueKey)) {
              productsMap.set(uniqueKey, {
                productData: product,
                businessName: businessId,
                productId: productDoc.id,
                uniqueKey: uniqueKey
              });
            }
          }
        }
        
        // Convertir Map a array
        const uniqueProducts = Array.from(productsMap.values());
        
        // Limpiar el grid antes de agregar nuevos productos
        productsGrid.innerHTML = '';
        
        // === CORRECCIÓN PRINCIPAL: Si hay exactamente 1 resultado, agregarlo automáticamente ===
        if (uniqueProducts.length === 1 && searchTerm !== '') {
          const productInfo = uniqueProducts[0];
          
          // Verificar si necesita venta por unidad variable
          if (requiresVariableUnit(productInfo.productData)) {
            showVariableUnitModal(productInfo.productData, productInfo.businessName, productInfo.productId);
          } else if (quantityWindowEnabled) {
            showQuantityWindow(productInfo.productData, productInfo.businessName, productInfo.productId);
          } else {
            addToInvoice(productInfo.productData, productInfo.businessName, productInfo.productId);
          }
          
          // Limpiar el buscador automáticamente
          if (autoClearSearchEnabled) {
            setTimeout(() => {
              mobileSearch.value = '';
              loadProducts('');
            }, 500);
          }
          
          hideLoading();
          isSearchInProgress = false;
          return;
        }
        
        // Mostrar productos (cuando hay 0 o múltiples resultados)
        if (uniqueProducts.length === 0) {
          productsGrid.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);"><i class="fas fa-search" style="font-size: 40px; margin-bottom: 10px;"></i><p>No se encontraron productos</p></div>';
        } else {
          uniqueProducts.forEach(productInfo => {
            createProductCard(productInfo.productData, productInfo.businessName, productInfo.productId);
          });
        }
        
        hideLoading();
        isSearchInProgress = false;
        
      } catch (error) {
        console.error('Error loading products:', error);
        hideLoading();
        isSearchInProgress = false;
        showToast('Error al cargar productos', 'error');
      }
    }

    // Función auxiliar para crear tarjeta de producto
    function createProductCard(product, businessName, productId) {
      // Verificar si el producto ya fue agregado al grid
      const existingCard = productsGrid.querySelector(`[data-uniquekey="${businessName}_${productId}_${product.name}"]`);
      if (existingCard) {
        return; // Ya existe, no duplicar
      }
      
      const productCard = document.createElement('div');
      productCard.className = 'product-card';
      productCard.dataset.id = productId;
      productCard.dataset.business = businessName;
      productCard.dataset.uniqueKey = `${businessName}_${productId}_${product.name}`;
      
      let badgeHtml = '';
      const expirationStatus = getExpirationStatus(product);
      
      switch (expirationStatus.status) {
        case 'expired':
          badgeHtml = '<span class="product-badge badge-expired">VENCIDO</span>';
          break;
        case 'expired-grace':
          badgeHtml = '<span class="product-badge badge-expired">VENCIDO (PLAZO CUMPLIDO)</span>';
          break;
        case 'in-grace-period':
          badgeHtml = `<span class="product-badge badge-warning">PLAZO GRACIA: ${expirationStatus.days} DÍAS</span>`;
          break;
        case 'expiring-soon':
          const alertDays = product.alertDays || 30;
          badgeHtml = `<span class="product-badge badge-warning">VENCE EN ${expirationStatus.days} DÍAS (Alerta: ${alertDays} días)</span>`;
          break;
      }
      
      let taxBadge = '';
      if (taxConfig.active && (product.applyItbis || product.applyIva)) {
        taxBadge = '<span class="product-badge badge-tax">IMPUESTOS</span>';
      }
      
      // NUEVO: Indicador de venta por unidad variable
      let variableUnitBadge = '';
      if (requiresVariableUnit(product)) {
        variableUnitBadge = `<span class="product-badge badge-variable" style="background: #9b59b6;">
          <i class="fas fa-balance-scale"></i> VENTA POR ${product.unit}
        </span>`;
      }
      
      productCard.innerHTML = `
        ${badgeHtml}
        ${variableUnitBadge}
        <img src="${product.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image'}" class="product-image" alt="${product.name}">
        <div class="product-name">${product.name}</div>
        <div class="product-price">${formatCurrency(product.pricePerUnit)}/${product.unit || 'unidad'}</div>
        ${product.eanUpcCode ? `<div class="product-ean-mobile"><i class="fas fa-barcode"></i> ${product.eanUpcCode}</div>` : ''}
        ${taxBadge}
      `;
      
      productCard.dataset.expirationStatus = expirationStatus.status;
      productCard.dataset.expirationDays = expirationStatus.days;
      productCard.dataset.alertDays = product.alertDays || 30;
      productCard.dataset.productName = product.name;
      productCard.dataset.productId = productId;
      productCard.dataset.businessName = businessName;
      productCard.dataset.requiresVariableUnit = requiresVariableUnit(product);
      productCard.dataset.productUnit = product.unit || 'Unidad';
      
      productCard.addEventListener('click', () => {
        handleProductClick(product, businessName, productId, expirationStatus);
      });
      productsGrid.appendChild(productCard);
      
      // Agregar al set de resultados actuales
      currentSearchResults.add(`${businessName}_${productId}_${product.name}`);
    }

    // Función para manejar el clic en producto con verificación de vencimiento
    async function handleProductClick(product, businessName, productId, expirationStatus) {
      if (product.quantity === 0) {
        showToast('Producto agotado', 'error');
        return;
      }
      
      // Verificar si el producto está vencido o en estado crítico
      if (expirationStatus.status === 'expired' || expirationStatus.status === 'expired-grace') {
        showExpirationAlert(product, businessName, productId, expirationStatus.days, true, expirationStatus.status);
        return;
      }
      
      // Verificar si el producto está próximo a vencer según alert days personalizado
      if (expirationStatus.status === 'expiring-soon') {
        showExpirationAlert(product, businessName, productId, expirationStatus.days, false, expirationStatus.status);
        return;
      }
      
      // Verificar si está en plazo de gracia
      if (expirationStatus.status === 'in-grace-period') {
        showExpirationAlert(product, businessName, productId, expirationStatus.days, false, expirationStatus.status);
        return;
      }
      
      // NUEVO: Verificar si necesita venta por unidad variable
      if (requiresVariableUnit(product)) {
        showVariableUnitModal(product, businessName, productId);
      } else if (quantityWindowEnabled) {
        // Mostrar ventana de cantidad
        showQuantityWindow(product, businessName, productId);
      } else {
        // Agregar directamente una unidad
        addToInvoice(product, businessName, productId);
      }
    }

    // Función para mostrar ventana de cantidad
    function showQuantityWindow(product, businessName, productId) {
      currentProductForQuantity = { product, businessName, productId };
      quantityProductName.textContent = product.name;
      quantityProductPrice.textContent = formatCurrency(product.pricePerUnit);
      quantityDisplay.textContent = '1';
      quantityModal.style.display = 'flex';
    }

    // Función para agregar producto con cantidad específica
    function addProductWithQuantity(quantity) {
      if (!currentProductForQuantity) return;
      
      const { product, businessName, productId } = currentProductForQuantity;
      
      if (product.quantity < quantity) {
        showToast('Stock insuficiente', 'error');
        return;
      }
      
      const existingItem = invoice.find(item => item.productId === productId && item.businessName === businessName);
      
      if (existingItem) {
        if (existingItem.quantity + quantity > product.quantity) {
          showToast('Stock insuficiente', 'error');
          return;
        }
        existingItem.quantity += quantity;
      } else {
        invoice.push({
          ...product,
          businessName,
          productId,
          quantity: quantity
        });
      }
      
      updateInvoiceDisplay();
      showToast(`${quantity} ${product.name} agregado(s)`, 'success');
      quantityModal.style.display = 'none';
      currentProductForQuantity = null;
      
      updateRealTimeData();
    }

    // CORRECCIÓN: Función mejorada para mostrar alerta de vencimiento con ventanas más pequeñas
    function showExpirationAlert(product, businessName, productId, daysDiff, isExpired, status) {
      const overlay = document.createElement('div');
      overlay.className = 'expiration-modal-overlay';
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
      overlay.style.zIndex = '9999';
      overlay.style.display = 'flex';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';
      overlay.style.backdropFilter = 'blur(5px)';
      
      const modal = document.createElement('div');
      
      let modalStyle = {};
      let title = '';
      let icon = '';
      let iconColor = '';
      let buttonColor = '';
      let message = '';
      let isCritical = false;
      
      switch(status) {
        case 'expired':
        case 'expired-grace':
          modalStyle.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
          title = '¡PRODUCTO VENCIDO!';
          icon = 'fa-exclamation-circle';
          iconColor = '#ffffff';
          buttonColor = '#ffffff';
          isCritical = true;
          message = `<strong style="color: #ffffff;">¡ADVERTENCIA CRÍTICA!</strong><br>
            El producto <strong>"${product.name}"</strong> está <strong>VENCIDO</strong>.<br><br>
            <span style="color: #ffffff; font-weight: bold;">¿ESTÁ SEGURO QUE DESEA VENDER ESTE PRODUCTO?</span>`;
          break;
          
        case 'expiring-soon':
          modalStyle.background = 'linear-gradient(135deg, #f39c12, #d35400)';
          title = 'ADVERTENCIA: Producto próximo a vencer';
          icon = 'fa-exclamation-triangle';
          iconColor = '#ffffff';
          buttonColor = '#f39c12';
          message = `<strong style="color: #ffffff;">¡ATENCIÓN!</strong><br>
            El producto <strong>"${product.name}"</strong> está próximo a vencer.<br>
            Faltan <strong>${daysDiff} días</strong> para su fecha de vencimiento.<br>
            <small>(Alerta configurada: ${product.alertDays || 30} días)</small><br><br>
            <span style="color: #ffffff; font-weight: bold;">¿DESEA PROCEDER CON LA VENTA?</span>`;
          break;
          
        case 'in-grace-period':
          modalStyle.background = 'linear-gradient(135deg, #f39c12, #d35400)';
          title = 'PRODUCTO EN PLAZO DE GRACIA';
          icon = 'fa-clock';
          iconColor = '#ffffff';
          buttonColor = '#f39c12';
          message = `<strong style="color: #ffffff;">¡INFORMACIÓN IMPORTANTE!</strong><br>
            El producto <strong>"${product.name}"</strong> está en plazo de gracia.<br>
            Tiene <strong>${daysDiff} días</strong> restantes en el plazo de gracia.<br><br>
            <span style="color: #ffffff; font-weight: bold;">¿DESEA PROCEDER CON LA VENTA?</span>`;
          break;
      }
      
      modal.className = isCritical ? 'expiration-modal expired' : 'expiration-modal';
      modal.style.background = modalStyle.background;
      modal.style.borderRadius = '12px';
      modal.style.padding = '20px';
      modal.style.width = '85%';
      modal.style.maxWidth = '320px';
      modal.style.boxShadow = '0 8px 25px rgba(0,0,0,0.4)';
      modal.style.color = 'white';
      modal.style.textAlign = 'center';
      modal.style.animation = 'fadeIn 0.3s ease-out';
      modal.style.border = '2px solid rgba(255, 255, 255, 0.2)';
      
      let warningText = '';
      if (isCritical) {
        warningText = 'La venta de productos vencidos puede acarrear sanciones legales y riesgos para la salud.';
      } else if (status === 'expiring-soon') {
        warningText = 'Productos próximos a vencer deben ser vendidos con precaución.';
      } else {
        warningText = 'Productos en plazo de gracia deben ser consumidos pronto.';
      }
      
      modal.innerHTML = `
        <div class="expiration-icon" style="font-size: 40px; color: ${iconColor}; margin-bottom: 15px;">
          <i class="fas ${icon}"></i>
        </div>
        <h2 class="expiration-title" style="color: #ffffff; margin: 0 0 12px 0; font-size: 18px;"> 
          ${title}
        </h2>
        <div class="expiration-message" style="margin-bottom: 20px; font-size: 13px; line-height: 1.4;">
          ${message}
        </div>
        <div class="expiration-warning" style="background: rgba(0, 0, 0, 0.3); 
              border-left: 3px solid ${iconColor};
              padding: 8px; margin: 12px 0; text-align: left; border-radius: 4px; font-size: 11px;">
          <strong>⚠️ RESPONSABILIDAD:</strong><br>
          ${warningText}
        </div>
        <div class="expiration-buttons" style="display: flex; gap: 8px; justify-content: center; margin-top: 15px;">
          <button class="expiration-btn expiration-btn-no" 
                  style="flex: 1; padding: 10px 15px; background: #7f8c8d; color: white; border: none; border-radius: 6px; 
                         font-weight: bold; cursor: pointer; font-size: 13px;">
            <i class="fas fa-times"></i> NO, CANCELAR
          </button>
          <button class="expiration-btn expiration-btn-yes" 
                  style="flex: 1; padding: 10px 15px; background: ${buttonColor}; 
                         color: #16a086; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px;">
            <i class="fas fa-check"></i> SÍ, ${isCritical ? 'VENDER' : 'PROCEDER'}
          </button>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      const yesBtn = overlay.querySelector('.expiration-btn-yes');
      const noBtn = overlay.querySelector('.expiration-btn-no');
      
      if (yesBtn) {
        yesBtn.addEventListener('click', () => {
          document.body.removeChild(overlay);
          if (isCritical) {
            // Para productos vencidos, mostrar confirmación adicional
            showFinalConfirmation(product, businessName, productId, status);
          } else {
            // Para otros estados, continuar normal
            if (requiresVariableUnit(product)) {
              showVariableUnitModal(product, businessName, productId);
            } else if (quantityWindowEnabled) {
              showQuantityWindow(product, businessName, productId);
            } else {
              addToInvoice(product, businessName, productId);
            }
          }
        });
      }
      
      noBtn.addEventListener('click', () => {
        document.body.removeChild(overlay);
        showToast('Venta cancelada', 'info');
      });
    }

    // Función para mostrar confirmación final de productos vencidos
    function showFinalConfirmation(product, businessName, productId, status) {
      const overlay = document.createElement('div');
      overlay.className = 'expiration-modal-overlay';
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
      overlay.style.zIndex = '10000';
      overlay.style.display = 'flex';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';
      
      const modal = document.createElement('div');
      modal.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
      modal.style.borderRadius = '12px';
      modal.style.padding = '20px';
      modal.style.width = '85%';
      modal.style.maxWidth = '320px';
      modal.style.boxShadow = '0 8px 25px rgba(0,0,0,0.4)';
      modal.style.textAlign = 'center';
      modal.style.color = 'white';
      modal.style.border = '2px solid rgba(255, 255, 255, 0.3)';
      
      modal.innerHTML = `
        <div style="color: #ffffff; font-size: 40px; margin-bottom: 15px;">
          <i class="fas fa-skull-crossbones"></i>
        </div>
        <h2 style="color: #ffffff; margin: 0 0 12px 0; font-size: 20px;">
          ¡CONFIRMACIÓN FINAL!
        </h2>
        <div style="margin-bottom: 20px; font-size: 14px; line-height: 1.4;">
          Está a punto de vender un producto <strong>${status === 'expired-grace' ? 'VENCIDO (PLAZO CUMPLIDO)' : 'VENCIDO'}</strong>:<br>
          <strong>"${product.name}"</strong>
        </div>
        <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.3); padding: 10px; 
                    margin: 15px 0; border-radius: 6px; text-align: left; font-size: 11px;">
          <strong style="color: #ffffff;">⚠️ ADVERTENCIA LEGAL:</strong><br>
          • Usted asume toda responsabilidad legal<br>
          • Esta acción será registrada<br>
          • Se notificará al administrador
        </div>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <button id="cancelFinal" 
                  style="flex: 1; padding: 10px 15px; background: #7f8c8d; color: white; 
                         border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px;">
            <i class="fas fa-ban"></i> CANCELAR
          </button>
          <button id="confirmFinal" 
                  style="flex: 1; padding: 10px 15px; background: #ffffff; color: #e74c3c; 
                         border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px;">
            <i class="fas fa-check-double"></i> CONFIRMAR
          </button>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      document.getElementById('cancelFinal').addEventListener('click', () => {
        document.body.removeChild(overlay);
        showToast('Venta de producto vencido cancelada', 'warning');
      });
      
      document.getElementById('confirmFinal').addEventListener('click', () => {
        document.body.removeChild(overlay);
        // Registrar la venta de producto vencido en el sistema
        registerExpiredProductSale(product, businessName, productId, status);
        
        // Proceder con la venta
        if (requiresVariableUnit(product)) {
          showVariableUnitModal(product, businessName, productId);
        } else if (quantityWindowEnabled) {
          showQuantityWindow(product, businessName, productId);
        } else {
          addToInvoice(product, businessName, productId);
        }
        
        showToast('Producto vencido agregado - REGISTRADO', 'error');
      });
    }

    // Función para registrar venta de producto vencido
    async function registerExpiredProductSale(product, businessName, productId, status) {
      try {
        if (!currentCollaborator) return;
        
        const expirationStatus = getExpirationStatus(product);
        
        const expiredSaleRef = collection(db, "expiredProductSales");
        await addDoc(expiredSaleRef, {
          productId: productId,
          productName: product.name,
          businessName: businessName,
          collaboratorId: currentCollaborator.id,
          collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
          userId: currentCollaborator.userId,
          timestamp: Timestamp.now(),
          expirationDate: product.expirationDate,
          alertDays: product.alertDays || 30,
          gracePeriod: product.gracePeriod || 0,
          expirationStatus: status,
          daysUntilExpiration: expirationStatus.days,
          action: 'added_to_invoice'
        });
        
        console.log('Venta de producto vencido registrada');
      } catch (error) {
        console.error('Error registrando venta de producto vencido:', error);
      }
    }

    // Auto clear search function
    function setupAutoClearSearch(searchTerm) {
      if (autoClearSearchTimeout) {
        clearTimeout(autoClearSearchTimeout);
      }
      
      if (autoClearSearchEnabled && searchTerm !== '') {
        autoClearSearchTimeout = setTimeout(() => {
          if (mobileSearch.value === searchTerm) {
            mobileSearch.value = '';
            loadProducts('');
            showToast('Buscador limpiado automáticamente', 'info');
          }
        }, 6000);
      }
    }

    // Invoice Management
    function addToInvoice(product, businessName, productId) {
      if (product.quantity === 0) {
        showToast('Producto agotado', 'error');
        return;
      }
      
      const existingItem = invoice.find(item => item.productId === productId && item.businessName === businessName);
      
      if (existingItem) {
        if (existingItem.quantity >= product.quantity) {
          showToast('Stock insuficiente', 'error');
          return;
        }
        existingItem.quantity += 1;
      } else {
        invoice.push({
          ...product,
          businessName,
          productId,
          quantity: 1
        });
      }
      
      updateInvoiceDisplay();
      showToast('Producto agregado', 'success');
      
      updateRealTimeData();
    }

    function updateRealTimeData() {
      if (!currentCollaborator) return;
      
      try {
        const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
        setDoc(totalRef, {
          total: discountedTotal > 0 ? discountedTotal : totalPrice
        }, { merge: true });
        
        const productos = invoice.map(item => {
          let priceWithTaxes = item.pricePerUnit;
          if (taxConfig.active) {
            if (item.applyItbis) {
              priceWithTaxes += priceWithTaxes * (taxConfig.itbis / 100);
            }
            if (item.applyIva) {
              priceWithTaxes += priceWithTaxes * (taxConfig.iva / 100);
            }
          }
          
          // Para productos vendidos por unidad variable, usar la unidad seleccionada para display
          const displayUnit = item.selectedUnit || item.unit || item.originalUnit || 'unidad';
          const displayQuantity = item.quantityInSelectedUnit || item.quantity;
          
          return {
            id: item.productId,
            nombre: item.name,
            cantidad: displayQuantity,
            precio: priceWithTaxes * item.quantity, // Usar cantidad en unidad base para cálculo
            businessName: item.businessName,
            unit: displayUnit,
            variableUnitSale: item.variableUnitSale || false
          };
        });
        
        const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
        setDoc(productosRef, {
          productos: productos
        }, { merge: true });
      } catch (error) {
        console.error('Error updating real-time data:', error);
      }
    }

    function updateCurrencyTotals() {
      usdTotalMobile.innerHTML = `<i class="fas fa-dollar-sign"></i> ${formatCurrency(discountedTotal / exchangeRates.usd)}`;
      eurTotalMobile.innerHTML = `<i class="fas fa-euro-sign"></i> ${formatCurrency(discountedTotal / exchangeRates.eur)}`;
    }

    function updateRealTimeTotal() {
      if (showRealTimeTotal) {
        realTimeTotalAmount.textContent = formatCurrency(discountedTotal);
        realTimeTotalContainer.style.display = 'block';
      } else {
        realTimeTotalContainer.style.display = 'none';
      }
    }

    // CORRECCIÓN: Configuración mejorada del teclado numérico
    function setupNumpadForModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      
      const inputField = modal.querySelector('input[type="text"], input[type="password"]');
      if (!inputField) return;
      
      // Configurar botones numéricos
      const numButtons = modal.querySelectorAll('.num-btn[data-value]');
      numButtons.forEach(btn => {
        // Remover event listeners existentes
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', (e) => {
          const now = Date.now();
          if (now - lastNumpadClickTime < numpadClickDelay) return;
          lastNumpadClickTime = now;
          
          const value = newBtn.getAttribute('data-value');
          
          // Manejar valores especiales
          if (value === '.') {
            // Evitar múltiples puntos decimales
            if (!inputField.value.includes('.')) {
              inputField.value = inputField.value + value;
            }
          } else if (value === '00') {
            inputField.value = inputField.value + '00';
          } else {
            inputField.value = inputField.value + value;
          }
          
          // Disparar evento input
          const inputEvent = new Event('input', { bubbles: true });
          inputField.dispatchEvent(inputEvent);
        });
      });
      
      // Configurar botón clear
      const clearBtn = modal.querySelector('.num-btn.clear');
      if (clearBtn) {
        const newClearBtn = clearBtn.cloneNode(true);
        clearBtn.parentNode.replaceChild(newClearBtn, clearBtn);
        
        newClearBtn.addEventListener('click', () => {
          inputField.value = '';
          const inputEvent = new Event('input', { bubbles: true });
          inputField.dispatchEvent(inputEvent);
        });
      }
      
      // Configurar botón backspace
      const backspaceBtn = modal.querySelector('.num-btn.backspace');
      if (backspaceBtn) {
        const newBackspaceBtn = backspaceBtn.cloneNode(true);
        backspaceBtn.parentNode.replaceChild(newBackspaceBtn, backspaceBtn);
        
        newBackspaceBtn.addEventListener('click', () => {
          inputField.value = inputField.value.slice(0, -1);
          const inputEvent = new Event('input', { bubbles: true });
          inputField.dispatchEvent(inputEvent);
        });
      }
    }

    // Payment Processing
    function setupCashPayment() {
      // Configurar teclado numérico para cashReceivedInput
      setupNumpadForModal('cashModal');
      
      cashReceivedInput.value = '';
      
      function calculateChange() {
        const received = parseFloat(cashReceivedInput.value) || 0;
        const change = received - discountedTotal;
        
        amountReceived = received;
        
        cashReceivedDisplay.textContent = formatCurrency(received);
        cashChangeAmount.textContent = formatCurrency(change);
        
        if (change < 0) {
          cashChangeAmount.style.color = '#e74c3c';
        } else {
          cashChangeAmount.style.color = '#16e086';
        }
      }
      
      cashConfirmBtn.addEventListener('click', async () => {
        const received = parseFloat(cashReceivedInput.value) || 0;
        
        if (received < discountedTotal) {
          showToast('Monto insuficiente', 'error');
          return;
        }
        
        await processPayment('Efectivo', received);
      });
      
      cashReceivedInput.addEventListener('input', calculateChange);
    }

    // CORRECCIÓN PRINCIPAL: Función para procesar pagos que evita registrar dos facturas a la vez
    async function processPayment(paymentType, amountReceived = 0) {
      // Verificar si ya se está procesando un pago
      if (isProcessingPayment) {
        showToast('Ya se está procesando un pago. Por favor espere.', 'warning');
        return;
      }
      
      try {
        // Establecer que se está procesando un pago
        isProcessingPayment = true;
        showLoading('Procesando pago...');
        
        // CORRECCIÓN: Usar la nueva función para generar ID único con 5 dígitos
        const invoiceId = generateUniqueInvoiceId(currentCollaborator.id);
        
        // Verificar que la factura tenga productos
        if (invoice.length === 0) {
          showToast('La factura está vacía', 'error');
          isProcessingPayment = false;
          hideLoading();
          return;
        }
        
        let totalITBIS = 0;
        let totalIVA = 0;
        
        if (taxConfig.active) {
          invoice.forEach(item => {
            const basePrice = item.pricePerUnit;
            if (item.applyItbis) {
              totalITBIS += basePrice * (taxConfig.itbis / 100) * item.quantity;
            }
            if (item.applyIva) {
              totalIVA += basePrice * (taxConfig.iva / 100) * item.quantity;
            }
          });
        }
        
        const invoiceData = {
          invoiceId,
          collaboratorId: currentCollaborator.id,
          collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
          userId: currentCollaborator.userId,
          username: currentCollaborator.username,
          items: invoice.map(item => {
            const expirationStatus = getExpirationStatus(item);
            return {
              name: item.name,
              quantity: item.quantity, // Cantidad en unidad base
              quantityInSelectedUnit: item.quantityInSelectedUnit || item.quantity, // Cantidad en unidad seleccionada
              selectedUnit: item.selectedUnit || item.unit, // Unidad mostrada al usuario
              price: item.pricePerUnit,
              total: item.pricePerUnit * item.quantity,
              unit: item.unit || item.originalUnit || 'unidad',
              variableUnitSale: item.variableUnitSale || false,
              applyItbis: item.applyItbis || false,
              applyIva: item.applyIva || false,
              expirationDate: item.expirationDate || null,
              alertDays: item.alertDays || 30,
              gracePeriod: item.gracePeriod || 0,
              expirationStatus: expirationStatus.status,
              daysToExpire: expirationStatus.days,
              hasExpired: expirationStatus.status === 'expired' || expirationStatus.status === 'expired-grace',
              inGracePeriod: expirationStatus.status === 'in-grace-period'
            };
          }),
          subtotal: totalPrice,
          discount: discount,
          discountAmount: totalPrice * (discount / 100),
          itbis: totalITBIS,
          iva: totalIVA,
          total: discountedTotal,
          paymentType,
          amountReceived,
          change: amountReceived - discountedTotal,
          timestamp: Timestamp.now(),
          date: new Date().toISOString(),
          businessName: businessDetails.name,
          businessRNC: businessDetails.rnc,
          businessAddress: businessDetails.address,
          businessPhone: businessDetails.phone,
          businessEmail: businessDetails.email,
          businessNCF: businessDetails.ncf,
          // Nuevo campo para registrar productos vencidos
          hasExpiredProducts: invoice.some(item => {
            const expirationStatus = getExpirationStatus(item);
            return expirationStatus.status === 'expired' || expirationStatus.status === 'expired-grace';
          }),
          hasGracePeriodProducts: invoice.some(item => {
            const expirationStatus = getExpirationStatus(item);
            return expirationStatus.status === 'in-grace-period';
          }),
          hasVariableUnitSales: invoice.some(item => item.variableUnitSale)
        };
        
        // CORRECCIÓN: Guardar en facturacionCarrito (SOLO UNA VEZ)
        await addDoc(collection(db, "facturacionCarrito"), invoiceData);
        
        // CORRECCIÓN: Guardar en el historial del usuario (SOLO UNA VEZ)
        const historyRef = collection(db, "users", currentCollaborator.userId, "invoiceHistory");
        await addDoc(historyRef, invoiceData);
        
        // CORRECCIÓN: Guardar en FacturaDeCuadres (SOLO UNA VEZ)
        await addDoc(collection(db, "FacturaDeCuadres"), invoiceData);
        
        // Actualizar stock de productos - CORRECCIÓN PARA UNIDADES VARIABLES
        for (const item of invoice) {
          const productRef = doc(db, "businesses", item.businessName, "products", item.productId);
          const productDoc = await getDoc(productRef);
          
          if (productDoc.exists()) {
            const currentStock = productDoc.data().quantity;
            const quantityToDeduct = item.quantity; // Ya está en unidad base
            
            await updateDoc(productRef, {
              quantity: Math.max(0, currentStock - quantityToDeduct)
            });
          }
        }
        
        await generateInvoiceHTML(invoiceData);
        
        // CORRECCIÓN: Limpiar la factura actual después del procesamiento exitoso
        invoice = [];
        discount = 0;
        updateInvoiceDisplay();
        
        await clearRealTimeData();
        
        cashModal.style.display = 'none';
        cardModal.style.display = 'none';
        
        printModal.style.display = 'flex';
        
        hideLoading();
        showToast('Pago procesado exitosamente', 'success');
        
      } catch (error) {
        console.error('Payment processing error:', error);
        hideLoading();
        showToast('Error al procesar el pago', 'error');
      } finally {
        // CORRECCIÓN: Siempre liberar el bloqueo de procesamiento
        isProcessingPayment = false;
      }
    }

    async function clearRealTimeData() {
      try {
        const totalRef = doc(db, "users", currentCollaborator.userId, "totals", "currentTotal");
        await setDoc(totalRef, {
          total: 0
        }, { merge: true });
        
        const productosRef = doc(db, "users", currentCollaborator.userId, "totalApagarVentas", "currentVenta");
        await setDoc(productosRef, {
          productos: []
        }, { merge: true });
      } catch (error) {
        console.error('Error clearing real-time data:', error);
      }
    }

    async function generateInvoiceHTML(invoiceData) {
      try {
        let logoUrl = '';
        if (businessDetails.logoUrl && businessDetails.logoUrl !== 'logo.png') {
          try {
            const logoRef = ref(storage, businessDetails.logoUrl);
            logoUrl = await getDownloadURL(logoRef);
          } catch (error) {
            console.error('Error loading logo:', error);
            logoUrl = 'logo.png';
          }
        } else {
          logoUrl = 'logo.png';
        }
        
        let qrCodeHtml = '';
        if (businessDetails.qrUrl) {
          try {
            const qrRef = ref(storage, businessDetails.qrUrl);
            const qrUrl = await getDownloadURL(qrRef);
            qrCodeHtml = `
              <div style="text-align: center; margin: 12px 0;">
                <img src="${qrUrl}" alt="Código QR" style="width: 80px; height: 80px;">
              </div>
            `;
          } catch (error) {
            console.error('Error loading QR code:', error);
          }
        }
        
        const itemsHtml = invoiceData.items.map(item => {
          let expirationWarning = '';
          if (item.expirationStatus) {
            switch(item.expirationStatus) {
              case 'expired':
              case 'expired-grace':
                expirationWarning = `<br><small style="color: #e74c3c; font-weight: bold;">¡PRODUCTO VENCIDO!</small>`;
                break;
              case 'in-grace-period':
                expirationWarning = `<br><small style="color: #f39c12;">Plazo de gracia: ${item.daysToExpire} días restantes</small>`;
                break;
              case 'expiring-soon':
                expirationWarning = `<br><small style="color: #f39c12;">Vence en ${item.daysToExpire} días (Alerta: ${item.alertDays} días)</small>`;
                break;
            }
          }
          
          // Mostrar información de unidad variable
          let unitInfo = '';
          let displayQuantity = item.quantity;
          let displayUnit = item.unit;
          
          if (item.variableUnitSale && item.selectedUnit) {
            unitInfo = `<br><small style="color: #9b59b6;"><i class="fas fa-balance-scale"></i> Venta por peso/medida</small>`;
            displayQuantity = item.quantityInSelectedUnit || item.quantity;
            displayUnit = item.selectedUnit;
          }
          
          return `
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; border-bottom: 1px dashed #eee; padding-bottom: 2px;">
            <div style="flex: 3;">
              ${item.name} - ${formatNumber(displayQuantity)} ${displayUnit}
              ${item.applyItbis || item.applyIva ? `<br><small style="color: #666;">${item.applyItbis ? 'ITBIS ' : ''}${item.applyIva ? 'IVA' : ''}</small>` : ''}
              ${expirationWarning}
              ${unitInfo}
            </div>
            <div style="flex: 1; text-align: right;">
              ${formatCurrency(item.total)}
            </div>
          </div>
        `}).join('');
        
        let summaryHtml = '';
        summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
          <span>Subtotal:</span>
          <span>${formatCurrency(invoiceData.subtotal)}</span>
        </div>`;
        
        if (invoiceData.discount > 0) {
          summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
            <span>Descuento (${invoiceData.discount}%):</span>
            <span>-${formatCurrency(invoiceData.discountAmount)}</span>
          </div>`;
        }
        
        if (invoiceData.itbis > 0) {
          summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
            <span>ITBIS (${taxConfig.itbis}%):</span>
            <span>${formatCurrency(invoiceData.itbis)}</span>
          </div>`;
        }
        
        if (invoiceData.iva > 0) {
          summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
            <span>IVA (${taxConfig.iva}%):</span>
            <span>${formatCurrency(invoiceData.iva)}</span>
          </div>`;
        }
        
        summaryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-weight: bold; font-size: 13px;">
          <span>Total:</span>
          <span>${formatCurrency(invoiceData.total)}</span>
        </div>`;
        
        // Advertencia si hay productos vencidos
        let expiredWarning = '';
        if (invoiceData.hasExpiredProducts) {
          expiredWarning = `
            <div style="background: #fee; border: 2px solid #e74c3c; padding: 8px; margin: 10px 0; border-radius: 4px; text-align: center;">
              <strong style="color: #e74c3c;">⚠️ ADVERTENCIA: ESTA FACTURA CONTIENE PRODUCTOS VENCIDOS</strong><br>
              <small style="color: #e74c3c;">Facturado por: ${invoiceData.collaboratorName}</small>
            </div>
          `;
        }
        
        // Advertencia si hay productos en plazo de gracia
        let graceWarning = '';
        if (invoiceData.hasGracePeriodProducts) {
          graceWarning = `
            <div style="background: #fff3cd; border: 2px solid #f39c12; padding: 8px; margin: 10px 0; border-radius: 4px; text-align: center;">
              <strong style="color: #856404;">ℹ️ INFORMACIÓN: PRODUCTOS EN PLAZO DE GRACIA</strong>
            </div>
          `;
        }
        
        // Información si hay ventas por unidad variable
        let variableUnitInfo = '';
        if (invoiceData.hasVariableUnitSales) {
          variableUnitInfo = `
            <div style="background: #f0e6ff; border: 2px solid #9b59b6; padding: 8px; margin: 10px 0; border-radius: 4px; text-align: center;">
              <strong style="color: #9b59b6;">📏 VENTAS POR PESO/MEDIDA INCLUIDAS</strong>
            </div>
          `;
        }
        
        const invoiceHtml = `
          <div style="padding: 12px; max-width: 280px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 12px;">
              ${logoUrl ? `<img src="${logoUrl}" alt="Logo" style="max-height: 50px; margin-bottom: 8px;">` : ''}
              <h3 style="margin: 0 0 4px 0; color: #16e086;">${businessDetails.name}</h3>
              <p style="margin: 0; font-size: 10px; color: #666;">RNC: ${businessDetails.rnc}</p>
              <p style="margin: 0; font-size: 10px; color: #666;">${businessDetails.address}</p>
              <p style="margin: 0; font-size: 10px; color: #666;">Tel: ${businessDetails.phone}</p>
              <p style="margin: 0; font-size: 10px; color: #666;">NCF: ${businessDetails.ncf}</p>
              <p style="margin: 4px 0; font-size: 10px; color: #666;">Factura: ${invoiceData.invoiceId}</p>
              <p style="margin: 0; font-size: 10px; color: #666;">${formatDate(invoiceData.date)}</p>
            </div>
            
            ${expiredWarning}
            ${graceWarning}
            ${variableUnitInfo}
            
            <div style="margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
              <p style="margin: 0 0 4px 0; font-size: 10px;"><strong>Atendido por:</strong> ${invoiceData.collaboratorName}</p>
              <p style="margin: 0; font-size: 10px;"><strong>Usuario:</strong> ${invoiceData.username}</p>
            </div>
            
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 4px; padding-bottom: 4px; border-bottom: 2px solid #16e086;">
                <span style="flex: 3;">Producto (Cantidad)</span>
                <span style="flex: 1; text-align: right;">Total</span>
              </div>
              ${itemsHtml}
            </div>
            
            <div style="font-size: 11px; border-top: 2px solid #16e086; padding-top: 8px;">
              ${summaryHtml}
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>Método de pago:</span>
                <span>${invoiceData.paymentType}</span>
              </div>
              ${invoiceData.paymentType === 'Efectivo' ? `
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>Recibido:</span>
                <span>${formatCurrency(invoiceData.amountReceived)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>Cambio:</span>
                <span>${formatCurrency(invoiceData.change)}</span>
              </div>
              ` : ''}
            </div>
            
            ${qrCodeHtml}
            
            <div style="text-align: center; margin-top: 15px; padding-top: 8px; border-top: 1px dashed #ccc;">
              <p style="margin: 0; font-size: 9px; color: #666;">¡Gracias por su compra!</p>
              <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px; font-size: 8px; color: #666; text-align: left;">
                <p style="margin: 0 0 3px 0;"><strong>POLÍTICAS:</strong></p>
                <p style="margin: 0;">• No se aceptan devoluciones después de 7 días.</p>
                <p style="margin: 0;">• Productos perecederos no tienen cambio.</p>
                <p style="margin: 0;">• Para garantías presentar factura original.</p>
                <p style="margin: 0;">• Horario: Lunes a Sábado 8:00 AM - 6:00 PM.</p>
              </div>
            </div>
          </div>
        `;
        
        invoicePrintContent.innerHTML = invoiceHtml;
        
        let whatsappMessage = `*FACTURA ${invoiceData.invoiceId}*\n\n`;
        whatsappMessage += `*${businessDetails.name}*\n`;
        whatsappMessage += `RNC: ${businessDetails.rnc}\n`;
        whatsappMessage += `Fecha: ${formatDate(invoiceData.date)}\n`;
        whatsappMessage += `Atendido por: ${invoiceData.collaboratorName}\n\n`;
        whatsappMessage += `*DETALLES DE LA COMPRA:*\n`;
        
        invoiceData.items.forEach(item => {
          let expirationInfo = '';
          if (item.expirationStatus) {
            switch(item.expirationStatus) {
              case 'expired':
              case 'expired-grace':
                expirationInfo = ` ⚠️ VENCIDO`;
                break;
              case 'in-grace-period':
                expirationInfo = ` ⏳ PLAZO GRACIA: ${item.daysToExpire} DÍAS`;
                break;
              case 'expiring-soon':
                expirationInfo = ` ⏰ VENCE EN ${item.daysToExpire} DÍAS (Alerta: ${item.alertDays} días)`;
                break;
            }
          }
          
          // Información de unidad variable
          let unitInfo = item.variableUnitSale ? ` ⚖️ VENTA POR PESO/MEDIDA` : '';
          let displayQuantity = item.quantity;
          let displayUnit = item.unit;
          
          if (item.variableUnitSale && item.selectedUnit) {
            displayQuantity = item.quantityInSelectedUnit || item.quantity;
            displayUnit = item.selectedUnit;
          }
          
          whatsappMessage += `• ${item.name} - ${formatNumber(displayQuantity)} ${displayUnit} - ${formatCurrency(item.total)}${expirationInfo}${unitInfo}\n`;
        });
        
        whatsappMessage += `\n*RESUMEN:*\n`;
        whatsappMessage += `Subtotal: ${formatCurrency(invoiceData.subtotal)}\n`;
        
        if (invoiceData.discount > 0) {
          whatsappMessage += `Descuento: -${formatCurrency(invoiceData.discountAmount)}\n`;
        }
        
        if (invoiceData.itbis > 0) {
          whatsappMessage += `ITBIS: ${formatCurrency(invoiceData.itbis)}\n`;
        }
        
        if (invoiceData.iva > 0) {
          whatsappMessage += `IVA: ${formatCurrency(invoiceData.iva)}*\n`;
        }
        
        whatsappMessage += `*TOTAL: ${formatCurrency(invoiceData.total)}*\n`;
        whatsappMessage += `Método de pago: ${invoiceData.paymentType}\n\n`;
        
        if (invoiceData.hasExpiredProducts) {
          whatsappMessage += `⚠️ *ADVERTENCIA: ESTA FACTURA CONTIENE PRODUCTOS VENCIDOS*\n`;
          whatsappMessage += `Facturado por: ${invoiceData.collaboratorName}\n\n`;
        }
        
        if (invoiceData.hasGracePeriodProducts) {
          whatsappMessage += `ℹ️ *INFORMACIÓN: PRODUCTOS EN PLAZO DE GRACIA*\n\n`;
        }
        
        if (invoiceData.hasVariableUnitSales) {
          whatsappMessage += `📏 *VENTAS POR PESO/MEDIDA INCLUIDAS*\n\n`;
        }
        
        whatsappMessage += `¡Gracias por su compra! 🛒`;
        
        window.currentWhatsAppMessage = whatsappMessage;
        
      } catch (error) {
        console.error('Error generating invoice HTML:', error);
        const basicHtml = `
          <div style="padding: 15px;">
            <h3 style="color: #e74c3c;">Error al cargar información completa</h3>
            <p>Factura ID: ${invoiceData.invoiceId}</p>
            <p>Total: ${formatCurrency(invoiceData.total)}</p>
          </div>
        `;
        invoicePrintContent.innerHTML = basicHtml;
      }
    }

    // Scanner Functions
    function initializeScanner() {
      // Inicialización del escáner
      if (typeof Html5Qrcode !== 'undefined') {
        html5QrCode = new Html5Qrcode("scannerViewport");
      }
    }

    async function startScanner() {
      try {
        if (!html5QrCode) return;
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        };
        
        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanError
        );
        
        isScannerActive = true;
        showToast('Escáner activado', 'success');
        
      } catch (error) {
        console.error('Scanner error:', error);
        showToast('Error al iniciar escáner', 'error');
      }
    }

    async function stopScanner() {
      if (html5QrCode && isScannerActive) {
        await html5QrCode.stop();
        isScannerActive = false;
      }
    }

    function onScanSuccess(decodedText) {
      stopScanner();
      mobileSearch.value = decodedText;
      
      // Buscar producto automáticamente SIN DUPLICADOS
      handleSearchWithAutoAdd(decodedText);
      
      scannerModal.style.display = 'none';
      showToast(`Código escaneado: ${decodedText}`, 'success');
    }

    function onScanError(error) {
      // Ignore scanning errors
    }

    // Shift Management
    async function checkCurrentShift() {
      try {
        const shiftsQuery = query(
          collection(db, "Shifts"),
          where("collaboratorId", "==", currentCollaborator.id),
          where("active", "==", true)
        );
        
        const snapshot = await getDocs(shiftsQuery);
        
        if (!snapshot.empty) {
          const shiftDoc = snapshot.docs[0];
          currentShift = {
            id: shiftDoc.id,
            ...shiftDoc.data()
          };
          
          updateShiftDisplay();
          startShiftTimer();
        } else {
          blockSession('No tienes un turno activo asignado.');
        }
        
      } catch (error) {
        console.error('Error checking shift:', error);
        blockSession('Error al verificar el turno. Contacte al administrador.');
      }
    }

    function updateShiftDisplay() {
      if (currentShift) {
        shiftUserName.textContent = `${currentCollaborator.firstName} ${currentCollaborator.lastName}`;
        shiftName.textContent = currentShift.shiftName || 'Turno Activo';
        
        const startTime = currentShift.startTime?.toDate();
        const endTime = currentShift.endTime?.toDate();
        
        if (startTime) {
          shiftStartTime.textContent = startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        if (endTime) {
          shiftEndTime.textContent = endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
      }
    }

    function startShiftTimer() {
      if (!currentShift || !currentShift.endTime) return;
      
      const endTime = currentShift.endTime.toDate();
      
      if (shiftTimer) clearInterval(shiftTimer);
      if (shiftEndTimer) clearTimeout(shiftEndTimer);
      
      shiftTimer = setInterval(() => {
        const now = new Date();
        const remaining = endTime - now;
        
        if (remaining <= 0) {
          clearInterval(shiftTimer);
          shiftTimeRemaining.textContent = 'FINALIZADO';
          shiftTimeRemaining.style.color = '#e74c3c';
          endShiftAutomatically();
        } else {
          const hours = Math.floor(remaining / (1000 * 60 * 60));
          const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
          
          shiftTimeRemaining.textContent = `${hours}h ${minutes}m ${seconds}s`;
          shiftTimeRemaining.style.color = hours === 0 && minutes < 30 ? '#f39c12' : '#16e086';
        }
      }, 1000);
      
      const remainingMs = endTime - new Date();
      if (remainingMs > 0) {
        shiftEndTimer = setTimeout(() => {
          endShiftAutomatically();
        }, remainingMs);
      }
    }

    async function endShiftAutomatically() {
      try {
        showLoading('Finalizando turno...');
        
        if (currentShift) {
          await updateDoc(doc(db, "Shifts", currentShift.id), {
            active: false,
            endTime: Timestamp.now()
          });
          
          await addDoc(collection(db, "ShiftHistory"), {
            collaboratorId: currentCollaborator.id,
            collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
            shiftName: currentShift.shiftName,
            startTime: currentShift.startTime,
            endTime: Timestamp.now(),
            duration: Math.floor((Date.now() - currentShift.startTime.toDate().getTime()) / (1000 * 60 * 60)),
            automatic: true,
            timestamp: Timestamp.now()
          });
          
          currentShift = null;
          shiftModal.style.display = 'none';
          
          blockSession('Tu turno ha terminado automáticamente.');
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error ending shift:', error);
        hideLoading();
        blockSession('Error al finalizar el turno automáticamente.');
      }
    }

    async function endShift() {
      try {
        showLoading('Finalizando turno...');
        
        if (currentShift) {
          await updateDoc(doc(db, "Shifts", currentShift.id), {
            active: false,
            endTime: Timestamp.now()
          });
          
          await addDoc(collection(db, "ShiftHistory"), {
            collaboratorId: currentCollaborator.id,
            collaboratorName: `${currentCollaborator.firstName} ${currentCollaborator.lastName}`,
            shiftName: currentShift.shiftName,
            startTime: currentShift.startTime,
            endTime: Timestamp.now(),
            duration: Math.floor((Date.now() - currentShift.startTime.toDate().getTime()) / (1000 * 60 * 60)),
            automatic: false,
            timestamp: Timestamp.now()
          });
          
          currentShift = null;
          shiftModal.style.display = 'none';
          
          blockSession('Turno finalizado manualmente.');
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('Error ending shift:', error);
        hideLoading();
        showToast('Error al finalizar turno', 'error');
      }
    }

    function blockSession(message) {
      if (!shiftModeEnabled) return; // No bloquear si el modo de turnos está desactivado
      
      shiftEndMessage.textContent = message;
      shiftEndModal.style.display = 'flex';
      posScreen.style.display = 'none';
      
      if (shiftTimer) clearInterval(shiftTimer);
      if (shiftEndTimer) clearTimeout(shiftEndTimer);
    }

    // Discount Functions
    async function applyDiscountWithPassword() {
      try {
        const password = discountPasswordInput.value.trim();
        
        if (!password) {
          showToast('Ingrese la contraseña', 'error');
          return;
        }
        
        if (discountSettings && discountSettings.password === password) {
          discountModal.style.display = 'none';
          discountPasswordInput.value = '';
          
          discountInput.value = discountSettings.percentage || 10;
          discountPercentageModal.style.display = 'flex';
          // Configurar teclado numérico para discountInput
          setupNumpadForModal('discountPercentageModal');
        } else {
          showToast('Contraseña incorrecta', 'error');
        }
        
      } catch (error) {
        console.error('Discount error:', error);
        showToast('Error al verificar descuento', 'error');
      }
    }

    function applyDiscountPercentage() {
      const discountValue = parseInt(discountInput.value);
      
      if (isNaN(discountValue) || discountValue < 0 || discountValue > 100) {
        showToast('Descuento inválido', 'error');
        return;
      }
      
      discount = discountValue;
      updateInvoiceDisplay();
      discountPercentageModal.style.display = 'none';
      showToast(`Descuento del ${discount}% aplicado`, 'success');
    }

    // CORRECCIÓN: User Profile Functions - Mostrar ID único
    async function loadUserProfile() {
      try {
        if (!currentCollaborator) return;
        
        const userRef = doc(db, "Collaborators", currentCollaborator.id);
        const userDoc = await getDoc(userRef);
        
        let userData = currentCollaborator;
        if (userDoc.exists()) {
          userData = { ...currentCollaborator, ...userDoc.data() };
        }
        
        // Actualizar información del perfil
        profileName.textContent = `${userData.firstName} ${userData.lastName}`;
        profileUsername.textContent = userData.username;
        // Mostrar el ID único generado
        profileUserId.textContent = userData.uniqueProfileId || generateUniqueProfileId(userData);
        profileFullName.textContent = `${userData.firstName} ${userData.lastName}`;
        profileShift.textContent = currentShift ? currentShift.shiftName || 'Activo' : 'No activo';
        
        // Determinar rol
        let role = 'Colaborador';
        if (userData.role) {
          role = userData.role;
        } else if (userData.isAdmin) {
          role = 'Administrador';
        }
        profileRole.textContent = role;
        
        // Cargar avatar si existe
        if (userData.avatarUrl) {
          try {
            const avatarRef = ref(storage, userData.avatarUrl);
            const avatarUrl = await getDownloadURL(avatarRef);
            profileAvatar.src = avatarUrl;
            profileAvatar.style.display = 'block';
            profileCarrotIcon.style.display = 'none';
            userAvatarMobile.src = avatarUrl;
            userAvatarMobile.style.display = 'block';
          } catch (error) {
            console.error('Error loading avatar:', error);
            // Mostrar icono de zanahoria
            showCarrotIcon();
          }
        } else {
          // Mostrar icono de zanahoria si no hay avatar
          showCarrotIcon();
        }
        
      } catch (error) {
        console.error('Error loading user profile:', error);
        showCarrotIcon();
      }
    }

    function showCarrotIcon() {
      // Para el perfil grande
      profileAvatar.style.display = 'none';
      profileCarrotIcon.style.display = 'flex';
      
      // Para el avatar pequeño
      userAvatarMobile.style.display = 'none';
      userBtnMobile.innerHTML = '<i class="fas fa-user"></i>';
    }

    // Config Functions
    async function saveConfig() {
      try {
        showLoading('Guardando configuración...');
        
        const configRef = doc(db, "userConfig", currentCollaborator.userId);
        await setDoc(configRef, {
          showRealTimeTotal: toggleRealTimeTotal.checked,
          lowStockNotifications: toggleLowStockNotifications.checked,
          expirationAlerts: toggleExpirationAlerts.checked,
          autoPrint: toggleAutoPrint.checked,
          alwaysActiveSearch: toggleAlwaysActiveSearch.checked,
          autoClearSearch: toggleAutoClearSearch.checked,
          shiftMode: toggleShiftMode.checked,
          quantityWindow: toggleQuantityWindow.checked,
          updatedAt: Timestamp.now(),
          updatedBy: currentCollaborator.username
        });
        
        showRealTimeTotal = toggleRealTimeTotal.checked;
        alwaysActiveSearchEnabled = toggleAlwaysActiveSearch.checked;
        autoClearSearchEnabled = toggleAutoClearSearch.checked;
        shiftModeEnabled = toggleShiftMode.checked;
        quantityWindowEnabled = toggleQuantityWindow.checked;
        
        if (showRealTimeTotal && invoice.length > 0) {
          realTimeTotalContainer.style.display = 'block';
          updateRealTimeTotal();
        } else {
          realTimeTotalContainer.style.display = 'none';
        }
        
        configModal.style.display = 'none';
        hideLoading();
        showToast('Configuración guardada', 'success');
        
      } catch (error) {
        console.error('Error saving config:', error);
        hideLoading();
        showToast('Error al guardar configuración', 'error');
      }
    }

    // Búsqueda con agregado automático
    async function handleSearchWithAutoAdd(searchTerm) {
      if (!searchTerm || searchTerm.trim() === '') {
        await loadProducts('');
        return;
      }
      
      try {
        if (isSearchInProgress) return;
        isSearchInProgress = true;
        
        showLoading('Buscando producto...');
        
        // Limpiar productos anteriores y el set de resultados
        productsGrid.innerHTML = '';
        currentSearchResults.clear();
        
        // Usar un Map para evitar duplicados
        const productsMap = new Map();
        
        const businessesRef = collection(db, "businesses");
        const businessesSnapshot = await getDocs(businessesRef);
        
        let foundProducts = [];
        
        for (const businessDoc of businessesSnapshot.docs) {
          const businessId = businessDoc.id;
          const productsRef = collection(db, "businesses", businessId, "products");
          const productsQuery = query(
            productsRef, 
            where("userId", "==", currentCollaborator.userId)
          );
          
          const querySnapshot = await getDocs(productsQuery);
          
          for (const productDoc of querySnapshot.docs) {
            const product = productDoc.data();
            
            const nameMatch = product.name.toLowerCase().includes(searchTerm.toLowerCase());
            const eanMatch = product.eanUpcCode?.includes(searchTerm);
            
            if (nameMatch || eanMatch) {
              // Crear una clave única para el producto
              const uniqueKey = `${businessId}_${productDoc.id}_${product.name}`;
              
              // Evitar duplicados usando el Map
              if (!productsMap.has(uniqueKey)) {
                productsMap.set(uniqueKey, {
                  productData: product,
                  businessName: businessId,
                  productId: productDoc.id,
                  uniqueKey: uniqueKey
                });
                foundProducts.push({
                  productData: product,
                  businessName: businessId,
                  productId: productDoc.id
                });
              }
            }
          }
        }
        
        // Limpiar el grid antes de agregar nuevos productos
        productsGrid.innerHTML = '';
        
        if (foundProducts.length === 1) {
          // Si solo hay un resultado, agregarlo automáticamente
          const product = foundProducts[0];
          
          // NUEVO: Verificar si necesita venta por unidad variable
          if (requiresVariableUnit(product.productData)) {
            showVariableUnitModal(product.productData, product.businessName, product.productId);
          } else if (quantityWindowEnabled) {
            showQuantityWindow(product.productData, product.businessName, product.productId);
          } else {
            addToInvoice(product.productData, product.businessName, product.productId);
          }
          
          // Limpiar buscador si auto-limpieza está habilitada
          if (autoClearSearchEnabled) {
            setTimeout(() => {
              mobileSearch.value = '';
              loadProducts('');
            }, 500);
          }
          
          hideLoading();
          isSearchInProgress = false;
        } else if (foundProducts.length > 1) {
          // Si hay múltiples resultados, mostrarlos sin duplicados
          displaySearchResults(foundProducts, searchTerm);
          hideLoading();
          isSearchInProgress = false;
        } else {
          // Si no hay resultados
          productsGrid.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);"><i class="fas fa-search" style="font-size: 40px; margin-bottom: 10px;"></i><p>No se encontraron productos para "' + searchTerm + '"</p></div>';
          hideLoading();
          isSearchInProgress = false;
          showToast('No se encontró el producto', 'info');
        }
        
      } catch (error) {
        console.error('Error in search:', error);
        hideLoading();
        isSearchInProgress = false;
        showToast('Error al buscar producto', 'error');
      }
    }

    function displaySearchResults(products, searchTerm) {
      const messageDiv = document.createElement('div');
      messageDiv.style.textAlign = 'center';
      messageDiv.style.padding = '8px';
      messageDiv.style.marginBottom = '12px';
      messageDiv.style.background = 'rgba(243, 156, 18, 0.1)';
      messageDiv.style.borderRadius = '8px';
      messageDiv.style.border = '1px solid rgba(243, 156, 18, 0.3)';
      messageDiv.innerHTML = `
        <p style="color: #f39c12; font-size: 13px; margin-bottom: 4px;">
          <i class="fas fa-info-circle"></i> Se encontraron ${products.length} productos
        </p>
        <p style="color: rgba(255,255,255,0.8); font-size: 11px;">
          Seleccione el producto que desea agregar
        </p>
      `;
      productsGrid.appendChild(messageDiv);
      
      // Crear tarjetas para cada producto encontrado (sin duplicados)
      const processedKeys = new Set();
      products.forEach(productInfo => {
        const uniqueKey = `${productInfo.businessName}_${productInfo.productId}_${productInfo.productData.name}`;
        if (!processedKeys.has(uniqueKey)) {
          processedKeys.add(uniqueKey);
          createProductCard(
            productInfo.productData,
            productInfo.businessName,
            productInfo.productId
          );
        }
      });
    }

    // View Toggle Functions
    function setProductView(view) {
      if (view === 'grid') {
        viewGridMobile.classList.add('active');
        viewListMobile.classList.remove('active');
        productsGrid.classList.remove('list-view');
        productsGrid.style.display = 'grid';
      } else if (view === 'list') {
        viewListMobile.classList.add('active');
        viewGridMobile.classList.remove('active');
        productsGrid.classList.add('list-view');
        productsGrid.style.display = 'flex';
      }
    }

    // CORRECCIÓN: Configuración inicial de teclados numéricos
    function initializeAllNumpads() {
      // Configurar teclados cuando se abren los modales
      const modalsWithNumpads = ['cashModal', 'discountModal', 'discountPercentageModal'];
      
      modalsWithNumpads.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          // Configurar cuando se muestre el modal
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                if (modal.style.display === 'flex') {
                  setupNumpadForModal(modalId);
                }
              }
            });
          });
          
          observer.observe(modal, { attributes: true });
        }
      });
    }

    // CORRECCIÓN: History functions - CORREGIDAS para manejar errores y diferentes estructuras de datos
    async function loadHistory() {
      try {
        showLoading('Cargando historial...');
        
        historyContainer.innerHTML = '';
        
        if (!currentCollaborator) {
          historyContainer.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);"><i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay historial disponible</p></div>';
          hideLoading();
          return;
        }
        
        let allInvoices = [];
        
        // Intentar cargar de facturacionCarrito (ubicación principal)
        try {
          const invoiceQuery = query(
            collection(db, "facturacionCarrito"),
            where("userId", "==", currentCollaborator.userId),
            orderBy("timestamp", "desc"),
            limit(50)
          );
          
          const snapshot = await getDocs(invoiceQuery);
          
          snapshot.forEach((doc) => {
            try {
              const invoiceData = doc.data();
              // Asegurarse de que la factura pertenece al colaborador actual
              if (invoiceData.collaboratorId === currentCollaborator.id || 
                  invoiceData.userId === currentCollaborator.userId ||
                  invoiceData.username === currentCollaborator.username) {
                allInvoices.push({
                  id: doc.id,
                  ...invoiceData,
                  source: 'facturacionCarrito'
                });
              }
            } catch (error) {
              console.warn('Error procesando documento de facturacionCarrito:', error);
            }
          });
        } catch (error) {
          console.warn('Error al cargar facturacionCarrito:', error);
        }
        
        // Si no hay facturas, intentar cargar del historial del usuario
        if (allInvoices.length === 0) {
          try {
            const userHistoryRef = collection(db, "users", currentCollaborator.userId, "invoiceHistory");
            const userHistoryQuery = query(
              userHistoryRef,
              orderBy("timestamp", "desc"),
              limit(50)
            );
            
            const userSnapshot = await getDocs(userHistoryQuery);
            
            userSnapshot.forEach((doc) => {
              try {
                const invoiceData = doc.data();
                allInvoices.push({
                  id: doc.id,
                  ...invoiceData,
                  source: 'userHistory'
                });
              } catch (error) {
                console.warn('Error procesando documento de userHistory:', error);
              }
            });
          } catch (error) {
            console.warn('Error al cargar userHistory:', error);
          }
        }
        
        // Si no hay facturas, mostrar mensaje
        if (allInvoices.length === 0) {
          historyContainer.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);"><i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay historial de facturas</p></div>';
          hideLoading();
          return;
        }
        
        // Ordenar facturas por fecha (más recientes primero)
        allInvoices.sort((a, b) => {
          const dateA = a.timestamp?.toDate?.() || new Date(a.date || 0);
          const dateB = b.timestamp?.toDate?.() || new Date(b.date || 0);
          return dateB - dateA;
        });
        
        // Mostrar solo las últimas 30 facturas
        const recentInvoices = allInvoices.slice(0, 30);
        
        // Crear elementos para cada factura
        recentInvoices.forEach((invoiceData) => {
          try {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            // Extraer información con manejo de errores
            const invoiceId = invoiceData.invoiceId || invoiceData.id || 'Sin ID';
            const total = invoiceData.total || 0;
            const paymentType = invoiceData.paymentType || 'Desconocido';
            const itemsCount = invoiceData.items?.length || 0;
            const collaboratorName = invoiceData.collaboratorName || currentCollaborator.firstName + ' ' + currentCollaborator.lastName;
            
            // Obtener fecha con manejo de errores
            let invoiceDate;
            try {
              if (invoiceData.timestamp?.toDate) {
                invoiceDate = invoiceData.timestamp.toDate();
              } else if (invoiceData.date) {
                invoiceDate = new Date(invoiceData.date);
              } else {
                invoiceDate = new Date();
              }
            } catch (error) {
              invoiceDate = new Date();
            }
            
            // Marcar si tiene productos vencidos
            const expiredBadge = invoiceData.hasExpiredProducts ? 
              '<span class="history-expired-badge">VENCIDOS</span>' : '';
            
            // NUEVO: Marcar si tiene ventas por unidad variable
            const variableUnitBadge = invoiceData.hasVariableUnitSales ? 
              '<span class="history-variable-badge" style="background: #9b59b6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 8px;"><i class="fas fa-balance-scale"></i> PESO</span>' : '';
            
            historyItem.innerHTML = `
              <div class="history-header">
                <span class="history-id">${invoiceId}</span>
                ${expiredBadge}
                ${variableUnitBadge}
                <span class="history-date">${formatDate(invoiceDate)}</span>
              </div>
              <div class="history-details">
                <div class="history-detail">
                  <span class="history-label">Total</span>
                  <span class="history-value">${formatCurrency(total)}</span>
                </div>
                <div class="history-detail">
                  <span class="history-label">Método</span>
                  <span class="history-value">${paymentType}</span>
                </div>
                <div class="history-detail">
                  <span class="history-label">Items</span>
                  <span class="history-value">${itemsCount}</span>
                </div>
              </div>
              <div class="history-collaborator">
                <small>${collaboratorName}</small>
              </div>
            `;
            
            historyContainer.appendChild(historyItem);
          } catch (error) {
            console.error('Error creando elemento de historial:', error);
          }
        });
        
        hideLoading();
        
      } catch (error) {
        console.error('Error general al cargar historial:', error);
        historyContainer.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);"><i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 10px;"></i><p>Error al cargar el historial. Intente nuevamente.</p></div>';
        hideLoading();
        showToast('Error al cargar historial', 'error');
      }
    }

    // ====================================================================
    // EVENT LISTENERS - TODOS LOS EVENTOS ORIGINALES MANTENIDOS
    // ====================================================================

    mobileLoginBtn.addEventListener('click', async () => {
      const username = mobileUsername.value.trim();
      const pin = mobilePin.value.trim();
      
      if (!username || !pin) {
        loginError.textContent = 'Por favor complete todos los campos';
        loginError.style.display = 'block';
        return;
      }
      
      const authenticated = await authenticateCollaborator(username, pin);
      
      if (authenticated) {
        loginError.style.display = 'none';
        loginScreen.style.display = 'none';
        posScreen.style.display = 'flex';
        
        checkHeaderLogo();
        await loadCollaboratorData();
        initializeScanner();
        initializeAllNumpads(); // Inicializar teclados numéricos
        
        if (alwaysActiveSearchEnabled) {
          setTimeout(() => {
            mobileSearch.focus();
          }, 500);
        }
      }
    });

    // Permitir inicio de sesión con Enter
    mobileUsername.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        mobilePin.focus();
      }
    });

    mobilePin.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        mobileLoginBtn.click();
      }
    });

    // Search functionality
    let searchTimeout = null;
    mobileSearch.addEventListener('input', async (e) => {
      const searchTerm = e.target.value.trim();
      
      // Limpiar timeout anterior
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // Si el usuario está borrando y el campo está vacío, cargar todos los productos inmediatamente
      if (searchTerm === '') {
        await loadProducts('');
        lastSearchQuery = ''; // Resetear la última búsqueda
        return;
      }
      
      // Usar debounce para evitar múltiples búsquedas rápidas
      searchTimeout = setTimeout(async () => {
        if (autoClearSearchEnabled && searchTerm !== '') {
          setupAutoClearSearch(searchTerm);
        }
        
        if (searchTerm !== '') {
          await loadProducts(searchTerm);
        }
      }, 300); // 300ms de delay
    });

    mobileSearch.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        const searchTerm = mobileSearch.value.trim();
        if (searchTerm !== '') {
          await handleSearchWithAutoAdd(searchTerm);
        }
      }
    });

    // Scanner
    scannerBtnMobile.addEventListener('click', () => {
      scannerModal.style.display = 'flex';
      if (!isScannerActive) {
        startScanner();
      }
    });

    switchCameraBtn.addEventListener('click', async () => {
      await stopScanner();
      await startScanner();
    });

    // Ventana de cantidad
    quantityDecrease.addEventListener('click', () => {
      let quantity = parseInt(quantityDisplay.textContent);
      if (quantity > 1) {
        quantity--;
        quantityDisplay.textContent = quantity;
      }
    });

    quantityIncrease.addEventListener('click', () => {
      let quantity = parseInt(quantityDisplay.textContent);
      if (quantity < 100) {
        quantity++;
        quantityDisplay.textContent = quantity;
      }
    });

    quantityCancel.addEventListener('click', () => {
      quantityModal.style.display = 'none';
      currentProductForQuantity = null;
    });

    quantityAdd.addEventListener('click', () => {
      const quantity = parseInt(quantityDisplay.textContent);
      addProductWithQuantity(quantity);
    });

    // NUEVO: Event Listeners para modal de unidades variables
    closeUnitModal.addEventListener('click', closeVariableUnitModal);
    unitCancel.addEventListener('click', closeVariableUnitModal);
    unitAddToCart.addEventListener('click', addVariableUnitToCart);
    
    unitDecrease.addEventListener('click', () => {
      let currentValue = parseFloat(unitCustomQuantity.value) || 1;
      if (currentValue > 0.01) {
        currentValue = Math.max(0.01, currentValue - 0.1);
        unitCustomQuantity.value = currentValue.toFixed(2);
        calculateUnitTotal();
      }
    });
    
    unitIncrease.addEventListener('click', () => {
      let currentValue = parseFloat(unitCustomQuantity.value) || 1;
      currentValue += 0.1;
      unitCustomQuantity.value = currentValue.toFixed(2);
      calculateUnitTotal();
    });
    
    unitCustomQuantity.addEventListener('input', () => {
      calculateUnitTotal();
    });
    
    // También cerrar modal de unidades al hacer clic fuera
    unitModal.addEventListener('click', (e) => {
      if (e.target === unitModal) {
        closeVariableUnitModal();
      }
    });

    // View toggle
    viewGridMobile.addEventListener('click', () => {
      setProductView('grid');
    });

    viewListMobile.addEventListener('click', () => {
      setProductView('list');
    });

    // Navigation
    navProducts.addEventListener('click', (e) => {
      e.preventDefault();
      invoiceSection.classList.remove('active');
      navProducts.classList.add('active');
      navInvoice.classList.remove('active');
      navHistory.classList.remove('active');
      navReports.classList.remove('active');
      navMenu.classList.remove('active');
    });

    navInvoice.addEventListener('click', (e) => {
      e.preventDefault();
      invoiceSection.classList.add('active');
      navProducts.classList.remove('active');
      navInvoice.classList.add('active');
      navHistory.classList.remove('active');
      navReports.classList.remove('active');
      navMenu.classList.remove('active');
    });

    navHistory.addEventListener('click', async (e) => {
      e.preventDefault();
      await loadHistory();
      historyModal.style.display = 'flex';
      navProducts.classList.remove('active');
      navInvoice.classList.remove('active');
      navHistory.classList.add('active');
      navReports.classList.remove('active');
      navMenu.classList.remove('active');
    });

    navReports.addEventListener('click', (e) => {
      e.preventDefault();
      // Redirigir a estadistica-rapida-colaboradores.html
      window.location.href = 'estadistica-rapida-colaboradores.html';
      navProducts.classList.remove('active');
      navInvoice.classList.remove('active');
      navHistory.classList.remove('active');
      navReports.classList.add('active');
      navMenu.classList.remove('active');
    });

    navMenu.addEventListener('click', (e) => {
      e.preventDefault();
      menuModal.style.display = 'flex';
      navProducts.classList.remove('active');
      navInvoice.classList.remove('active');
      navHistory.classList.remove('active');
      navReports.classList.remove('active');
      navMenu.classList.add('active');
    });

    closeInvoiceBtn.addEventListener('click', () => {
      invoiceSection.classList.remove('active');
      navProducts.classList.add('active');
      navInvoice.classList.remove('active');
    });

    // Header buttons
    userBtnMobile.addEventListener('click', (e) => {
      e.preventDefault();
      // Evitar múltiples clics rápidos
      if (userBtnMobile.classList.contains('processing')) return;
      
      userBtnMobile.classList.add('processing');
      loadUserProfile();
      userInfoModal.style.display = 'flex';
      
      setTimeout(() => {
        userBtnMobile.classList.remove('processing');
      }, 500);
    });

    shiftBtnMobile.addEventListener('click', () => {
      if (shiftModeEnabled) {
        updateShiftDisplay();
        shiftModal.style.display = 'flex';
      } else {
        showToast('Modo de turnos desactivado', 'info');
      }
    });

    // Menu hamburger para tablet/PC
    menuHamburgerBtn.addEventListener('click', () => {
      menuModal.style.display = 'flex';
    });

    // User info modal
    closeUserInfoModal.addEventListener('click', () => {
      userInfoModal.style.display = 'none';
    });

    // CORRECCIÓN: Logout button cierra el modal y hace logout
    logoutBtn.addEventListener('click', () => {
      userInfoModal.style.display = 'none';
      setTimeout(() => {
        logoutCollaborator();
      }, 300);
    });

    // Payment buttons
    discountBtnMobile.addEventListener('click', () => {
      discountPasswordInput.value = '';
      discountModal.style.display = 'flex';
      // Configurar teclado para contraseña
      setupNumpadForModal('discountModal');
    });

    cashBtnMobile.addEventListener('click', () => {
      setupCashPayment();
      cashModal.style.display = 'flex';
    });

    cardBtnMobile.addEventListener('click', () => {
      cardModal.style.display = 'flex';
    });

    // CORRECCIÓN DEL BOTÓN "FACTURAR" - Ahora funciona igual que "Efectivo"
    invoiceBtnMobile.addEventListener('click', () => {
      setupCashPayment();
      cashModal.style.display = 'flex';
    });

    // Discount modals
    verifyDiscountBtn.addEventListener('click', applyDiscountWithPassword);

    discountClearPasswordBtn.addEventListener('click', () => {
      discountPasswordInput.value = '';
    });

    discountBackspaceBtn.addEventListener('click', () => {
      discountPasswordInput.value = discountPasswordInput.value.slice(0, -1);
    });

    discountClearBtn.addEventListener('click', () => {
      discountInput.value = '';
    });

    discountBackspaceBtn2.addEventListener('click', () => {
      discountInput.value = discountInput.value.slice(0, -1);
    });

    applyDiscountBtn.addEventListener('click', applyDiscountPercentage);

    // Card payment
    confirmCardBtn.addEventListener('click', async () => {
      await processPayment('Tarjeta');
    });

    // Shift modal
    endShiftBtn.addEventListener('click', endShift);

    // Menu items
    menuInventory.addEventListener('click', (e) => {
      // El enlace ya está configurado en el HTML
    });

    menuReportsMain.addEventListener('click', (e) => {
      // El enlace ya está configurado en el HTML
    });

    menuInvoices.addEventListener('click', (e) => {
      // El enlace ya está configurado en el HTML
    });

    menuAnalysis.addEventListener('click', (e) => {
      // El enlace ya está configurado en el HTML
    });

    menuConfigMain.addEventListener('click', (e) => {
      e.preventDefault();
      configModal.style.display = 'flex';
      menuModal.style.display = 'none';
    });

    // Config
    saveConfigBtn.addEventListener('click', saveConfig);

    // Print modal
    printInvoiceBtn.addEventListener('click', () => {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Factura ${Date.now()}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 15px; }
              @media print {
                body { padding: 0; }
                button { display: none; }
              }
            </style>
          </head>
          <body>
            ${invoicePrintContent.innerHTML}
            <button onclick="window.print()" style="margin-top: 15px; padding: 8px 15px; background: #16e086; color: white; border: none; border-radius: 4px; cursor: pointer;">Imprimir</button>
          </body>
        </html>
      `);
      printWindow.document.close();
    });

    sendInvoiceBtn.addEventListener('click', () => {
      printModal.style.display = 'none';
      sendInvoiceModal.style.display = 'flex';
    });

    sendWhatsAppBtn.addEventListener('click', () => {
      const phoneNumber = whatsappNumber.value.trim();
      
      if (!phoneNumber) {
        showToast('Ingrese un número de teléfono', 'error');
        return;
      }
      
      if (!/^\d{10,}$/.test(phoneNumber)) {
        showToast('Ingrese un número válido (10 dígitos mínimo, sin código de país)', 'error');
        return;
      }
      
      const phoneNumberWithCountryCode = `+1${phoneNumber}`;
      const message = window.currentWhatsAppMessage;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${phoneNumberWithCountryCode}?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
      sendInvoiceModal.style.display = 'none';
      showToast('Factura preparada para WhatsApp', 'success');
    });

    copyInvoiceBtn.addEventListener('click', () => {
      const message = window.currentWhatsAppMessage;
      
      navigator.clipboard.writeText(message).then(() => {
        showToast('Factura copiada al portapapeles', 'success');
        sendInvoiceModal.style.display = 'none';
      }).catch(err => {
        showToast('Error al copiar al portapapeles', 'error');
      });
    });

    // Shift end modal
    changeAccountBtn.addEventListener('click', () => {
      logoutCollaborator();
      shiftEndModal.style.display = 'none';
    });

    reloadPageBtn.addEventListener('click', () => {
      location.reload();
    });

    // Close modal handlers
    const closeButtons = [
      closeCashModal, closeCardModal, closeDiscountModal, closeDiscountPercentageModal, 
      closeScannerModal, closeShiftModal, closeConfigModal,
      closeHistoryModal, closeReportsModal, closeMenuModal,
      closePrintModal, closeSendInvoiceModal
    ];
    
    closeButtons.forEach(btn => {
      if (btn) {
        btn.addEventListener('click', () => {
          btn.closest('.modal-mobile').style.display = 'none';
        });
      }
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal-mobile').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    });

    // También cerrar ventana de cantidad al hacer clic fuera
    quantityModal.addEventListener('click', (e) => {
      if (e.target === quantityModal) {
        quantityModal.style.display = 'none';
        currentProductForQuantity = null;
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-mobile').forEach(modal => {
          modal.style.display = 'none';
        });
        quantityModal.style.display = 'none';
        if (unitModalOpen) {
          closeVariableUnitModal();
        }
      }
      
      if (e.key === 'Delete' && document.activeElement !== mobileSearch) {
        e.preventDefault();
        mobileSearch.value = '';
        loadProducts('');
        if (alwaysActiveSearchEnabled) {
          mobileSearch.focus();
        }
      }
    });

    // Check for saved session
    window.addEventListener('load', () => {
      if (localStorage.getItem('collaboratorLoggedIn') === 'true') {
        const savedData = localStorage.getItem('collaboratorData');
        if (savedData) {
          currentCollaborator = JSON.parse(savedData);
          loginScreen.style.display = 'none';
          posScreen.style.display = 'flex';   
          
          checkHeaderLogo();
          loadCollaboratorData();
          initializeScanner();
          initializeAllNumpads(); // Inicializar teclados numéricos
          
          if (alwaysActiveSearchEnabled) {
            setTimeout(() => {
              mobileSearch.focus();
            }, 500);
          }
        }
      }
      
      // Inicializar todos los teclados numéricos
      initializeAllNumpads();
    });

    // ====================================================================
    // HACER FUNCIONES DISPONIBLES GLOBALMENTE
    // ====================================================================
    window.removeFromInvoice = removeFromInvoice;
    
    // Función auxiliar para calcular estado de vencimiento
    function getExpirationStatus(product) {
      if (!product.expirationDate) return { status: 'no-date', days: null };
      
      const currentDate = new Date();
      const expiration = new Date(product.expirationDate);
      const timeDiff = expiration.getTime() - currentDate.getTime();
      const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      const alertDays = product.alertDays || 30;
      
      if (daysDiff < 0) {
        return { status: 'expired', days: Math.abs(daysDiff) };
      } else if (daysDiff <= alertDays) {
        return { status: 'expiring-soon', days: daysDiff };
      } else {
        return { status: 'ok', days: daysDiff };
      }
    }
    
    // Inicializar estilos CSS adicionales
    document.addEventListener('DOMContentLoaded', () => {
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        .expiration-modal-overlay {
          animation: fadeIn 0.3s ease-out;
        }
        
        .history-expired-badge {
          background: #e74c3c;
          color: white;
          padding: 2px 6px;
          border-radius: 4px;
          font-size: 10px;
          font-weight: bold;
          margin-left: 8px;
        }
        
        /* NUEVO: Estilos para el modal de unidades variables */
        .badge-variable {
          background: #9b59b6 !important;
          position: absolute;
          top: 5px;
          right: 5px;
          z-index: 1;
        }
        
        /* NUEVO: Estilos para notificaciones - CORREGIDOS */
        .notification-toast {
          animation: slideInRight 0.3s ease;
          z-index: 9998 !important;
        }
        
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
          0% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
          50% { transform: scale(1.1); box-shadow: 0 3px 12px rgba(0,0,0,0.4); }
          100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        }
        
        /* CORRECCIÓN: Para pantallas grandes, adaptación completa */
        @media (min-width: 769px) {
          body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2b3c, #2c3e50);
          }
          
          .mobile-container {
            max-width: 90%; 
            height: 95vh;
          }
        }
        
        @media (min-width: 1200px) {
          .mobile-container {
            max-width: 1100px;
          }
        }
        
        @media (min-width: 1600px) {
          .mobile-container {
            max-width: 1300px;
          }
          
          .modal-content-mobile {
            max-width: 700px;
          }
        }
        
        /* CORRECCIÓN: Para dispositivos móviles, asegurar que no interfiera con la barra inferior */
        @media (max-height: 700px) {
          #notificationIcon {
            top: 60px !important;
          }
          
          .notification-toast {
            top: 50px !important;
          }
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>
