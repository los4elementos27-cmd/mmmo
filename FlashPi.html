<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retom - Transporte Inteligente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS VARIABLES & RESET ===== */
        :root {
            --primary: #00d4ff;
            --secondary: #7b2cbf;
            --success: #00c96e;
            --warning: #ffaa00;
            --danger: #ff2255;
            --dark-bg: #090e17;
            --surface: #111827;
            --surface2: #1c2537;
            --surface3: #243047;
            --text: #f0f4ff;
            --text-dim: rgba(200,215,255,0.55);
            --text-dimmer: rgba(200,215,255,0.28);
            --border: rgba(100,140,255,0.12);
            --border-active: rgba(0,212,255,0.45);
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
            --radius: 14px;
            --radius-sm: 9px;
            --radius-lg: 22px;
            --fs-xs: clamp(9px, 2vw, 11px);
            --fs-sm: clamp(10px, 2.2vw, 12px);
            --fs-base: clamp(11px, 2.5vw, 13px);
            --fs-md: clamp(12px, 2.8vw, 14px);
            --fs-lg: clamp(14px, 3.2vw, 17px);
            --fs-xl: clamp(18px, 4vw, 24px);
            --fs-2xl: clamp(22px, 5vw, 30px);
            --pad-sm: clamp(6px, 2vw, 10px);
            --pad: clamp(10px, 3vw, 16px);
            --pad-lg: clamp(14px, 4vw, 22px);
        }

        [data-theme="light"] {
            --dark-bg: #eef2fb;
            --surface: #ffffff;
            --surface2: #f0f4ff;
            --surface3: #e4eaf8;
            --text: #0d1520;
            --text-dim: rgba(20,40,80,0.6);
            --text-dimmer: rgba(20,40,80,0.35);
            --border: rgba(80,120,200,0.15);
            --shadow: 0 8px 32px rgba(100,140,220,0.15);
        }

        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

        html, body {
            height: 100%; width: 100%;
            font-family: 'Poppins', sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            overflow: hidden;
            position: fixed;
            font-size: var(--fs-base);
        }

        /* ===== MAP ===== */
        #map {
            height: 100%; width: 100%;
            position: absolute; top:0; left:0; z-index:1;
        }

        /* ===== SCREENS ===== */
        .screen {
            display: none;
            position: fixed; inset:0;
            z-index: 100;
            background: linear-gradient(145deg, #060d1a 0%, #0d1e33 50%, #060d1a 100%);
            overflow-y: auto;
            overflow-x: hidden;
        }
        .screen.active { display:flex; flex-direction:column; }

        /* ===== AUTH ===== */
        .auth-bg {
            position: fixed; inset:0;
            background: radial-gradient(ellipse at 20% 20%, rgba(0,140,255,0.08) 0%, transparent 60%),
                        radial-gradient(ellipse at 80% 80%, rgba(123,44,191,0.08) 0%, transparent 60%);
            pointer-events: none;
        }
        .auth-container {
            flex:1; display:flex; justify-content:center; align-items:flex-start;
            padding: var(--pad); min-height:100%; overflow-y:auto; z-index:1;
        }
        .auth-card {
            background: rgba(17,24,39,0.97);
            border-radius: var(--radius-lg);
            padding: var(--pad-lg);
            width:100%; max-width:420px;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            margin: auto;
        }
        .logo-big {
            width: clamp(52px,12vw,68px); height: clamp(52px,12vw,68px);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius);
            display:flex; align-items:center; justify-content:center;
            font-size: clamp(24px,6vw,34px);
            margin: 0 auto var(--pad-lg);
            box-shadow: 0 8px 32px rgba(0,212,255,0.25);
        }
        .auth-card h1 {
            text-align:center; margin-bottom:4px;
            font-size: var(--fs-xl); font-weight:800;
            background: linear-gradient(135deg,var(--primary),var(--secondary));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        }
        .auth-card > p { text-align:center; color:var(--text-dim); margin-bottom:var(--pad-lg); font-size:var(--fs-sm); }

        .role-selector { display:flex; gap:10px; margin-bottom:var(--pad-lg); }
        .role-btn {
            flex:1; padding:var(--pad-sm) var(--pad);
            background: var(--surface2);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            cursor:pointer; transition:all 0.25s; text-align:center;
            font-size: var(--fs-sm); font-family:'Poppins',sans-serif;
        }
        .role-btn.active { border-color:var(--primary); background:rgba(0,212,255,0.08); color:var(--primary); }
        .role-btn i { font-size:clamp(18px,4vw,22px); margin-bottom:5px; display:block; }

        .photo-upload {
            width: clamp(80px,22vw,110px); height: clamp(80px,22vw,110px);
            border-radius:50%; border:2px dashed rgba(0,212,255,0.3);
            margin:0 auto var(--pad-lg); display:flex; flex-direction:column;
            align-items:center; justify-content:center;
            cursor:pointer; position:relative; overflow:hidden;
            background: var(--surface2);
        }
        .photo-upload img { width:100%; height:100%; object-fit:cover; position:absolute; }
        .photo-upload i { font-size:clamp(20px,5vw,28px); color:var(--primary); margin-bottom:5px; }
        .photo-upload span { font-size:var(--fs-xs); color:var(--text-dim); text-align:center; padding:0 8px; }
        #photoInput { display:none; }

        .input-group { margin-bottom:10px; }
        .input-group label {
            display:block; margin-bottom:5px;
            font-size:var(--fs-xs); color:var(--text-dim);
            text-transform:uppercase; letter-spacing:0.5px; font-weight:600;
        }
        .input {
            width:100%; background:var(--surface2);
            border:1px solid var(--border); border-radius:var(--radius-sm);
            padding: var(--pad-sm) var(--pad); color:var(--text);
            font-size:var(--fs-md); outline:none; transition:all 0.25s;
            font-family:'Poppins',sans-serif;
        }
        .input:focus { border-color:var(--primary); box-shadow:0 0 0 2px rgba(0,212,255,0.12); }
        select.input { cursor:pointer; }

        .input-row { display:flex; gap:8px; }
        .input-row .input-group { flex:1; }

        .btn {
            width:100%; background:linear-gradient(135deg,var(--primary),var(--secondary));
            border:none; border-radius:var(--radius-sm);
            padding: var(--pad-sm) var(--pad);
            color:#fff; font-size:var(--fs-md); font-weight:700;
            cursor:pointer; transition:all 0.25s;
            display:flex; align-items:center; justify-content:center; gap:7px;
            font-family:'Poppins',sans-serif;
        }
        .btn:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,212,255,0.25); }
        .btn:disabled { opacity:0.45; cursor:not-allowed; transform:none; }
        .btn-secondary { background:transparent; border:1px solid var(--border); margin-top:8px; color:var(--text); }
        .btn-success { background:linear-gradient(135deg,var(--success),#008850); }
        .btn-danger { background:linear-gradient(135deg,var(--danger),#bb0033); }
        .btn-warning { background:linear-gradient(135deg,var(--warning),#cc8800); }
        .btn-sm { padding:7px 12px; font-size:var(--fs-sm); width:auto; }

        /* ===== MAIN APP HEADER ===== */
        .app-header {
            position:fixed; top:0; left:0; right:0; z-index:900;
            background:rgba(9,14,23,0.92);
            backdrop-filter:blur(16px);
            border-bottom:1px solid var(--border);
            padding: 8px var(--pad);
            display:flex; align-items:center; gap:8px;
            min-height:52px;
        }
        [data-theme="light"] .app-header { background:rgba(238,242,251,0.92); }

        .header-logo { font-size:clamp(15px,3.5vw,19px); font-weight:800; color:var(--primary); letter-spacing:1px; }
        .header-logo span { color:var(--text-dim); font-weight:400; font-size:var(--fs-xs); margin-left:4px; }

        .header-nav { display:flex; gap:4px; flex:1; justify-content:center; overflow-x:auto; }
        .header-nav::-webkit-scrollbar { display:none; }
        .nav-item {
            padding:5px 10px; border-radius:20px; font-size:var(--fs-xs);
            color:var(--text-dim); cursor:pointer; transition:all 0.2s;
            white-space:nowrap; font-weight:500; border:1px solid transparent;
            background:none;
        }
        .nav-item:hover, .nav-item.active { color:var(--primary); background:rgba(0,212,255,0.08); border-color:rgba(0,212,255,0.2); }
        .nav-item i { margin-right:4px; }

        .header-actions { display:flex; gap:6px; align-items:center; }
        .hdr-btn {
            width:34px; height:34px; border-radius:50%;
            background:var(--surface2); border:1px solid var(--border);
            color:var(--text); cursor:pointer; font-size:13px;
            display:flex; align-items:center; justify-content:center;
            transition:all 0.2s; position:relative;
        }
        .hdr-btn:hover { border-color:var(--primary); color:var(--primary); }
        .hdr-btn .badge {
            position:absolute; top:-3px; right:-3px;
            width:16px; height:16px; background:var(--danger);
            border-radius:50%; font-size:9px; display:flex;
            align-items:center; justify-content:center; font-weight:700;
        }
        .user-pill {
            display:flex; align-items:center; gap:7px;
            background:var(--surface2); border:1px solid var(--border);
            border-radius:20px; padding:3px 10px 3px 4px;
            cursor:pointer; transition:all 0.2s; font-size:var(--fs-sm); font-weight:600;
        }
        .user-pill:hover { border-color:var(--primary); }
        .user-pill img { width:26px; height:26px; border-radius:50%; object-fit:cover; }
        .user-pill i { font-size:18px; color:var(--text-dim); }

        /* ===== MAP CONTROLS ===== */
        .map-controls {
            position:fixed; top:60px; right:10px; z-index:800;
            display:flex; flex-direction:column; gap:7px;
        }
        .map-ctrl-btn {
            width:38px; height:38px; background:rgba(17,24,39,0.95);
            border:1px solid var(--border); border-radius:10px;
            color:var(--text); display:flex; align-items:center;
            justify-content:center; cursor:pointer; font-size:14px;
            backdrop-filter:blur(10px); transition:all 0.2s;
        }
        [data-theme="light"] .map-ctrl-btn { background:rgba(255,255,255,0.95); }
        .map-ctrl-btn:hover { border-color:var(--primary); color:var(--primary); }
        .map-ctrl-btn.muted { color:var(--danger); border-color:var(--danger); }

        /* ===== FLOATING STATUS ===== */
        .floating-status {
            position:fixed; top:58px; left:50%; transform:translateX(-50%) translateY(-80px);
            background:rgba(17,24,39,0.97); backdrop-filter:blur(16px);
            border:1.5px solid var(--primary); border-radius:50px;
            padding:10px 22px; z-index:700;
            display:flex; align-items:center; gap:10px;
            font-weight:700; font-size:var(--fs-sm);
            box-shadow:0 8px 30px rgba(0,212,255,0.2);
            opacity:0; transition:all 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);
            pointer-events:auto; max-width:92vw;
        }
        .floating-status.active { transform:translateX(-50%) translateY(0); opacity:1; }
        .floating-status i { font-size:15px; color:var(--primary); animation:pulse-icon 2s infinite; }
        .floating-status .repeat-btn {
            width:28px; height:28px; border-radius:50%; background:rgba(0,212,255,0.15);
            border:none; color:var(--primary); cursor:pointer; font-size:12px;
            display:flex; align-items:center; justify-content:center;
        }
        @keyframes pulse-icon { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.2);opacity:0.7} }

        /* ===== SOS ===== */
        .sos-button {
            position:fixed; bottom:90px; right:12px;
            width:50px; height:50px; background:var(--danger);
            border:none; border-radius:50%; color:#fff;
            font-size:11px; font-weight:800; cursor:pointer; z-index:700;
            display:none; align-items:center; justify-content:center;
            box-shadow:0 4px 16px rgba(255,0,85,0.4);
            animation:sos-pulse 2s infinite;
        }
        .sos-button.active { display:flex; }
        @keyframes sos-pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

        /* ===== ADDRESS SELECTION MODAL ===== */
        .addr-modal {
            position:fixed; inset:0; z-index:2500;
            background:rgba(6,13,26,0.97); backdrop-filter:blur(10px);
            display:none; flex-direction:column;
        }
        .addr-modal.active { display:flex; }
        .addr-modal-header {
            padding:var(--pad) var(--pad-lg);
            border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:10px;
            background:var(--surface); min-height:52px;
            padding-top:max(var(--pad), env(safe-area-inset-top));
        }
        .addr-modal-header h3 { font-size:var(--fs-md); font-weight:700; flex:1; }
        .addr-modal-close {
            width:32px; height:32px; border-radius:50%;
            background:var(--surface2); border:none; color:var(--text);
            cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:15px;
        }
        .addr-modal-body { flex:1; overflow-y:auto; padding:var(--pad); }
        .addr-search-row {
            display:flex; gap:8px; margin-bottom:var(--pad);
        }
        .addr-search-input {
            flex:1; background:var(--surface2); border:1.5px solid var(--border);
            border-radius:var(--radius-sm); padding:var(--pad-sm) var(--pad);
            color:var(--text); font-size:var(--fs-md); outline:none;
            font-family:'Poppins',sans-serif; transition:all 0.25s;
        }
        .addr-search-input:focus { border-color:var(--primary); }
        .addr-map-btn {
            padding:var(--pad-sm) var(--pad); background:rgba(0,212,255,0.1);
            border:1px solid var(--primary); border-radius:var(--radius-sm);
            color:var(--primary); cursor:pointer; font-size:var(--fs-sm);
            display:flex; align-items:center; gap:6px; white-space:nowrap;
            font-family:'Poppins',sans-serif;
        }
        .addr-suggestions { display:flex; flex-direction:column; gap:4px; }
        .addr-suggestion-item {
            padding:10px var(--pad); border-radius:var(--radius-sm);
            background:var(--surface2); cursor:pointer; transition:all 0.2s;
            display:flex; align-items:flex-start; gap:10px; border:1px solid transparent;
        }
        .addr-suggestion-item:hover { border-color:var(--primary); background:rgba(0,212,255,0.05); }
        .addr-suggestion-item i { color:var(--text-dim); font-size:14px; margin-top:2px; }
        .addr-sug-main { font-size:var(--fs-sm); font-weight:600; }
        .addr-sug-sub { font-size:var(--fs-xs); color:var(--text-dim); }

        .addr-map-selector {
            position:absolute; inset:0; z-index:10; display:none; flex-direction:column;
            background:var(--dark-bg);
        }
        .addr-map-selector.active { display:flex; }
        .addr-map-header {
            padding:var(--pad); background:var(--surface);
            border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:10px;
        }
        .addr-map-inner { flex:1; position:relative; }
        .addr-map-inner #mapSelector { width:100%; height:100%; }
        .addr-map-confirm {
            padding:var(--pad); background:var(--surface); border-top:1px solid var(--border);
        }

        /* ===== CLIENT PANEL ===== */
        .search-panel {
            position:fixed; bottom:0; left:0; right:0;
            background:rgba(17,24,39,0.98); backdrop-filter:blur(20px);
            border-radius:20px 20px 0 0;
            border-top:1px solid var(--border);
            padding:var(--pad) var(--pad-lg);
            z-index:600; max-height:82vh; overflow-y:auto;
            transform:translateY(0); transition:transform 0.3s ease;
            display:none;
        }
        .search-panel.active { display:block; }
        .search-panel.hidden { transform:translateY(calc(100% - 52px)); }
        [data-theme="light"] .search-panel { background:rgba(255,255,255,0.98); }

        .panel-handle {
            width:36px; height:4px; background:var(--border);
            border-radius:2px; margin:0 auto 12px; cursor:pointer;
        }
        .panel-toggle {
            position:absolute; top:8px; right:var(--pad);
            width:34px; height:34px; background:var(--surface2);
            border:none; border-radius:50%; color:var(--text);
            cursor:pointer; display:flex; align-items:center;
            justify-content:center; font-size:15px;
        }

        .location-inputs { display:flex; flex-direction:column; gap:8px; margin-bottom:var(--pad); }
        .location-row {
            display:flex; align-items:center; gap:8px;
            background:var(--surface2); border-radius:var(--radius-sm);
            padding:3px; border:1.5px solid var(--border);
            transition:all 0.25s; cursor:pointer;
        }
        .location-row:hover { border-color:rgba(0,212,255,0.3); }
        .location-icon { width:36px; height:36px; display:flex; align-items:center; justify-content:center; font-size:16px; }
        .location-icon.pickup { color:var(--primary); }
        .location-icon.dest { color:var(--danger); }
        .location-display {
            flex:1; padding:8px 4px; font-size:var(--fs-sm);
            color:var(--text); min-height:36px; display:flex; align-items:center;
            cursor:pointer;
        }
        .location-display.placeholder { color:var(--text-dim); }
        .location-btn {
            width:34px; height:34px; background:rgba(0,212,255,0.08);
            border:none; border-radius:8px; color:var(--primary);
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            transition:all 0.2s; font-size:13px;
        }
        .location-btn:hover { background:rgba(0,212,255,0.18); }

        /* ===== PRICE SECTION - ELEGANT ===== */
        .price-section {
            background:linear-gradient(135deg, rgba(0,212,255,0.06), rgba(123,44,191,0.06));
            border:1px solid var(--border); border-radius:var(--radius);
            padding:var(--pad); margin-bottom:var(--pad); display:none;
        }
        .price-section-title { font-size:var(--fs-xs); color:var(--text-dim); text-transform:uppercase; letter-spacing:0.6px; margin-bottom:10px; font-weight:600; }
        .price-options { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
        .price-option {
            flex:1; min-width:80px; padding:8px; border-radius:var(--radius-sm);
            background:var(--surface2); border:1.5px solid var(--border);
            text-align:center; cursor:pointer; transition:all 0.25s;
        }
        .price-option.active { border-color:var(--primary); background:rgba(0,212,255,0.08); }
        .price-option-label { font-size:var(--fs-xs); color:var(--text-dim); }
        .price-option-value { font-size:var(--fs-lg); font-weight:800; color:var(--success); }
        .price-custom-row { display:flex; gap:8px; align-items:center; }
        .price-custom-row label { font-size:var(--fs-xs); color:var(--text-dim); white-space:nowrap; }
        .price-input {
            flex:1; background:var(--surface2); border:1.5px solid var(--border);
            border-radius:var(--radius-sm); padding:8px var(--pad);
            color:var(--text); font-size:var(--fs-md); text-align:center; outline:none;
            font-family:'Poppins',sans-serif; font-weight:700; transition:all 0.25s;
        }
        .price-input:focus { border-color:var(--primary); }

        .find-driver-btn { background:linear-gradient(135deg,var(--success),#008850); margin-bottom:var(--pad); display:none; }

        /* ===== DRIVER INFO CARD ===== */
        .driver-info-card {
            background:var(--surface2); border-radius:var(--radius);
            padding:var(--pad); margin-bottom:var(--pad); display:none;
            border:1px solid var(--border);
        }
        .driver-info-card.active { display:block; animation:slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(16px);opacity:0} to{transform:translateY(0);opacity:1} }
        .driver-profile { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .driver-photo { width:52px; height:52px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); }
        .driver-details h3 { margin-bottom:3px; font-size:var(--fs-md); }
        .driver-rating { color:var(--warning); font-size:var(--fs-xs); display:flex; align-items:center; gap:5px; }
        .driver-actions { display:flex; gap:8px; }
        .driver-actions button {
            flex:1; padding:9px; border-radius:var(--radius-sm);
            border:none; cursor:pointer; font-size:var(--fs-xs);
            display:flex; align-items:center; justify-content:center;
            gap:6px; font-family:'Poppins',sans-serif; font-weight:600; transition:all 0.2s;
        }
        .btn-msg { background:rgba(0,212,255,0.12); color:var(--primary); border:1px solid rgba(0,212,255,0.3) !important; }
        .btn-cancel-small { background:rgba(255,34,85,0.12); color:var(--danger); border:1px solid rgba(255,34,85,0.3) !important; }

        /* ===== RATING STARS ===== */
        .star-rating { display:flex; gap:6px; margin:10px 0; }
        .star-rating i {
            font-size:clamp(20px,5vw,28px); color:var(--text-dimmer);
            cursor:pointer; transition:all 0.2s;
        }
        .star-rating i.active, .star-rating i:hover { color:var(--warning); transform:scale(1.15); }

        /* ===== RATING MODAL ===== */
        .rating-modal {
            position:fixed; inset:0; z-index:3500;
            background:rgba(0,0,0,0.85); backdrop-filter:blur(10px);
            display:none; align-items:center; justify-content:center; padding:var(--pad);
        }
        .rating-modal.active { display:flex; }
        .rating-content {
            background:var(--surface); border-radius:var(--radius-lg);
            padding:var(--pad-lg); width:100%; max-width:380px;
            border:1px solid var(--border); text-align:center;
        }
        .rating-content h3 { font-size:var(--fs-lg); margin-bottom:8px; }
        .rating-content p { color:var(--text-dim); font-size:var(--fs-sm); margin-bottom:var(--pad); }
        .rating-profile { display:flex; flex-direction:column; align-items:center; margin-bottom:var(--pad); }
        .rating-profile img { width:70px; height:70px; border-radius:50%; object-fit:cover; border:3px solid var(--primary); margin-bottom:8px; }

        /* ===== DRIVER OFFERS MODAL ===== */
        .driver-offers-modal {
            position:fixed; inset:0; background:rgba(0,0,0,0.92);
            z-index:2000; display:none; overflow-y:auto;
            padding:var(--pad) var(--pad) 80px;
        }
        .driver-offers-modal.active { display:block; }
        .offers-header { text-align:center; margin-bottom:var(--pad-lg); padding-top:var(--pad-lg); }
        .offers-header h2 { font-size:var(--fs-lg); margin-bottom:4px; }
        .offers-header p { color:var(--text-dim); font-size:var(--fs-sm); }

        .driver-offer-card {
            background:var(--surface2); border-radius:var(--radius);
            padding:var(--pad); margin-bottom:12px;
            border:1.5px solid var(--border); transition:all 0.25s;
            position:relative; overflow:hidden;
        }
        .driver-offer-card:hover { border-color:var(--primary); }
        .offer-timer { position:absolute; top:0; left:0; height:3px; background:var(--success); transition:width 1s linear; }
        .offer-timer.warning { background:var(--warning); }
        .offer-timer.danger { background:var(--danger); }
        .driver-offer-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .driver-offer-photo { width:52px; height:52px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); }
        .driver-offer-info h3 { margin-bottom:3px; font-size:var(--fs-md); }
        .driver-offer-rating { color:var(--warning); font-size:var(--fs-xs); }
        .offer-price { font-size:var(--fs-xl); font-weight:800; color:var(--success); text-align:center; margin:10px 0; }
        .offer-actions { display:flex; gap:8px; }
        .offer-actions .btn { flex:1; margin:0; }

        /* ===== DRIVER PANEL ===== */
        .driver-panel {
            position:fixed; bottom:0; left:0; right:0;
            background:rgba(17,24,39,0.98); backdrop-filter:blur(20px);
            border-radius:20px 20px 0 0; border-top:1px solid var(--border);
            padding:var(--pad) var(--pad-lg);
            z-index:600; max-height:84vh; overflow-y:auto;
            transform:translateY(0); transition:transform 0.3s ease; display:none;
        }
        .driver-panel.active { display:block; }
        .driver-panel.hidden { transform:translateY(calc(100% - 52px)); }
        [data-theme="light"] .driver-panel { background:rgba(255,255,255,0.98); }
        .driver-panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--pad); }
        .driver-panel-toggle {
            width:34px; height:34px; background:var(--surface2); border:none;
            border-radius:50%; color:var(--text); cursor:pointer; font-size:15px;
            display:flex; align-items:center; justify-content:center;
        }

        .driver-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:var(--pad); }
        .stat-card {
            background:var(--surface2); border-radius:var(--radius-sm);
            padding:10px 8px; text-align:center; border:1px solid var(--border);
        }
        .stat-value { font-size:clamp(15px,4vw,20px); font-weight:800; color:var(--primary); margin-bottom:2px; }
        .stat-label { font-size:var(--fs-xs); color:var(--text-dim); text-transform:uppercase; }

        .status-toggle {
            display:flex; align-items:center; justify-content:space-between;
            margin-bottom:var(--pad); padding:var(--pad);
            background:var(--surface2); border-radius:var(--radius); border:1px solid var(--border);
        }
        .status-text { font-size:var(--fs-md); font-weight:700; }
        .status-text.online { color:var(--success); }
        .status-text.offline { color:var(--text-dim); }
        .toggle-switch {
            width:52px; height:28px; background:var(--surface3);
            border-radius:14px; position:relative; cursor:pointer; transition:all 0.3s;
        }
        .toggle-switch.active { background:var(--success); }
        .toggle-switch::after {
            content:''; position:absolute; width:24px; height:24px;
            background:#fff; border-radius:50%; top:2px; left:2px; transition:all 0.3s;
        }
        .toggle-switch.active::after { left:26px; }

        .earnings-section {
            background:var(--surface2); border-radius:var(--radius);
            padding:var(--pad); margin-bottom:var(--pad); display:none;
            border:1px solid rgba(0,212,255,0.15);
        }
        .earnings-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .earnings-title { font-size:var(--fs-sm); font-weight:700; }
        .earnings-amount { font-size:clamp(20px,5vw,28px); font-weight:800; color:var(--success); text-align:center; margin-bottom:10px; }
        .earnings-period { display:flex; gap:6px; }
        .period-btn {
            flex:1; padding:6px; background:var(--surface3); border:1px solid var(--border);
            border-radius:var(--radius-sm); color:var(--text); font-size:var(--fs-xs);
            cursor:pointer; transition:all 0.2s; font-family:'Poppins',sans-serif;
        }
        .period-btn.active { background:var(--primary); color:#000; border-color:var(--primary); }

        /* ===== REQUEST CARD ===== */
        .request-card {
            background:var(--surface2); border-radius:var(--radius);
            padding:var(--pad); margin-bottom:10px;
            border:1px solid var(--border); transition:all 0.25s;
        }
        .request-card:hover { border-color:var(--primary); transform:translateY(-1px); }
        .request-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
        .request-price { font-size:clamp(18px,4vw,22px); font-weight:800; color:var(--success); }
        .request-route { display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
        .route-point { display:flex; align-items:center; gap:10px; font-size:var(--fs-sm); }
        .route-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        .route-dot.pickup { background:var(--primary); box-shadow:0 0 8px var(--primary); }
        .route-dot.dest { background:var(--danger); box-shadow:0 0 8px var(--danger); }
        .request-actions { display:flex; gap:8px; }
        .request-actions .btn { flex:1; margin:0; }

        /* ===== CURRENT TRIP CARD ===== */
        .current-trip-card {
            background:linear-gradient(135deg,rgba(0,212,255,0.06),rgba(123,44,191,0.06));
            border:1.5px solid var(--primary); border-radius:var(--radius);
            padding:var(--pad); margin-bottom:var(--pad); display:none;
        }
        .current-trip-card.active { display:block; }
        .trip-status {
            text-align:center; font-size:var(--fs-sm); font-weight:700;
            color:var(--primary); margin-bottom:12px; text-transform:uppercase;
            padding:6px; background:rgba(0,212,255,0.08); border-radius:8px;
        }
        .client-info { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .client-photo { width:52px; height:52px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); }
        .trip-info-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px; }
        .trip-info-item { background:var(--surface2); padding:8px; border-radius:8px; text-align:center; }
        .trip-info-label { font-size:var(--fs-xs); color:var(--text-dim); text-transform:uppercase; margin-bottom:2px; }
        .trip-info-value { font-size:var(--fs-md); font-weight:700; color:var(--success); }
        .trip-buttons { display:flex; gap:8px; flex-wrap:wrap; }
        .trip-buttons .btn { flex:1; min-width:100px; margin:0; font-size:var(--fs-xs); }

        /* ===== NAV OVERLAY ===== */
        .nav-instructions-overlay {
            position:fixed; bottom:var(--pad); left:var(--pad); right:var(--pad);
            background:rgba(17,24,39,0.97); backdrop-filter:blur(16px);
            border-radius:var(--radius); padding:var(--pad);
            z-index:500; display:none; border:1px solid rgba(0,212,255,0.2);
        }
        .nav-instructions-overlay.active { display:block; }
        .nav-step { display:flex; align-items:center; gap:12px; }
        .nav-step-icon {
            width:44px; height:44px; min-width:44px; background:rgba(0,212,255,0.1);
            border-radius:10px; display:flex; align-items:center;
            justify-content:center; font-size:20px; color:var(--primary);
        }
        .nav-step-text { flex:1; }
        .nav-step-main { font-size:var(--fs-md); font-weight:700; margin-bottom:3px; }
        .nav-step-sub { font-size:var(--fs-xs); color:var(--text-dim); }
        .nav-step-distance { text-align:right; }
        .nav-step-distance-value { font-size:clamp(18px,4.5vw,24px); font-weight:800; color:var(--primary); }

        /* ===== CHAT MODAL ===== */
        .modal-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.7);
            z-index:2000; display:none; align-items:flex-end;
        }
        .modal-overlay.active { display:flex; }
        .chat-container {
            width:100%; height:80vh; background:var(--surface);
            border-radius:20px 20px 0 0; display:flex; flex-direction:column;
        }
        .chat-header {
            padding:var(--pad) var(--pad-lg); border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:10px;
        }
        .chat-header img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
        .chat-messages { flex:1; overflow-y:auto; padding:var(--pad); display:flex; flex-direction:column; gap:8px; }
        .message {
            max-width:78%; padding:9px 13px; border-radius:14px;
            font-size:var(--fs-sm); line-height:1.4;
        }
        .message.sent { align-self:flex-end; background:var(--primary); color:#000; border-bottom-right-radius:4px; }
        .message.received { align-self:flex-start; background:var(--surface2); border-bottom-left-radius:4px; }
        .chat-input {
            padding:var(--pad); border-top:1px solid var(--border);
            display:flex; gap:8px;
            padding-bottom:max(var(--pad), env(safe-area-inset-bottom));
        }
        .chat-input input {
            flex:1; background:var(--surface2); border:1px solid var(--border);
            border-radius:22px; padding:10px 16px; color:var(--text);
            outline:none; font-size:var(--fs-sm); font-family:'Poppins',sans-serif;
        }
        .chat-input button {
            width:42px; height:42px; border-radius:50%;
            background:var(--primary); border:none; color:#000;
            cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:15px;
        }

        /* ===== CANCEL MODAL ===== */
        .cancel-modal {
            position:fixed; inset:0; background:rgba(0,0,0,0.85);
            z-index:3000; display:none; align-items:center;
            justify-content:center; padding:var(--pad);
        }
        .cancel-modal.active { display:flex; }
        .cancel-content {
            background:var(--surface); border-radius:var(--radius-lg);
            padding:var(--pad-lg); width:100%; max-width:380px; text-align:center;
            border:1px solid var(--border);
        }
        .cancel-content h3 { margin-bottom:10px; color:var(--danger); font-size:var(--fs-lg); }
        .cancel-reasons { display:flex; flex-direction:column; gap:8px; margin:var(--pad) 0; }
        .cancel-reason-btn {
            background:var(--surface2); border:1px solid var(--border);
            border-radius:var(--radius-sm); padding:12px var(--pad);
            color:var(--text); cursor:pointer; text-align:left;
            transition:all 0.2s; font-size:var(--fs-sm); font-family:'Poppins',sans-serif;
        }
        .cancel-reason-btn:hover { background:rgba(255,34,85,0.08); border-color:var(--danger); }

        /* ===== PROFILE MODAL ===== */
        .profile-modal { position:fixed; inset:0; z-index:2500; background:rgba(0,0,0,0.9); display:none; overflow-y:auto; }
        .profile-modal.active { display:block; }
        .profile-content { max-width:520px; margin:0 auto; padding:var(--pad); }
        .profile-card {
            background:var(--surface); border-radius:var(--radius-lg);
            padding:var(--pad-lg); margin-bottom:var(--pad); border:1px solid var(--border);
        }
        .profile-card h3 { font-size:var(--fs-md); margin-bottom:var(--pad); }
        .profile-header-section { text-align:center; margin-bottom:var(--pad-lg); }
        .profile-photo-wrap { position:relative; display:inline-block; margin-bottom:10px; }
        .profile-photo-large { width:clamp(70px,18vw,100px); height:clamp(70px,18vw,100px); border-radius:50%; border:3px solid var(--primary); object-fit:cover; }
        .edit-photo-btn {
            position:absolute; bottom:0; right:0;
            width:28px; height:28px; background:var(--primary);
            border:none; border-radius:50%; color:#000; cursor:pointer;
            display:flex; align-items:center; justify-content:center; font-size:12px;
        }
        .section-divider {
            border:none; border-top:1px solid var(--border); margin:var(--pad) 0;
        }
        .detail-section-title { font-size:var(--fs-xs); color:var(--primary); text-transform:uppercase; letter-spacing:0.7px; font-weight:700; margin-bottom:10px; }

        /* ===== NOTIFICATIONS PANEL ===== */
        .notif-panel {
            position:fixed; top:52px; right:0; bottom:0; width:min(100vw, 360px);
            background:var(--surface); border-left:1px solid var(--border);
            z-index:1800; display:none; flex-direction:column;
            transform:translateX(100%); transition:transform 0.3s ease;
        }
        .notif-panel.active { display:flex; transform:translateX(0); }
        .notif-header { padding:var(--pad) var(--pad-lg); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .notif-header h3 { font-size:var(--fs-md); }
        .notif-clear { font-size:var(--fs-xs); color:var(--primary); cursor:pointer; border:none; background:none; color:var(--primary); }
        .notif-list { flex:1; overflow-y:auto; padding:var(--pad-sm); }
        .notif-item {
            padding:10px var(--pad); border-radius:var(--radius-sm);
            background:var(--surface2); margin-bottom:6px; border:1px solid var(--border);
            display:flex; gap:10px; align-items:flex-start; cursor:pointer; transition:all 0.2s;
        }
        .notif-item:hover { border-color:var(--primary); }
        .notif-item i { font-size:15px; color:var(--primary); margin-top:2px; }
        .notif-text { font-size:var(--fs-xs); flex:1; }
        .notif-time { font-size:var(--fs-xs); color:var(--text-dimmer); }

        /* ===== NEGOTIATE ALERT ===== */
        .negotiate-alert {
            position:fixed; top:60px; left:50%; transform:translateX(-50%) translateY(-120px);
            background:var(--surface); backdrop-filter:blur(16px);
            border:1.5px solid var(--warning); border-radius:var(--radius);
            padding:var(--pad); z-index:2800; width:min(92vw,380px);
            opacity:0; transition:all 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);
        }
        .negotiate-alert.active { transform:translateX(-50%) translateY(0); opacity:1; }
        .negotiate-alert-header { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
        .negotiate-alert-header i { color:var(--warning); font-size:18px; }
        .negotiate-alert-header h4 { font-size:var(--fs-sm); font-weight:700; }
        .negotiate-alert-body { font-size:var(--fs-sm); color:var(--text-dim); margin-bottom:10px; }
        .negotiate-alert-price { font-size:var(--fs-xl); font-weight:800; color:var(--warning); text-align:center; margin:8px 0; }
        .negotiate-alert-actions { display:flex; gap:8px; }
        .negotiate-alert-actions .btn { flex:1; margin:0; }

        /* ===== LOADING & TOAST ===== */
        .loading-screen {
            position:fixed; inset:0; background:var(--dark-bg);
            z-index:9999; display:none; flex-direction:column;
            align-items:center; justify-content:center;
        }
        .loading-screen.active { display:flex; }
        .loading-spinner {
            width:50px; height:50px; border:3px solid rgba(0,212,255,0.15);
            border-top-color:var(--primary); border-radius:50%;
            animation:spin 0.9s linear infinite; margin-bottom:16px;
        }
        @keyframes spin { to{transform:rotate(360deg)} }
        .toast {
            position:fixed; bottom:80px; left:50%;
            transform:translateX(-50%) translateY(60px);
            background:rgba(17,24,39,0.98); color:var(--text);
            padding:10px 18px; border-radius:10px;
            border:1px solid rgba(0,212,255,0.25); z-index:10000;
            display:flex; align-items:center; gap:8px;
            font-weight:600; font-size:var(--fs-sm);
            box-shadow:var(--shadow); opacity:0; transition:all 0.3s;
            max-width:88vw; text-align:center;
        }
        .toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

        /* ===== RESPONSIVE ===== */
        @media (max-width:480px) {
            .driver-stats { grid-template-columns:1fr 1fr; }
            .trip-info-grid { grid-template-columns:1fr 1fr; }
            .header-nav { display:none; }
        }
        @media (min-width:769px) {
            .search-panel, .driver-panel { max-width:420px; left:auto; border-radius:var(--radius-lg); bottom:var(--pad); right:var(--pad); }
            .nav-instructions-overlay { max-width:420px; left:auto; right:var(--pad); bottom:var(--pad); }
            .sos-button { bottom:var(--pad); }
        }

        /* Animations */
        .driver-marker-el {
            width:44px; height:44px; background:#000; border:3px solid var(--success);
            border-radius:10px; display:flex; align-items:center; justify-content:center;
            box-shadow:0 0 0 0 rgba(0,255,136,0.6); animation:pulse-vehicle 1.8s infinite;
        }
        @keyframes pulse-vehicle {
            0%{box-shadow:0 0 0 0 rgba(0,255,136,0.6)}
            70%{box-shadow:0 0 0 14px rgba(0,255,136,0)}
            100%{box-shadow:0 0 0 0 rgba(0,255,136,0)}
        }
        .driver-marker-el i { color:var(--success); font-size:20px; }

        /* Dark/Light map toggle */
        #map-dark-overlay {
            position:absolute; inset:0; z-index:2;
            background:rgba(9,14,23,0.3); pointer-events:none; display:none;
        }
    </style>
</head>
<body>
    <!-- ===== AUTH SCREEN ===== -->
    <div id="authScreen" class="screen active">
        <div class="auth-bg"></div>
        <div class="auth-container">
            <div class="auth-card">
                <div class="logo-big"><i class="fas fa-taxi"></i></div>
                <h1>RETOM</h1>
                <p>Transporte rápido y seguro</p>

                <div class="role-selector">
                    <div class="role-btn active" onclick="selectRole('cliente')" id="role-cliente">
                        <i class="fas fa-user"></i><div>Cliente</div>
                    </div>
                    <div class="role-btn" onclick="selectRole('conductor')" id="role-conductor">
                        <i class="fas fa-car"></i><div>Conductor</div>
                    </div>
                </div>

                <!-- Login Form -->
                <div id="loginForm">
                    <div class="input-group">
                        <label>Correo electrónico</label>
                        <input type="email" class="input" id="email" placeholder="tu@email.com">
                    </div>
                    <div class="input-group">
                        <label>Contraseña</label>
                        <input type="password" class="input" id="password" placeholder="••••••••">
                    </div>
                    <button class="btn" onclick="login()"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</button>
                    <button class="btn btn-secondary" onclick="showRegister()"><i class="fas fa-user-plus"></i> Crear cuenta</button>
                </div>

                <!-- Register Form -->
                <div id="registerForm" style="display:none;">
                    <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                        <img id="previewPhoto" style="display:none;">
                        <i class="fas fa-camera" id="cameraIcon"></i>
                        <span>Foto de perfil</span>
                        <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoSelect(event)">
                    </div>

                    <div class="input-group">
                        <label>Nombre completo</label>
                        <input type="text" class="input" id="regName" placeholder="Juan Pérez">
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Correo electrónico</label>
                            <input type="email" class="input" id="regEmail" placeholder="tu@email.com">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Teléfono</label>
                            <input type="tel" class="input" id="regPhone" placeholder="8095551234">
                        </div>
                        <div class="input-group">
                            <label>Género</label>
                            <select class="input" id="regGender">
                                <option value="">Seleccionar</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Fecha de nacimiento</label>
                        <input type="date" class="input" id="regBirth">
                    </div>
                    <div class="input-group">
                        <label>Dirección</label>
                        <input type="text" class="input" id="regAddress" placeholder="Tu dirección">
                    </div>
                    <div class="input-group">
                        <label>Contraseña</label>
                        <input type="password" class="input" id="regPassword" placeholder="••••••••">
                    </div>

                    <!-- Driver-only fields -->
                    <div id="conductorFields" style="display:none;">
                        <hr class="section-divider">
                        <div class="detail-section-title"><i class="fas fa-car"></i> Información del vehículo</div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Placa</label>
                                <input type="text" class="input" id="regPlate" placeholder="A123456">
                            </div>
                            <div class="input-group">
                                <label>Año</label>
                                <input type="number" class="input" id="regYear" placeholder="2020" min="1990" max="2025">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Marca y Modelo</label>
                            <input type="text" class="input" id="regModel" placeholder="Toyota Corolla">
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Color</label>
                                <input type="text" class="input" id="regColor" placeholder="Blanco">
                            </div>
                            <div class="input-group">
                                <label>Tipo</label>
                                <select class="input" id="regVehicleType">
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                    <option value="pickup">Pickup</option>
                                    <option value="moto">Moto</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Cédula / Licencia</label>
                            <input type="text" class="input" id="regLicense" placeholder="00100000000">
                        </div>
                        <div class="input-group">
                            <label>Número de seguro</label>
                            <input type="text" class="input" id="regInsurance" placeholder="Número de póliza">
                        </div>
                    </div>

                    <button class="btn" style="margin-top:12px;" onclick="register()"><i class="fas fa-user-plus"></i> Registrarse</button>
                    <button class="btn btn-secondary" onclick="showLogin()"><i class="fas fa-arrow-left"></i> Volver</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MAIN SCREEN ===== -->
    <div id="mainScreen" class="screen">
        <div id="map"></div>

        <!-- App Header -->
        <header class="app-header">
            <div class="header-logo">RETOM <span>Transporte</span></div>
            <nav class="header-nav" id="headerNav"></nav>
            <div class="header-actions">
                <button class="hdr-btn" onclick="toggleTheme()" title="Modo oscuro/claro" id="themeBtn"><i class="fas fa-moon"></i></button>
                <button class="hdr-btn" onclick="toggleNotifPanel()" title="Notificaciones">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notifBadge" style="display:none;">0</span>
                </button>
                <div class="user-pill" onclick="openProfile()">
                    <img id="headerPhoto" src="" style="display:none;">
                    <i class="fas fa-user-circle" id="headerIcon"></i>
                    <span id="userName">Usuario</span>
                </div>
                <button class="hdr-btn" onclick="logout()" title="Cerrar sesión"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <!-- Floating Status -->
        <div class="floating-status" id="floatingStatus">
            <i class="fas fa-route"></i>
            <span id="floatingStatusText">En camino</span>
            <button class="repeat-btn" onclick="repeatLastSpeak()" title="Repetir instrucción"><i class="fas fa-redo"></i></button>
        </div>

        <!-- SOS -->
        <button class="sos-button" id="sosButton" onclick="triggerSOS()">SOS</button>

        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-ctrl-btn" onclick="toggleMapType()" title="Vista mapa"><i class="fas fa-layer-group"></i></button>
            <button class="map-ctrl-btn" onclick="centerOnUser()" title="Mi ubicación"><i class="fas fa-crosshairs"></i></button>
            <button class="map-ctrl-btn" id="audioControlBtn" onclick="toggleAudio()" title="Audio"><i class="fas fa-volume-up"></i></button>
        </div>

        <!-- CLIENT PANEL -->
        <div class="search-panel" id="clientPanel">
            <div class="panel-handle" onclick="toggleClientPanel()"></div>
            <button class="panel-toggle" onclick="toggleClientPanel()">
                <i class="fas fa-chevron-down" id="clientPanelToggleIcon"></i>
            </button>

            <div class="location-inputs">
                <div class="location-row" onclick="openAddrModal('pickup')">
                    <div class="location-icon pickup"><i class="fas fa-dot-circle"></i></div>
                    <div class="location-display placeholder" id="pickupDisplay">¿Dónde te recogemos?</div>
                    <button class="location-btn" onclick="event.stopPropagation(); enableMapSelectionPickup()" title="Seleccionar en mapa"><i class="fas fa-map-pin"></i></button>
                </div>
                <div class="location-row" onclick="openAddrModal('dest')">
                    <div class="location-icon dest"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="location-display placeholder" id="destDisplay">¿A dónde vas?</div>
                    <button class="location-btn" onclick="event.stopPropagation(); enableMapSelection()" title="Seleccionar en mapa"><i class="fas fa-map-pin"></i></button>
                </div>
            </div>

            <!-- Price Section Elegant -->
            <div class="price-section" id="priceSection">
                <div class="price-section-title"><i class="fas fa-tag"></i> Tarifa del viaje</div>
                <div class="price-options" id="priceOptions">
                    <div class="price-option active" id="priceOpt1" onclick="selectPriceOption(1)">
                        <div class="price-option-label">Recomendado</div>
                        <div class="price-option-value" id="suggestedPrice">RD$150</div>
                    </div>
                    <div class="price-option" id="priceOpt2" onclick="selectPriceOption(2)">
                        <div class="price-option-label">Económico</div>
                        <div class="price-option-value" id="economicPrice">RD$120</div>
                    </div>
                    <div class="price-option" id="priceOpt3" onclick="selectPriceOption(3)">
                        <div class="price-option-label">Premium</div>
                        <div class="price-option-value" id="premiumPrice">RD$200</div>
                    </div>
                </div>
                <div class="price-custom-row">
                    <label>Tu oferta:</label>
                    <input type="number" class="price-input" id="clientOffer" placeholder="150" value="150" min="50">
                    <span style="color:var(--text-dim); font-size:var(--fs-xs); white-space:nowrap;">RD$</span>
                </div>
            </div>

            <button class="btn find-driver-btn" id="findDriverBtn" onclick="findDriver()">
                <i class="fas fa-search"></i> Buscar Conductor
            </button>

            <div class="driver-info-card" id="driverInfoCard">
                <div class="driver-profile">
                    <img id="driverPhoto" class="driver-photo" src="https://via.placeholder.com/52">
                    <div class="driver-details">
                        <h3 id="driverName">Conductor</h3>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                            <span style="color:var(--text-dim);margin-left:6px;" id="driverTrips">120 viajes</span>
                        </div>
                        <div style="font-size:var(--fs-xs);color:var(--text-dim);margin-top:2px;" id="driverVehicle"></div>
                    </div>
                </div>
                <div class="driver-actions">
                    <button class="btn-msg" onclick="openChat()"><i class="fas fa-comment"></i> Mensaje</button>
                    <button class="btn-cancel-small" onclick="showCancelModal()"><i class="fas fa-times"></i> Cancelar</button>
                </div>
            </div>
        </div>

        <!-- DRIVER OFFERS MODAL -->
        <div class="driver-offers-modal" id="driverOffersModal">
            <div class="offers-header">
                <h2><i class="fas fa-users"></i> Conductores disponibles</h2>
                <p>Selecciona la mejor oferta</p>
            </div>
            <div id="driverOffersList"></div>
            <button class="btn btn-secondary" onclick="closeDriverOffers()" style="margin-top:16px;">
                <i class="fas fa-times"></i> Cancelar búsqueda
            </button>
        </div>

        <!-- DRIVER PANEL -->
        <div class="driver-panel" id="driverPanel">
            <div class="panel-handle" onclick="toggleDriverPanel()"></div>
            <div class="driver-panel-header">
                <h3 style="margin:0;font-size:var(--fs-md);">Panel del Conductor</h3>
                <button class="driver-panel-toggle" onclick="toggleDriverPanel()">
                    <i class="fas fa-chevron-down" id="driverPanelToggleIcon"></i>
                </button>
            </div>

            <div class="driver-stats" id="driverStats">
                <div class="stat-card">
                    <div class="stat-value" id="statRating">5.0</div>
                    <div class="stat-label">Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTrips">0</div>
                    <div class="stat-label">Viajes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statEarnings">RD$0</div>
                    <div class="stat-label">Ganancias</div>
                </div>
            </div>

            <div class="earnings-section" id="earningsSection">
                <div class="earnings-header">
                    <span class="earnings-title">Ganancias</span>
                    <i class="fas fa-wallet" style="color:var(--success);"></i>
                </div>
                <div class="earnings-amount" id="earningsAmount">RD$ 0</div>
                <div class="earnings-period">
                    <button class="period-btn active" onclick="setEarningsPeriod('day', this)">Hoy</button>
                    <button class="period-btn" onclick="setEarningsPeriod('week', this)">Semana</button>
                    <button class="period-btn" onclick="setEarningsPeriod('month', this)">Mes</button>
                </div>
            </div>

            <div class="current-trip-card" id="currentTripCard">
                <div class="trip-status" id="tripStatus">Viaje en Progreso</div>
                <div class="client-info">
                    <img id="clientPhoto" class="client-photo" src="https://via.placeholder.com/52">
                    <div>
                        <h4 id="clientName" style="margin:0 0 3px;font-size:var(--fs-md);">Cliente</h4>
                        <div style="color:var(--text-dim);font-size:var(--fs-xs);">
                            <i class="fas fa-map-marker-alt" style="color:var(--primary);"></i>
                            <span id="clientDistance">Calculando...</span>
                        </div>
                        <div style="color:var(--text-dim);font-size:var(--fs-xs);margin-top:3px;" id="clientRatingDisplay"></div>
                    </div>
                </div>
                <div class="trip-info-grid">
                    <div class="trip-info-item">
                        <div class="trip-info-label">Distancia</div>
                        <div class="trip-info-value" id="tripDistance">-- km</div>
                    </div>
                    <div class="trip-info-item">
                        <div class="trip-info-label">Ganancia</div>
                        <div class="trip-info-value" id="tripEarnings">RD$ --</div>
                    </div>
                    <div class="trip-info-item">
                        <div class="trip-info-label">Tiempo Est.</div>
                        <div class="trip-info-value" id="tripTime">-- min</div>
                    </div>
                    <div class="trip-info-item">
                        <div class="trip-info-label">Pago</div>
                        <div class="trip-info-value" style="font-size:var(--fs-xs);">Efectivo</div>
                    </div>
                </div>
                <div class="request-route" style="margin-bottom:12px;">
                    <div class="route-point"><div class="route-dot pickup"></div><span id="tripPickup" style="font-size:var(--fs-xs);">Origen</span></div>
                    <div class="route-point"><div class="route-dot dest"></div><span id="tripDest" style="font-size:var(--fs-xs);">Destino</span></div>
                </div>
                <div class="trip-buttons">
                    <button class="btn btn-success" id="btnLlegue" onclick="driverArrived()" style="display:none;"><i class="fas fa-check-circle"></i> Llegué al origen</button>
                    <button class="btn btn-success" id="btnIniciar" onclick="startTrip()" style="display:none;"><i class="fas fa-play"></i> Iniciar Viaje</button>
                    <button class="btn btn-success" id="btnFinalizar" onclick="endTrip()" style="display:none;"><i class="fas fa-flag-checkered"></i> Finalizar</button>
                    <button class="btn-msg" onclick="openChat()" style="padding:8px 12px;border-radius:var(--radius-sm);border:1px solid rgba(0,212,255,0.3);background:rgba(0,212,255,0.1);color:var(--primary);cursor:pointer;font-size:var(--fs-xs);display:flex;align-items:center;gap:5px;"><i class="fas fa-comment"></i> Chat</button>
                    <button class="btn-cancel-small" onclick="showCancelModal()" style="padding:8px 12px;border-radius:var(--radius-sm);border:1px solid rgba(255,34,85,0.3);background:rgba(255,34,85,0.1);color:var(--danger);cursor:pointer;font-size:var(--fs-xs);"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="status-toggle">
                <div class="status-text offline" id="statusText">Desconectado</div>
                <div class="toggle-switch" id="toggleSwitch" onclick="toggleStatus()"></div>
            </div>

            <div id="requestsList">
                <div style="text-align:center;padding:32px;color:var(--text-dim);">
                    <i class="fas fa-wifi" style="font-size:36px;margin-bottom:12px;display:block;"></i>
                    <span style="font-size:var(--fs-sm);">Activa tu disponibilidad para recibir solicitudes</span>
                </div>
            </div>
        </div>

        <!-- NAV INSTRUCTIONS OVERLAY -->
        <div class="nav-instructions-overlay" id="navOverlay">
            <div class="nav-step">
                <div class="nav-step-icon"><i class="fas fa-arrow-up" id="navStepIcon"></i></div>
                <div class="nav-step-text">
                    <div class="nav-step-main" id="navStepMain">Continúa recto</div>
                    <div class="nav-step-sub" id="navStepSub">Siguiente instrucción</div>
                </div>
                <div class="nav-step-distance">
                    <div class="nav-step-distance-value" id="navStepDistance">--</div>
                    <div style="font-size:var(--fs-xs);color:var(--text-dim);" id="navDistUnit">m</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ADDRESS MODAL ===== -->
    <div class="addr-modal" id="addrModal">
        <div class="addr-modal-header">
            <button class="addr-modal-close" onclick="closeAddrModal()"><i class="fas fa-arrow-left"></i></button>
            <h3 id="addrModalTitle">Seleccionar dirección</h3>
        </div>
        <div class="addr-modal-body">
            <div class="addr-search-row">
                <input type="text" class="addr-search-input" id="addrSearchInput" placeholder="Buscar dirección..." autocomplete="off" oninput="onAddrSearch(this.value)">
                <button class="addr-map-btn" onclick="openMapSelector()"><i class="fas fa-map-pin"></i> Mapa</button>
            </div>
            <div class="addr-suggestions" id="addrSuggestions"></div>
        </div>

        <!-- Map Selector (dentro del modal) -->
        <div class="addr-map-selector" id="addrMapSelector">
            <div class="addr-map-header">
                <button class="addr-modal-close" onclick="closeMapSelector()"><i class="fas fa-arrow-left"></i></button>
                <span style="font-size:var(--fs-sm);font-weight:600;">Toca el mapa para seleccionar</span>
            </div>
            <div class="addr-map-inner"><div id="mapSelector"></div></div>
            <div class="addr-map-confirm">
                <div style="font-size:var(--fs-xs);color:var(--text-dim);margin-bottom:8px;" id="mapSelectorAddr">Toca en el mapa para elegir ubicación</div>
                <button class="btn" onclick="confirmMapSelection()"><i class="fas fa-check"></i> Confirmar esta ubicación</button>
            </div>
        </div>
    </div>

    <!-- ===== CHAT MODAL ===== -->
    <div class="modal-overlay" id="chatModal" onclick="closeChat(event)">
        <div class="chat-container" onclick="event.stopPropagation()">
            <div class="chat-header">
                <img id="chatPhoto" src="https://via.placeholder.com/36">
                <div>
                    <div style="font-weight:700;font-size:var(--fs-sm);" id="chatName">Usuario</div>
                    <div style="font-size:var(--fs-xs);color:var(--success);"><i class="fas fa-circle" style="font-size:8px;"></i> En línea</div>
                </div>
                <button style="margin-left:auto;background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;" onclick="closeChat()"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- ===== CANCEL MODAL ===== -->
    <div class="cancel-modal" id="cancelModal">
        <div class="cancel-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Cancelar Viaje</h3>
            <p style="color:var(--text-dim);font-size:var(--fs-sm);">¿Por qué deseas cancelar?</p>
            <div class="cancel-reasons">
                <button class="cancel-reason-btn" onclick="cancelTrip('Tiempo de espera')"><i class="fas fa-clock"></i> Tiempo de espera excesivo</button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Cambio de planes')"><i class="fas fa-calendar-times"></i> Cambio de planes</button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Conductor no llega')"><i class="fas fa-car-crash"></i> Conductor no llega</button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Precio no acordado')"><i class="fas fa-dollar-sign"></i> Precio no acordado</button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Otro')"><i class="fas fa-question-circle"></i> Otro motivo</button>
            </div>
            <button class="btn btn-secondary" onclick="closeCancelModal()">Volver</button>
        </div>
    </div>

    <!-- ===== RATING MODAL ===== -->
    <div class="rating-modal" id="ratingModal">
        <div class="rating-content">
            <div class="rating-profile">
                <img id="ratingPhoto" src="https://via.placeholder.com/70">
                <h3 id="ratingName">Califica tu experiencia</h3>
            </div>
            <p id="ratingDesc">¿Cómo fue el viaje?</p>
            <div class="star-rating" id="starRating">
                <i class="fas fa-star" onclick="setRating(1)" data-val="1"></i>
                <i class="fas fa-star" onclick="setRating(2)" data-val="2"></i>
                <i class="fas fa-star" onclick="setRating(3)" data-val="3"></i>
                <i class="fas fa-star" onclick="setRating(4)" data-val="4"></i>
                <i class="fas fa-star" onclick="setRating(5)" data-val="5"></i>
            </div>
            <div class="input-group" style="text-align:left;margin-top:12px;">
                <label>Comentario (opcional)</label>
                <input type="text" class="input" id="ratingComment" placeholder="¿Algo que agregar?">
            </div>
            <button class="btn btn-success" onclick="submitRating()" style="margin-top:12px;"><i class="fas fa-check"></i> Enviar calificación</button>
        </div>
    </div>

    <!-- ===== PROFILE MODAL ===== -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <div class="profile-card">
                <div class="profile-header-section">
                    <div class="profile-photo-wrap">
                        <img id="profilePhotoLarge" class="profile-photo-large" src="https://via.placeholder.com/100">
                        <button class="edit-photo-btn" onclick="document.getElementById('editPhotoInput').click()"><i class="fas fa-camera"></i></button>
                        <input type="file" id="editPhotoInput" style="display:none;" accept="image/*" onchange="updateProfilePhoto(event)">
                    </div>
                    <h2 id="profileName" style="font-size:var(--fs-lg);margin-bottom:3px;">Nombre</h2>
                    <p style="color:var(--text-dim);font-size:var(--fs-sm);" id="profileEmail">email@example.com</p>
                    <div id="profileRatingDisplay" style="color:var(--warning);font-size:var(--fs-sm);margin-top:5px;"></div>
                </div>
            </div>

            <!-- Personal Info -->
            <div class="profile-card">
                <h3><i class="fas fa-user" style="color:var(--primary);margin-right:8px;"></i>Información personal</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label>Nombre completo</label>
                        <input type="text" class="input" id="editName">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Teléfono</label>
                        <input type="tel" class="input" id="editPhone">
                    </div>
                    <div class="input-group">
                        <label>Género</label>
                        <select class="input" id="editGender">
                            <option value="">Seleccionar</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Fecha de nacimiento</label>
                        <input type="date" class="input" id="editBirth">
                    </div>
                </div>
                <div class="input-group">
                    <label>Dirección</label>
                    <input type="text" class="input" id="editAddress" placeholder="Tu dirección">
                </div>
            </div>

            <!-- Driver Info -->
            <div class="profile-card" id="driverProfileCard" style="display:none;">
                <h3><i class="fas fa-car" style="color:var(--primary);margin-right:8px;"></i>Información del vehículo</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label>Placa</label>
                        <input type="text" class="input" id="editPlate">
                    </div>
                    <div class="input-group">
                        <label>Año</label>
                        <input type="number" class="input" id="editYear" placeholder="2020">
                    </div>
                </div>
                <div class="input-group">
                    <label>Marca y Modelo</label>
                    <input type="text" class="input" id="editModel" placeholder="Toyota Corolla">
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Color</label>
                        <input type="text" class="input" id="editColor" placeholder="Blanco">
                    </div>
                    <div class="input-group">
                        <label>Tipo</label>
                        <select class="input" id="editVehicleType">
                            <option value="sedan">Sedan</option>
                            <option value="suv">SUV</option>
                            <option value="pickup">Pickup</option>
                            <option value="moto">Moto</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>Cédula / Licencia</label>
                    <input type="text" class="input" id="editLicense">
                </div>
                <div class="input-group">
                    <label>Número de seguro</label>
                    <input type="text" class="input" id="editInsurance">
                </div>
            </div>

            <!-- History -->
            <div class="profile-card">
                <h3><i class="fas fa-history" style="color:var(--primary);margin-right:8px;"></i>Historial de viajes</h3>
                <div id="tripHistoryList" style="font-size:var(--fs-sm);color:var(--text-dim);text-align:center;padding:20px;">
                    <i class="fas fa-road" style="font-size:28px;display:block;margin-bottom:8px;"></i>Sin viajes registrados aún
                </div>
            </div>

            <button class="btn" onclick="saveProfile()"><i class="fas fa-save"></i> Guardar Cambios</button>
            <button class="btn btn-secondary" onclick="closeProfile()"><i class="fas fa-times"></i> Cerrar</button>
        </div>
    </div>

    <!-- ===== NOTIFICATIONS PANEL ===== -->
    <div class="notif-panel" id="notifPanel">
        <div class="notif-header">
            <h3>Notificaciones</h3>
            <button class="notif-clear" onclick="clearNotifications()">Borrar todas</button>
        </div>
        <div class="notif-list" id="notifList">
            <div style="text-align:center;padding:32px;color:var(--text-dim);font-size:var(--fs-sm);">Sin notificaciones</div>
        </div>
    </div>

    <!-- ===== NEGOTIATE ALERT ===== -->
    <div class="negotiate-alert" id="negotiateAlert">
        <div class="negotiate-alert-header">
            <i class="fas fa-exchange-alt"></i>
            <h4>Oferta del conductor</h4>
        </div>
        <div class="negotiate-alert-body" id="negotiateAlertBody">El conductor propone un nuevo precio:</div>
        <div class="negotiate-alert-price" id="negotiateAlertPrice">RD$ 200</div>
        <div class="negotiate-alert-actions">
            <button class="btn btn-success" onclick="acceptNegotiation()"><i class="fas fa-check"></i> Aceptar</button>
            <button class="btn btn-danger" onclick="rejectNegotiation()"><i class="fas fa-times"></i> Rechazar</button>
        </div>
    </div>

    <!-- ===== LOADING ===== -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div style="color:var(--text-dim);font-size:var(--fs-sm);">Cargando...</div>
    </div>

    <!-- ===== TOAST ===== -->
    <div class="toast" id="toast"></div>

    <!-- ===== SCRIPTS ===== -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSHIYTEhTeXUNC4g5f_mBJ52CiP4H57XY&libraries=places,geometry&callback=onMapsLoaded" async defer></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            onAuthStateChanged, signOut, updateProfile
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import {
            getFirestore, collection, doc, setDoc, getDoc, updateDoc,
            onSnapshot, query, where, addDoc, serverTimestamp, deleteDoc,
            getDocs, orderBy, increment, limit
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytes, getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
            authDomain: "formulario-2-8929a.firebaseapp.com",
            projectId: "formulario-2-8929a",
            storageBucket: "formulario-2-8929a.appspot.com",
            messagingSenderId: "136908102526",
            appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ===== GLOBALS =====
        let map = null, selectorMap = null;
        let directionsService = null, directionsRenderer = null;
        let geocoder = null;
        let userRole = 'cliente';
        let currentUser = null, userData = null;
        let currentTrip = null;
        let selectedPhoto = null;
        let audioEnabled = true;
        let isDarkMap = true;
        let isDarkTheme = true;
        let chatUnsubscribe = null, tripUnsubscribe = null, offersUnsubscribe = null;
        let driverOffersTimers = {};
        let isClientPanelHidden = false, isDriverPanelHidden = false;
        let earningsPeriod = 'day';
        let mapClickMode = null;
        let isNavigating = false, steps = [], currentStepIndex = 0;
        let lastSpokenText = '';
        let selectedRating = 0;
        let ratingTripId = null, ratingTargetId = null;
        let currentPriceOption = 1;
        let currentNegotiationData = null;
        let addrModalTarget = null;
        let mapSelectorLatLng = null;
        let pickupAutocomplete = null, destAutocomplete = null, addrAutocomplete = null;
        let notifPanelOpen = false;
        let notifications = [];

        let markers = { user:null, pickup:null, destination:null, driver:null, selectorPin:null };
        let locations = { pickup:null, destination:null, current:null };
        let isOnline = false;
        let mapsLoaded = false;

        // ===== MAPS READY =====
        window.onMapsLoaded = function() {
            mapsLoaded = true;
            if (currentUser && document.getElementById('mainScreen').classList.contains('active')) {
                initMap();
            }
        };

        // ===== ROLE SELECT =====
        window.selectRole = function(role) {
            userRole = role;
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`role-${role}`).classList.add('active');
            document.getElementById('conductorFields').style.display = role === 'conductor' ? 'block' : 'none';
        };

        window.showRegister = function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        };
        window.showLogin = function() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        };

        window.handlePhotoSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            selectedPhoto = file;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('previewPhoto').src = e.target.result;
                document.getElementById('previewPhoto').style.display = 'block';
                document.getElementById('cameraIcon').style.display = 'none';
            };
            reader.readAsDataURL(file);
        };

        // ===== LOGIN =====
        window.login = async function() {
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value;
            if (!email || !pass) { showToast('Completa todos los campos','error'); return; }
            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) {
                const msgs = { 'auth/user-not-found':'Usuario no encontrado','auth/wrong-password':'Contraseña incorrecta','auth/invalid-email':'Email inválido','auth/invalid-credential':'Credenciales incorrectas' };
                showToast(msgs[e.code] || 'Error al iniciar sesión','error');
                showLoading(false);
            }
        };

        // ===== REGISTER =====
        window.register = async function() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const pass = document.getElementById('regPassword').value;
            const gender = document.getElementById('regGender').value;
            const birth = document.getElementById('regBirth').value;
            const address = document.getElementById('regAddress').value.trim();

            if (!name || !email || !phone || !pass) { showToast('Completa los campos requeridos','error'); return; }
            if (pass.length < 6) { showToast('Contraseña mínimo 6 caracteres','error'); return; }

            showLoading(true);
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const user = cred.user;
                currentUser = user;

                let photoURL = null;
                if (selectedPhoto) {
                    try {
                        const sRef = ref(storage, `profiles/${user.uid}`);
                        await uploadBytes(sRef, selectedPhoto);
                        photoURL = await getDownloadURL(sRef);
                        await updateProfile(user, { photoURL });
                    } catch(e) { console.warn('Photo upload error:', e); }
                }

                const base = {
                    uid: user.uid, nombre: name, email, telefono: phone,
                    rol: userRole, photoURL, genero: gender, fechaNacimiento: birth,
                    direccion: address, creado: serverTimestamp(),
                    calificacionTotal: 0, cantidadCalificaciones: 0
                };
                await setDoc(doc(db, 'usuarios', user.uid), base);

                if (userRole === 'conductor') {
                    const plate = document.getElementById('regPlate').value.trim();
                    const model = document.getElementById('regModel').value.trim();
                    const year = document.getElementById('regYear').value;
                    const color = document.getElementById('regColor').value.trim();
                    const type = document.getElementById('regVehicleType').value;
                    const license = document.getElementById('regLicense').value.trim();
                    const insurance = document.getElementById('regInsurance').value.trim();

                    await setDoc(doc(db, 'conductores', user.uid), {
                        uid: user.uid, nombre: name, telefono: phone, photoURL,
                        disponible: false, enViaje: false, ubicacion: null,
                        calificacion: 5.0, calificacionTotal: 0, cantidadCalificaciones: 0,
                        viajesCompletados: 0, gananciasTotal: 0, gananciasDia: 0,
                        gananciasSemana: 0, gananciasMes: 0,
                        placa: plate, modelo: model, anio: year, color, tipoVehiculo: type,
                        licencia: license, seguro: insurance,
                        actualizado: serverTimestamp()
                    });
                }
                showToast('¡Cuenta creada exitosamente!');
            } catch(e) {
                const msgs = { 'auth/email-already-in-use':'Email ya registrado','auth/invalid-email':'Email inválido','auth/weak-password':'Contraseña débil' };
                showToast(msgs[e.code] || 'Error al crear cuenta','error');
                showLoading(false);
            }
        };

        // ===== LOGOUT =====
        window.logout = async function() {
            try {
                if (userRole === 'conductor' && isOnline && currentUser) {
                    await updateDoc(doc(db, 'conductores', currentUser.uid), { disponible: false });
                }
                if (chatUnsubscribe) chatUnsubscribe();
                if (tripUnsubscribe) tripUnsubscribe();
                if (offersUnsubscribe) offersUnsubscribe();
                await signOut(auth);
                location.reload();
            } catch(e) { location.reload(); }
        };

        // ===== AUTH STATE =====
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
            } else {
                showLoading(false);
            }
        });

        async function loadUserData() {
            try {
                const snap = await getDoc(doc(db, 'usuarios', currentUser.uid));
                if (!snap.exists()) {
                    showToast('Perfil no encontrado','error');
                    await signOut(auth);
                    return;
                }
                userData = snap.data();
                userRole = userData.rol || 'cliente';

                document.getElementById('userName').textContent = userData.nombre || 'Usuario';
                if (userData.photoURL) {
                    document.getElementById('headerPhoto').src = userData.photoURL;
                    document.getElementById('headerPhoto').style.display = 'block';
                    document.getElementById('headerIcon').style.display = 'none';
                }

                document.getElementById('authScreen').classList.remove('active');
                document.getElementById('mainScreen').classList.add('active');

                buildHeaderNav();
                await restoreAppState();

                if (mapsLoaded) initMap();
                if (userRole === 'conductor') loadDriverStats();
                listenForNotifications();
            } catch(e) {
                console.error('loadUserData error:', e);
                showToast('Error al cargar perfil','error');
                showLoading(false);
            }
        }

        function buildHeaderNav() {
            const nav = document.getElementById('headerNav');
            const clientItems = [
                { icon:'fa-home', label:'Inicio', action:'closeAllModals()' },
                { icon:'fa-history', label:'Mis Viajes', action:'openProfile()' },
                { icon:'fa-star', label:'Calificaciones', action:'openProfile()' },
                { icon:'fa-headset', label:'Soporte', action:'showToast("Soporte: 809-555-0100")' }
            ];
            const driverItems = [
                { icon:'fa-tachometer-alt', label:'Panel', action:'closeAllModals()' },
                { icon:'fa-wallet', label:'Ganancias', action:'openProfile()' },
                { icon:'fa-history', label:'Historial', action:'openProfile()' },
                { icon:'fa-headset', label:'Soporte', action:'showToast("Soporte: 809-555-0100")' }
            ];
            const items = userRole === 'conductor' ? driverItems : clientItems;
            nav.innerHTML = items.map(i =>
                `<button class="nav-item" onclick="${i.action}"><i class="fas ${i.icon}"></i>${i.label}</button>`
            ).join('');
        }

        window.closeAllModals = function() {
            document.querySelectorAll('.profile-modal,.notif-panel').forEach(el => {
                el.classList.remove('active');
            });
        };

        // ===== PERSIST =====
        async function saveAppState() {
            if (!currentUser) return;
            const state = { userRole, locations, currentTrip: currentTrip ? { id: currentTrip.id } : null, isOnline, ts: Date.now() };
            localStorage.setItem(`appState_${currentUser.uid}`, JSON.stringify(state));
            try {
                await setDoc(doc(db, 'estados', currentUser.uid), { ...state, actualizado: serverTimestamp() });
            } catch(e) {}
        }

        async function restoreAppState() {
            if (!currentUser) return;
            try {
                const snap = await getDoc(doc(db, 'estados', currentUser.uid));
                let state = snap.exists() ? snap.data() : JSON.parse(localStorage.getItem(`appState_${currentUser.uid}`) || 'null');
                if (!state) return;

                if (state.isOnline && userRole === 'conductor') isOnline = true;

                if (state.currentTrip?.id) {
                    const tSnap = await getDoc(doc(db, 'viajes', state.currentTrip.id));
                    if (tSnap.exists()) {
                        const td = tSnap.data();
                        if (!['completado','cancelado'].includes(td.estado)) {
                            currentTrip = { id: state.currentTrip.id, ...td };
                            if (td.origen) { locations.pickup = td.origen; updatePickupDisplay(td.origen.name || ''); }
                            if (td.destino) { locations.destination = td.destino; updateDestDisplay(td.destino.name || ''); }
                            listenToTrip(state.currentTrip.id);
                        }
                    }
                }
            } catch(e) { console.log('restoreAppState error:', e); }
        }

        // ===== MAP INIT =====
        function initMap() {
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: isDarkMap ? "#00d4ff" : "#0077ff",
                    strokeWeight: 5, strokeOpacity: 0.85
                }
            });

            const center = locations.current || { lat: 18.4861, lng: -69.9312 };
            const darkStyles = [
                { elementType:"geometry", stylers:[{color:"#1a2035"}] },
                { elementType:"labels.text.fill", stylers:[{color:"#7a8aaa"}] },
                { elementType:"labels.text.stroke", stylers:[{color:"#1a2035"}] },
                { featureType:"road", elementType:"geometry", stylers:[{color:"#253050"}] },
                { featureType:"road.arterial", elementType:"geometry", stylers:[{color:"#1e3660"}] },
                { featureType:"road.highway", elementType:"geometry", stylers:[{color:"#1b4080"}] },
                { featureType:"road", elementType:"labels.text.fill", stylers:[{color:"#8a9bc0"}] },
                { featureType:"water", elementType:"geometry", stylers:[{color:"#0d1a2e"}] },
                { featureType:"poi", elementType:"geometry", stylers:[{color:"#1e2d45"}] },
                { featureType:"poi", elementType:"labels.text.fill", stylers:[{color:"#5a7090"}] },
                { featureType:"transit", elementType:"geometry", stylers:[{color:"#1e2d45"}] }
            ];

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16, center, disableDefaultUI: true,
                styles: darkStyles, gestureHandling:'greedy',
                mapTypeControl: false, fullscreenControl: false,
                streetViewControl: false, zoomControl: false
            });

            window._darkMapStyles = darkStyles;
            directionsRenderer.setMap(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    updateUserPosition(p); map.setCenter(p);
                    if (!locations.pickup && userRole === 'cliente') {
                        reverseGeocode(p, addr => {
                            locations.pickup = { ...p, name: addr };
                            updatePickupDisplay(addr);
                            if (markers.pickup) markers.pickup.setMap(null);
                            markers.pickup = createMarker(map, p, 'pickup');
                        });
                    }
                }, err => {}, { enableHighAccuracy: true });

                navigator.geolocation.watchPosition(pos => {
                    const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    locations.current = p;
                    updateUserPosition(p);
                    if (isNavigating) checkVoiceNavigation(p);
                    if (userRole === 'conductor' && currentUser && isOnline) {
                        updateDoc(doc(db, 'conductores', currentUser.uid), { ubicacion: p, actualizado: serverTimestamp() }).catch(() => {});
                    }
                }, err => {}, { enableHighAccuracy: true, maximumAge: 4000, timeout: 10000 });
            }

            map.addListener('click', e => {
                if (mapClickMode === 'destination') {
                    setDestFromLatLng(e.latLng);
                    mapClickMode = null;
                    document.body.style.cursor = 'default';
                } else if (mapClickMode === 'pickup') {
                    setPickupFromLatLng(e.latLng);
                    mapClickMode = null;
                    document.body.style.cursor = 'default';
                }
            });

            // Init selector map
            initSelectorMap();

            if (userRole === 'cliente') {
                document.getElementById('clientPanel').classList.add('active');
                if (currentTrip) showTripStateClient();
            } else {
                document.getElementById('driverPanel').classList.add('active');
                document.getElementById('earningsSection').style.display = 'block';
                if (isOnline) {
                    document.getElementById('toggleSwitch').classList.add('active');
                    document.getElementById('statusText').textContent = 'Conectado';
                    document.getElementById('statusText').className = 'status-text online';
                }
                listenForTrips();
                listenForMyTrips();
            }

            // Restore markers if trip restored
            if (locations.pickup) createOrUpdateMarker('pickup', locations.pickup);
            if (locations.destination) createOrUpdateMarker('destination', locations.destination);
            if (locations.pickup && locations.destination) calcRoute();

            showLoading(false);
        }

        function initSelectorMap() {
            if (!google || !google.maps) return;
            const center = locations.current || { lat: 18.4861, lng: -69.9312 };
            selectorMap = new google.maps.Map(document.getElementById('mapSelector'), {
                zoom: 16, center, disableDefaultUI: true,
                styles: window._darkMapStyles || [], gestureHandling:'greedy',
                mapTypeControl:false, fullscreenControl:false, streetViewControl:false, zoomControl:false
            });
            selectorMap.addListener('click', e => {
                mapSelectorLatLng = { lat: e.latLng.lat(), lng: e.latLng.lng() };
                if (markers.selectorPin) markers.selectorPin.setMap(null);
                markers.selectorPin = new google.maps.Marker({
                    map: selectorMap, position: e.latLng,
                    icon: { path: google.maps.SymbolPath.BACKWARD_OPEN_ARROW, scale:6, fillColor:"#00d4ff", fillOpacity:1, strokeColor:"#fff", strokeWeight:2 }
                });
                reverseGeocode({ lat: e.latLng.lat(), lng: e.latLng.lng() }, addr => {
                    document.getElementById('mapSelectorAddr').textContent = addr;
                });
            });
        }

        // ===== ADDRESS MODAL =====
        window.openAddrModal = function(target) {
            addrModalTarget = target;
            const isPickup = target === 'pickup';
            document.getElementById('addrModalTitle').textContent = isPickup ? '¿Dónde te recogemos?' : '¿A dónde vas?';
            document.getElementById('addrSearchInput').value = '';
            document.getElementById('addrSuggestions').innerHTML = '';
            document.getElementById('addrModal').classList.add('active');
            setTimeout(() => document.getElementById('addrSearchInput').focus(), 300);

            // Autocomplete on this input
            if (google && google.maps && google.maps.places) {
                if (addrAutocomplete) google.maps.event.clearInstanceListeners(addrAutocomplete);
                addrAutocomplete = new google.maps.places.Autocomplete(document.getElementById('addrSearchInput'), { types:['geocode','establishment'] });
                addrAutocomplete.addListener('place_changed', () => {
                    const place = addrAutocomplete.getPlace();
                    if (place.geometry) {
                        const pos = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                        applyAddrSelection(pos, place.formatted_address || place.name);
                    }
                });
            }
        };

        window.closeAddrModal = function() {
            document.getElementById('addrModal').classList.remove('active');
            closeMapSelector();
        };

        window.onAddrSearch = function(val) {
            if (!val || val.length < 3) {
                document.getElementById('addrSuggestions').innerHTML = '';
                return;
            }
            if (!google || !google.maps || !google.maps.places) return;
            const svc = new google.maps.places.AutocompleteService();
            svc.getPlacePredictions({ input: val, types:['geocode','establishment'] }, (results, status) => {
                const container = document.getElementById('addrSuggestions');
                if (status !== 'OK' || !results) { container.innerHTML = ''; return; }
                container.innerHTML = results.map(r => `
                    <div class="addr-suggestion-item" onclick="selectAddrSuggestion('${r.place_id}','${escHtml(r.description)}')">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <div class="addr-sug-main">${r.structured_formatting?.main_text || r.description}</div>
                            <div class="addr-sug-sub">${r.structured_formatting?.secondary_text || ''}</div>
                        </div>
                    </div>
                `).join('');
            });
        };

        window.selectAddrSuggestion = function(placeId, desc) {
            if (!google) return;
            const svc = new google.maps.places.PlacesService(map || document.createElement('div'));
            svc.getDetails({ placeId }, (place, status) => {
                if (status === 'OK' && place.geometry) {
                    const pos = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                    applyAddrSelection(pos, place.formatted_address || desc);
                }
            });
        };

        window.openMapSelector = function() {
            document.getElementById('addrMapSelector').classList.add('active');
            if (selectorMap && locations.current) {
                selectorMap.setCenter(locations.current);
            }
            setTimeout(() => {
                if (selectorMap) google.maps.event.trigger(selectorMap, 'resize');
            }, 300);
        };

        window.closeMapSelector = function() {
            document.getElementById('addrMapSelector').classList.remove('active');
        };

        window.confirmMapSelection = function() {
            if (!mapSelectorLatLng) { showToast('Toca el mapa para seleccionar','error'); return; }
            const addr = document.getElementById('mapSelectorAddr').textContent;
            if (addr === 'Toca en el mapa para elegir ubicación') { showToast('Selecciona una ubicación','error'); return; }
            applyAddrSelection(mapSelectorLatLng, addr);
        };

        function applyAddrSelection(pos, addr) {
            if (addrModalTarget === 'pickup') {
                locations.pickup = { ...pos, name: addr };
                updatePickupDisplay(addr);
                createOrUpdateMarker('pickup', pos);
                if (locations.current && !locations.destination) map.panTo(pos);
            } else {
                locations.destination = { ...pos, name: addr };
                updateDestDisplay(addr);
                createOrUpdateMarker('destination', pos);
            }
            closeAddrModal();
            mapSelectorLatLng = null;
            if (locations.pickup && locations.destination) {
                calcRoute();
                document.getElementById('priceSection').style.display = 'block';
                document.getElementById('findDriverBtn').style.display = 'flex';
            }
        }

        function updatePickupDisplay(text) {
            const el = document.getElementById('pickupDisplay');
            el.textContent = text || '¿Dónde te recogemos?';
            el.classList.toggle('placeholder', !text);
        }
        function updateDestDisplay(text) {
            const el = document.getElementById('destDisplay');
            el.textContent = text || '¿A dónde vas?';
            el.classList.toggle('placeholder', !text);
        }

        // ===== MARKERS =====
        function createOrUpdateMarker(type, pos) {
            const configs = {
                pickup: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, fillColor:"#00d4ff", title:'Recogida', zIndex:900 },
                destination: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, fillColor:"#ff2255", title:'Destino', zIndex:800 }
            };
            const cfg = configs[type];
            if (!cfg) return;
            if (markers[type]) markers[type].setMap(null);
            markers[type] = new google.maps.Marker({
                map, position: pos,
                icon: { path: cfg.path, scale:7, fillColor: cfg.fillColor, fillOpacity:1, strokeColor:"#fff", strokeWeight:2 },
                title: cfg.title, zIndex: cfg.zIndex
            });
            map.panTo(pos);
        }

        function createMarker(m, pos, type) {
            const cfg = type === 'pickup'
                ? { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, fillColor:"#00d4ff" }
                : { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, fillColor:"#ff2255" };
            return new google.maps.Marker({
                map: m, position: pos,
                icon: { path: cfg.path, scale:7, fillColor: cfg.fillColor, fillOpacity:1, strokeColor:"#fff", strokeWeight:2 }
            });
        }

        function updateUserPosition(pos) {
            locations.current = pos;
            if (!markers.user) {
                markers.user = new google.maps.Marker({
                    map, position: pos, zIndex:1000,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale:9, fillColor:"#00d4ff", fillOpacity:1, strokeColor:"#fff", strokeWeight:3 }
                });
            } else { markers.user.setPosition(pos); }
        }

        // ===== GEOCODE HELPERS =====
        function reverseGeocode(pos, cb) {
            if (!geocoder) return;
            geocoder.geocode({ location: pos }, (results, status) => {
                if (status === 'OK' && results[0]) cb(results[0].formatted_address);
            });
        }

        window.enableMapSelection = function() {
            mapClickMode = 'destination';
            document.body.style.cursor = 'crosshair';
            showToast('Toca el mapa para seleccionar destino');
        };
        window.enableMapSelectionPickup = function() {
            mapClickMode = 'pickup';
            document.body.style.cursor = 'crosshair';
            showToast('Toca el mapa para seleccionar recogida');
        };

        function setPickupFromLatLng(latLng) {
            const pos = { lat: latLng.lat(), lng: latLng.lng() };
            reverseGeocode(pos, addr => {
                locations.pickup = { ...pos, name: addr };
                updatePickupDisplay(addr);
                createOrUpdateMarker('pickup', pos);
                if (locations.destination) calcRoute();
            });
        }

        function setDestFromLatLng(latLng) {
            const pos = { lat: latLng.lat(), lng: latLng.lng() };
            reverseGeocode(pos, addr => {
                locations.destination = { ...pos, name: addr };
                updateDestDisplay(addr);
                createOrUpdateMarker('destination', pos);
                if (locations.pickup) calcRoute();
            });
        }

        // ===== ROUTE =====
        function calcRoute() {
            if (!locations.pickup || !locations.destination || !directionsService) return;
            directionsService.route({
                origin: { lat: locations.pickup.lat, lng: locations.pickup.lng },
                destination: { lat: locations.destination.lat, lng: locations.destination.lng },
                travelMode: 'DRIVING'
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    steps = result.routes[0].legs[0].steps;
                    const leg = result.routes[0].legs[0];
                    const dist = leg.distance.value;
                    const base = Math.max(80, Math.ceil(dist / 100) * 10);
                    const eco = Math.floor(base * 0.8);
                    const prem = Math.ceil(base * 1.35);
                    document.getElementById('suggestedPrice').textContent = `RD$${base}`;
                    document.getElementById('economicPrice').textContent = `RD$${eco}`;
                    document.getElementById('premiumPrice').textContent = `RD$${prem}`;
                    document.getElementById('clientOffer').value = base;
                    selectPriceOption(1);
                    document.getElementById('priceSection').style.display = 'block';
                    document.getElementById('findDriverBtn').style.display = 'flex';
                }
            });
        }

        window.selectPriceOption = function(opt) {
            currentPriceOption = opt;
            document.querySelectorAll('.price-option').forEach((el,i) => el.classList.toggle('active', i+1 === opt));
            const prices = [
                parseInt(document.getElementById('suggestedPrice').textContent.replace('RD$','')),
                parseInt(document.getElementById('economicPrice').textContent.replace('RD$','')),
                parseInt(document.getElementById('premiumPrice').textContent.replace('RD$',''))
            ];
            if (!isNaN(prices[opt-1])) document.getElementById('clientOffer').value = prices[opt-1];
        };

        // ===== MAP CONTROLS =====
        window.toggleMapType = function() {
            isDarkMap = !isDarkMap;
            if (map) map.setOptions({ styles: isDarkMap ? (window._darkMapStyles || []) : [] });
            if (selectorMap) selectorMap.setOptions({ styles: isDarkMap ? (window._darkMapStyles || []) : [] });
        };

        window.centerOnUser = function() {
            if (locations.current && map) { map.panTo(locations.current); map.setZoom(17); }
            else showToast('Esperando GPS...','error');
        };

        window.toggleTheme = function() {
            isDarkTheme = !isDarkTheme;
            document.documentElement.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
            document.getElementById('themeBtn').innerHTML = isDarkTheme ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            if (!isDarkMap) toggleMapType(); // sync
        };

        window.toggleClientPanel = function() {
            isClientPanelHidden = !isClientPanelHidden;
            document.getElementById('clientPanel').classList.toggle('hidden', isClientPanelHidden);
            document.getElementById('clientPanelToggleIcon').className = isClientPanelHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        };

        window.toggleDriverPanel = function() {
            isDriverPanelHidden = !isDriverPanelHidden;
            document.getElementById('driverPanel').classList.toggle('hidden', isDriverPanelHidden);
            document.getElementById('driverPanelToggleIcon').className = isDriverPanelHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        };

        // ===== NOTIFICATIONS =====
        function listenForNotifications() {
            if (!currentUser) return;
            const q = query(collection(db, 'usuarios', currentUser.uid, 'notificaciones'), orderBy('creado','desc'), limit(30));
            onSnapshot(q, snap => {
                notifications = [];
                snap.forEach(d => notifications.push({ id: d.id, ...d.data() }));
                renderNotifications();
            });
        }

        function renderNotifications() {
            const list = document.getElementById('notifList');
            const badge = document.getElementById('notifBadge');
            const unread = notifications.filter(n => !n.leida).length;
            badge.textContent = unread;
            badge.style.display = unread > 0 ? 'flex' : 'none';

            if (!notifications.length) {
                list.innerHTML = '<div style="text-align:center;padding:32px;color:var(--text-dim);font-size:var(--fs-sm);">Sin notificaciones</div>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notif-item" onclick="markNotifRead('${n.id}')">
                    <i class="fas ${n.icono || 'fa-bell'}"></i>
                    <div style="flex:1;">
                        <div class="notif-text">${n.texto}</div>
                        <div class="notif-time">${n.creado?.toDate ? formatTime(n.creado.toDate()) : ''}</div>
                    </div>
                    ${!n.leida ? '<div style="width:7px;height:7px;border-radius:50%;background:var(--primary);flex-shrink:0;margin-top:5px;"></div>' : ''}
                </div>
            `).join('');
        }

        window.markNotifRead = async function(id) {
            if (!currentUser) return;
            try { await updateDoc(doc(db, 'usuarios', currentUser.uid, 'notificaciones', id), { leida: true }); } catch(e) {}
        };

        window.clearNotifications = async function() {
            if (!currentUser) return;
            try {
                const snap = await getDocs(collection(db, 'usuarios', currentUser.uid, 'notificaciones'));
                for (const d of snap.docs) await deleteDoc(d.ref);
            } catch(e) {}
        };

        window.toggleNotifPanel = function() {
            notifPanelOpen = !notifPanelOpen;
            document.getElementById('notifPanel').classList.toggle('active', notifPanelOpen);
        };

        async function addNotification(userId, texto, icono='fa-bell') {
            try {
                await addDoc(collection(db, 'usuarios', userId, 'notificaciones'), {
                    texto, icono, leida: false, creado: serverTimestamp()
                });
            } catch(e) {}
        }

        // ===== FIND DRIVER =====
        window.findDriver = async function() {
            if (!locations.pickup || !locations.destination) { showToast('Selecciona origen y destino','error'); return; }
            if (!currentUser) { showToast('No autenticado','error'); return; }

            showLoading(true);
            const offer = parseInt(document.getElementById('clientOffer').value) || 150;

            try {
                const tripData = {
                    clienteId: currentUser.uid, clienteNombre: userData.nombre || 'Cliente',
                    clienteTelefono: userData.telefono || '', clientePhoto: userData.photoURL || null,
                    clienteCalificacion: calcRatingAvg(userData),
                    origen: { lat: locations.pickup.lat, lng: locations.pickup.lng, name: locations.pickup.name || 'Recogida' },
                    destino: { lat: locations.destination.lat, lng: locations.destination.lng, name: locations.destination.name || 'Destino' },
                    precioOfrecido: offer, precioNegociado: null,
                    estado: 'buscando', creado: serverTimestamp()
                };
                const ref = await addDoc(collection(db, 'viajes'), tripData);
                currentTrip = { id: ref.id, ...tripData };
                await saveAppState();
                listenForDriverOffers(ref.id);
                document.getElementById('findDriverBtn').style.display = 'none';
                document.getElementById('driverOffersModal').classList.add('active');
                showToast('Buscando conductores...');
            } catch(e) {
                showToast('Error al buscar conductor: ' + e.message,'error');
            } finally { showLoading(false); }
        };

        function listenForDriverOffers(tripId) {
            if (tripUnsubscribe) tripUnsubscribe();
            tripUnsubscribe = onSnapshot(doc(db, 'viajes', tripId), async snap => {
                if (!snap.exists()) return;
                const data = snap.data();
                if (data.estado === 'aceptado' && data.conductorId) {
                    document.getElementById('driverOffersModal').classList.remove('active');
                    Object.values(driverOffersTimers).forEach(t => clearInterval(t));
                    driverOffersTimers = {};
                    currentTrip = { id: tripId, ...data };
                    await saveAppState();
                    showDriverInfo(data);
                    playNotifSound();
                    showToast(`¡${data.conductorNombre} aceptó tu viaje!`);
                    addNotification(currentUser.uid, `${data.conductorNombre} aceptó tu viaje`, 'fa-car');
                    startDriverTracking(data.conductorId, data);
                } else if (data.estado === 'conductor_llego') {
                    showToast('¡El conductor llegó a tu ubicación!','success');
                    addNotification(currentUser.uid, 'El conductor llegó a tu ubicación', 'fa-check-circle');
                    speak('El conductor ha llegado a tu ubicación');
                    showFloatingStatus('Conductor llegó');
                } else if (data.estado === 'en_curso') {
                    showToast('¡El viaje inició!');
                    showFloatingStatus('En camino al destino');
                    if (data.destino) startClientNavigation(data.destino);
                } else if (data.estado === 'completado') {
                    showToast('¡Viaje completado!','success');
                    hideFloatingStatus();
                    resetClientUI();
                    openRatingModal('conductor', data.conductorId, data.conductorNombre, data.conductorPhoto, tripId);
                } else if (data.estado === 'cancelado') {
                    showToast('El viaje fue cancelado','error');
                    hideFloatingStatus();
                    resetClientUI();
                } else if (data.estado === 'negociando' && data.precioNuevo) {
                    showNegotiateAlert(data);
                }
            });

            if (offersUnsubscribe) offersUnsubscribe();
            offersUnsubscribe = onSnapshot(collection(db, 'viajes', tripId, 'ofertas'), snap => {
                snap.docChanges().forEach(ch => {
                    if (ch.type === 'added') addDriverOfferCard(ch.doc.data(), ch.doc.id, tripId);
                });
            });
        }

        function listenToTrip(tripId) {
            if (tripUnsubscribe) tripUnsubscribe();
            tripUnsubscribe = onSnapshot(doc(db, 'viajes', tripId), snap => {
                if (!snap.exists()) return;
                const data = snap.data();
                if (data.estado === 'completado') {
                    showToast('Viaje completado');
                    hideFloatingStatus();
                    resetClientUI();
                }
            });
        }

        function showTripStateClient() {
            if (!currentTrip) return;
            if (['aceptado','conductor_llego','en_curso'].includes(currentTrip.estado)) {
                showDriverInfo(currentTrip);
                if (currentTrip.conductorId) startDriverTracking(currentTrip.conductorId, currentTrip);
            }
        }

        function addDriverOfferCard(oferta, ofertaId, tripId) {
            if (document.getElementById(`offer-${ofertaId}`)) return;
            const container = document.getElementById('driverOffersList');
            const card = document.createElement('div');
            card.id = `offer-${ofertaId}`;
            card.className = 'driver-offer-card';
            const ratingCount = oferta.conductorCantCalificaciones || 0;
            const ratingStr = ratingCount > 0 ? `${(oferta.conductorRating||5).toFixed(1)} (${ratingCount})` : 'Nuevo';
            card.innerHTML = `
                <div class="offer-timer" id="otimer-${ofertaId}" style="width:100%;"></div>
                <div class="driver-offer-header">
                    <img src="${oferta.conductorPhoto||'https://via.placeholder.com/52'}" class="driver-offer-photo">
                    <div class="driver-offer-info">
                        <h3>${oferta.conductorNombre}</h3>
                        <div class="driver-offer-rating"><i class="fas fa-star"></i> ${ratingStr}</div>
                        <div style="font-size:var(--fs-xs);color:var(--text-dim);margin-top:2px;">${oferta.conductorViajes||0} viajes · ${oferta.conductorModelo||''}</div>
                    </div>
                </div>
                <div class="offer-price">RD$ ${oferta.precioOfrecido}</div>
                <div class="offer-actions">
                    <button class="btn btn-success" onclick="acceptDriverOffer('${tripId}','${oferta.conductorId}',${oferta.precioOfrecido},'${ofertaId}')"><i class="fas fa-check"></i> Aceptar</button>
                    <button class="btn btn-danger" onclick="rejectDriverOffer('${tripId}','${ofertaId}')"><i class="fas fa-times"></i> Rechazar</button>
                </div>
            `;
            container.prepend(card);

            let tLeft = 60;
            const bar = document.getElementById(`otimer-${ofertaId}`);
            const iv = setInterval(() => {
                tLeft--;
                const pct = (tLeft/60)*100;
                bar.style.width = pct+'%';
                if (pct < 30) { bar.classList.add('danger'); bar.classList.remove('warning'); }
                else if (pct < 60) { bar.classList.add('warning'); }
                if (tLeft <= 0) { clearInterval(iv); card.remove(); delete driverOffersTimers[ofertaId]; }
            }, 1000);
            driverOffersTimers[ofertaId] = iv;
            playNotifSound();
        }

        window.acceptDriverOffer = async function(tripId, conductorId, precio, ofertaId) {
            showLoading(true);
            try {
                // Get conductor data
                const cdoc = await getDoc(doc(db, 'conductores', conductorId));
                const cd = cdoc.exists() ? cdoc.data() : {};

                await updateDoc(doc(db, 'viajes', tripId), {
                    estado: 'aceptado', conductorId,
                    conductorNombre: cd.nombre || '', conductorPhoto: cd.photoURL || null,
                    conductorRating: cd.calificacion || 5.0,
                    conductorViajes: cd.viajesCompletados || 0,
                    conductorModelo: cd.modelo || '', conductorPlaca: cd.placa || '',
                    precioNegociado: precio, aceptado: serverTimestamp()
                });

                // Delete all other offers
                const ofSnap = await getDocs(collection(db, 'viajes', tripId, 'ofertas'));
                for (const od of ofSnap.docs) {
                    if (od.id !== ofertaId) await deleteDoc(od.ref);
                }

                // Update driver state
                await updateDoc(doc(db, 'conductores', conductorId), { enViaje: true });

                addNotification(conductorId, `${userData.nombre} aceptó tu oferta de RD$${precio}`, 'fa-check-circle');
                showToast('Conductor seleccionado');
            } catch(e) { showToast('Error al aceptar oferta','error'); }
            finally { showLoading(false); }
        };

        window.rejectDriverOffer = async function(tripId, ofertaId) {
            try {
                await deleteDoc(doc(db, 'viajes', tripId, 'ofertas', ofertaId));
                document.getElementById(`offer-${ofertaId}`)?.remove();
                if (driverOffersTimers[ofertaId]) { clearInterval(driverOffersTimers[ofertaId]); delete driverOffersTimers[ofertaId]; }
            } catch(e) {}
        };

        window.closeDriverOffers = async function() {
            document.getElementById('driverOffersModal').classList.remove('active');
            if (currentTrip?.id) {
                try {
                    await updateDoc(doc(db, 'viajes', currentTrip.id), { estado:'cancelado', canceladoEn: serverTimestamp() });
                    const ofSnap = await getDocs(collection(db, 'viajes', currentTrip.id, 'ofertas'));
                    for (const od of ofSnap.docs) await deleteDoc(od.ref);
                } catch(e) {}
            }
            Object.values(driverOffersTimers).forEach(t => clearInterval(t));
            driverOffersTimers = {};
            document.getElementById('findDriverBtn').style.display = 'flex';
            currentTrip = null;
            saveAppState();
        };

        function showDriverInfo(data) {
            const card = document.getElementById('driverInfoCard');
            card.classList.add('active');
            document.getElementById('driverName').textContent = data.conductorNombre || 'Conductor';
            const rc = data.conductorCantCalificaciones || 0;
            const rv = rc > 0 ? (data.conductorRating||5).toFixed(1) : '5.0';
            document.getElementById('driverRating').textContent = rv;
            document.getElementById('driverTrips').textContent = `${data.conductorViajes||0} viajes`;
            document.getElementById('driverVehicle').textContent = [data.conductorModelo, data.conductorPlaca].filter(Boolean).join(' · ');
            if (data.conductorPhoto) document.getElementById('driverPhoto').src = data.conductorPhoto;
            window.currentDriverId = data.conductorId;
            window.currentTripId = currentTrip?.id;
        }

        // ===== DRIVER TRACKING (CLIENT VIEW) =====
        function startDriverTracking(driverId, tripData) {
            onSnapshot(doc(db, 'conductores', driverId), snap => {
                if (!snap.exists()) return;
                const d = snap.data();
                if (!d.ubicacion) return;
                const pos = d.ubicacion;

                if (!markers.driver) {
                    const el = document.createElement('div');
                    el.className = 'driver-marker-el';
                    el.innerHTML = '<i class="fas fa-car"></i>';
                    markers.driver = new google.maps.Marker({
                        map, position: pos, zIndex: 1100,
                        icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale:8, fillColor:"#00c96e", fillOpacity:1, strokeColor:"#fff", strokeWeight:2, rotation: d.rumbo||0 }
                    });
                } else {
                    markers.driver.setPosition(pos);
                }

                // Calc ETA to pickup or destination
                const target = ['en_curso'].includes(tripData?.estado) ? locations.destination : locations.pickup;
                if (target && google.maps.geometry) {
                    const dist = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(pos.lat, pos.lng),
                        new google.maps.LatLng(target.lat, target.lng)
                    );
                    const etaMin = Math.max(1, Math.ceil((dist/1000)/0.5));
                    const navEl = document.getElementById('navOverlay');
                    navEl.classList.add('active');

                    if (dist < 80) {
                        document.getElementById('navStepMain').textContent = '¡El conductor llegó!';
                        document.getElementById('navStepSub').textContent = 'Tu conductor te espera';
                        document.getElementById('navStepIcon').className = 'fas fa-check-circle';
                        document.getElementById('navStepDistance').textContent = '0';
                        document.getElementById('navDistUnit').textContent = 'm';
                    } else {
                        const label = ['en_curso'].includes(currentTrip?.estado) ? 'En camino al destino' : 'Conductor en camino';
                        document.getElementById('navStepMain').textContent = label;
                        document.getElementById('navStepSub').textContent = `Aprox. ${etaMin} min`;
                        document.getElementById('navStepIcon').className = 'fas fa-car';
                        document.getElementById('navStepDistance').textContent = dist >= 1000 ? (dist/1000).toFixed(1) : Math.round(dist);
                        document.getElementById('navDistUnit').textContent = dist >= 1000 ? 'km' : 'm';
                    }
                }
            });
        }

        function startClientNavigation(dest) {
            isNavigating = true;
            currentStepIndex = 0;
            if (locations.pickup && dest) {
                directionsService.route({
                    origin: locations.pickup, destination: dest, travelMode:'DRIVING'
                }, (res, st) => {
                    if (st === 'OK') {
                        directionsRenderer.setDirections(res);
                        steps = res.routes[0].legs[0].steps;
                        if (steps[0]) {
                            const instr = buildVoiceInstruction(steps[0]);
                            showFloatingStatus(instr);
                            speak(instr);
                        }
                    }
                });
            }
        }

        // ===== CLIENT RESET =====
        function resetClientUI() {
            document.getElementById('driverInfoCard').classList.remove('active');
            document.getElementById('priceSection').style.display = 'none';
            document.getElementById('findDriverBtn').style.display = 'none';
            updatePickupDisplay('');
            updateDestDisplay('');
            ['pickup','destination','driver'].forEach(k => { if (markers[k]) { markers[k].setMap(null); markers[k]=null; } });
            if (directionsRenderer) directionsRenderer.setDirections({ routes:[] });
            document.getElementById('navOverlay').classList.remove('active');
            currentTrip = null; locations.pickup = null; locations.destination = null;
            isNavigating = false; steps = []; currentStepIndex = 0;
            saveAppState();
        }

        // ===== NEGOTIATE =====
        function showNegotiateAlert(data) {
            currentNegotiationData = data;
            document.getElementById('negotiateAlertBody').textContent = `${data.conductorNombre} propone un nuevo precio:`;
            document.getElementById('negotiateAlertPrice').textContent = `RD$ ${data.precioNuevo}`;
            document.getElementById('negotiateAlert').classList.add('active');
            playNotifSound();
        }
        window.acceptNegotiation = async function() {
            if (!currentNegotiationData || !currentTrip) return;
            document.getElementById('negotiateAlert').classList.remove('active');
            try {
                await updateDoc(doc(db, 'viajes', currentTrip.id), { precioNegociado: currentNegotiationData.precioNuevo, estado:'aceptado' });
            } catch(e) {}
        };
        window.rejectNegotiation = function() {
            document.getElementById('negotiateAlert').classList.remove('active');
            currentNegotiationData = null;
        };

        // ===== DRIVER PANEL =====
        async function loadDriverStats() {
            if (!currentUser) return;
            const snap = await getDoc(doc(db, 'conductores', currentUser.uid));
            if (snap.exists()) updateDriverStatsUI(snap.data());
        }

        function updateDriverStatsUI(d) {
            const cnt = d.cantidadCalificaciones || 0;
            const rating = cnt > 0 ? (d.calificacionTotal / cnt).toFixed(1) : '5.0';
            document.getElementById('statRating').textContent = rating;
            document.getElementById('statTrips').textContent = d.viajesCompletados || 0;
            let earn = 0;
            if (earningsPeriod==='day') earn = d.gananciasDia||0;
            else if (earningsPeriod==='week') earn = d.gananciasSemana||0;
            else earn = d.gananciasMes||0;
            document.getElementById('statEarnings').textContent = `RD$${earn}`;
            document.getElementById('earningsAmount').textContent = `RD$ ${earn}`;
        }

        window.setEarningsPeriod = function(period, btn) {
            earningsPeriod = period;
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            loadDriverStats();
        };

        window.toggleStatus = async function() {
            if (!currentUser) return;
            isOnline = !isOnline;
            const sw = document.getElementById('toggleSwitch');
            const txt = document.getElementById('statusText');
            sw.classList.toggle('active', isOnline);
            txt.textContent = isOnline ? 'Conectado' : 'Desconectado';
            txt.className = 'status-text ' + (isOnline ? 'online' : 'offline');
            try {
                await updateDoc(doc(db, 'conductores', currentUser.uid), { disponible: isOnline, actualizado: serverTimestamp() });
                if (isOnline) showToast('Ahora recibes solicitudes de viaje');
                saveAppState();
            } catch(e) {}
        };

        function listenForTrips() {
            const q = query(collection(db, 'viajes'), where('estado','==','buscando'));
            onSnapshot(q, snap => {
                const container = document.getElementById('requestsList');
                if (!isOnline) {
                    container.innerHTML = `<div style="text-align:center;padding:32px;color:var(--text-dim);font-size:var(--fs-sm);"><i class="fas fa-power-off" style="font-size:32px;display:block;margin-bottom:10px;"></i>Activa tu disponibilidad</div>`;
                    return;
                }
                if (snap.empty) {
                    container.innerHTML = `<div style="text-align:center;padding:32px;color:var(--text-dim);font-size:var(--fs-sm);"><i class="fas fa-search" style="font-size:32px;display:block;margin-bottom:10px;"></i>Sin solicitudes disponibles</div>`;
                    return;
                }
                let html = '';
                snap.forEach(d => {
                    const trip = d.data();
                    const dist = (locations.current && trip.origen) ? (
                        google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(locations.current.lat, locations.current.lng),
                            new google.maps.LatLng(trip.origen.lat, trip.origen.lng)
                        ) / 1000
                    ).toFixed(1) : '?';
                    const cRating = trip.clienteCalificacion ? `<i class="fas fa-star" style="color:var(--warning);"></i> ${trip.clienteCalificacion}` : '';
                    html += `
                        <div class="request-card">
                            <div class="request-header">
                                <div>
                                    <div style="font-weight:700;font-size:var(--fs-md);">${trip.clienteNombre}</div>
                                    <div style="font-size:var(--fs-xs);color:var(--text-dim);">A ${dist}km de ti ${cRating}</div>
                                </div>
                                <div class="request-price">RD$ ${trip.precioOfrecido}</div>
                            </div>
                            <div class="request-route">
                                <div class="route-point"><div class="route-dot pickup"></div><span>${trip.origen?.name||'Recogida'}</span></div>
                                <div class="route-point"><div class="route-dot dest"></div><span>${trip.destino?.name||'Destino'}</span></div>
                            </div>
                            <div class="request-actions">
                                <button class="btn btn-success" onclick="makeOffer('${d.id}',${trip.precioOfrecido})"><i class="fas fa-hand-holding-usd"></i> Hacer Oferta</button>
                                <button class="btn btn-secondary" style="flex:0.5;" onclick="showTripOnMap(${trip.origen?.lat},${trip.origen?.lng})"><i class="fas fa-map"></i></button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        window.showTripOnMap = function(lat, lng) {
            if (!lat || !lng || !map) return;
            map.panTo({ lat, lng }); map.setZoom(16);
        };

        function listenForMyTrips() {
            if (!currentUser) return;
            const q = query(collection(db,'viajes'), where('conductorId','==',currentUser.uid), where('estado','in',['aceptado','en_curso','conductor_llego']));
            onSnapshot(q, snap => {
                if (!snap.empty) {
                    snap.forEach(d => {
                        currentTrip = { id: d.id, ...d.data() };
                        showDriverCurrentTrip(currentTrip);
                    });
                } else {
                    document.getElementById('currentTripCard').classList.remove('active');
                    document.getElementById('requestsList').style.display = 'block';
                    document.getElementById('sosButton').classList.remove('active');
                    hideFloatingStatus();
                    document.getElementById('navOverlay').classList.remove('active');
                }
            });
        }

        function showDriverCurrentTrip(trip) {
            document.getElementById('currentTripCard').classList.add('active');
            document.getElementById('requestsList').style.display = 'none';
            document.getElementById('sosButton').classList.add('active');

            document.getElementById('clientName').textContent = trip.clienteNombre||'Cliente';
            document.getElementById('tripPickup').textContent = trip.origen?.name||'Origen';
            document.getElementById('tripDest').textContent = trip.destino?.name||'Destino';
            document.getElementById('tripEarnings').textContent = `RD$ ${trip.precioNegociado||trip.precioOfrecido}`;
            if (trip.clientePhoto) document.getElementById('clientPhoto').src = trip.clientePhoto;

            const cRating = trip.clienteCalificacion;
            document.getElementById('clientRatingDisplay').innerHTML = cRating ? `<i class="fas fa-star" style="color:var(--warning);"></i> ${cRating} cliente` : '';

            if (locations.current && trip.origen) {
                const dist = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(locations.current.lat, locations.current.lng),
                    new google.maps.LatLng(trip.origen.lat, trip.origen.lng)
                ) / 1000;
                document.getElementById('clientDistance').textContent = dist.toFixed(1)+' km';
                document.getElementById('tripDistance').textContent = dist.toFixed(1)+' km';
                document.getElementById('tripTime').textContent = Math.ceil(dist/0.5)+' min';
            }

            ['btnLlegue','btnIniciar','btnFinalizar'].forEach(id => document.getElementById(id).style.display='none');

            if (trip.estado === 'aceptado') {
                document.getElementById('tripStatus').textContent = 'En camino al cliente';
                document.getElementById('btnLlegue').style.display = 'flex';
                showFloatingStatus('En camino al cliente');
                showRouteToPoint(trip.origen, true);
            } else if (trip.estado === 'conductor_llego') {
                document.getElementById('tripStatus').textContent = 'Esperando al cliente';
                document.getElementById('btnIniciar').style.display = 'flex';
                hideFloatingStatus();
                speak('Has llegado al punto de recogida. Esperando al cliente.');
            } else if (trip.estado === 'en_curso') {
                document.getElementById('tripStatus').textContent = 'Viaje en progreso';
                document.getElementById('btnFinalizar').style.display = 'flex';
                showFloatingStatus('En camino al destino');
                showRouteToPoint(trip.destino, true);
            }

            window.currentTripId = trip.id;
            window.currentClientId = trip.clienteId;
        }

        function showRouteToPoint(dest, startNav) {
            if (!locations.current || !dest || !directionsService) return;
            directionsService.route({
                origin: locations.current, destination: dest, travelMode:'DRIVING'
            }, (res, st) => {
                if (st === 'OK') {
                    directionsRenderer.setDirections(res);
                    steps = res.routes[0].legs[0].steps;
                    if (startNav) {
                        isNavigating = true;
                        currentStepIndex = 0;
                        if (steps[0]) {
                            const instr = buildVoiceInstruction(steps[0]);
                            showNavStep(0);
                            speak(instr);
                        }
                    }
                }
            });
        }

        window.makeOffer = async function(tripId, clientPrice) {
            if (!currentUser || !isOnline) return;
            const myPrice = prompt(`El cliente ofrece: RD$ ${clientPrice}\n¿A qué precio aceptas? (mínimo 50)`, clientPrice);
            if (myPrice === null) return;
            const offerPrice = parseInt(myPrice);
            if (isNaN(offerPrice) || offerPrice < 50) { showToast('Precio inválido','error'); return; }

            showLoading(true);
            try {
                const cdoc = await getDoc(doc(db, 'conductores', currentUser.uid));
                const cd = cdoc.exists() ? cdoc.data() : {};
                const cnt = cd.cantidadCalificaciones || 0;
                const rating = cnt > 0 ? (cd.calificacionTotal / cnt) : 5.0;

                await addDoc(collection(db, 'viajes', tripId, 'ofertas'), {
                    conductorId: currentUser.uid, conductorNombre: userData.nombre,
                    conductorPhoto: userData.photoURL||null, conductorRating: parseFloat(rating.toFixed(1)),
                    conductorCantCalificaciones: cnt, conductorViajes: cd.viajesCompletados||0,
                    conductorModelo: cd.modelo||'', conductorPlaca: cd.placa||'',
                    precioOfrecido: offerPrice, timestamp: serverTimestamp()
                });

                // Notify client
                const tSnap = await getDoc(doc(db, 'viajes', tripId));
                if (tSnap.exists()) {
                    addNotification(tSnap.data().clienteId, `${userData.nombre} ofreció RD$${offerPrice} para tu viaje`, 'fa-car');
                }
                showToast('Oferta enviada al cliente');
            } catch(e) { showToast('Error al enviar oferta','error'); }
            finally { showLoading(false); }
        };

        window.driverArrived = async function() {
            if (!currentTrip) return;
            try {
                await updateDoc(doc(db, 'viajes', currentTrip.id), { estado:'conductor_llego', llegadaConductor: serverTimestamp() });
                addNotification(currentTrip.clienteId, '¡El conductor llegó a tu ubicación!', 'fa-check-circle');
                showToast('Marcaste que llegaste al origen');
                speak('Has llegado al punto de recogida.');
            } catch(e) { showToast('Error','error'); }
        };

        window.startTrip = async function() {
            if (!currentTrip) return;
            try {
                await updateDoc(doc(db, 'viajes', currentTrip.id), { estado:'en_curso', inicioViaje: serverTimestamp() });
                addNotification(currentTrip.clienteId, '¡El viaje ha iniciado!', 'fa-route');
                showToast('¡Viaje iniciado!');
            } catch(e) { showToast('Error','error'); }
        };

        window.endTrip = async function() {
            if (!currentTrip) return;
            showLoading(true);
            try {
                const price = currentTrip.precioNegociado || currentTrip.precioOfrecido;
                await updateDoc(doc(db, 'viajes', currentTrip.id), { estado:'completado', finViaje: serverTimestamp() });
                await updateDoc(doc(db, 'conductores', currentUser.uid), {
                    viajesCompletados: increment(1), gananciasTotal: increment(price),
                    gananciasDia: increment(price), gananciasSemana: increment(price), gananciasMes: increment(price), enViaje: false
                });
                addNotification(currentTrip.clienteId, '¡Viaje completado! Califica tu experiencia', 'fa-flag-checkered');
                showToast('¡Viaje completado exitosamente!');
                hideFloatingStatus();
                document.getElementById('navOverlay').classList.remove('active');
                if (directionsRenderer) directionsRenderer.setDirections({ routes:[] });
                const savedClientId = currentTrip.clienteId;
                const savedClientName = currentTrip.clienteNombre;
                const savedClientPhoto = currentTrip.clientePhoto;
                const savedTripId = currentTrip.id;
                currentTrip = null;
                isNavigating = false; steps = []; currentStepIndex = 0;
                loadDriverStats();
                // Show rating for client
                openRatingModal('cliente', savedClientId, savedClientName, savedClientPhoto, savedTripId);
            } catch(e) { showToast('Error al finalizar','error'); }
            finally { showLoading(false); }
        };

        // ===== RATING =====
        window.openRatingModal = function(targetRole, targetId, targetName, targetPhoto, tripId) {
            selectedRating = 0;
            ratingTripId = tripId;
            ratingTargetId = targetId;
            window._ratingTargetRole = targetRole;

            document.getElementById('ratingPhoto').src = targetPhoto || 'https://via.placeholder.com/70';
            document.getElementById('ratingName').textContent = targetName || 'Usuario';
            document.getElementById('ratingDesc').textContent = targetRole === 'conductor' ? '¿Cómo fue el conductor?' : '¿Cómo fue el cliente?';
            document.getElementById('ratingComment').value = '';
            document.querySelectorAll('#starRating i').forEach(s => s.classList.remove('active'));
            document.getElementById('ratingModal').classList.add('active');
        };

        window.setRating = function(val) {
            selectedRating = val;
            document.querySelectorAll('#starRating i').forEach((s, i) => s.classList.toggle('active', i < val));
        };

        window.submitRating = async function() {
            if (!selectedRating) { showToast('Selecciona una calificación','error'); return; }
            if (!ratingTargetId || !currentUser) return;
            const comment = document.getElementById('ratingComment').value.trim();

            try {
                // Save rating
                await addDoc(collection(db, 'calificaciones'), {
                    calificadorId: currentUser.uid, calificadorNombre: userData.nombre,
                    calificadoId: ratingTargetId, tripId: ratingTripId,
                    estrellas: selectedRating, comentario: comment,
                    creado: serverTimestamp()
                });

                // Update target's rating
                const targetCol = window._ratingTargetRole === 'conductor' ? 'conductores' : 'usuarios';
                await updateDoc(doc(db, targetCol, ratingTargetId), {
                    calificacionTotal: increment(selectedRating),
                    cantidadCalificaciones: increment(1)
                });

                document.getElementById('ratingModal').classList.remove('active');
                showToast('¡Calificación enviada!');
                addNotification(ratingTargetId, `${userData.nombre} te calificó con ${selectedRating} ⭐`, 'fa-star');
            } catch(e) { showToast('Error al enviar calificación','error'); }
        };

        // ===== CANCEL =====
        window.showCancelModal = function() {
            if (!currentTrip) { showToast('No hay viaje activo','error'); return; }
            document.getElementById('cancelModal').classList.add('active');
        };
        window.closeCancelModal = function() { document.getElementById('cancelModal').classList.remove('active'); };

        window.cancelTrip = async function(reason) {
            if (!currentTrip) return;
            showLoading(true);
            try {
                await updateDoc(doc(db, 'viajes', currentTrip.id), {
                    estado:'cancelado', motivoCancelacion: reason,
                    canceladoPor: userRole, canceladoEn: serverTimestamp()
                });
                if (userRole === 'conductor') {
                    await updateDoc(doc(db, 'conductores', currentUser.uid), { enViaje: false });
                    addNotification(currentTrip.clienteId, `El conductor canceló el viaje: ${reason}`, 'fa-times-circle');
                } else {
                    if (currentTrip.conductorId) addNotification(currentTrip.conductorId, `El cliente canceló el viaje: ${reason}`, 'fa-times-circle');
                }
                showToast('Viaje cancelado'); closeCancelModal(); hideFloatingStatus();
                if (userRole === 'cliente') resetClientUI();
                else {
                    document.getElementById('currentTripCard').classList.remove('active');
                    document.getElementById('requestsList').style.display = 'block';
                    document.getElementById('sosButton').classList.remove('active');
                    if (directionsRenderer) directionsRenderer.setDirections({ routes:[] });
                    currentTrip = null;
                }
            } catch(e) { showToast('Error al cancelar','error'); }
            finally { showLoading(false); }
        };

        // ===== SOS =====
        window.triggerSOS = function() {
            if (confirm('¿Activar alerta de emergencia? Esto notificará a contactos de emergencia.')) {
                showToast('🚨 Alerta de emergencia activada','error');
                if (currentTrip) {
                    addDoc(collection(db, 'emergencias'), {
                        userId: currentUser.uid, tripId: currentTrip.id,
                        ubicacion: locations.current, creado: serverTimestamp()
                    }).catch(() => {});
                }
            }
        };

        // ===== VOICE NAV =====
        function checkVoiceNavigation(myPos) {
            if (!steps || currentStepIndex >= steps.length) return;
            const nextStep = steps[currentStepIndex];
            const dist = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(myPos.lat, myPos.lng),
                nextStep.end_location
            );
            if (dist < 30) {
                currentStepIndex++;
                if (steps[currentStepIndex]) {
                    const instr = buildVoiceInstruction(steps[currentStepIndex]);
                    showNavStep(currentStepIndex);
                    speak(instr);
                    showFloatingStatus(instr);
                } else {
                    speak('Has llegado a tu destino.');
                    showFloatingStatus('Llegaste al destino');
                    isNavigating = false;
                }
            }
        }

        function buildVoiceInstruction(step) {
            if (!step) return '';
            const clean = cleanHtml(step.instructions || '');
            const dist = step.distance?.value || 0;
            const distText = dist >= 1000 ? `en ${(dist/1000).toFixed(1)} kilómetros` : `a ${Math.round(dist)} metros`;
            return `${distText}, ${clean}`;
        }

        function showNavStep(idx) {
            if (!steps[idx]) return;
            const step = steps[idx];
            const next = steps[idx+1];
            const dist = step.distance?.value || 0;
            const instr = cleanHtml(step.instructions || '');
            document.getElementById('navStepMain').textContent = instr;
            document.getElementById('navStepSub').textContent = next ? cleanHtml(next.instructions || '') : 'Llegando al destino';
            document.getElementById('navStepDistance').textContent = dist >= 1000 ? (dist/1000).toFixed(1) : Math.round(dist);
            document.getElementById('navDistUnit').textContent = dist >= 1000 ? 'km' : 'm';
            document.getElementById('navOverlay').classList.add('active');

            // Icon by maneuver
            const m = step.maneuver || '';
            let icon = 'fa-arrow-up';
            if (m.includes('left')) icon = 'fa-arrow-left';
            else if (m.includes('right')) icon = 'fa-arrow-right';
            else if (m.includes('uturn')) icon = 'fa-undo';
            else if (m.includes('roundabout')) icon = 'fa-circle-notch';
            document.getElementById('navStepIcon').className = `fas ${icon}`;
        }

        function speak(text) {
            if (!audioEnabled) return;
            lastSpokenText = text;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'es-ES'; msg.rate = 1.0; msg.pitch = 1.0;
            window.speechSynthesis.speak(msg);
        }

        function cleanHtml(html) {
            const d = document.createElement('div');
            d.innerHTML = html;
            return d.textContent || d.innerText || '';
        }

        window.repeatLastSpeak = function() { if (lastSpokenText) speak(lastSpokenText); };

        // ===== CHAT =====
        window.openChat = function() {
            if (!currentTrip?.id && !window.currentTripId) { showToast('No hay viaje activo','error'); return; }
            const tid = currentTrip?.id || window.currentTripId;
            window.currentTripId = tid;
            document.getElementById('chatModal').classList.add('active');
            const chatName = userRole === 'cliente' ? (currentTrip?.conductorNombre||'Conductor') : (currentTrip?.clienteNombre||'Cliente');
            const chatPhoto = userRole === 'cliente' ? (currentTrip?.conductorPhoto||'') : (currentTrip?.clientePhoto||'');
            document.getElementById('chatName').textContent = chatName;
            if (chatPhoto) document.getElementById('chatPhoto').src = chatPhoto;
            loadMessages(tid);
        };

        window.closeChat = function(event) {
            if (!event || event.target.id === 'chatModal') {
                document.getElementById('chatModal').classList.remove('active');
                if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
            }
        };

        function loadMessages(tripId) {
            if (chatUnsubscribe) chatUnsubscribe();
            const q = query(collection(db,'viajes',tripId,'mensajes'), orderBy('timestamp','asc'));
            chatUnsubscribe = onSnapshot(q, snap => {
                const c = document.getElementById('chatMessages');
                c.innerHTML = '';
                snap.forEach(d => {
                    const msg = d.data();
                    const sent = msg.remitente === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `message ${sent?'sent':'received'}`;
                    div.textContent = msg.texto;
                    c.appendChild(div);
                    if (!sent && audioEnabled) playMsgSound();
                });
                c.scrollTop = c.scrollHeight;
            });
        }

        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            const tid = currentTrip?.id || window.currentTripId;
            if (!text || !tid) return;
            try {
                await addDoc(collection(db,'viajes',tid,'mensajes'), {
                    texto: text, remitente: currentUser.uid,
                    remitenteNombre: userData.nombre, timestamp: serverTimestamp()
                });
                input.value = '';
            } catch(e) { showToast('Error al enviar','error'); }
        };

        window.handleKeyPress = function(e) { if (e.key === 'Enter') sendMessage(); };

        // ===== PROFILE =====
        window.openProfile = function() {
            if (!userData) return;
            document.getElementById('profileModal').classList.add('active');
            document.getElementById('profileName').textContent = userData.nombre||'';
            document.getElementById('profileEmail').textContent = userData.email||'';
            if (userData.photoURL) document.getElementById('profilePhotoLarge').src = userData.photoURL;

            const cnt = userData.cantidadCalificaciones || 0;
            const avg = cnt > 0 ? (userData.calificacionTotal / cnt).toFixed(1) : '5.0';
            document.getElementById('profileRatingDisplay').innerHTML = `<i class="fas fa-star"></i> ${avg} (${cnt} calificaciones)`;

            document.getElementById('editName').value = userData.nombre||'';
            document.getElementById('editPhone').value = userData.telefono||'';
            document.getElementById('editGender').value = userData.genero||'';
            document.getElementById('editBirth').value = userData.fechaNacimiento||'';
            document.getElementById('editAddress').value = userData.direccion||'';

            if (userRole === 'conductor') {
                document.getElementById('driverProfileCard').style.display = 'block';
                getDoc(doc(db, 'conductores', currentUser.uid)).then(d => {
                    if (d.exists()) {
                        const cd = d.data();
                        document.getElementById('editPlate').value = cd.placa||'';
                        document.getElementById('editModel').value = cd.modelo||'';
                        document.getElementById('editYear').value = cd.anio||'';
                        document.getElementById('editColor').value = cd.color||'';
                        document.getElementById('editVehicleType').value = cd.tipoVehiculo||'sedan';
                        document.getElementById('editLicense').value = cd.licencia||'';
                        document.getElementById('editInsurance').value = cd.seguro||'';
                    }
                });
            }

            // Load trip history
            loadTripHistory();
        };

        async function loadTripHistory() {
            if (!currentUser) return;
            const q = query(
                collection(db, 'viajes'),
                where(userRole==='conductor' ? 'conductorId' : 'clienteId', '==', currentUser.uid),
                where('estado','==','completado'),
                orderBy('finViaje','desc'),
                limit(10)
            );
            try {
                const snap = await getDocs(q);
                const el = document.getElementById('tripHistoryList');
                if (snap.empty) return;
                el.innerHTML = snap.docs.map(d => {
                    const t = d.data();
                    return `
                        <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-size:var(--fs-xs);font-weight:600;">${t.origen?.name||'Origen'} → ${t.destino?.name||'Destino'}</div>
                                <div style="font-size:var(--fs-xs);color:var(--text-dim);">${t.finViaje?.toDate ? formatTime(t.finViaje.toDate()) : ''}</div>
                            </div>
                            <div style="font-size:var(--fs-sm);font-weight:700;color:var(--success);">RD$ ${t.precioNegociado||t.precioOfrecido}</div>
                        </div>
                    `;
                }).join('');
            } catch(e) {}
        }

        window.closeProfile = function() { document.getElementById('profileModal').classList.remove('active'); };

        window.updateProfilePhoto = async function(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;
            showLoading(true);
            try {
                const sRef = ref(storage, `profiles/${currentUser.uid}`);
                await uploadBytes(sRef, file);
                const url = await getDownloadURL(sRef);
                await updateProfile(auth.currentUser, { photoURL: url });
                await updateDoc(doc(db, 'usuarios', currentUser.uid), { photoURL: url });
                if (userRole === 'conductor') await updateDoc(doc(db, 'conductores', currentUser.uid), { photoURL: url });
                userData.photoURL = url;
                document.getElementById('profilePhotoLarge').src = url;
                document.getElementById('headerPhoto').src = url;
                document.getElementById('headerPhoto').style.display = 'block';
                document.getElementById('headerIcon').style.display = 'none';
                showToast('Foto actualizada');
            } catch(e) { showToast('Error al actualizar foto','error'); }
            finally { showLoading(false); }
        };

        window.saveProfile = async function() {
            const nombre = document.getElementById('editName').value.trim();
            if (!nombre) { showToast('El nombre es requerido','error'); return; }
            showLoading(true);
            try {
                const upd = {
                    nombre, telefono: document.getElementById('editPhone').value.trim(),
                    genero: document.getElementById('editGender').value,
                    fechaNacimiento: document.getElementById('editBirth').value,
                    direccion: document.getElementById('editAddress').value.trim()
                };
                await updateDoc(doc(db, 'usuarios', currentUser.uid), upd);
                if (userRole === 'conductor') {
                    await updateDoc(doc(db, 'conductores', currentUser.uid), {
                        nombre, telefono: upd.telefono,
                        placa: document.getElementById('editPlate').value.trim(),
                        modelo: document.getElementById('editModel').value.trim(),
                        anio: document.getElementById('editYear').value,
                        color: document.getElementById('editColor').value.trim(),
                        tipoVehiculo: document.getElementById('editVehicleType').value,
                        licencia: document.getElementById('editLicense').value.trim(),
                        seguro: document.getElementById('editInsurance').value.trim()
                    });
                }
                userData = { ...userData, ...upd };
                document.getElementById('userName').textContent = nombre;
                document.getElementById('profileName').textContent = nombre;
                showToast('Perfil actualizado'); closeProfile();
            } catch(e) { showToast('Error al guardar','error'); }
            finally { showLoading(false); }
        };

        // ===== FLOATING STATUS =====
        function showFloatingStatus(text) {
            lastSpokenText = text;
            document.getElementById('floatingStatusText').textContent = text;
            document.getElementById('floatingStatus').classList.add('active');
        }
        function hideFloatingStatus() { document.getElementById('floatingStatus').classList.remove('active'); }

        // ===== AUDIO =====
        window.toggleAudio = function() {
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audioControlBtn');
            btn.classList.toggle('muted', !audioEnabled);
            btn.innerHTML = audioEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            if (!audioEnabled) window.speechSynthesis.cancel();
        };

        function playNotifSound() {
            if (!audioEnabled) return;
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 880; osc.type = 'sine';
                gain.gain.setValueAtTime(0.25, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
            } catch(e) {}
        }

        function playMsgSound() {
            if (!audioEnabled) return;
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 1100; osc.type = 'sine';
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.25);
            } catch(e) {}
        }

        // ===== UTILS =====
        function calcRatingAvg(ud) {
            const cnt = ud?.cantidadCalificaciones || 0;
            if (!cnt) return '5.0';
            return ((ud.calificacionTotal || 0) / cnt).toFixed(1);
        }

        function formatTime(date) {
            if (!(date instanceof Date)) return '';
            return date.toLocaleDateString('es-DO', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
        }

        function escHtml(str) { return str.replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show';
            t.style.borderColor = type === 'error' ? 'rgba(255,34,85,0.4)' : type === 'success' ? 'rgba(0,201,110,0.4)' : 'rgba(0,212,255,0.25)';
            clearTimeout(window._toastTimer);
            window._toastTimer = setTimeout(() => t.classList.remove('show'), 3200);
        }

        function showLoading(show) { document.getElementById('loadingScreen').classList.toggle('active', show); }

        // Expose to global
        window.showToast = showToast;
        window.showLoading = showLoading;
        window.openRatingModal = window.openRatingModal;
    </script>
</body>
</html>
