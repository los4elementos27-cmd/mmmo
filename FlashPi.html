<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retom - Transporte</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:'Outfit',sans-serif}
        :root{
            --pr:#00d4ff;--sec:#7b2cbf;--ok:#00ff88;--warn:#ffaa00;--err:#ff0055;
            --bg:#0a0a12;--surf:#151520;--surf2:#1e1e2e;--txt:#ffffff;--txt2:rgba(255,255,255,0.6);--txt3:rgba(255,255,255,0.3);
            --brd:rgba(255,255,255,0.08);--brd2:rgba(0,212,255,0.25);
            --r8:8px;--r12:12px;--r16:16px;--r20:20px;--r24:24px;
            --fs10:clamp(9px,2vw,10px);--fs11:clamp(10px,2.2vw,11px);--fs12:clamp(10.5px,2.4vw,12px);
            --fs13:clamp(11px,2.6vw,13px);--fs14:clamp(12px,2.8vw,14px);--fs15:clamp(12.5px,3vw,15px);
            --fs16:clamp(13px,3.2vw,16px);--fs18:clamp(14px,3.6vw,18px);--fs20:clamp(15px,4vw,20px);
            --fs22:clamp(16px,4.4vw,22px);--fs24:clamp(17px,4.8vw,24px);--fs28:clamp(18px,5.6vw,28px);
            --sp4:4px;--sp6:6px;--sp8:8px;--sp10:10px;--sp12:12px;--sp14:14px;--sp16:16px;--sp20:20px;--sp24:24px;
        }
        body.light-mode{
            --bg:#f0f2f5;--surf:#ffffff;--surf2:#f8f9fc;--txt:#111827;--txt2:rgba(0,0,0,0.6);--txt3:rgba(0,0,0,0.3);
            --brd:rgba(0,0,0,0.08);--brd2:rgba(0,100,200,0.25);
        }
        html,body{height:100%;width:100%;background:var(--bg);overflow:hidden;position:fixed;color:var(--txt)}
        #map{height:100%;width:100%;position:absolute;top:0;left:0;z-index:1}
        body.light-mode #map{filter:none}
        .screen{display:none;position:fixed;inset:0;z-index:100;background:linear-gradient(135deg,var(--bg),var(--surf));overflow-y:auto}
        .screen.active{display:flex;flex-direction:column}
        /* ---- AUTH ---- */
        .auth-wrap{flex:1;display:flex;justify-content:center;align-items:flex-start;padding:var(--sp16);padding-top:max(env(safe-area-inset-top),var(--sp16));min-height:100%}
        .auth-card{background:var(--surf);border-radius:var(--r24);padding:var(--sp24);width:100%;max-width:380px;border:1px solid var(--brd2);backdrop-filter:blur(20px);margin:auto}
        .logo-big{width:60px;height:60px;background:linear-gradient(135deg,var(--pr),var(--sec));border-radius:var(--r16);display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto var(--sp16);box-shadow:0 8px 32px rgba(0,212,255,0.25)}
        .auth-card h1{text-align:center;font-size:var(--fs24);font-weight:800;background:linear-gradient(135deg,var(--pr),var(--sec));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:var(--sp4)}
        .auth-card>p{text-align:center;color:var(--txt2);font-size:var(--fs12);margin-bottom:var(--sp20)}
        .role-selector{display:flex;gap:var(--sp10);margin-bottom:var(--sp20)}
        .role-btn{flex:1;padding:var(--sp12);background:var(--surf2);border:2px solid transparent;border-radius:var(--r12);color:var(--txt2);cursor:pointer;text-align:center;transition:.3s;font-size:var(--fs13)}
        .role-btn.active{border-color:var(--pr);background:rgba(0,212,255,0.1);color:var(--pr)}
        .role-btn i{font-size:var(--fs20);margin-bottom:var(--sp4);display:block}
        .inp-grp{margin-bottom:var(--sp12)}
        .inp-grp label{display:block;margin-bottom:var(--sp6);font-size:var(--fs11);color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
        .inp{width:100%;background:var(--surf2);border:1px solid var(--brd);border-radius:var(--r12);padding:var(--sp12) var(--sp14);color:var(--txt);font-size:var(--fs14);outline:none;transition:.3s}
        .inp:focus{border-color:var(--pr);box-shadow:0 0 0 3px rgba(0,212,255,0.1)}
        select.inp option{background:var(--surf);color:var(--txt)}
        .btn{width:100%;background:linear-gradient(135deg,var(--pr),var(--sec));border:none;border-radius:var(--r12);padding:var(--sp12) var(--sp16);color:#fff;font-size:var(--fs14);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:var(--sp8);transition:.3s;margin-bottom:var(--sp8)}
        .btn:hover{opacity:.9;transform:translateY(-1px)}
        .btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
        .btn-sec{background:transparent;border:1px solid var(--brd);color:var(--txt)}
        .btn-ok{background:linear-gradient(135deg,var(--ok),#00aa55)}
        .btn-err{background:linear-gradient(135deg,var(--err),#cc0033)}
        .btn-warn{background:linear-gradient(135deg,var(--warn),#cc8800)}
        .photo-upload{width:90px;height:90px;border-radius:50%;border:2px dashed rgba(0,212,255,0.3);margin:0 auto var(--sp16);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;background:var(--surf2)}
        .photo-upload img{width:100%;height:100%;object-fit:cover;position:absolute}
        .photo-upload i{font-size:24px;color:var(--pr);margin-bottom:4px}
        .photo-upload span{font-size:9px;color:var(--txt2)}
        #photoInput{display:none}
        /* ---- SECTIONS / HEADER ---- */
        .app-header{position:fixed;top:0;left:0;right:0;z-index:1100;padding:max(env(safe-area-inset-top),10px) var(--sp12) var(--sp10);background:linear-gradient(180deg,rgba(0,0,0,0.85) 0%,transparent 100%);pointer-events:none}
        body.light-mode .app-header{background:linear-gradient(180deg,rgba(240,242,245,0.92) 0%,transparent 100%)}
        .app-header-content{display:flex;justify-content:space-between;align-items:center;pointer-events:auto}
        .user-pill{background:rgba(21,21,32,0.95);backdrop-filter:blur(16px);padding:var(--sp8) var(--sp12);border-radius:50px;border:1px solid var(--brd);display:flex;align-items:center;gap:var(--sp8);font-size:var(--fs13);font-weight:600;cursor:pointer;color:var(--txt)}
        body.light-mode .user-pill{background:rgba(255,255,255,0.95)}
        .user-pill img{width:28px;height:28px;border-radius:50%;object-fit:cover}
        .header-right{display:flex;gap:var(--sp8)}
        .hdr-btn{width:38px;height:38px;background:rgba(21,21,32,0.95);backdrop-filter:blur(16px);border:1px solid var(--brd);border-radius:50%;color:var(--txt);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:var(--fs14);transition:.3s}
        body.light-mode .hdr-btn{background:rgba(255,255,255,0.95)}
        .hdr-btn:hover{border-color:var(--pr);color:var(--pr)}
        .hdr-btn.active-btn{border-color:var(--pr);color:var(--pr);background:rgba(0,212,255,0.1)}
        /* nav menu dropdown */
        .nav-menu{position:fixed;top:60px;right:var(--sp12);background:var(--surf);border:1px solid var(--brd2);border-radius:var(--r16);padding:var(--sp8);z-index:2000;min-width:200px;display:none;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
        .nav-menu.open{display:block}
        .nav-menu-item{display:flex;align-items:center;gap:var(--sp10);padding:var(--sp10) var(--sp12);border-radius:var(--r8);cursor:pointer;font-size:var(--fs13);color:var(--txt);transition:.2s}
        .nav-menu-item:hover{background:rgba(0,212,255,0.1);color:var(--pr)}
        .nav-menu-item i{width:18px;text-align:center;color:var(--pr)}
        .nav-divider{height:1px;background:var(--brd);margin:var(--sp4) 0}
        /* ---- MAP CONTROLS ---- */
        .map-ctrls{position:fixed;top:70px;right:var(--sp12);z-index:900;display:flex;flex-direction:column;gap:var(--sp8)}
        .mc-btn{width:38px;height:38px;background:rgba(21,21,32,0.95);border:1px solid var(--brd);border-radius:var(--r8);color:var(--txt);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:var(--fs14);backdrop-filter:blur(10px);transition:.3s}
        body.light-mode .mc-btn{background:rgba(255,255,255,0.95)}
        .mc-btn:hover{border-color:var(--pr);color:var(--pr)}
        .mc-btn.muted{color:var(--err);border-color:var(--err)}
        /* ---- FLOATING STATUS ---- */
        .float-status{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-120px);background:rgba(21,21,32,0.97);backdrop-filter:blur(20px);border:2px solid var(--pr);border-radius:50px;padding:var(--sp12) var(--sp20);z-index:900;display:flex;align-items:center;gap:var(--sp10);font-weight:700;font-size:var(--fs13);box-shadow:0 8px 32px rgba(0,212,255,0.25);opacity:0;transition:all .5s cubic-bezier(.68,-.55,.265,1.55);pointer-events:none;max-width:90%;white-space:nowrap}
        .float-status.on{transform:translateX(-50%) translateY(0);opacity:1}
        .float-status i{font-size:var(--fs16);color:var(--pr);animation:pulse-ico 2s infinite}
        .repeat-btn{pointer-events:auto;background:rgba(0,212,255,0.15);border:1px solid var(--pr);border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:var(--fs12);color:var(--pr)}
        @keyframes pulse-ico{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
        /* ---- ADDRESS SEARCH OVERLAY ---- */
        .addr-overlay{position:fixed;inset:0;background:var(--bg);z-index:3000;display:none;flex-direction:column;padding:var(--sp16);padding-top:max(env(safe-area-inset-top),var(--sp16))}
        .addr-overlay.open{display:flex}
        .addr-overlay-head{display:flex;align-items:center;gap:var(--sp10);margin-bottom:var(--sp16)}
        .addr-overlay-head h3{font-size:var(--fs16);font-weight:700}
        .addr-overlay-head button{background:none;border:none;color:var(--txt);font-size:var(--fs20);cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center}
        .addr-input-wrap{position:relative;margin-bottom:var(--sp10)}
        .addr-input-wrap i{position:absolute;left:var(--sp12);top:50%;transform:translateY(-50%);color:var(--txt2);font-size:var(--fs14)}
        .addr-inp{width:100%;background:var(--surf2);border:1px solid var(--brd);border-radius:var(--r12);padding:var(--sp12) var(--sp12) var(--sp12) 36px;color:var(--txt);font-size:var(--fs14);outline:none;transition:.3s}
        .addr-inp:focus{border-color:var(--pr)}
        .addr-map-btn{width:100%;background:rgba(0,212,255,0.1);border:1px solid var(--brd2);border-radius:var(--r12);padding:var(--sp12);color:var(--pr);font-size:var(--fs14);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:var(--sp8);margin-bottom:var(--sp10)}
        .addr-suggestions{flex:1;overflow-y:auto}
        .sug-item{padding:var(--sp12);border-bottom:1px solid var(--brd);cursor:pointer;display:flex;align-items:center;gap:var(--sp12);transition:.2s}
        .sug-item:hover{background:rgba(0,212,255,0.08)}
        .sug-item i{color:var(--txt3);font-size:var(--fs14);width:20px;text-align:center}
        .sug-main{font-size:var(--fs14);color:var(--txt)}
        .sug-sub{font-size:var(--fs12);color:var(--txt2)}
        /* ---- CLIENT PANEL ---- */
        .client-panel{position:fixed;bottom:0;left:0;right:0;background:rgba(21,21,32,0.98);backdrop-filter:blur(20px);border-radius:var(--r24) var(--r24) 0 0;padding:var(--sp16);z-index:800;display:none;max-height:80vh;overflow-y:auto;transition:transform .3s ease;padding-bottom:max(env(safe-area-inset-bottom),var(--sp16))}
        body.light-mode .client-panel{background:rgba(255,255,255,0.98)}
        .client-panel.active{display:block}
        .client-panel.hidden{transform:translateY(calc(100% - 50px))}
        .panel-handle{width:36px;height:3px;background:var(--brd);border-radius:2px;margin:0 auto var(--sp16);cursor:pointer}
        .loc-row{display:flex;align-items:center;gap:var(--sp8);background:var(--surf2);border-radius:var(--r12);padding:var(--sp4);border:1px solid var(--brd);margin-bottom:var(--sp8);cursor:pointer;transition:.3s}
        .loc-row:hover{border-color:var(--pr)}
        .loc-ico{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:var(--fs16)}
        .loc-ico.pu{color:var(--pr)}
        .loc-ico.de{color:var(--err)}
        .loc-display{flex:1;padding:var(--sp8);font-size:var(--fs13);color:var(--txt);min-height:36px;display:flex;align-items:center}
        .loc-display.empty{color:var(--txt3)}
        .loc-map-btn{width:34px;height:34px;background:rgba(0,212,255,0.08);border:none;border-radius:var(--r8);color:var(--pr);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:var(--fs13)}
        /* price section */
        .price-sec{background:var(--surf2);border-radius:var(--r16);padding:var(--sp16);margin-bottom:var(--sp12);display:none}
        .price-hdr{text-align:center;margin-bottom:var(--sp12)}
        .price-lbl{font-size:var(--fs11);color:var(--txt2);margin-bottom:var(--sp6);text-transform:uppercase;letter-spacing:.5px}
        .price-rec{font-size:var(--fs11);color:var(--txt2);margin-bottom:var(--sp4)}
        .price-val{font-size:var(--fs28);font-weight:800;color:var(--ok)}
        .price-row{display:flex;gap:var(--sp8);margin-bottom:var(--sp12)}
        .price-inp{flex:1;background:var(--surf);border:1px solid var(--brd);border-radius:var(--r12);padding:var(--sp10);color:var(--txt);font-size:var(--fs16);text-align:center;outline:none}
        .price-inp:focus{border-color:var(--pr)}
        /* driver info card */
        .drv-card{background:var(--surf2);border-radius:var(--r16);padding:var(--sp14);margin-bottom:var(--sp12);display:none}
        .drv-card.active{display:block;animation:slideUp .3s}
        @keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
        .drv-profile{display:flex;align-items:center;gap:var(--sp12);margin-bottom:var(--sp12)}
        .drv-photo{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--pr)}
        .drv-name{font-size:var(--fs15);font-weight:700;margin-bottom:var(--sp4)}
        .drv-rating{color:var(--warn);font-size:var(--fs12);display:flex;align-items:center;gap:var(--sp4)}
        .drv-actions{display:flex;gap:var(--sp8)}
        .drv-actions button{flex:1;padding:var(--sp10);border-radius:var(--r8);border:none;cursor:pointer;font-size:var(--fs13);display:flex;align-items:center;justify-content:center;gap:var(--sp6);font-weight:600}
        .btn-msg{background:rgba(0,212,255,0.15);color:var(--pr)}
        .btn-can{background:rgba(255,0,85,0.15);color:var(--err);border:1px solid var(--err)!important}
        /* arrival + rating */
        .arrival-banner{background:linear-gradient(135deg,rgba(0,255,136,0.15),rgba(0,212,255,0.15));border:1px solid var(--ok);border-radius:var(--r16);padding:var(--sp14);text-align:center;margin-bottom:var(--sp12);display:none}
        .arrival-banner.active{display:block}
        .arrival-banner h3{font-size:var(--fs16);color:var(--ok);margin-bottom:var(--sp6)}
        .arrival-banner p{font-size:var(--fs13);color:var(--txt2)}
        .rating-modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:4000;display:none;align-items:center;justify-content:center;padding:var(--sp20)}
        .rating-modal.active{display:flex}
        .rating-content{background:var(--surf);border-radius:var(--r24);padding:var(--sp24);width:100%;max-width:360px;text-align:center}
        .rating-content h3{font-size:var(--fs20);margin-bottom:var(--sp8)}
        .rating-content p{color:var(--txt2);font-size:var(--fs13);margin-bottom:var(--sp16)}
        .stars-row{display:flex;justify-content:center;gap:var(--sp8);margin-bottom:var(--sp16)}
        .star-btn{font-size:var(--fs28);cursor:pointer;color:var(--brd);transition:.2s}
        .star-btn.active{color:var(--warn)}
        /* ---- DRIVER PANEL ---- */
        .driver-panel{position:fixed;bottom:0;left:0;right:0;background:rgba(21,21,32,0.98);backdrop-filter:blur(20px);border-radius:var(--r24) var(--r24) 0 0;padding:var(--sp16);z-index:800;display:none;max-height:85vh;overflow-y:auto;transition:transform .3s ease;padding-bottom:max(env(safe-area-inset-bottom),var(--sp16))}
        body.light-mode .driver-panel{background:rgba(255,255,255,0.98)}
        .driver-panel.active{display:block}
        .driver-panel.hidden{transform:translateY(calc(100% - 50px))}
        .drv-panel-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp14)}
        .drv-panel-hdr h3{font-size:var(--fs16);font-weight:700;margin:0}
        .drv-panel-toggle{width:36px;height:36px;background:var(--surf2);border:none;border-radius:50%;color:var(--txt);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:var(--fs14)}
        .status-toggle{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp14);padding:var(--sp14);background:var(--surf2);border-radius:var(--r14)}
        .status-txt{font-size:var(--fs16);font-weight:700}
        .status-txt.online{color:var(--ok)}
        .status-txt.offline{color:var(--txt2)}
        .tgl-sw{width:52px;height:28px;background:var(--brd);border-radius:14px;position:relative;cursor:pointer;transition:.3s}
        .tgl-sw.on{background:var(--ok)}
        .tgl-sw::after{content:'';position:absolute;width:24px;height:24px;background:#fff;border-radius:50%;top:2px;left:2px;transition:.3s}
        .tgl-sw.on::after{left:26px}
        .drv-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp8);margin-bottom:var(--sp14)}
        .stat-c{background:var(--surf2);border-radius:var(--r12);padding:var(--sp12);text-align:center}
        .stat-v{font-size:var(--fs20);font-weight:800;color:var(--pr)}
        .stat-l{font-size:var(--fs10);color:var(--txt2);text-transform:uppercase;margin-top:var(--sp4)}
        .earn-sec{background:var(--surf2);border-radius:var(--r16);padding:var(--sp14);margin-bottom:var(--sp14)}
        .earn-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp10);font-size:var(--fs14);font-weight:700}
        .earn-amt{font-size:var(--fs24);font-weight:800;color:var(--ok);text-align:center;margin-bottom:var(--sp10)}
        .earn-period{display:flex;gap:var(--sp6)}
        .period-b{flex:1;padding:var(--sp8);background:var(--surf);border:1px solid var(--brd);border-radius:var(--r8);color:var(--txt);font-size:var(--fs12);cursor:pointer;transition:.3s;text-align:center}
        .period-b.active{background:var(--pr);color:#000;border-color:var(--pr)}
        /* trip card */
        .trip-card{background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(123,44,191,0.08));border:2px solid var(--pr);border-radius:var(--r16);padding:var(--sp14);margin-bottom:var(--sp14);display:none}
        .trip-card.active{display:block}
        .trip-status{text-align:center;font-size:var(--fs14);font-weight:700;color:var(--pr);margin-bottom:var(--sp12);padding:var(--sp8);background:rgba(0,212,255,0.1);border-radius:var(--r8);text-transform:uppercase}
        .cli-info{display:flex;align-items:center;gap:var(--sp12);margin-bottom:var(--sp12)}
        .cli-photo{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--pr)}
        .cli-name{font-size:var(--fs15);font-weight:700}
        .cli-dist{font-size:var(--fs12);color:var(--txt2);margin-top:var(--sp4)}
        .trip-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp8);margin-bottom:var(--sp12)}
        .trip-item{background:rgba(255,255,255,0.04);padding:var(--sp10);border-radius:var(--r8);text-align:center}
        .trip-lbl{font-size:var(--fs10);color:var(--txt2);text-transform:uppercase;margin-bottom:var(--sp4)}
        .trip-val{font-size:var(--fs15);font-weight:700;color:var(--ok)}
        .route-line{display:flex;flex-direction:column;gap:var(--sp10);margin-bottom:var(--sp12)}
        .rt-pt{display:flex;align-items:center;gap:var(--sp10);font-size:var(--fs13)}
        .rt-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
        .rt-dot.pu{background:var(--pr);box-shadow:0 0 8px var(--pr)}
        .rt-dot.de{background:var(--err);box-shadow:0 0 8px var(--err)}
        .trip-btns{display:flex;gap:var(--sp8);flex-wrap:wrap}
        .trip-btns .btn{flex:1;min-width:100px;margin:0;padding:var(--sp10)}
        /* request card */
        .req-card{background:var(--surf2);border-radius:var(--r16);padding:var(--sp14);margin-bottom:var(--sp10);border:1px solid var(--brd);transition:.3s}
        .req-card:hover{border-color:var(--pr)}
        .req-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp10)}
        .req-price{font-size:var(--fs20);font-weight:800;color:var(--ok)}
        .req-actions{display:flex;gap:var(--sp8);margin-top:var(--sp10)}
        .req-actions .btn{flex:1;margin:0;padding:var(--sp10)}
        /* ---- NOTIF OFFERS MODAL ---- */
        .offers-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.93);z-index:2500;display:none;overflow-y:auto;padding:var(--sp16);padding-top:max(env(safe-area-inset-top),var(--sp16))}
        .offers-modal.active{display:block}
        .offers-hdr{text-align:center;margin-bottom:var(--sp20);padding-top:var(--sp20)}
        .offers-hdr h2{font-size:var(--fs22);margin-bottom:var(--sp6)}
        .offers-hdr p{color:var(--txt2);font-size:var(--fs13)}
        .offer-card{background:var(--surf);border-radius:var(--r16);padding:var(--sp16);margin-bottom:var(--sp12);border:2px solid transparent;transition:.3s;position:relative;overflow:hidden}
        .offer-card:hover{border-color:var(--pr)}
        .offer-timer-bar{position:absolute;top:0;left:0;height:3px;background:var(--ok);transition:width 1s linear}
        .offer-drv-hdr{display:flex;align-items:center;gap:var(--sp12);margin-bottom:var(--sp12)}
        .offer-drv-photo{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--pr)}
        .offer-drv-name{font-size:var(--fs16);font-weight:700}
        .offer-drv-rating{color:var(--warn);font-size:var(--fs12)}
        .offer-price{font-size:var(--fs28);font-weight:800;color:var(--ok);text-align:center;margin:var(--sp12) 0}
        .offer-acts{display:flex;gap:var(--sp10)}
        .offer-acts .btn{flex:1;margin:0}
        /* ---- CHAT ---- */
        .modal-ov{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:3500;display:none;align-items:flex-end}
        .modal-ov.active{display:flex}
        .chat-wrap{width:100%;height:78vh;background:var(--surf);border-radius:var(--r24) var(--r24) 0 0;display:flex;flex-direction:column;padding-bottom:max(env(safe-area-inset-bottom),0px)}
        .chat-hdr{padding:var(--sp16);border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:var(--sp10)}
        .chat-hdr img{width:36px;height:36px;border-radius:50%;object-fit:cover}
        .chat-hdr-name{font-size:var(--fs15);font-weight:700}
        .chat-hdr-status{font-size:var(--fs11);color:var(--ok)}
        .chat-hdr-close{margin-left:auto;background:none;border:none;color:var(--txt);font-size:var(--fs20);cursor:pointer}
        .chat-msgs{flex:1;overflow-y:auto;padding:var(--sp16);display:flex;flex-direction:column;gap:var(--sp10)}
        .msg{max-width:78%;padding:var(--sp10) var(--sp14);border-radius:var(--r16);font-size:var(--fs13);line-height:1.4}
        .msg.sent{align-self:flex-end;background:var(--pr);color:#000;border-bottom-right-radius:4px}
        .msg.recv{align-self:flex-start;background:var(--surf2);border-bottom-left-radius:4px}
        .chat-footer{padding:var(--sp12);border-top:1px solid var(--brd);display:flex;gap:var(--sp8)}
        .chat-footer input{flex:1;background:var(--surf2);border:1px solid var(--brd);border-radius:50px;padding:var(--sp10) var(--sp16);color:var(--txt);outline:none;font-size:var(--fs14)}
        .chat-footer button{width:40px;height:40px;border-radius:50%;background:var(--pr);border:none;color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center}
        /* ---- CANCEL MODAL ---- */
        .cancel-modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:4000;display:none;align-items:center;justify-content:center;padding:var(--sp20)}
        .cancel-modal.active{display:flex}
        .cancel-cont{background:var(--surf);border-radius:var(--r24);padding:var(--sp24);width:100%;max-width:380px;text-align:center}
        .cancel-cont h3{margin-bottom:var(--sp8);color:var(--err);font-size:var(--fs18)}
        .cancel-cont>p{color:var(--txt2);font-size:var(--fs13);margin-bottom:var(--sp16)}
        .cancel-reasons{display:flex;flex-direction:column;gap:var(--sp8);margin-bottom:var(--sp16)}
        .cancel-rsn-btn{background:var(--surf2);border:1px solid var(--brd);border-radius:var(--r12);padding:var(--sp12);color:var(--txt);cursor:pointer;text-align:left;transition:.3s;font-size:var(--fs13)}
        .cancel-rsn-btn:hover{background:rgba(255,0,85,0.1);border-color:var(--err)}
        /* ---- PROFILE MODAL ---- */
        .profile-modal{position:fixed;inset:0;background:var(--bg);z-index:3000;display:none;overflow-y:auto;padding:max(env(safe-area-inset-top),var(--sp16)) var(--sp16) var(--sp20)}
        .profile-modal.active{display:block}
        .profile-content{max-width:480px;margin:0 auto}
        .profile-hdr{text-align:center;margin-bottom:var(--sp24);padding-top:var(--sp16)}
        .profile-photo-lg{width:100px;height:100px;border-radius:50%;border:3px solid var(--pr);object-fit:cover;margin-bottom:var(--sp12)}
        .profile-name{font-size:var(--fs20);font-weight:700;margin-bottom:var(--sp4)}
        .profile-email{color:var(--txt2);font-size:var(--fs13)}
        .profile-section{background:var(--surf);border-radius:var(--r16);padding:var(--sp16);margin-bottom:var(--sp16);border:1px solid var(--brd)}
        .profile-section h4{font-size:var(--fs15);font-weight:700;margin-bottom:var(--sp12);color:var(--pr)}
        .stats-row{display:flex;gap:var(--sp8);margin-bottom:var(--sp12)}
        .stats-row .stat-c{flex:1}
        .photo-edit-row{position:relative;display:inline-block;margin-bottom:var(--sp12)}
        .edit-photo-btn{position:absolute;bottom:0;right:0;width:30px;height:30px;background:var(--pr);border:none;border-radius:50%;color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:var(--fs12)}
        /* ---- NAV OVERLAY ---- */
        .nav-instr{position:fixed;top:70px;left:var(--sp12);right:var(--sp12);background:rgba(21,21,32,0.97);backdrop-filter:blur(20px);border-radius:var(--r16);padding:var(--sp12);z-index:900;display:none;border:1px solid rgba(0,212,255,0.3)}
        .nav-instr.active{display:block}
        .nav-step{display:flex;align-items:center;gap:var(--sp12)}
        .nav-step-ico{width:44px;height:44px;background:rgba(0,212,255,0.1);border-radius:var(--r10);display:flex;align-items:center;justify-content:center;font-size:var(--fs20);color:var(--pr);flex-shrink:0}
        .nav-step-txt{flex:1}
        .nav-step-main{font-size:var(--fs15);font-weight:700}
        .nav-step-sub{font-size:var(--fs12);color:var(--txt2)}
        .nav-step-dist{text-align:right}
        .nav-dist-val{font-size:var(--fs22);font-weight:800;color:var(--pr)}
        .nav-dist-unit{font-size:var(--fs11);color:var(--txt2)}
        /* ---- SOS ---- */
        .sos-btn{position:fixed;bottom:90px;right:var(--sp12);width:52px;height:52px;background:var(--err);border:none;border-radius:50%;color:#fff;font-size:var(--fs12);font-weight:800;cursor:pointer;z-index:880;display:none;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(255,0,85,.4);animation:sos-p 2s infinite}
        .sos-btn.active{display:flex}
        @keyframes sos-p{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
        /* ---- LOADING / TOAST ---- */
        .loading-scr{position:fixed;inset:0;background:var(--bg);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center}
        .loading-scr.active{display:flex}
        .spin{width:50px;height:50px;border:3px solid rgba(0,212,255,.2);border-top-color:var(--pr);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:var(--sp12)}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(80px);background:rgba(21,21,32,.98);color:var(--txt);padding:var(--sp12) var(--sp20);border-radius:var(--r12);border:1px solid rgba(0,212,255,.25);z-index:10000;display:flex;align-items:center;gap:var(--sp10);font-weight:600;font-size:var(--fs13);box-shadow:0 8px 32px rgba(0,0,0,.5);opacity:0;transition:all .3s;max-width:90%;white-space:nowrap}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        /* ---- NEGOTIATE ALERT ---- */
        .neg-alert{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surf);border:2px solid var(--warn);border-radius:var(--r20);padding:var(--sp20);z-index:5000;display:none;text-align:center;width:90%;max-width:340px;box-shadow:0 12px 48px rgba(0,0,0,.6)}
        .neg-alert.active{display:block;animation:pop .35s cubic-bezier(.68,-.55,.265,1.55)}
        @keyframes pop{from{transform:translate(-50%,-50%) scale(.7);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
        .neg-alert-ico{font-size:40px;margin-bottom:var(--sp10)}
        .neg-alert h3{font-size:var(--fs18);font-weight:700;margin-bottom:var(--sp8);color:var(--warn)}
        .neg-alert p{color:var(--txt2);font-size:var(--fs13);margin-bottom:var(--sp14)}
        .neg-alert .price-big{font-size:var(--fs28);font-weight:800;color:var(--ok);margin-bottom:var(--sp14)}
        .neg-acts{display:flex;gap:var(--sp8)}
        .neg-acts .btn{flex:1;margin:0}
        /* ---- MAP SELECT OVERLAY ---- */
        .map-sel-overlay{position:fixed;inset:0;z-index:2000;display:none;pointer-events:none}
        .map-sel-overlay.active{display:block;pointer-events:auto}
        .map-sel-top{position:absolute;top:0;left:0;right:0;padding:max(env(safe-area-inset-top),var(--sp12)) var(--sp12) var(--sp12);background:linear-gradient(180deg,rgba(0,0,0,.85) 0%,transparent 100%);pointer-events:none}
        .map-sel-banner{background:var(--surf);border:1px solid var(--pr);border-radius:50px;padding:var(--sp8) var(--sp16);display:inline-flex;align-items:center;gap:var(--sp8);font-size:var(--fs13);font-weight:700;color:var(--pr);pointer-events:none}
        .map-sel-cross{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:36px;color:var(--pr);text-shadow:0 0 16px var(--pr);pointer-events:none}
        .map-sel-confirm{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);pointer-events:auto}
        .map-sel-cancel{position:absolute;bottom:40px;right:var(--sp16);pointer-events:auto;background:var(--surf);border:1px solid var(--brd);border-radius:50px;padding:var(--sp10) var(--sp16);color:var(--txt);cursor:pointer;font-size:var(--fs13)}
        /* ---- RESPONSIVE ---- */
        @media(max-width:400px){
            .auth-card{padding:var(--sp16)}
            .drv-stats{grid-template-columns:1fr 1fr}
            .trip-grid{grid-template-columns:1fr}
        }
        /* ---- SCROLLBAR ---- */
        ::-webkit-scrollbar{width:4px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:rgba(0,212,255,.2);border-radius:2px}
        /* light mode adjustments */
        body.light-mode .req-card{background:#f0f2f5;border-color:#e0e0e0}
        body.light-mode .offer-card{background:#f8f9fc}
        body.light-mode .cancel-cont{background:#fff}
        body.light-mode .profile-section{background:#fff}
        body.light-mode .chat-wrap{background:#fff}
        body.light-mode .msg.recv{background:#f0f2f5}
        body.light-mode .nav-instr{background:rgba(255,255,255,.97)}
        body.light-mode .trip-card{background:linear-gradient(135deg,rgba(0,100,200,.05),rgba(100,0,200,.05))}
        body.light-mode .trip-item{background:rgba(0,0,0,.03)}
        body.light-mode .neg-alert{background:#fff}
    </style>
</head>
<body>

<!-- ===== AUTH SCREEN ===== -->
<div id="authScreen" class="screen active">
    <div class="auth-wrap">
        <div class="auth-card">
            <div class="logo-big"><i class="fas fa-taxi"></i></div>
            <h1>RETOM</h1>
            <p>Transporte r√°pido y seguro</p>
            <div class="role-selector">
                <div class="role-btn active" onclick="selectRole('cliente')" id="role-cliente">
                    <i class="fas fa-user"></i><div style="font-size:var(--fs12)">Cliente</div>
                </div>
                <div class="role-btn" onclick="selectRole('conductor')" id="role-conductor">
                    <i class="fas fa-car"></i><div style="font-size:var(--fs12)">Conductor</div>
                </div>
            </div>
            <div id="loginForm">
                <div class="inp-grp"><label>Correo</label><input type="email" class="inp" id="email" placeholder="tu@email.com"></div>
                <div class="inp-grp"><label>Contrase√±a</label><input type="password" class="inp" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button class="btn" onclick="login()"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</button>
                <button class="btn btn-sec" onclick="showRegister()"><i class="fas fa-user-plus"></i> Crear cuenta</button>
            </div>
            <div id="registerForm" style="display:none">
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <img id="previewPhoto" style="display:none">
                    <i class="fas fa-camera" id="cameraIcon"></i>
                    <span>Foto</span>
                    <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoSelect(event)">
                </div>
                <div class="inp-grp"><label>Nombre completo</label><input type="text" class="inp" id="regName" placeholder="Juan P√©rez"></div>
                <div class="inp-grp"><label>Correo</label><input type="email" class="inp" id="regEmail" placeholder="tu@email.com"></div>
                <div class="inp-grp"><label>Tel√©fono</label><input type="tel" class="inp" id="regPhone" placeholder="8095551234"></div>
                <div class="inp-grp"><label>C√©dula / ID</label><input type="text" class="inp" id="regCedula" placeholder="000-0000000-0"></div>
                <div class="inp-grp"><label>Fecha de nacimiento</label><input type="date" class="inp" id="regBirth"></div>
                <div id="conductorRegFields" style="display:none">
                    <div class="inp-grp"><label>Placa del veh√≠culo</label><input type="text" class="inp" id="regPlate" placeholder="A123456"></div>
                    <div class="inp-grp"><label>Modelo del veh√≠culo</label><input type="text" class="inp" id="regModel" placeholder="Toyota Corolla 2020"></div>
                    <div class="inp-grp"><label>Color del veh√≠culo</label><input type="text" class="inp" id="regColor" placeholder="Blanco"></div>
                    <div class="inp-grp"><label>Licencia de conducir</label><input type="text" class="inp" id="regLicense" placeholder="N√∫m. licencia"></div>
                    <div class="inp-grp"><label>Tipo de veh√≠culo</label>
                        <select class="inp" id="regVehicleType">
                            <option value="sedan">Sed√°n</option>
                            <option value="suv">SUV</option>
                            <option value="pickup">Pickup</option>
                            <option value="moto">Moto</option>
                        </select>
                    </div>
                </div>
                <div class="inp-grp"><label>Contrase√±a</label><input type="password" class="inp" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button class="btn" onclick="register()"><i class="fas fa-user-plus"></i> Registrarse</button>
                <button class="btn btn-sec" onclick="showLogin()"><i class="fas fa-arrow-left"></i> Volver</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== MAIN MAP SCREEN ===== -->
<div id="mainScreen" class="screen">
    <div id="map"></div>

    <!-- App Header -->
    <div class="app-header">
        <div class="app-header-content">
            <div class="user-pill" onclick="openProfile()">
                <img id="headerPhoto" src="" style="display:none">
                <i class="fas fa-user-circle" id="headerIcon" style="font-size:18px"></i>
                <span id="userName" style="font-size:var(--fs13)">Usuario</span>
            </div>
            <div class="header-right">
                <button class="hdr-btn" id="darkModeBtn" onclick="toggleDarkMode()" title="Modo claro/oscuro"><i class="fas fa-moon"></i></button>
                <button class="hdr-btn" id="menuBtn" onclick="toggleMenu()" title="Men√∫"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </div>

    <!-- Nav Menu -->
    <div class="nav-menu" id="navMenu">
        <div class="nav-menu-item" onclick="openProfile();closeMenu()"><i class="fas fa-user-edit"></i> Mi Perfil</div>
        <div class="nav-menu-item" onclick="openTripHistory();closeMenu()"><i class="fas fa-history"></i> Historial de Viajes</div>
        <div class="nav-menu-item" onclick="openPaymentMethods();closeMenu()"><i class="fas fa-credit-card"></i> M√©todos de Pago</div>
        <div class="nav-menu-item" onclick="openSupport();closeMenu()"><i class="fas fa-headset"></i> Soporte</div>
        <div class="nav-menu-item" onclick="openSettings();closeMenu()"><i class="fas fa-cog"></i> Configuraci√≥n</div>
        <div class="nav-divider"></div>
        <div class="nav-menu-item" onclick="logout();closeMenu()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</div>
    </div>

    <!-- Floating Status -->
    <div class="float-status" id="floatStatus">
        <i class="fas fa-route"></i>
        <span id="floatStatusTxt">En camino al destino</span>
        <button class="repeat-btn" onclick="repeatLastInstruction()" title="Repetir instrucci√≥n"><i class="fas fa-redo"></i></button>
    </div>

    <!-- Map Controls -->
    <div class="map-ctrls">
        <button class="mc-btn" onclick="toggleMapType()" title="Vista mapa"><i class="fas fa-layer-group"></i></button>
        <button class="mc-btn" onclick="centerOnUser()" title="Mi ubicaci√≥n"><i class="fas fa-crosshairs"></i></button>
        <button class="mc-btn" id="audioBtn" onclick="toggleAudio()" title="Audio"><i class="fas fa-volume-up"></i></button>
    </div>

    <!-- SOS -->
    <button class="sos-btn" id="sosBtn" onclick="triggerSOS()">SOS</button>

    <!-- Nav Instructions Overlay -->
    <div class="nav-instr" id="navInstr">
        <div class="nav-step">
            <div class="nav-step-ico"><i class="fas fa-arrow-up" id="navIco"></i></div>
            <div class="nav-step-txt">
                <div class="nav-step-main" id="navMain">Contin√∫a recto</div>
                <div class="nav-step-sub" id="navSub">Pr√≥xima instrucci√≥n</div>
            </div>
            <div class="nav-step-dist">
                <div class="nav-dist-val" id="navDist">200</div>
                <div class="nav-dist-unit">m</div>
            </div>
        </div>
    </div>

    <!-- ===== CLIENT PANEL ===== -->
    <div class="client-panel" id="clientPanel">
        <div class="panel-handle" onclick="toggleClientPanel()"></div>
        <!-- Location inputs (tap to open overlay) -->
        <div class="loc-row" onclick="openAddrOverlay('pickup')" id="pickupRow">
            <div class="loc-ico pu"><i class="fas fa-dot-circle"></i></div>
            <div class="loc-display empty" id="pickupDisplay">¬øD√≥nde te recogemos?</div>
            <button class="loc-map-btn" onclick="event.stopPropagation();openMapSelector('pickup')" title="Seleccionar en mapa"><i class="fas fa-map-marker-alt"></i></button>
        </div>
        <div class="loc-row" onclick="openAddrOverlay('dest')" id="destRow">
            <div class="loc-ico de"><i class="fas fa-map-marker-alt"></i></div>
            <div class="loc-display empty" id="destDisplay">¬øA d√≥nde vas?</div>
            <button class="loc-map-btn" onclick="event.stopPropagation();openMapSelector('dest')" title="Seleccionar en mapa"><i class="fas fa-map"></i></button>
        </div>
        <!-- Price Section -->
        <div class="price-sec" id="priceSection">
            <div class="price-hdr">
                <div class="price-lbl">Tu oferta</div>
                <div class="price-rec" id="priceRec">Precio recomendado: RD$ 150</div>
                <div class="price-val" id="currentPrice">RD$ 150</div>
            </div>
            <div class="price-row">
                <input type="number" class="price-inp" id="clientOffer" placeholder="Precio manual" value="150" oninput="onOfferInput()">
            </div>
            <div style="font-size:var(--fs11);color:var(--txt2);text-align:center;margin-bottom:var(--sp8)">
                Ingresa tu precio o usa el recomendado
            </div>
        </div>
        <button class="btn" id="findDriverBtn" onclick="findDriver()" style="display:none;background:linear-gradient(135deg,var(--ok),#00aa55)">
            <i class="fas fa-search"></i> Buscar Conductor
        </button>
        <!-- Driver Info Card -->
        <div class="drv-card" id="driverInfoCard">
            <div class="drv-profile">
                <img id="driverPhoto" class="drv-photo" src="">
                <div>
                    <div class="drv-name" id="driverName">Conductor</div>
                    <div class="drv-rating"><i class="fas fa-star"></i><span id="driverRating">4.8</span><span style="color:var(--txt2);margin-left:6px;font-size:var(--fs11)" id="driverTrips">0 viajes</span></div>
                    <div style="font-size:var(--fs11);color:var(--txt2);margin-top:4px" id="driverVehicle"></div>
                    <div style="font-size:var(--fs11);color:var(--txt2)" id="driverETA"></div>
                </div>
            </div>
            <div class="drv-actions">
                <button class="btn-msg" onclick="openChat()"><i class="fas fa-comment"></i> Mensaje</button>
                <button class="btn-can" onclick="showCancelModal()"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
        <!-- Arrival Banner -->
        <div class="arrival-banner" id="arrivalBanner">
            <h3><i class="fas fa-check-circle"></i> ¬°El conductor lleg√≥!</h3>
            <p>Tu conductor est√° esper√°ndote</p>
        </div>
    </div>

    <!-- ===== DRIVER PANEL ===== -->
    <div class="driver-panel" id="driverPanel">
        <div class="panel-handle" onclick="toggleDriverPanel()"></div>
        <div class="drv-panel-hdr">
            <h3>Panel Conductor</h3>
            <button class="drv-panel-toggle" onclick="toggleDriverPanel()"><i class="fas fa-chevron-down" id="drvPanelIco"></i></button>
        </div>
        <div class="drv-stats">
            <div class="stat-c"><div class="stat-v" id="statRating">5.0</div><div class="stat-l">Calificaci√≥n</div></div>
            <div class="stat-c"><div class="stat-v" id="statTrips">0</div><div class="stat-l">Viajes</div></div>
            <div class="stat-c"><div class="stat-v" id="statEarnings">RD$0</div><div class="stat-l">Ganancias</div></div>
        </div>
        <div class="earn-sec">
            <div class="earn-hdr"><span>Ganancias</span><i class="fas fa-wallet" style="color:var(--ok)"></i></div>
            <div class="earn-amt" id="earnAmt">RD$ 0</div>
            <div class="earn-period">
                <button class="period-b active" onclick="setEarnPeriod('day',this)">Hoy</button>
                <button class="period-b" onclick="setEarnPeriod('week',this)">Semana</button>
                <button class="period-b" onclick="setEarnPeriod('month',this)">Mes</button>
            </div>
        </div>
        <div class="status-toggle">
            <div class="status-txt offline" id="statusTxt">Desconectado</div>
            <div class="tgl-sw" id="tglSw" onclick="toggleStatus()"></div>
        </div>
        <!-- Current Trip Card -->
        <div class="trip-card" id="tripCard">
            <div class="trip-status" id="tripStatusTxt">En camino al cliente</div>
            <div class="cli-info">
                <img id="clientPhoto" class="cli-photo" src="">
                <div>
                    <div class="cli-name" id="clientName">Cliente</div>
                    <div class="cli-dist" id="clientDist"><i class="fas fa-map-marker-alt" style="color:var(--pr)"></i> Calculando...</div>
                    <div style="font-size:var(--fs11);color:var(--warn);margin-top:4px" id="clientRatingShow"></div>
                </div>
            </div>
            <div class="trip-grid">
                <div class="trip-item"><div class="trip-lbl">Distancia</div><div class="trip-val" id="tripDist">-- km</div></div>
                <div class="trip-item"><div class="trip-lbl">Ganancia</div><div class="trip-val" id="tripEarn">RD$ --</div></div>
                <div class="trip-item"><div class="trip-lbl">Tiempo Est.</div><div class="trip-val" id="tripTime">-- min</div></div>
                <div class="trip-item"><div class="trip-lbl">Pago</div><div class="trip-val" style="font-size:var(--fs12)">Efectivo</div></div>
            </div>
            <div class="route-line">
                <div class="rt-pt"><div class="rt-dot pu"></div><span id="tripOrigen" style="font-size:var(--fs13)">Origen</span></div>
                <div class="rt-pt"><div class="rt-dot de"></div><span id="tripDest" style="font-size:var(--fs13)">Destino</span></div>
            </div>
            <div class="trip-btns">
                <button class="btn btn-ok" id="btnLlegue" onclick="driverArrived()" style="display:none"><i class="fas fa-check-circle"></i> Llegu√©</button>
                <button class="btn btn-ok" id="btnIniciar" onclick="startTrip()" style="display:none"><i class="fas fa-play"></i> Iniciar</button>
                <button class="btn btn-ok" id="btnFinalizar" onclick="endTrip()" style="display:none"><i class="fas fa-flag-checkered"></i> Finalizar</button>
                <button class="btn-msg" style="border-radius:var(--r8);padding:var(--sp10);cursor:pointer;border:none" onclick="openChat()"><i class="fas fa-comment"></i></button>
                <button class="btn-can" style="border-radius:var(--r8);padding:var(--sp10);cursor:pointer;border:1px solid var(--err)" onclick="showCancelModal()"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="requestsList">
            <div style="text-align:center;padding:30px;color:var(--txt2)">
                <i class="fas fa-wifi" style="font-size:36px;display:block;margin-bottom:10px"></i>
                Activa disponibilidad para recibir solicitudes
            </div>
        </div>
    </div>
</div>

<!-- ===== ADDRESS OVERLAY ===== -->
<div class="addr-overlay" id="addrOverlay">
    <div class="addr-overlay-head">
        <button onclick="closeAddrOverlay()"><i class="fas fa-arrow-left"></i></button>
        <h3 id="addrOverlayTitle">¬øD√≥nde te recogemos?</h3>
    </div>
    <div class="addr-input-wrap">
        <i class="fas fa-search"></i>
        <input type="text" class="addr-inp" id="addrInput" placeholder="Buscar direcci√≥n..." oninput="onAddrSearch(this.value)" autocomplete="off">
    </div>
    <button class="addr-map-btn" onclick="openMapSelectorFromOverlay()">
        <i class="fas fa-map-marker-alt"></i> Seleccionar desde el mapa
    </button>
    <div class="addr-suggestions" id="addrSuggestions"></div>
</div>

<!-- ===== MAP SELECTOR OVERLAY ===== -->
<div class="map-sel-overlay" id="mapSelOverlay">
    <div class="map-sel-top">
        <div class="map-sel-banner"><i class="fas fa-crosshairs"></i> <span id="mapSelTitle">Mueve el mapa y confirma</span></div>
    </div>
    <div class="map-sel-cross">+</div>
    <button class="btn map-sel-confirm" onclick="confirmMapSelection()" style="width:auto;padding:var(--sp12) var(--sp24)">
        <i class="fas fa-check"></i> Confirmar
    </button>
    <button class="map-sel-cancel" onclick="cancelMapSelector()"><i class="fas fa-times"></i> Cancelar</button>
</div>

<!-- ===== DRIVER OFFERS MODAL ===== -->
<div class="offers-modal" id="offersModal">
    <div class="offers-hdr">
        <h2>Conductores disponibles</h2>
        <p>Elige la mejor oferta</p>
    </div>
    <div id="offersList"></div>
    <button class="btn btn-sec" onclick="closeOffers()" style="margin-top:var(--sp16)"><i class="fas fa-times"></i> Cancelar b√∫squeda</button>
</div>

<!-- ===== NEGOTIATE ALERT ===== -->
<div class="neg-alert" id="negAlert">
    <div class="neg-alert-ico">üí∞</div>
    <h3>Oferta del conductor</h3>
    <p id="negDriverName">El conductor te propone:</p>
    <div class="price-big" id="negPrice">RD$ 0</div>
    <div class="neg-acts">
        <button class="btn btn-ok" onclick="acceptNegotiation()"><i class="fas fa-check"></i> Aceptar</button>
        <button class="btn btn-err" onclick="rejectNegotiation()"><i class="fas fa-times"></i> Rechazar</button>
    </div>
</div>

<!-- ===== CHAT MODAL ===== -->
<div class="modal-ov" id="chatModal" onclick="closeChatIfBg(event)">
    <div class="chat-wrap" onclick="event.stopPropagation()">
        <div class="chat-hdr">
            <img id="chatPhoto" src="">
            <div><div class="chat-hdr-name" id="chatName">Conductor</div><div class="chat-hdr-status"><i class="fas fa-circle" style="font-size:8px"></i> En l√≠nea</div></div>
            <button class="chat-hdr-close" onclick="closeChat()"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-msgs" id="chatMsgs"></div>
        <div class="chat-footer">
            <input type="text" id="msgInput" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter')sendMessage()">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<!-- ===== CANCEL MODAL ===== -->
<div class="cancel-modal" id="cancelModal">
    <div class="cancel-cont">
        <h3><i class="fas fa-exclamation-triangle"></i> Cancelar Viaje</h3>
        <p>¬øPor qu√© deseas cancelar?</p>
        <div class="cancel-reasons">
            <button class="cancel-rsn-btn" onclick="cancelTrip('Tiempo de espera')"><i class="fas fa-clock"></i> Tiempo de espera excesivo</button>
            <button class="cancel-rsn-btn" onclick="cancelTrip('Cambio de planes')"><i class="fas fa-calendar-times"></i> Cambio de planes</button>
            <button class="cancel-rsn-btn" onclick="cancelTrip('Conductor no llega')"><i class="fas fa-car-crash"></i> Conductor no llega</button>
            <button class="cancel-rsn-btn" onclick="cancelTrip('Otro')"><i class="fas fa-question-circle"></i> Otro motivo</button>
        </div>
        <button class="btn btn-sec" onclick="closeCancelModal()">Volver</button>
    </div>
</div>

<!-- ===== RATING MODAL ===== -->
<div class="rating-modal" id="ratingModal">
    <div class="rating-content">
        <h3 id="ratingTitle">Califica el viaje</h3>
        <p id="ratingSubtitle">¬øC√≥mo fue tu experiencia?</p>
        <div class="stars-row" id="starsRow">
            <span class="star-btn" onclick="selectStar(1)" data-star="1">‚òÖ</span>
            <span class="star-btn" onclick="selectStar(2)" data-star="2">‚òÖ</span>
            <span class="star-btn" onclick="selectStar(3)" data-star="3">‚òÖ</span>
            <span class="star-btn" onclick="selectStar(4)" data-star="4">‚òÖ</span>
            <span class="star-btn" onclick="selectStar(5)" data-star="5">‚òÖ</span>
        </div>
        <div class="inp-grp" style="margin-bottom:var(--sp16)">
            <textarea class="inp" id="ratingComment" placeholder="Comentario (opcional)" rows="3" style="resize:none"></textarea>
        </div>
        <button class="btn" onclick="submitRating()"><i class="fas fa-star"></i> Enviar calificaci√≥n</button>
        <button class="btn btn-sec" onclick="skipRating()">Omitir</button>
    </div>
</div>

<!-- ===== PROFILE MODAL ===== -->
<div class="profile-modal" id="profileModal">
    <div class="profile-content">
        <div style="display:flex;justify-content:flex-end;margin-bottom:var(--sp8)">
            <button onclick="closeProfile()" style="background:none;border:none;color:var(--txt);font-size:var(--fs22);cursor:pointer"><i class="fas fa-times"></i></button>
        </div>
        <div class="profile-hdr">
            <div class="photo-edit-row">
                <img id="profilePhotoLg" class="profile-photo-lg" src="">
                <button class="edit-photo-btn" onclick="document.getElementById('editPhotoInp').click()"><i class="fas fa-camera"></i></button>
                <input type="file" id="editPhotoInp" style="display:none" accept="image/*" onchange="updateProfilePhoto(event)">
            </div>
            <div class="profile-name" id="profileName">Nombre</div>
            <div class="profile-email" id="profileEmail">email</div>
        </div>
        <!-- Stats -->
        <div class="profile-section">
            <h4><i class="fas fa-chart-bar"></i> Estad√≠sticas</h4>
            <div class="stats-row">
                <div class="stat-c"><div class="stat-v" id="pStatRating">5.0</div><div class="stat-l">Rating</div></div>
                <div class="stat-c"><div class="stat-v" id="pStatTrips">0</div><div class="stat-l">Viajes</div></div>
                <div class="stat-c"><div class="stat-v" id="pStatEarn">RD$0</div><div class="stat-l">Ganado</div></div>
            </div>
        </div>
        <!-- Personal info -->
        <div class="profile-section">
            <h4><i class="fas fa-user"></i> Informaci√≥n Personal</h4>
            <div class="inp-grp"><label>Nombre</label><input type="text" class="inp" id="editName"></div>
            <div class="inp-grp"><label>Tel√©fono</label><input type="tel" class="inp" id="editPhone"></div>
            <div class="inp-grp"><label>C√©dula / ID</label><input type="text" class="inp" id="editCedula"></div>
            <div class="inp-grp"><label>Fecha de nacimiento</label><input type="date" class="inp" id="editBirth"></div>
            <div class="inp-grp"><label>Direcci√≥n</label><input type="text" class="inp" id="editAddress" placeholder="Tu direcci√≥n"></div>
        </div>
        <!-- Driver fields -->
        <div class="profile-section" id="drvEditSection" style="display:none">
            <h4><i class="fas fa-car"></i> Informaci√≥n del Veh√≠culo</h4>
            <div class="inp-grp"><label>Placa</label><input type="text" class="inp" id="editPlate"></div>
            <div class="inp-grp"><label>Modelo</label><input type="text" class="inp" id="editModel"></div>
            <div class="inp-grp"><label>Color</label><input type="text" class="inp" id="editColor"></div>
            <div class="inp-grp"><label>Tipo</label>
                <select class="inp" id="editVehicleType">
                    <option value="sedan">Sed√°n</option><option value="suv">SUV</option>
                    <option value="pickup">Pickup</option><option value="moto">Moto</option>
                </select>
            </div>
            <div class="inp-grp"><label>Licencia</label><input type="text" class="inp" id="editLicense"></div>
        </div>
        <!-- Preferences -->
        <div class="profile-section">
            <h4><i class="fas fa-cog"></i> Preferencias</h4>
            <div class="inp-grp"><label>Idioma</label>
                <select class="inp" id="editLang"><option value="es">Espa√±ol</option><option value="en">English</option></select>
            </div>
        </div>
        <button class="btn" onclick="saveProfile()"><i class="fas fa-save"></i> Guardar Cambios</button>
        <button class="btn btn-err" onclick="confirmDeleteAccount()" style="margin-top:var(--sp8)"><i class="fas fa-trash"></i> Eliminar cuenta</button>
    </div>
</div>

<!-- Loading -->
<div class="loading-scr" id="loadingScr"><div class="spin"></div><div style="color:var(--txt2);font-size:var(--fs13)">Cargando...</div></div>
<!-- Toast -->
<div class="toast" id="toastEl"></div>

<!-- ===== SCRIPTS ===== -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSHIYTEhTeXUNC4g5f_mBJ52CiP4H57XY&libraries=places,geometry&callback=onMapScriptLoad" async></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, addDoc, serverTimestamp, deleteDoc, getDocs, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

const fbCfg = {
    apiKey:"AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
    authDomain:"formulario-2-8929a.firebaseapp.com",
    projectId:"formulario-2-8929a",
    storageBucket:"formulario-2-8929a.appspot.com",
    messagingSenderId:"136908102526",
    appId:"1:136908102526:web:d0a3bc1e3cb91a3fcab12f"
};
const fbApp = initializeApp(fbCfg);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);
const storage = getStorage(fbApp);

// ---- State ----
let map=null, dirSvc=null, dirRender=null;
let userRole='cliente', currentUser=null, userData=null;
let currentTrip=null, selectedPhoto=null;
let audioEnabled=true, darkMode=true, mapTypeIdx=0;
let chatUnsub=null, tripUnsub=null, offersUnsub=null, reqsUnsub=null;
let offerTimers={};
let clientPanelHidden=false, driverPanelHidden=false;
let earnPeriod='day';
let isOnline=false, isNavigating=false;
let steps=[], stepIdx=0;
let watchId=null;
let mapClickMode=null;
let lastInstruction='';
let currentRating=0;
let ratingTargetId=null, ratingTripId=null, ratingTargetRole=null;
let currentNegOffer=null;
let addrType=null; // 'pickup' or 'dest'
let mapSelectorType=null;
let autocompleteService=null, geocoder=null;
let addrSearchTimer=null;

const mkrs={user:null,pickup:null,dest:null,driver:null};
const locs={pickup:null,dest:null,cur:null};

// ---- Make global ----
window.selectRole=selectRole; window.showRegister=showRegister; window.showLogin=showLogin;
window.handlePhotoSelect=handlePhotoSelect; window.login=login; window.register=register; window.logout=logout;
window.toggleClientPanel=toggleClientPanel; window.toggleDriverPanel=toggleDriverPanel;
window.toggleMenu=toggleMenu; window.closeMenu=closeMenu;
window.toggleDarkMode=toggleDarkMode; window.toggleMapType=toggleMapType; window.centerOnUser=centerOnUser; window.toggleAudio=toggleAudio;
window.openAddrOverlay=openAddrOverlay; window.closeAddrOverlay=closeAddrOverlay;
window.openMapSelector=openMapSelector; window.openMapSelectorFromOverlay=openMapSelectorFromOverlay;
window.confirmMapSelection=confirmMapSelection; window.cancelMapSelector=cancelMapSelector;
window.onAddrSearch=onAddrSearch; window.findDriver=findDriver; window.closeOffers=closeOffers;
window.acceptOffer=acceptOffer; window.rejectOffer=rejectOffer;
window.acceptNegotiation=acceptNegotiation; window.rejectNegotiation=rejectNegotiation;
window.openChat=openChat; window.closeChat=closeChat; window.closeChatIfBg=closeChatIfBg; window.sendMessage=sendMessage;
window.showCancelModal=showCancelModal; window.closeCancelModal=closeCancelModal; window.cancelTrip=cancelTrip;
window.makeOffer=makeOffer; window.driverArrived=driverArrived; window.startTrip=startTrip; window.endTrip=endTrip;
window.toggleStatus=toggleStatus; window.setEarnPeriod=setEarnPeriod;
window.openProfile=openProfile; window.closeProfile=closeProfile; window.saveProfile=saveProfile; window.updateProfilePhoto=updateProfilePhoto;
window.triggerSOS=triggerSOS; window.repeatLastInstruction=repeatLastInstruction;
window.selectStar=selectStar; window.submitRating=submitRating; window.skipRating=skipRating;
window.onOfferInput=onOfferInput;
window.openTripHistory=openTripHistory; window.openPaymentMethods=openPaymentMethods;
window.openSupport=openSupport; window.openSettings=openSettings;
window.confirmDeleteAccount=confirmDeleteAccount;

// ---- AUTH ----
function selectRole(r){
    userRole=r;
    document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('role-'+r).classList.add('active');
    document.getElementById('conductorRegFields').style.display=r==='conductor'?'block':'none';
}

function showRegister(){
    document.getElementById('loginForm').style.display='none';
    document.getElementById('registerForm').style.display='block';
}
function showLogin(){
    document.getElementById('registerForm').style.display='none';
    document.getElementById('loginForm').style.display='block';
}

function handlePhotoSelect(e){
    const f=e.target.files[0]; if(!f)return;
    selectedPhoto=f;
    const r=new FileReader();
    r.onload=ev=>{
        document.getElementById('previewPhoto').src=ev.target.result;
        document.getElementById('previewPhoto').style.display='block';
        document.getElementById('cameraIcon').style.display='none';
    };
    r.readAsDataURL(f);
}

async function login(){
    const email=document.getElementById('email').value.trim();
    const pw=document.getElementById('password').value;
    if(!email||!pw){showToast('Completa los campos','err');return;}
    showLoad(true);
    try{
        const uc=await signInWithEmailAndPassword(auth,email,pw);
        currentUser=uc.user;
    }catch(e){
        showToast(e.code==='auth/user-not-found'?'Usuario no encontrado':e.code==='auth/wrong-password'||e.code==='auth/invalid-credential'?'Contrase√±a incorrecta':'Error al iniciar sesi√≥n','err');
        showLoad(false);
    }
}

async function register(){
    const name=document.getElementById('regName').value.trim();
    const email=document.getElementById('regEmail').value.trim();
    const phone=document.getElementById('regPhone').value.trim();
    const pw=document.getElementById('regPassword').value;
    const cedula=document.getElementById('regCedula').value.trim();
    const birth=document.getElementById('regBirth').value;
    if(!name||!email||!phone||!pw){showToast('Completa los campos requeridos','err');return;}
    if(pw.length<6){showToast('Contrase√±a: m√≠nimo 6 caracteres','err');return;}
    showLoad(true);
    try{
        const uc=await createUserWithEmailAndPassword(auth,email,pw);
        const u=uc.user; currentUser=u;
        let photoURL=null;
        if(selectedPhoto){
            try{
                const sr=ref(storage,`profiles/${u.uid}`);
                await uploadBytes(sr,selectedPhoto);
                photoURL=await getDownloadURL(sr);
                await updateProfile(u,{photoURL});
            }catch(se){console.warn('Photo upload:',se);}
        }
        const ud={uid:u.uid,nombre:name,email,telefono:phone,cedula,fechaNacimiento:birth,rol:userRole,photoURL,calificacion:5.0,viajesCompletados:0,creado:serverTimestamp()};
        await setDoc(doc(db,'usuarios',u.uid),ud);
        if(userRole==='conductor'){
            const plate=document.getElementById('regPlate').value.trim();
            const model=document.getElementById('regModel').value.trim();
            const color=document.getElementById('regColor').value.trim();
            const license=document.getElementById('regLicense').value.trim();
            const vtype=document.getElementById('regVehicleType').value;
            await setDoc(doc(db,'conductores',u.uid),{
                uid:u.uid,nombre:name,telefono:phone,cedula,photoURL,
                disponible:false,enViaje:false,ubicacion:null,
                calificacion:5.0,viajesCompletados:0,
                gananciasTotal:0,gananciasDia:0,gananciasSemana:0,gananciasMes:0,
                placa:plate,modelo:model,color,licencia:license,tipoVehiculo:vtype,
                actualizado:serverTimestamp()
            });
        }
        showToast('Cuenta creada exitosamente');
    }catch(e){
        let msg='Error al crear cuenta';
        if(e.code==='auth/email-already-in-use')msg='Email ya registrado';
        else if(e.code==='auth/invalid-email')msg='Email inv√°lido';
        showToast(msg,'err'); showLoad(false);
    }
}

async function logout(){
    try{
        if(userRole==='conductor'&&currentUser){
            await updateDoc(doc(db,'conductores',currentUser.uid),{disponible:false}).catch(()=>{});
        }
        [chatUnsub,tripUnsub,offersUnsub,reqsUnsub].forEach(u=>u&&u());
        await signOut(auth);
    }catch(e){console.log(e);}
    location.reload();
}

onAuthStateChanged(auth,async u=>{
    if(u){currentUser=u;await loadUserData();}
    else showLoad(false);
});

async function loadUserData(){
    try{
        const snap=await getDoc(doc(db,'usuarios',currentUser.uid));
        if(!snap.exists()){showToast('Perfil no encontrado','err');await signOut(auth);return;}
        userData=snap.data();
        userRole=userData.rol||'cliente';
        document.getElementById('userName').textContent=userData.nombre||'Usuario';
        if(userData.photoURL){
            document.getElementById('headerPhoto').src=userData.photoURL;
            document.getElementById('headerPhoto').style.display='block';
            document.getElementById('headerIcon').style.display='none';
        }
        document.getElementById('authScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        await restoreState();
        window._mapReady?initMap():window._pendingInit=true;
    }catch(e){showToast('Error al cargar perfil','err');showLoad(false);}
}

// ---- PERSIST STATE ----
async function saveState(){
    if(!currentUser)return;
    const s={userRole,locations:locs,tripId:currentTrip?.id||null,isOnline,ts:Date.now()};
    localStorage.setItem('rs_'+currentUser.uid,JSON.stringify(s));
    try{await setDoc(doc(db,'estados',currentUser.uid),{...s,upd:serverTimestamp()});}catch(e){}
}

async function restoreState(){
    if(!currentUser)return;
    try{
        let s=null;
        const sd=await getDoc(doc(db,'estados',currentUser.uid));
        if(sd.exists())s=sd.data();
        else{const ls=localStorage.getItem('rs_'+currentUser.uid);if(ls)s=JSON.parse(ls);}
        if(s?.tripId){
            const td=await getDoc(doc(db,'viajes',s.tripId));
            if(td.exists()){
                const d=td.data();
                if(!['completado','cancelado'].includes(d.estado)){
                    currentTrip={id:s.tripId,...d};
                    if(d.origen){locs.pickup=d.origen;setLocDisplay('pickup',d.origen.name);}
                    if(d.destino){locs.dest=d.destino;setLocDisplay('dest',d.destino.name);}
                    listenToTrip(s.tripId);
                }
            }
        }
        if(s?.isOnline&&userRole==='conductor')isOnline=true;
    }catch(e){console.log('restoreState:',e);}
}

// ---- MAP INIT ----
window.onMapScriptLoad=function(){window._mapReady=true;if(window._pendingInit)initMap();};

function initMap(){
    window._pendingInit=false;
    autocompleteService=new google.maps.places.AutocompleteService();
    geocoder=new google.maps.Geocoder();
    dirSvc=new google.maps.DirectionsService();
    dirRender=new google.maps.DirectionsRenderer({
        suppressMarkers:true,
        polylineOptions:{strokeColor:'#00d4ff',strokeWeight:5,strokeOpacity:.85,
            icons:[{icon:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,scale:3,fillColor:'#00d4ff',fillOpacity:1,strokeColor:'#00d4ff'},offset:'100%',repeat:'80px'}]
        }
    });

    const darkStyles=[
        {elementType:'geometry',stylers:[{color:'#1a1a2e'}]},
        {elementType:'labels.text.fill',stylers:[{color:'#6b7280'}]},
        {elementType:'labels.text.stroke',stylers:[{color:'#1a1a2e'}]},
        {featureType:'road',elementType:'geometry',stylers:[{color:'#2d2d44'}]},
        {featureType:'road',elementType:'labels.text.fill',stylers:[{color:'#9ca3af'}]},
        {featureType:'poi',elementType:'labels',stylers:[{visibility:'off'}]},
        {featureType:'transit',stylers:[{visibility:'off'}]},
        {featureType:'water',elementType:'geometry',stylers:[{color:'#0d1b2a'}]}
    ];

    const center=locs.cur||{lat:18.4861,lng:-69.9312};
    map=new google.maps.Map(document.getElementById('map'),{
        zoom:15,center,disableDefaultUI:true,
        styles:darkStyles,gestureHandling:'greedy',
        mapTypeControl:false,fullscreenControl:false,streetViewControl:false,zoomControl:false
    });
    window._darkStyles=darkStyles;
    dirRender.setMap(map);

    // Geolocation
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
            const pos={lat:p.coords.latitude,lng:p.coords.longitude};
            updateMyPos(pos); map.setCenter(pos);
            if(userRole==='cliente'&&!locs.pickup){
                locs.pickup=pos;
                // Reverse geocode for display
                geocoder.geocode({location:pos},(res,st)=>{
                    if(st==='OK'&&res[0]){
                        locs.pickup.name=res[0].formatted_address;
                        setLocDisplay('pickup',res[0].formatted_address);
                    }
                });
                placeMarker('pickup',pos);
            }
        },null,{enableHighAccuracy:true});
        watchId=navigator.geolocation.watchPosition(p=>{
            const pos={lat:p.coords.latitude,lng:p.coords.longitude};
            updateMyPos(pos);
            if(isNavigating)checkVoiceNav(pos);
            if(userRole==='conductor'&&currentUser&&isOnline){
                updateDoc(doc(db,'conductores',currentUser.uid),{ubicacion:pos,actualizado:serverTimestamp()}).catch(()=>{});
            }
        },e=>console.log('GPS:',e),{enableHighAccuracy:true,maximumAge:4000,timeout:10000});
    }

    // Show panels
    if(userRole==='cliente'){
        document.getElementById('clientPanel').classList.add('active');
        if(currentTrip)showTripStateClient();
    }else{
        document.getElementById('driverPanel').classList.add('active');
        if(isOnline){
            document.getElementById('tglSw').classList.add('on');
            document.getElementById('statusTxt').textContent='Conectado';
            document.getElementById('statusTxt').classList.replace('offline','online');
        }
        loadDriverStats();
        listenForRequests();
        listenForMyTrips();
    }
    showLoad(false);
}

function updateMyPos(pos){
    locs.cur=pos;
    if(!mkrs.user){
        mkrs.user=new google.maps.Marker({
            map,position:pos,zIndex:1000,
            icon:{path:google.maps.SymbolPath.CIRCLE,scale:9,fillColor:'#00d4ff',fillOpacity:1,strokeColor:'#fff',strokeWeight:3}
        });
    }else mkrs.user.setPosition(pos);
}

function placeMarker(type,pos,heading=0){
    if(mkrs[type])mkrs[type].setMap(null);
    const icons={
        pickup:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,scale:7,fillColor:'#00d4ff',fillOpacity:1,strokeColor:'#fff',strokeWeight:2},
        dest:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,scale:7,fillColor:'#ff0055',fillOpacity:1,strokeColor:'#fff',strokeWeight:2},
        driver:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,scale:8,fillColor:'#00ff88',fillOpacity:1,strokeColor:'#fff',strokeWeight:2,rotation:heading}
    };
    mkrs[type]=new google.maps.Marker({map,position:pos,icon:icons[type]||icons.pickup,zIndex:900});
}

function setLocDisplay(type,name){
    const el=document.getElementById(type==='pickup'?'pickupDisplay':'destDisplay');
    if(name){el.textContent=name;el.classList.remove('empty');}
    else{el.textContent=type==='pickup'?'¬øD√≥nde te recogemos?':'¬øA d√≥nde vas?';el.classList.add('empty');}
}

function checkAndShowRoute(){
    if(!locs.pickup||!locs.dest)return;
    dirSvc.route({origin:locs.pickup,destination:locs.dest,travelMode:'DRIVING'},(res,st)=>{
        if(st==='OK'){
            dirRender.setDirections(res);
            steps=res.routes[0].legs[0].steps;
            const leg=res.routes[0].legs[0];
            const dist=leg.distance.value;
            const suggested=Math.max(80,Math.ceil(dist/100)*15);
            document.getElementById('priceRec').textContent=`Precio recomendado: RD$ ${suggested}`;
            document.getElementById('currentPrice').textContent=`RD$ ${suggested}`;
            document.getElementById('clientOffer').value=suggested;
            document.getElementById('priceSection').style.display='block';
            document.getElementById('findDriverBtn').style.display='flex';
            // Fit bounds
            const bounds=new google.maps.LatLngBounds();
            bounds.extend(locs.pickup);bounds.extend(locs.dest);
            map.fitBounds(bounds,{top:80,bottom:200,left:20,right:20});
        }
    });
}

function onOfferInput(){
    const v=document.getElementById('clientOffer').value;
    if(v)document.getElementById('currentPrice').textContent=`RD$ ${v}`;
}

// ---- MAP CONTROLS ----
function toggleMapType(){
    mapTypeIdx=(mapTypeIdx+1)%2;
    if(mapTypeIdx===0)map.setOptions({styles:window._darkStyles});
    else map.setOptions({styles:[]});
}
function centerOnUser(){
    if(locs.cur){map.panTo(locs.cur);map.setZoom(16);}
    else showToast('Esperando GPS...','err');
}
function toggleDarkMode(){
    darkMode=!darkMode;
    document.body.classList.toggle('light-mode',!darkMode);
    const btn=document.getElementById('darkModeBtn');
    btn.innerHTML=`<i class="fas fa-${darkMode?'moon':'sun'}"></i>`;
    if(map){if(!darkMode)map.setOptions({styles:[]});else map.setOptions({styles:window._darkStyles});}
}
function toggleAudio(){
    audioEnabled=!audioEnabled;
    const b=document.getElementById('audioBtn');
    b.innerHTML=`<i class="fas fa-volume-${audioEnabled?'up':'mute'}"></i>`;
    if(!audioEnabled)b.classList.add('muted');else b.classList.remove('muted');
}
function toggleMenu(){document.getElementById('navMenu').classList.toggle('open');}
function closeMenu(){document.getElementById('navMenu').classList.remove('open');}

function toggleClientPanel(){
    clientPanelHidden=!clientPanelHidden;
    document.getElementById('clientPanel').classList.toggle('hidden',clientPanelHidden);
}
function toggleDriverPanel(){
    driverPanelHidden=!driverPanelHidden;
    document.getElementById('driverPanel').classList.toggle('hidden',driverPanelHidden);
    const ico=document.getElementById('drvPanelIco');
    ico.className='fas fa-chevron-'+(driverPanelHidden?'up':'down');
}

// ---- ADDRESS SEARCH OVERLAY ----
function openAddrOverlay(type){
    addrType=type;
    document.getElementById('addrOverlayTitle').textContent=type==='pickup'?'¬øD√≥nde te recogemos?':'¬øA d√≥nde vas?';
    document.getElementById('addrInput').value='';
    document.getElementById('addrSuggestions').innerHTML='';
    document.getElementById('addrOverlay').classList.add('open');
    setTimeout(()=>document.getElementById('addrInput').focus(),100);
}
function closeAddrOverlay(){
    document.getElementById('addrOverlay').classList.remove('open');
}
function openMapSelectorFromOverlay(){
    closeAddrOverlay();
    openMapSelector(addrType);
}

function onAddrSearch(val){
    clearTimeout(addrSearchTimer);
    if(!val||val.length<2){document.getElementById('addrSuggestions').innerHTML='';return;}
    addrSearchTimer=setTimeout(()=>{
        if(!autocompleteService)return;
        autocompleteService.getPlacePredictions({
            input:val,
            componentRestrictions:{country:'do'},
            location:locs.cur?new google.maps.LatLng(locs.cur.lat,locs.cur.lng):null,
            radius:locs.cur?50000:null
        },(preds,st)=>{
            const cont=document.getElementById('addrSuggestions');
            if(st!==google.maps.places.PlacesServiceStatus.OK||!preds){cont.innerHTML='';return;}
            cont.innerHTML=preds.map(p=>`
                <div class="sug-item" onclick="selectSuggestion('${p.place_id}','${p.description.replace(/'/g,"\\'")}')">
                    <i class="fas fa-map-marker-alt"></i>
                    <div><div class="sug-main">${p.structured_formatting.main_text}</div><div class="sug-sub">${p.structured_formatting.secondary_text||''}</div></div>
                </div>`).join('');
        });
    },300);
}
window.selectSuggestion=function(placeId,desc){
    geocoder.geocode({placeId},(res,st)=>{
        if(st==='OK'&&res[0]){
            const pos={lat:res[0].geometry.location.lat(),lng:res[0].geometry.location.lng(),name:desc};
            setLocation(addrType,pos);
            closeAddrOverlay();
        }
    });
};

function setLocation(type,pos){
    if(type==='pickup'){
        locs.pickup=pos;
        setLocDisplay('pickup',pos.name);
        placeMarker('pickup',pos);
        if(locs.dest){map.panTo(pos);checkAndShowRoute();}
        else map.panTo(pos);
    }else{
        locs.dest=pos;
        setLocDisplay('dest',pos.name);
        placeMarker('dest',pos);
        if(locs.pickup){map.panTo(pos);checkAndShowRoute();}
        else map.panTo(pos);
    }
}

// ---- MAP SELECTOR ----
function openMapSelector(type){
    mapSelectorType=type;
    const title=type==='pickup'?'Selecciona punto de recogida':'Selecciona destino';
    document.getElementById('mapSelTitle').textContent=title;
    document.getElementById('mapSelOverlay').classList.add('active');
    closeAddrOverlay();
    // If panel is hidden, expand map view
    document.getElementById('clientPanel').classList.add('hidden');
    clientPanelHidden=true;
}
function cancelMapSelector(){
    document.getElementById('mapSelOverlay').classList.remove('active');
    mapSelectorType=null;
    document.getElementById('clientPanel').classList.remove('hidden');
    clientPanelHidden=false;
}
function confirmMapSelection(){
    const center=map.getCenter();
    const pos={lat:center.lat(),lng:center.lng()};
    geocoder.geocode({location:pos},(res,st)=>{
        const name=st==='OK'&&res[0]?res[0].formatted_address:'Ubicaci√≥n seleccionada';
        pos.name=name;
        setLocation(mapSelectorType,pos);
        document.getElementById('mapSelOverlay').classList.remove('active');
        mapSelectorType=null;
        document.getElementById('clientPanel').classList.remove('hidden');
        clientPanelHidden=false;
    });
}

// ---- FIND DRIVER ----
async function findDriver(){
    if(!locs.pickup||!locs.dest){showToast('Selecciona origen y destino','err');return;}
    if(!currentUser){showToast('No autenticado','err');return;}
    showLoad(true);
    const price=parseInt(document.getElementById('clientOffer').value)||150;
    try{
        const td={
            clienteId:currentUser.uid,clienteNombre:userData.nombre,clienteTelefono:userData.telefono||'',
            clientePhoto:userData.photoURL||null,clienteRating:userData.calificacion||5.0,
            origen:{lat:locs.pickup.lat,lng:locs.pickup.lng,name:locs.pickup.name||'Origen'},
            destino:{lat:locs.dest.lat,lng:locs.dest.lng,name:locs.dest.name||'Destino'},
            precioOfrecido:price,estado:'buscando',creado:serverTimestamp()
        };
        const tr=await addDoc(collection(db,'viajes'),td);
        currentTrip={id:tr.id,...td};
        await saveState();
        listenToTrip(tr.id);
        document.getElementById('offersModal').classList.add('active');
        document.getElementById('findDriverBtn').style.display='none';
        document.getElementById('priceSection').style.display='none';
        showToast('Buscando conductores...');
        // Listen for offers
        const oq=query(collection(db,'viajes',tr.id,'ofertas'));
        offersUnsub=onSnapshot(oq,snap=>{
            snap.docChanges().forEach(ch=>{
                if(ch.type==='added'){addOfferCard(ch.doc.data(),ch.doc.id,tr.id);}
            });
        });
    }catch(e){showToast('Error: '+e.message,'err');}
    finally{showLoad(false);}
}

function listenToTrip(tripId){
    tripUnsub=onSnapshot(doc(db,'viajes',tripId),snap=>{
        if(!snap.exists())return;
        const d=snap.data();
        currentTrip={id:tripId,...d};
        if(d.estado==='aceptado'&&d.conductorId){
            document.getElementById('offersModal').classList.remove('active');
            Object.values(offerTimers).forEach(t=>clearInterval(t)); offerTimers={};
            showDriverCard(d);
            playBeep(800,0.5,0.3);
            showToast(`¬°${d.conductorNombre} acept√≥ tu viaje!`);
            trackDriver(d.conductorId);
            // Route to pickup
            if(locs.cur)showRouteDriver(locs.cur,d.origen);
        }else if(d.estado==='conductor_llego'){
            document.getElementById('arrivalBanner').classList.add('active');
            speak('Tu conductor lleg√≥, est√° esper√°ndote');
            playBeep(1000,0.5,0.4);
            showToast('¬°El conductor lleg√≥!');
        }else if(d.estado==='en_curso'){
            document.getElementById('arrivalBanner').classList.remove('active');
            showFloat('Viaje en curso ‚Äî en camino al destino');
            speak('Viaje iniciado, en camino al destino');
            isNavigating=true; stepIdx=0;
        }else if(d.estado==='completado'){
            hideFloat();
            isNavigating=false;
            showToast('¬°Viaje completado!');
            openRatingModal(d.conductorId,'conductor',tripId,d.conductorNombre);
            resetClientUI();
        }else if(d.estado==='cancelado'){
            showToast('Viaje cancelado','err');
            hideFloat();
            isNavigating=false;
            resetClientUI();
        }
        // Conductor offer negotiation
        if(d.estado==='buscando'&&d.ofertaConductor){
            showNegAlert(d.ofertaConductor);
        }
    });
}

function showTripStateClient(){
    if(!currentTrip)return;
    showDriverCard(currentTrip);
    if(currentTrip.conductorId)trackDriver(currentTrip.conductorId);
    if(currentTrip.estado==='conductor_llego')document.getElementById('arrivalBanner').classList.add('active');
    if(currentTrip.estado==='en_curso'){showFloat('Viaje en curso');isNavigating=true;}
}

function addOfferCard(oferta,oid,tripId){
    if(document.getElementById('ofc-'+oid))return;
    const c=document.createElement('div');
    c.id='ofc-'+oid; c.className='offer-card';
    c.innerHTML=`
        <div class="offer-timer-bar" id="otb-${oid}" style="width:100%"></div>
        <div class="offer-drv-hdr">
            <img src="${oferta.conductorPhoto||''}" class="offer-drv-photo" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><circle cx=%2230%22 cy=%2230%22 r=%2230%22 fill=%22%23333%22/><text x=%2230%22 y=%2236%22 font-size=%2224%22 text-anchor=%22middle%22 fill=%22%23aaa%22>üë§</text></svg>'">
            <div>
                <div class="offer-drv-name">${oferta.conductorNombre}</div>
                <div class="offer-drv-rating">‚òÖ ${(oferta.conductorRating||5).toFixed(1)} ¬∑ ${oferta.conductorViajes||0} viajes</div>
                <div style="font-size:var(--fs11);color:var(--txt2);margin-top:2px">${oferta.conductorModelo||''} ${oferta.conductorPlaca?'¬∑'+oferta.conductorPlaca:''}</div>
            </div>
        </div>
        <div class="offer-price">RD$ ${oferta.precioOfrecido}</div>
        <div class="offer-acts">
            <button class="btn btn-ok" onclick="acceptOffer('${tripId}','${oferta.conductorId}',${oferta.precioOfrecido},'${oid}')"><i class="fas fa-check"></i> Aceptar</button>
            <button class="btn btn-err" onclick="rejectOffer('${tripId}','${oid}')"><i class="fas fa-times"></i> Rechazar</button>
        </div>`;
    document.getElementById('offersList').appendChild(c);
    let t=60;
    const bar=document.getElementById('otb-'+oid);
    offerTimers[oid]=setInterval(()=>{
        t--;bar.style.width=(t/60*100)+'%';
        if(t<=20)bar.style.background='var(--err)';
        else if(t<=40)bar.style.background='var(--warn)';
        if(t<=0){clearInterval(offerTimers[oid]);delete offerTimers[oid];c.remove();}
    },1000);
    playBeep(600,0.3,0.2);
}

async function acceptOffer(tripId,driverId,price,oid){
    showLoad(true);
    try{
        await updateDoc(doc(db,'viajes',tripId),{estado:'aceptado',conductorId:driverId,precioNegociado:price,aceptadoEn:serverTimestamp()});
        // Delete other offers
        const os=await getDocs(collection(db,'viajes',tripId,'ofertas'));
        os.forEach(async od=>{if(od.data().conductorId!==driverId)await deleteDoc(od.ref);});
        // Mark in conductor doc
        await updateDoc(doc(db,'conductores',driverId),{enViaje:true,viajeId:tripId});
        Object.values(offerTimers).forEach(t=>clearInterval(t));offerTimers={};
    }catch(e){showToast('Error','err');}
    finally{showLoad(false);}
}

async function rejectOffer(tripId,oid){
    try{
        await deleteDoc(doc(db,'viajes',tripId,'ofertas',oid));
        document.getElementById('ofc-'+oid)?.remove();
        clearInterval(offerTimers[oid]); delete offerTimers[oid];
    }catch(e){}
}

async function closeOffers(){
    document.getElementById('offersModal').classList.remove('active');
    if(currentTrip?.id){
        try{await updateDoc(doc(db,'viajes',currentTrip.id),{estado:'cancelado',canceladoEn:serverTimestamp()});}catch(e){}
    }
    Object.values(offerTimers).forEach(t=>clearInterval(t));offerTimers={};
    document.getElementById('findDriverBtn').style.display='flex';
    document.getElementById('priceSection').style.display='block';
    currentTrip=null; saveState();
}

function showDriverCard(data){
    const card=document.getElementById('driverInfoCard');
    card.classList.add('active');
    document.getElementById('driverName').textContent=data.conductorNombre||'Conductor';
    document.getElementById('driverRating').textContent=(data.conductorRating||5).toFixed(1);
    document.getElementById('driverTrips').textContent=(data.conductorViajes||0)+' viajes';
    document.getElementById('driverVehicle').textContent=`${data.conductorModelo||''} ${data.conductorPlaca?'¬∑ '+data.conductorPlaca:''}`;
    if(data.conductorPhoto)document.getElementById('driverPhoto').src=data.conductorPhoto;
    window._chatDriverId=data.conductorId;
    window._chatTripId=currentTrip?.id;
}

function resetClientUI(){
    document.getElementById('driverInfoCard').classList.remove('active');
    document.getElementById('arrivalBanner').classList.remove('active');
    document.getElementById('priceSection').style.display='none';
    document.getElementById('findDriverBtn').style.display='none';
    setLocDisplay('pickup',null); setLocDisplay('dest',null);
    locs.pickup=null; locs.dest=null;
    ['pickup','dest','driver'].forEach(k=>{if(mkrs[k]){mkrs[k].setMap(null);mkrs[k]=null;}});
    dirRender.setDirections({routes:[]});
    currentTrip=null; isNavigating=false; saveState();
    document.getElementById('navInstr').classList.remove('active');
    hideFloat();
}

// ---- DRIVER TRACKING ----
function trackDriver(driverId){
    onSnapshot(doc(db,'conductores',driverId),snap=>{
        if(!snap.exists())return;
        const d=snap.data();
        if(!d.ubicacion)return;
        const pos=d.ubicacion;
        placeMarker('driver',pos,d.heading||0);
        // Update ETA
        if(locs.pickup){
            const dist=google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(pos.lat,pos.lng),
                new google.maps.LatLng(locs.pickup.lat,locs.pickup.lng)
            );
            const eta=Math.ceil((dist/1000)/0.5);
            document.getElementById('driverETA').textContent=dist<100?'¬°Lleg√≥!':eta<2?'Llegando...':`~${eta} min`;
            // Client nav panel shows driver info
            document.getElementById('navInstr').classList.add('active');
            document.getElementById('navMain').textContent=dist<100?'¬°Conductor lleg√≥!':'Conductor en camino';
            document.getElementById('navSub').textContent=dist<100?'Te est√° esperando':`A ${(dist/1000).toFixed(1)} km`;
            document.getElementById('navDist').textContent=dist<1000?Math.round(dist):(dist/1000).toFixed(1);
            document.getElementById('navIco').className=dist<100?'fas fa-check-circle':'fas fa-car';
            const unit=document.querySelector('.nav-dist-unit');
            if(unit)unit.textContent=dist<1000?'m':'km';
            // Show mini car icon moving
            if(mkrs.driver)mkrs.driver.setPosition(pos);
        }
    });
}

function showRouteDriver(from,to){
    dirSvc.route({origin:from,destination:to,travelMode:'DRIVING'},(res,st)=>{
        if(st==='OK'){dirRender.setDirections(res);steps=res.routes[0].legs[0].steps;}
    });
}

// ---- VOICE NAV ----
function checkVoiceNav(pos){
    if(stepIdx>=steps.length)return;
    const next=steps[stepIdx];
    const dist=google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(pos.lat,pos.lng),next.end_location
    );
    // Announce at 200m
    if(dist<200&&dist>30){
        const instr=cleanHtml(steps[stepIdx+1]?steps[stepIdx+1].instructions:'Has llegado');
        const distTxt=dist<1000?`a ${Math.round(dist)} metros`:`a ${(dist/1000).toFixed(1)} kil√≥metros`;
        const msg=`${distTxt}, ${formatInstruction(instr)}`;
        document.getElementById('navMain').textContent=formatInstruction(instr);
        document.getElementById('navSub').textContent=`En ${distTxt}`;
        document.getElementById('navDist').textContent=dist<1000?Math.round(dist):(dist/1000).toFixed(1);
        document.querySelector('.nav-dist-unit').textContent=dist<1000?'m':'km';
        document.getElementById('navInstr').classList.add('active');
        showFloat(msg);
        if(audioEnabled){speak(msg);lastInstruction=msg;}
    }
    if(dist<30){
        stepIdx++;
        if(stepIdx>=steps.length){
            speak('Has llegado a tu destino');
            isNavigating=false;
            document.getElementById('navInstr').classList.remove('active');
            hideFloat();
        }
    }
}

function formatInstruction(html){
    const txt=cleanHtml(html).toLowerCase();
    if(txt.includes('turn left')||txt.includes('gira a la izquierda')||txt.includes('izquierda'))return 'Dobla a la izquierda';
    if(txt.includes('turn right')||txt.includes('gira a la derecha')||txt.includes('derecha'))return 'Dobla a la derecha';
    if(txt.includes('contin√∫a')||txt.includes('continue'))return 'Contin√∫a recto';
    if(txt.includes('rotonda')||txt.includes('roundabout'))return 'Toma la rotonda';
    return cleanHtml(html);
}

function speak(text){
    if(!audioEnabled)return;
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    u.lang='es-ES'; u.rate=0.95;
    const voices=window.speechSynthesis.getVoices().filter(v=>v.lang.startsWith('es'));
    if(voices.length)u.voice=voices[0];
    window.speechSynthesis.speak(u);
    lastInstruction=text;
}
function cleanHtml(h){const d=document.createElement('div');d.innerHTML=h;return d.textContent||'';}
function repeatLastInstruction(){if(lastInstruction)speak(lastInstruction);else speak(document.getElementById('floatStatusTxt').textContent);}

// ---- DRIVER LOGIC ----
async function loadDriverStats(){
    if(!currentUser)return;
    try{
        const snap=await getDoc(doc(db,'conductores',currentUser.uid));
        if(!snap.exists())return;
        const d=snap.data();
        document.getElementById('statRating').textContent=(d.calificacion||5).toFixed(1);
        document.getElementById('statTrips').textContent=d.viajesCompletados||0;
        let earn=0;
        if(earnPeriod==='day')earn=d.gananciasDia||0;
        else if(earnPeriod==='week')earn=d.gananciasSemana||0;
        else earn=d.gananciasMes||0;
        document.getElementById('statEarnings').textContent=`RD$${earn}`;
        document.getElementById('earnAmt').textContent=`RD$ ${earn}`;
    }catch(e){}
}

function setEarnPeriod(p,btn){
    earnPeriod=p;
    document.querySelectorAll('.period-b').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    loadDriverStats();
}

async function toggleStatus(){
    if(!currentUser)return;
    isOnline=!isOnline;
    const sw=document.getElementById('tglSw'),txt=document.getElementById('statusTxt');
    if(isOnline){
        sw.classList.add('on');txt.textContent='Conectado';txt.classList.replace('offline','online');
        await updateDoc(doc(db,'conductores',currentUser.uid),{disponible:true,actualizado:serverTimestamp()}).catch(()=>{});
        showToast('Ahora recibes solicitudes');
    }else{
        sw.classList.remove('on');txt.textContent='Desconectado';txt.classList.replace('online','offline');
        await updateDoc(doc(db,'conductores',currentUser.uid),{disponible:false,actualizado:serverTimestamp()}).catch(()=>{});
    }
    saveState();
}

function listenForRequests(){
    const q=query(collection(db,'viajes'),where('estado','==','buscando'));
    reqsUnsub=onSnapshot(q,snap=>{
        const cont=document.getElementById('requestsList');
        if(document.getElementById('tripCard').classList.contains('active'))return;
        if(snap.empty||!isOnline){
            cont.innerHTML=`<div style="text-align:center;padding:24px;color:var(--txt2)">
                <i class="fas fa-${isOnline?'search':'power-off'}" style="font-size:32px;display:block;margin-bottom:8px"></i>
                ${isOnline?'Sin solicitudes':'Activa disponibilidad'}
            </div>`;
            return;
        }
        let html='';
        snap.forEach(d=>{
            const t=d.data();
            const distToClient=locs.cur?
                (google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(locs.cur.lat,locs.cur.lng),
                    new google.maps.LatLng(t.origen.lat,t.origen.lng)
                )/1000).toFixed(1):'?';
            html+=`<div class="req-card">
                <div class="req-hdr">
                    <div>
                        <div style="font-weight:700;font-size:var(--fs14)">${t.clienteNombre}</div>
                        <div style="font-size:var(--fs12);color:var(--txt2)">A ${distToClient} km de ti ¬∑ ‚òÖ${(t.clienteRating||5).toFixed(1)}</div>
                    </div>
                    <div class="req-price">RD$ ${t.precioOfrecido}</div>
                </div>
                <div class="route-line">
                    <div class="rt-pt"><div class="rt-dot pu"></div><span style="font-size:var(--fs13)">${t.origen.name||'Origen'}</span></div>
                    <div class="rt-pt"><div class="rt-dot de"></div><span style="font-size:var(--fs13)">${t.destino.name||'Destino'}</span></div>
                </div>
                <div class="req-actions">
                    <button class="btn btn-ok" onclick="makeOffer('${d.id}',${t.precioOfrecido})">
                        <i class="fas fa-hand-holding-usd"></i> Hacer Oferta
                    </button>
                </div>
            </div>`;
        });
        cont.innerHTML=html;
    });
}

function listenForMyTrips(){
    if(!currentUser)return;
    const q=query(collection(db,'viajes'),where('conductorId','==',currentUser.uid),where('estado','in',['aceptado','conductor_llego','en_curso']));
    onSnapshot(q,snap=>{
        if(!snap.empty){
            snap.forEach(d=>{
                currentTrip={id:d.id,...d.data()};
                showDriverTripCard(currentTrip);
            });
        }else{
            document.getElementById('tripCard').classList.remove('active');
            document.getElementById('requestsList').style.display='block';
            document.getElementById('sosBtn').classList.remove('active');
            hideFloat(); isNavigating=false;
            if(dirRender)dirRender.setDirections({routes:[]});
        }
    });
}

function showDriverTripCard(trip){
    document.getElementById('tripCard').classList.add('active');
    document.getElementById('requestsList').style.display='none';
    document.getElementById('sosBtn').classList.add('active');
    document.getElementById('clientName').textContent=trip.clienteNombre;
    document.getElementById('tripOrigen').textContent=trip.origen.name||'Origen';
    document.getElementById('tripDest').textContent=trip.destino.name||'Destino';
    document.getElementById('tripEarn').textContent=`RD$ ${trip.precioNegociado||trip.precioOfrecido}`;
    if(trip.clientePhoto)document.getElementById('clientPhoto').src=trip.clientePhoto;
    if(trip.clienteRating)document.getElementById('clientRatingShow').textContent=`‚òÖ ${trip.clienteRating.toFixed(1)}`;
    if(locs.cur&&trip.origen){
        const dist=google.maps.geometry.spherical.computeDistanceBetween(
            new google.maps.LatLng(locs.cur.lat,locs.cur.lng),new google.maps.LatLng(trip.origen.lat,trip.origen.lng))/1000;
        document.getElementById('clientDist').textContent=dist.toFixed(1)+' km';
        document.getElementById('tripDist').textContent=dist.toFixed(1)+' km';
        document.getElementById('tripTime').textContent=Math.ceil(dist/0.5)+' min';
    }
    const [btnL,btnI,btnF]=['btnLlegue','btnIniciar','btnFinalizar'].map(id=>document.getElementById(id));
    btnL.style.display=btnI.style.display=btnF.style.display='none';
    const st=document.getElementById('tripStatusTxt');
    if(trip.estado==='aceptado'){
        st.textContent='En camino al cliente';btnL.style.display='flex';
        showFloat('En camino al origen');
        if(locs.cur)showRouteDriver(locs.cur,trip.origen);
        isNavigating=true; stepIdx=0;
        speak('Ve al cliente, en camino al origen');
    }else if(trip.estado==='conductor_llego'){
        st.textContent='Esperando al cliente';btnI.style.display='flex';
        hideFloat(); isNavigating=false;
        speak('Has llegado al punto de recogida, esperando al cliente');
        // Notify client via trip update (already handled in listenToTrip)
    }else if(trip.estado==='en_curso'){
        st.textContent='Viaje en progreso';btnF.style.display='flex';
        showFloat('Viaje en curso ‚Äî en camino al destino');
        if(locs.cur)showRouteDriver(locs.cur,trip.destino);
        isNavigating=true; stepIdx=0;
        speak('Viaje iniciado, en camino al destino');
    }
    window._chatClientId=trip.clienteId;
    window._chatTripId=trip.id;
}

async function makeOffer(tripId,clientPrice){
    const myPriceStr=prompt(`Cliente ofrece: RD$ ${clientPrice}\n¬øTu precio?`,clientPrice);
    if(!myPriceStr)return;
    const myPrice=parseInt(myPriceStr);
    if(isNaN(myPrice)||myPrice<50){showToast('Precio inv√°lido','err');return;}
    showLoad(true);
    try{
        const cd=await getDoc(doc(db,'conductores',currentUser.uid));
        const cdat=cd.data()||{};
        await addDoc(collection(db,'viajes',tripId,'ofertas'),{
            conductorId:currentUser.uid,conductorNombre:userData.nombre,conductorPhoto:userData.photoURL||null,
            conductorRating:cdat.calificacion||5.0,conductorViajes:cdat.viajesCompletados||0,
            conductorModelo:cdat.modelo||'',conductorPlaca:cdat.placa||'',
            precioOfrecido:myPrice,timestamp:serverTimestamp()
        });
        showToast('Oferta enviada');
    }catch(e){showToast('Error al enviar oferta','err');}
    finally{showLoad(false);}
}

async function driverArrived(){
    if(!currentTrip)return;
    await updateDoc(doc(db,'viajes',currentTrip.id),{estado:'conductor_llego',llegadaEn:serverTimestamp()}).catch(e=>showToast('Error','err'));
    showToast('Marcaste que llegaste');
}
async function startTrip(){
    if(!currentTrip)return;
    await updateDoc(doc(db,'viajes',currentTrip.id),{estado:'en_curso',inicioEn:serverTimestamp()}).catch(e=>showToast('Error','err'));
    showToast('Viaje iniciado');
}
async function endTrip(){
    if(!currentTrip)return;
    showLoad(true);
    try{
        const price=currentTrip.precioNegociado||currentTrip.precioOfrecido;
        await updateDoc(doc(db,'viajes',currentTrip.id),{estado:'completado',finEn:serverTimestamp()});
        await updateDoc(doc(db,'conductores',currentUser.uid),{
            viajesCompletados:increment(1),gananciasTotal:increment(price),
            gananciasDia:increment(price),gananciasSemana:increment(price),gananciasMes:increment(price),enViaje:false
        });
        speak('Viaje completado. ¬°Excelente trabajo!');
        showToast('¬°Viaje completado!');
        document.getElementById('tripCard').classList.remove('active');
        document.getElementById('requestsList').style.display='block';
        document.getElementById('sosBtn').classList.remove('active');
        hideFloat(); isNavigating=false;
        dirRender.setDirections({routes:[]});
        currentTrip=null;
        loadDriverStats();
        openRatingModal(currentTrip?.clienteId,'cliente',currentTrip?.id,currentTrip?.clienteNombre);
    }catch(e){showToast('Error','err');}
    finally{showLoad(false);}
}

// ---- NEGOTIATE ----
function showNegAlert(offer){
    currentNegOffer=offer;
    document.getElementById('negDriverName').textContent=`${offer.conductorNombre||'El conductor'} te propone:`;
    document.getElementById('negPrice').textContent=`RD$ ${offer.precioOfrecido}`;
    document.getElementById('negAlert').classList.add('active');
}
async function acceptNegotiation(){
    if(!currentNegOffer||!currentTrip)return;
    document.getElementById('negAlert').classList.remove('active');
    await updateDoc(doc(db,'viajes',currentTrip.id),{precioNegociado:currentNegOffer.precioOfrecido,ofertaConductor:null});
    showToast('Precio aceptado');
}
async function rejectNegotiation(){
    if(!currentTrip)return;
    document.getElementById('negAlert').classList.remove('active');
    await updateDoc(doc(db,'viajes',currentTrip.id),{ofertaConductor:null});
    showToast('Oferta rechazada');
}

// ---- CANCEL ----
function showCancelModal(){if(!currentTrip){showToast('Sin viaje activo','err');return;}document.getElementById('cancelModal').classList.add('active');}
function closeCancelModal(){document.getElementById('cancelModal').classList.remove('active');}
async function cancelTrip(reason){
    if(!currentTrip)return;
    showLoad(true);
    try{
        await updateDoc(doc(db,'viajes',currentTrip.id),{estado:'cancelado',motivoCancelacion:reason,canceladoPor:userRole,canceladoEn:serverTimestamp()});
        if(userRole==='conductor')await updateDoc(doc(db,'conductores',currentUser.uid),{enViaje:false}).catch(()=>{});
        showToast('Viaje cancelado');
        closeCancelModal(); hideFloat(); isNavigating=false;
        if(userRole==='cliente')resetClientUI();
        else{
            document.getElementById('tripCard').classList.remove('active');
            document.getElementById('requestsList').style.display='block';
            document.getElementById('sosBtn').classList.remove('active');
            dirRender.setDirections({routes:[]});currentTrip=null;
        }
    }catch(e){showToast('Error','err');}
    finally{showLoad(false);}
}

// ---- RATING ----
function openRatingModal(targetId,targetRole,tripId,name){
    if(!targetId)return;
    ratingTargetId=targetId; ratingTripId=tripId; ratingTargetRole=targetRole;
    currentRating=0;
    document.getElementById('ratingTitle').textContent=`Califica a ${name||'este usuario'}`;
    document.getElementById('ratingSubtitle').textContent=`¬øC√≥mo fue tu experiencia con ${targetRole==='conductor'?'el conductor':'el cliente'}?`;
    document.querySelectorAll('.star-btn').forEach(s=>s.classList.remove('active'));
    document.getElementById('ratingModal').classList.add('active');
}
function selectStar(n){
    currentRating=n;
    document.querySelectorAll('.star-btn').forEach(s=>s.classList.toggle('active',parseInt(s.dataset.star)<=n));
}
async function submitRating(){
    if(!currentRating){showToast('Selecciona una calificaci√≥n','err');return;}
    const comment=document.getElementById('ratingComment').value.trim();
    showLoad(true);
    try{
        await addDoc(collection(db,'calificaciones'),{
            calificadorId:currentUser.uid,calificadorNombre:userData.nombre,
            calificadoId:ratingTargetId,calificadoRol:ratingTargetRole,
            tripId:ratingTripId,estrellas:currentRating,comentario:comment,
            fecha:serverTimestamp()
        });
        // Update average rating
        const colName=ratingTargetRole==='conductor'?'conductores':'usuarios';
        const snap=await getDoc(doc(db,colName,ratingTargetId));
        if(snap.exists()){
            const d=snap.data();
            const trips=(d.viajesCompletados||0)+1;
            const oldRating=d.calificacion||5;
            const newRating=((oldRating*(trips-1))+currentRating)/trips;
            await updateDoc(doc(db,colName,ratingTargetId),{calificacion:parseFloat(newRating.toFixed(2))});
        }
        showToast('¬°Calificaci√≥n enviada!');
        document.getElementById('ratingModal').classList.remove('active');
    }catch(e){showToast('Error','err');}
    finally{showLoad(false);}
}
function skipRating(){document.getElementById('ratingModal').classList.remove('active');}

// ---- CHAT ----
function openChat(){
    const tripId=window._chatTripId||currentTrip?.id;
    if(!tripId){showToast('Sin viaje activo','err');return;}
    window._chatTripId=tripId;
    document.getElementById('chatModal').classList.add('active');
    const isClient=userRole==='cliente';
    document.getElementById('chatName').textContent=isClient?(currentTrip?.conductorNombre||'Conductor'):(currentTrip?.clienteNombre||'Cliente');
    const photo=isClient?currentTrip?.conductorPhoto:currentTrip?.clientePhoto;
    if(photo)document.getElementById('chatPhoto').src=photo;
    loadMessages(tripId);
}
function closeChat(){document.getElementById('chatModal').classList.remove('active');if(chatUnsub){chatUnsub();chatUnsub=null;}}
function closeChatIfBg(e){if(e.target.id==='chatModal')closeChat();}
function loadMessages(tripId){
    const q=query(collection(db,'viajes',tripId,'mensajes'),orderBy('timestamp','asc'));
    chatUnsub=onSnapshot(q,snap=>{
        const cont=document.getElementById('chatMsgs');
        cont.innerHTML='';
        snap.forEach(d=>{
            const m=d.data();
            const sent=m.remitente===currentUser.uid;
            const div=document.createElement('div');
            div.className='msg '+(sent?'sent':'recv');
            div.textContent=m.texto;
            cont.appendChild(div);
            if(!sent&&audioEnabled)playBeep(1200,0.15,0.2);
        });
        cont.scrollTop=cont.scrollHeight;
    });
}
async function sendMessage(){
    const inp=document.getElementById('msgInput');
    const txt=inp.value.trim();
    const tid=window._chatTripId||currentTrip?.id;
    if(!txt||!tid)return;
    try{
        await addDoc(collection(db,'viajes',tid,'mensajes'),{texto:txt,remitente:currentUser.uid,remitenteNombre:userData.nombre,timestamp:serverTimestamp()});
        inp.value='';
    }catch(e){showToast('Error','err');}
}

// ---- SOS ----
function triggerSOS(){
    if(confirm('¬øActivar alerta de emergencia?')){
        showToast('üö® Alerta SOS activada','err');
        if(currentTrip?.id){
            updateDoc(doc(db,'viajes',currentTrip.id),{sos:true,sosEn:serverTimestamp()}).catch(()=>{});
        }
    }
}

// ---- PROFILE ----
function openProfile(){
    if(!userData)return;
    document.getElementById('profileModal').classList.add('active');
    document.getElementById('profileName').textContent=userData.nombre;
    document.getElementById('profileEmail').textContent=userData.email;
    document.getElementById('editName').value=userData.nombre||'';
    document.getElementById('editPhone').value=userData.telefono||'';
    document.getElementById('editCedula').value=userData.cedula||'';
    document.getElementById('editBirth').value=userData.fechaNacimiento||'';
    document.getElementById('editAddress').value=userData.direccion||'';
    if(userData.photoURL)document.getElementById('profilePhotoLg').src=userData.photoURL;
    document.getElementById('pStatRating').textContent=(userData.calificacion||5).toFixed(1);
    document.getElementById('pStatTrips').textContent=userData.viajesCompletados||0;
    if(userRole==='conductor'){
        document.getElementById('drvEditSection').style.display='block';
        getDoc(doc(db,'conductores',currentUser.uid)).then(snap=>{
            if(!snap.exists())return;
            const d=snap.data();
            document.getElementById('editPlate').value=d.placa||'';
            document.getElementById('editModel').value=d.modelo||'';
            document.getElementById('editColor').value=d.color||'';
            document.getElementById('editLicense').value=d.licencia||'';
            document.getElementById('editVehicleType').value=d.tipoVehiculo||'sedan';
            document.getElementById('pStatEarn').textContent=`RD$${d.gananciasTotal||0}`;
        });
    }else{
        document.getElementById('drvEditSection').style.display='none';
        document.getElementById('pStatEarn').textContent='N/A';
    }
    closeMenu();
}
function closeProfile(){document.getElementById('profileModal').classList.remove('active');}

async function saveProfile(){
    const nombre=document.getElementById('editName').value.trim();
    const telefono=document.getElementById('editPhone').value.trim();
    const cedula=document.getElementById('editCedula').value.trim();
    const fechaNacimiento=document.getElementById('editBirth').value;
    const direccion=document.getElementById('editAddress').value.trim();
    if(!nombre){showToast('Nombre requerido','err');return;}
    showLoad(true);
    try{
        await updateDoc(doc(db,'usuarios',currentUser.uid),{nombre,telefono,cedula,fechaNacimiento,direccion});
        if(userRole==='conductor'){
            await updateDoc(doc(db,'conductores',currentUser.uid),{
                nombre,telefono,cedula,
                placa:document.getElementById('editPlate').value.trim(),
                modelo:document.getElementById('editModel').value.trim(),
                color:document.getElementById('editColor').value.trim(),
                licencia:document.getElementById('editLicense').value.trim(),
                tipoVehiculo:document.getElementById('editVehicleType').value
            });
        }
        userData.nombre=nombre; userData.telefono=telefono;
        document.getElementById('userName').textContent=nombre;
        document.getElementById('profileName').textContent=nombre;
        showToast('Perfil actualizado'); closeProfile();
    }catch(e){showToast('Error al guardar','err');}
    finally{showLoad(false);}
}

async function updateProfilePhoto(e){
    const f=e.target.files[0]; if(!f||!currentUser)return;
    showLoad(true);
    try{
        const sr=ref(storage,`profiles/${currentUser.uid}`);
        await uploadBytes(sr,f);
        const url=await getDownloadURL(sr);
        await updateProfile(auth.currentUser,{photoURL:url});
        await updateDoc(doc(db,'usuarios',currentUser.uid),{photoURL:url});
        if(userRole==='conductor')await updateDoc(doc(db,'conductores',currentUser.uid),{photoURL:url});
        userData.photoURL=url;
        document.getElementById('profilePhotoLg').src=url;
        document.getElementById('headerPhoto').src=url;
        document.getElementById('headerPhoto').style.display='block';
        document.getElementById('headerIcon').style.display='none';
        showToast('Foto actualizada');
    }catch(e){showToast('Error','err');}
    finally{showLoad(false);}
}

function confirmDeleteAccount(){
    if(confirm('¬øSeguro que deseas eliminar tu cuenta? Esta acci√≥n es irreversible.')){
        showToast('Funci√≥n disponible pr√≥ximamente','err');
    }
}

// ---- FLOATING STATUS ----
function showFloat(txt){
    document.getElementById('floatStatusTxt').textContent=txt;
    document.getElementById('floatStatus').classList.add('on');
    lastInstruction=txt;
}
function hideFloat(){document.getElementById('floatStatus').classList.remove('on');}

// ---- MENU STUBS ----
function openTripHistory(){showToast('Historial ‚Äî pr√≥ximamente');closeMenu();}
function openPaymentMethods(){showToast('M√©todos de pago ‚Äî pr√≥ximamente');closeMenu();}
function openSupport(){showToast('Soporte ‚Äî pr√≥ximamente');closeMenu();}
function openSettings(){showToast('Configuraci√≥n ‚Äî pr√≥ximamente');closeMenu();}

// ---- UTILS ----
function playBeep(freq,dur,vol){
    if(!audioEnabled)return;
    try{
        const ac=new(window.AudioContext||window.webkitAudioContext)();
        const o=ac.createOscillator(),g=ac.createGain();
        o.connect(g);g.connect(ac.destination);
        o.frequency.value=freq;o.type='sine';
        g.gain.setValueAtTime(vol,ac.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01,ac.currentTime+dur);
        o.start(ac.currentTime);o.stop(ac.currentTime+dur);
    }catch(e){}
}

function showToast(msg,type='ok'){
    const t=document.getElementById('toastEl');
    t.textContent=msg;
    t.className='toast show';
    t.style.borderColor=type==='err'?'var(--err)':'rgba(0,212,255,.25)';
    clearTimeout(window._toastTimer);
    window._toastTimer=setTimeout(()=>t.classList.remove('show'),3000);
}
function showLoad(v){document.getElementById('loadingScr').classList.toggle('active',v);}

// Close nav menu on outside click
document.addEventListener('click',e=>{
    const menu=document.getElementById('navMenu');
    const btn=document.getElementById('menuBtn');
    if(menu.classList.contains('open')&&!menu.contains(e.target)&&!btn.contains(e.target)){closeMenu();}
});

window.showToast=showToast;
window.showLoad=showLoad;
</script>
</body>
</html>
