<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retom - Transporte Inteligente</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #00d4ff;
            --primary-dark: #00a3cc;
            --secondary: #7b2cbf;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff0055;
            --dark: #0a0a0a;
            --surface: #1a1a1a;
            --surface-light: #2a2a2a;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        [data-theme="light"] {
            --dark: #ffffff;
            --surface: #f5f5f5;
            --surface-light: #e8e8e8;
            --text: #1a1a1a;
            --text-secondary: #4a4a4a;
            --border: rgba(0,0,0,0.1);
        }

        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%; 
            font-family: 'Inter', sans-serif; 
            background: var(--dark);
            overflow: hidden;
            position: fixed;
            color: var(--text);
        }

        #map { 
            height: 100%; 
            width: 100%; 
            position: absolute; 
            top: 0; 
            left: 0;
            z-index: 1;
            transition: filter 0.3s ease;
        }

        /* Screens */
        .screen {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: var(--dark);
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* Auth Screen */
        .auth-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: clamp(16px, 4vw, 32px);
            min-height: 100%;
        }

        .auth-card {
            background: var(--surface);
            border-radius: clamp(20px, 5vw, 32px);
            padding: clamp(20px, 5vw, 32px);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .logo-big {
            width: clamp(60px, 15vw, 80px);
            height: clamp(60px, 15vw, 80px);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: clamp(15px, 4vw, 20px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(30px, 8vw, 40px);
            margin: 0 auto clamp(16px, 4vw, 24px);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: clamp(4px, 2vw, 8px);
            font-size: clamp(24px, 7vw, 32px);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-card p {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: clamp(24px, 6vw, 32px);
            font-size: clamp(12px, 3.5vw, 14px);
        }

        .role-selector {
            display: flex;
            gap: clamp(8px, 2vw, 12px);
            margin-bottom: clamp(16px, 4vw, 24px);
        }

        .role-btn {
            flex: 1;
            padding: clamp(12px, 3vw, 16px);
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: clamp(10px, 3vw, 12px);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: clamp(12px, 3vw, 14px);
        }

        .role-btn.active {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
            color: var(--primary);
        }

        .role-btn i {
            font-size: clamp(20px, 5vw, 24px);
            margin-bottom: clamp(4px, 2vw, 8px);
            display: block;
        }

        .input-group {
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .input-group label {
            display: block;
            margin-bottom: clamp(4px, 2vw, 8px);
            font-size: clamp(11px, 3vw, 13px);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: clamp(10px, 3vw, 12px);
            padding: clamp(12px, 3vw, 14px);
            color: var(--text);
            font-size: clamp(14px, 4vw, 15px);
            outline: none;
            transition: all 0.3s;
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: clamp(10px, 3vw, 12px);
            padding: clamp(14px, 4vw, 16px);
            color: #fff;
            font-size: clamp(14px, 4vw, 16px);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(4px, 2vw, 8px);
            margin-bottom: clamp(8px, 2vw, 12px);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        /* Header Superior con Menú */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--surface);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 16px);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-logo {
            font-size: clamp(18px, 5vw, 22px);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-menu {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 12px);
        }

        .menu-btn {
            width: clamp(36px, 10vw, 40px);
            height: clamp(36px, 10vw, 40px);
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: clamp(16px, 4.5vw, 18px);
            transition: all 0.3s;
        }

        .menu-btn:active {
            background: var(--primary);
            color: #000;
        }

        .user-pill {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: clamp(4px, 1.5vw, 6px) clamp(8px, 2vw, 12px) clamp(4px, 1.5vw, 6px) clamp(4px, 1.5vw, 6px);
            display: flex;
            align-items: center;
            gap: clamp(6px, 2vw, 10px);
            cursor: pointer;
        }

        .user-pill img {
            width: clamp(28px, 8vw, 32px);
            height: clamp(28px, 8vw, 32px);
            border-radius: 50%;
            object-fit: cover;
        }

        .user-pill span {
            font-size: clamp(12px, 3.5vw, 14px);
            font-weight: 600;
            margin-right: clamp(4px, 1.5vw, 6px);
        }

        /* Menú desplegable */
        .dropdown-menu {
            position: fixed;
            top: clamp(70px, 15vh, 80px);
            right: clamp(12px, 3vw, 16px);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: clamp(12px, 3vw, 16px);
            padding: clamp(8px, 2vw, 12px);
            min-width: 200px;
            z-index: 1001;
            box-shadow: var(--shadow);
            display: none;
        }

        .dropdown-menu.active {
            display: block;
        }

        .menu-item {
            padding: clamp(10px, 3vw, 12px) clamp(12px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: clamp(10px, 3vw, 12px);
            color: var(--text);
            text-decoration: none;
            border-radius: clamp(8px, 2vw, 10px);
            transition: all 0.2s;
            cursor: pointer;
            font-size: clamp(13px, 3.5vw, 14px);
        }

        .menu-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .menu-item i {
            width: clamp(18px, 5vw, 20px);
            color: var(--primary);
        }

        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: clamp(6px, 2vw, 8px) 0;
        }

        /* Floating Status */
        .floating-status {
            position: fixed;
            top: clamp(80px, 15vh, 100px);
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 50px;
            padding: clamp(12px, 3vw, 16px) clamp(20px, 5vw, 32px);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 12px);
            font-weight: 700;
            font-size: clamp(13px, 3.5vw, 15px);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            max-width: 90%;
            white-space: nowrap;
        }

        .floating-status.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Map Controls */
        .map-controls {
            position: fixed;
            top: clamp(80px, 15vh, 90px);
            right: clamp(12px, 3vw, 16px);
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 2vw, 8px);
        }

        .map-control-btn {
            width: clamp(40px, 11vw, 44px);
            height: clamp(40px, 11vw, 44px);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: clamp(10px, 3vw, 12px);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: clamp(16px, 4.5vw, 18px);
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .map-control-btn:active {
            background: var(--primary);
            color: #000;
        }

        .map-control-btn.muted {
            color: var(--danger);
            border-color: var(--danger);
        }

        /* Panel de búsqueda */
        .search-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: clamp(24px, 6vw, 32px) clamp(24px, 6vw, 32px) 0 0;
            padding: clamp(16px, 4vw, 24px);
            z-index: 1000;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(0);
            transition: transform 0.3s ease;
            border-top: 1px solid var(--border);
        }

        .search-panel.hidden {
            transform: translateY(calc(100% - 70px));
        }

        .panel-handle {
            width: clamp(36px, 10vw, 40px);
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto clamp(16px, 4vw, 20px);
            cursor: pointer;
        }

        .panel-toggle {
            position: absolute;
            top: clamp(10px, 3vw, 12px);
            right: clamp(16px, 4vw, 20px);
            width: clamp(36px, 10vw, 40px);
            height: clamp(36px, 10vw, 40px);
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 50%;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 4.5vw, 18px);
            z-index: 10;
        }

        /* Direcciones */
        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 3vw, 12px);
            margin-bottom: clamp(16px, 4vw, 20px);
        }

        .location-row {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
            background: rgba(255,255,255,0.03);
            border-radius: clamp(10px, 3vw, 12px);
            padding: 4px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .location-row:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .location-icon {
            width: clamp(36px, 10vw, 40px);
            height: clamp(36px, 10vw, 40px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 4.5vw, 18px);
        }

        .location-icon.pickup { color: var(--primary); }
        .location-icon.dest { color: var(--danger); }

        .location-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: clamp(14px, 4vw, 15px);
            outline: none;
            padding: clamp(8px, 2.5vw, 10px);
        }

        .location-btn {
            width: clamp(36px, 10vw, 40px);
            height: clamp(36px, 10vw, 40px);
            background: rgba(0, 212, 255, 0.1);
            border: none;
            border-radius: clamp(8px, 2.5vw, 10px);
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .location-btn:active {
            background: var(--primary);
            color: #000;
        }

        /* Precio */
        .price-section {
            background: rgba(255,255,255,0.03);
            border-radius: clamp(14px, 4vw, 16px);
            padding: clamp(16px, 4vw, 20px);
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .price-header {
            text-align: center;
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .price-label {
            font-size: clamp(12px, 3.5vw, 13px);
            color: var(--text-secondary);
            margin-bottom: clamp(4px, 2vw, 8px);
        }

        .price-current {
            font-size: clamp(32px, 9vw, 40px);
            font-weight: 800;
            color: var(--success);
        }

        .price-input-group {
            display: flex;
            gap: clamp(8px, 2.5vw, 10px);
        }

        .price-input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: clamp(10px, 3vw, 12px);
            padding: clamp(12px, 3vw, 14px);
            color: var(--text);
            font-size: clamp(14px, 4vw, 15px);
            text-align: center;
        }

        /* Tarjeta de conductor */
        .driver-info-card {
            background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(123,44,191,0.1));
            border: 2px solid var(--primary);
            border-radius: clamp(14px, 4vw, 16px);
            padding: clamp(16px, 4vw, 20px);
            margin-top: clamp(12px, 3vw, 16px);
            display: none;
        }

        .driver-info-card.active {
            display: block;
        }

        .driver-profile {
            display: flex;
            align-items: center;
            gap: clamp(12px, 3vw, 16px);
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .driver-photo {
            width: clamp(50px, 14vw, 60px);
            height: clamp(50px, 14vw, 60px);
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .driver-details h3 {
            font-size: clamp(16px, 4.5vw, 18px);
            margin-bottom: clamp(2px, 1vw, 4px);
        }

        .driver-rating {
            color: var(--warning);
            font-size: clamp(12px, 3.5vw, 14px);
        }

        .driver-actions {
            display: flex;
            gap: clamp(8px, 2.5vw, 10px);
        }

        .driver-actions button {
            flex: 1;
            padding: clamp(10px, 3vw, 12px);
            border-radius: clamp(8px, 2.5vw, 10px);
            border: none;
            cursor: pointer;
            font-size: clamp(12px, 3.5vw, 14px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(4px, 2vw, 8px);
        }

        .btn-message {
            background: rgba(0, 212, 255, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-cancel {
            background: rgba(255, 0, 85, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Panel de conductor */
        .driver-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: clamp(24px, 6vw, 32px) clamp(24px, 6vw, 32px) 0 0;
            padding: clamp(16px, 4vw, 24px);
            z-index: 1000;
            max-height: 85vh;
            overflow-y: auto;
            border-top: 1px solid var(--border);
        }

        .driver-panel.hidden {
            transform: translateY(calc(100% - 70px));
        }

        .driver-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(16px, 4vw, 20px);
        }

        .driver-panel-header h3 {
            font-size: clamp(16px, 4.5vw, 18px);
        }

        /* Estadísticas */
        .driver-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: clamp(8px, 2.5vw, 12px);
            margin-bottom: clamp(16px, 4vw, 20px);
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            border-radius: clamp(10px, 3vw, 12px);
            padding: clamp(12px, 3vw, 16px);
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: clamp(18px, 5vw, 22px);
            font-weight: 800;
            color: var(--primary);
            margin-bottom: clamp(2px, 1vw, 4px);
        }

        .stat-label {
            font-size: clamp(10px, 3vw, 11px);
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Ganancias */
        .earnings-section {
            background: rgba(255,255,255,0.03);
            border-radius: clamp(14px, 4vw, 16px);
            padding: clamp(16px, 4vw, 20px);
            margin-bottom: clamp(16px, 4vw, 20px);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .earnings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .earnings-title {
            font-size: clamp(14px, 4vw, 16px);
            font-weight: 700;
        }

        .earnings-amount {
            font-size: clamp(24px, 7vw, 28px);
            font-weight: 800;
            color: var(--success);
            text-align: center;
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .earnings-period {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: clamp(4px, 2vw, 8px);
        }

        .period-btn {
            padding: clamp(6px, 2vw, 8px);
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: clamp(6px, 2vw, 8px);
            color: var(--text-secondary);
            font-size: clamp(11px, 3vw, 12px);
            cursor: pointer;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }

        /* Toggle estado */
        .status-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: clamp(16px, 4vw, 20px);
            background: rgba(255,255,255,0.03);
            border-radius: clamp(14px, 4vw, 16px);
            margin-bottom: clamp(16px, 4vw, 20px);
        }

        .status-text {
            font-size: clamp(16px, 4.5vw, 18px);
            font-weight: 700;
        }

        .status-text.online { color: var(--success); }
        .status-text.offline { color: var(--text-secondary); }

        .toggle-switch {
            width: clamp(50px, 14vw, 60px);
            height: clamp(26px, 7vw, 32px);
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: clamp(22px, 6vw, 28px);
            height: clamp(22px, 6vw, 28px);
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: calc(100% - 30px);
        }

        /* Tarjeta de solicitud */
        .request-card {
            background: rgba(255,255,255,0.03);
            border-radius: clamp(14px, 4vw, 16px);
            padding: clamp(16px, 4vw, 20px);
            margin-bottom: clamp(10px, 3vw, 12px);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .request-card:active {
            border-color: var(--primary);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .request-price {
            font-size: clamp(20px, 6vw, 24px);
            font-weight: 800;
            color: var(--success);
        }

        .request-route {
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 2.5vw, 12px);
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .route-point {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2.5vw, 12px);
            font-size: clamp(12px, 3.5vw, 14px);
        }

        .route-dot {
            width: clamp(8px, 2.5vw, 12px);
            height: clamp(8px, 2.5vw, 12px);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .route-dot.pickup { background: var(--primary); }
        .route-dot.dest { background: var(--danger); }

        /* Viaje actual */
        .current-trip-card {
            background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(123,44,191,0.1));
            border: 2px solid var(--primary);
            border-radius: clamp(14px, 4vw, 16px);
            padding: clamp(16px, 4vw, 20px);
            margin-bottom: clamp(16px, 4vw, 20px);
            display: none;
        }

        .current-trip-card.active {
            display: block;
        }

        .trip-status {
            text-align: center;
            font-size: clamp(14px, 4vw, 16px);
            font-weight: 700;
            color: var(--primary);
            margin-bottom: clamp(12px, 3vw, 16px);
            text-transform: uppercase;
            padding: clamp(6px, 2vw, 8px);
            background: rgba(0,212,255,0.1);
            border-radius: clamp(6px, 2vw, 8px);
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: clamp(12px, 3vw, 16px);
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .client-photo {
            width: clamp(50px, 14vw, 60px);
            height: clamp(50px, 14vw, 60px);
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .trip-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(8px, 2.5vw, 12px);
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .trip-info-item {
            background: rgba(255,255,255,0.03);
            padding: clamp(8px, 2.5vw, 10px);
            border-radius: clamp(8px, 2.5vw, 10px);
            text-align: center;
        }

        .trip-info-label {
            font-size: clamp(9px, 2.5vw, 10px);
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: clamp(2px, 1vw, 4px);
        }

        .trip-info-value {
            font-size: clamp(12px, 3.5vw, 14px);
            font-weight: 700;
            color: var(--success);
        }

        .trip-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(6px, 2vw, 8px);
            margin-top: clamp(12px, 3vw, 16px);
        }

        .trip-buttons .btn {
            margin: 0;
            padding: clamp(10px, 3vw, 12px);
            font-size: clamp(11px, 3vw, 12px);
        }

        /* Ofertas de conductores */
        .driver-offers-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            padding: clamp(16px, 4vw, 20px);
        }

        .driver-offers-modal.active {
            display: block;
        }

        .offers-header {
            text-align: center;
            margin-bottom: clamp(20px, 5vw, 24px);
            padding-top: clamp(30px, 8vh, 40px);
        }

        .offers-header h2 {
            font-size: clamp(20px, 6vw, 24px);
            margin-bottom: clamp(4px, 2vw, 8px);
        }

        .driver-offer-card {
            background: rgba(255,255,255,0.03);
            border-radius: clamp(14px, 4vw, 16px);
            padding: clamp(16px, 4vw, 20px);
            margin-bottom: clamp(12px, 3vw, 16px);
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .driver-offer-card:active {
            border-color: var(--primary);
        }

        .offer-timer {
            position: absolute;
            top: 0;
            left: 0;
            height: 4px;
            background: var(--success);
            transition: width 1s linear;
        }

        .offer-timer.warning { background: var(--warning); }
        .offer-timer.danger { background: var(--danger); }

        .driver-offer-header {
            display: flex;
            align-items: center;
            gap: clamp(12px, 3vw, 16px);
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .driver-offer-photo {
            width: clamp(50px, 14vw, 60px);
            height: clamp(50px, 14vw, 60px);
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .offer-price {
            font-size: clamp(28px, 8vw, 32px);
            font-weight: 800;
            color: var(--success);
            text-align: center;
            margin: clamp(12px, 3vw, 16px) 0;
        }

        .offer-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(8px, 2.5vw, 12px);
        }

        /* Chat Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            align-items: flex-end;
        }

        .modal-overlay.active {
            display: flex;
        }

        .chat-container {
            width: 100%;
            height: 80vh;
            background: var(--surface);
            border-radius: clamp(24px, 6vw, 32px) clamp(24px, 6vw, 32px) 0 0;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: clamp(16px, 4vw, 20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: clamp(8px, 2.5vw, 12px);
        }

        .chat-header img {
            width: clamp(36px, 10vw, 40px);
            height: clamp(36px, 10vw, 40px);
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: clamp(16px, 4vw, 20px);
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 2.5vw, 12px);
        }

        .message {
            max-width: 80%;
            padding: clamp(8px, 2.5vw, 12px) clamp(12px, 3vw, 16px);
            border-radius: clamp(12px, 3vw, 16px);
            font-size: clamp(13px, 3.5vw, 14px);
            line-height: 1.4;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--primary);
            color: #000;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background: rgba(255,255,255,0.1);
            border-bottom-left-radius: 4px;
        }

        .chat-input {
            padding: clamp(12px, 3vw, 16px);
            border-top: 1px solid var(--border);
            display: flex;
            gap: clamp(8px, 2.5vw, 10px);
        }

        .chat-input input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: clamp(20px, 5vw, 24px);
            padding: clamp(10px, 3vw, 12px) clamp(16px, 4vw, 20px);
            color: var(--text);
            font-size: clamp(14px, 4vw, 15px);
            outline: none;
        }

        .chat-input button {
            width: clamp(44px, 12vw, 48px);
            height: clamp(44px, 12vw, 48px);
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 4.5vw, 18px);
        }

        /* Calificaciones */
        .rating-section {
            background: rgba(255,255,255,0.03);
            border-radius: clamp(14px, 4vw, 16px);
            padding: clamp(16px, 4vw, 20px);
            margin-bottom: clamp(16px, 4vw, 20px);
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: clamp(8px, 2.5vw, 12px);
            margin: clamp(12px, 3vw, 16px) 0;
        }

        .star-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.2);
            font-size: clamp(30px, 8vw, 40px);
            cursor: pointer;
            transition: all 0.2s;
        }

        .star-btn.active {
            color: var(--warning);
        }

        .rating-count {
            text-align: center;
            font-size: clamp(12px, 3.5vw, 14px);
            color: var(--text-secondary);
        }

        /* Navegación */
        .nav-instructions-overlay {
            position: fixed;
            bottom: clamp(20px, 5vh, 30px);
            left: clamp(12px, 3vw, 20px);
            right: clamp(12px, 3vw, 20px);
            background: var(--surface);
            border-radius: clamp(16px, 4vw, 20px);
            padding: clamp(16px, 4vw, 20px);
            z-index: 900;
            display: none;
            border: 1px solid rgba(0,212,255,0.3);
            box-shadow: var(--shadow);
        }

        .nav-instructions-overlay.active {
            display: block;
        }

        .nav-step {
            display: flex;
            align-items: center;
            gap: clamp(12px, 3vw, 16px);
        }

        .nav-step-icon {
            width: clamp(44px, 12vw, 50px);
            height: clamp(44px, 12vw, 50px);
            background: rgba(0,212,255,0.1);
            border-radius: clamp(10px, 3vw, 12px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(20px, 5.5vw, 24px);
            color: var(--primary);
        }

        .nav-step-text {
            flex: 1;
        }

        .nav-step-main {
            font-size: clamp(14px, 4vw, 16px);
            font-weight: 700;
            margin-bottom: clamp(2px, 1vw, 4px);
        }

        .nav-step-sub {
            font-size: clamp(11px, 3vw, 12px);
            color: var(--text-secondary);
        }

        .nav-step-distance {
            text-align: right;
        }

        .nav-step-distance-value {
            font-size: clamp(20px, 5.5vw, 24px);
            font-weight: 800;
            color: var(--primary);
        }

        /* SOS Button */
        .sos-button {
            position: fixed;
            bottom: clamp(100px, 20vh, 120px);
            right: clamp(12px, 3vw, 16px);
            width: clamp(50px, 14vw, 60px);
            height: clamp(50px, 14vw, 60px);
            background: var(--danger);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: clamp(12px, 3.5vw, 14px);
            font-weight: 800;
            cursor: pointer;
            z-index: 900;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(255,0,85,0.4);
        }

        .sos-button.active {
            display: flex;
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 4000;
            display: none;
            overflow-y: auto;
        }

        .profile-modal.active {
            display: block;
        }

        .profile-content {
            max-width: 500px;
            margin: 0 auto;
            padding: clamp(16px, 4vw, 20px);
        }

        .profile-header {
            text-align: center;
            margin-bottom: clamp(24px, 6vw, 32px);
            position: relative;
        }

        .profile-photo-large {
            width: clamp(100px, 28vw, 120px);
            height: clamp(100px, 28vw, 120px);
            border-radius: 50%;
            border: 4px solid var(--primary);
            object-fit: cover;
            margin-bottom: clamp(12px, 3vw, 16px);
        }

        .edit-photo-btn {
            position: absolute;
            bottom: clamp(16px, 4vw, 20px);
            right: calc(50% - 50px);
            width: clamp(32px, 9vw, 36px);
            height: clamp(32px, 9vw, 36px);
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--dark);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loading-screen.active {
            display: flex;
        }

        .loading-spinner {
            width: clamp(50px, 14vw, 60px);
            height: clamp(50px, 14vw, 60px);
            border: 3px solid rgba(0,212,255,0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: clamp(16px, 4vw, 20px);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: clamp(100px, 20vh, 120px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: var(--text);
            padding: clamp(12px, 3vw, 16px) clamp(20px, 5vw, 24px);
            border-radius: clamp(10px, 3vw, 12px);
            border: 1px solid rgba(0,212,255,0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: clamp(8px, 2.5vw, 12px);
            font-weight: 600;
            font-size: clamp(13px, 3.5vw, 14px);
            box-shadow: var(--shadow);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Botón de repetir asistente */
        .repeat-assistant {
            position: fixed;
            bottom: clamp(100px, 20vh, 120px);
            left: clamp(12px, 3vw, 16px);
            width: clamp(44px, 12vw, 50px);
            height: clamp(44px, 12vw, 50px);
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 50%;
            color: var(--primary);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 900;
            font-size: clamp(18px, 5vw, 20px);
            box-shadow: 0 4px 15px rgba(0,212,255,0.3);
        }

        .repeat-assistant.active {
            display: flex;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .trip-info-grid {
                grid-template-columns: 1fr;
            }
            
            .trip-buttons {
                grid-template-columns: 1fr;
            }
            
            .offer-actions {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .driver-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .stat-card:last-child {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Auth Screen -->
    <div id="authScreen" class="screen active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="logo-big">
                    <i class="fas fa-car"></i>
                </div>
                <h1>RETOM</h1>
                <p>Transporte inteligente con asistente virtual</p>

                <div class="role-selector">
                    <div class="role-btn active" onclick="selectRole('cliente')" id="role-cliente">
                        <i class="fas fa-user"></i>
                        <div>Cliente</div>
                    </div>
                    <div class="role-btn" onclick="selectRole('conductor')" id="role-conductor">
                        <i class="fas fa-car"></i>
                        <div>Conductor</div>
                    </div>
                </div>

                <div id="loginForm">
                    <div class="input-group">
                        <label>Correo electrónico</label>
                        <input type="email" class="input" id="email" placeholder="tu@email.com">
                    </div>
                    <div class="input-group">
                        <label>Contraseña</label>
                        <input type="password" class="input" id="password" placeholder="••••••••">
                    </div>
                    <button class="btn" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                    <button class="btn btn-secondary" onclick="showRegister()">
                        <i class="fas fa-user-plus"></i> Crear cuenta
                    </button>
                </div>

                <div id="registerForm" style="display: none;">
                    <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                        <img id="previewPhoto" style="display: none;">
                        <i class="fas fa-camera" id="cameraIcon"></i>
                        <span>Foto de perfil</span>
                        <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoSelect(event)">
                    </div>
                    
                    <div class="input-group">
                        <label>Nombre completo</label>
                        <input type="text" class="input" id="regName" placeholder="Juan Pérez">
                    </div>
                    <div class="input-group">
                        <label>Correo electrónico</label>
                        <input type="email" class="input" id="regEmail" placeholder="tu@email.com">
                    </div>
                    <div class="input-group">
                        <label>Teléfono</label>
                        <input type="tel" class="input" id="regPhone" placeholder="809-555-1234">
                    </div>
                    <div class="input-group">
                        <label>Contraseña</label>
                        <input type="password" class="input" id="regPassword" placeholder="••••••••">
                    </div>
                    <div class="input-group" id="driverRegFields" style="display: none;">
                        <label>Placa del vehículo</label>
                        <input type="text" class="input" id="regPlate" placeholder="A123456">
                    </div>
                    <div class="input-group" id="driverRegFields2" style="display: none;">
                        <label>Modelo del vehículo</label>
                        <input type="text" class="input" id="regModel" placeholder="Toyota Corolla 2020">
                    </div>
                    <div class="input-group" id="driverRegFields3" style="display: none;">
                        <label>Color del vehículo</label>
                        <input type="text" class="input" id="regColor" placeholder="Rojo">
                    </div>
                    <button class="btn" onclick="register()">
                        <i class="fas fa-user-plus"></i> Registrarse
                    </button>
                    <button class="btn btn-secondary" onclick="showLogin()">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="screen">
        <div id="map"></div>

        <!-- Header Superior con Menú -->
        <div class="top-header">
            <div class="header-logo">RETOM</div>
            <div class="header-menu">
                <div class="user-pill" onclick="toggleMenu()">
                    <img id="headerPhoto" src="https://via.placeholder.com/32" style="display: none;">
                    <i class="fas fa-user-circle" id="headerIcon"></i>
                    <span id="userName">Usuario</span>
                    <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
                </div>
            </div>
        </div>

        <!-- Menú desplegable -->
        <div class="dropdown-menu" id="dropdownMenu">
            <div class="menu-item" onclick="openProfile()">
                <i class="fas fa-user"></i>
                <span>Mi Perfil</span>
            </div>
            <div class="menu-item" onclick="toggleTheme()">
                <i class="fas fa-moon" id="themeIcon"></i>
                <span>Modo Oscuro/Claro</span>
            </div>
            <div class="menu-item" onclick="openHistory()">
                <i class="fas fa-history"></i>
                <span>Historial de Viajes</span>
            </div>
            <div class="menu-item" onclick="openRatings()">
                <i class="fas fa-star"></i>
                <span>Mis Calificaciones</span>
            </div>
            <div class="menu-item" onclick="openSupport()">
                <i class="fas fa-headset"></i>
                <span>Soporte</span>
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </div>
        </div>

        <!-- Floating Status -->
        <div class="floating-status" id="floatingStatus">
            <i class="fas fa-route"></i>
            <span id="floatingStatusText">En camino al destino</span>
        </div>

        <!-- Botón repetir asistente -->
        <div class="repeat-assistant" id="repeatAssistant" onclick="repeatLastInstruction()">
            <i class="fas fa-volume-up"></i>
        </div>

        <!-- SOS Button -->
        <button class="sos-button" id="sosButton" onclick="triggerSOS()">
            SOS
        </button>

        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" onclick="toggleMapType()" title="Cambiar vista">
                <i class="fas fa-layer-group"></i>
            </button>
            <button class="map-control-btn" onclick="centerOnUser()" title="Mi ubicación">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="map-control-btn" id="audioControlBtn" onclick="toggleAudio()" title="Asistente por voz">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>

        <!-- Panel Cliente -->
        <div class="search-panel" id="clientPanel">
            <div class="panel-handle" onclick="toggleClientPanel()"></div>
            <button class="panel-toggle" onclick="toggleClientPanel()">
                <i class="fas fa-chevron-down" id="clientPanelToggleIcon"></i>
            </button>
            
            <div class="location-inputs">
                <div class="location-row">
                    <div class="location-icon pickup">
                        <i class="fas fa-dot-circle"></i>
                    </div>
                    <input type="text" class="location-input" id="pickupInput" 
                           placeholder="¿Dónde te recogemos?" 
                           autocomplete="off"
                           readonly onclick="showLocationSearch('pickup')">
                    <button class="location-btn" onclick="showMapSelection('pickup')" title="Seleccionar en mapa">
                        <i class="fas fa-map"></i>
                    </button>
                </div>
                
                <div class="location-row">
                    <div class="location-icon dest">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <input type="text" class="location-input" id="destInput" 
                           placeholder="¿A dónde vas?" 
                           autocomplete="off"
                           readonly onclick="showLocationSearch('dest')">
                    <button class="location-btn" onclick="showMapSelection('dest')" title="Seleccionar en mapa">
                        <i class="fas fa-map"></i>
                    </button>
                </div>
            </div>

            <!-- Panel de búsqueda de direcciones -->
            <div id="locationSearchPanel" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <input type="text" class="input" id="searchLocationInput" 
                           placeholder="Buscar dirección..." 
                           onkeyup="searchLocation()">
                    <button class="btn" style="width: auto; padding: 12px 20px;" onclick="hideLocationSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="searchResults" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div class="suggestions" id="suggestions"></div>

            <div class="price-section" id="priceSection" style="display: none;">
                <div class="price-header">
                    <div class="price-label">Tu oferta</div>
                    <div class="price-current" id="currentPrice">RD$ 150</div>
                </div>
                
                <div class="price-input-group">
                    <input type="number" class="price-input" id="clientOffer" placeholder="Precio manual" value="150">
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                    Precio recomendado: <span id="recommendedPrice">RD$ 150</span>
                </div>
            </div>

            <button class="btn find-driver-btn" id="findDriverBtn" onclick="findDriver()" style="display: none;">
                <i class="fas fa-search"></i> Buscar Conductor
            </button>

            <!-- Info del conductor asignado -->
            <div class="driver-info-card" id="driverInfoCard">
                <div class="driver-profile">
                    <img id="driverPhoto" class="driver-photo" src="https://via.placeholder.com/60">
                    <div class="driver-details">
                        <h3 id="driverName">Conductor</h3>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                            <span style="color: var(--text-secondary); margin-left: 8px;" id="driverTrips">120 viajes</span>
                        </div>
                    </div>
                </div>
                <div class="driver-actions">
                    <button class="btn-message" onclick="openChat()">
                        <i class="fas fa-comment"></i> Mensaje
                    </button>
                    <button class="btn-cancel" onclick="showCancelModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
                <!-- Calificación al conductor -->
                <div id="rateDriverSection" style="display: none; margin-top: 16px;">
                    <div style="text-align: center; margin-bottom: 8px;">Califica a tu conductor</div>
                    <div class="rating-stars" id="driverRatingStars">
                        <button class="star-btn" onclick="rateDriver(1)">★</button>
                        <button class="star-btn" onclick="rateDriver(2)">★</button>
                        <button class="star-btn" onclick="rateDriver(3)">★</button>
                        <button class="star-btn" onclick="rateDriver(4)">★</button>
                        <button class="star-btn" onclick="rateDriver(5)">★</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ofertas de conductores -->
        <div class="driver-offers-modal" id="driverOffersModal">
            <div class="offers-header">
                <h2>Conductores disponibles</h2>
                <p>Elige la mejor oferta</p>
            </div>
            <div id="driverOffersList"></div>
            <button class="btn btn-secondary" onclick="closeDriverOffers()" style="margin-top: 20px;">
                <i class="fas fa-times"></i> Cancelar búsqueda
            </button>
        </div>

        <!-- Panel Conductor -->
        <div class="driver-panel" id="driverPanel">
            <div class="panel-handle" onclick="toggleDriverPanel()"></div>
            <div class="driver-panel-header">
                <h3>Panel de Conductor</h3>
                <button class="driver-panel-toggle" onclick="toggleDriverPanel()">
                    <i class="fas fa-chevron-down" id="driverPanelToggleIcon"></i>
                </button>
            </div>
            
            <!-- Estadísticas -->
            <div class="driver-stats">
                <div class="stat-card">
                    <div class="stat-value" id="statRating">5.0</div>
                    <div class="stat-label">Calificación</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTrips">0</div>
                    <div class="stat-label">Viajes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statEarnings">RD$0</div>
                    <div class="stat-label">Ganancias</div>
                </div>
            </div>

            <!-- Ganancias -->
            <div class="earnings-section">
                <div class="earnings-header">
                    <span class="earnings-title">Ganancias</span>
                    <i class="fas fa-wallet" style="color: var(--success);"></i>
                </div>
                <div class="earnings-amount" id="earningsAmount">RD$ 0</div>
                <div class="earnings-period">
                    <button class="period-btn active" onclick="setEarningsPeriod('day')">Hoy</button>
                    <button class="period-btn" onclick="setEarningsPeriod('week')">Semana</button>
                    <button class="period-btn" onclick="setEarningsPeriod('month')">Mes</button>
                </div>
            </div>

            <!-- Viaje actual -->
            <div class="current-trip-card" id="currentTripCard">
                <div class="trip-status" id="tripStatus">Viaje en Progreso</div>
                <div class="client-info">
                    <img id="clientPhoto" class="client-photo" src="https://via.placeholder.com/60">
                    <div>
                        <h4 id="clientName" style="margin: 0 0 4px 0;">Cliente</h4>
                        <div style="color: var(--text-secondary); font-size: clamp(12px, 3.5vw, 14px);">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary);"></i> 
                            <span id="clientDistance">Calculando...</span>
                        </div>
                    </div>
                </div>
                
                <div class="trip-info-grid">
                    <div class="trip-info-item">
                        <div class="trip-info-label">Distancia</div>
                        <div class="trip-info-value" id="tripDistance">-- km</div>
                    </div>
                    <div class="trip-info-item">
                        <div class="trip-info-label">Ganancia</div>
                        <div class="trip-info-value" id="tripEarnings">RD$ --</div>
                    </div>
                    <div class="trip-info-item">
                        <div class="trip-info-label">Tiempo Est.</div>
                        <div class="trip-info-value" id="tripTime">-- min</div>
                    </div>
                    <div class="trip-info-item">
                        <div class="trip-info-label">Pago</div>
                        <div class="trip-info-value">Efectivo</div>
                    </div>
                </div>

                <div class="request-route" style="margin-bottom: 16px;">
                    <div class="route-point">
                        <div class="route-dot pickup"></div>
                        <span id="tripPickup">Origen</span>
                    </div>
                    <div class="route-point">
                        <div class="route-dot dest"></div>
                        <span id="tripDest">Destino</span>
                    </div>
                </div>

                <div class="trip-buttons">
                    <button class="btn btn-success" id="btnLlegue" onclick="driverArrived()" style="display: none;">
                        <i class="fas fa-check-circle"></i> Llegué
                    </button>
                    <button class="btn btn-success" id="btnIniciar" onclick="startTrip()" style="display: none;">
                        <i class="fas fa-play"></i> Iniciar
                    </button>
                    <button class="btn btn-success" id="btnFinalizar" onclick="endTrip()" style="display: none;">
                        <i class="fas fa-flag-checkered"></i> Finalizar
                    </button>
                    <button class="btn-message" onclick="openChat()">
                        <i class="fas fa-comment"></i> Chat
                    </button>
                    <button class="btn-cancel" onclick="showCancelModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>

                <!-- Calificación al cliente -->
                <div id="rateClientSection" style="display: none; margin-top: 16px;">
                    <div style="text-align: center; margin-bottom: 8px;">Califica al cliente</div>
                    <div class="rating-stars" id="clientRatingStars">
                        <button class="star-btn" onclick="rateClient(1)">★</button>
                        <button class="star-btn" onclick="rateClient(2)">★</button>
                        <button class="star-btn" onclick="rateClient(3)">★</button>
                        <button class="star-btn" onclick="rateClient(4)">★</button>
                        <button class="star-btn" onclick="rateClient(5)">★</button>
                    </div>
                </div>
            </div>

            <!-- Estado toggle -->
            <div class="status-toggle">
                <div class="status-text offline" id="statusText">Desconectado</div>
                <div class="toggle-switch" id="toggleSwitch" onclick="toggleStatus()"></div>
            </div>

            <!-- Lista de solicitudes -->
            <div id="requestsList">
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-wifi" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                    Activa tu disponibilidad
                </div>
            </div>
        </div>

        <!-- Instrucciones de navegación -->
        <div class="nav-instructions-overlay" id="navOverlay">
            <div class="nav-step">
                <div class="nav-step-icon">
                    <i class="fas fa-arrow-up" id="navStepIcon"></i>
                </div>
                <div class="nav-step-text">
                    <div class="nav-step-main" id="navStepMain">Continúa recto</div>
                    <div class="nav-step-sub" id="navStepSub">En 200 metros gira</div>
                </div>
                <div class="nav-step-distance">
                    <div class="nav-step-distance-value" id="navStepDistance">200</div>
                    <div style="font-size: 10px; color: var(--text-secondary);">m</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal-overlay" id="chatModal" onclick="closeChat(event)">
        <div class="chat-container" onclick="event.stopPropagation()">
            <div class="chat-header">
                <img id="chatPhoto" src="https://via.placeholder.com/40">
                <div>
                    <div style="font-weight: 700;" id="chatName">Usuario</div>
                    <div style="font-size: 11px; color: var(--success);">
                        <i class="fas fa-circle"></i> En línea
                    </div>
                </div>
                <button style="margin-left: auto; background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer;" onclick="closeChat()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Modal -->
    <div class="cancel-modal" id="cancelModal">
        <div class="cancel-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Cancelar Viaje</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">¿Por qué deseas cancelar?</p>
            <div class="cancel-reasons">
                <button class="cancel-reason-btn" onclick="cancelTrip('Tiempo de espera')">
                    <i class="fas fa-clock"></i> Tiempo de espera
                </button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Cambio de planes')">
                    <i class="fas fa-calendar-times"></i> Cambio de planes
                </button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Conductor no llega')">
                    <i class="fas fa-car-crash"></i> Conductor no llega
                </button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Cliente no responde')">
                    <i class="fas fa-user-slash"></i> Cliente no responde
                </button>
                <button class="cancel-reason-btn" onclick="cancelTrip('Otro')">
                    <i class="fas fa-question-circle"></i> Otro motivo
                </button>
            </div>
            <button class="btn btn-secondary" onclick="closeCancelModal()" style="margin-top: 10px;">
                Volver
            </button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <div class="profile-header">
                <img id="profilePhotoLarge" class="profile-photo-large" src="https://via.placeholder.com/120">
                <button class="edit-photo-btn" onclick="document.getElementById('editPhotoInput').click()">
                    <i class="fas fa-camera"></i>
                </button>
                <input type="file" id="editPhotoInput" style="display: none;" accept="image/*" onchange="updateProfilePhoto(event)">
                <h2 id="profileName">Nombre</h2>
                <p style="color: var(--text-secondary);" id="profileEmail">email@example.com</p>
            </div>

            <div class="auth-card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Editar Perfil</h3>
                
                <div class="input-group">
                    <label>Nombre</label>
                    <input type="text" class="input" id="editName">
                </div>
                
                <div class="input-group">
                    <label>Teléfono</label>
                    <input type="tel" class="input" id="editPhone">
                </div>
                
                <div class="input-group" id="driverEditFields" style="display: none;">
                    <label>Placa del vehículo</label>
                    <input type="text" class="input" id="editPlate">
                </div>
                
                <div class="input-group" id="driverEditFields2" style="display: none;">
                    <label>Modelo del vehículo</label>
                    <input type="text" class="input" id="editModel">
                </div>
                
                <div class="input-group" id="driverEditFields3" style="display: none;">
                    <label>Color del vehículo</label>
                    <input type="text" class="input" id="editColor">
                </div>

                <button class="btn" onclick="saveProfile()">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
                <button class="btn btn-secondary" onclick="closeProfile()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div style="color: var(--text-secondary);">Cargando...</div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Scripts -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSHIYTEhTeXUNC4g5f_mBJ52CiP4H57XY&libraries=places,geometry,drawing"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc,
            onSnapshot,
            query,
            where,
            addDoc,
            serverTimestamp,
            deleteDoc,
            getDocs,
            orderBy,
            increment,
            limit 
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAMTWJr3mISmNiP-e_KjCO9BdBPi7Uuug4",
            authDomain: "formulario-2-8929a.firebaseapp.com",
            projectId: "formulario-2-8929a",
            storageBucket: "formulario-2-8929a.appspot.com",
            messagingSenderId: "136908102526",
            appId: "1:136908102526:web:d0a3bc1e3cb91a3fcab12f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let map = null;
        let directionsService = null;
        let directionsRenderer = null;
        let userRole = 'cliente';
        let currentUser = null;
        let userData = null;
        let currentTrip = null;
        let selectedPhoto = null;
        let audioEnabled = true;
        let mapType = 'dark';
        let theme = 'dark';
        let chatUnsubscribe = null;
        let tripUnsubscribe = null;
        let offersUnsubscribe = null;
        let driverOffersTimers = {};
        let isClientPanelHidden = false;
        let isDriverPanelHidden = false;
        let earningsPeriod = 'day';
        let mapClickMode = null;
        let currentLocationMode = null;
        let watchId = null;
        let isNavigating = false;
        let steps = [];
        let currentStepIndex = 0;
        let lastInstruction = '';
        let driverMarkers = [];
        
        let markers = {
            user: null,
            pickup: null,
            destination: null,
            driver: null,
            client: null
        };
        
        let locations = {
            pickup: null,
            destination: null,
            current: null
        };
        
        let isOnline = false;

        // ==========================================
        // AUTENTICACIÓN
        // ==========================================
        
        window.selectRole = function(role) {
            userRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`role-${role}`).classList.add('active');
            
            // Mostrar campos adicionales para conductor
            if (role === 'conductor') {
                document.getElementById('driverRegFields').style.display = 'block';
                document.getElementById('driverRegFields2').style.display = 'block';
                document.getElementById('driverRegFields3').style.display = 'block';
            } else {
                document.getElementById('driverRegFields').style.display = 'none';
                document.getElementById('driverRegFields2').style.display = 'none';
                document.getElementById('driverRegFields3').style.display = 'none';
            }
        };

        window.showRegister = function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        };

        window.showLogin = function() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        };

        window.handlePhotoSelect = function(event) {
            const file = event.target.files[0];
            if (file) {
                selectedPhoto = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewPhoto').src = e.target.result;
                    document.getElementById('previewPhoto').style.display = 'block';
                    document.getElementById('cameraIcon').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        };

        window.login = async function() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!email || !password) {
                showToast('Completa todos los campos', 'error');
                return;
            }
            
            showLoading(true);
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
            } catch (error) {
                console.error('Login error:', error);
                let msg = 'Credenciales incorrectas';
                if (error.code === 'auth/user-not-found') msg = 'Usuario no encontrado';
                if (error.code === 'auth/wrong-password') msg = 'Contraseña incorrecta';
                showToast(msg, 'error');
                showLoading(false);
            }
        };

        window.register = async function() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;
            const plate = document.getElementById('regPlate')?.value.trim() || '';
            const model = document.getElementById('regModel')?.value.trim() || '';
            const color = document.getElementById('regColor')?.value.trim() || '';
            
            if (!name || !email || !phone || !password) {
                showToast('Completa todos los campos', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('La contraseña debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            showLoading(true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                currentUser = user;
                
                let photoURL = null;
                if (selectedPhoto) {
                    try {
                        const storageRef = ref(storage, `profiles/${user.uid}`);
                        await uploadBytes(storageRef, selectedPhoto);
                        photoURL = await getDownloadURL(storageRef);
                        await updateProfile(user, { photoURL });
                    } catch (storageError) {
                        console.warn('Error subiendo foto:', storageError);
                    }
                }
                
                const userDataToSave = {
                    uid: user.uid,
                    nombre: name,
                    email: email,
                    telefono: phone,
                    rol: userRole,
                    photoURL: photoURL,
                    calificacion: 5.0,
                    totalCalificaciones: 0,
                    sumaCalificaciones: 0,
                    creado: serverTimestamp()
                };
                
                await setDoc(doc(db, 'usuarios', user.uid), userDataToSave);
                
                if (userRole === 'conductor') {
                    await setDoc(doc(db, 'conductores', user.uid), {
                        uid: user.uid,
                        nombre: name,
                        telefono: phone,
                        photoURL: photoURL,
                        disponible: false,
                        enViaje: false,
                        ubicacion: null,
                        calificacion: 5.0,
                        viajesCompletados: 0,
                        gananciasTotal: 0,
                        gananciasDia: 0,
                        gananciasSemana: 0,
                        gananciasMes: 0,
                        placa: plate,
                        modelo: model,
                        color: color,
                        actualizado: serverTimestamp()
                    });
                }
                
                showToast('Cuenta creada exitosamente');
                
            } catch (error) {
                console.error('Register error:', error);
                let msg = 'Error al crear cuenta';
                if (error.code === 'auth/email-already-in-use') {
                    msg = 'Este email ya está registrado';
                }
                showToast(msg, 'error');
                showLoading(false);
            }
        };

        window.logout = async function() {
            try {
                if (userRole === 'conductor' && isOnline && currentUser) {
                    await updateDoc(doc(db, 'conductores', currentUser.uid), {
                        disponible: false
                    });
                }
                if (chatUnsubscribe) chatUnsubscribe();
                if (tripUnsubscribe) tripUnsubscribe();
                if (offersUnsubscribe) offersUnsubscribe();
                await signOut(auth);
                location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                location.reload();
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
            } else {
                showLoading(false);
            }
        });

        async function loadUserData() {
            try {
                if (!currentUser) return;

                const docSnap = await getDoc(doc(db, 'usuarios', currentUser.uid));
                
                if (!docSnap.exists()) {
                    showToast('Error: Perfil no encontrado', 'error');
                    await signOut(auth);
                    return;
                }
                
                userData = docSnap.data();
                userRole = userData.rol || 'cliente';
                
                document.getElementById('userName').textContent = userData.nombre || 'Usuario';
                
                if (userData.photoURL) {
                    document.getElementById('headerPhoto').src = userData.photoURL;
                    document.getElementById('headerPhoto').style.display = 'block';
                    document.getElementById('headerIcon').style.display = 'none';
                }
                
                document.getElementById('authScreen').classList.remove('active');
                document.getElementById('mainScreen').classList.add('active');
                
                await restoreAppState();
                initMap();
                
                if (userRole === 'conductor') {
                    document.getElementById('driverPanel').classList.add('active');
                    document.getElementById('driverEditFields').style.display = 'block';
                    document.getElementById('driverEditFields2').style.display = 'block';
                    document.getElementById('driverEditFields3').style.display = 'block';
                    loadDriverStats();
                } else {
                    document.getElementById('clientPanel').classList.add('active');
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error al cargar perfil', 'error');
                showLoading(false);
            }
        }

        // ==========================================
        // PERSISTENCIA
        // ==========================================

        async function saveAppState() {
            if (!currentUser) return;
            
            const state = {
                userRole,
                locations,
                currentTrip: currentTrip ? { id: currentTrip.id } : null,
                isOnline,
                timestamp: Date.now()
            };
            
            localStorage.setItem(`appState_${currentUser.uid}`, JSON.stringify(state));
            
            try {
                await setDoc(doc(db, 'estados', currentUser.uid), {
                    ...state,
                    actualizado: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.log('Error guardando estado:', e);
            }
        }

        async function restoreAppState() {
            if (!currentUser) return;
            
            try {
                const stateDoc = await getDoc(doc(db, 'estados', currentUser.uid));
                let state = null;
                
                if (stateDoc.exists()) {
                    state = stateDoc.data();
                } else {
                    const localState = localStorage.getItem(`appState_${currentUser.uid}`);
                    if (localState) {
                        state = JSON.parse(localState);
                    }
                }
                
                if (state && state.currentTrip) {
                    const tripDoc = await getDoc(doc(db, 'viajes', state.currentTrip.id));
                    if (tripDoc.exists()) {
                        const tripData = tripDoc.data();
                        if (tripData.estado !== 'completado' && tripData.estado !== 'cancelado') {
                            currentTrip = { id: state.currentTrip.id, ...tripData };
                            
                            if (tripData.origen) {
                                locations.pickup = tripData.origen;
                                document.getElementById('pickupInput').value = tripData.origen.name || '';
                            }
                            if (tripData.destino) {
                                locations.destination = tripData.destino;
                                document.getElementById('destInput').value = tripData.destino.name || '';
                            }
                            
                            listenToTrip(state.currentTrip.id);
                        }
                    }
                }
                
                if (state && state.isOnline && userRole === 'conductor') {
                    isOnline = true;
                    document.getElementById('toggleSwitch').classList.add('active');
                    document.getElementById('statusText').textContent = 'Conectado';
                    document.getElementById('statusText').classList.remove('offline');
                    document.getElementById('statusText').classList.add('online');
                }
                
            } catch (error) {
                console.log('Error restaurando estado:', error);
            }
        }

        // ==========================================
        // MAPA
        // ==========================================
        
        function initMap() {
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: { 
                    strokeColor: "#00d4ff", 
                    strokeWeight: 5, 
                    strokeOpacity: 0.9
                }
            });

            const defaultCenter = locations.current || { lat: 18.4861, lng: -69.9312 };

            const styles = {
                dark: [
                    { elementType: "geometry", stylers: [{ color: "#212121" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#2c2c2c" }] },
                    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca3af" }] }
                ],
                light: [
                    { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] }
                ]
            };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: defaultCenter,
                disableDefaultUI: true,
                styles: styles.dark,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false,
                zoomControl: false
            });

            directionsRenderer.setMap(map);

            // Geolocalización
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    updateUserPosition(pos);
                    map.setCenter(pos);
                    
                    // Guardar como ubicación actual
                    document.getElementById('pickupInput').value = 'Mi ubicación actual';
                    locations.pickup = { lat: pos.lat, lng: pos.lng, name: 'Mi ubicación actual' };
                });

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateUserPosition(pos);
                        
                        if (isNavigating) {
                            checkVoiceNavigation(pos);
                        }
                        
                        if (userRole === 'conductor' && currentUser && isOnline) {
                            updateDoc(doc(db, 'conductores', currentUser.uid), {
                                ubicacion: pos,
                                actualizado: serverTimestamp()
                            }).catch(() => {});
                        }
                    },
                    (err) => console.log('GPS error:', err),
                    { enableHighAccuracy: true }
                );
            }

            // Click en mapa
            map.addListener("click", (e) => {
                if (isNavigating) return;
                
                if (mapClickMode === 'pickup') {
                    setPickup(e.latLng, null, true);
                    mapClickMode = null;
                    document.body.style.cursor = 'default';
                } else if (mapClickMode === 'dest') {
                    setDestination(e.latLng, null, true);
                    mapClickMode = null;
                    document.body.style.cursor = 'default';
                }
            });

            // Escuchar viajes activos
            if (userRole === 'conductor') {
                listenForTrips();
                listenForMyTrips();
            }
            
            showLoading(false);
        }

        function updateUserPosition(pos) {
            locations.current = pos;
            
            if (!markers.user) {
                markers.user = new google.maps.Marker({
                    map: map,
                    position: pos,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: "#00d4ff",
                        fillOpacity: 1,
                        strokeColor: "#ffffff",
                        strokeWeight: 3
                    },
                    zIndex: 1000
                });
            } else {
                markers.user.setPosition(pos);
            }
        }

        function setPickup(latLng, name = null, fromMap = false) {
            const pos = typeof latLng.lat === 'function' ? 
                { lat: latLng.lat(), lng: latLng.lng() } : latLng;
            
            locations.pickup = { lat: pos.lat, lng: pos.lng, name };
            
            if (fromMap && !name) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: pos }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        locations.pickup.name = results[0].formatted_address;
                        document.getElementById('pickupInput').value = results[0].formatted_address;
                    }
                });
            } else if (name) {
                document.getElementById('pickupInput').value = name;
            }
            
            if (markers.pickup) {
                markers.pickup.setMap(null);
            }
            
            markers.pickup = new google.maps.Marker({
                map: map,
                position: pos,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: "#00d4ff",
                    fillOpacity: 1,
                    strokeColor: "#ffffff",
                    strokeWeight: 3
                },
                title: 'Punto de recogida',
                zIndex: 900
            });
            
            map.panTo(pos);
            checkRoute();
            hideLocationSearch();
        }

        function setDestination(latLng, name = null, fromMap = false) {
            const pos = typeof latLng.lat === 'function' ? 
                { lat: latLng.lat(), lng: latLng.lng() } : latLng;
            
            locations.destination = { lat: pos.lat, lng: pos.lng, name };
            
            if (fromMap && !name) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: pos }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        locations.destination.name = results[0].formatted_address;
                        document.getElementById('destInput').value = results[0].formatted_address;
                    }
                });
            } else if (name) {
                document.getElementById('destInput').value = name;
            }
            
            if (markers.destination) {
                markers.destination.setMap(null);
            }
            
            markers.destination = new google.maps.Marker({
                map: map,
                position: pos,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: "#ff0055",
                    fillOpacity: 1,
                    strokeColor: "#ffffff",
                    strokeWeight: 3
                },
                title: 'Destino',
                zIndex: 800
            });
            
            map.panTo(pos);
            checkRoute();
            hideLocationSearch();
        }

        function checkRoute() {
            if (!locations.pickup || !locations.destination) return;
            
            directionsService.route({
                origin: locations.pickup,
                destination: locations.destination,
                travelMode: 'DRIVING'
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    steps = result.routes[0].legs[0].steps;
                    const leg = result.routes[0].legs[0];
                    
                    const distance = leg.distance.value;
                    const suggestedPrice = Math.max(50, Math.ceil(distance / 100) * 10);
                    
                    document.getElementById('currentPrice').textContent = `RD$ ${suggestedPrice}`;
                    document.getElementById('recommendedPrice').textContent = `RD$ ${suggestedPrice}`;
                    document.getElementById('clientOffer').value = suggestedPrice;
                    
                    document.getElementById('priceSection').style.display = 'block';
                    document.getElementById('findDriverBtn').style.display = 'flex';
                }
            });
        }

        // ==========================================
        // BÚSQUEDA DE DIRECCIONES
        // ==========================================

        window.showLocationSearch = function(mode) {
            currentLocationMode = mode;
            document.getElementById('locationSearchPanel').style.display = 'block';
            document.getElementById('searchLocationInput').focus();
        };

        window.hideLocationSearch = function() {
            document.getElementById('locationSearchPanel').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        };

        window.searchLocation = function() {
            const query = document.getElementById('searchLocationInput').value;
            if (!query) return;
            
            const service = new google.maps.places.AutocompleteService();
            service.getPlacePredictions({ 
                input: query,
                componentRestrictions: { country: 'do' }
            }, (predictions, status) => {
                if (status === 'OK') {
                    showSearchResults(predictions);
                }
            });
        };

        function showSearchResults(predictions) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            predictions.forEach(prediction => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.onclick = () => selectPlace(prediction.place_id);
                div.innerHTML = `
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="suggestion-text">
                        <div class="suggestion-main">${prediction.structured_formatting.main_text}</div>
                        <div class="suggestion-sub">${prediction.structured_formatting.secondary_text}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectPlace(placeId) {
            const service = new google.maps.places.PlacesService(map);
            service.getDetails({ placeId: placeId }, (place, status) => {
                if (status === 'OK' && place.geometry) {
                    if (currentLocationMode === 'pickup') {
                        setPickup(place.geometry.location, place.formatted_address);
                    } else {
                        setDestination(place.geometry.location, place.formatted_address);
                    }
                }
            });
        }

        window.showMapSelection = function(mode) {
            mapClickMode = mode;
            document.body.style.cursor = 'crosshair';
            showToast('Toca en el mapa para seleccionar la ubicación');
            hideLocationSearch();
        };

        // ==========================================
        // CONTROLES
        // ==========================================

        window.toggleMenu = function() {
            document.getElementById('dropdownMenu').classList.toggle('active');
        };

        window.toggleTheme = function() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', theme);
            document.getElementById('themeIcon').className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            
            // Actualizar mapa
            map.setOptions({
                styles: theme === 'dark' ? [
                    { elementType: "geometry", stylers: [{ color: "#212121" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#2c2c2c" }] }
                ] : []
            });
        };

        window.toggleMapType = function() {
            mapType = mapType === 'roadmap' ? 'satellite' : 'roadmap';
            map.setMapTypeId(mapType);
        };

        window.centerOnUser = function() {
            if (locations.current) {
                map.panTo(locations.current);
                map.setZoom(17);
            } else {
                showToast('Esperando señal GPS...', 'error');
            }
        };

        window.toggleClientPanel = function() {
            const panel = document.getElementById('clientPanel');
            const icon = document.getElementById('clientPanelToggleIcon');
            isClientPanelHidden = !isClientPanelHidden;
            
            if (isClientPanelHidden) {
                panel.classList.add('hidden');
                icon.className = 'fas fa-chevron-up';
            } else {
                panel.classList.remove('hidden');
                icon.className = 'fas fa-chevron-down';
            }
        };

        window.toggleDriverPanel = function() {
            const panel = document.getElementById('driverPanel');
            const icon = document.getElementById('driverPanelToggleIcon');
            isDriverPanelHidden = !isDriverPanelHidden;
            
            if (isDriverPanelHidden) {
                panel.classList.add('hidden');
                icon.className = 'fas fa-chevron-up';
            } else {
                panel.classList.remove('hidden');
                icon.className = 'fas fa-chevron-down';
            }
        };

        window.toggleAudio = function() {
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audioControlBtn');
            btn.innerHTML = audioEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            btn.classList.toggle('muted', !audioEnabled);
        };

        // ==========================================
        // ASISTENTE DE VOZ
        // ==========================================

        function speak(text) {
            if (!audioEnabled) return;
            lastInstruction = text;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'es-ES';
            msg.rate = 0.9;
            window.speechSynthesis.speak(msg);
            
            // Mostrar botón para repetir
            document.getElementById('repeatAssistant').classList.add('active');
        }

        window.repeatLastInstruction = function() {
            if (lastInstruction) {
                speak(lastInstruction);
            }
        };

        function checkVoiceNavigation(pos) {
            if (currentStepIndex < steps.length) {
                const step = steps[currentStepIndex];
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(pos.lat, pos.lng),
                    step.end_location
                );

                if (distance < 30) {
                    currentStepIndex++;
                    if (steps[currentStepIndex]) {
                        const instruction = cleanHtml(steps[currentStepIndex].instructions);
                        const distanceText = steps[currentStepIndex].distance.text;
                        speak(`A ${distanceText}, ${instruction}`);
                        
                        // Actualizar overlay
                        document.getElementById('navStepMain').textContent = instruction;
                        document.getElementById('navStepSub').textContent = `En ${distanceText}`;
                        document.getElementById('navStepIcon').className = getDirectionIcon(steps[currentStepIndex].maneuver);
                    } else {
                        speak("Has llegado a tu destino.");
                        isNavigating = false;
                        hideFloatingStatus();
                    }
                } else {
                    // Mostrar instrucción actual
                    document.getElementById('navStepMain').textContent = cleanHtml(step.instructions);
                    document.getElementById('navStepSub').textContent = `En ${step.distance.text}`;
                    document.getElementById('navStepDistance').textContent = step.distance.value;
                    document.getElementById('navStepIcon').className = getDirectionIcon(step.maneuver);
                }
            }
        }

        function getDirectionIcon(maneuver) {
            const icons = {
                'turn-left': 'fas fa-arrow-left',
                'turn-right': 'fas fa-arrow-right',
                'straight': 'fas fa-arrow-up',
                'merge': 'fas fa-code-branch',
                'fork': 'fas fa-code-branch',
                'ramp': 'fas fa-road',
                'roundabout': 'fas fa-sync-alt'
            };
            return icons[maneuver] || 'fas fa-arrow-up';
        }

        function cleanHtml(html) {
            const div = document.createElement("div");
            div.innerHTML = html;
            return div.textContent || div.innerText || "";
        }

        // ==========================================
        // CLIENTE - BUSCAR CONDUCTOR
        // ==========================================

        window.findDriver = async function() {
            if (!locations.pickup || !locations.destination) {
                showToast('Selecciona origen y destino', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('Error: Usuario no autenticado', 'error');
                return;
            }
            
            showLoading(true);
            
            const offerPrice = parseInt(document.getElementById('clientOffer').value) || 150;
            
            try {
                const tripData = {
                    clienteId: currentUser.uid,
                    clienteNombre: userData.nombre || 'Cliente',
                    clienteTelefono: userData.telefono || '',
                    clientePhoto: userData.photoURL || null,
                    origen: {
                        lat: locations.pickup.lat,
                        lng: locations.pickup.lng,
                        name: locations.pickup.name || 'Punto de recogida'
                    },
                    destino: {
                        lat: locations.destination.lat,
                        lng: locations.destination.lng,
                        name: locations.destination.name || 'Destino'
                    },
                    precioOfrecido: offerPrice,
                    precioNegociado: null,
                    estado: 'buscando',
                    creado: serverTimestamp(),
                    timestamp: Date.now()
                };
                
                const tripRef = await addDoc(collection(db, 'viajes'), tripData);
                
                currentTrip = { id: tripRef.id, ...tripData };
                await saveAppState();
                
                listenForDriverOffers(tripRef.id);
                
                document.getElementById('findDriverBtn').style.display = 'none';
                document.getElementById('priceSection').style.display = 'none';
                document.getElementById('driverOffersModal').classList.add('active');
                
                showToast('Buscando conductores...');
                
            } catch (error) {
                console.error('Find driver error:', error);
                showToast('Error al buscar conductor', 'error');
            } finally {
                showLoading(false);
            }
        };

        function listenForDriverOffers(tripId) {
            tripUnsubscribe = onSnapshot(doc(db, 'viajes', tripId), async (doc) => {
                if (!doc.exists()) return;
                
                const data = doc.data();
                
                if (data.estado === 'aceptado' && data.conductorId) {
                    document.getElementById('driverOffersModal').classList.remove('active');
                    
                    Object.values(driverOffersTimers).forEach(clearInterval);
                    driverOffersTimers = {};
                    
                    currentTrip = { id: tripId, ...data };
                    await saveAppState();
                    
                    showDriverInfo(data);
                    speak(`${data.conductorNombre} aceptó tu viaje`);
                    showToast(`¡${data.conductorNombre} aceptó tu viaje!`);
                    
                    startDriverTracking(data.conductorId);
                } else if (data.estado === 'conductor_llego') {
                    showToast('El conductor ha llegado', 'success');
                    speak('El conductor ha llegado a tu ubicación');
                } else if (data.estado === 'en_curso') {
                    showToast('Viaje iniciado', 'success');
                    showFloatingStatus('En camino al destino');
                    speak('Viaje iniciado, en camino al destino');
                } else if (data.estado === 'completado') {
                    showToast('Viaje completado', 'success');
                    hideFloatingStatus();
                    document.getElementById('rateDriverSection').style.display = 'block';
                } else if (data.estado === 'cancelado') {
                    showToast('Viaje cancelado', 'error');
                    hideFloatingStatus();
                    resetClientUI();
                }
            });
            
            // Escuchar ofertas
            const ofertasQuery = query(collection(db, 'viajes', tripId, 'ofertas'), orderBy('timestamp', 'desc'));
            
            offersUnsubscribe = onSnapshot(ofertasQuery, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const oferta = change.doc.data();
                        addDriverOfferToModal(oferta, change.doc.id, tripId);
                    }
                });
            });
        }

        function addDriverOfferToModal(oferta, ofertaId, tripId) {
            const container = document.getElementById('driverOffersList');
            
            if (document.getElementById(`offer-${ofertaId}`)) return;
            
            const offerCard = document.createElement('div');
            offerCard.id = `offer-${ofertaId}`;
            offerCard.className = 'driver-offer-card';
            offerCard.innerHTML = `
                <div class="offer-timer" id="timer-${ofertaId}"></div>
                <div class="driver-offer-header">
                    <img src="${oferta.conductorPhoto || 'https://via.placeholder.com/60'}" class="driver-offer-photo">
                    <div class="driver-offer-info">
                        <h3>${oferta.conductorNombre}</h3>
                        <div class="driver-offer-rating">
                            <i class="fas fa-star"></i> ${oferta.conductorRating || '4.8'}
                        </div>
                    </div>
                </div>
                <div class="offer-price">RD$ ${oferta.precioOfrecido}</div>
                <div class="offer-actions">
                    <button class="btn btn-success" onclick="acceptDriverOffer('${tripId}', '${oferta.conductorId}', ${oferta.precioOfrecido})">
                        Aceptar
                    </button>
                    <button class="btn btn-danger" onclick="rejectDriverOffer('${tripId}', '${ofertaId}')">
                        Rechazar
                    </button>
                </div>
            `;
            
            container.prepend(offerCard); // Poner al principio
            
            let timeLeft = 60;
            const timerBar = document.getElementById(`timer-${ofertaId}`);
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 60) * 100;
                timerBar.style.width = `${percentage}%`;
                
                if (percentage < 30) {
                    timerBar.classList.add('danger');
                } else if (percentage < 60) {
                    timerBar.classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    offerCard.remove();
                    delete driverOffersTimers[ofertaId];
                }
            }, 1000);
            
            driverOffersTimers[ofertaId] = timerInterval;
        }

        window.acceptDriverOffer = async function(tripId, conductorId, precio) {
            showLoading(true);
            
            try {
                await updateDoc(doc(db, 'viajes', tripId), {
                    estado: 'aceptado',
                    conductorId: conductorId,
                    precioNegociado: precio,
                    aceptado: serverTimestamp()
                });
                
                // Eliminar otras ofertas
                const ofertasSnapshot = await getDocs(collection(db, 'viajes', tripId, 'ofertas'));
                ofertasSnapshot.forEach(async (ofertaDoc) => {
                    if (ofertaDoc.data().conductorId !== conductorId) {
                        await deleteDoc(ofertaDoc.ref);
                    }
                });
                
                showToast('Conductor seleccionado');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al aceptar oferta', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.rejectDriverOffer = async function(tripId, ofertaId) {
            try {
                await deleteDoc(doc(db, 'viajes', tripId, 'ofertas', ofertaId));
                document.getElementById(`offer-${ofertaId}`)?.remove();
                
                if (driverOffersTimers[ofertaId]) {
                    clearInterval(driverOffersTimers[ofertaId]);
                    delete driverOffersTimers[ofertaId];
                }
            } catch (error) {
                console.error('Error:', error);
            }
        };

        window.closeDriverOffers = async function() {
            document.getElementById('driverOffersModal').classList.remove('active');
            
            if (currentTrip && currentTrip.id) {
                try {
                    await updateDoc(doc(db, 'viajes', currentTrip.id), {
                        estado: 'cancelado',
                        cancelado: serverTimestamp()
                    });
                    
                    const ofertasSnapshot = await getDocs(collection(db, 'viajes', currentTrip.id, 'ofertas'));
                    ofertasSnapshot.forEach(async (doc) => {
                        await deleteDoc(doc.ref);
                    });
                    
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            
            Object.values(driverOffersTimers).forEach(clearInterval);
            driverOffersTimers = {};
            
            document.getElementById('findDriverBtn').style.display = 'flex';
            document.getElementById('priceSection').style.display = 'block';
            
            currentTrip = null;
            saveAppState();
        };

        function showDriverInfo(data) {
            document.getElementById('driverInfoCard').classList.add('active');
            
            document.getElementById('driverName').textContent = data.conductorNombre;
            document.getElementById('driverRating').textContent = data.conductorRating || '4.8';
            document.getElementById('driverTrips').textContent = `${data.conductorViajes || 0} viajes`;
            
            if (data.conductorPhoto) {
                document.getElementById('driverPhoto').src = data.conductorPhoto;
            }
            
            window.currentDriverId = data.conductorId;
            window.currentTripId = currentTrip.id;
        }

        function startDriverTracking(driverId) {
            onSnapshot(doc(db, 'conductores', driverId), (doc) => {
                if (!doc.exists()) return;
                const data = doc.data();
                
                if (data.ubicacion) {
                    const pos = data.ubicacion;
                    
                    if (!markers.driver) {
                        markers.driver = new google.maps.Marker({
                            map: map,
                            position: pos,
                            icon: {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                scale: 8,
                                fillColor: "#00ff88",
                                fillOpacity: 1,
                                strokeColor: "#ffffff",
                                strokeWeight: 2
                            },
                            zIndex: 1100
                        });
                    } else {
                        markers.driver.setPosition(pos);
                    }
                    
                    // Calcular tiempo estimado
                    if (locations.pickup) {
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(pos.lat, pos.lng),
                            new google.maps.LatLng(locations.pickup.lat, locations.pickup.lng)
                        );
                        const timeMinutes = Math.ceil(distance / 500); // 500m por minuto aprox
                        
                        document.getElementById('navOverlay').classList.add('active');
                        document.getElementById('navStepMain').textContent = 'Conductor en camino';
                        document.getElementById('navStepSub').textContent = `Llega en ${timeMinutes} min`;
                        document.getElementById('navStepDistance').textContent = timeMinutes;
                        
                        if (distance < 100) {
                            document.getElementById('navStepMain').textContent = '¡Conductor llegó!';
                            speak('El conductor ha llegado');
                        }
                    }
                }
            });
        }

        function resetClientUI() {
            document.getElementById('driverInfoCard').classList.remove('active');
            document.getElementById('rateDriverSection').style.display = 'none';
            document.getElementById('priceSection').style.display = 'none';
            document.getElementById('findDriverBtn').style.display = 'none';
            document.getElementById('pickupInput').value = '';
            document.getElementById('destInput').value = '';
            document.getElementById('navOverlay').classList.remove('active');
            document.getElementById('repeatAssistant').classList.remove('active');
            
            if (markers.pickup) markers.pickup.setMap(null);
            if (markers.destination) markers.destination.setMap(null);
            if (markers.driver) markers.driver.setMap(null);
            
            markers.pickup = null;
            markers.destination = null;
            markers.driver = null;
            
            directionsRenderer.setDirections({ routes: [] });
            
            currentTrip = null;
            locations.pickup = null;
            locations.destination = null;
            saveAppState();
        }

        // ==========================================
        // CONDUCTOR
        // ==========================================

        async function loadDriverStats() {
            if (!currentUser) return;
            
            const conductorDoc = await getDoc(doc(db, 'conductores', currentUser.uid));
            if (conductorDoc.exists()) {
                const data = conductorDoc.data();
                updateDriverStatsUI(data);
            }
        }

        function updateDriverStatsUI(data) {
            document.getElementById('statRating').textContent = (data.calificacion || 5.0).toFixed(1);
            document.getElementById('statTrips').textContent = data.viajesCompletados || 0;
            
            let earnings = 0;
            switch(earningsPeriod) {
                case 'day': earnings = data.gananciasDia || 0; break;
                case 'week': earnings = data.gananciasSemana || 0; break;
                case 'month': earnings = data.gananciasMes || 0; break;
            }
            
            document.getElementById('statEarnings').textContent = `RD$${earnings}`;
            document.getElementById('earningsAmount').textContent = `RD$ ${earnings}`;
        }

        window.setEarningsPeriod = function(period) {
            earningsPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadDriverStats();
        };

        window.toggleStatus = async function() {
            if (!currentUser) return;
            
            isOnline = !isOnline;
            const toggle = document.getElementById('toggleSwitch');
            const text = document.getElementById('statusText');
            
            if (isOnline) {
                toggle.classList.add('active');
                text.textContent = 'Conectado';
                text.classList.remove('offline');
                text.classList.add('online');
                
                await updateDoc(doc(db, 'conductores', currentUser.uid), {
                    disponible: true,
                    actualizado: serverTimestamp()
                });
                showToast('Ahora estás disponible');
                saveAppState();
            } else {
                toggle.classList.remove('active');
                text.textContent = 'Desconectado';
                text.classList.remove('online');
                text.classList.add('offline');
                
                await updateDoc(doc(db, 'conductores', currentUser.uid), {
                    disponible: false,
                    actualizado: serverTimestamp()
                });
                saveAppState();
            }
        };

        function listenForTrips() {
            const q = query(
                collection(db, 'viajes'),
                where('estado', '==', 'buscando'),
                orderBy('creado', 'desc')
            );
            
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('requestsList');
                
                if (snapshot.empty || !isOnline) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
                            ${isOnline ? 'No hay solicitudes' : 'Activa tu disponibilidad'}
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const trip = doc.data();
                    const distToClient = locations.current ? 
                        google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(locations.current.lat, locations.current.lng),
                            new google.maps.LatLng(trip.origen.lat, trip.origen.lng)
                        ) / 1000 : 0;
                    
                    html += `
                        <div class="request-card">
                            <div class="request-header">
                                <div>
                                    <div style="font-weight: 700;">${trip.clienteNombre}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        A ${distToClient.toFixed(1)}km
                                    </div>
                                </div>
                                <div class="request-price">RD$ ${trip.precioOfrecido}</div>
                            </div>
                            <div class="request-route">
                                <div class="route-point">
                                    <div class="route-dot pickup"></div>
                                    <span>${trip.origen.name || 'Origen'}</span>
                                </div>
                                <div class="route-point">
                                    <div class="route-dot dest"></div>
                                    <span>${trip.destino.name || 'Destino'}</span>
                                </div>
                            </div>
                            <div class="request-actions">
                                <button class="btn btn-success" onclick="makeOffer('${doc.id}', ${trip.precioOfrecido})">
                                    Hacer Oferta
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            });
        }

        function listenForMyTrips() {
            if (!currentUser) return;
            
            const q = query(
                collection(db, 'viajes'),
                where('conductorId', '==', currentUser.uid),
                where('estado', 'in', ['aceptado', 'conductor_llego', 'en_curso']),
                orderBy('creado', 'desc')
            );
            
            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const trip = { id: doc.id, ...doc.data() };
                        currentTrip = trip;
                        showDriverCurrentTrip(trip);
                    });
                } else {
                    document.getElementById('currentTripCard').classList.remove('active');
                    document.getElementById('sosButton').classList.remove('active');
                    document.getElementById('repeatAssistant').classList.remove('active');
                    hideFloatingStatus();
                }
            });
        }

        function showDriverCurrentTrip(trip) {
            document.getElementById('currentTripCard').classList.add('active');
            document.getElementById('sosButton').classList.add('active');
            
            document.getElementById('clientName').textContent = trip.clienteNombre;
            document.getElementById('tripPickup').textContent = trip.origen.name || 'Origen';
            document.getElementById('tripDest').textContent = trip.destino.name || 'Destino';
            document.getElementById('tripEarnings').textContent = `RD$ ${trip.precioNegociado || trip.precioOfrecido}`;
            
            if (trip.clientePhoto) {
                document.getElementById('clientPhoto').src = trip.clientePhoto;
            }
            
            if (locations.current && trip.origen) {
                const dist = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(locations.current.lat, locations.current.lng),
                    new google.maps.LatLng(trip.origen.lat, trip.origen.lng)
                ) / 1000;
                document.getElementById('clientDistance').textContent = `${dist.toFixed(1)} km`;
                document.getElementById('tripDistance').textContent = `${dist.toFixed(1)} km`;
                document.getElementById('tripTime').textContent = `${Math.ceil(dist / 0.5)} min`;
            }
            
            const statusEl = document.getElementById('tripStatus');
            const btnLlegue = document.getElementById('btnLlegue');
            const btnIniciar = document.getElementById('btnIniciar');
            const btnFinalizar = document.getElementById('btnFinalizar');
            
            btnLlegue.style.display = 'none';
            btnIniciar.style.display = 'none';
            btnFinalizar.style.display = 'none';
            document.getElementById('rateClientSection').style.display = 'none';
            
            if (trip.estado === 'aceptado') {
                statusEl.textContent = 'En camino al cliente';
                btnLlegue.style.display = 'flex';
                showFloatingStatus('En camino al origen');
                
                if (locations.current && trip.origen) {
                    showRoute(trip.origen);
                }
            } else if (trip.estado === 'conductor_llego') {
                statusEl.textContent = 'Esperando cliente';
                btnIniciar.style.display = 'flex';
                hideFloatingStatus();
                speak('Has llegado al punto de recogida');
            } else if (trip.estado === 'en_curso') {
                statusEl.textContent = 'Viaje en progreso';
                btnFinalizar.style.display = 'flex';
                showFloatingStatus('En camino al destino');
                
                if (locations.current && trip.destino) {
                    showRoute(trip.destino);
                }
            }
            
            window.currentTripId = trip.id;
            window.currentClientId = trip.clienteId;
        }

        function showRoute(dest) {
            if (!locations.current) return;
            
            directionsService.route({
                origin: locations.current,
                destination: dest,
                travelMode: 'DRIVING'
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    steps = result.routes[0].legs[0].steps;
                    isNavigating = true;
                }
            });
        }

        window.makeOffer = async function(tripId, clientPrice) {
            const myPrice = prompt(`Cliente ofrece: RD$ ${clientPrice}\nTu oferta:`, clientPrice);
            
            if (!myPrice) return;
            
            const offerPrice = parseInt(myPrice);
            if (isNaN(offerPrice) || offerPrice < 50) {
                showToast('Precio inválido', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                await addDoc(collection(db, 'viajes', tripId, 'ofertas'), {
                    conductorId: currentUser.uid,
                    conductorNombre: userData.nombre,
                    conductorPhoto: userData.photoURL,
                    conductorRating: userData.calificacion || 5.0,
                    conductorViajes: userData.viajesCompletados || 0,
                    precioOfrecido: offerPrice,
                    timestamp: serverTimestamp()
                });
                
                showToast('Oferta enviada');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al enviar oferta', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.driverArrived = async function() {
            if (!currentTrip) return;
            
            try {
                await updateDoc(doc(db, 'viajes', currentTrip.id), {
                    estado: 'conductor_llego',
                    llegadaConductor: serverTimestamp()
                });
                showToast('Llegaste al origen');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', 'error');
            }
        };

        window.startTrip = async function() {
            if (!currentTrip) return;
            
            try {
                await updateDoc(doc(db, 'viajes', currentTrip.id), {
                    estado: 'en_curso',
                    inicioViaje: serverTimestamp()
                });
                showToast('Viaje iniciado');
                speak('Viaje iniciado');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', 'error');
            }
        };

        window.endTrip = async function() {
            if (!currentTrip) return;
            
            showLoading(true);
            
            try {
                const tripPrice = currentTrip.precioNegociado || currentTrip.precioOfrecido;
                
                await updateDoc(doc(db, 'viajes', currentTrip.id), {
                    estado: 'completado',
                    finViaje: serverTimestamp()
                });
                
                await updateDoc(doc(db, 'conductores', currentUser.uid), {
                    viajesCompletados: increment(1),
                    gananciasTotal: increment(tripPrice),
                    gananciasDia: increment(tripPrice),
                    gananciasSemana: increment(tripPrice),
                    gananciasMes: increment(tripPrice),
                    enViaje: false
                });
                
                showToast('Viaje completado');
                document.getElementById('rateClientSection').style.display = 'block';
                
                document.getElementById('currentTripCard').classList.remove('active');
                document.getElementById('sosButton').classList.remove('active');
                hideFloatingStatus();
                directionsRenderer.setDirections({ routes: [] });
                
                currentTrip = null;
                isNavigating = false;
                loadDriverStats();
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', 'error');
            } finally {
                showLoading(false);
            }
        };

        // ==========================================
        // CALIFICACIONES
        // ==========================================

        window.rateDriver = async function(stars) {
            if (!currentTrip || !currentTrip.conductorId) return;
            
            showLoading(true);
            
            try {
                // Actualizar estrellas visualmente
                document.querySelectorAll('#driverRatingStars .star-btn').forEach((btn, index) => {
                    btn.classList.toggle('active', index < stars);
                });
                
                // Guardar calificación
                await addDoc(collection(db, 'calificaciones'), {
                    de: currentUser.uid,
                    para: currentTrip.conductorId,
                    viajeId: currentTrip.id,
                    puntuacion: stars,
                    tipo: 'conductor',
                    timestamp: serverTimestamp()
                });
                
                // Actualizar promedio del conductor
                const conductorRef = doc(db, 'conductores', currentTrip.conductorId);
                const conductorDoc = await getDoc(conductorRef);
                
                if (conductorDoc.exists()) {
                    const data = conductorDoc.data();
                    const total = (data.totalCalificaciones || 0) + 1;
                    const suma = (data.sumaCalificaciones || 0) + stars;
                    const promedio = suma / total;
                    
                    await updateDoc(conductorRef, {
                        calificacion: promedio,
                        totalCalificaciones: total,
                        sumaCalificaciones: suma
                    });
                }
                
                showToast('¡Gracias por calificar!');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al calificar', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.rateClient = async function(stars) {
            if (!currentTrip || !currentTrip.clienteId) return;
            
            showLoading(true);
            
            try {
                // Actualizar estrellas visualmente
                document.querySelectorAll('#clientRatingStars .star-btn').forEach((btn, index) => {
                    btn.classList.toggle('active', index < stars);
                });
                
                // Guardar calificación
                await addDoc(collection(db, 'calificaciones'), {
                    de: currentUser.uid,
                    para: currentTrip.clienteId,
                    viajeId: currentTrip.id,
                    puntuacion: stars,
                    tipo: 'cliente',
                    timestamp: serverTimestamp()
                });
                
                // Actualizar promedio del cliente
                const clienteRef = doc(db, 'usuarios', currentTrip.clienteId);
                const clienteDoc = await getDoc(clienteRef);
                
                if (clienteDoc.exists()) {
                    const data = clienteDoc.data();
                    const total = (data.totalCalificaciones || 0) + 1;
                    const suma = (data.sumaCalificaciones || 0) + stars;
                    const promedio = suma / total;
                    
                    await updateDoc(clienteRef, {
                        calificacion: promedio,
                        totalCalificaciones: total,
                        sumaCalificaciones: suma
                    });
                }
                
                showToast('Cliente calificado');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al calificar', 'error');
            } finally {
                showLoading(false);
            }
        };

        // ==========================================
        // CHAT
        // ==========================================

        window.openChat = function() {
            if (!window.currentTripId) {
                showToast('No hay viaje activo', 'error');
                return;
            }
            
            document.getElementById('chatModal').classList.add('active');
            
            const chatName = userRole === 'cliente' ? currentTrip?.conductorNombre : currentTrip?.clienteNombre;
            const chatPhoto = userRole === 'cliente' ? currentTrip?.conductorPhoto : currentTrip?.clientePhoto;
            
            document.getElementById('chatName').textContent = chatName || 'Usuario';
            if (chatPhoto) {
                document.getElementById('chatPhoto').src = chatPhoto;
            }
            
            loadMessages();
        };

        window.closeChat = function(event) {
            if (!event || event.target.id === 'chatModal') {
                document.getElementById('chatModal').classList.remove('active');
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                    chatUnsubscribe = null;
                }
            }
        };

        function loadMessages() {
            const q = query(
                collection(db, 'viajes', window.currentTripId, 'mensajes'),
                orderBy('timestamp', 'asc')
            );
            
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('chatMessages');
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isSent = msg.remitente === currentUser.uid;
                    
                    const div = document.createElement('div');
                    div.className = `message ${isSent ? 'sent' : 'received'}`;
                    div.textContent = msg.texto;
                    container.appendChild(div);
                    
                    if (!isSent && audioEnabled) {
                        playMessageSound();
                    }
                });
                
                container.scrollTop = container.scrollHeight;
            });
        }

        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !window.currentTripId) return;
            
            try {
                await addDoc(collection(db, 'viajes', window.currentTripId, 'mensajes'), {
                    texto: text,
                    remitente: currentUser.uid,
                    remitenteNombre: userData.nombre,
                    timestamp: serverTimestamp()
                });
                
                input.value = '';
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al enviar', 'error');
            }
        };

        window.handleKeyPress = function(event) {
            if (event.key === 'Enter') sendMessage();
        };

        // ==========================================
        // CANCELAR
        // ==========================================

        window.showCancelModal = function() {
            if (!currentTrip) {
                showToast('No hay viaje activo', 'error');
                return;
            }
            document.getElementById('cancelModal').classList.add('active');
        };

        window.closeCancelModal = function() {
            document.getElementById('cancelModal').classList.remove('active');
        };

        window.cancelTrip = async function(reason) {
            if (!currentTrip) return;
            
            showLoading(true);
            
            try {
                await updateDoc(doc(db, 'viajes', currentTrip.id), {
                    estado: 'cancelado',
                    motivoCancelacion: reason,
                    canceladoPor: userRole,
                    canceladoEn: serverTimestamp()
                });
                
                if (userRole === 'conductor') {
                    await updateDoc(doc(db, 'conductores', currentUser.uid), {
                        enViaje: false
                    });
                }
                
                showToast('Viaje cancelado');
                closeCancelModal();
                hideFloatingStatus();
                
                if (userRole === 'cliente') {
                    resetClientUI();
                } else {
                    document.getElementById('currentTripCard').classList.remove('active');
                    document.getElementById('sosButton').classList.remove('active');
                    document.getElementById('repeatAssistant').classList.remove('active');
                    directionsRenderer.setDirections({ routes: [] });
                    currentTrip = null;
                    isNavigating = false;
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al cancelar', 'error');
            } finally {
                showLoading(false);
            }
        };

        // ==========================================
        // PERFIL
        // ==========================================

        window.openProfile = function() {
            if (!userData) return;
            
            document.getElementById('profileModal').classList.add('active');
            document.getElementById('dropdownMenu').classList.remove('active');
            
            document.getElementById('profileName').textContent = userData.nombre;
            document.getElementById('profileEmail').textContent = userData.email;
            document.getElementById('editName').value = userData.nombre;
            document.getElementById('editPhone').value = userData.telefono || '';
            
            if (userData.photoURL) {
                document.getElementById('profilePhotoLarge').src = userData.photoURL;
            }
            
            if (userRole === 'conductor') {
                document.getElementById('driverEditFields').style.display = 'block';
                document.getElementById('driverEditFields2').style.display = 'block';
                document.getElementById('driverEditFields3').style.display = 'block';
                
                getDoc(doc(db, 'conductores', currentUser.uid)).then(doc => {
                    if (doc.exists()) {
                        const data = doc.data();
                        document.getElementById('editPlate').value = data.placa || '';
                        document.getElementById('editModel').value = data.modelo || '';
                        document.getElementById('editColor').value = data.color || '';
                    }
                });
            }
        };

        window.closeProfile = function() {
            document.getElementById('profileModal').classList.remove('active');
        };

        window.updateProfilePhoto = async function(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;
            
            showLoading(true);
            
            try {
                const storageRef = ref(storage, `profiles/${currentUser.uid}`);
                await uploadBytes(storageRef, file);
                const photoURL = await getDownloadURL(storageRef);
                
                await updateProfile(auth.currentUser, { photoURL });
                await updateDoc(doc(db, 'usuarios', currentUser.uid), { photoURL });
                
                if (userRole === 'conductor') {
                    await updateDoc(doc(db, 'conductores', currentUser.uid), { photoURL });
                }
                
                userData.photoURL = photoURL;
                document.getElementById('profilePhotoLarge').src = photoURL;
                document.getElementById('headerPhoto').src = photoURL;
                document.getElementById('headerPhoto').style.display = 'block';
                document.getElementById('headerIcon').style.display = 'none';
                
                showToast('Foto actualizada');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al actualizar foto', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.saveProfile = async function() {
            const nombre = document.getElementById('editName').value.trim();
            const telefono = document.getElementById('editPhone').value.trim();
            const placa = document.getElementById('editPlate')?.value.trim() || '';
            const modelo = document.getElementById('editModel')?.value.trim() || '';
            const color = document.getElementById('editColor')?.value.trim() || '';
            
            if (!nombre) {
                showToast('El nombre es requerido', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                await updateDoc(doc(db, 'usuarios', currentUser.uid), {
                    nombre,
                    telefono
                });
                
                if (userRole === 'conductor') {
                    await updateDoc(doc(db, 'conductores', currentUser.uid), {
                        nombre,
                        telefono,
                        placa,
                        modelo,
                        color
                    });
                }
                
                userData.nombre = nombre;
                userData.telefono = telefono;
                document.getElementById('userName').textContent = nombre;
                document.getElementById('profileName').textContent = nombre;
                
                showToast('Perfil actualizado');
                closeProfile();
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar', 'error');
            } finally {
                showLoading(false);
            }
        };

        // ==========================================
        // MENÚ - OPCIONES
        // ==========================================

        window.openHistory = function() {
            showToast('Historial de viajes (próximamente)');
            document.getElementById('dropdownMenu').classList.remove('active');
        };

        window.openRatings = function() {
            showToast('Mis calificaciones (próximamente)');
            document.getElementById('dropdownMenu').classList.remove('active');
        };

        window.openSupport = function() {
            showToast('Soporte (próximamente)');
            document.getElementById('dropdownMenu').classList.remove('active');
        };

        window.triggerSOS = function() {
            if (confirm('¿Activar alerta de emergencia?')) {
                showToast('Alerta enviada', 'error');
                speak('Alerta de emergencia activada');
            }
        };

        // ==========================================
        // UTILIDADES
        // ==========================================

        function playMessageSound() {
            if (!audioEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1200;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {}
        }

        function showFloatingStatus(text) {
            document.getElementById('floatingStatusText').textContent = text;
            document.getElementById('floatingStatus').classList.add('active');
        }

        function hideFloatingStatus() {
            document.getElementById('floatingStatus').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            toast.style.borderColor = type === 'error' ? 'var(--danger)' : 'rgba(0,212,255,0.3)';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showLoading(show) {
            document.getElementById('loadingScreen').classList.toggle('active', show);
        }

        window.showToast = showToast;
        window.showLoading = showLoading;

        // Cerrar menú al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('dropdownMenu');
            const userPill = document.querySelector('.user-pill');
            
            if (!userPill.contains(event.target) && !menu.contains(event.target)) {
                menu.classList.remove('active');
            }
        });
    </script>
</body>
</html>
