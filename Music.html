<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MusicApp - Reproductor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1DB954;
      --primary-dark: #1AA34A;
      --secondary-color: #191414;
      --background-color: #121212;
      --card-bg: #181818;
      --text-color: #FFFFFF;
      --text-light: #B3B3B3;
      --border-color: #282828;
      --sidebar-width: 280px;
      --player-height: 80px;
      --header-height: 60px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding-bottom: var(--player-height);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background-color: rgba(25, 20, 20, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 100;
      border-bottom: 1px solid var(--border-color);
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
    }

    .logo img {
      height: 30px;
      margin-right: 10px;
    }

    .logo h1 {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .menu-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
      margin-left: 20px;
      padding: 5px;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: var(--header-height);
      left: -280px;
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height) - var(--player-height));
      background-color: var(--secondary-color);
      transition: transform 0.3s ease;
      z-index: 90;
      overflow-y: auto;
      padding: 20px 0;
    }

    .sidebar.active {
      transform: translateX(280px);
    }

    .sidebar-search {
      padding: 0 20px 20px;
      position: relative;
    }

    .sidebar-search input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border-radius: 20px;
      border: none;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 0.9rem;
    }

    .sidebar-search i {
      position: absolute;
      left: 30px;
      top: 10px;
      color: var(--text-light);
    }

    .sidebar-nav {
      list-style: none;
    }

    .sidebar-nav li {
      margin: 5px 0;
    }

    .sidebar-nav a {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: var(--text-light);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .sidebar-nav a:hover, .sidebar-nav a.active {
      color: var(--text-color);
      background-color: var(--card-bg);
    }

    .sidebar-nav a i {
      margin-right: 15px;
      font-size: 1.2rem;
    }

    .sidebar-divider {
      height: 1px;
      background-color: var(--border-color);
      margin: 15px 20px;
    }

    /* Main Content */
    .main-content {
      margin-top: var(--header-height);
      padding: 20px;
      transition: margin-left 0.3s ease;
      min-height: calc(100vh - var(--header-height) - var(--player-height));
    }

    .main-content.active {
      margin-left: var(--sidebar-width);
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--text-color);
    }

    /* Player Section */
    .player-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
    }

    .album-art {
      width: 250px;
      height: 250px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      margin-bottom: 30px;
    }

    .song-info {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
    }

    .song-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .song-artist {
      font-size: 1rem;
      color: var(--text-light);
    }

    .song-album {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: 5px;
    }

    /* Progress Bar */
    .progress-container {
      width: 100%;
      margin-bottom: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background-color: var(--border-color);
      border-radius: 3px;
      margin-bottom: 5px;
      cursor: pointer;
      position: relative;
    }

    .progress {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 3px;
      width: 0%;
      position: relative;
    }

    .progress-handle {
      width: 12px;
      height: 12px;
      background-color: var(--primary-color);
      border-radius: 50%;
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .progress-bar:hover .progress-handle {
      opacity: 1;
    }

    .time-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-light);
    }

    /* Controls */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 30px;
      width: 100%;
    }

    .control-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.2rem;
      margin: 0 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .control-btn:hover {
      transform: scale(1.1);
    }

    .control-btn.active {
      color: var(--primary-color);
    }

    .play-btn {
      background-color: var(--primary-color);
      width: 60px;
      height: 60px;
      font-size: 1.8rem;
      box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3);
    }

    .play-btn:hover {
      transform: scale(1.05);
      background-color: var(--primary-dark);
    }

    /* Navigation */
    .nav-tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .nav-tab {
      padding: 10px 20px;
      cursor: pointer;
      color: var(--text-light);
      font-weight: 500;
      position: relative;
      font-size: 0.9rem;
    }

    .nav-tab.active {
      color: var(--text-color);
    }

    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: -11px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    /* Songs List */
    .songs-list {
      list-style: none;
    }

    .song-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }

    .song-item:hover {
      background-color: var(--card-bg);
    }

    .song-item.active {
      background-color: rgba(29, 185, 84, 0.1);
    }

    .song-item-img {
      width: 50px;
      height: 50px;
      border-radius: 5px;
      object-fit: cover;
      margin-right: 15px;
    }

    .song-item-info {
      flex: 1;
      min-width: 0;
    }

    .song-item-title {
      font-size: 1rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .song-item-artist {
      font-size: 0.8rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .song-item-duration {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-left: 15px;
    }

    .song-item-plays {
      font-size: 0.7rem;
      color: var(--primary-color);
      margin-left: 10px;
      display: flex;
      align-items: center;
    }

    .song-item-plays i {
      margin-right: 3px;
    }

    .song-item-actions {
      margin-left: 15px;
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      align-items: center;
    }

    .song-item:hover .song-item-actions {
      opacity: 1;
    }

    .song-item-actions button {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1rem;
      cursor: pointer;
      margin-left: 10px;
    }

    .song-item-actions button:hover {
      color: var(--primary-color);
    }

    .local-song-icon {
      color: var(--primary-color);
      font-size: 0.8rem;
      margin-left: 5px;
    }

    /* Search Section */
    .search-section {
      display: none;
    }

    .search-section.active {
      display: block;
    }

    .search-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .search-input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 20px;
      border: none;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 1rem;
    }

    .search-results {
      margin-top: 20px;
    }

    /* Mini Player */
    .mini-player {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--player-height);
      background-color: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 100;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .mini-player.active {
      transform: translateY(0);
    }

    .mini-player-img {
      width: 50px;
      height: 50px;
      border-radius: 5px;
      object-fit: cover;
      margin-right: 15px;
    }

    .mini-player-info {
      flex: 1;
      min-width: 0;
    }

    .mini-player-title {
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mini-player-artist {
      font-size: 0.8rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mini-player-progress {
      flex: 1;
      height: 3px;
      background-color: var(--border-color);
      border-radius: 3px;
      margin: 0 20px;
      position: relative;
    }

    .mini-player-progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 3px;
      width: 0%;
    }

    .mini-player-controls {
      display: flex;
      align-items: center;
    }

    .mini-player-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1rem;
      cursor: pointer;
      margin-left: 15px;
    }

    .mini-player-btn.play {
      color: var(--primary-color);
    }

    .minimize-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1rem;
      cursor: pointer;
    }

    /* Upload Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--card-bg);
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.5rem;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 1rem;
    }

    .file-input {
      display: none;
    }

    .file-label {
      display: block;
      padding: 15px;
      border: 2px dashed var(--border-color);
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .file-label:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .file-label i {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }

    .file-name {
      font-size: 0.8rem;
      margin-top: 5px;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 20px;
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      text-align: center;
    }

    .btn:hover {
      background-color: var(--primary-dark);
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .uploading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .uploading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Local File Upload */
    .local-upload-container {
      margin-top: 30px;
      padding: 20px;
      background-color: var(--card-bg);
      border-radius: 10px;
    }

    .local-upload-title {
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .local-upload-title i {
      margin-right: 10px;
      color: var(--primary-color);
    }

    .local-upload-btn {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 20px;
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      text-align: center;
      margin-top: 10px;
    }

    .local-upload-btn:hover {
      background-color: var(--primary-dark);
    }

    /* Loading */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--background-color);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(29, 185, 84, 0.2);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .album-art {
        width: 200px;
        height: 200px;
      }

      .sidebar {
        width: 100%;
        left: -100%;
      }

      .sidebar.active {
        transform: translateX(100%);
      }

      .main-content.active {
        margin-left: 0;
      }

      .control-btn {
        margin: 0 10px;
      }

      .nav-tab {
        padding: 10px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading" id="loadingScreen">
    <div class="spinner"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <img src="logo.png" alt="MusicApp Logo">
        <h1>MusicApp</h1>
      </div>
    </div>
    <button class="menu-btn" id="menuBtn">
      <i class="fas fa-bars"></i>
    </button>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-search">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Buscar canciones, artistas..." id="sidebarSearch">
    </div>
    
    <ul class="sidebar-nav">
      <li><a href="#" class="active" id="homeLink"><i class="fas fa-home"></i> Inicio</a></li>
      <li><a href="#" id="libraryLink"><i class="fas fa-music"></i> Mi Biblioteca</a></li>
      <li><a href="#" id="favoritesLink"><i class="fas fa-heart"></i> Favoritos</a></li>
      <li><a href="#" id="topSongsLink"><i class="fas fa-chart-line"></i> Más Escuchadas</a></li>
    </ul>
    
    <div class="sidebar-divider"></div>
    
    <ul class="sidebar-nav">
      <li><a href="#" id="searchLink"><i class="fas fa-search"></i> Buscar</a></li>
      <li><a href="perfil.html" id="profileLink"><i class="fas fa-user"></i> Perfil</a></li>
      <li><a href="#" id="uploadLink"><i class="fas fa-upload"></i> Subir Canción</a></li>
      <li><a href="#" id="localUploadLink"><i class="fas fa-folder-open"></i> Subir desde Dispositivo</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Player Section -->
    <section class="player-section" id="playerSection">
      <img src="https://via.placeholder.com/250" alt="Album Art" class="album-art" id="albumArt">
      
      <div class="song-info">
        <h2 class="song-title" id="songTitle">Nombre de la Canción</h2>
        <p class="song-artist" id="songArtist">Nombre del Artista</p>
        <p class="song-album" id="songAlbum">Nombre del Álbum</p>
      </div>
      
      <div class="progress-container">
        <div class="progress-bar" id="progressBar">
          <div class="progress" id="progress">
            <div class="progress-handle"></div>
          </div>
        </div>
        <div class="time-info">
          <span id="currentTime">0:00</span>
          <span id="duration">3:30</span>
        </div>
      </div>
      
      <div class="controls">
        <button class="control-btn" id="favoriteBtn">
          <i class="far fa-heart"></i>
        </button>
        <button class="control-btn" id="shuffleBtn">
          <i class="fas fa-random"></i>
        </button>
        <button class="control-btn" id="repeatBtn">
          <i class="fas fa-redo"></i>
        </button>
      </div>
      
      <div class="controls">
        <button class="control-btn" id="prevBtn">
          <i class="fas fa-step-backward"></i>
        </button>
        <button class="control-btn play-btn" id="playBtn">
          <i class="fas fa-play" id="playIcon"></i>
        </button>
        <button class="control-btn" id="nextBtn">
          <i class="fas fa-step-forward"></i>
        </button>
      </div>
      
      <div class="controls">
        <button class="control-btn" id="songsListBtn">
          <i class="fas fa-list"></i>
        </button>
        <button class="control-btn" id="favoritesListBtn">
          <i class="fas fa-heart"></i>
        </button>
        <button class="control-btn" id="topSongsListBtn">
          <i class="fas fa-chart-line"></i>
        </button>
      </div>
    </section>
    
    <!-- Search Section -->
    <section class="search-section" id="searchSection">
      <div class="search-header">
        <input type="text" class="search-input" placeholder="Buscar canciones..." id="searchInput">
      </div>
      <div class="search-results">
        <ul class="songs-list" id="searchResultsList"></ul>
      </div>
    </section>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs" id="navTabs">
      <div class="nav-tab active" data-tab="songs">Canciones</div>
      <div class="nav-tab" data-tab="favorites">Favoritos</div>
      <div class="nav-tab" data-tab="top">Más Escuchadas</div>
    </div>
    
    <!-- Songs List -->
    <ul class="songs-list" id="songsList">
      <!-- Songs will be added dynamically -->
    </ul>
    
    <!-- Local Upload Section -->
    <div class="local-upload-container" id="localUploadContainer">
      <h3 class="local-upload-title"><i class="fas fa-folder-open"></i> Canciones Locales</h3>
      <input type="file" id="localFileInput" accept="audio/*" multiple style="display: none;">
      <button class="local-upload-btn" id="localUploadBtn">Seleccionar Canciones</button>
      <ul class="songs-list" id="localSongsList"></ul>
    </div>
  </main>

  <!-- Mini Player -->
  <div class="mini-player" id="miniPlayer">
    <button class="minimize-btn" id="minimizeBtn">
      <i class="fas fa-chevron-down"></i>
    </button>
    <img src="https://via.placeholder.com/50" alt="Album Art" class="mini-player-img" id="miniPlayerImg">
    
    <div class="mini-player-info">
      <div class="mini-player-title" id="miniPlayerTitle">Nombre de la Canción</div>
      <div class="mini-player-artist" id="miniPlayerArtist">Nombre del Artista</div>
    </div>
    
    <div class="mini-player-progress">
      <div class="mini-player-progress-bar" id="miniPlayerProgress"></div>
    </div>
    
    <div class="mini-player-controls">
      <button class="mini-player-btn" id="miniPlayerPlayBtn">
        <i class="fas fa-play" id="miniPlayerPlayIcon"></i>
      </button>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal" id="uploadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Subir Canción a Firebase</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      
      <form id="uploadForm">
        <div class="form-group">
          <label for="songName">Nombre de la Canción*</label>
          <input type="text" id="songName" class="form-control" required>
        </div>
        
        <div class="form-group">
          <label for="songArtist">Artista*</label>
          <input type="text" id="songArtist" class="form-control" required>
        </div>
        
        <div class="form-group">
          <label for="songAlbum">Álbum</label>
          <input type="text" id="songAlbum" class="form-control">
        </div>
        
        <div class="form-group">
          <label>Archivo de Audio*</label>
          <input type="file" id="audioFile" class="file-input" accept="audio/*" required>
          <label for="audioFile" class="file-label">
            <i class="fas fa-music"></i>
            <span>Seleccionar archivo de audio</span>
            <div class="file-name" id="audioFileName">Ningún archivo seleccionado</div>
          </label>
        </div>
        
        <div class="form-group">
          <label>Imagen de Portada</label>
          <input type="file" id="coverImage" class="file-input" accept="image/*">
          <label for="coverImage" class="file-label">
            <i class="fas fa-image"></i>
            <span>Seleccionar imagen de portada</span>
            <div class="file-name" id="coverImageName">Ningún archivo seleccionado</div>
          </label>
        </div>
        
        <button type="submit" class="btn btn-block" id="uploadBtn">Subir Canción</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    // DOM Elements
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const loadingScreen = document.getElementById('loadingScreen');
    const sidebarSearch = document.getElementById('sidebarSearch');
    
    // Player Elements
    const albumArt = document.getElementById('albumArt');
    const songTitle = document.getElementById('songTitle');
    const songArtist = document.getElementById('songArtist');
    const songAlbum = document.getElementById('songAlbum');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const repeatBtn = document.getElementById('repeatBtn');
    const favoriteBtn = document.getElementById('favoriteBtn');
    const songsListBtn = document.getElementById('songsListBtn');
    const favoritesListBtn = document.getElementById('favoritesListBtn');
    const topSongsListBtn = document.getElementById('topSongsListBtn');
    
    // Mini Player Elements
    const miniPlayer = document.getElementById('miniPlayer');
    const miniPlayerImg = document.getElementById('miniPlayerImg');
    const miniPlayerTitle = document.getElementById('miniPlayerTitle');
    const miniPlayerArtist = document.getElementById('miniPlayerArtist');
    const miniPlayerProgress = document.getElementById('miniPlayerProgress');
    const miniPlayerPlayBtn = document.getElementById('miniPlayerPlayBtn');
    const miniPlayerPlayIcon = document.getElementById('miniPlayerPlayIcon');
    const minimizeBtn = document.getElementById('minimizeBtn');
    
    // Songs List Elements
    const songsList = document.getElementById('songsList');
    const navTabs = document.querySelectorAll('.nav-tab');
    
    // Search Elements
    const searchSection = document.getElementById('searchSection');
    const searchInput = document.getElementById('searchInput');
    const searchResultsList = document.getElementById('searchResultsList');
    
    // Upload Modal Elements
    const uploadModal = document.getElementById('uploadModal');
    const modalClose = document.getElementById('modalClose');
    const uploadForm = document.getElementById('uploadForm');
    const audioFileInput = document.getElementById('audioFile');
    const coverImageInput = document.getElementById('coverImage');
    const audioFileName = document.getElementById('audioFileName');
    const coverImageName = document.getElementById('coverImageName');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadLink = document.getElementById('uploadLink');
    const localUploadLink = document.getElementById('localUploadLink');
    
    // Local Upload Elements
    const localUploadContainer = document.getElementById('localUploadContainer');
    const localFileInput = document.getElementById('localFileInput');
    const localUploadBtn = document.getElementById('localUploadBtn');
    const localSongsList = document.getElementById('localSongsList');
    
    // Navigation Links
    const homeLink = document.getElementById('homeLink');
    const libraryLink = document.getElementById('libraryLink');
    const favoritesLink = document.getElementById('favoritesLink');
    const topSongsLink = document.getElementById('topSongsLink');
    const searchLink = document.getElementById('searchLink');
    const profileLink = document.getElementById('profileLink');
    
    // Audio Player
    const audio = new Audio();
    let isPlaying = false;
    let currentSongIndex = 0;
    let songs = [];
    let localSongs = [];
    let favorites = [];
    let topSongs = [];
    let repeatMode = 'none'; // 'none', 'one', 'all'
    let isShuffled = false;
    let originalSongsOrder = [];
    let currentTab = 'songs';
    
    // Initialize App
    function initApp() {
      // Load songs from Firestore
      loadSongs();
      
      // Load local songs from localStorage
      loadLocalSongs();
      
      // Load favorites from localStorage
      loadFavorites();
      
      // Event Listeners
      setupEventListeners();
      
      // Hide loading screen after 1.5 seconds (simulate loading)
      setTimeout(() => {
        loadingScreen.style.opacity = '0';
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 300);
      }, 1500);
    }
    
    // Setup Event Listeners
    function setupEventListeners() {
      // Menu Button
      menuBtn.addEventListener('click', toggleSidebar);
      
      // Sidebar Search
      sidebarSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          showSearchSection();
          searchInput.value = sidebarSearch.value;
          searchSongs(sidebarSearch.value);
        }
      });
      
      // Player Controls
      playBtn.addEventListener('click', togglePlay);
      prevBtn.addEventListener('click', playPrevious);
      nextBtn.addEventListener('click', playNext);
      shuffleBtn.addEventListener('click', toggleShuffle);
      repeatBtn.addEventListener('click', toggleRepeat);
      favoriteBtn.addEventListener('click', toggleFavorite);
      songsListBtn.addEventListener('click', () => switchTab('songs'));
      favoritesListBtn.addEventListener('click', () => switchTab('favorites'));
      topSongsListBtn.addEventListener('click', () => switchTab('top'));
      
      // Progress Bar
      progressBar.addEventListener('click', seek);
      
      // Audio Events
      audio.addEventListener('timeupdate', updateProgress);
      audio.addEventListener('ended', handleSongEnd);
      audio.addEventListener('play', () => {
        isPlaying = true;
        updatePlayButton();
      });
      audio.addEventListener('pause', () => {
        isPlaying = false;
        updatePlayButton();
      });
      audio.addEventListener('loadedmetadata', () => {
        durationEl.textContent = formatTime(audio.duration);
      });
      
      // Mini Player
      miniPlayer.addEventListener('click', showMainPlayer);
      miniPlayerPlayBtn.addEventListener('click', togglePlay);
      minimizeBtn.addEventListener('click', minimizePlayer);
      
      // Navigation Tabs
      navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });
      
      // Search
      searchInput.addEventListener('input', () => searchSongs(searchInput.value));
      
      // Upload Modal
      uploadLink.addEventListener('click', showUploadModal);
      localUploadLink.addEventListener('click', showLocalUploadSection);
      modalClose.addEventListener('click', hideUploadModal);
      
      // File Inputs
      audioFileInput.addEventListener('change', () => {
        if (audioFileInput.files.length > 0) {
          audioFileName.textContent = audioFileInput.files[0].name;
        } else {
          audioFileName.textContent = 'Ningún archivo seleccionado';
        }
      });
      
      coverImageInput.addEventListener('change', () => {
        if (coverImageInput.files.length > 0) {
          coverImageName.textContent = coverImageInput.files[0].name;
        } else {
          coverImageName.textContent = 'Ningún archivo seleccionado';
        }
      });
      
      // Upload Form
      uploadForm.addEventListener('submit', uploadSong);
      
      // Local Upload
      localUploadBtn.addEventListener('click', () => localFileInput.click());
      localFileInput.addEventListener('change', handleLocalFileUpload);
      
      // Navigation Links
      homeLink.addEventListener('click', (e) => {
        e.preventDefault();
        showPlayerSection();
      });
      
      libraryLink.addEventListener('click', (e) => {
        e.preventDefault();
        showPlayerSection();
        switchTab('songs');
      });
      
      favoritesLink.addEventListener('click', (e) => {
        e.preventDefault();
        showPlayerSection();
        switchTab('favorites');
      });
      
      topSongsLink.addEventListener('click', (e) => {
        e.preventDefault();
        showPlayerSection();
        switchTab('top');
      });
      
      searchLink.addEventListener('click', (e) => {
        e.preventDefault();
        showSearchSection();
      });
    }
    
    // Toggle Sidebar
    function toggleSidebar() {
      sidebar.classList.toggle('active');
      mainContent.classList.toggle('active');
    }
    
    // Show Player Section
    function showPlayerSection() {
      playerSection.style.display = 'flex';
      searchSection.classList.remove('active');
      navTabs.style.display = 'flex';
    }
    
    // Show Search Section
    function showSearchSection() {
      playerSection.style.display = 'none';
      searchSection.classList.add('active');
      navTabs.style.display = 'none';
      searchInput.focus();
    }
    
    // Show Local Upload Section
    function showLocalUploadSection(e) {
      e.preventDefault();
      toggleSidebar();
      localUploadContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Load Songs from Firestore
    function loadSongs() {
      db.collection('songs').orderBy('createdAt', 'desc').get()
        .then(querySnapshot => {
          songs = [];
          querySnapshot.forEach(doc => {
            const song = doc.data();
            song.id = doc.id;
            song.fromFirebase = true;
            songs.push(song);
          });
          
          // Update top songs (sort by playCount)
          updateTopSongs();
          
          // Render songs list
          renderSongsList(songs);
          
          // If there are songs, play the first one
          if (songs.length > 0) {
            loadSong(0);
          }
        })
        .catch(error => {
          console.error('Error loading songs:', error);
        });
    }
    
    // Load Local Songs from localStorage
    function loadLocalSongs() {
      const storedSongs = localStorage.getItem('localSongs');
      if (storedSongs) {
        localSongs = JSON.parse(storedSongs);
        renderLocalSongsList();
      }
    }
    
    // Save Local Songs to localStorage
    function saveLocalSongs() {
      localStorage.setItem('localSongs', JSON.stringify(localSongs));
    }
    
    // Handle Local File Upload
    function handleLocalFileUpload() {
      const files = localFileInput.files;
      if (!files || files.length === 0) return;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const song = {
            id: 'local-' + Date.now() + '-' + i,
            title: file.name.replace(/\.[^/.]+$/, ""), // Remove file extension
            artist: 'Local',
            audioUrl: e.target.result,
            coverUrl: 'https://via.placeholder.com/250?text=No+Image',
            duration: 0,
            playCount: 0,
            isLocal: true,
            createdAt: new Date().toISOString()
          };
          
          // Create a temporary audio element to get duration
          const tempAudio = new Audio(song.audioUrl);
          tempAudio.onloadedmetadata = function() {
            song.duration = tempAudio.duration;
            localSongs.unshift(song);
            saveLocalSongs();
            renderLocalSongsList();
            
            // Play the first uploaded song
            if (i === 0) {
              const allSongs = [...localSongs, ...songs];
              const index = allSongs.findIndex(s => s.id === song.id);
              if (index !== -1) {
                loadSong(index, allSongs);
                playSong();
              }
            }
          };
        };
        
        reader.readAsDataURL(file);
      }
    }
    
    // Render Local Songs List
    function renderLocalSongsList() {
      localSongsList.innerHTML = '';
      
      localSongs.forEach((song, index) => {
        const songItem = document.createElement('li');
        songItem.className = 'song-item';
        
        songItem.innerHTML = `
          <img src="${song.coverUrl}" alt="${song.title}" class="song-item-img">
          <div class="song-item-info">
            <div class="song-item-title">${song.title}</div>
            <div class="song-item-artist">${song.artist}</div>
          </div>
          <div class="song-item-duration">${formatTime(song.duration || 0)}</div>
          <div class="song-item-plays">
            <i class="fas fa-headphones"></i> ${song.playCount || 0}
          </div>
          <div class="song-item-actions">
            <button class="favorite-btn" data-id="${song.id}">
              <i class="${favorites.includes(song.id) ? 'fas' : 'far'} fa-heart"></i>
            </button>
            <i class="fas fa-folder local-song-icon" title="Canción local"></i>
          </div>
        `;
        
        songItem.addEventListener('click', () => {
          const allSongs = [...localSongs, ...songs];
          const songIndex = allSongs.findIndex(s => s.id === song.id);
          if (songIndex !== -1) {
            loadSong(songIndex, allSongs);
            playSong();
          }
        });
        
        localSongsList.appendChild(songItem);
      });
      
      // Add event listeners to favorite buttons
      document.querySelectorAll('#localSongsList .favorite-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const songId = btn.dataset.id;
          toggleFavoriteById(songId);
        });
      });
    }
    
    // Load Favorites from localStorage
    function loadFavorites() {
      const storedFavorites = localStorage.getItem('favorites');
      if (storedFavorites) {
        favorites = JSON.parse(storedFavorites);
        updateFavoriteButton();
      }
    }
    
    // Save Favorites to localStorage
    function saveFavorites() {
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }
    
    // Update Top Songs
    function updateTopSongs() {
      topSongs = [...songs].sort((a, b) => (b.playCount || 0) - (a.playCount || 0));
    }
    
    // Render Songs List
    function renderSongsList(songsToRender) {
      songsList.innerHTML = '';
      
      songsToRender.forEach((song, index) => {
        const songItem = document.createElement('li');
        songItem.className = 'song-item';
        
        songItem.innerHTML = `
          <img src="${song.coverUrl || 'https://via.placeholder.com/50?text=No+Image'}" alt="${song.title}" class="song-item-img">
          <div class="song-item-info">
            <div class="song-item-title">${song.title}</div>
            <div class="song-item-artist">${song.artist}</div>
          </div>
          <div class="song-item-duration">${formatTime(song.duration || 0)}</div>
          <div class="song-item-plays">
            <i class="fas fa-headphones"></i> ${song.playCount || 0}
          </div>
          <div class="song-item-actions">
            <button class="favorite-btn" data-id="${song.id}">
              <i class="${favorites.includes(song.id) ? 'fas' : 'far'} fa-heart"></i>
            </button>
            ${song.isLocal ? '<i class="fas fa-folder local-song-icon" title="Canción local"></i>' : ''}
          </div>
        `;
        
        songItem.addEventListener('click', () => {
          loadSong(index, songsToRender);
          playSong();
        });
        
        songsList.appendChild(songItem);
      });
      
      // Add event listeners to favorite buttons
      document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const songId = btn.dataset.id;
          toggleFavoriteById(songId);
        });
      });
    }
    
    // Render Favorites List
    function renderFavoritesList() {
      const allSongs = [...localSongs, ...songs];
      const favoriteSongs = allSongs.filter(song => favorites.includes(song.id));
      renderSongsList(favoriteSongs);
    }
    
    // Render Top Songs List
    function renderTopSongsList() {
      renderSongsList(topSongs);
    }
    
    // Search Songs
    function searchSongs(query) {
      if (!query) {
        searchResultsList.innerHTML = '<li>Ingrese un término de búsqueda</li>';
        return;
      }
      
      const allSongs = [...localSongs, ...songs];
      const results = allSongs.filter(song => 
        song.title.toLowerCase().includes(query.toLowerCase()) || 
        song.artist.toLowerCase().includes(query.toLowerCase())
      );
      
      if (results.length === 0) {
        searchResultsList.innerHTML = '<li>No se encontraron resultados</li>';
        return;
      }
      
      renderSearchResults(results);
    }
    
    // Render Search Results
    function renderSearchResults(results) {
      searchResultsList.innerHTML = '';
      
      results.forEach((song, index) => {
        const songItem = document.createElement('li');
        songItem.className = 'song-item';
        
        songItem.innerHTML = `
          <img src="${song.coverUrl || 'https://via.placeholder.com/50?text=No+Image'}" alt="${song.title}" class="song-item-img">
          <div class="song-item-info">
            <div class="song-item-title">${song.title}</div>
            <div class="song-item-artist">${song.artist}</div>
          </div>
          <div class="song-item-duration">${formatTime(song.duration || 0)}</div>
          <div class="song-item-plays">
            <i class="fas fa-headphones"></i> ${song.playCount || 0}
          </div>
          <div class="song-item-actions">
            <button class="favorite-btn" data-id="${song.id}">
              <i class="${favorites.includes(song.id) ? 'fas' : 'far'} fa-heart"></i>
            </button>
            ${song.isLocal ? '<i class="fas fa-folder local-song-icon" title="Canción local"></i>' : ''}
          </div>
        `;
        
        songItem.addEventListener('click', () => {
          const allSongs = [...localSongs, ...songs];
          const songIndex = allSongs.findIndex(s => s.id === song.id);
          if (songIndex !== -1) {
            loadSong(songIndex, allSongs);
            playSong();
            showPlayerSection();
          }
        });
        
        searchResultsList.appendChild(songItem);
      });
      
      // Add event listeners to favorite buttons
      document.querySelectorAll('#searchResultsList .favorite-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const songId = btn.dataset.id;
          toggleFavoriteById(songId);
        });
      });
    }
    
    // Switch Tab
    function switchTab(tabName) {
      currentTab = tabName;
      navTabs.forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });
      
      switch (tabName) {
        case 'songs':
          renderSongsList([...localSongs, ...songs]);
          break;
        case 'favorites':
          renderFavoritesList();
          break;
        case 'top':
          renderTopSongsList();
          break;
      }
    }
    
    // Load Song
    function loadSong(index, songsArray = [...localSongs, ...songs]) {
      if (songsArray.length === 0) return;
      
      // Wrap around if index is out of bounds
      if (index < 0) {
        index = songsArray.length - 1;
      } else if (index >= songsArray.length) {
        index = 0;
      }
      
      currentSongIndex = index;
      const song = songsArray[currentSongIndex];
      
      // Update UI
      albumArt.src = song.coverUrl || 'https://via.placeholder.com/250?text=No+Image';
      songTitle.textContent = song.title;
      songArtist.textContent = song.artist;
      songAlbum.textContent = song.album || '';
      
      // Update mini player
      miniPlayerImg.src = song.coverUrl || 'https://via.placeholder.com/50?text=No+Image';
      miniPlayerTitle.textContent = song.title;
      miniPlayerArtist.textContent = song.artist;
      
      // Update favorite button
      updateFavoriteButton();
      
      // Highlight current song in list
      document.querySelectorAll('.song-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Find the song in the current view
      let songItems;
      if (currentTab === 'songs') {
        songItems = document.querySelectorAll('#songsList .song-item');
      } else if (currentTab === 'favorites') {
        songItems = document.querySelectorAll('#songsList .song-item');
      } else if (currentTab === 'top') {
        songItems = document.querySelectorAll('#songsList .song-item');
      } else {
        songItems = document.querySelectorAll('.song-item');
      }
      
      if (songItems.length > currentSongIndex) {
        songItems[currentSongIndex]?.classList.add('active');
      }
      
      // Load audio
      audio.src = song.audioUrl;
      audio.load();
      
      // Update duration
      audio.onloadedmetadata = () => {
        durationEl.textContent = formatTime(audio.duration);
        if (!song.duration) {
          // Update duration in local songs
          if (song.isLocal) {
            const songIndex = localSongs.findIndex(s => s.id === song.id);
            if (songIndex !== -1) {
              localSongs[songIndex].duration = audio.duration;
              saveLocalSongs();
            }
          }
        }
      };
      
      // Increment play count
      incrementPlayCount(song.id);
    }
    
    // Play Song
    function playSong() {
      audio.play()
        .then(() => {
          isPlaying = true;
          updatePlayButton();
          showMiniPlayer();
        })
        .catch(error => {
          console.error('Error playing song:', error);
        });
    }
    
    // Pause Song
    function pauseSong() {
      audio.pause();
      isPlaying = false;
      updatePlayButton();
    }
    
    // Toggle Play/Pause
    function togglePlay() {
      if (isPlaying) {
        pauseSong();
      } else {
        playSong();
      }
    }
    
    // Play Previous Song
    function playPrevious() {
      const allSongs = [...localSongs, ...songs];
      loadSong(currentSongIndex - 1, allSongs);
      playSong();
    }
    
    // Play Next Song
    function playNext() {
      const allSongs = [...localSongs, ...songs];
      if (repeatMode === 'one') {
        audio.currentTime = 0;
        playSong();
      } else {
        loadSong(currentSongIndex + 1, allSongs);
        playSong();
      }
    }
    
    // Handle Song End
    function handleSongEnd() {
      const allSongs = [...localSongs, ...songs];
      if (repeatMode === 'one') {
        audio.currentTime = 0;
        playSong();
      } else {
        playNext();
      }
    }
    
    // Toggle Shuffle
    function toggleShuffle() {
      isShuffled = !isShuffled;
      shuffleBtn.classList.toggle('active');
      
      if (isShuffled) {
        originalSongsOrder = [...songs];
        songs = [...songs].sort(() => Math.random() - 0.5);
      } else {
        songs = [...originalSongsOrder];
      }
      
      // Find the current song in the new order
      const currentSongId = songs[currentSongIndex]?.id;
      if (currentSongId) {
        const newIndex = songs.findIndex(song => song.id === currentSongId);
        if (newIndex !== -1) {
          currentSongIndex = newIndex;
        }
      }
      
      renderSongsList(songs);
    }
    
    // Toggle Repeat
    function toggleRepeat() {
      const repeatModes = ['none', 'one', 'all'];
      const currentIndex = repeatModes.indexOf(repeatMode);
      repeatMode = repeatModes[(currentIndex + 1) % repeatModes.length];
      
      repeatBtn.className = 'control-btn';
      
      switch (repeatMode) {
        case 'none':
          repeatBtn.innerHTML = '<i class="fas fa-redo"></i>';
          break;
        case 'one':
          repeatBtn.innerHTML = '<i class="fas fa-redo"></i>';
          repeatBtn.classList.add('active');
          break;
        case 'all':
          repeatBtn.innerHTML = '<i class="fas fa-infinity"></i>';
          repeatBtn.classList.add('active');
          break;
      }
    }
    
    // Toggle Favorite
    function toggleFavorite() {
      const allSongs = [...localSongs, ...songs];
      const currentSongId = allSongs[currentSongIndex]?.id;
      if (!currentSongId) return;
      
      toggleFavoriteById(currentSongId);
    }
    
    // Toggle Favorite by ID
    function toggleFavoriteById(songId) {
      const index = favorites.indexOf(songId);
      
      if (index === -1) {
        favorites.push(songId);
      } else {
        favorites.splice(index, 1);
      }
      
      // Save to localStorage
      saveFavorites();
      
      // Update favorite button
      updateFavoriteButton();
      
      // Update favorite buttons in all lists
      document.querySelectorAll(`.favorite-btn[data-id="${songId}"]`).forEach(btn => {
        const icon = btn.querySelector('i');
        icon.className = favorites.includes(songId) ? 'fas fa-heart' : 'far fa-heart';
      });
      
      // If we're on the favorites tab, refresh the list
      if (currentTab === 'favorites') {
        renderFavoritesList();
      }
    }
    
    // Update Favorite Button
    function updateFavoriteButton() {
      const allSongs = [...localSongs, ...songs];
      const currentSongId = allSongs[currentSongIndex]?.id;
      if (!currentSongId) return;
      
      const isFavorite = favorites.includes(currentSongId);
      favoriteBtn.innerHTML = isFavorite ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart"></i>';
    }
    
    // Update Progress Bar
    function updateProgress() {
      const { currentTime, duration } = audio;
      const progressPercent = (currentTime / duration) * 100;
      
      progress.style.width = `${progressPercent}%`;
      miniPlayerProgress.style.width = `${progressPercent}%`;
      
      currentTimeEl.textContent = formatTime(currentTime);
    }
    
    // Seek in Song
    function seek(e) {
      const width = this.clientWidth;
      const clickX = e.offsetX;
      const duration = audio.duration;
      
      audio.currentTime = (clickX / width) * duration;
    }
    
    // Update Play Button
    function updatePlayButton() {
      if (isPlaying) {
        playIcon.className = 'fas fa-pause';
        miniPlayerPlayIcon.className = 'fas fa-pause';
        miniPlayerPlayBtn.classList.add('play');
      } else {
        playIcon.className = 'fas fa-play';
        miniPlayerPlayIcon.className = 'fas fa-play';
        miniPlayerPlayBtn.classList.remove('play');
      }
    }
    
    // Show Mini Player
    function showMiniPlayer() {
      miniPlayer.classList.add('active');
    }
    
    // Minimize Player
    function minimizePlayer() {
      miniPlayer.classList.remove('active');
    }
    
    // Show Main Player
    function showMainPlayer() {
      // Scroll to top of player section
      playerSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Show Upload Modal
    function showUploadModal(e) {
      e.preventDefault();
      uploadModal.classList.add('active');
    }
    
    // Hide Upload Modal
    function hideUploadModal() {
      uploadModal.classList.remove('active');
    }
    
    // Upload Song to Firebase
    function uploadSong(e) {
      e.preventDefault();
      
      const songName = document.getElementById('songName').value.trim();
      const songArtist = document.getElementById('songArtist').value.trim();
      const songAlbum = document.getElementById('songAlbum').value.trim();
      const audioFile = audioFileInput.files[0];
      
      if (!songName || !songArtist || !audioFile) {
        alert('Por favor complete todos los campos obligatorios');
        return;
      }
      
      // Disable form and show loading
      uploadBtn.disabled = true;
      uploadBtn.classList.add('uploading');
      
      // Upload files to Firebase Storage
      const storageRef = storage.ref();
      const audioRef = storageRef.child(`songs/${Date.now()}_${audioFile.name}`);
      let coverRef = null;
      
      if (coverImageInput.files.length > 0) {
        const coverFile = coverImageInput.files[0];
        coverRef = storageRef.child(`covers/${Date.now()}_${coverFile.name}`);
      }
      
      // Upload audio file
      const uploadAudio = audioRef.put(audioFile);
      
      uploadAudio.on('state_changed', 
        (snapshot) => {
          // Progress
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log(`Audio upload: ${progress}%`);
        },
        (error) => {
          // Error
          console.error('Error uploading audio:', error);
          alert('Error al subir el archivo de audio');
          resetUploadForm();
        },
        () => {
          // Complete
          uploadAudio.snapshot.ref.getDownloadURL().then((audioUrl) => {
            let coverUpload = Promise.resolve(null);
            
            if (coverRef) {
              const coverFile = coverImageInput.files[0];
              const uploadCover = coverRef.put(coverFile);
              
              coverUpload = new Promise((resolve, reject) => {
                uploadCover.on('state_changed', 
                  null,
                  (error) => {
                    console.error('Error uploading cover:', error);
                    resolve(null); // Continue even if cover fails
                  },
                  () => {
                    uploadCover.snapshot.ref.getDownloadURL().then((coverUrl) => {
                      resolve(coverUrl);
                    });
                  }
                );
              });
            }
            
            coverUpload.then((coverUrl) => {
              // Save song data to Firestore
              const songData = {
                title: songName,
                artist: songArtist,
                album: songAlbum || '',
                audioUrl: audioUrl,
                coverUrl: coverUrl || '',
                duration: 0, // Will be updated after metadata is loaded
                playCount: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                fromFirebase: true
              };
              
              db.collection('songs').add(songData)
                .then((docRef) => {
                  console.log('Song added with ID:', docRef.id);
                  alert('Canción subida exitosamente');
                  resetUploadForm();
                  hideUploadModal();
                  loadSongs(); // Refresh songs list
                })
                .catch((error) => {
                  console.error('Error adding song:', error);
                  alert('Error al guardar los datos de la canción');
                  resetUploadForm();
                });
            });
          });
        }
      );
    }
    
    // Reset Upload Form
    function resetUploadForm() {
      uploadForm.reset();
      audioFileName.textContent = 'Ningún archivo seleccionado';
      coverImageName.textContent = 'Ningún archivo seleccionado';
      uploadBtn.disabled = false;
      uploadBtn.classList.remove('uploading');
    }
    
    // Increment Play Count
    function incrementPlayCount(songId) {
      if (songId.startsWith('local-')) {
        // Update local song play count
        const songIndex = localSongs.findIndex(song => song.id === songId);
        if (songIndex !== -1) {
          localSongs[songIndex].playCount = (localSongs[songIndex].playCount || 0) + 1;
          saveLocalSongs();
          renderLocalSongsList();
        }
      } else {
        // Update Firebase song play count
        const songRef = db.collection('songs').doc(songId);
        
        db.runTransaction((transaction) => {
          return transaction.get(songRef).then((doc) => {
            if (!doc.exists) {
              throw new Error('Document does not exist!');
            }
            
            const newPlayCount = (doc.data().playCount || 0) + 1;
            transaction.update(songRef, { playCount: newPlayCount });
            
            // Update local data
            const songIndex = songs.findIndex(song => song.id === songId);
            if (songIndex !== -1) {
              songs[songIndex].playCount = newPlayCount;
              updateTopSongs();
              
              // If we're on the top songs tab, refresh the list
              if (currentTab === 'top') {
                renderTopSongsList();
              }
            }
          });
        }).catch((error) => {
          console.error('Error updating play count:', error);
        });
      }
    }
    
    // Format Time (seconds to MM:SS)
    function formatTime(seconds) {
      if (isNaN(seconds)) return "0:00";
      
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Initialize App when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
